<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Dsa-hl-svn] r3055 - in rl/trunk: engine/core/include	engine/core/include/nulldriver engine/core/src	engine/core/src/nulldriver engine/script/swig engine/ui/src	plugins/fmod4driver/include plugins/fmod4driver/src	plugins/openaldriver/include plugins/openaldriver/src
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/dsa-hl-svn/2007-February/index.html" >
   <LINK REL="made" HREF="mailto:dsa-hl-svn%40lists.berlios.de?Subject=Re%3A%20%5BDsa-hl-svn%5D%20r3055%20-%20in%20rl/trunk%3A%20engine/core/include%0A%09engine/core/include/nulldriver%20engine/core/src%0A%09engine/core/src/nulldriver%20engine/script/swig%20engine/ui/src%0A%09plugins/fmod4driver/include%20plugins/fmod4driver/src%0A%09plugins/openaldriver/include%20plugins/openaldriver/src&In-Reply-To=%3C200702211559.l1LFxcJX005675%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000125.html">
   <LINK REL="Next"  HREF="000127.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Dsa-hl-svn] r3055 - in rl/trunk: engine/core/include	engine/core/include/nulldriver engine/core/src	engine/core/src/nulldriver engine/script/swig engine/ui/src	plugins/fmod4driver/include plugins/fmod4driver/src	plugins/openaldriver/include plugins/openaldriver/src</H1>
    <B>tanis at mail.berlios.de</B> 
    <A HREF="mailto:dsa-hl-svn%40lists.berlios.de?Subject=Re%3A%20%5BDsa-hl-svn%5D%20r3055%20-%20in%20rl/trunk%3A%20engine/core/include%0A%09engine/core/include/nulldriver%20engine/core/src%0A%09engine/core/src/nulldriver%20engine/script/swig%20engine/ui/src%0A%09plugins/fmod4driver/include%20plugins/fmod4driver/src%0A%09plugins/openaldriver/include%20plugins/openaldriver/src&In-Reply-To=%3C200702211559.l1LFxcJX005675%40sheep.berlios.de%3E"
       TITLE="[Dsa-hl-svn] r3055 - in rl/trunk: engine/core/include	engine/core/include/nulldriver engine/core/src	engine/core/src/nulldriver engine/script/swig engine/ui/src	plugins/fmod4driver/include plugins/fmod4driver/src	plugins/openaldriver/include plugins/openaldriver/src">tanis at mail.berlios.de
       </A><BR>
    <I>Wed Feb 21 16:59:38 CET 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="000125.html">[Dsa-hl-svn] r3054 - rl/trunk/engine/core/src
</A></li>
        <LI>Next message: <A HREF="000127.html">[Dsa-hl-svn] r3056 - in modules/common/scripts: . jobs
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#126">[ date ]</a>
              <a href="thread.html#126">[ thread ]</a>
              <a href="subject.html#126">[ subject ]</a>
              <a href="author.html#126">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: tanis
Date: 2007-02-21 16:58:09 +0100 (Wed, 21 Feb 2007)
New Revision: 3055

Modified:
   rl/trunk/engine/core/include/CoreSubsystem.h
   rl/trunk/engine/core/include/PlaySoundJob.h
   rl/trunk/engine/core/include/Sound.h
   rl/trunk/engine/core/include/SoundDriver.h
   rl/trunk/engine/core/include/nulldriver/NullDriver.h
   rl/trunk/engine/core/include/nulldriver/NullSound.h
   rl/trunk/engine/core/src/ActorManager.cpp
   rl/trunk/engine/core/src/CoreSubsystem.cpp
   rl/trunk/engine/core/src/PlaySoundJob.cpp
   rl/trunk/engine/core/src/Sound.cpp
   rl/trunk/engine/core/src/SoundDriver.cpp
   rl/trunk/engine/core/src/nulldriver/NullDriver.cpp
   rl/trunk/engine/core/src/nulldriver/NullSound.cpp
   rl/trunk/engine/script/swig/RlCore.head.inc
   rl/trunk/engine/script/swig/RlCore.inc
   rl/trunk/engine/ui/src/DialogCharacterController.cpp
   rl/trunk/plugins/fmod4driver/include/Fmod4Driver.h
   rl/trunk/plugins/fmod4driver/include/Fmod4Sound.h
   rl/trunk/plugins/fmod4driver/src/Fmod4Driver.cpp
   rl/trunk/plugins/fmod4driver/src/Fmod4Sound.cpp
   rl/trunk/plugins/openaldriver/include/OpenALDriver.h
   rl/trunk/plugins/openaldriver/include/OpenALSound.h
   rl/trunk/plugins/openaldriver/src/OpenALDriver.cpp
   rl/trunk/plugins/openaldriver/src/OpenALSound.cpp
Log:
Sound driver-API changes: Only one createSound function, whether stream or sample is determined by the SoundType argument.
Added functions to handle automatic Sound removal after done playing. This is implemented in NullDriver and Fmod4Driver, but not yet OpenAL.

2d/3d sound play jobs work now and are eported to Ruby, along with teh JobScheduler.

Modified: rl/trunk/engine/core/include/CoreSubsystem.h
===================================================================
--- rl/trunk/engine/core/include/CoreSubsystem.h	2007-02-18 13:03:24 UTC (rev 3054)
+++ rl/trunk/engine/core/include/CoreSubsystem.h	2007-02-21 15:58:09 UTC (rev 3055)
@@ -86,6 +86,9 @@
     void setDeveloperMode(bool developerMode);
     bool getDeveloperMode() const;
 
+    /// Returns time since game started in Milliseconds.
+    /// Uses GameLoop::getClock internally, function is here to allow access from ruby.
+    unsigned long getClock();
 
     /** Saves a timestamped jpg Screenshot
         @param sName The filename (extended with the timestamp)

Modified: rl/trunk/engine/core/include/PlaySoundJob.h
===================================================================
--- rl/trunk/engine/core/include/PlaySoundJob.h	2007-02-18 13:03:24 UTC (rev 3054)
+++ rl/trunk/engine/core/include/PlaySoundJob.h	2007-02-21 15:58:09 UTC (rev 3055)
@@ -28,8 +28,7 @@
     {
     public:
 
-        PlaySound2dJob(const Ogre::String&amp; sound, Ogre::Real volume=1.0f,
-            bool looping=false, bool isDiscardable=false);
+        PlaySound2dJob(const Ogre::String&amp; sound, Ogre::Real volume=1.0f);
         virtual ~PlaySound2dJob();
 
         /// Play the sound.
@@ -39,12 +38,29 @@
         ///       playing.
         virtual bool execute(Ogre::Real time);
 
-        /// Do nothing, since the sound can be either played or not.
-        /// Once started, it is not aborted.
-        virtual void discard();
     private:
         Sound* mSound;
+        bool mExecuted;
     };
+
+    class _RlCoreExport PlaySound3dJob : public Job
+    {
+    public:
+
+        PlaySound3dJob(const Ogre::String&amp; sound, const Ogre::Vector3&amp; pos, Ogre::Real volume=1.0f);
+        virtual ~PlaySound3dJob();
+
+        /// Play the sound.
+        /// @return true, when the sound is done playing, false else.
+        /// @todo this return-behaviour is actually a hack to prevent a memory leak.
+        ///       We have to find a way to get rid of the sound automatically, when it is done
+        ///       playing.
+        virtual bool execute(Ogre::Real time);
+
+    private:
+        Sound* mSound;
+        bool mExecuted;
+    };
 }
 
 #endif

Modified: rl/trunk/engine/core/include/Sound.h
===================================================================
--- rl/trunk/engine/core/include/Sound.h	2007-02-18 13:03:24 UTC (rev 3054)
+++ rl/trunk/engine/core/include/Sound.h	2007-02-21 15:58:09 UTC (rev 3055)
@@ -43,7 +43,7 @@
     {
     public:
         /// Konstruktor
-        Sound(const SoundResourcePtr &amp;soundres);
+        Sound(const SoundResourcePtr&amp; soundres, SoundDriver* creator);
         /// Destruktor
         virtual ~Sound();
           
@@ -53,7 +53,7 @@
         virtual void unload() throw (RuntimeException) = 0;
 
         // SoundResource zurueckgeben.
-        const SoundResourcePtr &amp;getSoundResource() const;
+        const SoundResourcePtr&amp; getSoundResource() const;
         // Wollen wir 3D?
         bool is3d() const;
         // Setzen des 3D-Flags.
@@ -100,7 +100,7 @@
 	    virtual const Ogre::Real getRolloffEndDistance() const;
 
         /// Spielt den Sound ab.
-        virtual void play() = 0;
+        virtual void play(bool destroyWhenDone=false) = 0;
         /// Pausiert den Sound.
         virtual void pause(bool pausing) = 0;
         /// Ist der Sound pausiert?
@@ -113,6 +113,8 @@
         virtual const bool isPlaying() const = 0;
 
     protected:
+        SoundDriver* mCreator;
+
         /// Die Lautstaerke
 	    Ogre::Real mVolume;
         /// Die Position

Modified: rl/trunk/engine/core/include/SoundDriver.h
===================================================================
--- rl/trunk/engine/core/include/SoundDriver.h	2007-02-18 13:03:24 UTC (rev 3054)
+++ rl/trunk/engine/core/include/SoundDriver.h	2007-02-21 15:58:09 UTC (rev 3055)
@@ -1,109 +1,114 @@
-/* This source file is part of Rastullahs Lockenpracht.
- * Copyright (C) 2003-2007 Team Pantheon. <A HREF="http://www.team-pantheon.de">http://www.team-pantheon.de</A>
- *
- *  This program is free software; you can redistribute it and/or modify
- *  it under the terms of the Clarified Artistic License.
- *
- *  This program is distributed in the hope that it will be useful,
- *  but WITHOUT ANY WARRANTY; without even the implied warranty of
- *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
- *  Clarified Artistic License for more details.
- *
- *  You should have received a copy of the Clarified Artistic License
- *  along with this program; if not you can get it here
- *  <A HREF="http://www.jpaulmorrison.com/fbp/artistic2.htm.">http://www.jpaulmorrison.com/fbp/artistic2.htm.</A>
- */
-#ifndef SOUNDDRIVER_H_
-#define SOUNDDRIVER_H_
-
-#include &quot;CorePrerequisites.h&quot;
-#include &lt;OgreResourceManager.h&gt;
-#include &quot;Sound.h&quot;
-
-namespace rl
-{
-    class ListenerMovable;
-
-    /// Abstract super class of all API specific sound drivers.
-    class _RlCoreExport SoundDriver
-    {
-    public:
-        /// Der Konstruktor
-        SoundDriver(Ogre::ResourceManager* soundResourceManager);
-        /// Der Destruktor
-        virtual ~SoundDriver();
-
-        /// returns true, if the driver can work on the current system. False else.
-        virtual bool isDriverAvailable() = 0;
-
-        /** Initialize driver
-         *  @return &lt;code&gt;true&lt;/code&gt; if successful, &lt;code&gt;false&lt;/code&gt; otherwise
-         */
-        virtual bool initialize() = 0;
-
-        /// Beende den Treiber
-        virtual void shutdown() = 0;
-        /// Der Name des Treibers
-        virtual Ogre::String getName() const = 0;
-        /// Update-Aufgaben erledigen
-        virtual void update() = 0;
-        /// Einen Sound-Stream mit Resource erzeugen
-        virtual Sound* createStream(const SoundResourcePtr &amp;res);
-        virtual Sound* createStream(const Ogre::String&amp; name);
-        /// Einen Sound-Sample mit Resource erzeugen
-        virtual Sound* createSample(const SoundResourcePtr &amp;res);
-        virtual Sound* createSample(const Ogre::String&amp; name);
-
-
-        /// Destroy a sound created by this driver. Do not call the Sound destructor yourself!
-        virtual void destroySound(Sound*);
-
-        /// Einen Soundlistener erzeugen
-        virtual ListenerMovable *createListener(const Ogre::String &amp;name) = 0;
-
-
-        /// Set attenuation of the volume with distance. f influences
-        /// volume like this: relative volume = 1/(f*distance)
-        virtual void setRolloffFactor(const Ogre::Real&amp; f) = 0;
-        virtual const Ogre::Real getRolloffFactor() = 0;
-
-        void setDefaultMusicVolume(const Ogre::Real&amp; vol);
-        const Ogre::Real getDefaultMusicVolume() const;
-
-        void setDefaultSoundVolume(const Ogre::Real&amp; vol);
-        const Ogre::Real getDefaultSoundVolume() const;
-
-        virtual void setMasterVolume(const Ogre::Real&amp; vol);
-        const Ogre::Real getMasterVolume() const;
-
-        /**
-         * Returns the current sound driver settings as a key-value list
-         *
-         * @return key-value list of sound options
-         */
-        virtual Ogre::NameValuePairList getSettings() const;
-
-        /**
-         * Sets certain options for the sound driver, like volume settings for
-         * sound effects and music.
-         *
-         * @param settings key-value list of settings
-         */
-        virtual void applySettings(const Ogre::NameValuePairList&amp; settings);
-
-    protected:
-        Ogre::ResourceManager* mSoundResourceManager;
-
-        SoundSet mStreamSet;
-        SoundSet mSampleSet;
-
-        Ogre::Real mDefaultMusicVolume;  ///!&lt; Music volume
-        Ogre::Real mDefaultSoundVolume;  ///!&lt; Sound effect volume
-        Ogre::Real mMasterVolume;        ///!&lt; Master volume
-
-        virtual Sound* createStreamImpl(const SoundResourcePtr &amp;res) = 0;
-        virtual Sound* createSampleImpl(const SoundResourcePtr &amp;res) = 0;
-    };
-}
-
-#endif /*SOUNDDRIVER_H_*/
+/* This source file is part of Rastullahs Lockenpracht.
+ * Copyright (C) 2003-2007 Team Pantheon. <A HREF="http://www.team-pantheon.de">http://www.team-pantheon.de</A>
+ *
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the Clarified Artistic License.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  Clarified Artistic License for more details.
+ *
+ *  You should have received a copy of the Clarified Artistic License
+ *  along with this program; if not you can get it here
+ *  <A HREF="http://www.jpaulmorrison.com/fbp/artistic2.htm.">http://www.jpaulmorrison.com/fbp/artistic2.htm.</A>
+ */
+#ifndef SOUNDDRIVER_H_
+#define SOUNDDRIVER_H_
+
+#include &quot;CorePrerequisites.h&quot;
+#include &lt;OgreResourceManager.h&gt;
+#include &quot;Sound.h&quot;
+
+namespace rl
+{
+    class ListenerMovable;
+
+    typedef enum {ST_SAMPLE, ST_STREAM} SoundType;
+
+    /// Abstract super class of all API specific sound drivers.
+    class _RlCoreExport SoundDriver
+    {
+    public:
+        /// Der Konstruktor
+        SoundDriver(Ogre::ResourceManager* soundResourceManager);
+        /// Der Destruktor
+        virtual ~SoundDriver();
+
+        /// returns true, if the driver can work on the current system. False else.
+        virtual bool isDriverAvailable() = 0;
+
+        /** Initialize driver
+         *  @return &lt;code&gt;true&lt;/code&gt; if successful, &lt;code&gt;false&lt;/code&gt; otherwise
+         */
+        virtual bool initialize() = 0;
+
+        /// Beende den Treiber
+        virtual void shutdown() = 0;
+        /// Der Name des Treibers
+        virtual Ogre::String getName() const = 0;
+        /// Update-Aufgaben erledigen
+        virtual void update() = 0;
+
+        /**
+         *  Create a Sound object.
+         *  Sounds created with this functions have to be destroyed using
+         *  SoundDriver#destroySound, unless destroyWhenDone is set to true.
+         *  @param res the resource from which to create the sound.
+         *  @param type whether to create the sound as sample or stream.
+         */
+        virtual Sound* createSound(SoundResourcePtr res, SoundType type=ST_SAMPLE);
+
+        /// @overload
+        virtual Sound* createSound(const Ogre::String&amp; res, SoundType type=ST_SAMPLE);
+
+        /// Destroy a sound created by this driver. Do not call the Sound destructor yourself!
+        virtual void destroySound(Sound*);
+
+        /// Einen Soundlistener erzeugen
+        virtual ListenerMovable *createListener(const Ogre::String &amp;name) = 0;
+
+        /// Set attenuation of the volume with distance. f influences
+        /// volume like this: relative volume = 1/(f*distance)
+        virtual void setRolloffFactor(const Ogre::Real&amp; f) = 0;
+        virtual const Ogre::Real getRolloffFactor() = 0;
+
+        void setDefaultMusicVolume(const Ogre::Real&amp; vol);
+        const Ogre::Real getDefaultMusicVolume() const;
+
+        void setDefaultSoundVolume(const Ogre::Real&amp; vol);
+        const Ogre::Real getDefaultSoundVolume() const;
+
+        virtual void setMasterVolume(const Ogre::Real&amp; vol);
+        const Ogre::Real getMasterVolume() const;
+
+        /**
+         * Returns the current sound driver settings as a key-value list
+         *
+         * @return key-value list of sound options
+         */
+        virtual Ogre::NameValuePairList getSettings() const;
+
+        /**
+         * Sets certain options for the sound driver, like volume settings for
+         * sound effects and music.
+         *
+         * @param settings key-value list of settings
+         */
+        virtual void applySettings(const Ogre::NameValuePairList&amp; settings);
+
+    protected:
+        Ogre::ResourceManager* mSoundResourceManager;
+
+        SoundSet mStreamSet;
+        SoundSet mSampleSet;
+
+        Ogre::Real mDefaultMusicVolume;  ///!&lt; Music volume
+        Ogre::Real mDefaultSoundVolume;  ///!&lt; Sound effect volume
+        Ogre::Real mMasterVolume;        ///!&lt; Master volume
+
+        virtual Sound* createSoundImpl(SoundResourcePtr res, SoundType type) = 0;
+    };
+}
+
+#endif /*SOUNDDRIVER_H_*/

Modified: rl/trunk/engine/core/include/nulldriver/NullDriver.h
===================================================================
--- rl/trunk/engine/core/include/nulldriver/NullDriver.h	2007-02-18 13:03:24 UTC (rev 3054)
+++ rl/trunk/engine/core/include/nulldriver/NullDriver.h	2007-02-21 15:58:09 UTC (rev 3055)
@@ -51,8 +51,7 @@
     virtual const Ogre::Real getRolloffFactor();
 
 protected:
-    virtual Sound *createStreamImpl(const SoundResourcePtr &amp;res);
-    virtual Sound *createSampleImpl(const SoundResourcePtr &amp;res);
+    virtual Sound* createSoundImpl(SoundResourcePtr res, SoundType type);
 };
 
 }

Modified: rl/trunk/engine/core/include/nulldriver/NullSound.h
===================================================================
--- rl/trunk/engine/core/include/nulldriver/NullSound.h	2007-02-18 13:03:24 UTC (rev 3054)
+++ rl/trunk/engine/core/include/nulldriver/NullSound.h	2007-02-21 15:58:09 UTC (rev 3055)
@@ -32,7 +32,7 @@
     {
     public:
         /// Konstruktor
-        NullSound(const SoundResourcePtr &amp;soundres);
+        NullSound(const SoundResourcePtr &amp;soundres, SoundDriver* creator);
         /// Destruktor
         virtual ~NullSound();
 
@@ -64,8 +64,8 @@
         /// Setzt die Geschwindigkeit der Soundquelle.
          void setVelocity(const Ogre::Vector3&amp;);
 
-        /// Spielt den Sound ab.
-         void play();
+         /// Spielt den Sound ab.
+         void play(bool destroyWhenDone=false);
         /// Pausiert den Sound.
          void pause(bool pausing);
         /// Ist der Sound pausiert?
@@ -76,9 +76,11 @@
     //         void rewind() throw (RuntimeException);
         /// Laeuft der Sound noch
          const bool isPlaying() const;
+
     protected:
         // Sind wir gueltig?
         virtual bool isValid() const throw (RuntimeException);
+
     private:
         // Shared class-level name for Movable type
         static Ogre::String msMovableType;

Modified: rl/trunk/engine/core/src/ActorManager.cpp
===================================================================
--- rl/trunk/engine/core/src/ActorManager.cpp	2007-02-18 13:03:24 UTC (rev 3054)
+++ rl/trunk/engine/core/src/ActorManager.cpp	2007-02-21 15:58:09 UTC (rev 3055)
@@ -192,7 +192,8 @@
         Actor* actor = 0;
         try
         {
-            Sound* sm = SoundManager::getSingleton().getActiveDriver()-&gt;createSample(soundfile);
+            Sound* sm = SoundManager::getSingleton().getActiveDriver()-&gt;
+                createSound(soundfile, ST_SAMPLE);
             SoundObject* so = new SoundObject(sm, soundfile);
             actor = new Actor(uniquename, so);
             mActors.insert(ActorPtrPair(uniquename,actor));  
@@ -220,7 +221,8 @@
         Actor* actor = 0;
         try
         {
-            Sound* sm = SoundManager::getSingleton().getActiveDriver()-&gt;createStream(soundfile);
+            Sound* sm = SoundManager::getSingleton().getActiveDriver()-&gt;
+                createSound(soundfile, ST_STREAM);
             SoundObject* so = new SoundObject(sm, soundfile);
 
             actor = new Actor(uniquename, so);

Modified: rl/trunk/engine/core/src/CoreSubsystem.cpp
===================================================================
--- rl/trunk/engine/core/src/CoreSubsystem.cpp	2007-02-18 13:03:24 UTC (rev 3054)
+++ rl/trunk/engine/core/src/CoreSubsystem.cpp	2007-02-21 15:58:09 UTC (rev 3055)
@@ -231,6 +231,7 @@
         LOG_MESSAGE(Logger::CORE,&quot;Aktormanager erzeugt&quot;);
 
         mSoundManager = new SoundManager();
+        GameLoop::getSingleton().addTask(mSoundManager, GameLoop::TG_SOUND);
         LOG_MESSAGE(Logger::CORE,&quot;SoundManager erzeugt&quot;);
 
         initializeResources();
@@ -249,18 +250,23 @@
 
         mPhysicsManager = new PhysicsManager();
         GameLoop::getSingleton().addTask(mPhysicsManager, GameLoop::TG_PHYSICS);
+        LOG_MESSAGE(Logger::CORE,&quot;PhysicsManager erzeugt&quot;);
 
         mAnimationManager = new AnimationManager();
         GameLoop::getSingleton().addTask(mAnimationManager, GameLoop::TG_GRAPHICS);
+        LOG_MESSAGE(Logger::CORE,&quot;AnimationManager erzeugt&quot;);
 
         mGameEventManager = new GameEventManager();
         GameLoop::getSingleton().addTask(mGameEventManager, GameLoop::TG_LOGIC);
+        LOG_MESSAGE(Logger::CORE,&quot;GameEventManager erzeugt&quot;);
 
         mDebugVisualsManager = new DebugVisualsManager();
         GameLoop::getSingleton().addTask(mDebugVisualsManager, GameLoop::TG_GRAPHICS);
+        LOG_MESSAGE(Logger::CORE,&quot;DebugVisualsManager erzeugt&quot;);
 
         mJobScheduler = new JobScheduler();
         GameLoop::getSingleton().addTask(mJobScheduler, GameLoop::TG_GRAPHICS);
+        LOG_MESSAGE(Logger::CORE,&quot;JobScheduler erzeugt&quot;);
 
         return true;
     }
@@ -465,6 +471,11 @@
         return mWorld;
     }
 
+    unsigned long CoreSubsystem::getClock()
+    {
+        return mGameLoop-&gt;getClock();
+    }
+
     Ogre::String CoreSubsystem::getEngineVersionString() const
     {
         static Ogre::String version = &quot;0.3.0&quot;;

Modified: rl/trunk/engine/core/src/PlaySoundJob.cpp
===================================================================
--- rl/trunk/engine/core/src/PlaySoundJob.cpp	2007-02-18 13:03:24 UTC (rev 3054)
+++ rl/trunk/engine/core/src/PlaySoundJob.cpp	2007-02-21 15:58:09 UTC (rev 3055)
@@ -24,28 +24,56 @@
 namespace rl
 {
 
-    PlaySound2dJob::PlaySound2dJob(const String&amp; sound, Real volume,
-        bool looping, bool isDiscardable) : Job(isDiscardable, true), mSound()
+    PlaySound2dJob::PlaySound2dJob(const String&amp; sound, Real volume)
+        : Job(false, true), mSound(NULL), mExecuted(false)
     {
-        mSound = SoundManager::getSingleton().getActiveDriver()-&gt;
-            createStream(SoundManager::getSingleton().getByName(sound));
+        mSound = SoundManager::getSingleton().getActiveDriver()-&gt;createSound(sound, ST_SAMPLE);
         mSound-&gt;set3d(false);
         mSound-&gt;setVolume(volume);
-        mSound-&gt;setLooping(looping);
+        mSound-&gt;setLooping(false);
     }
 
     PlaySound2dJob::~PlaySound2dJob()
     {
-        delete mSound;
+        // Only destroy sound, if not played,
+        // because else the sound gets destroyed automatically.
+        if(!mExecuted)
+        {
+            SoundManager::getSingleton().getActiveDriver()-&gt;destroySound(mSound);
+        }
     }
 
     bool PlaySound2dJob::execute(Ogre::Real time)
     {
-        if (mSound) mSound-&gt;play();
+        if (mSound) mSound-&gt;play(true);
+        mExecuted = true;
         return true;
     }
 
-    void PlaySound2dJob::discard()
+    PlaySound3dJob::PlaySound3dJob(const String&amp; sound, const Ogre::Vector3&amp; pos, Real volume)
+        : Job(false, true), mSound(NULL), mExecuted(false)
     {
+        mSound = SoundManager::getSingleton().getActiveDriver()-&gt;createSound(sound, ST_SAMPLE);
+        mSound-&gt;set3d(true);
+        mSound-&gt;setPosition(pos);
+        mSound-&gt;setVolume(volume);
+        mSound-&gt;setLooping(false);
     }
+
+    PlaySound3dJob::~PlaySound3dJob()
+    {
+        // Only destroy sound, if not played,
+        // because else the sound gets destroyed automatically.
+        if(!mExecuted)
+        {
+            SoundManager::getSingleton().getActiveDriver()-&gt;destroySound(mSound);
+        }
+    }
+
+    bool PlaySound3dJob::execute(Ogre::Real time)
+    {
+        if (mSound) mSound-&gt;play(true);
+        mExecuted = true;
+        return true;
+    }
 }

Modified: rl/trunk/engine/core/src/Sound.cpp
===================================================================
--- rl/trunk/engine/core/src/Sound.cpp	2007-02-18 13:03:24 UTC (rev 3054)
+++ rl/trunk/engine/core/src/Sound.cpp	2007-02-21 15:58:09 UTC (rev 3055)
@@ -14,6 +14,7 @@
 *  <A HREF="http://www.jpaulmorrison.com/fbp/artistic2.htm.">http://www.jpaulmorrison.com/fbp/artistic2.htm.</A>
 */
 #include &quot;Sound.h&quot;
+#include &quot;SoundDriver.h&quot;
 
 using namespace Ogre; 
 
@@ -22,10 +23,11 @@
 
 AxisAlignedBox Sound::msAABox = Ogre::AxisAlignedBox(0.0, 0.0, 0.0, 0.0, 0.0, 0.0);
 
-Sound::Sound(const SoundResourcePtr &amp;soundres)
+Sound::Sound(const SoundResourcePtr &amp;soundres, SoundDriver* creator)
 : MovableObject(soundres-&gt;getName()),
    EventSource(),
    EventCaster&lt;SoundEvent&gt;(),
+   mCreator(creator),
    mVolume(1.0),
    mSoundResource(soundres),
    mIsLooping(false),
@@ -135,5 +137,4 @@
 	return mRolloffEndDistance;
 }
 
-
 };

Modified: rl/trunk/engine/core/src/SoundDriver.cpp
===================================================================
--- rl/trunk/engine/core/src/SoundDriver.cpp	2007-02-18 13:03:24 UTC (rev 3054)
+++ rl/trunk/engine/core/src/SoundDriver.cpp	2007-02-21 15:58:09 UTC (rev 3055)
@@ -97,9 +97,12 @@
         Ogre::NameValuePairList SoundSettings;
 
         // Append the settings to the list
-        SoundSettings.insert(make_pair(&quot;MasterVolume&quot;, Ogre::StringConverter::toString(mMasterVolume)));
-        SoundSettings.insert(make_pair(&quot;DefaultMusicVolume&quot;, Ogre::StringConverter::toString(mDefaultMusicVolume)));
-        SoundSettings.insert(make_pair(&quot;DefaultSoundVolume&quot;, Ogre::StringConverter::toString(mDefaultSoundVolume)));
+        SoundSettings.insert(make_pair(&quot;MasterVolume&quot;,
+            Ogre::StringConverter::toString(mMasterVolume)));
+        SoundSettings.insert(make_pair(&quot;DefaultMusicVolume&quot;,
+            Ogre::StringConverter::toString(mDefaultMusicVolume)));
+        SoundSettings.insert(make_pair(&quot;DefaultSoundVolume&quot;,
+            Ogre::StringConverter::toString(mDefaultSoundVolume)));
 
         return SoundSettings;
     }
@@ -142,7 +145,7 @@
         }
     }
 
-    Sound* SoundDriver::createStream(const Ogre::String&amp; name)
+    Sound* SoundDriver::createSound(const String&amp; name, SoundType type)
     {
         SoundResourcePtr ptr = mSoundResourceManager-&gt;load(name,
             ResourceGroupManager::AUTODETECT_RESOURCE_GROUP_NAME);
@@ -150,40 +153,26 @@
         {
             Throw(IllegalArgumentException, &quot;Sound &quot; + name + &quot;nicht gefunden&quot;);
         }
-        return createStream(ptr);
+        return createSound(ptr, type);
     }
 
-    Sound* SoundDriver::createStream(const SoundResourcePtr &amp;res)
+    Sound* SoundDriver::createSound(SoundResourcePtr res, SoundType type)
     {
-        Sound* sound = createStreamImpl(res);
+        Sound* sound = createSoundImpl(res, type);
         if (sound != NULL)
         {
-            mStreamSet.insert(sound);
+            if (type == ST_SAMPLE)
+            {
+                mSampleSet.insert(sound);
+            }
+            else
+            {
+                mStreamSet.insert(sound);
+            }
         }
         return sound;
     }
 
-    Sound* SoundDriver::createSample(const Ogre::String&amp; name)
-    {
-        SoundResourcePtr ptr = mSoundResourceManager-&gt;load(name,
-            ResourceGroupManager::AUTODETECT_RESOURCE_GROUP_NAME);
-        if (ptr.isNull())
-        {
-            Throw(IllegalArgumentException, &quot;Sound &quot; + name + &quot;nicht gefunden&quot;);
-        }
-        return createSample(ptr);
-    }
-
-    Sound* SoundDriver::createSample(const SoundResourcePtr &amp;res)
-    {
-        Sound* sound = createSampleImpl(res);
-        if (sound != NULL)
-        {
-            mSampleSet.insert(sound);
-        }
-        return sound;
-    }
-
     void SoundDriver::destroySound(Sound* sound)
     {
         if (sound-&gt;isPlaying())

Modified: rl/trunk/engine/core/src/nulldriver/NullDriver.cpp
===================================================================
--- rl/trunk/engine/core/src/nulldriver/NullDriver.cpp	2007-02-18 13:03:24 UTC (rev 3054)
+++ rl/trunk/engine/core/src/nulldriver/NullDriver.cpp	2007-02-21 15:58:09 UTC (rev 3055)
@@ -92,33 +92,13 @@
      // Erstmal nichts zu tun.
  }
 
- /**
-  * Einen Sound-Stream mit Resource erzeugen
-  * @return Der erzeugte Stream
-  * @param res Die Resource zur Erzeugung des Sounds
-  * @author JoSch
-  * @date 03-06-2006
-  */
-Sound *NullDriver::createStreamImpl(const SoundResourcePtr &amp;res)
+Sound *NullDriver::createSoundImpl(SoundResourcePtr res, SoundType type)
 {
-     Sound *sound = new NullSound(res);
+     Sound* sound = new NullSound(res, this);
      return sound;
 }
 
 /**
- * Einen Sound-Sample mit Resource erzeugen
- * @return Das erzeugte Sample
- * @param res Die Resource zur Erzeugung des Sounds
- * @author JoSch
- * @date 03-06-2006
- */
-Sound *NullDriver::createSampleImpl(const SoundResourcePtr &amp;res)
-{
-     Sound *sound = new NullSound(res);
-     return sound;
-}
-
-/**
  * Einen Soundlistener erzeugen
  * @return Der erzeugte Listener
  * @param name Der Name des Channels.
@@ -127,7 +107,7 @@
  */
 ListenerMovable *NullDriver::createListener(const Ogre::String &amp;name)
 {
-    ListenerMovable *listener = new NullListener(name);
+    ListenerMovable* listener = new NullListener(name);
     return listener;
 }
 

Modified: rl/trunk/engine/core/src/nulldriver/NullSound.cpp
===================================================================
--- rl/trunk/engine/core/src/nulldriver/NullSound.cpp	2007-02-18 13:03:24 UTC (rev 3054)
+++ rl/trunk/engine/core/src/nulldriver/NullSound.cpp	2007-02-21 15:58:09 UTC (rev 3055)
@@ -14,6 +14,8 @@
 *  <A HREF="http://www.jpaulmorrison.com/fbp/artistic2.htm.">http://www.jpaulmorrison.com/fbp/artistic2.htm.</A>
 */
 #include &quot;NullSound.h&quot;
+#include &quot;NullDriver.h&quot;
+
 #include &quot;SoundManager.h&quot;
 #include &quot;SoundResource.h&quot;
 
@@ -29,8 +31,8 @@
  * @author JoSch
  * @date 07-04-2005
  */
-NullSound::NullSound(const SoundResourcePtr &amp;soundres):
-    Sound(soundres)
+NullSound::NullSound(const SoundResourcePtr &amp;soundres, SoundDriver* creator):
+    Sound(soundres, creator)
 {
 }
 
@@ -89,8 +91,13 @@
  * @author JoSch
  * @date 07-23-2005
  */
-void NullSound::play()
+void NullSound::play(bool destroyWhenDone)
 {
+    if (destroyWhenDone)
+    {
+        // We're not going to play anything, so we can self-destroy right away...
+        mCreator-&gt;destroySound(this);
+    }
 }
 
 /**

Modified: rl/trunk/engine/script/swig/RlCore.head.inc
===================================================================
--- rl/trunk/engine/script/swig/RlCore.head.inc	2007-02-18 13:03:24 UTC (rev 3054)
+++ rl/trunk/engine/script/swig/RlCore.head.inc	2007-02-21 15:58:09 UTC (rev 3055)
@@ -50,6 +50,10 @@
 #include &quot;ListenerObject.h&quot;
 #include &quot;Sound.h&quot;
 #include &quot;SoundEvents.h&quot;
+#include &quot;JobScheduler.h&quot;
+#include &quot;Job.h&quot;
+#include &quot;JobListener.h&quot;
+#include &quot;PlaySoundJob.h&quot;
 #undef message
 #undef send
 %}

Modified: rl/trunk/engine/script/swig/RlCore.inc
===================================================================
--- rl/trunk/engine/script/swig/RlCore.inc	2007-02-18 13:03:24 UTC (rev 3054)
+++ rl/trunk/engine/script/swig/RlCore.inc	2007-02-21 15:58:09 UTC (rev 3055)
@@ -655,6 +655,7 @@
 		const Ogre::String&amp; resourceGroup, const Ogre::String&amp; startupScript = &quot;&quot;);
 	void registerModule(ContentModule* module);
     World* getWorld();
+    unsigned long getClock();
     void makeScreenshot(const Ogre::String&amp; sName);
     bool isInitialized() const;
     void setScheme(const Ogre::String&amp; schemeName);
@@ -713,4 +714,34 @@
     bool isValid() const;
 };
 
+// define as empty at this time. Must not yet be used from within ruby.
+class Job
+{
+private:
+	Job();
+};
+
+class PlaySound2dJob : public rl::Job
+{
+public:
+
+    PlaySound2dJob(const Ogre::String&amp; sound, Ogre::Real volume=1.0f);
+    virtual ~PlaySound2dJob();
+};
+
+class PlaySound3dJob : public rl::Job
+{
+public:
+
+    PlaySound3dJob(const Ogre::String&amp; sound, const Ogre::Vector3&amp; pos, Ogre::Real volume=1.0f);
+    virtual ~PlaySound3dJob();
+};
+
+class JobScheduler
+{
+public:
+	static JobScheduler&amp; getSingleton(void);
+    unsigned long addJob(rl::Job* job);
+};
+
 }

Modified: rl/trunk/engine/ui/src/DialogCharacterController.cpp
===================================================================
--- rl/trunk/engine/ui/src/DialogCharacterController.cpp	2007-02-18 13:03:24 UTC (rev 3054)
+++ rl/trunk/engine/ui/src/DialogCharacterController.cpp	2007-02-21 15:58:09 UTC (rev 3055)
@@ -237,12 +237,8 @@
                     mSoundObject-&gt;getMovableObject() );
 
             delete mSoundObject;
-            mSoundObject =
-                new SoundObject(
-                    SoundManager::getSingleton().getActiveDriver()-&gt;
-                        createSample(
-                            SoundManager::getSingleton().getByName(soundFile)),
-                    soundFile);
+            mSoundObject = new SoundObject(SoundManager::getSingleton().getActiveDriver()-&gt;
+                    createSound(soundFile, ST_SAMPLE), soundFile);
 
             // An Sprecher h&#228;ngen
             actor-&gt;_getSceneNode()-&gt;attachObject( mSoundObject-&gt;getMovableObject() );

Modified: rl/trunk/plugins/fmod4driver/include/Fmod4Driver.h
===================================================================
--- rl/trunk/plugins/fmod4driver/include/Fmod4Driver.h	2007-02-18 13:03:24 UTC (rev 3054)
+++ rl/trunk/plugins/fmod4driver/include/Fmod4Driver.h	2007-02-21 15:58:09 UTC (rev 3055)
@@ -45,6 +45,8 @@
         }\
     }
 
+    class Fmod4Sound;
+
     /** Diese Klasse ist der Treiber, der OpenAL zur
      * Ausgabe benutzt.
      */
@@ -95,20 +97,14 @@
         const DriverMap&amp; getDriverData() const;
 
         FMOD::System* _getFmodSystem();
+        void _registerForAutoDestruction(Fmod4Sound* sound, FMOD::Channel* channel);
 
     protected:
-        virtual Sound* createStreamImpl(const SoundResourcePtr &amp;res);
-        virtual Sound* createSampleImpl(const SoundResourcePtr &amp;res);
+        virtual Sound* createSoundImpl(SoundResourcePtr res, SoundType type);
 
     private:
-        /// Informationen &#239;&#191;&#189;ber den Treiber ausgeben
-        virtual void printData() const;
-        void printDriverInfo(int driver) const;
 
-        // Wir merken uns die Konfiguration von Fmod4
-        DriverMap mDriverData;
-        FMOD::System* mFmod4System;
-        FMOD::ChannelGroup* mMasterChannelGroup;
+        typedef std::map&lt;FMOD::Channel*, Fmod4Sound*&gt; ChannelSoundMap;
 
         static FMOD_RESULT F_CALLBACK open(
             const char *  name,
@@ -137,8 +133,26 @@
             void *  userdata
         );
 
+        static FMOD_RESULT F_CALLBACK channelCallback(
+            FMOD_CHANNEL* channel,
+            FMOD_CHANNEL_CALLBACKTYPE type,
+            int command,
+            unsigned int commanddata1,
+            unsigned int commanddata2
+        );
+
+        /// Log driver config data
+        virtual void printData() const;
+        void printDriverInfo(int driver) const;
+
+        // Wir merken uns die Konfiguration von Fmod4
+        DriverMap mDriverData;
+        /// Stores sounds that are automatically destroyed after having been played.
+        ChannelSoundMap mChannelSoundMap;
+        FMOD::System* mFmod4System;
+        FMOD::ChannelGroup* mMasterChannelGroup;
+
     };
-
 }
 
 #endif /*FMODDRIVER_H_*/

Modified: rl/trunk/plugins/fmod4driver/include/Fmod4Sound.h
===================================================================
--- rl/trunk/plugins/fmod4driver/include/Fmod4Sound.h	2007-02-18 13:03:24 UTC (rev 3054)
+++ rl/trunk/plugins/fmod4driver/include/Fmod4Sound.h	2007-02-21 15:58:09 UTC (rev 3055)
@@ -19,6 +19,7 @@
 #include &quot;Fmod4DriverPrerequisites.h&quot;
 
 #include &quot;Sound.h&quot;
+#include &quot;SoundDriver.h&quot;
 
 #if OGRE_PLATFORM == OGRE_PLATFORM_WIN32
     #include &lt;fmod.hpp&gt;
@@ -33,20 +34,14 @@
     class _RlFmod4DriverExport Fmod4Sound : public Sound
     {
     public:
-        enum SoundType 
-        {
-            SAMPLE,
-            STREAM
-        };
-
         /// Konstruktor
-        Fmod4Sound(Fmod4Driver* driver, const SoundResourcePtr &amp;soundres, SoundType type = SAMPLE);
+        Fmod4Sound(Fmod4Driver* driver, SoundResourcePtr soundres, SoundType type = ST_SAMPLE);
 
         /// Laedt den Sound.
         virtual void load() throw (RuntimeException);
         /// Entlaedt den Sound.
         virtual void unload() throw (RuntimeException);
-         // Wir geben zur&#239;&#191;&#189;ck, wie lange der Sound ist.
+        // Running length in seconds
 	    virtual float getLength() const;
 
 		// Sind wir gueltig
@@ -71,8 +66,7 @@
 		/// Setzt die Geschwindigkeit der Soundquelle.
 		virtual void setVelocity(const Ogre::Vector3&amp;);
 
-		/// Spielt den Sound ab.
-		virtual void play();
+        virtual void play(bool destroyWhenDone=false);
 		/// Pausiert den Sound.
 		virtual void pause(bool pausing);
 		/// Ist der Sound pausiert?
@@ -81,7 +75,7 @@
 		virtual void stop();
 		/// Laeuft der Sound noch
 		virtual const bool isPlaying() const;
-	    
+
     private:
 		/// Shared class-level name for Movable type
 		static Ogre::String msMovableType;

Modified: rl/trunk/plugins/fmod4driver/src/Fmod4Driver.cpp
===================================================================
--- rl/trunk/plugins/fmod4driver/src/Fmod4Driver.cpp	2007-02-18 13:03:24 UTC (rev 3054)
+++ rl/trunk/plugins/fmod4driver/src/Fmod4Driver.cpp	2007-02-21 15:58:09 UTC (rev 3055)
@@ -26,6 +26,7 @@
 {
     // Used by FMOD-Callbacks, which are not C++-functions, but C-functions.
     Ogre::ResourceManager* gSoundResourceManager = NULL;
+    Fmod4Driver* gDriver = NULL;
 
     String Fmod4Driver::NAME = &quot;RlFmod4Driver&quot;;
 
@@ -34,6 +35,7 @@
         mMasterChannelGroup(NULL)
     {
         gSoundResourceManager = soundResourceManager;
+        gDriver = this;
     }
 
     Fmod4Driver::~Fmod4Driver()
@@ -63,7 +65,7 @@
         mFmod4System-&gt;setDriver(-1);
         //CHECK_FMOD4_ERRORS(mFmod4System-&gt;setOutput(FMOD_OUTPUTTYPE_ESD));
 
-        FMOD_RESULT result = mFmod4System-&gt;init(MAX_VIRTUAL_CHANNELS, FMOD_INIT_NORMAL, NULL); //Alternative: ,Output)
+        FMOD_RESULT result = mFmod4System-&gt;init(MAX_VIRTUAL_CHANNELS, FMOD_INIT_NORMAL, NULL);
         if (result != FMOD_OK)
         {
             LOG_ERROR(Logger::CORE,
@@ -103,30 +105,12 @@
         mFmod4System-&gt;update();
     }
 
-    /**
-      * Einen Sound-Stream mit Resource erzeugen
-      * @return Der erzeugte Stream
-      * @author JoSch
-      * @date 03-06-2006
-      */
-    Sound *Fmod4Driver::createStreamImpl(const SoundResourcePtr &amp;res)
+    Sound* Fmod4Driver::createSoundImpl(SoundResourcePtr res, SoundType type)
     {
-         Sound *sound = new Fmod4Sound(this, res, Fmod4Sound::STREAM);
-         return sound;
+        Sound* sound = new Fmod4Sound(this, res, type);
+        return sound;
     }
 
-    /**
-     * Einen Sound-Sample mit Resource erzeugen
-     * @return Das erzeugte Sample
-     * @author JoSch
-     * @date 03-06-2006
-     */
-    Sound *Fmod4Driver::createSampleImpl(const SoundResourcePtr &amp;res)
-    {
-        Sound *sound = new Fmod4Sound(this, res, Fmod4Sound::SAMPLE);
-         return sound;
-    }
-
     ListenerMovable *Fmod4Driver::createListener(const Ogre::String &amp;name)
     {
         return new Fmod4Listener(name, mFmod4System);
@@ -284,11 +268,11 @@
     }
 
     FMOD_RESULT F_CALLBACK Fmod4Driver::read(
-        void *  handle,
-        void *  buffer,
+        void*  handle,
+        void*  buffer,
         unsigned int  sizebytes,
-        unsigned int *  bytesread,
-        void *  userdata)
+        unsigned int* bytesread,
+        void*  userdata)
     {
         if (handle == NULL)
         {
@@ -341,6 +325,23 @@
         return FMOD_ERR_INVALID_PARAM;
     }
 
+    FMOD_RESULT F_CALLBACK Fmod4Driver::channelCallback(
+        FMOD_CHANNEL* channel,
+        FMOD_CHANNEL_CALLBACKTYPE type,
+        int command,
+        unsigned int commanddata1,
+        unsigned int commanddata2)
+    {
+        // Look up sound for this channel
+        ChannelSoundMap::iterator it = gDriver-&gt;mChannelSoundMap.find((FMOD::Channel*)channel);
+        if (it != gDriver-&gt;mChannelSoundMap.end())
+        {
+            gDriver-&gt;destroySound(it-&gt;second);
+            gDriver-&gt;mChannelSoundMap.erase(it);
+        }
+        return FMOD_OK;
+    }
+
     void Fmod4Driver::setMasterVolume(const Ogre::Real&amp; vol)
     {
         SoundDriver::setMasterVolume(vol);
@@ -359,4 +360,11 @@
         mFmod4System-&gt;get3DSettings(NULL, NULL, &amp;factor);
         return factor;
     }
+
+    void Fmod4Driver::_registerForAutoDestruction(Fmod4Sound* sound, FMOD::Channel* channel)
+    {
+        FMOD_RESULT res = channel-&gt;setCallback(FMOD_CHANNEL_CALLBACKTYPE_END, channelCallback, 0);
+        CHECK_FMOD4_ERRORS(res);
+        mChannelSoundMap.insert(std::make_pair(channel, sound));
+    }
 }

Modified: rl/trunk/plugins/fmod4driver/src/Fmod4Sound.cpp
===================================================================
--- rl/trunk/plugins/fmod4driver/src/Fmod4Sound.cpp	2007-02-18 13:03:24 UTC (rev 3054)
+++ rl/trunk/plugins/fmod4driver/src/Fmod4Sound.cpp	2007-02-21 15:58:09 UTC (rev 3055)
@@ -26,8 +26,8 @@
 
 String Fmod4Sound::msMovableType = &quot;Fmod4Sound&quot;;
  
-Fmod4Sound::Fmod4Sound(Fmod4Driver* driver, const rl::SoundResourcePtr &amp;soundres, SoundType type)
-  : Sound(soundres),
+Fmod4Sound::Fmod4Sound(Fmod4Driver* driver, SoundResourcePtr soundres, SoundType type)
+  : Sound(soundres, driver),
     mType(type),
     mSound(NULL),
     mDriver(driver),
@@ -69,7 +69,7 @@
         mode |= FMOD_LOOP_OFF;
     }
 
-    if (mType == Fmod4Sound::SAMPLE)
+    if (mType == ST_SAMPLE)
     {
         FMOD_RESULT res = mDriver-&gt;_getFmodSystem()-&gt;createSound(
             getSoundResource()-&gt;getName().c_str(), 
@@ -79,7 +79,7 @@
 
         CHECK_FMOD4_ERRORS(res);
     }
-    else if (mType == Fmod4Sound::STREAM)
+    else if (mType == ST_STREAM)
     {
         FMOD_RESULT res = mDriver-&gt;_getFmodSystem()-&gt;createStream(
             getSoundResource()-&gt;getName().c_str(), 
@@ -89,6 +89,10 @@
 
         CHECK_FMOD4_ERRORS(res);
     }
+    else
+    {
+        RlFail(&quot;Unsupported SoundType.&quot;);
+    }
 }
 
 void Fmod4Sound::unload() throw (RuntimeException)
@@ -111,7 +115,7 @@
     return msMovableType;
 }
 
-void Fmod4Sound::play()
+void Fmod4Sound::play(bool destroyWhenDone)
 {
     if (!isValid())
     {
@@ -127,6 +131,10 @@
     CHECK_FMOD4_ERRORS(res);
 
     RlAssert1(mChannel != NULL);
+    if (destroyWhenDone)
+    {
+        mDriver-&gt;_registerForAutoDestruction(this, mChannel);
+    }
 
     float vol;
 	if (is3d())
@@ -142,7 +150,6 @@
     setPosition(mPosition);
     setDirection(mDirection);
 	setVelocity(mVelocity); 
-    //getSound()-&gt;_getFmodSound()-&gt;FSOUND_3D_SetMinMaxDistance(mChannel, mRolloffStartDistance, mRolloffEndDistance);
     pause(false);
     SoundPlayEvent event = SoundPlayEvent(this, SoundPlayEvent::STARTEVENT);
     dispatchEvent(&amp;event);

Modified: rl/trunk/plugins/openaldriver/include/OpenALDriver.h
===================================================================
--- rl/trunk/plugins/openaldriver/include/OpenALDriver.h	2007-02-18 13:03:24 UTC (rev 3054)
+++ rl/trunk/plugins/openaldriver/include/OpenALDriver.h	2007-02-21 15:58:09 UTC (rev 3055)
@@ -52,8 +52,7 @@
         virtual const Ogre::Real getRolloffFactor();
 
     protected:
-        virtual Sound* createStreamImpl(const SoundResourcePtr &amp;res);
-        virtual Sound* createSampleImpl(const SoundResourcePtr &amp;res);
+        virtual Sound* createSoundImpl(SoundResourcePtr res, SoundType type);
 
     private:
         /// Informationen &#252;ber den Treiber ausgeben

Modified: rl/trunk/plugins/openaldriver/include/OpenALSound.h
===================================================================
--- rl/trunk/plugins/openaldriver/include/OpenALSound.h	2007-02-18 13:03:24 UTC (rev 3054)
+++ rl/trunk/plugins/openaldriver/include/OpenALSound.h	2007-02-21 15:58:09 UTC (rev 3055)
@@ -54,8 +54,7 @@
     /// Setzt die Geschwindigkeit der Soundquelle.
     virtual void setVelocity(const Ogre::Vector3&amp;);
 
-    /// Spielt den Sound ab.
-    virtual void play();
+    virtual void play(bool destroyWhenDone=false);
     /// Pausiert den Sound.
     virtual void pause(bool pausing);
     /// Ist der Sound pausiert?

Modified: rl/trunk/plugins/openaldriver/src/OpenALDriver.cpp
===================================================================
--- rl/trunk/plugins/openaldriver/src/OpenALDriver.cpp	2007-02-18 13:03:24 UTC (rev 3054)
+++ rl/trunk/plugins/openaldriver/src/OpenALDriver.cpp	2007-02-21 15:58:09 UTC (rev 3055)
@@ -1,192 +1,191 @@
-/* This source file is part of Rastullahs Lockenpracht.
- * Copyright (C) 2003-2007 Team Pantheon. <A HREF="http://www.team-pantheon.de">http://www.team-pantheon.de</A>
- *
- *  This program is free software; you can redistribute it and/or modify
- *  it under the terms of the Clarified Artistic License.
- *
- *  This program is distributed in the hope that it will be useful,
- *  but WITHOUT ANY WARRANTY; without even the implied warranty of
- *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
- *  Clarified Artistic License for more details.
- *
- *  You should have received a copy of the Clarified Artistic License
- *  along with this program; if not you can get it here
- *  <A HREF="http://www.jpaulmorrison.com/fbp/artistic2.htm.">http://www.jpaulmorrison.com/fbp/artistic2.htm.</A>
- */
-#include &quot;OpenALDriver.h&quot;
-
-#if OGRE_PLATFORM == OGRE_PLATFORM_WIN32
-    // OpenAL 1.1 unter Windows
-//    extern &quot;C&quot; {
-//        #include &quot;al.h&quot;
-//        #include &quot;alc.h&quot;
-//    }
-//#else
-//    // OpenAL 1.0 unter Linux
-//    extern &quot;C&quot; {
-//        #include &quot;AL/al.h&quot;
-//        #include &quot;AL/alc.h&quot;
-//    }
-#endif
-
-#include &quot;OpenALSoundSample.h&quot;
-#include &quot;OpenALSoundStream.h&quot;
-#include &quot;OpenALListener.h&quot;
-
-namespace rl
-{
-    Ogre::String rl::OpenALDriver::NAME = &quot;RlOpenALDriver&quot;;
-
-    /**
-     * Konstruktor
-     * @author JoSch
-     * @date 12-23-2005
-     */
-    OpenALDriver::OpenALDriver(Ogre::ResourceManager* soundResourceManager)
-    : SoundDriver(soundResourceManager)
-    {
-    }
-
-    /**
-     * Destruktor
-     * @author JoSch
-     * @date 12-23-2005
-     */
-    OpenALDriver::~OpenALDriver()
-    {
-    }
-
-    /**
-     * Zeigt an, ob der Treiber funktionsf&#228;hig ist.
-     * @return Immer TRUE.
-     * @author JoSch
-     * @date 12-23-2005
-     */
-    bool OpenALDriver::isDriverAvailable()
-    {
-        //try {
-        //    // Clear error code
-        //    alGetError();
-        //    ALCdevice *device = alcOpenDevice(0);
-        //
-        //    if (device == 0)
-        //    {
-        //        return false;
-        //    }
-        //
-        //    //Create context(s)
-        //    ALCcontext *context = alcCreateContext(device, 0);
-        //    //Set active context
-        //    alcMakeContextCurrent(context);
-        //    // Get Error Code
-        //    ALenum success = alGetError();
-        //    //Disable context
-        //    alcMakeContextCurrent(0);
-        //    //Release context(s)
-        //    alcDestroyContext(context);
-        //    //Close device
-        //    alcCloseDevice(device);
-        //
-        //    return (success == AL_NO_ERROR);
-        //} catch (...)
-        //{
-            return false;
-        //}
-    }
-
-    /**
-     * Starte den Treiber und mache alle Initialisierung.
-     * @author JoSch
-     * @date 12-23-2005
-     */
-    bool OpenALDriver::initialize()
-    {
-        return true;
-    }
-
-    /**
-     * Beeende den Treiber und gib alle Resourcen frei.
-     * @author JoSch
-     * @date 12-23-2005
-     */
-    void OpenALDriver::shutdown()
-    {
-    }
-
-    /**
-     * Gibt den Anzeigename des Treiber zur&#252;ck.
-     * @return Anzeigename
-     * @author JoSch
-     * @date 12-23-2005
-     */
-    Ogre::String OpenALDriver::getName() const
-    {
-        return NAME;
-    }
-
-    /**
-     * Update-Aufgaben erledigen
-     * @author JoSch
-     * @date 03-06-2006
-     */
-     void OpenALDriver::update()
-     {
-         // Erstmal nichts zu tun.
-     }
-
-     /**
-      * Einen Sound-Stream mit Resource erzeugen
-      * @return Der erzeugte Stream
-      * @author JoSch
-      * @date 03-06-2006
-      */
-    Sound* OpenALDriver::createStreamImpl(const SoundResourcePtr &amp;res)
-    {
-         Sound *sound = new OpenALSoundStream(this, res);
-         return sound;
-    }
-
-    /**
-     * Einen Sound-Sample mit Resource erzeugen
-     * @return Das erzeugte Sample
-     * @author JoSch
-     * @date 03-06-2006
-     */
-    Sound* OpenALDriver::createSampleImpl(const SoundResourcePtr &amp;res)
-    {
-         Sound *sound = new OpenALSoundSample(this, res);
-         return sound;
-    }
-
-    /**
-     * Einen Soundlistener erzeugen
-     * @return Der erzeugte Listener
-     * @param name Der Name des Channels.
-     * @author JoSch
-     * @date 04-04-2006
-     */
-    ListenerMovable *OpenALDriver::createListener(const Ogre::String &amp;name)
-    {
-        ListenerMovable *listener = new OpenALListener(name);
-        return listener;
-    }
-
-    /**
-     * Ausdruck einiger Werte des Soundsystems.
-     * @author JoSch
-     * @date 01-20-2006
-     */
-    void OpenALDriver::printData() const
-    {
-    }
-
-    void OpenALDriver::setRolloffFactor(const Ogre::Real&amp; f)
-    {
-    }
-
-    const Ogre::Real OpenALDriver::getRolloffFactor()
-    {
-        return 1.0;
-    }
-
-}
+/* This source file is part of Rastullahs Lockenpracht.
+ * Copyright (C) 2003-2007 Team Pantheon. <A HREF="http://www.team-pantheon.de">http://www.team-pantheon.de</A>
+ *
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the Clarified Artistic License.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  Clarified Artistic License for more details.
+ *
+ *  You should have received a copy of the Clarified Artistic License
+ *  along with this program; if not you can get it here
+ *  <A HREF="http://www.jpaulmorrison.com/fbp/artistic2.htm.">http://www.jpaulmorrison.com/fbp/artistic2.htm.</A>
+ */
+#include &quot;OpenALDriver.h&quot;
+
+#if OGRE_PLATFORM == OGRE_PLATFORM_WIN32
+    // OpenAL 1.1 unter Windows
+//    extern &quot;C&quot; {
+//        #include &quot;al.h&quot;
+//        #include &quot;alc.h&quot;
+//    }
+//#else
+//    // OpenAL 1.0 unter Linux
+//    extern &quot;C&quot; {
+//        #include &quot;AL/al.h&quot;
+//        #include &quot;AL/alc.h&quot;
+//    }
+#endif
+
+#include &quot;OpenALSoundSample.h&quot;
+#include &quot;OpenALSoundStream.h&quot;
+#include &quot;OpenALListener.h&quot;
+
+namespace rl
+{
+    Ogre::String rl::OpenALDriver::NAME = &quot;RlOpenALDriver&quot;;
+
+    /**
+     * Konstruktor
+     * @author JoSch
+     * @date 12-23-2005
+     */
+    OpenALDriver::OpenALDriver(Ogre::ResourceManager* soundResourceManager)
+    : SoundDriver(soundResourceManager)
+    {
+    }
+
+    /**
+     * Destruktor
+     * @author JoSch
+     * @date 12-23-2005
+     */
+    OpenALDriver::~OpenALDriver()
+    {
+    }
+
+    /**
+     * Zeigt an, ob der Treiber funktionsf&#228;hig ist.
+     * @return Immer TRUE.
+     * @author JoSch
+     * @date 12-23-2005
+     */
+    bool OpenALDriver::isDriverAvailable()
+    {
+        //try {
+        //    // Clear error code
+        //    alGetError();
+        //    ALCdevice *device = alcOpenDevice(0);
+        //
+        //    if (device == 0)
+        //    {
+        //        return false;
+        //    }
+        //
+        //    //Create context(s)
+        //    ALCcontext *context = alcCreateContext(device, 0);
+        //    //Set active context
+        //    alcMakeContextCurrent(context);
+        //    // Get Error Code
+        //    ALenum success = alGetError();
+        //    //Disable context
+        //    alcMakeContextCurrent(0);
+        //    //Release context(s)
+        //    alcDestroyContext(context);
+        //    //Close device
+        //    alcCloseDevice(device);
+        //
+        //    return (success == AL_NO_ERROR);
+        //} catch (...)
+        //{
+            return false;
+        //}
+    }
+
+    /**
+     * Starte den Treiber und mache alle Initialisierung.
+     * @author JoSch
+     * @date 12-23-2005
+     */
+    bool OpenALDriver::initialize()
+    {
+        return true;
+    }
+
+    /**
+     * Beeende den Treiber und gib alle Resourcen frei.
+     * @author JoSch
+     * @date 12-23-2005
+     */
+    void OpenALDriver::shutdown()
+    {
+    }
+
+    /**
+     * Gibt den Anzeigename des Treiber zur&#252;ck.
+     * @return Anzeigename
+     * @author JoSch
+     * @date 12-23-2005
+     */
+    Ogre::String OpenALDriver::getName() const
+    {
+        return NAME;
+    }
+
+    /**
+     * Update-Aufgaben erledigen
+     * @author JoSch
+     * @date 03-06-2006
+     */
+     void OpenALDriver::update()
+     {
+         // Erstmal nichts zu tun.
+     }
+
+     /**
+      * Einen Sound-Stream mit Resource erzeugen
+      * @return Der erzeugte Stream
+      * @author JoSch
+      * @date 03-06-2006
+      */
+    Sound* OpenALDriver::createSoundImpl(SoundResourcePtr res, SoundType type)
+    {
+         Sound* sound = NULL;
+         if (type == ST_STREAM)
+         {
+             sound = new OpenALSoundStream(this, res);
+         }
+         else if (type == ST_SAMPLE)
+         {
+             sound = new OpenALSoundSample(this, res);
+         }
+         else
+         {
+             RlFail(&quot;Unsupported SoundType.&quot;);
+         }
+         return sound;
+    }
+
+    /**
+     * Einen Soundlistener erzeugen
+     * @return Der erzeugte Listener
+     * @param name Der Name des Channels.
+     * @author JoSch
+     * @date 04-04-2006
+     */
+    ListenerMovable *OpenALDriver::createListener(const Ogre::String &amp;name)
+    {
+        ListenerMovable *listener = new OpenALListener(name);
+        return listener;
+    }
+
+    /**
+     * Ausdruck einiger Werte des Soundsystems.
+     * @author JoSch
+     * @date 01-20-2006
+     */
+    void OpenALDriver::printData() const
+    {
+    }
+
+    void OpenALDriver::setRolloffFactor(const Ogre::Real&amp; f)
+    {
+    }
+
+    const Ogre::Real OpenALDriver::getRolloffFactor()
+    {
+        return 1.0;
+    }
+}

Modified: rl/trunk/plugins/openaldriver/src/OpenALSound.cpp
===================================================================
--- rl/trunk/plugins/openaldriver/src/OpenALSound.cpp	2007-02-18 13:03:24 UTC (rev 3054)
+++ rl/trunk/plugins/openaldriver/src/OpenALSound.cpp	2007-02-21 15:58:09 UTC (rev 3055)
@@ -16,6 +16,7 @@
 #include &quot;OpenALSound.h&quot;
 
 #include &quot;OpenALDriver.h&quot;
+#include &quot;Logger.h&quot;
 
 Ogre::String rl::OpenALSound::msMovableType = &quot;OpenALSound&quot;;
 
@@ -25,7 +26,7 @@
 {
 
 OpenALSound::OpenALSound(OpenALDriver* driver, const SoundResourcePtr&amp; res)
- : Sound(res),
+ : Sound(res, driver),
    mDriver(driver),
    mChannel(NO_CHANNEL)
 {   
@@ -39,7 +40,7 @@
  * @author JoSch
  * @date 07-23-2005
  */
-void OpenALSound::play()
+void OpenALSound::play(bool destroyWhenDone)
 {
     if (!isValid())
     {
@@ -51,6 +52,13 @@
     setDirection(mDirection);
     setVelocity(mVelocity); 
     pause(false);
+
+    // OpenAL Driver doesn't handle destroyWhenDone yet, so warn about it
+    if (destroyWhenDone)
+    {
+        LOG_WARNING(Logger::MULTIMEDIA, &quot;Sound zum automatischen l&#246;schen regisitert, aber\
+ OpenAL-Treiber unterst&#252;tzt diese Option nicht. Memory-Leak.&quot;);
+    }
 }
 
 float OpenALSound::getLength() const


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000125.html">[Dsa-hl-svn] r3054 - rl/trunk/engine/core/src
</A></li>
	<LI>Next message: <A HREF="000127.html">[Dsa-hl-svn] r3056 - in modules/common/scripts: . jobs
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#126">[ date ]</a>
              <a href="thread.html#126">[ thread ]</a>
              <a href="subject.html#126">[ subject ]</a>
              <a href="author.html#126">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/dsa-hl-svn">More information about the Dsa-hl-svn
mailing list</a><br>
</body></html>
