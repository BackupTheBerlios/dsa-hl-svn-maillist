<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Dsa-hl-svn] r3585 - modules/common/gui/windows rl/trunk/engine/ui	rl/trunk/engine/ui/include rl/trunk/engine/ui/src
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/dsa-hl-svn/2007-July/index.html" >
   <LINK REL="made" HREF="mailto:dsa-hl-svn%40lists.berlios.de?Subject=Re%3A%20%5BDsa-hl-svn%5D%20r3585%20-%20modules/common/gui/windows%20rl/trunk/engine/ui%0A%09rl/trunk/engine/ui/include%20rl/trunk/engine/ui/src&In-Reply-To=%3C200707032222.l63MM2wp020064%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000655.html">
   <LINK REL="Next"  HREF="000657.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Dsa-hl-svn] r3585 - modules/common/gui/windows rl/trunk/engine/ui	rl/trunk/engine/ui/include rl/trunk/engine/ui/src</H1>
    <B>blakharaz at mail.berlios.de</B> 
    <A HREF="mailto:dsa-hl-svn%40lists.berlios.de?Subject=Re%3A%20%5BDsa-hl-svn%5D%20r3585%20-%20modules/common/gui/windows%20rl/trunk/engine/ui%0A%09rl/trunk/engine/ui/include%20rl/trunk/engine/ui/src&In-Reply-To=%3C200707032222.l63MM2wp020064%40sheep.berlios.de%3E"
       TITLE="[Dsa-hl-svn] r3585 - modules/common/gui/windows rl/trunk/engine/ui	rl/trunk/engine/ui/include rl/trunk/engine/ui/src">blakharaz at mail.berlios.de
       </A><BR>
    <I>Wed Jul  4 00:22:02 CEST 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="000655.html">[Dsa-hl-svn] r3584 - in rl/trunk/engine/ui: include src
</A></li>
        <LI>Next message: <A HREF="000657.html">[Dsa-hl-svn] r3586 - in modules/common: materials materials/model	materials/programs models
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#656">[ date ]</a>
              <a href="thread.html#656">[ thread ]</a>
              <a href="subject.html#656">[ subject ]</a>
              <a href="author.html#656">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: blakharaz
Date: 2007-07-04 00:21:46 +0200 (Wed, 04 Jul 2007)
New Revision: 3585

Added:
   modules/common/gui/windows/itemdescriptiondragcontainer.xml
   modules/common/gui/windows/itemicondragcontainer.xml
   rl/trunk/engine/ui/include/ItemDescriptionDragContainer.h
   rl/trunk/engine/ui/include/ItemIconDragContainer.h
   rl/trunk/engine/ui/src/ItemDescriptionDragContainer.cpp
   rl/trunk/engine/ui/src/ItemIconDragContainer.cpp
Modified:
   rl/trunk/engine/ui/RlUI2005.vcproj
   rl/trunk/engine/ui/include/AbstractWindow.h
   rl/trunk/engine/ui/include/InventoryWindow.h
   rl/trunk/engine/ui/include/ItemDragContainer.h
   rl/trunk/engine/ui/include/Makefile.am
   rl/trunk/engine/ui/src/ContainerContentWindow.cpp
   rl/trunk/engine/ui/src/InventoryWindow.cpp
   rl/trunk/engine/ui/src/ItemDragContainer.cpp
   rl/trunk/engine/ui/src/Makefile.am
Log:
Present item description in a nice window when selecting gameobjects in world

Added: modules/common/gui/windows/itemdescriptiondragcontainer.xml
===================================================================
--- modules/common/gui/windows/itemdescriptiondragcontainer.xml	2007-07-03 19:57:10 UTC (rev 3584)
+++ modules/common/gui/windows/itemdescriptiondragcontainer.xml	2007-07-03 22:21:46 UTC (rev 3585)
@@ -0,0 +1,28 @@
+&lt;GUILayout xmlns:xsi=&quot;<A HREF="http://www.w3.org/2001/XMLSchema-instance">http://www.w3.org/2001/XMLSchema-instance</A>&quot; xsi:noNamespaceSchemaLocation=&quot;GUILayout.xsd&quot;&gt;
+    &lt;Window Type=&quot;DefaultWindow&quot; Name=&quot;ItemDescriptionDragContainer&quot;&gt;
+		&lt;Property Name=&quot;UnifiedSize&quot; Value=&quot;{{0,250},{0,120}}&quot; /&gt;
+        &lt;Window Type=&quot;RastullahLook/StaticImage&quot; Name=&quot;ItemDescriptionDragContainer/Icon&quot;&gt;
+            &lt;Property Name=&quot;VerticalAlignment&quot; Value=&quot;Bottom&quot; /&gt;
+            &lt;Property Name=&quot;HorizontalAlignment&quot; Value=&quot;Left&quot; /&gt;
+            &lt;Property Name=&quot;UnifiedPosition&quot; Value=&quot;{{0,2},{0,2}}&quot; /&gt;
+            &lt;Property Name=&quot;UnifiedSize&quot; Value=&quot;{{0,90},{0,90}}&quot; /&gt;
+			&lt;Property Name=&quot;FrameEnabled&quot; Value=&quot;False&quot;/&gt;
+        &lt;/Window&gt;
+        &lt;Window Type=&quot;RastullahLook/StaticText&quot; Name=&quot;ItemDescriptionDragContainer/Name&quot;&gt;
+            &lt;Property Name=&quot;VerticalAlignment&quot; Value=&quot;Top&quot; /&gt;
+            &lt;Property Name=&quot;HorizontalAlignment&quot; Value=&quot;Center&quot; /&gt;
+            &lt;Property Name=&quot;UnifiedPosition&quot; Value=&quot;{{0.0,100},{0,5}}&quot; /&gt;
+            &lt;Property Name=&quot;UnifiedSize&quot; Value=&quot;{{0.95,-100},{0,24}}&quot; /&gt;
+            &lt;Property Name=&quot;Font&quot; Value=&quot;Vera Serif-10&quot; /&gt;
+            &lt;Property Name=&quot;FrameEnabled&quot; Value=&quot;false&quot; /&gt;
+        &lt;/Window&gt;
+        &lt;Window Type=&quot;RastullahLook/MultiLineEditbox&quot; Name=&quot;ItemDescriptionDragContainer/Description&quot;&gt;
+            &lt;Property Name=&quot;ReadOnly&quot; Value=&quot;true&quot;/&gt;
+            &lt;Property Name=&quot;Disabled&quot; Value=&quot;true&quot;/&gt;
+            &lt;Property Name=&quot;UnifiedPosition&quot; Value=&quot;{{0.0,100},{0,30}}&quot; /&gt;
+            &lt;Property Name=&quot;UnifiedSize&quot; Value=&quot;{{0.95,-100},{0.95,-30}}&quot; /&gt;
+            &lt;Property Name=&quot;Font&quot; Value=&quot;Vera Serif-8&quot; /&gt;
+            &lt;Property Name=&quot;FrameEnabled&quot; Value=&quot;false&quot; /&gt;
+        &lt;/Window&gt;
+    &lt;/Window&gt;
+&lt;/GUILayout&gt; 

Added: modules/common/gui/windows/itemicondragcontainer.xml
===================================================================
--- modules/common/gui/windows/itemicondragcontainer.xml	2007-07-03 19:57:10 UTC (rev 3584)
+++ modules/common/gui/windows/itemicondragcontainer.xml	2007-07-03 22:21:46 UTC (rev 3585)
@@ -0,0 +1,11 @@
+&lt;GUILayout xmlns:xsi=&quot;<A HREF="http://www.w3.org/2001/XMLSchema-instance">http://www.w3.org/2001/XMLSchema-instance</A>&quot; xsi:noNamespaceSchemaLocation=&quot;GUILayout.xsd&quot;&gt;
+    &lt;Window Type=&quot;DefaultWindow&quot; Name=&quot;ItemIconDragContainer&quot;&gt;
+        &lt;Window Type=&quot;RastullahLook/StaticImage&quot; Name=&quot;ItemIconDragContainer/Icon&quot;&gt;
+            &lt;Property Name=&quot;VerticalAlignment&quot; Value=&quot;Bottom&quot; /&gt;
+            &lt;Property Name=&quot;HorizontalAlignment&quot; Value=&quot;Left&quot; /&gt;
+            &lt;Property Name=&quot;UnifiedPosition&quot; Value=&quot;{{0,0},{0,0}}&quot; /&gt;
+            &lt;Property Name=&quot;UnifiedSize&quot; Value=&quot;{{1,0},{1,0}}&quot; /&gt;
+			&lt;Property Name=&quot;FrameEnabled&quot; Value=&quot;False&quot;/&gt;
+        &lt;/Window&gt;
+    &lt;/Window&gt;
+&lt;/GUILayout&gt; 

Modified: rl/trunk/engine/ui/RlUI2005.vcproj
===================================================================
--- rl/trunk/engine/ui/RlUI2005.vcproj	2007-07-03 19:57:10 UTC (rev 3584)
+++ rl/trunk/engine/ui/RlUI2005.vcproj	2007-07-03 22:21:46 UTC (rev 3585)
@@ -469,10 +469,18 @@
 					&gt;
 				&lt;/File&gt;
 				&lt;File
+					RelativePath=&quot;.\include\ItemDescriptionDragContainer.h&quot;
+					&gt;
+				&lt;/File&gt;
+				&lt;File
 					RelativePath=&quot;.\include\ItemDragContainer.h&quot;
 					&gt;
 				&lt;/File&gt;
 				&lt;File
+					RelativePath=&quot;.\include\ItemIconDragContainer.h&quot;
+					&gt;
+				&lt;/File&gt;
+				&lt;File
 					RelativePath=&quot;.\include\JournalWindow.h&quot;
 					&gt;
 				&lt;/File&gt;
@@ -662,10 +670,18 @@
 					&gt;
 				&lt;/File&gt;
 				&lt;File
+					RelativePath=&quot;.\src\ItemDescriptionDragContainer.cpp&quot;
+					&gt;
+				&lt;/File&gt;
+				&lt;File
 					RelativePath=&quot;.\src\ItemDragContainer.cpp&quot;
 					&gt;
 				&lt;/File&gt;
 				&lt;File
+					RelativePath=&quot;.\src\ItemIconDragContainer.cpp&quot;
+					&gt;
+				&lt;/File&gt;
+				&lt;File
 					RelativePath=&quot;.\src\JournalWindow.cpp&quot;
 					&gt;
 				&lt;/File&gt;

Modified: rl/trunk/engine/ui/include/AbstractWindow.h
===================================================================
--- rl/trunk/engine/ui/include/AbstractWindow.h	2007-07-03 19:57:10 UTC (rev 3584)
+++ rl/trunk/engine/ui/include/AbstractWindow.h	2007-07-03 22:21:46 UTC (rev 3585)
@@ -57,7 +57,10 @@
 
 		/// creates a CEGUI window from an XML file, should only be used to load window parts (e.g. buttons)
 		static CEGUI::Window* loadWindow(const CeGuiString&amp; xmlfile);
-		
+
+		/// creates a CEGUI window from an XML file, should only be used to load window parts (e.g. buttons)
+		static CEGUI::Window* loadWindow(const CeGuiString&amp; xmlfile, CeGuiString&amp; prefix);
+
 		/// gets the CEGUI root
 		static CEGUI::Window* getRoot();
 
@@ -109,8 +112,6 @@
 		void bindDestroyWindowToXButton();
 		void bindHideWindowToXButton();
 
-		static CEGUI::Window* loadWindow(const CeGuiString&amp; xmlfile, CeGuiString&amp; prefix);
-
 		const CeGuiString&amp; getUserDataType(CEGUI::Window* window) const;
 		void setUserDataType(CEGUI::Window* window, const CeGuiString&amp; typeDescription) const;
 

Modified: rl/trunk/engine/ui/include/InventoryWindow.h
===================================================================
--- rl/trunk/engine/ui/include/InventoryWindow.h	2007-07-03 19:57:10 UTC (rev 3584)
+++ rl/trunk/engine/ui/include/InventoryWindow.h	2007-07-03 22:21:46 UTC (rev 3585)
@@ -19,10 +19,13 @@
 
 #include &quot;UiPrerequisites.h&quot;
 
+#include &lt;OgreRectangle.h&gt;
+
 #include &quot;AbstractWindow.h&quot;
 
 namespace rl {
 
+	class CameraObject;
     class Inventory;
 	class Item;
 	class ItemDragContainer;
@@ -31,8 +34,6 @@
 	class _RlUiExport InventoryWindow : public AbstractWindow
 	{
 	public:
-		///@todo where to put this, it is used in ContainerContentWindow too
-		static const Ogre::String ICON_UNKNOWN_ITEM;
 		static const Ogre::String SLOTNAME;
 
 		InventoryWindow(const Ogre::String&amp; inventoryWindow, Inventory* inventory);
@@ -50,7 +51,7 @@
 		void createSlotWindows(Inventory* inventory);
         void initInventoryWindow(Inventory* inventory);
 
-		ItemDragContainer* createItemDragContainer(Item* item, const CeGuiString&amp; containerName = &quot;&quot;);
+		ItemDragContainer* createItemDragContainer(Item* item, bool showdescription, const CeGuiString&amp; containerName = &quot;&quot;);
 		bool handleItemDroppedOnSlot(const CEGUI::EventArgs&amp; evt);
 		bool handleItemDroppedOnWorld(const CEGUI::EventArgs&amp; evt);
 		bool handleItemMouseClick(const CEGUI::EventArgs&amp; evt, Item* item);
@@ -58,6 +59,10 @@
 		bool handleMouseMovedInWorld(const CEGUI::EventArgs&amp; evt);
 		bool handleKeys(const CEGUI::EventArgs&amp; evt, bool down);
 		bool destroyDragContainer(ItemDragContainer* cont);
+
+		Ogre::Rectangle getCeGuiRectFromWorldAABB(
+			CameraObject* camera,
+			const Ogre::AxisAlignedBox&amp; aabb) const;
     };
 }
 

Added: rl/trunk/engine/ui/include/ItemDescriptionDragContainer.h
===================================================================
--- rl/trunk/engine/ui/include/ItemDescriptionDragContainer.h	2007-07-03 19:57:10 UTC (rev 3584)
+++ rl/trunk/engine/ui/include/ItemDescriptionDragContainer.h	2007-07-03 22:21:46 UTC (rev 3585)
@@ -0,0 +1,33 @@
+/* This source file is part of Rastullahs Lockenpracht.
+ * Copyright (C) 2003-2007 Team Pantheon. <A HREF="http://www.team-pantheon.de">http://www.team-pantheon.de</A>
+ * 
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the Clarified Artistic License.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  Clarified Artistic License for more details.
+ *
+ *  You should have received a copy of the Clarified Artistic License
+ *  along with this program; if not you can get it here
+ *  <A HREF="http://www.jpaulmorrison.com/fbp/artistic2.htm.">http://www.jpaulmorrison.com/fbp/artistic2.htm.</A>
+ */
+#ifndef __ItemDescriptionDragContainer_H__
+#define __ItemDescriptionDragContainer_H__
+
+#include &quot;UiPrerequisites.h&quot;
+
+#include &quot;ItemDragContainer.h&quot;
+
+namespace rl 
+{
+	class ItemDescriptionDragContainer : public ItemDragContainer
+	{
+	public:
+		ItemDescriptionDragContainer(Item* item, const CeGuiString&amp; name);
+	};
+
+} // namespace rl
+
+#endif //__ItemDescriptionDragContainer_H__

Modified: rl/trunk/engine/ui/include/ItemDragContainer.h
===================================================================
--- rl/trunk/engine/ui/include/ItemDragContainer.h	2007-07-03 19:57:10 UTC (rev 3584)
+++ rl/trunk/engine/ui/include/ItemDragContainer.h	2007-07-03 22:21:46 UTC (rev 3585)
@@ -30,8 +30,10 @@
 	class ItemDragContainer : public CEGUI::DragContainer
 	{
 	public:
-		ItemDragContainer(Item* item, const CeGuiString&amp; name);
+		static const Ogre::String ICON_UNKNOWN_ITEM;
 		
+		~ItemDragContainer();
+		
 		void setItemParent(Container* container);
 		void setItemParent(Inventory* inventory, const CeGuiString&amp; slotname);
 		Container* getItemParentContainer() const;
@@ -39,9 +41,11 @@
 		Inventory* getItemParentInventory() const;
 		Item* getItem() const;
 		CEGUI::Window* getContentWindow() const;
-		void setContentWindow(CEGUI::Window* window);
-
+	
 	protected:
+		CEGUI::Window* mContentWindow;
+		
+		ItemDragContainer(Item* item, const CeGuiString&amp; name);
 		virtual bool testClassName_impl(const CEGUI::String&amp; class_name) const;
 
 	private:
@@ -49,7 +53,6 @@
 		Container* mParentContainer;
 		CeGuiString mParentSlot;
 		Inventory* mInventory;
-		CEGUI::Window* mContentWindow;
 	};
 
 } // namespace rl

Added: rl/trunk/engine/ui/include/ItemIconDragContainer.h
===================================================================
--- rl/trunk/engine/ui/include/ItemIconDragContainer.h	2007-07-03 19:57:10 UTC (rev 3584)
+++ rl/trunk/engine/ui/include/ItemIconDragContainer.h	2007-07-03 22:21:46 UTC (rev 3585)
@@ -0,0 +1,35 @@
+/* This source file is part of Rastullahs Lockenpracht.
+ * Copyright (C) 2003-2007 Team Pantheon. <A HREF="http://www.team-pantheon.de">http://www.team-pantheon.de</A>
+ * 
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the Clarified Artistic License.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  Clarified Artistic License for more details.
+ *
+ *  You should have received a copy of the Clarified Artistic License
+ *  along with this program; if not you can get it here
+ *  <A HREF="http://www.jpaulmorrison.com/fbp/artistic2.htm.">http://www.jpaulmorrison.com/fbp/artistic2.htm.</A>
+ */
+#ifndef __ItemIconDragContainer_H__
+#define __ItemIconDragContainer_H__
+
+#include &quot;UiPrerequisites.h&quot;
+
+#include &quot;ItemDragContainer.h&quot;
+
+namespace rl 
+{
+	class Item;
+
+	class ItemIconDragContainer : public ItemDragContainer
+	{
+	public:
+		ItemIconDragContainer(Item* item, const CeGuiString&amp; name);
+	};
+
+} // namespace rl
+
+#endif //__ItemIconDragContainer_H__

Modified: rl/trunk/engine/ui/include/Makefile.am
===================================================================
--- rl/trunk/engine/ui/include/Makefile.am	2007-07-03 19:57:10 UTC (rev 3584)
+++ rl/trunk/engine/ui/include/Makefile.am	2007-07-03 22:21:46 UTC (rev 3585)
@@ -27,6 +27,8 @@
     InputManager.h \
     InventoryWindow.h \
     ItemDragContainer.h \
+    ItemDescriptionDragContainer.h \
+    ItemIconDragContainer.h \
     JournalWindow.h \
     ListboxWrappedTextItem.h \
     LogWindow.h \

Modified: rl/trunk/engine/ui/src/ContainerContentWindow.cpp
===================================================================
--- rl/trunk/engine/ui/src/ContainerContentWindow.cpp	2007-07-03 19:57:10 UTC (rev 3584)
+++ rl/trunk/engine/ui/src/ContainerContentWindow.cpp	2007-07-03 22:21:46 UTC (rev 3585)
@@ -23,8 +23,7 @@
 
 #include &quot;Container.h&quot;
 #include &quot;Inventory.h&quot;
-#include &quot;InventoryWindow.h&quot;
-#include &quot;ItemDragContainer.h&quot;
+#include &quot;ItemIconDragContainer.h&quot;
 #include &quot;WindowFactory.h&quot;
 
 using namespace CEGUI;
@@ -133,32 +132,26 @@
 
 		if (icon == &quot;&quot;)
 		{
-			icon = InventoryWindow::ICON_UNKNOWN_ITEM;
+			icon = ItemDragContainer::ICON_UNKNOWN_ITEM;
 		}
 
-        LOG_MESSAGE(&quot;IW&quot;, icon);
-        Window* itemWindow = 
-	        CEGUI::WindowManager::getSingletonPtr()-&gt;createWindow(
-		    &quot;RastullahLook/StaticImage&quot;, 
-			mWindow-&gt;getName() + &quot;/&quot; + icon 
-			+ &quot;/&quot; + CEGUI::PropertyHelper::intToString(sItemCount++));
-        itemWindow-&gt;setProperty(&quot;Image&quot;, icon);
-        itemWindow-&gt;setPosition(UVector2(cegui_reldim(0), cegui_reldim(0)));
-        itemWindow-&gt;setSize(
-            UVector2(cegui_absdim(item-&gt;getSize().first*30),
-                     cegui_absdim(item-&gt;getSize().second*30)));
+   //     LOG_MESSAGE(&quot;IW&quot;, icon);
+   //     Window* itemWindow = 
+	  //      CEGUI::WindowManager::getSingletonPtr()-&gt;createWindow(
+		 //   &quot;RastullahLook/StaticImage&quot;, 
+			//mWindow-&gt;getName() + &quot;/&quot; + icon 
+			//+ &quot;/&quot; + CEGUI::PropertyHelper::intToString(sItemCount++));
+   //     itemWindow-&gt;setProperty(&quot;Image&quot;, icon);
+   //     itemWindow-&gt;setPosition(UVector2(cegui_reldim(0), cegui_reldim(0)));
+   //     itemWindow-&gt;setSize(UVector2(cegui_reldim(1), cegui_reldim(1)));
+		CeGuiString dragContainerName = 
+			mWindow-&gt;getName() +  &quot;/item/&quot; 
+			+ Ogre::StringConverter::toString(item-&gt;getId())+&quot;_DragContainer&quot;;
 
-		ItemDragContainer* itemhandler = new ItemDragContainer(item, 
-			&quot;DragContainer_&quot;+itemWindow-&gt;getName());
+		ItemDragContainer* itemhandler = new ItemIconDragContainer(item, 
+			dragContainerName);
 		itemhandler-&gt;setItemParent(mContainer);
 		itemhandler-&gt;setPosition(UVector2(cegui_reldim(0), cegui_reldim(0)));
-		itemhandler-&gt;setSize(
-			UVector2(cegui_absdim(item-&gt;getSize().first*30),
-					 cegui_absdim(item-&gt;getSize().second*30))); 
-		itemhandler-&gt;setUserData(item);
-		itemhandler-&gt;setTooltipText(item-&gt;getName());
-		itemhandler-&gt;addChildWindow(itemWindow);
-		
 
 		return itemhandler;
 	}

Modified: rl/trunk/engine/ui/src/InventoryWindow.cpp
===================================================================
--- rl/trunk/engine/ui/src/InventoryWindow.cpp	2007-07-03 19:57:10 UTC (rev 3584)
+++ rl/trunk/engine/ui/src/InventoryWindow.cpp	2007-07-03 22:21:46 UTC (rev 3585)
@@ -26,16 +26,17 @@
 #include &quot;Creature.h&quot;
 #include &quot;Inventory.h&quot;
 #include &quot;Item.h&quot;
-#include &quot;ItemDragContainer.h&quot;
+#include &quot;ItemDescriptionDragContainer.h&quot;
+#include &quot;ItemIconDragContainer.h&quot;
 #include &quot;Selector.h&quot;
 #include &quot;WindowFactory.h&quot;
 
 using namespace CEGUI;
+using namespace Ogre;
 using namespace std;
 
 namespace rl {
 
-	const Ogre::String InventoryWindow::ICON_UNKNOWN_ITEM = &quot;set:ModelThumbnails image:item_unknown&quot;;
 	const Ogre::String InventoryWindow::SLOTNAME = &quot;slotname&quot;;
 
     InventoryWindow::InventoryWindow(const Ogre::String&amp; inventoryWindow, Inventory* inventory)
@@ -120,7 +121,7 @@
             if (item != NULL)
             {
                 LOG_MESSAGE(Logger::UI, slotName + &quot; - &quot; + item-&gt;getDescription());
-				Window* itemWindow = createItemDragContainer(item, slotName);
+				Window* itemWindow = createItemDragContainer(item, false, slotName);
 				if (itemWindow != NULL)
 				{
 					slotWindow-&gt;addChildWindow(itemWindow);
@@ -139,32 +140,34 @@
 			boost::bind(&amp;InventoryWindow::handleKeys, this, _1, false));
     }
 
-	ItemDragContainer* InventoryWindow::createItemDragContainer(Item* item, const CeGuiString&amp; slotName)
+	ItemDragContainer* InventoryWindow::createItemDragContainer(
+		Item* item, bool showdescription, const CeGuiString&amp; slotName)
 	{
-        CeGuiString icon = item-&gt;getImageName();
-
-		if (icon == &quot;&quot;)
-		{
-			icon = ICON_UNKNOWN_ITEM;
-		}
-
-		CeGuiString itemWindowName = mWindow-&gt;getName() + &quot;/&quot; + slotName + &quot;/&quot; + icon + item-&gt;getId();
-		CeGuiString dragContainerName = itemWindowName+&quot;_DragContainer&quot;;
+		CeGuiString dragContainerName = 
+			mWindow-&gt;getName() +  &quot;/item/&quot; 
+			+ Ogre::StringConverter::toString(item-&gt;getId())+&quot;_DragContainer&quot;;
 		ItemDragContainer* itemhandler = NULL;
 
 		DndContainerMap::iterator it = mDragContainers.find(dragContainerName);
 		if (it != mDragContainers.end())
 		{
-			itemhandler = it-&gt;second;
+			//itemhandler = it-&gt;second;
 			return NULL; ///@todo just a test
 		}
 		else
 		{
-	        Window* itemWindow = CEGUI::WindowManager::getSingletonPtr()-&gt;createWindow(
-				&quot;RastullahLook/StaticImage&quot;, 
-				itemWindowName);
-			itemWindow-&gt;setProperty(&quot;Image&quot;, icon);
+			if (showdescription)
+				itemhandler = new ItemDescriptionDragContainer(item, dragContainerName);
+			else
+				itemhandler = new ItemIconDragContainer(item, dragContainerName);
 
+			if (slotName != &quot;&quot;)
+			{
+				itemhandler-&gt;setItemParent(mInventory, slotName);
+			}
+
+			Window* itemWindow = itemhandler-&gt;getContentWindow();
+
 			itemWindow-&gt;subscribeEvent(
 				Window::EventMouseClick,
 				boost::bind(&amp;InventoryWindow::handleItemMouseClick, this, _1, item));
@@ -172,22 +175,9 @@
 			itemWindow-&gt;subscribeEvent(
 				Window::EventMouseDoubleClick,
 				boost::bind(&amp;InventoryWindow::handleItemDoubleClick, this, _1, item));
-			
-			itemhandler = new ItemDragContainer(item, dragContainerName);
-			if (slotName != &quot;&quot;)
-			{
-				itemhandler-&gt;setItemParent(mInventory, slotName);
-			}
 
 			itemhandler-&gt;setPosition(UVector2(cegui_reldim(0), cegui_reldim(0)));
-			itemhandler-&gt;setSize(
-				UVector2(cegui_absdim(item-&gt;getSize().first*30),
-						 cegui_absdim(item-&gt;getSize().second*30))); 
-			itemhandler-&gt;setTooltipText(item-&gt;getName());
-			itemhandler-&gt;setContentWindow(itemWindow);
 
-			itemhandler-&gt;setTooltipText(item-&gt;getName());
-
 			mDragContainers[dragContainerName] = itemhandler;
 		}
 
@@ -322,14 +312,19 @@
 					&quot;Selected &quot; + (*it)-&gt;getDescription());
 
 				ItemDragContainer* cont = 
-					createItemDragContainer(static_cast&lt;Item*&gt;(*it));
+					createItemDragContainer(static_cast&lt;Item*&gt;(*it), true);
 				if (cont)
 				{
 					mWorldBackground-&gt;addChildWindow(cont);
 					cont-&gt;setVisible(true);
 					
-					Ogre::Vector3 pos = camera-&gt;getPointOnCeGuiScreen((*it)-&gt;getPosition());
-					cont-&gt;setPosition(UVector2(UDim(pos.x, 0), UDim(pos.y, 0)));
+					Ogre::Rectangle aabb = getCeGuiRectFromWorldAABB(camera,
+							(*it)-&gt;getActor()-&gt;_getSceneNode()-&gt;_getWorldAABB());
+					UVector2 posCont = UVector2(
+							UDim((aabb.left+aabb.right)/2.0, 0), 
+							UDim((aabb.top+aabb.bottom)/2.0, 0));
+					posCont -= cont-&gt;getSize() / UVector2(UDim(2, 2), UDim(2, 2));
+					cont-&gt;setPosition(posCont);
 
 					cont-&gt;subscribeEvent(
 						Window::EventMouseLeaves,
@@ -392,14 +387,17 @@
 					it = v.begin(); it != v.end(); ++it)
 				{
 					ItemDragContainer* cont = 
-						createItemDragContainer(static_cast&lt;Item*&gt;(*it));
+						createItemDragContainer(static_cast&lt;Item*&gt;(*it), true);
 
 					if (cont)
 					{
 						mWorldBackground-&gt;addChildWindow(cont);
 						
-						Ogre::Vector3 pos = camera-&gt;getPointOnCeGuiScreen((*it)-&gt;getPosition());
-						UVector2 posCont = UVector2(UDim(pos.x, 0), UDim(pos.y, 0));
+						Ogre::Rectangle aabb = getCeGuiRectFromWorldAABB(camera,
+							(*it)-&gt;getActor()-&gt;_getSceneNode()-&gt;_getWorldAABB());
+						UVector2 posCont = UVector2(
+							UDim((aabb.left+aabb.right)/2.0, 0), 
+							UDim((aabb.top+aabb.bottom)/2.0, 0));
 						posCont -= cont-&gt;getSize() / UVector2(UDim(2, 2), UDim(2, 2));
 						cont-&gt;setPosition(posCont);
 
@@ -432,4 +430,28 @@
 
 		return true;
 	}
+
+	Ogre::Rectangle InventoryWindow::getCeGuiRectFromWorldAABB(
+		CameraObject* camera,
+        const AxisAlignedBox&amp; aabb) const
+    {
+        // Initialise each to the value of the opposite side, so that min/max work smoothly.
+        Real left = 1.0f, bottom = 1.0f, right = -1.0f, top = -1.0f;
+
+        // Determine screen pos of all corners and widen the rect if needed
+		const Ogre::Vector3* corners = aabb.getAllCorners();
+        for (size_t i = 0; i &lt; 8; ++i)
+        {
+			Ogre::Vector3 screenSpacePos = camera-&gt;getPointOnCeGuiScreen(corners[i]);
+            if (screenSpacePos.z &gt; 0) continue; // Behind camera
+
+            left   = std::min(left,   screenSpacePos.x);
+            right  = std::max(right,  screenSpacePos.x);
+            bottom = std::min(bottom, screenSpacePos.y);
+            top    = std::max(top,    screenSpacePos.y);
+        }
+
+        Ogre::Rectangle rval = {left,top, right, bottom};
+        return rval;
+    }
 }

Added: rl/trunk/engine/ui/src/ItemDescriptionDragContainer.cpp
===================================================================
--- rl/trunk/engine/ui/src/ItemDescriptionDragContainer.cpp	2007-07-03 19:57:10 UTC (rev 3584)
+++ rl/trunk/engine/ui/src/ItemDescriptionDragContainer.cpp	2007-07-03 22:21:46 UTC (rev 3585)
@@ -0,0 +1,48 @@
+/* This source file is part of Rastullahs Lockenpracht.
+ * Copyright (C) 2003-2007 Team Pantheon. <A HREF="http://www.team-pantheon.de">http://www.team-pantheon.de</A>
+ * 
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the Clarified Artistic License.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  Clarified Artistic License for more details.
+ *
+ *  You should have received a copy of the Clarified Artistic License
+ *  along with this program; if not you can get it here
+ *  <A HREF="http://www.jpaulmorrison.com/fbp/artistic2.htm.">http://www.jpaulmorrison.com/fbp/artistic2.htm.</A>
+ */
+#include &quot;ItemDescriptionDragContainer.h&quot;
+
+#include &quot;AbstractWindow.h&quot;
+#include &quot;Item.h&quot;
+
+namespace rl {
+	ItemDescriptionDragContainer::ItemDescriptionDragContainer(Item* item, const CeGuiString&amp; name)
+		: ItemDragContainer(item, name)
+	{
+		CeGuiString icon = item-&gt;getImageName();
+
+		if (icon == &quot;&quot;)
+		{
+			icon = ICON_UNKNOWN_ITEM;
+		}
+
+		CeGuiString prefix = name;
+		mContentWindow = AbstractWindow::loadWindow(&quot;itemdescriptiondragcontainer.xml&quot;, prefix);
+
+		mContentWindow-&gt;getChild(
+			mContentWindow-&gt;getName()+&quot;/Icon&quot;)
+			-&gt;setProperty(&quot;Image&quot;, icon);
+		mContentWindow-&gt;getChild(
+			mContentWindow-&gt;getName()+&quot;/Name&quot;)
+			-&gt;setText(item-&gt;getName());
+		mContentWindow-&gt;getChild(
+			mContentWindow-&gt;getName()+&quot;/Description&quot;)
+			-&gt;setText(item-&gt;getDescription());
+
+		setSize(mContentWindow-&gt;getSize());
+		addChildWindow(mContentWindow);
+	}
+}

Modified: rl/trunk/engine/ui/src/ItemDragContainer.cpp
===================================================================
--- rl/trunk/engine/ui/src/ItemDragContainer.cpp	2007-07-03 19:57:10 UTC (rev 3584)
+++ rl/trunk/engine/ui/src/ItemDragContainer.cpp	2007-07-03 22:21:46 UTC (rev 3585)
@@ -15,15 +15,30 @@
  */
 #include &quot;ItemDragContainer.h&quot;
 
+#include &lt;CEGUIWindowManager.h&gt;
+
+#include &quot;AbstractWindow.h&quot;
+#include &quot;Item.h&quot;
+
 namespace rl {
+	const Ogre::String ItemDragContainer::ICON_UNKNOWN_ITEM = &quot;set:ModelThumbnails image:item_unknown&quot;;
 
 	ItemDragContainer::ItemDragContainer(Item* item, const CeGuiString&amp; name)
 		: CEGUI::DragContainer(&quot;DragContainer&quot;, name),
 		mItem(item),
 		mParentContainer(NULL),
-		mParentSlot(&quot;&quot;)
+		mParentSlot(&quot;&quot;),
+		mContentWindow(NULL)
 	{
 	}
+
+	ItemDragContainer::~ItemDragContainer()
+	{
+		removeAllEvents();
+		mContentWindow-&gt;removeAllEvents();
+		removeChildWindow(mContentWindow);
+		CEGUI::WindowManager::getSingleton().destroyWindow(mContentWindow);
+	}
 		
 	void ItemDragContainer::setItemParent(Container* container)
 	{
@@ -69,15 +84,4 @@
 	{
 		return mContentWindow;
 	}
-
-	void ItemDragContainer::setContentWindow(CEGUI::Window* window)
-	{
-		if (window)
-		{
-			window-&gt;setPosition(CEGUI::UVector2(cegui_reldim(0), cegui_reldim(0)));
-			window-&gt;setSize(CEGUI::UVector2(cegui_reldim(1), cegui_reldim(1)));
-			addChildWindow(window);
-		}
-		mContentWindow = window;
-	}
 }

Added: rl/trunk/engine/ui/src/ItemIconDragContainer.cpp
===================================================================
--- rl/trunk/engine/ui/src/ItemIconDragContainer.cpp	2007-07-03 19:57:10 UTC (rev 3584)
+++ rl/trunk/engine/ui/src/ItemIconDragContainer.cpp	2007-07-03 22:21:46 UTC (rev 3585)
@@ -0,0 +1,47 @@
+/* This source file is part of Rastullahs Lockenpracht.
+ * Copyright (C) 2003-2007 Team Pantheon. <A HREF="http://www.team-pantheon.de">http://www.team-pantheon.de</A>
+ * 
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the Clarified Artistic License.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  Clarified Artistic License for more details.
+ *
+ *  You should have received a copy of the Clarified Artistic License
+ *  along with this program; if not you can get it here
+ *  <A HREF="http://www.jpaulmorrison.com/fbp/artistic2.htm.">http://www.jpaulmorrison.com/fbp/artistic2.htm.</A>
+ */
+#include &quot;ItemIconDragContainer.h&quot;
+
+#include &quot;AbstractWindow.h&quot;
+#include &quot;Item.h&quot;
+
+namespace rl {
+	ItemIconDragContainer::ItemIconDragContainer(Item* item, const CeGuiString&amp; name)
+		: ItemDragContainer(item, name)
+	{
+		CeGuiString icon = item-&gt;getImageName();
+
+		if (icon == &quot;&quot;)
+		{
+			icon = ICON_UNKNOWN_ITEM;
+		}
+
+		CeGuiString prefix = name;
+		mContentWindow = AbstractWindow::loadWindow(&quot;itemicondragcontainer.xml&quot;, prefix);
+		mContentWindow-&gt;getChild(mContentWindow-&gt;getName()+&quot;/Icon&quot;)
+			-&gt;setProperty(&quot;Image&quot;, icon);
+
+		setSize(CEGUI::UVector2(
+			cegui_absdim(item-&gt;getSize().first*30),
+			cegui_absdim(item-&gt;getSize().second*30))); 
+		mContentWindow-&gt;setSize(CEGUI::UVector2(
+			cegui_absdim(item-&gt;getSize().first*30),
+			cegui_absdim(item-&gt;getSize().second*30))); 
+		setTooltipText(item-&gt;getName());
+
+		addChildWindow(mContentWindow);
+	}
+}

Modified: rl/trunk/engine/ui/src/Makefile.am
===================================================================
--- rl/trunk/engine/ui/src/Makefile.am	2007-07-03 19:57:10 UTC (rev 3584)
+++ rl/trunk/engine/ui/src/Makefile.am	2007-07-03 22:21:46 UTC (rev 3585)
@@ -34,6 +34,8 @@
     InputManager.cpp \
     InventoryWindow.cpp \
     ItemDragContainer.cpp \
+    ItemDescriptionDragContainer.cpp \
+    ItemIconDragContainer.cpp \
     JournalWindow.cpp \
     ListboxWrappedTextItem.cpp \
     LogWindow.cpp \


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000655.html">[Dsa-hl-svn] r3584 - in rl/trunk/engine/ui: include src
</A></li>
	<LI>Next message: <A HREF="000657.html">[Dsa-hl-svn] r3586 - in modules/common: materials materials/model	materials/programs models
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#656">[ date ]</a>
              <a href="thread.html#656">[ thread ]</a>
              <a href="subject.html#656">[ subject ]</a>
              <a href="author.html#656">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/dsa-hl-svn">More information about the Dsa-hl-svn
mailing list</a><br>
</body></html>
