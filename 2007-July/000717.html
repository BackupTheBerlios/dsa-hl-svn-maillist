<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Dsa-hl-svn] r3646 - in rl/trunk/engine: common/include common/src	core core/include core/src rules rules/include rules/src script/swig
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/dsa-hl-svn/2007-July/index.html" >
   <LINK REL="made" HREF="mailto:dsa-hl-svn%40lists.berlios.de?Subject=Re%3A%20%5BDsa-hl-svn%5D%20r3646%20-%20in%20rl/trunk/engine%3A%20common/include%20common/src%0A%09core%20core/include%20core/src%20rules%20rules/include%20rules/src%20script/swig&In-Reply-To=%3C200707302055.l6UKtofD015943%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000716.html">
   <LINK REL="Next"  HREF="000718.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Dsa-hl-svn] r3646 - in rl/trunk/engine: common/include common/src	core core/include core/src rules rules/include rules/src script/swig</H1>
    <B>blakharaz at mail.berlios.de</B> 
    <A HREF="mailto:dsa-hl-svn%40lists.berlios.de?Subject=Re%3A%20%5BDsa-hl-svn%5D%20r3646%20-%20in%20rl/trunk/engine%3A%20common/include%20common/src%0A%09core%20core/include%20core/src%20rules%20rules/include%20rules/src%20script/swig&In-Reply-To=%3C200707302055.l6UKtofD015943%40sheep.berlios.de%3E"
       TITLE="[Dsa-hl-svn] r3646 - in rl/trunk/engine: common/include common/src	core core/include core/src rules rules/include rules/src script/swig">blakharaz at mail.berlios.de
       </A><BR>
    <I>Mon Jul 30 22:55:50 CEST 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="000716.html">[Dsa-hl-svn] r3645 - modules/common/scripts/jobs	modules/regressiontest/scripts rl/trunk/engine/script/include	rl/trunk/engine/script/src rl/trunk/engine/script/swig
</A></li>
        <LI>Next message: <A HREF="000718.html">[Dsa-hl-svn] r3647 - rl/trunk/engine/script/swig
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#717">[ date ]</a>
              <a href="thread.html#717">[ thread ]</a>
              <a href="subject.html#717">[ subject ]</a>
              <a href="author.html#717">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: blakharaz
Date: 2007-07-30 22:55:01 +0200 (Mon, 30 Jul 2007)
New Revision: 3646

Added:
   rl/trunk/engine/core/include/JobQueue.h
   rl/trunk/engine/core/include/TimeSource.h
   rl/trunk/engine/core/src/JobQueue.cpp
   rl/trunk/engine/core/src/TimeSource.cpp
   rl/trunk/engine/rules/include/GameTimeSource.h
   rl/trunk/engine/rules/src/GameTimeSource.cpp
Removed:
   rl/trunk/engine/rules/include/TimerEvent.h
   rl/trunk/engine/rules/include/TimerEventSource.h
   rl/trunk/engine/rules/include/TimerListener.h
   rl/trunk/engine/rules/include/TimerManager.h
   rl/trunk/engine/rules/src/TimerEvent.cpp
   rl/trunk/engine/rules/src/TimerEventSource.cpp
   rl/trunk/engine/rules/src/TimerListener.cpp
   rl/trunk/engine/rules/src/TimerManager.cpp
Modified:
   rl/trunk/engine/common/include/GameTask.h
   rl/trunk/engine/common/src/GameTask.cpp
   rl/trunk/engine/core/RlCore2005.vcproj
   rl/trunk/engine/core/include/CoreSubsystem.h
   rl/trunk/engine/core/include/GameLoop.h
   rl/trunk/engine/core/include/Job.h
   rl/trunk/engine/core/src/CoreSubsystem.cpp
   rl/trunk/engine/core/src/GameLoop.cpp
   rl/trunk/engine/core/src/Job.cpp
   rl/trunk/engine/core/src/JobScheduler.cpp
   rl/trunk/engine/rules/RlRules2005.vcproj
   rl/trunk/engine/rules/include/DsaManager.h
   rl/trunk/engine/rules/include/RulesSubsystem.h
   rl/trunk/engine/rules/src/DsaManager.cpp
   rl/trunk/engine/rules/src/RulesSubsystem.cpp
   rl/trunk/engine/script/swig/RlCore.swig
   rl/trunk/engine/script/swig/RlRules.swig
Log:
* introduced 3 different time sources (continuous realtime, interruptable realtime, game time) replacing the global game clock
* removed timer classes

Modified: rl/trunk/engine/common/include/GameTask.h
===================================================================
--- rl/trunk/engine/common/include/GameTask.h	2007-07-30 20:46:57 UTC (rev 3645)
+++ rl/trunk/engine/common/include/GameTask.h	2007-07-30 20:55:01 UTC (rev 3646)
@@ -26,30 +26,35 @@
 class _RlCommonExport GameTask
 {
     public:
-		/// Default Konstruktor, startet unpausiert
-        GameTask();
+		/// Konstruktor, startet unpausiert
+        /// @param interruptable set to &lt;code&gt;false&lt;/code&gt; if GameTask can't be paused
+        GameTask(bool interruptable = true);
+
 		/// Virtueller Basis-Destruktor
-        virtual ~GameTask( ) {};
+        virtual ~GameTask() {};
 
 		/** Wird vom Gameloop aufgerufen, wenn nicht pausiert, 
-            wird von  Unterklassen implementiert
+            wird von Unterklassen implementiert
 
 			@param elapsedTime Die vergangene Zeit
 		*/
-		virtual void run( Ogre::Real elapsedTime ) = 0;
+		virtual void run(Ogre::Real elapsedTime) = 0;
 
-		/** Returns the name of the derived class for debugging purposes.
-		 */
+		/// Returns the name of the derived class for debugging purposes.
         virtual const Ogre::String&amp; getName() const = 0;
+
+        bool isInterruptable() const;
         
 		/// Gibt zur&#252;ck ob dieser GameTask pausiert ist
         bool isPaused() const;
+
 		/// Pausiert/Unpausiert den GameTask
-        void setPaused( bool isPaused );
+        void setPaused(bool isPaused);
 
     private:
 		/// Pause
         bool mPaused;
+        bool mInterruptable;
 };
 
 }

Modified: rl/trunk/engine/common/src/GameTask.cpp
===================================================================
--- rl/trunk/engine/common/src/GameTask.cpp	2007-07-30 20:46:57 UTC (rev 3645)
+++ rl/trunk/engine/common/src/GameTask.cpp	2007-07-30 20:55:01 UTC (rev 3646)
@@ -18,11 +18,12 @@
 
 #include &quot;GameTask.h&quot;
 
-namespace rl {
+namespace rl 
+{
 
-GameTask::GameTask()
+GameTask::GameTask(bool pauseable)
+: mInterruptable(false), mPaused(false)
 {
-    mPaused = false;
 }
         
 bool GameTask::isPaused() const
@@ -32,7 +33,15 @@
 
 void GameTask::setPaused( bool isPaused )
 {
-    mPaused = isPaused;
+    if (mInterruptable)
+    {
+        mPaused = isPaused;
+    }
 }
 
+bool GameTask::isInterruptable() const
+{
+    return mInterruptable;
 }
+
+}

Modified: rl/trunk/engine/core/RlCore2005.vcproj
===================================================================
--- rl/trunk/engine/core/RlCore2005.vcproj	2007-07-30 20:46:57 UTC (rev 3645)
+++ rl/trunk/engine/core/RlCore2005.vcproj	2007-07-30 20:55:01 UTC (rev 3646)
@@ -456,6 +456,10 @@
 				&gt;
 			&lt;/File&gt;
 			&lt;File
+				RelativePath=&quot;.\include\JobQueue.h&quot;
+				&gt;
+			&lt;/File&gt;
+			&lt;File
 				RelativePath=&quot;.\include\JobScheduler.h&quot;
 				&gt;
 			&lt;/File&gt;
@@ -600,6 +604,10 @@
 				&gt;
 			&lt;/File&gt;
 			&lt;File
+				RelativePath=&quot;.\include\TimeSource.h&quot;
+				&gt;
+			&lt;/File&gt;
+			&lt;File
 				RelativePath=&quot;.\include\TrackAnimation.h&quot;
 				&gt;
 			&lt;/File&gt;
@@ -729,6 +737,10 @@
 				&gt;
 			&lt;/File&gt;
 			&lt;File
+				RelativePath=&quot;.\src\JobQueue.cpp&quot;
+				&gt;
+			&lt;/File&gt;
+			&lt;File
 				RelativePath=&quot;.\src\JobScheduler.cpp&quot;
 				&gt;
 			&lt;/File&gt;
@@ -877,6 +889,10 @@
 				&lt;/FileConfiguration&gt;
 			&lt;/File&gt;
 			&lt;File
+				RelativePath=&quot;.\src\TimeSource.cpp&quot;
+				&gt;
+			&lt;/File&gt;
+			&lt;File
 				RelativePath=&quot;.\src\TrackAnimation.cpp&quot;
 				&gt;
 			&lt;/File&gt;

Modified: rl/trunk/engine/core/include/CoreSubsystem.h
===================================================================
--- rl/trunk/engine/core/include/CoreSubsystem.h	2007-07-30 20:46:57 UTC (rev 3645)
+++ rl/trunk/engine/core/include/CoreSubsystem.h	2007-07-30 20:55:01 UTC (rev 3646)
@@ -48,6 +48,7 @@
 class DebugVisualsManager;
 class JobScheduler;
 class ZoneManager;
+class TimeSourceManager;
 
 typedef _RlCoreExport std::map&lt;Ogre::String, ContentModule*&gt; ModuleMap;
 
@@ -87,10 +88,6 @@
     void setDeveloperMode(bool developerMode);
     bool getDeveloperMode() const;
 
-    /// Returns time since game started in Milliseconds.
-    /// Uses GameLoop::getClock internally, function is here to allow access from ruby.
-    unsigned long getClock();
-
     /** Saves a timestamped png Screenshot
         @param sName The filename (extended with the timestamp)
     */
@@ -143,6 +140,7 @@
     DebugVisualsManager* mDebugVisualsManager;
     JobScheduler* mJobScheduler;
 	ZoneManager* mZoneManager;
+    TimeSourceManager* mTimeSourceManager;
 
     /** Runs the setup methods  */
     bool initializeCoreSubsystem();

Modified: rl/trunk/engine/core/include/GameLoop.h
===================================================================
--- rl/trunk/engine/core/include/GameLoop.h	2007-07-30 20:46:57 UTC (rev 3645)
+++ rl/trunk/engine/core/include/GameLoop.h	2007-07-30 20:55:01 UTC (rev 3646)
@@ -67,9 +67,6 @@
 	/// @param paused &lt;code&gt;true&lt;/code&gt; if the game should be paused, &lt;code&gt;false&lt;/code&gt; if it should be continued
 	void setPaused(bool paused);
 
-    /// Returns time since game started in Milliseconds.
-    unsigned long getClock() const;
-
     /// Main loop of RL.
     void loop();
 
@@ -131,4 +128,3 @@
 
 }
 #endif
-

Modified: rl/trunk/engine/core/include/Job.h
===================================================================
--- rl/trunk/engine/core/include/Job.h	2007-07-30 20:46:57 UTC (rev 3645)
+++ rl/trunk/engine/core/include/Job.h	2007-07-30 20:55:01 UTC (rev 3646)
@@ -19,6 +19,8 @@
 
 #include &quot;CorePrerequisites.h&quot;
 
+#include &quot;TimeSource.h&quot;
+
 namespace rl
 {
     /** A Job is an independent executional entity, that encapsules a singe specific task
@@ -44,7 +46,8 @@
          *         Job, after execution is finished. This should usually be the case, but
          *         sometimes it is sensible to pool a number of Jobs for reuse.
          */
-        Job(bool isDiscardable, bool destroyWhenDone);
+        Job(bool isDiscardable, bool destroyWhenDone, 
+            TimeSource::TimeSourceType type = TimeSource::REALTIME_CONTINUOUS);
         virtual ~Job();
 
         /**
@@ -67,9 +70,12 @@
         /// Returns true, if the Job shall be deleted, if the Job is finished. Returns false else.
         virtual bool destroyWhenDone();
 
+        TimeSource::TimeSourceType getTimeSource() const;
+
     protected:
         bool mIsDiscardable;
         bool mDestroyWhenDone;
+        TimeSource::TimeSourceType mTimeSource;
     };
 }
 

Added: rl/trunk/engine/core/include/JobQueue.h
===================================================================
--- rl/trunk/engine/core/include/JobQueue.h	2007-07-30 20:46:57 UTC (rev 3645)
+++ rl/trunk/engine/core/include/JobQueue.h	2007-07-30 20:55:01 UTC (rev 3646)
@@ -0,0 +1,39 @@
+/* This source file is part of Rastullahs Lockenpracht.
+* Copyright (C) 2003-2007 Team Pantheon. <A HREF="http://www.team-pantheon.de">http://www.team-pantheon.de</A>
+*
+*  This program is free software; you can redistribute it and/or modify
+*  it under the terms of the Clarified Artistic License.
+*
+*  This program is distributed in the hope that it will be useful,
+*  but WITHOUT ANY WARRANTY; without even the implied warranty of
+*  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+*  Clarified Artistic License for more details.
+*
+*  You should have received a copy of the Clarified Artistic License
+*  along with this program; if not you can get it here
+*  <A HREF="http://www.jpaulmorrison.com/fbp/artistic2.htm.">http://www.jpaulmorrison.com/fbp/artistic2.htm.</A>
+*/
+#ifndef __JOBQUEUE_H__
+#define __JOBQUEUE_H__
+
+#include &quot;Job.h&quot;
+
+namespace rl
+{
+
+    class JobQueue : public Job
+    {
+    public:
+        JobQueue();
+        ~JobQueue();
+
+        void addJob(Job* job);
+        virtual bool execute(Ogre::Real elapsedTime);
+
+    private:
+        std::list&lt;Job*&gt; mQueue;
+    };
+
+}
+
+#endif // __JOBQUEUE_H__

Added: rl/trunk/engine/core/include/TimeSource.h
===================================================================
--- rl/trunk/engine/core/include/TimeSource.h	2007-07-30 20:46:57 UTC (rev 3645)
+++ rl/trunk/engine/core/include/TimeSource.h	2007-07-30 20:55:01 UTC (rev 3646)
@@ -0,0 +1,98 @@
+/* This source file is part of Rastullahs Lockenpracht.
+ * Copyright (C) 2003-2007 Team Pantheon. <A HREF="http://www.team-pantheon.de">http://www.team-pantheon.de</A>
+ * 
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the Clarified Artistic License.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  Clarified Artistic License for more details.
+ *
+ *  You should have received a copy of the Clarified Artistic License
+ *  along with this program; if not you can get it here
+ *  <A HREF="http://www.jpaulmorrison.com/fbp/artistic2.htm.">http://www.jpaulmorrison.com/fbp/artistic2.htm.</A>
+ */
+
+#ifndef __TimeSource_H__
+#define __TimeSource_H__
+
+#include &quot;CorePrerequisites.h&quot;
+
+#include &lt;OgreSingleton.h&gt;
+
+#include &quot;GameTask.h&quot;
+
+namespace rl
+{
+    class _RlCoreExport TimeSource : public GameTask
+    {
+    public:
+        static enum TimeSourceType
+        {
+            REALTIME_CONTINUOUS,
+            REALTIME_INTERRUPTABLE,
+            GAMETIME
+        };
+
+        TimeSource(bool interruptable);
+        virtual ~TimeSource();
+
+        virtual TimeSourceType getType() const = 0;
+
+        virtual Time getClock() const = 0;
+        virtual void setClock(const Time&amp; time) = 0;
+        virtual void setTimeFactor(Ogre::Real factor = 1.0) = 0;
+    };
+
+    class _RlCoreExport RealTimeContinuous : public TimeSource
+    {
+    public:
+        RealTimeContinuous();
+
+        virtual TimeSourceType getType() const;
+        virtual const Ogre::String&amp; getName() const;
+
+        virtual Time getClock() const;
+        virtual void setClock(const Time&amp; time);
+        virtual void setTimeFactor(Ogre::Real factor = 1.0);
+
+        virtual void run(Ogre::Real elapsedTime);
+    private:
+        Ogre::Real mTime;
+    };
+
+    class _RlCoreExport RealTimeInterruptable : public TimeSource
+    {
+    public:
+        RealTimeInterruptable();
+        virtual ~RealTimeInterruptable();
+
+        virtual TimeSourceType getType() const;
+        virtual const Ogre::String&amp; getName() const;
+
+        virtual Time getClock() const;
+        virtual void setClock(const Time&amp; time);
+        virtual void setTimeFactor(Ogre::Real factor = 1.0);
+
+        virtual void run(Ogre::Real elapsedTime);
+    private:
+        Ogre::Real mTime;
+        Ogre::Real mTimeFactor;
+    };
+
+    class _RlCoreExport TimeSourceManager 
+        : public Ogre::Singleton&lt;TimeSourceManager&gt;
+    {
+    public:
+        TimeSourceManager();
+
+        void registerTimeSource(TimeSource* ts);
+        TimeSource* getTimeSource(const TimeSource::TimeSourceType&amp; type) const;
+
+    private:
+        std::map&lt;TimeSource::TimeSourceType, TimeSource*&gt; mTimeSources;
+    };
+}
+
+#endif // __TimeSource_H__

Modified: rl/trunk/engine/core/src/CoreSubsystem.cpp
===================================================================
--- rl/trunk/engine/core/src/CoreSubsystem.cpp	2007-07-30 20:46:57 UTC (rev 3645)
+++ rl/trunk/engine/core/src/CoreSubsystem.cpp	2007-07-30 20:55:01 UTC (rev 3646)
@@ -30,19 +30,20 @@
 #include &quot;AnimationManager.h&quot;
 #include &quot;ContentModule.h&quot;
 #include &quot;ConfigurationManager.h&quot;
+#include &quot;DebugVisualsManager.h&quot;
 #include &quot;DotSceneOctreeWorld.h&quot;
 #include &quot;Exception.h&quot;
 #include &quot;GameEventManager.h&quot;
-#include &quot;MessagePump.h&quot;
 #include &quot;GameLoop.h&quot;
-#include &quot;ZoneManager.h&quot;
+#include &quot;JobScheduler.h&quot;
 #include &quot;Logger.h&quot;
+#include &quot;MessagePump.h&quot;
 #include &quot;PhysicsManager.h&quot;
 #include &quot;RubyInterpreter.h&quot;
 #include &quot;ScriptWrapper.h&quot;
 #include &quot;SoundManager.h&quot;
-#include &quot;DebugVisualsManager.h&quot;
-#include &quot;JobScheduler.h&quot;
+#include &quot;TimeSource.h&quot;
+#include &quot;ZoneManager.h&quot;
 
 #include &lt;ctime&gt;
 
@@ -100,6 +101,7 @@
         delete mSoundManager;
         delete mOgreRoot;
         delete mRubyInterpreter;
+        delete mTimeSourceManager;
     }
 
     void CoreSubsystem::startCore()
@@ -234,6 +236,11 @@
         mGameLoop = new GameLoop();
         LOG_MESSAGE(Logger::CORE,&quot;GameLoopmanager erzeugt&quot;);
 
+        mTimeSourceManager = new TimeSourceManager();
+        mTimeSourceManager-&gt;registerTimeSource(new RealTimeContinuous());
+        mTimeSourceManager-&gt;registerTimeSource(new RealTimeInterruptable());
+        LOG_MESSAGE(Logger::CORE,&quot;Time sources (realtime) created&quot;);
+
         mScriptWrapper = new ScriptWrapper();
         LOG_MESSAGE(Logger::CORE,&quot;Skriptwrapper erzeugt&quot;);
         // TODO: muss l&#246;schbar werden.
@@ -496,11 +503,6 @@
         return mWorld;
     }
 
-    unsigned long CoreSubsystem::getClock()
-    {
-        return mGameLoop-&gt;getClock();
-    }
-
     Ogre::String CoreSubsystem::getEngineVersionString() const
     {
         static Ogre::String version = &quot;0.3.0&quot;;

Modified: rl/trunk/engine/core/src/GameLoop.cpp
===================================================================
--- rl/trunk/engine/core/src/GameLoop.cpp	2007-07-30 20:46:57 UTC (rev 3645)
+++ rl/trunk/engine/core/src/GameLoop.cpp	2007-07-30 20:55:01 UTC (rev 3646)
@@ -204,9 +204,4 @@
             return std::accumulate(mLastTimes.begin(), mLastTimes.end(), 0)
                 / std::max(mLastTimes.size(), (size_t)1);
     }
-
-    unsigned long GameLoop::getClock() const
-    {
-        return mGameTime;
-    }
 }

Modified: rl/trunk/engine/core/src/Job.cpp
===================================================================
--- rl/trunk/engine/core/src/Job.cpp	2007-07-30 20:46:57 UTC (rev 3645)
+++ rl/trunk/engine/core/src/Job.cpp	2007-07-30 20:55:01 UTC (rev 3646)
@@ -20,10 +20,11 @@
 
 namespace rl
 {
-    Job::Job(bool isDiscardable, bool destroyWhenDone)
-        : mIsDiscardable(isDiscardable), mDestroyWhenDone(destroyWhenDone)
+    Job::Job(bool isDiscardable, bool destroyWhenDone, TimeSource::TimeSourceType timesource)
+        : mIsDiscardable(isDiscardable), 
+        mDestroyWhenDone(destroyWhenDone),
+        mTimeSource(timesource)
     {
-
     }
 
     Job::~Job()
@@ -44,4 +45,9 @@
     {
         RlFail(&quot;Discarded non discardable Job.&quot;);
     }
+
+    TimeSource::TimeSourceType Job::getTimeSource() const
+    {
+        return mTimeSource;
+    }
 }

Added: rl/trunk/engine/core/src/JobQueue.cpp
===================================================================
--- rl/trunk/engine/core/src/JobQueue.cpp	2007-07-30 20:46:57 UTC (rev 3645)
+++ rl/trunk/engine/core/src/JobQueue.cpp	2007-07-30 20:55:01 UTC (rev 3646)
@@ -0,0 +1,37 @@
+/* This source file is part of Rastullahs Lockenpracht.
+* Copyright (C) 2003-2007 Team Pantheon. <A HREF="http://www.team-pantheon.de">http://www.team-pantheon.de</A>
+*
+*  This program is free software; you can redistribute it and/or modify
+*  it under the terms of the Clarified Artistic License.
+*
+*  This program is distributed in the hope that it will be useful,
+*  but WITHOUT ANY WARRANTY; without even the implied warranty of
+*  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+*  Clarified Artistic License for more details.
+*
+*  You should have received a copy of the Clarified Artistic License
+*  along with this program; if not you can get it here
+*  <A HREF="http://www.jpaulmorrison.com/fbp/artistic2.htm.">http://www.jpaulmorrison.com/fbp/artistic2.htm.</A>
+*/
+#include &quot;stdinc.h&quot;
+
+#include &quot;JobQueue.h&quot;
+
+namespace rl
+{
+
+JobQueue::JobQueue()
+: Job(true, true)
+{
+}
+
+JobQueue::~JobQueue()
+{
+}
+
+bool JobQueue::execute(Ogre::Real elapsedTime)
+{
+    return true; ///@todo
+}
+
+}

Modified: rl/trunk/engine/core/src/JobScheduler.cpp
===================================================================
--- rl/trunk/engine/core/src/JobScheduler.cpp	2007-07-30 20:46:57 UTC (rev 3645)
+++ rl/trunk/engine/core/src/JobScheduler.cpp	2007-07-30 20:55:01 UTC (rev 3646)
@@ -19,6 +19,7 @@
 #include &quot;Job.h&quot;
 #include &quot;JobListener.h&quot;
 #include &quot;GameLoop.h&quot;
+#include &quot;TimeSource.h&quot;
 
 using namespace Ogre;
 
@@ -39,7 +40,9 @@
         JobListener* listener)
     {
         unsigned long ticket = ++mTicketCounter;
-        unsigned long clock = GameLoop::getSingleton().getClock();
+        TimeSource* ts = TimeSourceManager::getSingleton().getTimeSource(
+            job-&gt;getTimeSource());
+        unsigned long clock = ts-&gt;getClock();
         unsigned long start = clock + delay*1000;
         unsigned long end = maxRuntime &gt;= Math::POS_INFINITY ?
             0xffffffff : static_cast&lt;unsigned long&gt;(start + maxRuntime*1000);
@@ -55,7 +58,6 @@
 
         ///@todo dynamically determine token threshold. Maybe make it work load depending.
 
-        unsigned long clock = GameLoop::getSingleton().getClock();
 
         // Queue for finished jobs
         JobQueue notDone;
@@ -64,6 +66,10 @@
         {
             JobEntry entry = *it;
 
+            TimeSource* ts = TimeSourceManager::getSingleton().getTimeSource(
+                entry.job-&gt;getTimeSource());
+            Time clock = ts-&gt;getClock();
+
             if (entry.start &lt;= clock &amp;&amp; clock &lt; entry.end)
             {
                 // Is the token threshold reached?

Added: rl/trunk/engine/core/src/TimeSource.cpp
===================================================================
--- rl/trunk/engine/core/src/TimeSource.cpp	2007-07-30 20:46:57 UTC (rev 3645)
+++ rl/trunk/engine/core/src/TimeSource.cpp	2007-07-30 20:55:01 UTC (rev 3646)
@@ -0,0 +1,144 @@
+/* This source file is part of Rastullahs Lockenpracht.
+ * Copyright (C) 2003-2007 Team Pantheon. <A HREF="http://www.team-pantheon.de">http://www.team-pantheon.de</A>
+ * 
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the Clarified Artistic License.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  Clarified Artistic License for more details.
+ *
+ *  You should have received a copy of the Clarified Artistic License
+ *  along with this program; if not you can get it here
+ *  <A HREF="http://www.jpaulmorrison.com/fbp/artistic2.htm.">http://www.jpaulmorrison.com/fbp/artistic2.htm.</A>
+ */
+
+#include &quot;stdinc.h&quot; //precompiled header
+
+#include &quot;TimeSource.h&quot;
+
+#include &quot;GameLoop.h&quot;
+
+template&lt;&gt; rl::TimeSourceManager* Ogre::Singleton&lt;rl::TimeSourceManager&gt;::ms_Singleton = 0;
+
+namespace rl
+{
+
+    TimeSource::TimeSource(bool interruptable)
+        : GameTask(interruptable)
+    {
+        GameLoop::getSingleton().addTask(this, GameLoop::TG_LOGIC);
+    }
+
+    TimeSource::~TimeSource()
+    {
+        GameLoop::getSingleton().removeTask(this);
+    }
+
+    RealTimeContinuous::RealTimeContinuous()
+        : TimeSource(false),
+        mTime(0.0)
+    {
+    }
+
+    TimeSource::TimeSourceType RealTimeContinuous::getType() const
+    {
+        return TimeSource::REALTIME_CONTINUOUS;
+    }
+
+    Time RealTimeContinuous::getClock() const
+    {
+        return mTime;
+    }
+
+    void RealTimeContinuous::setClock(const Time&amp; time)
+    {
+        mTime = time;
+    }
+
+    void RealTimeContinuous::setTimeFactor(Ogre::Real factor)
+    {
+        // can't be accelerated or slowed down
+    }
+
+    void RealTimeContinuous::run(Ogre::Real elapsedTime)
+    {
+        mTime += elapsedTime * 1000;
+    }
+
+    const Ogre::String&amp; RealTimeContinuous::getName() const
+    {
+        static Ogre::String NAME = &quot;Continuous real time clock&quot;;
+        return NAME;
+    }
+
+    RealTimeInterruptable::RealTimeInterruptable()
+        : TimeSource(true),
+        mTimeFactor(1.0),
+        mTime(0.0)
+    {
+    }
+
+    RealTimeInterruptable::~RealTimeInterruptable()
+    {
+    }
+
+    TimeSource::TimeSourceType RealTimeInterruptable::getType() const
+    {
+        return TimeSource::REALTIME_INTERRUPTABLE;
+    }
+
+    Time RealTimeInterruptable::getClock() const
+    {
+        return mTime;
+    }
+
+    void RealTimeInterruptable::setClock(const Time&amp; time)
+    {
+        mTime = time;
+    }
+
+    void RealTimeInterruptable::setTimeFactor(Ogre::Real factor)
+    {
+        mTimeFactor = factor;
+    }
+
+    void RealTimeInterruptable::run(Ogre::Real elapsedTime)
+    {
+        if (!isPaused())
+        {
+            mTime += mTimeFactor * elapsedTime * 1000;
+        }
+    }
+
+    const Ogre::String&amp; RealTimeInterruptable::getName() const
+    {
+        static Ogre::String NAME = &quot;Pausable real time clock&quot;;
+        return NAME;
+    }
+
+    TimeSourceManager::TimeSourceManager()
+    {
+    }
+
+    void TimeSourceManager::registerTimeSource(TimeSource* ts)
+    {
+        mTimeSources[ts-&gt;getType()] = ts;
+    }
+
+    TimeSource* TimeSourceManager::getTimeSource(
+        const TimeSource::TimeSourceType&amp; type) const
+    {
+        std::map&lt;TimeSource::TimeSourceType, TimeSource*&gt;::const_iterator it
+            = mTimeSources.find(type);
+
+        if (it == mTimeSources.end())
+        {
+            return NULL;
+        }
+
+        return it-&gt;second;
+    }
+
+}

Modified: rl/trunk/engine/rules/RlRules2005.vcproj
===================================================================
--- rl/trunk/engine/rules/RlRules2005.vcproj	2007-07-30 20:46:57 UTC (rev 3645)
+++ rl/trunk/engine/rules/RlRules2005.vcproj	2007-07-30 20:55:01 UTC (rev 3646)
@@ -351,6 +351,10 @@
 				&gt;
 			&lt;/File&gt;
 			&lt;File
+				RelativePath=&quot;.\src\GameTimeSource.cpp&quot;
+				&gt;
+			&lt;/File&gt;
+			&lt;File
 				RelativePath=&quot;.\src\Inventory.cpp&quot;
 				&gt;
 			&lt;/File&gt;
@@ -455,22 +459,6 @@
 				&gt;
 			&lt;/File&gt;
 			&lt;File
-				RelativePath=&quot;.\src\TimerEvent.cpp&quot;
-				&gt;
-			&lt;/File&gt;
-			&lt;File
-				RelativePath=&quot;.\src\TimerEventSource.cpp&quot;
-				&gt;
-			&lt;/File&gt;
-			&lt;File
-				RelativePath=&quot;.\src\TimerListener.cpp&quot;
-				&gt;
-			&lt;/File&gt;
-			&lt;File
-				RelativePath=&quot;.\src\TimerManager.cpp&quot;
-				&gt;
-			&lt;/File&gt;
-			&lt;File
 				RelativePath=&quot;.\src\ZauberStateSet.cpp&quot;
 				&gt;
 			&lt;/File&gt;
@@ -577,6 +565,10 @@
 				&gt;
 			&lt;/File&gt;
 			&lt;File
+				RelativePath=&quot;.\include\GameTimeSource.h&quot;
+				&gt;
+			&lt;/File&gt;
+			&lt;File
 				RelativePath=&quot;.\include\Inventory.h&quot;
 				&gt;
 			&lt;/File&gt;
@@ -669,22 +661,6 @@
 				&gt;
 			&lt;/File&gt;
 			&lt;File
-				RelativePath=&quot;.\include\TimerEvent.h&quot;
-				&gt;
-			&lt;/File&gt;
-			&lt;File
-				RelativePath=&quot;.\include\TimerEventSource.h&quot;
-				&gt;
-			&lt;/File&gt;
-			&lt;File
-				RelativePath=&quot;.\include\TimerListener.h&quot;
-				&gt;
-			&lt;/File&gt;
-			&lt;File
-				RelativePath=&quot;.\include\TimerManager.h&quot;
-				&gt;
-			&lt;/File&gt;
-			&lt;File
 				RelativePath=&quot;.\include\ZauberStateSet.h&quot;
 				&gt;
 			&lt;/File&gt;

Modified: rl/trunk/engine/rules/include/DsaManager.h
===================================================================
--- rl/trunk/engine/rules/include/DsaManager.h	2007-07-30 20:46:57 UTC (rev 3645)
+++ rl/trunk/engine/rules/include/DsaManager.h	2007-07-30 20:55:01 UTC (rev 3646)
@@ -64,9 +64,6 @@
 		void setTimestamp(const RL_LONGLONG time);
 		void setCurrentDate(const Date&amp; date);
 
-        Ogre::Real getTimeScale() const;
-        void setTimeScale(Ogre::Real scale);
-
         /** liefert eine Zufallszahl zwischen 1 und 20.*/
         int rollD20() const;
 

Added: rl/trunk/engine/rules/include/GameTimeSource.h
===================================================================
--- rl/trunk/engine/rules/include/GameTimeSource.h	2007-07-30 20:46:57 UTC (rev 3645)
+++ rl/trunk/engine/rules/include/GameTimeSource.h	2007-07-30 20:55:01 UTC (rev 3646)
@@ -0,0 +1,42 @@
+/* This source file is part of Rastullahs Lockenpracht.
+ * Copyright (C) 2003-2007 Team Pantheon. <A HREF="http://www.team-pantheon.de">http://www.team-pantheon.de</A>
+ * 
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the Clarified Artistic License.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  Clarified Artistic License for more details.
+ *
+ *  You should have received a copy of the Clarified Artistic License
+ *  along with this program; if not you can get it here
+ *  <A HREF="http://www.jpaulmorrison.com/fbp/artistic2.htm.">http://www.jpaulmorrison.com/fbp/artistic2.htm.</A>
+ */
+
+#ifndef __GameTimeSource_H__
+#define __GameTimeSource_H__
+
+#include &quot;TimeSource.h&quot;
+
+#include &quot;Date.h&quot;
+
+namespace rl
+{
+
+    class GameTimeSource : public RealTimeInterruptable
+    {
+    public:
+        GameTimeSource();
+        ~GameTimeSource();
+
+        Date getDate() const;
+        void setDate(const Date&amp; date);
+
+        virtual TimeSourceType getType() const;
+        virtual const Ogre::String&amp; getName() const;
+    };
+
+}
+
+#endif // __GameTimeSource_H__

Modified: rl/trunk/engine/rules/include/RulesSubsystem.h
===================================================================
--- rl/trunk/engine/rules/include/RulesSubsystem.h	2007-07-30 20:46:57 UTC (rev 3645)
+++ rl/trunk/engine/rules/include/RulesSubsystem.h	2007-07-30 20:55:01 UTC (rev 3646)
@@ -28,7 +28,6 @@
     class CombatManager;
     class DsaManager;
     class CreatureControllerManager;
-    class TimerManager;
     class XdimlLoader;
 
 	class _RlRulesExport RulesSubsystem : public Ogre::Singleton&lt;RulesSubsystem&gt;
@@ -46,7 +45,6 @@
         CombatManager* mCombatManager;
         DsaManager* mDsaManager;
         CreatureControllerManager *mMovingCreatureManager;
-        TimerManager* mTimerManager;
         XdimlLoader* mXdimlLoader;
     };
 }

Deleted: rl/trunk/engine/rules/include/TimerEvent.h
===================================================================
--- rl/trunk/engine/rules/include/TimerEvent.h	2007-07-30 20:46:57 UTC (rev 3645)
+++ rl/trunk/engine/rules/include/TimerEvent.h	2007-07-30 20:55:01 UTC (rev 3646)
@@ -1,65 +0,0 @@
-/* This source file is part of Rastullahs Lockenpracht.
- * Copyright (C) 2003-2007 Team Pantheon. <A HREF="http://www.team-pantheon.de">http://www.team-pantheon.de</A>
- * 
- *  This program is free software; you can redistribute it and/or modify
- *  it under the terms of the Clarified Artistic License.
- *
- *  This program is distributed in the hope that it will be useful,
- *  but WITHOUT ANY WARRANTY; without even the implied warranty of
- *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
- *  Clarified Artistic License for more details.
- *
- *  You should have received a copy of the Clarified Artistic License
- *  along with this program; if not you can get it here
- *  <A HREF="http://www.jpaulmorrison.com/fbp/artistic2.htm.">http://www.jpaulmorrison.com/fbp/artistic2.htm.</A>
- */
-
-#ifndef __TimerEvent_H__
-#define __TimerEvent_H__
-
-#include &quot;RulesPrerequisites.h&quot;
-
-#include &quot;EventObject.h&quot;
-
-#include &quot;Date.h&quot;
-
-namespace rl {
-
-class TimerEventSource;
-class GameObject;
-
-/** 
- *  TimerEvent
- *  Ein Event der ausgel&#246;st wird, wenn sich eine Eigenschaft eines GameObjects ver&#228;ndert hat 
- *
- *  @see ObjectStateChangeListener, TimerEventSource
- *  @todo Feldgenauigkeit, also auch noch im Ereignis zu kodieren, was ver&#228;ndert wurde
- */
-class _RlRulesExport TimerEvent : public virtual EventObject 
-{
-public:
-	/** Der Standardkonstruktor
-	* @param src Die Eventquelle
-	*/
-	TimerEvent( TimerEventSource* src );
-	/// Standarddestruktor
-	virtual ~TimerEvent() {};
-
-	/// Setzt den Zeitpunkt des Events
-	void setTime(Ogre::Real time) { mTime = time; }
-	void setTime(Date gameTime) { mGameTime = gameTime; }
-
-	/// Gibt den Zeitpunkt des Events zur&#252;ck
-	Ogre::Real getTime() { return mTime; }
-	Date getGameTime() { return mGameTime; }
-
-	/// Gibt die Eventquelle zur&#252;ck
-	TimerEventSource* getSource() const;
-private:
-	/// Das verursachende Object
-	Ogre::Real mTime;
-	Date mGameTime;
-};
-}
-
-#endif

Deleted: rl/trunk/engine/rules/include/TimerEventSource.h
===================================================================
--- rl/trunk/engine/rules/include/TimerEventSource.h	2007-07-30 20:46:57 UTC (rev 3645)
+++ rl/trunk/engine/rules/include/TimerEventSource.h	2007-07-30 20:55:01 UTC (rev 3646)
@@ -1,97 +0,0 @@
-/* This source file is part of Rastullahs Lockenpracht.
- * Copyright (C) 2003-2007 Team Pantheon. <A HREF="http://www.team-pantheon.de">http://www.team-pantheon.de</A>
- * 
- *  This program is free software; you can redistribute it and/or modify
- *  it under the terms of the Clarified Artistic License.
- *
- *  This program is distributed in the hope that it will be useful,
- *  but WITHOUT ANY WARRANTY; without even the implied warranty of
- *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
- *  Clarified Artistic License for more details.
- *
- *  You should have received a copy of the Clarified Artistic License
- *  along with this program; if not you can get it here
- *  <A HREF="http://www.jpaulmorrison.com/fbp/artistic2.htm.">http://www.jpaulmorrison.com/fbp/artistic2.htm.</A>
- */
-
-#ifndef __TimerEventSource_H__
-#define __TimerEventSource_H__
-
-#include &quot;RulesPrerequisites.h&quot;
-
-#include &quot;EventSource.h&quot;
-#include &quot;EventCaster.h&quot;
-#include &quot;Date.h&quot;
-
-namespace rl {
-
-class TimerListener;
-class TimerEvent;
-
-/** 
- * TimerEventSource
- *
- *  @see TimerEvent, TimerListener
- */
-class _RlRulesExport TimerEventSource : public virtual EventSource
-{
-public:
-	static const RL_LONGLONG NO_REPEAT;
-
-    /** Konstruktor
-     */
-	TimerEventSource( const RL_LONGLONG gameTime, const RL_LONGLONG interval = NO_REPEAT );
-	TimerEventSource( const Date dsaTime, const Date interval = NO_REPEAT );
-
-	/// Dekonstruktor
-    virtual ~TimerEventSource();
-
-    /** F&#252;gt einen TimerListener hinzu, der zuk&#252;nftig bei TimerEvents benachrichtigt wird 
-     *
-     * @param list Der hinzuzuf&#252;gende Listener
-     */
-    void addTimerListener( TimerListener*  list );
-    /** Entfernt einen TimerListener
-    *
-    * @param list Der zu entfernende Listener
-    */
-    void removeTimerListener( TimerListener* list );
-
-	/**
-	 * Regt eine Timer&#252;berpr&#252;fung an
-	 *
-	 * @param gameTime die abgelaufene Spielzeit
-	 * @param dsaTime die aktuelle DSA-Zeit
-	 * @return true, falls das Ereignis nie wieder auftreten kann und somit gel&#246;scht werden soll
-	 */
-	bool injectTimePulse(RL_LONGLONG gameTime, Date dsaTime);
-
-    /// Gibt zur&#252;ck ob sich Listener angemeldet haben
-    bool hasListeners( ) const;
-
-    void fireTimerEvent();
-
-private: 
-
-	enum TimerType {
-		TIMER_GAME_TIME,
-		TIMER_DSA_TIME
-	};
-
-    /// Der EventCaster der die Verteilung an die Listener &#252;bernimmt
-    EventCaster&lt;TimerEvent&gt; mTimerEventCaster;
-    /// Das Object der &#252;berwacht wird
-	RL_LONGLONG mGameTime;
-	RL_LONGLONG mGameTimeLastCall;
-	RL_LONGLONG mGameTimeRepeatInterval;
-
-	Date mDsaTime;
-    Date mDsaTimeLastCall;
-	Date mDsaTimeRepeatInterval;
-
-	TimerType mType;
-};
-
-}
-
-#endif

Deleted: rl/trunk/engine/rules/include/TimerListener.h
===================================================================
--- rl/trunk/engine/rules/include/TimerListener.h	2007-07-30 20:46:57 UTC (rev 3645)
+++ rl/trunk/engine/rules/include/TimerListener.h	2007-07-30 20:55:01 UTC (rev 3646)
@@ -1,48 +0,0 @@
-/* This source file is part of Rastullahs Lockenpracht.
- * Copyright (C) 2003-2007 Team Pantheon. <A HREF="http://www.team-pantheon.de">http://www.team-pantheon.de</A>
- * 
- *  This program is free software; you can redistribute it and/or modify
- *  it under the terms of the Clarified Artistic License.
- *
- *  This program is distributed in the hope that it will be useful,
- *  but WITHOUT ANY WARRANTY; without even the implied warranty of
- *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
- *  Clarified Artistic License for more details.
- *
- *  You should have received a copy of the Clarified Artistic License
- *  along with this program; if not you can get it here
- *  <A HREF="http://www.jpaulmorrison.com/fbp/artistic2.htm.">http://www.jpaulmorrison.com/fbp/artistic2.htm.</A>
- */
-
-#ifndef __TimerListener_H__
-#define __TimerListener_H__
-
-#include &quot;EventListener.h&quot;
-#include &quot;TimerEvent.h&quot;
-
-#include &quot;RulesPrerequisites.h&quot;
-
-namespace rl {
-
-/** TimerListener
- *  Eine Basisklasse f&#252;r Listener die auf TimerEvents lauschen
- *
- *  @see TimerEvent, TimerEventSource, GameObject
- */
-class _RlRulesExport TimerListener : public virtual EventListener&lt;TimerEvent&gt;
-{
-public:
-    /// Dekonstruktor
-    virtual ~TimerListener();
-
-     /// K&#252;mmert sich um das Aufrufen benannter Methoden aus Reasons
-	bool eventRaised(TimerEvent *anEvent);
-
-    /** Diese Methode wird aufgerufen, wenn der Timer ausgel&#246;st wurde
-      * @param anEvent Der ausl&#246;sende Event
-      */  
-	virtual void timerFired(TimerEvent* anEvent) = 0;
-};
-}
-
-#endif

Deleted: rl/trunk/engine/rules/include/TimerManager.h
===================================================================
--- rl/trunk/engine/rules/include/TimerManager.h	2007-07-30 20:46:57 UTC (rev 3645)
+++ rl/trunk/engine/rules/include/TimerManager.h	2007-07-30 20:55:01 UTC (rev 3646)
@@ -1,55 +0,0 @@
-/* This source file is part of Rastullahs Lockenpracht.
- * Copyright (C) 2003-2007 Team Pantheon. <A HREF="http://www.team-pantheon.de">http://www.team-pantheon.de</A>
- * 
- *  This program is free software; you can redistribute it and/or modify
- *  it under the terms of the Clarified Artistic License.
- *
- *  This program is distributed in the hope that it will be useful,
- *  but WITHOUT ANY WARRANTY; without even the implied warranty of
- *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
- *  Clarified Artistic License for more details.
- *
- *  You should have received a copy of the Clarified Artistic License
- *  along with this program; if not you can get it here
- *  <A HREF="http://www.jpaulmorrison.com/fbp/artistic2.htm.">http://www.jpaulmorrison.com/fbp/artistic2.htm.</A>
- */
-
-#ifndef __TimerManager_H__
-#define __TimerManager_H__
-
-#include &quot;RulesPrerequisites.h&quot;
-#include &quot;GameTask.h&quot;
-
-#include &lt;OgreSingleton.h&gt;
-
-namespace rl {
-
-class TimerEventSource;
-
-/** 
- *  TimerEvent
- *  Ein Event der ausgel&#246;st wird, wenn ein Zeitpunkt erreicht wurde
- *
- *  @see TimerListener, TimerEventSource
- */
-class _RlRulesExport TimerManager : public GameTask, public Ogre::Singleton&lt;TimerManager&gt;
-{
-public:
-	TimerManager();
-	virtual ~TimerManager();
-
-	void registerTimerEventSource(TimerEventSource* source);
-	void unregisterTimerEventSource(TimerEventSource* source);
-
-    virtual const Ogre::String&amp; getName() const;
-
-protected:
-	virtual void run( Ogre::Real elapsedTime );
-
-private:
-	std::set&lt;TimerEventSource*&gt; mTimers;
-};
-
-}
-
-#endif //__TimerManager_H__

Modified: rl/trunk/engine/rules/src/DsaManager.cpp
===================================================================
--- rl/trunk/engine/rules/src/DsaManager.cpp	2007-07-30 20:46:57 UTC (rev 3645)
+++ rl/trunk/engine/rules/src/DsaManager.cpp	2007-07-30 20:55:01 UTC (rev 3646)
@@ -26,7 +26,7 @@
 #include &quot;DsaDataLoader.h&quot;
 
 #include &quot;Exception.h&quot;
-#include &quot;GameLoop.h&quot;
+#include &quot;GameTimeSource.h&quot;
 
 #include &lt;cstdlib&gt;
 
@@ -130,43 +130,50 @@
 		return false;
 	}
 
-    RL_LONGLONG DsaManager::getTimestamp() const
-    {
-        unsigned long currentClock = GameLoop::getSingleton().getClock();
-        mLastGameTime += (RL_LONGLONG) (mTimeScale * (currentClock - mLastClock));
-        mLastClock = currentClock;
-		return mLastGameTime;
-    }
+    Time DsaManager::getTimestamp() const
+	{
+        TimeSource* ts = TimeSourceManager::getSingleton().getTimeSource(
+                TimeSource::GAMETIME);
 
+        if (ts)
+        {
+            return ts-&gt;getClock();
+        }
+        else
+        {
+            return 0; ///@todo better throw exception?
+        }
+	}
+
 	Date DsaManager::getCurrentDate() const
 	{
-		return Date(getTimestamp());
-	}
+        GameTimeSource* ts = dynamic_cast&lt;GameTimeSource*&gt;(
+            TimeSourceManager::getSingleton().getTimeSource(
+                TimeSource::GAMETIME));
 
-	void DsaManager::setTimestamp(const RL_LONGLONG time)
-	{
-		mLastGameTime = time;
-        mLastClock = GameLoop::getSingleton().getClock();
+        if (ts)
+        {
+            return ts-&gt;getDate();
+        }
+        else
+        {
+            return Date(0); ///@todo better throw exception?
+        }
 	}
 
 	void DsaManager::setCurrentDate(const Date&amp; date)
 	{
-		setTimestamp(date.getTimestamp());
+        GameTimeSource* ts = dynamic_cast&lt;GameTimeSource*&gt;(
+            TimeSourceManager::getSingleton().getTimeSource(
+                TimeSource::GAMETIME));
+
+        if (ts)
+        {
+            ts-&gt;setDate(date);
+        }
+        //else ///@todo better throw exception?
 	}
 
-    Real DsaManager::getTimeScale() const
-    {
-        return mTimeScale;
-    }
-
-    void DsaManager::setTimeScale(Real scale)
-    {
-        // First refresh time with old scale.
-        getTimestamp();
-        // Then set new scale.
-        mTimeScale = scale;
-    }
-
     int DsaManager::rollD20() const
     {
         double d = std::rand();

Added: rl/trunk/engine/rules/src/GameTimeSource.cpp
===================================================================
--- rl/trunk/engine/rules/src/GameTimeSource.cpp	2007-07-30 20:46:57 UTC (rev 3645)
+++ rl/trunk/engine/rules/src/GameTimeSource.cpp	2007-07-30 20:55:01 UTC (rev 3646)
@@ -0,0 +1,53 @@
+/* This source file is part of Rastullahs Lockenpracht.
+ * Copyright (C) 2003-2007 Team Pantheon. <A HREF="http://www.team-pantheon.de">http://www.team-pantheon.de</A>
+ * 
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the Clarified Artistic License.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  Clarified Artistic License for more details.
+ *
+ *  You should have received a copy of the Clarified Artistic License
+ *  along with this program; if not you can get it here
+ *  <A HREF="http://www.jpaulmorrison.com/fbp/artistic2.htm.">http://www.jpaulmorrison.com/fbp/artistic2.htm.</A>
+ */
+
+#include &quot;stdinc.h&quot;
+#include &quot;GameTimeSource.h&quot;
+
+namespace rl
+{
+
+    GameTimeSource::GameTimeSource()
+        : RealTimeInterruptable()
+    {
+    }
+
+    GameTimeSource::~GameTimeSource()
+    {
+    }
+
+    void GameTimeSource::setDate(const Date&amp; date)
+    {
+        setClock(date.getTimestamp());
+    }
+
+    Date GameTimeSource::getDate() const
+    {
+        return Date(getClock());
+    }
+
+    const Ogre::String&amp; GameTimeSource::getName() const
+    {
+        static Ogre::String NAME = &quot;Game time source&quot;;
+        return NAME;
+    }
+
+    TimeSource::TimeSourceType GameTimeSource::getType() const
+    {
+        return TimeSource::GAMETIME;
+    }
+
+}

Modified: rl/trunk/engine/rules/src/RulesSubsystem.cpp
===================================================================
--- rl/trunk/engine/rules/src/RulesSubsystem.cpp	2007-07-30 20:46:57 UTC (rev 3645)
+++ rl/trunk/engine/rules/src/RulesSubsystem.cpp	2007-07-30 20:55:01 UTC (rev 3646)
@@ -24,9 +24,9 @@
 #include &quot;EffectFactory.h&quot;
 #include &quot;Logger.h&quot;
 #include &quot;CreatureControllerManager.h&quot;
-#include &quot;TimerManager.h&quot;
 #include &quot;GameObjectManager.h&quot;
 #include &quot;QuestBook.h&quot;
+#include &quot;GameTimeSource.h&quot;
 
 template &lt;&gt;
 rl::RulesSubsystem* Singleton&lt;rl::RulesSubsystem&gt;::ms_Singleton = 0;
@@ -38,13 +38,15 @@
         mCombatManager(NULL),
         mDsaManager(NULL),
         mMovingCreatureManager(NULL),
-        mTimerManager(NULL),
         mXdimlLoader(NULL)
     {
 		LOG_MESSAGE(Logger::RULES, &quot;Start&quot;);
         //Zufallsgenerator initialisieren
         srand(static_cast&lt;unsigned int&gt;(time(NULL)));
 
+        TimeSourceManager::getSingleton().registerTimeSource(
+            new GameTimeSource());
+
         //Singletons erzeugen
         mActionManager = new ActionManager();
 		LOG_MESSAGE(Logger::RULES, &quot;ActionManager erzeugt&quot;);
@@ -54,8 +56,6 @@
 		LOG_MESSAGE(Logger::RULES, &quot;DsaManager erzeugt&quot;);
         mMovingCreatureManager = new CreatureControllerManager();
 		LOG_MESSAGE(Logger::RULES, &quot;CreatureControllerManager erzeugt&quot;);
-        mTimerManager = new TimerManager();
-		LOG_MESSAGE(Logger::RULES, &quot;TimerManager erzeugt&quot;);
 		resetQuestBook();
 		LOG_MESSAGE(Logger::RULES, &quot;Questverwaltung erzeugt&quot;);
 
@@ -71,7 +71,6 @@
 	RulesSubsystem::~RulesSubsystem()
     {
         delete mQuestBook;
-        delete mTimerManager;
         delete mDsaManager;
         delete mMovingCreatureManager;
         delete mCombatManager;

Deleted: rl/trunk/engine/rules/src/TimerEvent.cpp
===================================================================
--- rl/trunk/engine/rules/src/TimerEvent.cpp	2007-07-30 20:46:57 UTC (rev 3645)
+++ rl/trunk/engine/rules/src/TimerEvent.cpp	2007-07-30 20:55:01 UTC (rev 3646)
@@ -1,37 +0,0 @@
-/* This source file is part of Rastullahs Lockenpracht.
- * Copyright (C) 2003-2007 Team Pantheon. <A HREF="http://www.team-pantheon.de">http://www.team-pantheon.de</A>
- *
- *  This program is free software; you can redistribute it and/or modify
- *  it under the terms of the Clarified Artistic License.
- *
- *  This program is distributed in the hope that it will be useful,
- *  but WITHOUT ANY WARRANTY; without even the implied warranty of
- *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
- *  Clarified Artistic License for more details.
- *
- *  You should have received a copy of the Clarified Artistic License
- *  along with this program; if not you can get it here
- *  <A HREF="http://www.jpaulmorrison.com/fbp/artistic2.htm.">http://www.jpaulmorrison.com/fbp/artistic2.htm.</A>
- */
-#include &quot;stdinc.h&quot; //precompiled header
-
-#include &quot;TimerEvent.h&quot;
-
-#include &quot;TimerEventSource.h&quot;
-
-namespace rl {
-
-TimerEvent::TimerEvent( TimerEventSource* src )
-    : EventObject(src,0)
-{
-
-}
-
-TimerEventSource* TimerEvent::getSource() const
-{
-	EventSource* eve =  EventObject::getSource();
-    return dynamic_cast&lt;TimerEventSource*&gt;( eve );
-}
-
-}
-

Deleted: rl/trunk/engine/rules/src/TimerEventSource.cpp
===================================================================
--- rl/trunk/engine/rules/src/TimerEventSource.cpp	2007-07-30 20:46:57 UTC (rev 3645)
+++ rl/trunk/engine/rules/src/TimerEventSource.cpp	2007-07-30 20:55:01 UTC (rev 3646)
@@ -1,148 +0,0 @@
-/* This source file is part of Rastullahs Lockenpracht.
- * Copyright (C) 2003-2007 Team Pantheon. <A HREF="http://www.team-pantheon.de">http://www.team-pantheon.de</A>
- *
- *  This program is free software; you can redistribute it and/or modify
- *  it under the terms of the Clarified Artistic License.
- *
- *  This program is distributed in the hope that it will be useful,
- *  but WITHOUT ANY WARRANTY; without even the implied warranty of
- *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
- *  Clarified Artistic License for more details.
- *
- *  You should have received a copy of the Clarified Artistic License
- *  along with this program; if not you can get it here
- *  <A HREF="http://www.jpaulmorrison.com/fbp/artistic2.htm.">http://www.jpaulmorrison.com/fbp/artistic2.htm.</A>
- */
-#include &quot;stdinc.h&quot; //precompiled header
-
-#include &quot;TimerEventSource.h&quot;
-
-#include &quot;TimerEvent.h&quot;
-#include &quot;TimerManager.h&quot;
-#include &quot;TimerListener.h&quot;
-#include &quot;DsaManager.h&quot;
-#include &quot;GameLoop.h&quot;
-#include &quot;ScriptWrapper.h&quot;
-
-using Ogre::Real;
-
-namespace rl {
-
-	const RL_LONGLONG TimerEventSource::NO_REPEAT = 0L;
-
-	TimerEventSource::TimerEventSource( RL_LONGLONG time, RL_LONGLONG repeat ) :
-		mTimerEventCaster(),
-		mType(TIMER_GAME_TIME),
-		mGameTime(time),
-		mGameTimeRepeatInterval(repeat),
-		mGameTimeLastCall(0L),
-		mDsaTime(0L),
-		mDsaTimeLastCall(0L),
-		mDsaTimeRepeatInterval(0L)
-	{
-		TimerManager::getSingleton().registerTimerEventSource(this);
-	}
-
-	TimerEventSource::TimerEventSource( Date time, Date repeat ) :
-		mTimerEventCaster(),
-		mType(TIMER_DSA_TIME),
-		mGameTime(0L),
-		mGameTimeRepeatInterval(0L),
-		mGameTimeLastCall(0L),
-		mDsaTime(time),
-		mDsaTimeRepeatInterval(repeat),
-		mDsaTimeLastCall(0L)
-	{
-		TimerManager::getSingleton().registerTimerEventSource(this);
-	}
-
-    TimerEventSource::~TimerEventSource()
-    {
-		TimerManager::getSingleton().unregisterTimerEventSource(this);
-
-		// Alle TimerListener
-		EventCaster&lt;TimerEvent&gt;::EventSet evSet
-			= mTimerEventCaster.getEventSet();
-		EventCaster&lt;TimerEvent&gt;::EventSet::iterator citer
-			= evSet.begin();
-		for (citer; citer != evSet.end(); )
-		{
-			EventListener&lt;TimerEvent&gt;* ev = *citer;
-			TimerListener* al = dynamic_cast&lt;TimerListener*&gt;( ev );
-			ScriptWrapper::getSingleton().disowned( al );
-			citer++;
-		}
-        mTimerEventCaster.removeEventListeners();
-    }
-
-
-	void TimerEventSource::fireTimerEvent()
-	{
-		TimerEvent* evt = new TimerEvent(this);
-		if (mType == TIMER_DSA_TIME)
-		{
-			Date date = DsaManager::getSingleton().getCurrentDate();
-			evt-&gt;setTime(date);
-			mDsaTimeLastCall = date;
-		}
-		else if (mType == TIMER_GAME_TIME)
-		{
-			RL_LONGLONG time = GameLoop::getSingleton().getClock();
-			evt-&gt;setTime(time);
-			mGameTimeLastCall = time;
-		}
-
-		mTimerEventCaster.dispatchEvent(evt);
-        delete evt;
-	}
-
-    void TimerEventSource::addTimerListener( TimerListener*  list )
-    {
-		if( !mTimerEventCaster.containsListener( list ) )
-		{
-			mTimerEventCaster.addEventListener( list );
-			ScriptWrapper::getSingleton().owned(list);
-		}
-    }
-
-    void TimerEventSource::removeTimerListener( TimerListener* list )
-    {
-		if( mTimerEventCaster.containsListener( list ) )
-		{
-			mTimerEventCaster.removeEventListener( list );
-			ScriptWrapper::getSingleton().disowned(list);
-		}
-    }
-
-    bool TimerEventSource::hasListeners( ) const
-    {
-        return mTimerEventCaster.hasEventListeners();
-    }
-
-	bool TimerEventSource::injectTimePulse(RL_LONGLONG gameTime, Date dsaTime)
-	{
-		bool deleteSource = false;
-
-		if (mType == TIMER_DSA_TIME)
-		{
-			if (mDsaTime &lt; dsaTime &amp;&amp; mDsaTimeLastCall + mDsaTimeRepeatInterval &lt;= dsaTime)
-			{
-				if (mDsaTimeRepeatInterval == NO_REPEAT)
-					deleteSource = true;
-				fireTimerEvent();
-			}
-		}
-		else if (mType == TIMER_GAME_TIME)
-		{
-			if (mGameTime &lt; gameTime &amp;&amp; mGameTimeLastCall + mGameTimeRepeatInterval &lt;= gameTime)
-			{
-				if (mGameTimeRepeatInterval == NO_REPEAT)
-					deleteSource = true;
-				fireTimerEvent();
-			}
-		}
-
-		return deleteSource;
-	}
-}
-

Deleted: rl/trunk/engine/rules/src/TimerListener.cpp
===================================================================
--- rl/trunk/engine/rules/src/TimerListener.cpp	2007-07-30 20:46:57 UTC (rev 3645)
+++ rl/trunk/engine/rules/src/TimerListener.cpp	2007-07-30 20:55:01 UTC (rev 3646)
@@ -1,37 +0,0 @@
-/* This source file is part of Rastullahs Lockenpracht.
- * Copyright (C) 2003-2007 Team Pantheon. <A HREF="http://www.team-pantheon.de">http://www.team-pantheon.de</A>
- *
- *  This program is free software; you can redistribute it and/or modify
- *  it under the terms of the Clarified Artistic License.
- *
- *  This program is distributed in the hope that it will be useful,
- *  but WITHOUT ANY WARRANTY; without even the implied warranty of
- *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
- *  Clarified Artistic License for more details.
- *
- *  You should have received a copy of the Clarified Artistic License
- *  along with this program; if not you can get it here
- *  <A HREF="http://www.jpaulmorrison.com/fbp/artistic2.htm.">http://www.jpaulmorrison.com/fbp/artistic2.htm.</A>
- */
-#include &quot;stdinc.h&quot; //precompiled header
-
-#include &quot;TimerListener.h&quot;
-
-#include &quot;CoreSubsystem.h&quot;
-#include &quot;Exception.h&quot;
-
-namespace rl {
-
-    TimerListener::~TimerListener()
-    {
-	}
-
-	bool TimerListener::eventRaised(TimerEvent* evt)
-	{
-        timerFired(evt);
-
-        // consumed or not
-		return false;
-	}
-}
-

Deleted: rl/trunk/engine/rules/src/TimerManager.cpp
===================================================================
--- rl/trunk/engine/rules/src/TimerManager.cpp	2007-07-30 20:46:57 UTC (rev 3645)
+++ rl/trunk/engine/rules/src/TimerManager.cpp	2007-07-30 20:55:01 UTC (rev 3646)
@@ -1,100 +0,0 @@
-/* This source file is part of Rastullahs Lockenpracht.
- * Copyright (C) 2003-2007 Team Pantheon. <A HREF="http://www.team-pantheon.de">http://www.team-pantheon.de</A>
- *
- *  This program is free software; you can redistribute it and/or modify
- *  it under the terms of the Clarified Artistic License.
- *
- *  This program is distributed in the hope that it will be useful,
- *  but WITHOUT ANY WARRANTY; without even the implied warranty of
- *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
- *  Clarified Artistic License for more details.
- *
- *  You should have received a copy of the Clarified Artistic License
- *  along with this program; if not you can get it here
- *  <A HREF="http://www.jpaulmorrison.com/fbp/artistic2.htm.">http://www.jpaulmorrison.com/fbp/artistic2.htm.</A>
- */
-#include &quot;stdinc.h&quot; //precompiled header
-
-#include &quot;TimerManager.h&quot;
-
-#include &quot;GameLoop.h&quot;
-#include &quot;CoreSubsystem.h&quot;
-#include &quot;DsaManager.h&quot;
-#include &quot;TimerEventSource.h&quot;
-#include &quot;ScriptWrapper.h&quot;
-#include &quot;Exception.h&quot;
-
-
-using Ogre::Singleton;
-using Ogre::StringConverter;
-
-template&lt;&gt; rl::TimerManager* Singleton&lt;rl::TimerManager&gt;::ms_Singleton = 0;
-
-namespace rl {
-
-	TimerManager::TimerManager() :
-		mTimers()
-	{
-        GameLoop::getSingleton().addTask(this, GameLoop::TG_GRAPHICS);
-	}
-
-	TimerManager::~TimerManager()
-	{
-		for (std::set&lt;TimerEventSource*&gt;::iterator timerIter = mTimers.begin();
-			timerIter != mTimers.end();timerIter++)
-		{
-			TimerEventSource* currTimer = *timerIter;
-			ScriptWrapper::getSingleton().disowned( currTimer );
-		}
-		mTimers.clear();
-		GameLoop::getSingleton().removeTask(this);
-	}
-
-	void TimerManager::run(Ogre::Real elapsedTime)
-	{
-		RL_LONGLONG nowDsa = DsaManager::getSingleton().getTimestamp();
-		RL_LONGLONG now = GameLoop::getSingleton().getClock();
-
-		for (std::set&lt;TimerEventSource*&gt;::iterator timerIter = mTimers.begin();
-			timerIter != mTimers.end();)
-		{
-			TimerEventSource* currTimer = *timerIter;
-			bool toDelete = currTimer-&gt;injectTimePulse(now, nowDsa);
-
-			if (toDelete)
-			{
-				mTimers.erase( timerIter++ );
-				ScriptWrapper::getSingleton().disowned( currTimer );
-			}
-			else
-				++timerIter;
-		}
-	}
-
-	void TimerManager::registerTimerEventSource(TimerEventSource* source)
-	{
-		if (mTimers.find(source) != mTimers.end())
-		{
-            Throw(IllegalArgumentException, &quot;TimerEventSource already registered.&quot;);
-        }
-		mTimers.insert(source);
-		ScriptWrapper::getSingleton().owned( source );
-	}
-
-	void TimerManager::unregisterTimerEventSource(TimerEventSource* source)
-    {
-		if (mTimers.find(source) == mTimers.end())
-		{
-            Throw(IllegalArgumentException, &quot;TimerEventSource not registered.&quot;);
-        }
-		mTimers.erase(source);
-		ScriptWrapper::getSingleton().disowned(source);
-    }
-
-    const Ogre::String&amp; TimerManager::getName() const
-    {
-        static Ogre::String NAME = &quot;TimerManager&quot;;
-
-        return NAME;
-    }
-}

Modified: rl/trunk/engine/script/swig/RlCore.swig
===================================================================
--- rl/trunk/engine/script/swig/RlCore.swig	2007-07-30 20:46:57 UTC (rev 3645)
+++ rl/trunk/engine/script/swig/RlCore.swig	2007-07-30 20:55:01 UTC (rev 3646)
@@ -662,7 +662,6 @@
     rl::ContentModule* getModule(const Ogre::String&amp; moduleId) const;
 
     rl::World* getWorld();
-    unsigned long getClock();
     void makeScreenshot(const Ogre::String&amp; sName);
     bool isInitialized() const;
     void setScheme(const Ogre::String&amp; schemeName);

Modified: rl/trunk/engine/script/swig/RlRules.swig
===================================================================
--- rl/trunk/engine/script/swig/RlRules.swig	2007-07-30 20:46:57 UTC (rev 3645)
+++ rl/trunk/engine/script/swig/RlRules.swig	2007-07-30 20:55:01 UTC (rev 3646)
@@ -97,7 +97,6 @@
     public:
         RL_LONGLONG getTimestamp();
         Date getCurrentDate();
-        void setTimestamp(const RL_LONGLONG time);
         void setCurrentDate(const Date&amp; date);
         
         int rollD20();
@@ -726,38 +725,6 @@
         static rl::ActionManager&amp; getSingleton();
     };
     
-    %feature(&quot;director&quot;) TimerListener;
-    class TimerListener
-    {
-    public:
-        virtual ~TimerLister();
-      
-          virtual void timerFired(rl::TimerEvent* anEvent) = 0;
-    };
-    
-    class TimerEventSource
-    {
-    public:
-        static const RL_LONGLONG NO_REPEAT;
-
-        TimerEventSource( const RL_LONGLONG gameTime, const RL_LONGLONG interval = rl::TimerEventSource::NO_REPEAT );
-        TimerEventSource( const rl::Date dsaTime, const rl::Date interval = rl::TimerEventSource::NO_REPEAT );
-    
-        void addTimerListener( rl::TimerListener* ist );
-        void removeTimerListener( rl::TimerListener* ist );
-    };
-    
-    class TimerEvent
-    {
-    public:
-        TimerEvent( rl::TimerEventSource* src );
-    
-        Ogre::Real getTime();
-        rl::Date getGameTime();
-
-        rl::TimerEventSource* getSource() const;
-    };
-    
     class CreatureController
     {
     public:


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000716.html">[Dsa-hl-svn] r3645 - modules/common/scripts/jobs	modules/regressiontest/scripts rl/trunk/engine/script/include	rl/trunk/engine/script/src rl/trunk/engine/script/swig
</A></li>
	<LI>Next message: <A HREF="000718.html">[Dsa-hl-svn] r3647 - rl/trunk/engine/script/swig
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#717">[ date ]</a>
              <a href="thread.html#717">[ thread ]</a>
              <a href="subject.html#717">[ subject ]</a>
              <a href="author.html#717">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/dsa-hl-svn">More information about the Dsa-hl-svn
mailing list</a><br>
</body></html>
