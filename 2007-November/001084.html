<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Dsa-hl-svn] r4013 - modules/common/dsa modules/common/materials	modules/common/scripts modules/kanalisation/materials	modules/kanalisation/scripts	modules/regressiontest/scripts/maps modules/techdemo/dsa	modules/techdemo/scripts modules/techdemo/scripts/maps	rl/trunk/engine/rules/src
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/dsa-hl-svn/2007-November/index.html" >
   <LINK REL="made" HREF="mailto:dsa-hl-svn%40lists.berlios.de?Subject=Re%3A%20%5BDsa-hl-svn%5D%20r4013%20-%20modules/common/dsa%20modules/common/materials%0A%09modules/common/scripts%20modules/kanalisation/materials%0A%09modules/kanalisation/scripts%0A%09modules/regressiontest/scripts/maps%20modules/techdemo/dsa%0A%09modules/techdemo/scripts%20modules/techdemo/scripts/maps%0A%09rl/trunk/engine/rules/src&In-Reply-To=%3C200711290058.lAT0wYOd000944%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001083.html">
   <LINK REL="Next"  HREF="001085.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Dsa-hl-svn] r4013 - modules/common/dsa modules/common/materials	modules/common/scripts modules/kanalisation/materials	modules/kanalisation/scripts	modules/regressiontest/scripts/maps modules/techdemo/dsa	modules/techdemo/scripts modules/techdemo/scripts/maps	rl/trunk/engine/rules/src</H1>
    <B>blakharaz at mail.berlios.de</B> 
    <A HREF="mailto:dsa-hl-svn%40lists.berlios.de?Subject=Re%3A%20%5BDsa-hl-svn%5D%20r4013%20-%20modules/common/dsa%20modules/common/materials%0A%09modules/common/scripts%20modules/kanalisation/materials%0A%09modules/kanalisation/scripts%0A%09modules/regressiontest/scripts/maps%20modules/techdemo/dsa%0A%09modules/techdemo/scripts%20modules/techdemo/scripts/maps%0A%09rl/trunk/engine/rules/src&In-Reply-To=%3C200711290058.lAT0wYOd000944%40sheep.berlios.de%3E"
       TITLE="[Dsa-hl-svn] r4013 - modules/common/dsa modules/common/materials	modules/common/scripts modules/kanalisation/materials	modules/kanalisation/scripts	modules/regressiontest/scripts/maps modules/techdemo/dsa	modules/techdemo/scripts modules/techdemo/scripts/maps	rl/trunk/engine/rules/src">blakharaz at mail.berlios.de
       </A><BR>
    <I>Thu Nov 29 01:58:34 CET 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="001083.html">[Dsa-hl-svn] r4012 - in rl/trunk/engine: ai/include ai/src ui/src
</A></li>
        <LI>Next message: <A HREF="001085.html">[Dsa-hl-svn] r4014 - rl/trunk/engine/script/src
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1084">[ date ]</a>
              <a href="thread.html#1084">[ thread ]</a>
              <a href="subject.html#1084">[ subject ]</a>
              <a href="author.html#1084">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: blakharaz
Date: 2007-11-29 01:58:24 +0100 (Thu, 29 Nov 2007)
New Revision: 4013

Added:
   modules/common/materials/feuertest.material
   modules/common/materials/feuertest.particle
Removed:
   modules/kanalisation/materials/feuertest.material
   modules/kanalisation/materials/feuertest.particle
Modified:
   modules/common/dsa/gameobjectdefinitions.gof
   modules/common/scripts/torch.rb
   modules/kanalisation/scripts/equip.rb
   modules/regressiontest/scripts/maps/regressiontest.rb
   modules/techdemo/dsa/techdemo.gof
   modules/techdemo/scripts/maps/techdemo.rb
   modules/techdemo/scripts/maps/techdemo_hoehle.rb
   modules/techdemo/scripts/moduleconfig.rb
   rl/trunk/engine/rules/src/GameObjectManager.cpp
   rl/trunk/engine/rules/src/Item.cpp
   rl/trunk/engine/rules/src/Slot.cpp
Log:
Fix torch

Modified: modules/common/dsa/gameobjectdefinitions.gof
===================================================================
--- modules/common/dsa/gameobjectdefinitions.gof	2007-11-29 00:53:46 UTC (rev 4012)
+++ modules/common/dsa/gameobjectdefinitions.gof	2007-11-29 00:58:24 UTC (rev 4013)
@@ -44,10 +44,11 @@
 
 
 	&lt;gameobjectclass classid=&quot;torch&quot; baseclass=&quot;Torch&quot;&gt;
-		&lt;property name=&quot;description&quot; type=&quot;STRING&quot; data=&quot;Eine Fackel&quot;/&gt;
+		&lt;property name=&quot;name&quot; type=&quot;STRING&quot; data=&quot;Eine Fackel&quot;/&gt;
 		&lt;property name=&quot;geometrytype&quot; type=&quot;STRING&quot; data=&quot;convexhull&quot;/&gt;
 		&lt;property name=&quot;meshfile&quot; type=&quot;STRING&quot; data=&quot;ins_fackel_01.mesh&quot;/&gt;
 		&lt;property name=&quot;sound&quot; type=&quot;STRING&quot; data=&quot;feuer_knisternd_01.ogg&quot;/&gt;
+		&lt;property name=&quot;flames&quot; type=&quot;STRING&quot; data=&quot;feuertest&quot;/&gt;
 		&lt;property name=&quot;lightable&quot; type=&quot;BOOL&quot; data=&quot;true&quot;/&gt;
 		&lt;property name=&quot;lit&quot; type=&quot;BOOL&quot; data=&quot;true&quot;/&gt;
 	&lt;/gameobjectclass&gt;

Added: modules/common/materials/feuertest.material
===================================================================
--- modules/common/materials/feuertest.material	2007-11-29 00:53:46 UTC (rev 4012)
+++ modules/common/materials/feuertest.material	2007-11-29 00:58:24 UTC (rev 4013)
@@ -0,0 +1,17 @@
+material feuertest
+{
+	technique
+	{
+		pass
+		{
+			lighting off
+			depth_write off
+			scene_blend add
+
+			texture_unit
+			{
+				texture explosion.png
+			}
+		}
+	}
+}
\ No newline at end of file

Added: modules/common/materials/feuertest.particle
===================================================================
--- modules/common/materials/feuertest.particle	2007-11-29 00:53:46 UTC (rev 4012)
+++ modules/common/materials/feuertest.particle	2007-11-29 00:58:24 UTC (rev 4013)
@@ -0,0 +1,64 @@
+feuertest
+{
+	quota	7000
+	material	glow01
+	particle_width	0.8
+	particle_height	0.8
+	cull_each	false
+	renderer	billboard
+	sorted	false
+	local_space	false
+	iteration_interval	0
+	nonvisible_update_timeout	0
+	billboard_type	point
+	billboard_origin	center
+	billboard_rotation_type	vertex
+	common_up_vector	0 1 0
+	point_rendering	false
+	accurate_facing	false
+
+	emitter Point
+	{
+		angle	18
+		colour	1 1 1 1
+		colour_range_start	1 1 1 1
+		colour_range_end	1 1 1 1
+		direction	0 1 0
+		emission_rate	40
+		position	0 -0.1 0
+		velocity	0.5
+		velocity_min	0.5
+		velocity_max	0.8
+		time_to_live	0.5
+		time_to_live_min	0.5
+		time_to_live_max	1.3
+		duration	0
+		duration_min	0
+		duration_max	0
+		repeat_delay	0
+		repeat_delay_min	0
+		repeat_delay_max	0
+	}
+
+	affector ColourInterpolator
+	{
+		colour0	0.768627 0.709804 0.368627 1
+		time0	0
+		colour1	0.619608 0.396078 0.145098 1
+		time1	0.2
+		colour2	0.690196 0.384314 0.176471 1
+		time2	0.4
+		colour3	0.772549 0.4 0.129412 1
+		time3	0.6
+		colour4	0.65098 0.239216 0.117647 1
+		time4	0.8
+		colour5	0.8 0.2 0.184314 1
+		time5	1
+	}
+
+	affector Scaler
+	{
+		rate	-0.5
+	}
+}
+

Modified: modules/common/scripts/torch.rb
===================================================================
--- modules/common/scripts/torch.rb	2007-11-29 00:53:46 UTC (rev 4012)
+++ modules/common/scripts/torch.rb	2007-11-29 00:58:24 UTC (rev 4013)
@@ -43,9 +43,6 @@
         
         #TODO timer setzen, damit die Fackel nach Ablauf ihrer Lebensdauer
         # ausgeht.
-        torch.sound.getSound().setPosition(torchActor.getPosition())
-        torch.sound.play()
-        torch.flammen.getControlledObject().setActive(true)
         torch.setLit(true);
     end
 end
@@ -64,28 +61,7 @@
     
     def doAction(torch, user, target)
         return unless torch.lit?
-        # Fackel hat ein Licht am Slot SLOT_FAR_END
-        # Man k&#195;&#182;nnte es auch so machen, dass dieses Licht jetzt
-        # erzeugt und angeheftet wird. Spr&#195;&#164;che einiges daf&#195;&#188;r.
-        # Das alles ist implizites Wissen. Deshalb sollte es
-        # allgemeine Richtlinien geben und die Item-Doku sollte
-        # sowas ganz klar ausweisen. Da aber alles innerhalb von Ruby
-        # geschieht, ist das nicht so tragisch. Die C++-Seite ist
-        # an der Stelle nur dumm und macht was Ruby sagt.
         
-        torchActor = torch.getActor();
-        #torchActor.getChildByName(&quot;TorchSparks&quot;).deactivate();
-        #torchActor.getChildByName(&quot;TorchCrackle&quot;).deactivate();
-        # Activation sollte folgenderma&#195;&#159;en geregelt sein:
-        #       ist Child activated, so wird er angezeigt/erklingt
-        #       wenn Parent-Activation true ist, sonst nicht
-        #       Parent-Activity-Flag wird nicht an die
-        #       Childs weitergereicht.
-        
-        #TODO timer setzen, damit die Fackel nach Ablauf ihrer Lebensdauer
-        # ausgeht.
-        torch.sound.stop();
-        torch.flammen.getControlledObject().setActive(false)
         torch.setLit(false);
     end
 end
@@ -94,56 +70,86 @@
 # TODO Persistenz *schreck*
 class Torch &lt; Item
     include GameObjectProperties
-    attr_reader :flammen
+    attr :_prop_flames
+    attr :_prop_sound
+    attr :_prop_color
+    attr :_prop_lit
+    attr :_prop_lightable
+
     
     def initialize(id)
         super(id)
-        @flammen = $AM.createParticleSystemActor(&quot;torch&quot; + id.to_s, &quot;flammen&quot;)
-        @flammen.getControlledObject().setActive(false)
-        setLit(false)
 		addActions()
+		@_prop_color = [1, 1, 0.5, 1];
     end
     
     def setLit(lit)
-        @_prop_Lit = lit
+        @_prop_lit = lit
+		updateState();
     end
     
     def lit?
-        @_prop_Lit
+        @_prop_lit
     end
     
-    def sound
-        @_prop_Sound
-    end
-    
     def setProperty(name, value)
-        if name == &quot;sound&quot;
-            @_prop_Sound = value
-        elsif name == &quot;lit&quot;
-            @_prop_Lit = value
-        elsif name == &quot;lightable&quot;
-            @_prop_Lightable = value
-        else
-            super(name, value)
+	    p &quot;Torch prop &quot;+name+&quot; := &quot;+value.to_s();
+		if (name == &quot;lit&quot;)
+			setLit(value)
+		elsif (name == &quot;sound&quot;)
+			@_prop_sound = value;
+		elsif (name == &quot;flames&quot;)
+			@_prop_flames = value;
+		else
+			super(name, value)
         end
     end
     
     def onStateChange(oldState, newState)
 		p &quot;New state&quot;+newState.to_s()
-		if (newState == RlScript::GOS_IN_SCENE || newState == RlScript::GOS_HELD)
-			sound = $SM.createSound(&quot;feuer_knisternd_01.ogg&quot;)
-	        sound.setLooping(true)
-	        sound.set3d(true)
-	        @_prop_Sound = SoundObject.new(sound, getId().to_s())
-	        getActor().attachToSlot(@flammen, &quot;SLOT_FAR_END&quot;)
-			doAction(&quot;lighttorch&quot;) if @_prop_Lit
+		updateState();
+    end
+	
+	def updateState()
+		
+		if (getState() == RlScript::GOS_IN_SCENE || getState() == RlScript::GOS_HELD)
+			if (@_prop_sound != nil &amp;&amp; @_prop_sound != &quot;&quot; &amp;&amp; @soundObj == nil)
+				@sound = $AM.createSoundSampleActor(getId().to_s()+&quot;_sound&quot;, @_prop_sound)
+		        @sound.getControlledObject().setLooping(true)
+		        @sound.getControlledObject().set3d(true)
+				getActor().attachToSlot(@sound, &quot;SLOT_FAR_END&quot;)
+			end
+			if (@_prop_flames != nil &amp;&amp; @_prop_flames != &quot;&quot; &amp;&amp; @flammen == nil)
+				@flammen = $AM.createParticleSystemActor(getId().to_s()+&quot;_flames&quot;, @_prop_flames)
+				getActor().attachToSlot(@flammen, &quot;SLOT_FAR_END&quot;)
+			end
+			if (@light == nil)
+				@light = $AM.createLightActor(getId().to_s()+&quot;_light&quot;, LightObject::LT_POINT);
+				@light.getControlledObject().setDiffuseColour(@_prop_color);
+				@light.getControlledObject().setSpecularColour(@_prop_color);
+				@light.getControlledObject().setAttenuation(5, 1, 0, 0);
+				getActor().attachToSlot(@light, &quot;SLOT_FAR_END&quot;)
+			end
+			
+			p &quot;Lit &quot;<A HREF="https://lists.berlios.de/mailman/listinfo/dsa-hl-svn">+ at _prop_lit.to_s</A>()
+			
+			@light.getControlledObject().setActive(@_prop_lit);
+			if (@flammen != nil)
+				@flammen.getControlledObject().setActive(@_prop_lit);
+			end
+			if (@sound != nil)
+				@sound.getControlledObject().setActive(@_prop_lit);
+			end
+			
+			
+		else
 		end
-    end
+	end
     
     def addActions()
         @mLightAction = LightTorchAction.new
         @mPutoutAction = PutoutTorchAction.new
-        if @_prop_Lightable
+        if @_prop_lightable
             addAction(@mLightAction)
             addAction(@mPutoutAction)
         else
@@ -156,7 +162,7 @@
         if not @_prop_Lightable
             super(actor)
         else
-            if @_prop_Lit
+            if @_prop_lit
                 @mPutoutAction
             else
                 @mLightAction

Deleted: modules/kanalisation/materials/feuertest.material
===================================================================
--- modules/kanalisation/materials/feuertest.material	2007-11-29 00:53:46 UTC (rev 4012)
+++ modules/kanalisation/materials/feuertest.material	2007-11-29 00:58:24 UTC (rev 4013)
@@ -1,17 +0,0 @@
-material feuertest
-{
-	technique
-	{
-		pass
-		{
-			lighting off
-			depth_write off
-			scene_blend add
-
-			texture_unit
-			{
-				texture explosion.png
-			}
-		}
-	}
-}
\ No newline at end of file

Deleted: modules/kanalisation/materials/feuertest.particle
===================================================================
--- modules/kanalisation/materials/feuertest.particle	2007-11-29 00:53:46 UTC (rev 4012)
+++ modules/kanalisation/materials/feuertest.particle	2007-11-29 00:58:24 UTC (rev 4013)
@@ -1,64 +0,0 @@
-feuertest
-{
-	quota	7000
-	material	glow01
-	particle_width	0.8
-	particle_height	0.8
-	cull_each	false
-	renderer	billboard
-	sorted	false
-	local_space	false
-	iteration_interval	0
-	nonvisible_update_timeout	0
-	billboard_type	point
-	billboard_origin	center
-	billboard_rotation_type	vertex
-	common_up_vector	0 1 0
-	point_rendering	false
-	accurate_facing	false
-
-	emitter Point
-	{
-		angle	18
-		colour	1 1 1 1
-		colour_range_start	1 1 1 1
-		colour_range_end	1 1 1 1
-		direction	0 1 0
-		emission_rate	40
-		position	0 -0.1 0
-		velocity	0.5
-		velocity_min	0.5
-		velocity_max	0.8
-		time_to_live	0.5
-		time_to_live_min	0.5
-		time_to_live_max	1.3
-		duration	0
-		duration_min	0
-		duration_max	0
-		repeat_delay	0
-		repeat_delay_min	0
-		repeat_delay_max	0
-	}
-
-	affector ColourInterpolator
-	{
-		colour0	0.768627 0.709804 0.368627 1
-		time0	0
-		colour1	0.619608 0.396078 0.145098 1
-		time1	0.2
-		colour2	0.690196 0.384314 0.176471 1
-		time2	0.4
-		colour3	0.772549 0.4 0.129412 1
-		time3	0.6
-		colour4	0.65098 0.239216 0.117647 1
-		time4	0.8
-		colour5	0.8 0.2 0.184314 1
-		time5	1
-	}
-
-	affector Scaler
-	{
-		rate	-0.5
-	}
-}
-

Modified: modules/kanalisation/scripts/equip.rb
===================================================================
--- modules/kanalisation/scripts/equip.rb	2007-11-29 00:53:46 UTC (rev 4012)
+++ modules/kanalisation/scripts/equip.rb	2007-11-29 00:58:24 UTC (rev 4013)
@@ -1,27 +1,26 @@
 require 'npc.rb'
 require 'torch.rb'
-	
-	$SCRIPT.log(&quot;aktiven hero geten&quot;);
-	hero = $UI.getActiveCharacter();
-	
-	$SCRIPT.log(&quot;backpack erstellen&quot;);
-    #backpack = $GOM.createGameObject(&quot;leather backpack&quot;);
-    #backpack.addAction(ShowContainerContentAction.new());
-    #backpack.setPosition(center);
-    #backpack.placeIntoScene();
-    
-    #$SCRIPT.log(&quot;inventar f&#252;llen!!!&quot;);
-    #hero.getInventory().hold(backpack, &quot;Back&quot;);
-    
-    itemToAdd = $GOM.createGameObject(&quot;men_human_female_leg_pants_01_long&quot;);
-    hero.getInventory().hold(itemToAdd, &quot;Trousers&quot;);
-    #hero.getInventory().getItem(&quot;Back&quot;).addItem(itemToAdd);
-    itemToAdd = $GOM.createGameObject(&quot;men_human_female_cloth_short&quot;);
-    hero.getInventory().hold(itemToAdd, &quot;Clothes&quot;);
-    #hero.getInventory().getItem(&quot;Back&quot;).addItem(itemToAdd);
-    itemToAdd = $GOM.createGameObject(&quot;men_human_female_feet_boots_01&quot;);
-    hero.getInventory().hold(itemToAdd, &quot;Boots&quot;);
-   # hero.getInventory().getItem(&quot;Back&quot;).addItem(itemToAdd);
-   
-    itemToAdd = $GOM.createGameObject(&quot;torch&quot;);
-    hero.getInventory().hold(itemToAdd, &quot;Right Hand&quot;);
+
+hero = $UI.getActiveCharacter();
+
+$SCRIPT.log(&quot;backpack erstellen&quot;);
+#backpack = $GOM.createGameObject(&quot;leather backpack&quot;);
+#backpack.addAction(ShowContainerContentAction.new());
+#backpack.setPosition(center);
+#backpack.placeIntoScene();
+
+#$SCRIPT.log(&quot;inventar f&#252;llen!!!&quot;);
+#hero.getInventory().hold(backpack, &quot;Back&quot;);
+
+itemToAdd = $GOM.createGameObject(&quot;men_human_female_leg_pants_01_long&quot;);
+hero.getInventory().hold(itemToAdd, &quot;Trousers&quot;);
+#hero.getInventory().getItem(&quot;Back&quot;).addItem(itemToAdd);
+itemToAdd = $GOM.createGameObject(&quot;men_human_female_cloth_short&quot;);
+hero.getInventory().hold(itemToAdd, &quot;Clothes&quot;);
+#hero.getInventory().getItem(&quot;Back&quot;).addItem(itemToAdd);
+itemToAdd = $GOM.createGameObject(&quot;men_human_female_feet_boots_01&quot;);
+hero.getInventory().hold(itemToAdd, &quot;Boots&quot;);
+# hero.getInventory().getItem(&quot;Back&quot;).addItem(itemToAdd);
+
+itemToAdd = $GOM.createGameObject(&quot;torch&quot;);
+hero.getInventory().hold(itemToAdd, &quot;Right Hand&quot;);

Modified: modules/regressiontest/scripts/maps/regressiontest.rb
===================================================================
--- modules/regressiontest/scripts/maps/regressiontest.rb	2007-11-29 00:53:46 UTC (rev 4012)
+++ modules/regressiontest/scripts/maps/regressiontest.rb	2007-11-29 00:58:24 UTC (rev 4013)
@@ -40,22 +40,22 @@
 
 
  MaterialSlotTest.new([-15, 0, -5]).run()
-    LightzoneTest.new([-10, 0, -5]).run()
-ErrorHandlingTest.new([-10, 0, 5]).run()
-         TimeTest.new([ -5, 0, -5]).run()
-   MapLoadingTest.new([ -5, 0, -10]).run()
+#    LightzoneTest.new([-10, 0, -5]).run()
+#ErrorHandlingTest.new([-10, 0, 5]).run()
+#         TimeTest.new([ -5, 0, -5]).run()
+#   MapLoadingTest.new([ -5, 0, -10]).run()
           NpcTest.new([ -5, 0, 5]).run()
-GameObjectCreationTest.new([0, 0, -10]).run()
-         DoorTest.new([  0, 0, -5]).run()
-	  WalkJobTest.new([  0, 0, -3]).run()
-   NpcCapsuleTest.new([  0, 0, 5]).run()
-    InventoryTest.new([  0, 0, 10]).run()
-  JobSequenceTest.new([  5, 0, -5]).run()
-     SelectorTest.new([  5, 0, 0]).run()
-       EffectTest.new([  5, 0, 5]).run()
-MergeableMeshTest.new([ 10, 0, 0]).run()
-        SoundTest.new([ 10, 0, 10]).run()
-     MeshAreaTest.new([-50, 0,-55]).run()
+#GameObjectCreationTest.new([0, 0, -10]).run()
+#         DoorTest.new([  0, 0, -5]).run()
+#	  WalkJobTest.new([  0, 0, -3]).run()
+#   NpcCapsuleTest.new([  0, 0, 5]).run()
+#    InventoryTest.new([  0, 0, 10]).run()
+#  JobSequenceTest.new([  5, 0, -5]).run()
+#     SelectorTest.new([  5, 0, 0]).run()
+#       EffectTest.new([  5, 0, 5]).run()
+#MergeableMeshTest.new([ 10, 0, 0]).run()
+#        SoundTest.new([ 10, 0, 10]).run()
+#     MeshAreaTest.new([-50, 0,-55]).run()
 
 $SCRIPT.log(&quot;tests initialisiert.&quot;);
 

Modified: modules/techdemo/dsa/techdemo.gof
===================================================================
--- modules/techdemo/dsa/techdemo.gof	2007-11-29 00:53:46 UTC (rev 4012)
+++ modules/techdemo/dsa/techdemo.gof	2007-11-29 00:58:24 UTC (rev 4013)
@@ -31,12 +31,6 @@
 	    &lt;property name=&quot;quality&quot; type=&quot;STRING&quot; data=&quot;A&quot;/&gt;
     &lt;/gameobjectclass&gt;
     
-    &lt;gameobjectclass classid=&quot;torch&quot; baseclass=&quot;Torch&quot;&gt;
-    	&lt;property name=&quot;name&quot; type=&quot;STRING&quot; data=&quot;Fackel&quot;/&gt;
-    	&lt;property name=&quot;description&quot; type=&quot;STRING&quot; data=&quot;Handels&#195;&#188;bliche Fackel zum Beleuchten der Umgebung.&quot;/&gt;
-    	&lt;property name=&quot;meshfile&quot; type=&quot;STRING&quot; data=&quot;ins_fackel_01.mesh&quot;/&gt;
-    &lt;/gameobjectclass&gt;
-    
     &lt;gameobjectclass classid=&quot;Fels&quot; baseclass=&quot;Rock&quot;&gt;
     	&lt;property name=&quot;name&quot; type=&quot;STRING&quot; data=&quot;Fels&quot;/&gt;
     	&lt;property name=&quot;description&quot; type=&quot;STRING&quot; data=&quot;Ein Fels&quot;/&gt;

Modified: modules/techdemo/scripts/maps/techdemo.rb
===================================================================
--- modules/techdemo/scripts/maps/techdemo.rb	2007-11-29 00:53:46 UTC (rev 4012)
+++ modules/techdemo/scripts/maps/techdemo.rb	2007-11-29 00:58:24 UTC (rev 4013)
@@ -16,13 +16,17 @@
 $SCRIPT.log(&quot;Welten-Thema fertig&quot;);
 
 $SCRIPT.log(&quot;Get hero&quot;)
-$hero = $GOM.getGameObject(1);
+hero = $GOM.getGameObject(1);
 
 $SCRIPT.log(&quot;Prepare hero for being the active character&quot;)
-PlayerSettings.preparePlayer($hero)
+PlayerSettings.preparePlayer(hero)
 
+itemToAdd = $GOM.createGameObject(&quot;torch&quot;);
+hero.getInventory().hold(itemToAdd, &quot;Right Hand&quot;);
+
+
 $SCRIPT.log(&quot;Set hero as active character&quot;)
-$UI.setActiveCharacter($hero)
+$UI.setActiveCharacter(hero)
 
 $World.setFog( World::FOG_EXP, [0.8,0.8,1.0,0.5], 0.00003, 0.4, 1.0);
 

Modified: modules/techdemo/scripts/maps/techdemo_hoehle.rb
===================================================================
--- modules/techdemo/scripts/maps/techdemo_hoehle.rb	2007-11-29 00:53:46 UTC (rev 4012)
+++ modules/techdemo/scripts/maps/techdemo_hoehle.rb	2007-11-29 00:58:24 UTC (rev 4013)
@@ -30,48 +30,3 @@
   end
 end
 
-class UseTorchAction &lt; Action
-  def initialize
-    super(&quot;use&quot;, &quot;Benutzen&quot;)
-  end
-
-  def doAction(torch, player, target)
-    RulesSubsystem.getSingleton().getQuestBook().getQuest(&quot;hoehleZeugFackel&quot;).setState(Quest::COMPLETED)
-    player.getActor().attachToSlotAxisRot( torch.getActor(), &quot;Bone15&quot;, &quot;SLOT_HANDLE&quot;, [0.0, 0.0, 0.0], [ 1.0, 0.0, 0.0 ], 90.0 );
-    torch.setLit(true); # Licht an
-  end
-end
-
-class Torch &lt; Item
-  def initialize(id)
-    super(id)
-  end
-  
-  def placeIntoScene()
-    super()
-    if (@fackellicht == nil)
-      @fackellicht = $AM.createLightActor(&quot;Das Licht der Fackel&quot;, LightObject::LT_POINT );
-      @fackellicht.getControlledObject().setCastShadows(false);
-      @fackellicht.getControlledObject().setDiffuseColour(1.0,0.8,0.0);
-      @fackellicht.getControlledObject().setAttenuation(5.0, 0.1,  0.005, 0.0 );
-      
-      getActor().attachToSlot( @fackellicht, &quot;SLOT_FAR_END&quot; );    
-      
-      $SCRIPT.log(&quot;actor gesetzt&quot;);
-      
-      setLit(false);
-      
-      addAction(UseTorchAction.new);
-      $SCRIPT.log(&quot;Aktion hinzugefuegt.&quot;);
-    end
-  end
-  
-  def setLit(lit)
-    @fackellicht.setVisible(lit)
-    @lit = lit;
-  end
-  
-  def isLit()
-    return @lit;
-  end
-end

Modified: modules/techdemo/scripts/moduleconfig.rb
===================================================================
--- modules/techdemo/scripts/moduleconfig.rb	2007-11-29 00:53:46 UTC (rev 4012)
+++ modules/techdemo/scripts/moduleconfig.rb	2007-11-29 00:58:24 UTC (rev 4013)
@@ -23,8 +23,9 @@
 
     def start()
 		require 'player.rb'
-		require 'hero.rb'
+		require 'mckhero.rb'
 		require 'npc.rb'
+		require 'torch.rb'
 		require &quot;techdemo_umgebung.rb&quot;
 		require &quot;techdemo_quests.rb&quot;
 		require &quot;techdemo_spinne.rb&quot;

Modified: rl/trunk/engine/rules/src/GameObjectManager.cpp
===================================================================
--- rl/trunk/engine/rules/src/GameObjectManager.cpp	2007-11-29 00:53:46 UTC (rev 4012)
+++ rl/trunk/engine/rules/src/GameObjectManager.cpp	2007-11-29 00:58:24 UTC (rev 4013)
@@ -146,10 +146,12 @@
             -&gt;createGameObject(
                 classname,
                 goId);
-
-        go-&gt;setClassId(classId);
-        applyProperties(go, ps);
-        mGameObjects[goId] = go;
+        if (go)
+        {
+            go-&gt;setClassId(classId);
+            applyProperties(go, ps);
+            mGameObjects[goId] = go;
+        }
         return go;
     }
 

Modified: rl/trunk/engine/rules/src/Item.cpp
===================================================================
--- rl/trunk/engine/rules/src/Item.cpp	2007-11-29 00:53:46 UTC (rev 4012)
+++ rl/trunk/engine/rules/src/Item.cpp	2007-11-29 00:58:24 UTC (rev 4013)
@@ -116,21 +116,21 @@
         GameObjectState oldState = mState;
 
 
-        if( targetstate != GOS_HELD &amp;&amp;
+        if (targetstate != GOS_HELD &amp;&amp;
             targetstate != GOS_IN_POSSESSION &amp;&amp;
-            targetstate != GOS_READY )
+            targetstate != GOS_READY)
         {
-            if( mState == GOS_HELD ||
+            if (mState == GOS_HELD ||
                 mState == GOS_IN_POSSESSION ||
-                mState == GOS_READY )
+                mState == GOS_READY)
             {
                 mState = GOS_LOADED; // &lt;- this is important to avoid endless recursion!
                 onStateChange(oldState, mState);
 
-                if( getParentSlot() )
+                if (getParentSlot())
                     getParentSlot()-&gt;setItem(NULL);
                 setParentSlot(NULL);
-                if( getParentContainer() )
+                if (getParentContainer())
                     getParentContainer()-&gt;removeItem(this);
                 setParentContainer(NULL);
                 doLoose();
@@ -141,9 +141,9 @@
         }
         else
         {
-            if( mState == GOS_HELD ||
+            if (mState == GOS_HELD ||
                 mState == GOS_IN_POSSESSION ||
-                mState == GOS_READY )
+                mState == GOS_READY)
             {
                 LOG_WARNING(Logger::RULES, 
                     &quot;Item::removeOldState() or Item::setState(GOS_LOADED) should be called  \
@@ -151,12 +151,17 @@
             }
             else
             {
-                if( mState != GOS_LOADED )
+                if (mState != GOS_LOADED)
                 {
                     GameObject::setState(GOS_LOADED);
                     oldState = GOS_LOADED;
                 }
 
+                if (targetstate == GOS_HELD)
+                {
+                    doHold();
+                }
+
                 mState = targetstate;
                 onStateChange(oldState, mState);
             }
@@ -235,7 +240,10 @@
 
     void Item::doCreateActor()
     {
-        setActor(createActor());
+        if (!getActor())
+        {
+            setActor(createActor());
+        }
     }
 
     void Item::setParentContainer(Container* cont)

Modified: rl/trunk/engine/rules/src/Slot.cpp
===================================================================
--- rl/trunk/engine/rules/src/Slot.cpp	2007-11-29 00:53:46 UTC (rev 4012)
+++ rl/trunk/engine/rules/src/Slot.cpp	2007-11-29 00:58:24 UTC (rev 4013)
@@ -42,33 +42,30 @@
 
     bool Slot::isAllowed(const Item *item) const
     {
-        if( item == NULL )
+        if (item == NULL)
             return false;
         int type = item-&gt;getItemType();
         return (type &amp; mItemReadyMask) == type || (type &amp; mItemHeldMask) == type;
     }
 
     bool Slot::canReady(const Item *item) const
-
-
     {
-        if( item == NULL )
+        if (item == NULL)
             return false;
         int type = item-&gt;getItemType();
         return (type &amp; mItemReadyMask) == type;
     }
 
     bool Slot::standardSetItem(Item* item)
-
     {
         if (item)
         {
-            if( isAllowed(item) &amp;&amp; isEmpty())
+            if (isAllowed(item) &amp;&amp; isEmpty())
             {
                 item-&gt;removeOldState();
                 item-&gt;setOwner(mOwner);
                 item-&gt;setParentSlot(this);
-                if( canReady(item) )
+                if (canReady(item))
                     item-&gt;setState(GOS_READY);
                 else
                     item-&gt;setState(GOS_HELD);
@@ -88,7 +85,7 @@
         {
             // this is the case, if the item is removed automatically
             // don't change this without looking at Item::setState
-            if( mItem-&gt;getState() != GOS_LOADED )
+            if (mItem-&gt;getState() != GOS_LOADED)
                 mItem-&gt;setState(GOS_LOADED);
             mItem = NULL;
 
@@ -105,14 +102,19 @@
 
     void BoneSlot::setItem(Item* item)
     {
-        if( !standardSetItem(item) )
+        if (!standardSetItem(item))
             return;
 
-        if(item)
+        if (item)
         {
-            if (mOwner-&gt;getState() == GOS_IN_SCENE)
+            if (mOwner-&gt;getState() == GOS_IN_SCENE
+                || mOwner-&gt;getState() == GOS_HELD
+                || mOwner-&gt;getState() == GOS_READY)
             {
-                mItem-&gt;doCreateActor();
+                if (!mItem-&gt;getActor())
+                {
+                    mItem-&gt;doCreateActor();
+                }
                 mOwner-&gt;getActor()-&gt;attachToSlot(mItem-&gt;getActor(), mBone);
             }
         }
@@ -127,7 +129,7 @@
     void SubmeshSlot::setItem(Item* item)
     {
         Item* oldItem = mItem;
-        if( !standardSetItem(item) )
+        if (!standardSetItem(item))
             return;
 
 
@@ -178,7 +180,7 @@
 
     void MaterialSlot::setItem(Item* item)
     {
-        if( !standardSetItem(item) )
+        if (!standardSetItem(item))
             return;
 
 


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001083.html">[Dsa-hl-svn] r4012 - in rl/trunk/engine: ai/include ai/src ui/src
</A></li>
	<LI>Next message: <A HREF="001085.html">[Dsa-hl-svn] r4014 - rl/trunk/engine/script/src
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1084">[ date ]</a>
              <a href="thread.html#1084">[ thread ]</a>
              <a href="subject.html#1084">[ subject ]</a>
              <a href="author.html#1084">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/dsa-hl-svn">More information about the Dsa-hl-svn
mailing list</a><br>
</body></html>
