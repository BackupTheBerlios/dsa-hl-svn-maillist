<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Dsa-hl-svn] r4071 - in rl/trunk/engine: ai/include ai/src core/src	rules rules/include rules/src script/swig ui ui/include ui/src
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/dsa-hl-svn/2008-February/index.html" >
   <LINK REL="made" HREF="mailto:dsa-hl-svn%40lists.berlios.de?Subject=Re%3A%20%5BDsa-hl-svn%5D%20r4071%20-%20in%20rl/trunk/engine%3A%20ai/include%20ai/src%20core/src%0A%09rules%20rules/include%20rules/src%20script/swig%20ui%20ui/include%20ui/src&In-Reply-To=%3C200802202134.m1KLYGhC015188%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001141.html">
   <LINK REL="Next"  HREF="001143.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Dsa-hl-svn] r4071 - in rl/trunk/engine: ai/include ai/src core/src	rules rules/include rules/src script/swig ui ui/include ui/src</H1>
    <B>tanis at mail.berlios.de</B> 
    <A HREF="mailto:dsa-hl-svn%40lists.berlios.de?Subject=Re%3A%20%5BDsa-hl-svn%5D%20r4071%20-%20in%20rl/trunk/engine%3A%20ai/include%20ai/src%20core/src%0A%09rules%20rules/include%20rules/src%20script/swig%20ui%20ui/include%20ui/src&In-Reply-To=%3C200802202134.m1KLYGhC015188%40sheep.berlios.de%3E"
       TITLE="[Dsa-hl-svn] r4071 - in rl/trunk/engine: ai/include ai/src core/src	rules rules/include rules/src script/swig ui ui/include ui/src">tanis at mail.berlios.de
       </A><BR>
    <I>Wed Feb 20 22:34:16 CET 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="001141.html">[Dsa-hl-svn] r4070 - modules/combattest/dsa
</A></li>
        <LI>Next message: <A HREF="001143.html">[Dsa-hl-svn] r4072 - in modules: regressiontest/dsa techdemo2/dsa
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1142">[ date ]</a>
              <a href="thread.html#1142">[ thread ]</a>
              <a href="subject.html#1142">[ subject ]</a>
              <a href="author.html#1142">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: tanis
Date: 2008-02-20 22:34:04 +0100 (Wed, 20 Feb 2008)
New Revision: 4071

Added:
   rl/trunk/engine/rules/include/CombatAction.h
   rl/trunk/engine/rules/include/GameEventLog.h
   rl/trunk/engine/rules/include/RulesMessages.h
   rl/trunk/engine/rules/src/GameEventLog.cpp
   rl/trunk/engine/ui/include/CombatGui.h
   rl/trunk/engine/ui/src/CombatGui.cpp
Modified:
   rl/trunk/engine/ai/include/AgentCombatState.h
   rl/trunk/engine/ai/include/AiMessages.h
   rl/trunk/engine/ai/src/AgentCombatState.cpp
   rl/trunk/engine/core/src/CameraObject.cpp
   rl/trunk/engine/rules/RlRules2005.vcproj
   rl/trunk/engine/rules/include/Combat.h
   rl/trunk/engine/rules/include/CombatManager.h
   rl/trunk/engine/rules/include/Combatant.h
   rl/trunk/engine/rules/include/RulesConstants.h
   rl/trunk/engine/rules/include/RulesSubsystem.h
   rl/trunk/engine/rules/src/Combat.cpp
   rl/trunk/engine/rules/src/CombatManager.cpp
   rl/trunk/engine/rules/src/Combatant.cpp
   rl/trunk/engine/rules/src/RulesSubsystem.cpp
   rl/trunk/engine/script/swig/RlRules.head.swig
   rl/trunk/engine/script/swig/RlRules.swig
   rl/trunk/engine/script/swig/RlUi.head.swig
   rl/trunk/engine/script/swig/RlUi.swig
   rl/trunk/engine/ui/RlUI2005.vcproj
   rl/trunk/engine/ui/include/CombatControlState.h
   rl/trunk/engine/ui/include/CombatWindow.h
   rl/trunk/engine/ui/include/GameLoggerWindow.h
   rl/trunk/engine/ui/src/CombatControlState.cpp
   rl/trunk/engine/ui/src/CombatWindow.cpp
   rl/trunk/engine/ui/src/GameLoggerWindow.cpp
   rl/trunk/engine/ui/src/InputManager.cpp
Log:
GameLoggerWindow is now a view of new class GameEventLogger. This way gae events can be logged directly in RlRules and independant of a window.
Irrelevant beginnings of the combat system. Too lazy to separate it from other changes and it does no harm. Honest.

Modified: rl/trunk/engine/ai/include/AgentCombatState.h
===================================================================
--- rl/trunk/engine/ai/include/AgentCombatState.h	2008-02-20 21:30:25 UTC (rev 4070)
+++ rl/trunk/engine/ai/include/AgentCombatState.h	2008-02-20 21:34:04 UTC (rev 4071)
@@ -34,6 +34,8 @@
 
         virtual ~AgentCombatState();
 
+        virtual void requestCombatantAction();
+
         virtual Ogre::String getCombatantTypeName() const;
 
 		/** Function invoked by Agents to advance the AI.

Modified: rl/trunk/engine/ai/include/AiMessages.h
===================================================================
--- rl/trunk/engine/ai/include/AiMessages.h	2008-02-20 21:30:25 UTC (rev 4070)
+++ rl/trunk/engine/ai/include/AiMessages.h	2008-02-20 21:34:04 UTC (rev 4071)
@@ -24,6 +24,7 @@
 {
     class Dialog;
 
+	/// 0x02xxxxxx as mask for ai messages
     enum AiMessageTypeIds
     {
         // Controllers //

Modified: rl/trunk/engine/ai/src/AgentCombatState.cpp
===================================================================
--- rl/trunk/engine/ai/src/AgentCombatState.cpp	2008-02-20 21:30:25 UTC (rev 4070)
+++ rl/trunk/engine/ai/src/AgentCombatState.cpp	2008-02-20 21:34:04 UTC (rev 4071)
@@ -17,6 +17,7 @@
 
 #include &quot;Agent.h&quot;
 #include &quot;AgentCombatState.h&quot;
+#include &quot;CombatManager.h&quot;
 #include &quot;CreatureControllerManager.h&quot;
 
 namespace rl
@@ -24,8 +25,9 @@
 
     AgentCombatState::AgentCombatState(Agent* agent)
         : AgentState(agent),
-        Combatant(CreatureControllerManager::getSingleton().getCreatureController(
-            agent-&gt;getControlledCreature())),
+        Combatant(CombatManager::getSingleton().getCurrentCombat(),
+            CreatureControllerManager::getSingleton().getCreatureController(
+                agent-&gt;getControlledCreature())),
         mState()
     {
     }
@@ -39,6 +41,11 @@
         return &quot;default&quot;;
     }
 
+    void AgentCombatState::requestCombatantAction()
+    {
+        // Think!
+    }
+
 	void AgentCombatState::update(const float elapsedTime)
     {
         mAgent-&gt;updateVehicle(0, elapsedTime);

Modified: rl/trunk/engine/core/src/CameraObject.cpp
===================================================================
--- rl/trunk/engine/core/src/CameraObject.cpp	2008-02-20 21:30:25 UTC (rev 4070)
+++ rl/trunk/engine/core/src/CameraObject.cpp	2008-02-20 21:34:04 UTC (rev 4071)
@@ -76,11 +76,11 @@
 	Vector3 CameraObject::getPointOnCeGuiScreen(const Ogre::Vector3&amp; worldCoords) const
 	{
 		//see Ogre::Camera::getCameraToViewportRay(Real, Real)
-		//		Real nx = (2.0f * screenX) - 1.0f;
-		//		Real ny = 1.0f - (2.0f * screenY);
-		// -&gt; screenX = (nx + 1.0f) / 2.0f
-		// -&gt; screenY = (1.0f - ny) / 2.0f
-
+		//		Real nx = (2.0f * screenX) - 1.0f;
+		//		Real ny = 1.0f - (2.0f * screenY);
+		// -&gt; screenX = (nx + 1.0f) / 2.0f
+		// -&gt; screenY = (1.0f - ny) / 2.0f
+
 		Vector3 screenSpacePos = getPointOnScreen(worldCoords);
 		screenSpacePos.x = (screenSpacePos.x + 1.0f) / 2.0f;
 		screenSpacePos.y = (1.0f - screenSpacePos.y) / 2.0f;

Modified: rl/trunk/engine/rules/RlRules2005.vcproj
===================================================================
--- rl/trunk/engine/rules/RlRules2005.vcproj	2008-02-20 21:30:25 UTC (rev 4070)
+++ rl/trunk/engine/rules/RlRules2005.vcproj	2008-02-20 21:34:04 UTC (rev 4071)
@@ -1,7 +1,7 @@
 &lt;?xml version=&quot;1.0&quot; encoding=&quot;Windows-1252&quot;?&gt;
 &lt;VisualStudioProject
 	ProjectType=&quot;Visual C++&quot;
-	Version=&quot;8,00&quot;
+	Version=&quot;8.00&quot;
 	Name=&quot;RlRules&quot;
 	ProjectGUID=&quot;{1D1D45B2-A9C3-4D10-93EC-22AE4AA5C070}&quot;
 	RootNamespace=&quot;RlRules&quot;
@@ -351,6 +351,10 @@
 				&gt;
 			&lt;/File&gt;
 			&lt;File
+				RelativePath=&quot;.\src\GameEventLog.cpp&quot;
+				&gt;
+			&lt;/File&gt;
+			&lt;File
 				RelativePath=&quot;.\src\GameObjectManager.cpp&quot;
 				&gt;
 			&lt;/File&gt;
@@ -521,6 +525,10 @@
 				&gt;
 			&lt;/File&gt;
 			&lt;File
+				RelativePath=&quot;.\include\CombatAction.h&quot;
+				&gt;
+			&lt;/File&gt;
+			&lt;File
 				RelativePath=&quot;.\include\Combatant.h&quot;
 				&gt;
 			&lt;/File&gt;
@@ -569,6 +577,10 @@
 				&gt;
 			&lt;/File&gt;
 			&lt;File
+				RelativePath=&quot;.\include\GameEventLog.h&quot;
+				&gt;
+			&lt;/File&gt;
+			&lt;File
 				RelativePath=&quot;.\include\GameObjectManager.h&quot;
 				&gt;
 			&lt;/File&gt;
@@ -625,6 +637,10 @@
 				&gt;
 			&lt;/File&gt;
 			&lt;File
+				RelativePath=&quot;.\include\RulesMessages.h&quot;
+				&gt;
+			&lt;/File&gt;
+			&lt;File
 				RelativePath=&quot;.\include\RulesPrerequisites.h&quot;
 				&gt;
 			&lt;/File&gt;

Modified: rl/trunk/engine/rules/include/Combat.h
===================================================================
--- rl/trunk/engine/rules/include/Combat.h	2008-02-20 21:30:25 UTC (rev 4070)
+++ rl/trunk/engine/rules/include/Combat.h	2008-02-20 21:34:04 UTC (rev 4071)
@@ -18,9 +18,11 @@
 #define __RL_COMBAT_H__
 
 #include &quot;RulesPrerequisites.h&quot;
+#include &quot;CombatAction.h&quot;
 
 #include &lt;set&gt;
 #include &lt;vector&gt;
+#include &lt;boost/tuple/tuple.hpp&gt;
 
 namespace rl
 {
@@ -31,7 +33,7 @@
     public:
         typedef std::set&lt;Combatant*&gt; CombatantSet;
 
-        Combat(Combatant* character);
+        Combat();
         ~Combat();
 
         void addOpponent(Combatant*);
@@ -46,17 +48,28 @@
         void start();
         void stop();
 
+        // Called by combatants in response to a request by the Combat object.
+        // With calling this function combatants register their actions for this round.
+        void registerCombatantAction(Combatant*, CombatAction*, CombatAction*, CombatAction*);
+
     private:
-        Combatant* mCharacter;
+        typedef std::vector&lt;std::pair&lt;int, Combatant*&gt; &gt; CombatantQueue;
+        /// Stores the max three actions a combatant can do per round.
+        /// Probably has to be replaced with a more sophisticated container later on,
+        /// but for now it will do what it needs to.
+        typedef boost::tuples::tuple&lt;CombatAction*, CombatAction*, CombatAction*&gt; ActionTuple;
+        typedef std::map&lt;Combatant*, ActionTuple&gt; CombatantActionMap;
+
         CombatantSet mOpponents;
         CombatantSet mAllies;
-        typedef std::vector&lt;std::pair&lt;int, Combatant*&gt; &gt; CombatantQueue;
-        // Combatants in order of their initiative for the current round.
+        /// Combatants in order of their initiative for the current round.
         CombatantQueue mCombatantQueue;
-        // Combatants in order of their initiative for the next round.
-        // Will be copied to the current round after current round is done
-        // and then it will be emptied.
-        CombatantQueue mNextCombatQueue;
+        CombatantActionMap mCombatantActions;
+
+        unsigned short mCurrentRound;
+
+        void beginRound();
+        void endRound();
     };
 }
 

Added: rl/trunk/engine/rules/include/CombatAction.h
===================================================================
--- rl/trunk/engine/rules/include/CombatAction.h	2008-02-20 21:30:25 UTC (rev 4070)
+++ rl/trunk/engine/rules/include/CombatAction.h	2008-02-20 21:34:04 UTC (rev 4071)
@@ -0,0 +1,41 @@
+/* This source file is part of Rastullahs Lockenpracht.
+ * Copyright (C) 2003-2007 Team Pantheon. <A HREF="http://www.team-pantheon.de">http://www.team-pantheon.de</A>
+ * 
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the Clarified Artistic License.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  Clarified Artistic License for more details.
+ *
+ *  You should have received a copy of the Clarified Artistic License
+ *  along with this program; if not you can get it here
+ *  <A HREF="http://www.jpaulmorrison.com/fbp/artistic2.htm.">http://www.jpaulmorrison.com/fbp/artistic2.htm.</A>
+ */
+
+#ifndef __RL_COMBATACTION_H__
+#define __RL_COMBATACTION_H__
+
+#include &quot;RulesPrerequisites.h&quot;
+#include &quot;Action.h&quot;
+
+namespace rl
+{
+    class Combatant;
+
+    class _RlRulesExport CombatAction : public Action
+    {
+    public:
+        typedef enum {FREE_ACTION, ACTIVE_ACTION, REACTIVE_ACTION, LONG_TERM_ACTION} Type;
+
+        CombatAction(Type type, const CeGuiString name, const CeGuiString description);
+        virtual ~CombatAction() {}
+
+        Type getType() const;
+    protected:
+        Type mType;
+    };
+}
+
+#endif

Modified: rl/trunk/engine/rules/include/CombatManager.h
===================================================================
--- rl/trunk/engine/rules/include/CombatManager.h	2008-02-20 21:30:25 UTC (rev 4070)
+++ rl/trunk/engine/rules/include/CombatManager.h	2008-02-20 21:34:04 UTC (rev 4071)
@@ -37,10 +37,8 @@
         ~CombatManager();
 
         /// Creates a new combat object and sets it active.
-        /// @param character the player character
-        /// @param firstOpponent the opponent, that caused the combat.
         /// @throw IllegalStateException if there is already a combat running.
-        Combat* startCombat(Combatant* character, Combatant* firstOpponent);
+        Combat* startCombat();
 
         /// Return the combat currently running, NULL if there is none.
         Combat* getCurrentCombat() const;

Modified: rl/trunk/engine/rules/include/Combatant.h
===================================================================
--- rl/trunk/engine/rules/include/Combatant.h	2008-02-20 21:30:25 UTC (rev 4070)
+++ rl/trunk/engine/rules/include/Combatant.h	2008-02-20 21:34:04 UTC (rev 4071)
@@ -21,20 +21,32 @@
 
 namespace rl
 {
+    class Combat;
     class Creature;
     class CreatureController;
 
-    class _RlRulesExport Combatant
+    /// Base class of combat participiants. This defines the interface Combat uses
+	/// to communicate with Combatants. Be it AI bots or actual users.
+	class _RlRulesExport Combatant
     {
     public:
-        Combatant(CreatureController* controller);
+        Combatant(Combat* combat, CreatureController* controller);
         virtual ~Combatant();
 
-        virtual Ogre::String getCombatantTypeName() const = 0;
+        /// This function is called by the Combat the Combatantant is taking part in,
+        /// in order to request it to register actions for the next round.
+        /// In response to this call Combatant is supposed to call Combat#registerCombatantAction.
+        /// The call is not required to be done immediatly,
+        /// it can be done synchronously or asynchronously.
+        virtual void requestCombatantAction() = 0;
 
+        /// Type name used by factory
+		virtual Ogre::String getCombatantTypeName() const = 0;
+
         CreatureController* getCreatureController() const;
 
     protected:
+        Combat* mCombat;
         CreatureController* mController;
     };
 

Added: rl/trunk/engine/rules/include/GameEventLog.h
===================================================================
--- rl/trunk/engine/rules/include/GameEventLog.h	2008-02-20 21:30:25 UTC (rev 4070)
+++ rl/trunk/engine/rules/include/GameEventLog.h	2008-02-20 21:34:04 UTC (rev 4071)
@@ -0,0 +1,48 @@
+/* This source file is part of Rastullahs Lockenpracht.
+* Copyright (C) 2003-2007 Team Pantheon. <A HREF="http://www.team-pantheon.de">http://www.team-pantheon.de</A>
+* 
+*  This program is free software; you can redistribute it and/or modify
+*  it under the terms of the Clarified Artistic License.
+*
+*  This program is distributed in the hope that it will be useful,
+*  but WITHOUT ANY WARRANTY; without even the implied warranty of
+*  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+*  Clarified Artistic License for more details.
+*
+*  You should have received a copy of the Clarified Artistic License
+*  along with this program; if not you can get it here
+*  <A HREF="http://www.jpaulmorrison.com/fbp/artistic2.htm.">http://www.jpaulmorrison.com/fbp/artistic2.htm.</A>
+*/
+
+#ifndef __GAMEEVENTLOG_H__
+#define __GAMEEVENTLOG_H__
+
+#include &quot;RulesPrerequisites.h&quot;
+
+#include &quot;RulesConstants.h&quot;
+
+namespace rl
+{
+	class _RlRulesExport GameEventLog : public Ogre::Singleton&lt;GameEventLog&gt;
+    {
+    public:
+        GameEventLog();
+
+		/// Set the number of event entries kept in memory.
+		/// If more events are logged, oldest message is removed.
+		void setEventQueueLength(size_t length);
+
+		/// Get the number of event entries kept in memory.
+		size_t getEventQueueLength() const;
+
+		void logEvent(const Ogre::String&amp; eventString, GameEventType type);
+
+	private:
+		typedef std::pair&lt;GameEventType, Ogre::String&gt; LogEntry;
+		std::deque&lt;LogEntry&gt; mLog;
+		size_t mLogSize;
+    };
+
+}
+
+#endif //__GAMEEVENTLOG_H__

Modified: rl/trunk/engine/rules/include/RulesConstants.h
===================================================================
--- rl/trunk/engine/rules/include/RulesConstants.h	2008-02-20 21:30:25 UTC (rev 4070)
+++ rl/trunk/engine/rules/include/RulesConstants.h	2008-02-20 21:34:04 UTC (rev 4071)
@@ -49,6 +49,15 @@
         SLOT_SUBMESH,
         SLOT_MATERIAL
     };
+
+	/// Event type that are distinguished in the game event log
+	enum GameEventType
+	{
+		GET_DEFAULT, ///!&lt; If nothing else fits..
+		GET_COMBAT,  ///!&lt; Combat events (&quot;Alrike hits Wolf for 10TP&quot;)
+		GET_DIALOG,  ///!&lt; Dialog events (&quot;Charisma roll succeded.&quot;)
+		GET_QUEST    ///!&lt; Quest related events (&quot;Quest succeded: Kill Wolf.&quot;)
+	};
 }
 
 #endif // __RULESCONSTANTS_H__

Added: rl/trunk/engine/rules/include/RulesMessages.h
===================================================================
--- rl/trunk/engine/rules/include/RulesMessages.h	2008-02-20 21:30:25 UTC (rev 4070)
+++ rl/trunk/engine/rules/include/RulesMessages.h	2008-02-20 21:34:04 UTC (rev 4071)
@@ -0,0 +1,42 @@
+/* This source file is part of Rastullahs Lockenpracht.
+* Copyright (C) 2003-2007 Team Pantheon. <A HREF="http://www.team-pantheon.de">http://www.team-pantheon.de</A>
+* 
+*  This program is free software; you can redistribute it and/or modify
+*  it under the terms of the Clarified Artistic License.
+*
+*  This program is distributed in the hope that it will be useful,
+*  but WITHOUT ANY WARRANTY; without even the implied warranty of
+*  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+*  Clarified Artistic License for more details.
+*
+*  You should have received a copy of the Clarified Artistic License
+*  along with this program; if not you can get it here
+*  <A HREF="http://www.jpaulmorrison.com/fbp/artistic2.htm.">http://www.jpaulmorrison.com/fbp/artistic2.htm.</A>
+*/
+
+#ifndef __Rl_RulesMessages_H__
+#define __Rl_RulesMessages_H__
+
+#include &quot;RulesPrerequisites.h&quot;
+
+#include &quot;MessageType.h&quot;
+#include &quot;RulesConstants.h&quot;
+
+namespace rl
+{
+	/// 0x03xxxxxx as mask for rules messages
+    enum RulesMessageTypeIds
+    {
+        // Game event log //
+        // Mask
+        RLMSG_GAMEEVENTLOG_EVENTS = 0x03000100,
+        // Events
+        RLMSG_GAMEEVENTLOG_EVENT_ADDED = 0x03000101,
+    };
+
+    /// Message sent right after a new game log event has been added.
+	typedef MessageType&lt;RLMSG_GAMEEVENTLOG_EVENT_ADDED, GameEventType, Ogre::String&gt;
+		MessageType_GameEventLog_EventAdded;
+
+}
+#endif

Modified: rl/trunk/engine/rules/include/RulesSubsystem.h
===================================================================
--- rl/trunk/engine/rules/include/RulesSubsystem.h	2008-02-20 21:30:25 UTC (rev 4070)
+++ rl/trunk/engine/rules/include/RulesSubsystem.h	2008-02-20 21:34:04 UTC (rev 4071)
@@ -23,11 +23,12 @@
 
 namespace rl
 {
-	class QuestBook;
     class ActionManager;
     class CombatManager;
+    class CreatureControllerManager;
     class DsaManager;
-    class CreatureControllerManager;
+	class GameEventLog;
+	class QuestBook;
     class XdimlLoader;
 
 	class _RlRulesExport RulesSubsystem : public Ogre::Singleton&lt;RulesSubsystem&gt;
@@ -44,6 +45,7 @@
         ActionManager* mActionManager;
         CombatManager* mCombatManager;
         DsaManager* mDsaManager;
+		GameEventLog* mGameEventLog;
         CreatureControllerManager *mMovingCreatureManager;
         XdimlLoader* mXdimlLoader;
     };

Modified: rl/trunk/engine/rules/src/Combat.cpp
===================================================================
--- rl/trunk/engine/rules/src/Combat.cpp	2008-02-20 21:30:25 UTC (rev 4070)
+++ rl/trunk/engine/rules/src/Combat.cpp	2008-02-20 21:34:04 UTC (rev 4071)
@@ -19,7 +19,14 @@
 
 #include &quot;Combatant.h&quot;
 #include &quot;CreatureController.h&quot;
+#include &quot;GameEventLog.h&quot;
 
+#include &lt;OgreStringConverter.h&gt;
+
+using namespace boost;
+using namespace boost::tuples;
+using namespace Ogre;
+
 namespace rl
 {
     struct InitiativeComparator
@@ -33,7 +40,12 @@
         }
     };
 
-    Combat::Combat(Combatant* character) : mCharacter(character)
+    Combat::Combat()
+        : mOpponents(),
+          mAllies(),
+          mCombatantQueue(),
+          mCombatantActions(),
+          mCurrentRound(0)
     {
     }
 
@@ -73,7 +85,11 @@
 
     void Combat::start()
     {
-        mCombatantQueue.clear();
+		GameEventLog::getSingleton().logEvent(&quot;Kampf beginnt.&quot;, GET_COMBAT);
+
+        mCurrentRound = 0;
+		mCombatantQueue.clear();
+
         std::vector&lt;Combatant*&gt; combatants;
         combatants.insert(combatants.end(), mAllies.begin(), mAllies.end());
         combatants.insert(combatants.end(), mOpponents.begin(), mOpponents.end());
@@ -85,9 +101,56 @@
                 (*it)-&gt;getCreatureController()-&gt;getCreature()-&gt;getInitiativeBasis(), *it));
         }
         std::sort(mCombatantQueue.begin(), mCombatantQueue.end(), InitiativeComparator());
+
+        beginRound();
     }
 
     void Combat::stop()
     {
     }
+
+    void Combat::beginRound()
+    {
+        // Increment round counter
+        mCurrentRound++;
+        mCombatantActions.clear();
+
+		GameEventLog::getSingleton().logEvent(&quot;Runde &quot; + StringConverter::toString(mCurrentRound),
+			GET_COMBAT);
+		// Show ini for this round.
+        for (CombatantQueue::iterator it = mCombatantQueue.begin();
+			it != mCombatantQueue.end(); ++it)
+        {
+			String evt = it-&gt;second-&gt;getCreatureController()-&gt;getCreature()-&gt;getName().c_str();
+			evt += &quot; - Initiative: &quot; + StringConverter::toString(it-&gt;first);
+			GameEventLog::getSingleton().logEvent(evt, GET_COMBAT);
+        }
+
+
+        // Request actions from combatants
+        for (CombatantQueue::iterator it = mCombatantQueue.begin();
+            it != mCombatantQueue.end(); ++it)
+        {
+            it-&gt;second-&gt;requestCombatantAction();
+        }
+    }
+
+    void Combat::registerCombatantAction(Combatant* combatant,
+        CombatAction* action1, CombatAction* action2, CombatAction* action3)
+    {
+        mCombatantActions[combatant] = ActionTuple(action1, action2, action3);
+        // Are all combatants registered now?
+        if (mCombatantActions.size() == mCombatantQueue.size())
+        {
+            endRound();
+        }
+    }
+
+    void Combat::endRound()
+    {
+        // All actions are registered. Now we can calculate the combat.
+        // 
+
+        // Refill combatant queue with combatants that are still alive.
+    }
 }

Modified: rl/trunk/engine/rules/src/CombatManager.cpp
===================================================================
--- rl/trunk/engine/rules/src/CombatManager.cpp	2008-02-20 21:30:25 UTC (rev 4070)
+++ rl/trunk/engine/rules/src/CombatManager.cpp	2008-02-20 21:34:04 UTC (rev 4071)
@@ -36,15 +36,14 @@
     {
     }
 
-    Combat* CombatManager::startCombat(Combatant* character, Combatant* firstOpponent)
+    Combat* CombatManager::startCombat()
     {
         if (mCurrentCombat != NULL)
         {
             Throw(IllegalStateException, &quot;There already is a combat running.&quot;);
         }
 
-        mCurrentCombat = new Combat(character);
-        mCurrentCombat-&gt;addOpponent(firstOpponent);
+        mCurrentCombat = new Combat();
 
         return mCurrentCombat;
     }

Modified: rl/trunk/engine/rules/src/Combatant.cpp
===================================================================
--- rl/trunk/engine/rules/src/Combatant.cpp	2008-02-20 21:30:25 UTC (rev 4070)
+++ rl/trunk/engine/rules/src/Combatant.cpp	2008-02-20 21:34:04 UTC (rev 4071)
@@ -16,10 +16,12 @@
 #include &quot;stdinc.h&quot;
 
 #include &quot;Combatant.h&quot;
+#include &quot;Combat.h&quot;
 
 namespace rl
 {
-    Combatant::Combatant(CreatureController* controller) : mController(controller)
+    Combatant::Combatant(Combat* combat, CreatureController* controller)
+        : mCombat(combat), mController(controller)
     {
     }
 

Added: rl/trunk/engine/rules/src/GameEventLog.cpp
===================================================================
--- rl/trunk/engine/rules/src/GameEventLog.cpp	2008-02-20 21:30:25 UTC (rev 4070)
+++ rl/trunk/engine/rules/src/GameEventLog.cpp	2008-02-20 21:34:04 UTC (rev 4071)
@@ -0,0 +1,49 @@
+/* This source file is part of Rastullahs Lockenpracht.
+* Copyright (C) 2003-2007 Team Pantheon. <A HREF="http://www.team-pantheon.de">http://www.team-pantheon.de</A>
+*
+*  This program is free software; you can redistribute it and/or modify
+*  it under the terms of the Clarified Artistic License.
+*
+*  This program is distributed in the hope that it will be useful,
+*  but WITHOUT ANY WARRANTY; without even the implied warranty of
+*  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+*  Clarified Artistic License for more details.
+*
+*  You should have received a copy of the Clarified Artistic License
+*  along with this program; if not you can get it here
+*  <A HREF="http://www.jpaulmorrison.com/fbp/artistic2.htm.">http://www.jpaulmorrison.com/fbp/artistic2.htm.</A>
+*/
+#include &quot;stdinc.h&quot; //precompiled header
+
+#include &quot;GameEventLog.h&quot;
+#include &quot;MessagePump.h&quot;
+#include &quot;RulesMessages.h&quot;
+
+using namespace Ogre;
+
+template&lt;&gt; rl::GameEventLog* Singleton&lt;rl::GameEventLog&gt;::ms_Singleton = 0;
+
+namespace rl {
+
+	GameEventLog::GameEventLog() : mLog(), mLogSize(100)
+	{
+	}
+
+	void GameEventLog::setEventQueueLength(size_t length)
+	{
+		mLogSize = length;
+		while (mLog.size() &gt; mLogSize) mLog.pop_front();
+	}
+
+	size_t GameEventLog::getEventQueueLength() const
+	{
+		return mLogSize;
+	}
+
+	void GameEventLog::logEvent(const String&amp; eventString, GameEventType type)
+	{
+		mLog.push_back(std::make_pair(type, eventString));
+        MessagePump::getSingleton().sendMessage&lt;MessageType_GameEventLog_EventAdded&gt;(type, eventString);
+		while (mLog.size() &gt; mLogSize) mLog.pop_front();
+	}
+}

Modified: rl/trunk/engine/rules/src/RulesSubsystem.cpp
===================================================================
--- rl/trunk/engine/rules/src/RulesSubsystem.cpp	2008-02-20 21:30:25 UTC (rev 4070)
+++ rl/trunk/engine/rules/src/RulesSubsystem.cpp	2008-02-20 21:34:04 UTC (rev 4071)
@@ -19,9 +19,9 @@
 #include &quot;ActionManager.h&quot;
 #include &quot;CombatManager.h&quot;
 #include &quot;DsaManager.h&quot;
-//#include &quot;XdimlLoader.h&quot;
 #include &quot;DsaDataLoader.h&quot;
 #include &quot;EffectFactory.h&quot;
+#include &quot;GameEventLog.h&quot;
 #include &quot;Logger.h&quot;
 #include &quot;CreatureControllerManager.h&quot;
 #include &quot;GameObjectManager.h&quot;
@@ -38,6 +38,7 @@
         mActionManager(NULL),
         mCombatManager(NULL),
         mDsaManager(NULL),
+		mGameEventLog(NULL),
         mMovingCreatureManager(NULL),
         mXdimlLoader(NULL)
     {
@@ -55,6 +56,8 @@
 		LOG_MESSAGE(Logger::RULES, &quot;CombatManager erzeugt&quot;);
         mDsaManager = new DsaManager();
 		LOG_MESSAGE(Logger::RULES, &quot;DsaManager erzeugt&quot;);
+        mGameEventLog = new GameEventLog();
+		LOG_MESSAGE(Logger::RULES, &quot;GameEventLog erzeugt&quot;);
         mMovingCreatureManager = new CreatureControllerManager();
 		LOG_MESSAGE(Logger::RULES, &quot;CreatureControllerManager erzeugt&quot;);
 		resetQuestBook();
@@ -72,6 +75,7 @@
 	RulesSubsystem::~RulesSubsystem()
     {
         delete mQuestBook;
+		delete mGameEventLog;
         delete mDsaManager;
         delete mCombatManager;
         delete mActionManager;

Modified: rl/trunk/engine/script/swig/RlRules.head.swig
===================================================================
--- rl/trunk/engine/script/swig/RlRules.head.swig	2008-02-20 21:30:25 UTC (rev 4070)
+++ rl/trunk/engine/script/swig/RlRules.head.swig	2008-02-20 21:34:04 UTC (rev 4071)
@@ -31,6 +31,7 @@
 #include &quot;Effect.h&quot;
 #include &quot;EffectFactory.h&quot;
 #include &quot;EigenschaftenStateSet.h&quot;
+#include &quot;GameEventLog.h&quot;
 #include &quot;GameObject.h&quot;
 #include &quot;GameObjectManager.h&quot;
 #include &quot;Inventory.h&quot;

Modified: rl/trunk/engine/script/swig/RlRules.swig
===================================================================
--- rl/trunk/engine/script/swig/RlRules.swig	2008-02-20 21:30:25 UTC (rev 4070)
+++ rl/trunk/engine/script/swig/RlRules.swig	2008-02-20 21:34:04 UTC (rev 4071)
@@ -130,7 +130,24 @@
         GameObjectManager();
     };
 
+	enum GameEventType
+	{
+		GET_DEFAULT,
+		GET_COMBAT,
+		GET_DIALOG,
+		GET_QUEST
+	};
+	
+    class GameEventLog
+    {
+    public:
+        static rl::GameEventLog&amp; getSingleton();
+		void logEvent(const Ogre::String&amp; eventString, GameEventType type);
 
+    private:
+        GameEventLog();
+    };
+
     %feature(&quot;director&quot;) QuestListener; 
     class QuestListener
     {

Modified: rl/trunk/engine/script/swig/RlUi.head.swig
===================================================================
--- rl/trunk/engine/script/swig/RlUi.head.swig	2008-02-20 21:30:25 UTC (rev 4070)
+++ rl/trunk/engine/script/swig/RlUi.head.swig	2008-02-20 21:34:04 UTC (rev 4071)
@@ -21,10 +21,9 @@
 #include &quot;ControlState.h&quot;
 #include &quot;CommandMapper.h&quot;
 #include &quot;CutsceneControlState.h&quot;
-#include &quot;GameLoggerWindow.h&quot;
 #include &quot;InputManager.h&quot;
 #include &quot;UiPrerequisites.h&quot;
 #include &quot;UiSubsystem.h&quot;
 #include &quot;WindowFactory.h&quot;
 #include &quot;WindowManager.h&quot;
-%}
\ No newline at end of file
+%}

Modified: rl/trunk/engine/script/swig/RlUi.swig
===================================================================
--- rl/trunk/engine/script/swig/RlUi.swig	2008-02-20 21:30:25 UTC (rev 4070)
+++ rl/trunk/engine/script/swig/RlUi.swig	2008-02-20 21:34:04 UTC (rev 4071)
@@ -72,15 +72,6 @@
     InputManager();
 };
 
-class GameLoggerWindow
-{
-public:
-    void logDialogEvent(const rl::CeGuiString&amp; speaker, const rl::CeGuiString&amp; text);
-    void logFightEvent(const rl::CeGuiString&amp; text);
-    void logCharacterEvent(const rl::CeGuiString&amp; text);
-    void logMiscEvent(const rl::CeGuiString&amp; text);
-};
-
 class WindowFactory
 {
 public:

Modified: rl/trunk/engine/ui/RlUI2005.vcproj
===================================================================
--- rl/trunk/engine/ui/RlUI2005.vcproj	2008-02-20 21:30:25 UTC (rev 4070)
+++ rl/trunk/engine/ui/RlUI2005.vcproj	2008-02-20 21:34:04 UTC (rev 4071)
@@ -1,7 +1,7 @@
 &lt;?xml version=&quot;1.0&quot; encoding=&quot;Windows-1252&quot;?&gt;
 &lt;VisualStudioProject
 	ProjectType=&quot;Visual C++&quot;
-	Version=&quot;8,00&quot;
+	Version=&quot;8.00&quot;
 	Name=&quot;RlUI&quot;
 	ProjectGUID=&quot;{53FE20F3-E726-44FE-BBEC-D29CAE210D25}&quot;
 	RootNamespace=&quot;RlUI&quot;
@@ -353,6 +353,10 @@
 				&gt;
 			&lt;/File&gt;
 			&lt;File
+				RelativePath=&quot;.\include\CombatGui.h&quot;
+				&gt;
+			&lt;/File&gt;
+			&lt;File
 				RelativePath=&quot;.\include\CommandMapper.h&quot;
 				&gt;
 			&lt;/File&gt;
@@ -566,6 +570,10 @@
 				&gt;
 			&lt;/File&gt;
 			&lt;File
+				RelativePath=&quot;.\src\CombatGui.cpp&quot;
+				&gt;
+			&lt;/File&gt;
+			&lt;File
 				RelativePath=&quot;.\src\CommandMapper.cpp&quot;
 				&gt;
 			&lt;/File&gt;

Modified: rl/trunk/engine/ui/include/CombatControlState.h
===================================================================
--- rl/trunk/engine/ui/include/CombatControlState.h	2008-02-20 21:30:25 UTC (rev 4070)
+++ rl/trunk/engine/ui/include/CombatControlState.h	2008-02-20 21:34:04 UTC (rev 4071)
@@ -29,8 +29,8 @@
 
 	class CameraObject;
     class Combat;
+    class CombatGui;
     class CombatManager;
-    class CombatWindow;
 
 	class _RlUiExport CombatControlState : public ControlState, public Combatant
 	{
@@ -38,30 +38,28 @@
 		/**
 		*  @throw NullPointerException if camera is NULL.
 		*/
-		CombatControlState(CommandMapper* cmdMapper, Actor* camera, Person* character);
+		CombatControlState(CommandMapper* cmdMapper, Actor* camera, Person* character, Combat* combat);
 		virtual ~CombatControlState();
 
+		// Control state overrides
+
         virtual void pause();
         virtual void resume();
 
 		void run(Ogre::Real elapsedTime);
 
-        // Combatant override
+        // Combatant overrides
+
         virtual Ogre::String getCombatantTypeName() const;
+        virtual void requestCombatantAction();
 
     private:
         CombatManager* mCombatManager;
-        // Current combat that is controlled.
-        Combat* mCombat;
-        CombatWindow* mCombatWindow;
+		CombatGui* mCombatGui;
         HalfSphereSelector mEnemySelector;
 
         CameraObject* mCamera;
 
-        /// Little Helper-MO for visualisation for everything that is difficult with cegui.
-        Ogre::ManualObject* mHud;
-
-        Ogre::Rectangle getScreenRectFromWorldAABB(const Ogre::AxisAlignedBox&amp; aabb) const;
 	};
 }
 #endif

Added: rl/trunk/engine/ui/include/CombatGui.h
===================================================================
--- rl/trunk/engine/ui/include/CombatGui.h	2008-02-20 21:30:25 UTC (rev 4070)
+++ rl/trunk/engine/ui/include/CombatGui.h	2008-02-20 21:34:04 UTC (rev 4071)
@@ -0,0 +1,52 @@
+/* This source file is part of Rastullahs Lockenpracht.
+ * Copyright (C) 2003-2007 Team Pantheon. <A HREF="http://www.team-pantheon.de">http://www.team-pantheon.de</A>
+ * 
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the Clarified Artistic License.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  Clarified Artistic License for more details.
+ *
+ *  You should have received a copy of the Clarified Artistic License
+ *  along with this program; if not you can get it here
+ *  <A HREF="http://www.jpaulmorrison.com/fbp/artistic2.htm.">http://www.jpaulmorrison.com/fbp/artistic2.htm.</A>
+ */
+
+#ifndef __CombatGui_H__
+#define __CombatGui_H__
+
+#include &quot;UiPrerequisites.h&quot;
+
+#include &quot;CameraObject.h&quot;
+#include &quot;Combat.h&quot;
+#include &quot;CombatWindow.h&quot;
+
+namespace rl {
+	
+	/// GUI for user control of combat.
+	/// Handles all graphical combat visualisation.
+	class _RlUiExport CombatGui
+	{
+	public:
+		CombatGui(Combat*, CameraObject* mCamera);
+		virtual ~CombatGui();
+
+		void update();
+
+		void show();
+		void hide();
+
+	private:
+		CombatWindow* mCombatWindow;
+		Combat* mCombat;
+		CameraObject* mCamera;
+        /// Little Helper-MO for visualisation for everything that is difficult with cegui.
+        Ogre::ManualObject* mHud;
+
+        Ogre::Rectangle getScreenRectFromWorldAabb(const Ogre::AxisAlignedBox&amp; aabb) const;
+	};
+}
+
+#endif

Modified: rl/trunk/engine/ui/include/CombatWindow.h
===================================================================
--- rl/trunk/engine/ui/include/CombatWindow.h	2008-02-20 21:30:25 UTC (rev 4070)
+++ rl/trunk/engine/ui/include/CombatWindow.h	2008-02-20 21:34:04 UTC (rev 4071)
@@ -22,6 +22,8 @@
 
 namespace rl {
 	
+	/// Wraps all cegui gui aspects of the combat gui and is
+	/// controlled by CombatGui class.
 	class _RlUiExport CombatWindow : public AbstractWindow
 	{
 	public:

Modified: rl/trunk/engine/ui/include/GameLoggerWindow.h
===================================================================
--- rl/trunk/engine/ui/include/GameLoggerWindow.h	2008-02-20 21:30:25 UTC (rev 4070)
+++ rl/trunk/engine/ui/include/GameLoggerWindow.h	2008-02-20 21:34:04 UTC (rev 4071)
@@ -20,6 +20,8 @@
 #include &quot;UiPrerequisites.h&quot;
 
 #include &quot;AbstractWindow.h&quot;
+#include &quot;MessagePump.h&quot;
+#include &quot;RulesConstants.h&quot;
 
 namespace rl {
 
@@ -28,23 +30,20 @@
 	public:
 		GameLoggerWindow();
 
-		void logDialogEvent(const CeGuiString&amp; speaker, const CeGuiString&amp; text);
-		void logFightEvent(const CeGuiString&amp; text);
-		void logCharacterEvent(const CeGuiString&amp; text);
-		void logMiscEvent(const CeGuiString&amp; text);
+		/// Message handler for RLMSG_GAMEEVENTLOG_EVENT_ADDED
+		bool onLogEntryAdded(GameEventType evt, const Ogre::String&amp; msg);
 
-		static CEGUI::colour COLOR_FIGHT;
+	private:
+		static CEGUI::colour COLOR_DEFAULT;
+		static CEGUI::colour COLOR_COMBAT;
 		static CEGUI::colour COLOR_DIALOG;
-		static CEGUI::colour COLOR_MISC;
-		static CEGUI::colour COLOR_CHARACTER;
+		static CEGUI::colour COLOR_QUEST;
 
-	private:
-		void logEvent(const CeGuiString&amp; text, const CEGUI::colour color);
-
+	    MessagePump::ScopedConnection mLogEntryAddedConnection;
 		CEGUI::Listbox* mLog;
-	};
 
-
+		void logEvent(const CeGuiString&amp; text, const CEGUI::colour color);
+	};
 }
 
 #endif

Modified: rl/trunk/engine/ui/src/CombatControlState.cpp
===================================================================
--- rl/trunk/engine/ui/src/CombatControlState.cpp	2008-02-20 21:30:25 UTC (rev 4070)
+++ rl/trunk/engine/ui/src/CombatControlState.cpp	2008-02-20 21:34:04 UTC (rev 4071)
@@ -20,8 +20,8 @@
 #include &quot;Actor.h&quot;
 #include &quot;CameraObject.h&quot;
 #include &quot;Combat.h&quot;
+#include &quot;CombatGui.h&quot;
 #include &quot;CombatManager.h&quot;
-#include &quot;CombatWindow.h&quot;
 #include &quot;CoreSubsystem.h&quot;
 #include &quot;Creature.h&quot;
 #include &quot;CreatureController.h&quot;
@@ -31,7 +31,6 @@
 #include &quot;Person.h&quot;
 #include &quot;PhysicalThing.h&quot;
 #include &quot;Selector.h&quot;
-#include &quot;WindowFactory.h&quot;
 #include &quot;World.h&quot;
 
 #include &lt;OgreManualObject.h&gt;
@@ -39,12 +38,11 @@
 
 namespace rl {
     CombatControlState::CombatControlState(CommandMapper* cmdMapper,
-        Actor* camera, Person* character)
+        Actor* camera, Person* character, Combat* combat)
         : ControlState(cmdMapper, camera, character, CST_COMBAT),
-          Combatant(CreatureControllerManager::getSingleton().getCreatureController(character)),
+          Combatant(combat, CreatureControllerManager::getSingleton().getCreatureController(character)),
           mCombatManager(CombatManager::getSingletonPtr()),
-          mCombat(NULL),
-          mCombatWindow(NULL),
+		  mCombatGui(NULL),
           mEnemySelector(CoreSubsystem::getSingleton().getWorld()-&gt;getSceneManager(),
             QUERYFLAG_CREATURE),
           mCamera(NULL)
@@ -53,23 +51,13 @@
         filter-&gt;setAlignmentMask(Creature::ALIGNMENT_ENEMY);
         mEnemySelector.setFilter(filter);
 
-        mCombatWindow = WindowFactory::getSingleton().getCombatWindow();
         mCamera = static_cast&lt;CameraObject*&gt;(mCameraActor-&gt;getControlledObject());
-
-        // Initialise HUD-MO. Put it into 2D mode and make sure it is always rendered.
-        SceneManager* sceneMgr = CoreSubsystem::getSingleton().getWorld()-&gt;getSceneManager();
-        mHud = sceneMgr-&gt;createManualObject(&quot;__COMBAT_HUD__&quot;);
-        mHud-&gt;setUseIdentityProjection(true);
-        mHud-&gt;setUseIdentityView(true);
-        AxisAlignedBox infiniteAabb;
-        infiniteAabb.setInfinite();
-        mHud-&gt;setBoundingBox(infiniteAabb);
-        mHud-&gt;setRenderQueueGroup(RENDER_QUEUE_OVERLAY);
-        sceneMgr-&gt;getRootSceneNode()-&gt;createChildSceneNode()-&gt;attachObject(mHud);
+		mCombatGui = new CombatGui(mCombat, mCamera);
     }
 
 	CombatControlState::~CombatControlState()
     {
+		delete mCombatGui;
         delete mEnemySelector.getFilter();
     }
 
@@ -87,45 +75,36 @@
         mEnemySelector.track(mCharacter);
         mEnemySelector.setRadius(10.0);
 
-        // Is there a combat running already?
-        if (mCombatManager-&gt;getCurrentCombat() != NULL)
+        mEnemySelector.updateSelection();
+        const Selector::GameObjectVector&amp; enemies = mEnemySelector.getAllSelectedObjects();
+        if (!enemies.empty())
         {
-            // Yes. Set this one as active.
-            mCombat = mCombatManager-&gt;getCurrentCombat();
+            for (size_t i = 0; i &lt; enemies.size(); ++i)
+            {
+                Combatant* opponent = mCombatManager-&gt;createCombatant(
+                    static_cast&lt;Creature*&gt;(enemies[i]));
+                mCombat-&gt;addOpponent(opponent);
+            }
         }
         else
         {
-            // No. Test, if we can start one.
-            mEnemySelector.updateSelection();
-            const Selector::GameObjectVector&amp; enemies = mEnemySelector.getAllSelectedObjects();
-            if (!enemies.empty())
-            {
-                Combatant* firstOpponent = mCombatManager-&gt;createCombatant(
-                    static_cast&lt;Creature*&gt;(enemies[0]));
-                // There are enemies in vicinity, so start a new combat and set it up properly.
-                mCombat = mCombatManager-&gt;startCombat(this, firstOpponent);
-                for (size_t i = 1; i &lt; enemies.size(); ++i)
-                {
-                    Combatant* opponent = mCombatManager-&gt;createCombatant(
-                        static_cast&lt;Creature*&gt;(enemies[i]));
-                    mCombat-&gt;addOpponent(opponent);
-                }
-            }
-            else
-            {
-                // Oops. Nothing to fight. Pop self.
-                InputManager::getSingleton().popControlState();
-                return;
-            }
+            // Oops. Nothing to fight. Pop self.
+            InputManager::getSingleton().popControlState();
+            return;
         }
-        mCombatWindow-&gt;setVisible(true);
 
+		mCombatGui-&gt;show();
+
+
+        // We want to play too..
+        mCombat-&gt;addAlly(this);
+
         mCombat-&gt;start();
     }
 
     void CombatControlState::pause()
     {
-        mCombatWindow-&gt;setVisible(false);
+		mCombatGui-&gt;hide();
 
         mCameraActor-&gt;getPhysicalThing()-&gt;unfreeze();
         mCharacterActor-&gt;getPhysicalThing()-&gt;unfreeze();
@@ -138,56 +117,15 @@
 
 	void CombatControlState::run(Ogre::Real elapsedTime)
     {
-        // HUD aktualisieren.
-        mHud-&gt;clear();
-
-        mHud-&gt;begin(&quot;BaseWhiteNoLighting&quot;, RenderOperation::OT_LINE_STRIP);
-        const Combat::CombatantSet&amp; opponents = mCombat-&gt;getAllOpponents();
-        for (Combat::CombatantSet::const_iterator it = opponents.begin(), end = opponents.end();
-            it != end; ++it)
-        {
-            Ogre::Rectangle rec = getScreenRectFromWorldAABB(
-                (*it)-&gt;getCreatureController()-&gt;getCreature()-&gt;getActor()
-                    -&gt;_getSceneNode()-&gt;_getWorldAABB());
-            mHud-&gt;position(rec.left,  rec.top,    0.0f);
-            mHud-&gt;position(rec.left,  rec.bottom, 0.0f);
-            mHud-&gt;position(rec.right, rec.top,    0.0f);
-            mHud-&gt;position(rec.right, rec.bottom, 0.0f);
-
-            mHud-&gt;index(0);
-            mHud-&gt;index(1);
-            mHud-&gt;index(3);
-            mHud-&gt;index(2);
-            mHud-&gt;index(0);
-        }
-        mHud-&gt;end();
     }
 
-    Ogre::Rectangle CombatControlState::getScreenRectFromWorldAABB(
-        const AxisAlignedBox&amp; aabb) const
+    Ogre::String CombatControlState::getCombatantTypeName() const
     {
-        // Initialise each to the value of the opposite side, so that min/max work smoothly.
-        Real left = 1.0f, bottom = 1.0f, right = -1.0f, top = -1.0f;
-
-        // Determine screen pos of all corners and widen the rect if needed
-        const Vector3* corners = aabb.getAllCorners();
-        for (size_t i = 0; i &lt; 8; ++i)
-        {
-			Vector3 screenSpacePos = mCamera-&gt;getPointOnScreen(corners[i]);
-            if (screenSpacePos.z &gt; 0) continue; // Behind camera
-
-            left   = std::min(left,   screenSpacePos.x);
-            right  = std::max(right,  screenSpacePos.x);
-            bottom = std::min(bottom, screenSpacePos.y);
-            top    = std::max(top,    screenSpacePos.y);
-        }
-
-        Ogre::Rectangle rval = {left,top, right, bottom};
-        return rval;
+        return &quot;CombatControlState&quot;;
     }
 
-    Ogre::String CombatControlState::getCombatantTypeName() const
+    void CombatControlState::requestCombatantAction()
     {
-        return &quot;CombatControlState&quot;;
+        // Change state to allow user to choose actions for next round.
     }
 }

Added: rl/trunk/engine/ui/src/CombatGui.cpp
===================================================================
--- rl/trunk/engine/ui/src/CombatGui.cpp	2008-02-20 21:30:25 UTC (rev 4070)
+++ rl/trunk/engine/ui/src/CombatGui.cpp	2008-02-20 21:34:04 UTC (rev 4071)
@@ -0,0 +1,116 @@
+/* This source file is part of Rastullahs Lockenpracht.
+ * Copyright (C) 2003-2007 Team Pantheon. <A HREF="http://www.team-pantheon.de">http://www.team-pantheon.de</A>
+ *
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the Clarified Artistic License.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  Clarified Artistic License for more details.
+ *
+ *  You should have received a copy of the Clarified Artistic License
+ *  along with this program; if not you can get it here
+ *  <A HREF="http://www.jpaulmorrison.com/fbp/artistic2.htm.">http://www.jpaulmorrison.com/fbp/artistic2.htm.</A>
+ */
+#include &quot;stdinc.h&quot; //precompiled header
+
+#include &quot;CombatGui.h&quot;
+
+#include &quot;Combatant.h&quot;
+#include &quot;CoreSubsystem.h&quot;
+#include &quot;CreatureController.h&quot;
+#include &quot;CreatureControllerManager.h&quot;
+#include &quot;WindowFactory.h&quot;
+#include &quot;World.h&quot;
+
+using namespace Ogre;
+
+namespace rl {
+
+	CombatGui::CombatGui(Combat* combat, CameraObject* camera)
+		: mCombatWindow(NULL),
+		  mCombat(combat),
+		  mCamera(camera)
+    {
+        mCombatWindow = WindowFactory::getSingleton().getCombatWindow();
+
+        // Initialise HUD-MO. Put it into 2D mode and make sure it is always rendered.
+        SceneManager* sceneMgr = CoreSubsystem::getSingleton().getWorld()-&gt;getSceneManager();
+        mHud = sceneMgr-&gt;createManualObject(&quot;__COMBAT_HUD__&quot;);
+        mHud-&gt;setUseIdentityProjection(true);
+        mHud-&gt;setUseIdentityView(true);
+        AxisAlignedBox infiniteAabb;
+        infiniteAabb.setInfinite();
+        mHud-&gt;setBoundingBox(infiniteAabb);
+        mHud-&gt;setRenderQueueGroup(RENDER_QUEUE_OVERLAY);
+        sceneMgr-&gt;getRootSceneNode()-&gt;createChildSceneNode()-&gt;attachObject(mHud);
+	}
+
+	CombatGui::~CombatGui()
+	{
+		hide();
+        SceneManager* sceneMgr = CoreSubsystem::getSingleton().getWorld()-&gt;getSceneManager();
+		sceneMgr-&gt;destroyManualObject(mHud);
+	}
+
+	void CombatGui::update()
+	{
+        // update HUD
+        mHud-&gt;clear();
+
+        mHud-&gt;begin(&quot;BaseWhiteNoLighting&quot;, RenderOperation::OT_LINE_STRIP);
+        const Combat::CombatantSet&amp; opponents = mCombat-&gt;getAllOpponents();
+        for (Combat::CombatantSet::const_iterator it = opponents.begin(), end = opponents.end();
+            it != end; ++it)
+        {
+            Ogre::Rectangle rec = getScreenRectFromWorldAabb(
+                (*it)-&gt;getCreatureController()-&gt;getCreature()-&gt;getActor()
+                    -&gt;_getSceneNode()-&gt;_getWorldAABB());
+            mHud-&gt;position(rec.left,  rec.top,    0.0f);
+            mHud-&gt;position(rec.left,  rec.bottom, 0.0f);
+            mHud-&gt;position(rec.right, rec.top,    0.0f);
+            mHud-&gt;position(rec.right, rec.bottom, 0.0f);
+
+            mHud-&gt;index(0);
+            mHud-&gt;index(1);
+            mHud-&gt;index(3);
+            mHud-&gt;index(2);
+            mHud-&gt;index(0);
+        }
+        mHud-&gt;end();
+	}
+
+	void CombatGui::show()
+	{
+        mCombatWindow-&gt;setVisible(true);
+	}
+
+	void CombatGui::hide()
+	{
+        mCombatWindow-&gt;setVisible(false);
+	}
+
+    Ogre::Rectangle CombatGui::getScreenRectFromWorldAabb(
+        const AxisAlignedBox&amp; aabb) const
+    {
+        // Initialise each to the value of the opposite side, so that min/max work smoothly.
+        Real left = 1.0f, bottom = 1.0f, right = -1.0f, top = -1.0f;
+
+        // Determine screen pos of all corners and widen the rect if needed
+        const Vector3* corners = aabb.getAllCorners();
+        for (size_t i = 0; i &lt; 8; ++i)
+        {
+			Vector3 screenSpacePos = mCamera-&gt;getPointOnScreen(corners[i]);
+            if (screenSpacePos.z &gt; 0) continue; // Behind camera
+
+            left   = std::min(left,   screenSpacePos.x);
+            right  = std::max(right,  screenSpacePos.x);
+            bottom = std::min(bottom, screenSpacePos.y);
+            top    = std::max(top,    screenSpacePos.y);
+        }
+
+        Ogre::Rectangle rval = {left, top, right, bottom};
+        return rval;
+    }
+}

Modified: rl/trunk/engine/ui/src/CombatWindow.cpp
===================================================================
--- rl/trunk/engine/ui/src/CombatWindow.cpp	2008-02-20 21:30:25 UTC (rev 4070)
+++ rl/trunk/engine/ui/src/CombatWindow.cpp	2008-02-20 21:34:04 UTC (rev 4071)
@@ -23,7 +23,7 @@
 
 namespace rl {
 
-    CombatWindow::CombatWindow() : AbstractWindow(&quot;combatwindow.xml&quot;, WIT_NONE)
+    CombatWindow::CombatWindow() : AbstractWindow(&quot;combatwindow.xml&quot;, WIT_NONE, false)
     {
     }
 

Modified: rl/trunk/engine/ui/src/GameLoggerWindow.cpp
===================================================================
--- rl/trunk/engine/ui/src/GameLoggerWindow.cpp	2008-02-20 21:30:25 UTC (rev 4070)
+++ rl/trunk/engine/ui/src/GameLoggerWindow.cpp	2008-02-20 21:34:04 UTC (rev 4071)
@@ -1,65 +1,58 @@
 /* This source file is part of Rastullahs Lockenpracht.
- * Copyright (C) 2003-2007 Team Pantheon. <A HREF="http://www.team-pantheon.de">http://www.team-pantheon.de</A>
- *
- *  This program is free software; you can redistribute it and/or modify
- *  it under the terms of the Clarified Artistic License.
- *
- *  This program is distributed in the hope that it will be useful,
- *  but WITHOUT ANY WARRANTY; without even the implied warranty of
- *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
- *  Clarified Artistic License for more details.
- *
- *  You should have received a copy of the Clarified Artistic License
- *  along with this program; if not you can get it here
- *  <A HREF="http://www.jpaulmorrison.com/fbp/artistic2.htm.">http://www.jpaulmorrison.com/fbp/artistic2.htm.</A>
- */
+* Copyright (C) 2003-2007 Team Pantheon. <A HREF="http://www.team-pantheon.de">http://www.team-pantheon.de</A>
+*
+*  This program is free software; you can redistribute it and/or modify
+*  it under the terms of the Clarified Artistic License.
+*
+*  This program is distributed in the hope that it will be useful,
+*  but WITHOUT ANY WARRANTY; without even the implied warranty of
+*  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+*  Clarified Artistic License for more details.
+*
+*  You should have received a copy of the Clarified Artistic License
+*  along with this program; if not you can get it here
+*  <A HREF="http://www.jpaulmorrison.com/fbp/artistic2.htm.">http://www.jpaulmorrison.com/fbp/artistic2.htm.</A>
+*/
 #include &quot;stdinc.h&quot; //precompiled header
 
-#include &quot;UiPrerequisites.h&quot;
+#include &quot;GameLoggerWindow.h&quot;
 
 #include &quot;Creature.h&quot;
-#include &quot;GameLoggerWindow.h&quot;
+#include &quot;GameEventLog.h&quot;
 #include &quot;ListboxWrappedTextItem.h&quot;
+#include &quot;RulesMessages.h&quot;
 
 namespace rl {
 
-CEGUI::colour GameLoggerWindow::COLOR_CHARACTER( 0xFFFF7F7F);
-CEGUI::colour GameLoggerWindow::COLOR_DIALOG(    0xFFFF7FFF);
-CEGUI::colour GameLoggerWindow::COLOR_FIGHT(     0xFFFFFF7F);
-CEGUI::colour GameLoggerWindow::COLOR_MISC(      0xFFFFFFFF);
+	CEGUI::colour GameLoggerWindow::COLOR_QUEST(     0xFFFF7F7F);
+	CEGUI::colour GameLoggerWindow::COLOR_COMBAT(    0xFFFFFF7F);
+	CEGUI::colour GameLoggerWindow::COLOR_DIALOG(    0xFFFF7FFF);
+	CEGUI::colour GameLoggerWindow::COLOR_DEFAULT(   0xFFFFFFFF);
 
-GameLoggerWindow::GameLoggerWindow() :
-	AbstractWindow(&quot;gameloggerwindow.xml&quot;, WIT_NONE)
-{
-	mLog = getListbox (&quot;GameLogger/Log&quot;);
-	bindDestroyWindowToXButton();
-}
+	GameLoggerWindow::GameLoggerWindow()
+		: AbstractWindow(&quot;gameloggerwindow.xml&quot;, WIT_NONE),
+		  mLogEntryAddedConnection(),
+		  mLog(NULL)
+	{
+		mLog = getListbox (&quot;GameLogger/Log&quot;);
+		mLogEntryAddedConnection = 
+            MessagePump::getSingleton().addMessageHandler&lt;MessageType_GameEventLog_EventAdded&gt;(
+			    boost::bind(&amp;GameLoggerWindow::onLogEntryAdded, this, _1, _2));
+	}
 
-void GameLoggerWindow::logEvent(const CeGuiString&amp; text, const CEGUI::colour color)
-{
-	CEGUI::ListboxWrappedTextItem* item = new CEGUI::ListboxWrappedTextItem(text);
-	item-&gt;setTextColours(color);
-	mLog-&gt;insertItem(item, NULL);
-}
+	bool GameLoggerWindow::onLogEntryAdded(GameEventType evt, const Ogre::String&amp; text)
+	{
+		CEGUI::colour col = evt == GET_QUEST ? COLOR_QUEST :
+			evt == GET_COMBAT ? COLOR_COMBAT :
+			evt == GET_DIALOG ? COLOR_DIALOG : COLOR_DEFAULT;
+		logEvent(text, col);
+		return true;
+	}
 
-void GameLoggerWindow::logDialogEvent(const CeGuiString&amp; speaker, const CeGuiString&amp; text)
-{
-	logEvent(speaker+&quot;: '&quot;+text+&quot;'&quot;, COLOR_DIALOG);
+	void GameLoggerWindow::logEvent(const CeGuiString&amp; text, const CEGUI::colour color)
+	{
+		CEGUI::ListboxWrappedTextItem* item = new CEGUI::ListboxWrappedTextItem(text);
+		item-&gt;setTextColours(color);
+		mLog-&gt;addItem(item);
+	}
 }
-
-void GameLoggerWindow::logFightEvent(const CeGuiString&amp; text)
-{
-	logEvent(text, COLOR_FIGHT);
-}
-
-void GameLoggerWindow::logCharacterEvent(const CeGuiString&amp; text)
-{
-	logEvent(text, COLOR_CHARACTER);
-}
-
-void GameLoggerWindow::logMiscEvent(const CeGuiString&amp; text)
-{
-	logEvent(text, COLOR_MISC);
-}
-
-}

Modified: rl/trunk/engine/ui/src/InputManager.cpp
===================================================================
--- rl/trunk/engine/ui/src/InputManager.cpp	2008-02-20 21:30:25 UTC (rev 4070)
+++ rl/trunk/engine/ui/src/InputManager.cpp	2008-02-20 21:34:04 UTC (rev 4071)
@@ -33,6 +33,7 @@
 #include &quot;AiMessages.h&quot;
 #include &quot;ControlState.h&quot;
 #include &quot;CombatControlState.h&quot;
+#include &quot;CombatManager.h&quot;
 #include &quot;CommandMapper.h&quot;
 #include &quot;ConfigurationManager.h&quot;
 #include &quot;Console.h&quot;
@@ -398,7 +399,10 @@
             controller = new DialogControlState(mCommandMapper, camera, character);
             break;
         case CST_COMBAT:
-            controller = new CombatControlState(mCommandMapper, camera, character);
+            {
+                Combat* combat = CombatManager::getSingleton().startCombat();
+                controller = new CombatControlState(mCommandMapper, camera, character, combat);
+            }
             break;
         default:
             Throw(IllegalStateException, &quot;Unknown controller type.&quot;);


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001141.html">[Dsa-hl-svn] r4070 - modules/combattest/dsa
</A></li>
	<LI>Next message: <A HREF="001143.html">[Dsa-hl-svn] r4072 - in modules: regressiontest/dsa techdemo2/dsa
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1142">[ date ]</a>
              <a href="thread.html#1142">[ thread ]</a>
              <a href="subject.html#1142">[ subject ]</a>
              <a href="author.html#1142">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/dsa-hl-svn">More information about the Dsa-hl-svn
mailing list</a><br>
</body></html>
