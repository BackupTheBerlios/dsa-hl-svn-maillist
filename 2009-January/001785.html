<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Dsa-hl-svn] r4728 - in dependencies/OgreNewt_ngt: . inc src
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/dsa-hl-svn/2009-January/index.html" >
   <LINK REL="made" HREF="mailto:dsa-hl-svn%40lists.berlios.de?Subject=Re%3A%20%5BDsa-hl-svn%5D%20r4728%20-%20in%20dependencies/OgreNewt_ngt%3A%20.%20inc%20src&In-Reply-To=%3C200901302213.n0UMDciL029937%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001784.html">
   <LINK REL="Next"  HREF="001786.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Dsa-hl-svn] r4728 - in dependencies/OgreNewt_ngt: . inc src</H1>
    <B>melven at mail.berlios.de</B> 
    <A HREF="mailto:dsa-hl-svn%40lists.berlios.de?Subject=Re%3A%20%5BDsa-hl-svn%5D%20r4728%20-%20in%20dependencies/OgreNewt_ngt%3A%20.%20inc%20src&In-Reply-To=%3C200901302213.n0UMDciL029937%40sheep.berlios.de%3E"
       TITLE="[Dsa-hl-svn] r4728 - in dependencies/OgreNewt_ngt: . inc src">melven at mail.berlios.de
       </A><BR>
    <I>Fri Jan 30 23:13:38 CET 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="001784.html">[Dsa-hl-svn] r4727 - in rl/branches/persistence: ai common	common/include core core/include core/include/fmod4driver	core/src core/src/fmod4driver rules script ui ui/include ui/src
</A></li>
        <LI>Next message: <A HREF="001786.html">[Dsa-hl-svn] r4729 - in dependencies/OgreNewt_ngt: . inc src
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1785">[ date ]</a>
              <a href="thread.html#1785">[ thread ]</a>
              <a href="subject.html#1785">[ subject ]</a>
              <a href="author.html#1785">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: melven
Date: 2009-01-30 23:13:30 +0100 (Fri, 30 Jan 2009)
New Revision: 4728

Added:
   dependencies/OgreNewt_ngt/inc/OgreNewt_BodyInAABBIterator.h
   dependencies/OgreNewt_ngt/inc/OgreNewt_ContactJoint.h
   dependencies/OgreNewt_ngt/src/OgreNewt_ContactJoint.cpp
Removed:
   dependencies/OgreNewt_ngt/inc/OgreNewt_BodyIterator.h
   dependencies/OgreNewt_ngt/src/OgreNewt_ContactCallback.cpp
Modified:
   dependencies/OgreNewt_ngt/CMakeLists.txt
   dependencies/OgreNewt_ngt/inc/OgreNewt.h
   dependencies/OgreNewt_ngt/inc/OgreNewt_BasicFrameListener.h
   dependencies/OgreNewt_ngt/inc/OgreNewt_BasicJoints.h
   dependencies/OgreNewt_ngt/inc/OgreNewt_Body.h
   dependencies/OgreNewt_ngt/inc/OgreNewt_Collision.h
   dependencies/OgreNewt_ngt/inc/OgreNewt_CollisionPrimitives.h
   dependencies/OgreNewt_ngt/inc/OgreNewt_CollisionSerializer.h
   dependencies/OgreNewt_ngt/inc/OgreNewt_ContactCallback.h
   dependencies/OgreNewt_ngt/inc/OgreNewt_Debugger.h
   dependencies/OgreNewt_ngt/inc/OgreNewt_Joint.h
   dependencies/OgreNewt_ngt/inc/OgreNewt_MaterialID.h
   dependencies/OgreNewt_ngt/inc/OgreNewt_MaterialPair.h
   dependencies/OgreNewt_ngt/inc/OgreNewt_PlayerController.h
   dependencies/OgreNewt_ngt/inc/OgreNewt_Prerequisites.h
   dependencies/OgreNewt_ngt/inc/OgreNewt_RayCast.h
   dependencies/OgreNewt_ngt/inc/OgreNewt_Tools.h
   dependencies/OgreNewt_ngt/inc/OgreNewt_Vehicle.h
   dependencies/OgreNewt_ngt/inc/OgreNewt_World.h
   dependencies/OgreNewt_ngt/src/OgreNewt_BasicJoints.cpp
   dependencies/OgreNewt_ngt/src/OgreNewt_Body.cpp
   dependencies/OgreNewt_ngt/src/OgreNewt_Collision.cpp
   dependencies/OgreNewt_ngt/src/OgreNewt_CollisionPrimitives.cpp
   dependencies/OgreNewt_ngt/src/OgreNewt_CollisionSerializer.cpp
   dependencies/OgreNewt_ngt/src/OgreNewt_Debugger.cpp
   dependencies/OgreNewt_ngt/src/OgreNewt_Joint.cpp
   dependencies/OgreNewt_ngt/src/OgreNewt_MaterialID.cpp
   dependencies/OgreNewt_ngt/src/OgreNewt_MaterialPair.cpp
   dependencies/OgreNewt_ngt/src/OgreNewt_PlayerController.cpp
   dependencies/OgreNewt_ngt/src/OgreNewt_RayCast.cpp
   dependencies/OgreNewt_ngt/src/OgreNewt_Tools.cpp
   dependencies/OgreNewt_ngt/src/OgreNewt_Vehicle.cpp
   dependencies/OgreNewt_ngt/src/OgreNewt_World.cpp
Log:
implemented lots of new features of newton 2.0, e.g. contacts can be processed more precisely etc
USE THE PREVIOUS REVISION OF OgreNewt, I still need to implement the changes in rastullah!
I didn't test the changes (but it should compile)


Modified: dependencies/OgreNewt_ngt/CMakeLists.txt
===================================================================
--- dependencies/OgreNewt_ngt/CMakeLists.txt	2009-01-28 19:18:55 UTC (rev 4727)
+++ dependencies/OgreNewt_ngt/CMakeLists.txt	2009-01-30 22:13:30 UTC (rev 4728)
@@ -74,7 +74,7 @@
 src/OgreNewt_Collision.cpp
 src/OgreNewt_CollisionPrimitives.cpp
 src/OgreNewt_CollisionSerializer.cpp
-src/OgreNewt_ContactCallback.cpp
+src/OgreNewt_ContactJoint.cpp
 src/OgreNewt_Debugger.cpp
 src/OgreNewt_Joint.cpp
 src/OgreNewt_MaterialID.cpp
@@ -102,12 +102,13 @@
         ARCHIVE DESTINATION ${CMAKE_INSTALL_PREFIX}/lib)
 
 INSTALL(FILES inc/OgreNewt_BasicJoints.h
-inc/OgreNewt_Body.h inc/OgreNewt_BodyIterator.h inc/OgreNewt_Collision.h
+inc/OgreNewt_Body.h inc/OgreNewt_Collision.h
 inc/OgreNewt_CollisionPrimitives.h inc/OgreNewt_CollisionSerializer.h
 inc/OgreNewt_ContactCallback.h inc/OgreNewt_Debugger.h inc/OgreNewt.h
 inc/OgreNewt_Joint.h inc/OgreNewt_MaterialID.h inc/OgreNewt_MaterialPair.h
 inc/OgreNewt_Prerequisites.h inc/OgreNewt_RayCast.h inc/OgreNewt_Tools.h
 inc/OgreNewt_Vehicle.h inc/OgreNewt_World.h inc/OgreNewt_PlayerController.h
+inc/OgreNewt_ContactJoint.h inc/OgreNewt_BodyInAABBIterator.h
 DESTINATION ${CMAKE_INSTALL_PREFIX}/include/OgreNewt)
 
 IF(NOT WIN32)

Modified: dependencies/OgreNewt_ngt/inc/OgreNewt.h
===================================================================
--- dependencies/OgreNewt_ngt/inc/OgreNewt.h	2009-01-28 19:18:55 UTC (rev 4727)
+++ dependencies/OgreNewt_ngt/inc/OgreNewt.h	2009-01-30 22:13:30 UTC (rev 4728)
@@ -24,17 +24,20 @@
 #include &quot;OgreNewt_Collision.h&quot;
 #include &quot;OgreNewt_Body.h&quot;
 #include &quot;OgreNewt_CollisionPrimitives.h&quot;
+#include &quot;OgreNewt_CollisionSerializer.h&quot;
 #include &quot;OgreNewt_MaterialID.h&quot;
 #include &quot;OgreNewt_MaterialPair.h&quot;
 #include &quot;OgreNewt_ContactCallback.h&quot;
+#include &quot;OgreNewt_ContactJoint.h&quot;
 #include &quot;OgreNewt_Vehicle.h&quot;
+#include &quot;OgreNewt_PlayerController.h&quot;
 #include &quot;OgreNewt_RayCast.h&quot;
 
 #include &quot;OgreNewt_Joint.h&quot;
 #include &quot;OgreNewt_BasicJoints.h&quot;
 
 #include &quot;OgreNewt_Tools.h&quot;
-#include &quot;OgreNewt_BodyIterator.h&quot;
+#include &quot;OgreNewt_BodyInAABBIterator.h&quot;
 #include &quot;OgreNewt_Debugger.h&quot;
 
 #include &quot;OgreNewt_BasicFrameListener.h&quot;

Modified: dependencies/OgreNewt_ngt/inc/OgreNewt_BasicFrameListener.h
===================================================================
--- dependencies/OgreNewt_ngt/inc/OgreNewt_BasicFrameListener.h	2009-01-28 19:18:55 UTC (rev 4727)
+++ dependencies/OgreNewt_ngt/inc/OgreNewt_BasicFrameListener.h	2009-01-30 22:13:30 UTC (rev 4728)
@@ -20,10 +20,11 @@
 		NOTE: update_framerate must be a value between [60,600]
 */
 
-#pragma once
-#include &lt;Ogre.h&gt;
-#include &lt;OgreNewt_World.h&gt;
+#ifndef _INCLUDE_OGRENEWT_BASICFRAMELISTENER
+#define _INCLUDE_OGRENEWT_BASICFRAMELISTENER
 
+#include &quot;OgreNewt_Prerequisites.h&quot;
+
 // using OIS (an Ogre 1.4.x dependency) for input.
 #define OIS_DYNAMIC_LIB
 #include &lt;OIS/OIS.h&gt;
@@ -31,7 +32,9 @@
 namespace OgreNewt
 {
 
+class World;
 
+
 //! simple frame listener to update the physics.
 /*!
 	updates the Newton World at the specified rate, with time-slicing, and
@@ -62,3 +65,6 @@
 
 
 }	// end NAMESPACE OgreNewt
+
+#endif /* _INCLUDE_OGRENEWT_BASICFRAMELISTENER */
+

Modified: dependencies/OgreNewt_ngt/inc/OgreNewt_BasicJoints.h
===================================================================
--- dependencies/OgreNewt_ngt/inc/OgreNewt_BasicJoints.h	2009-01-28 19:18:55 UTC (rev 4727)
+++ dependencies/OgreNewt_ngt/inc/OgreNewt_BasicJoints.h	2009-01-30 22:13:30 UTC (rev 4728)
@@ -11,9 +11,7 @@
 #ifndef _INCLUDE_OGRENEWT_BASICJOINTS
 #define _INCLUDE_OGRENEWT_BASICJOINTS
 
-#include &lt;Newton.h&gt;
-#include &quot;OgreNewt_World.h&quot;
-#include &quot;OgreNewt_Body.h&quot;
+#include &quot;OgreNewt_Prerequisites.h&quot;
 #include &quot;OgreNewt_Joint.h&quot;
 
 // OgreNewt namespace.  all functions and classes use this namespace.
@@ -33,6 +31,11 @@
 {
  
 public:
+	//! custom ballandsocket callback function.
+	/*!
+		 use the setCallback() function to assign your custom function to the joint.
+	 */
+	typedef void(*BallAndSocketCallback)( BallAndSocket* me, Ogre::Real timestep );
 
 	//! constructor
 	/*!
@@ -66,7 +69,16 @@
 	*/
 	void setLimits( const Ogre::Vector3&amp; pin, Ogre::Radian maxCone, Ogre::Radian maxTwist ) const { NewtonBallSetConeLimits( m_joint, &amp;pin.x, (float)maxCone.valueRadians(), (float)maxTwist.valueRadians() ); }
 
+    //! set callback function
+    void setCallback(BallAndSocketCallback *callback) {m_callback = callback;}
 
+
+protected:
+    BallAndSocketCallback *m_callback;
+
+private:
+    static void _CDECL newtonBallCallback(const NewtonJoint* ball, float timestep);
+    
 };
 
 

Modified: dependencies/OgreNewt_ngt/inc/OgreNewt_Body.h
===================================================================
--- dependencies/OgreNewt_ngt/inc/OgreNewt_Body.h	2009-01-28 19:18:55 UTC (rev 4727)
+++ dependencies/OgreNewt_ngt/inc/OgreNewt_Body.h	2009-01-30 22:13:30 UTC (rev 4728)
@@ -16,11 +16,7 @@
 #ifndef _INCLUDE_OGRENEWT_BODY
 #define _INCLUDE_OGRENEWT_BODY
 
-
-#include &lt;Ogre.h&gt;
-#include &lt;Newton.h&gt;
-#include &quot;OgreNewt_World.h&quot;
-#include &quot;OgreNewt_Collision.h&quot;
+#include &quot;OgreNewt_Prerequisites.h&quot;
 #include &quot;OgreNewt_MaterialID.h&quot;
 #include &lt;boost/function.hpp&gt;
 #include &lt;boost/bind.hpp&gt;
@@ -30,6 +26,10 @@
 namespace OgreNewt
 {
 
+class World;
+class MaterialID;
+class Collision;
+
 /*
 	CLASS DEFINITION:
 
@@ -372,7 +372,11 @@
 	}
 
 
+    //! use this function to iterate through all bodies
+    Body* getNext() const;
 
+
+
 	//! helper function that adds a force (and resulting torque) to an object in global cordinates.
 	/*!
 		this function is only valid inside a ForceCallback function!

Added: dependencies/OgreNewt_ngt/inc/OgreNewt_BodyInAABBIterator.h
===================================================================
--- dependencies/OgreNewt_ngt/inc/OgreNewt_BodyInAABBIterator.h	2009-01-28 19:18:55 UTC (rev 4727)
+++ dependencies/OgreNewt_ngt/inc/OgreNewt_BodyInAABBIterator.h	2009-01-30 22:13:30 UTC (rev 4728)
@@ -0,0 +1,103 @@
+/* 
+	OgreNewt Library
+
+	Ogre implementation of Newton Game Dynamics SDK
+
+	OgreNewt basically has no license, you may use any or all of the library however you desire... I hope it can help you in any way.
+
+		by Walaber
+
+*/
+
+#ifndef _INCLUDE_OGRENEWT_BODYINAABBITERATOR
+#define _INCLUDE_OGRENEWT_BODYINAABBITERATOR
+
+
+#include &quot;OgreNewt_Prerequisites.h&quot;
+#include &lt;boost/function.hpp&gt;
+#include &lt;boost/bind.hpp&gt;
+
+// OgreNewt namespace.  all functions and classes use this namespace.
+namespace OgreNewt
+{
+
+class World;
+class Body;
+
+
+//! Iterate through all bodies in a specific AABB in the world.
+/*!
+	this class is an easy way to loop through all bodies in an AABB in the world, performing some kind of action.
+    if you want to iterate through all bodies, use the world-&gt;getFirstBody and body-&gt;getNext functions
+    warning: this class is not thread safe
+*/
+class _OgreNewtExport BodyInAABBIterator
+{
+public:
+	//! function to be called for all bodies
+	/*!
+		This function will be called for every body iterated.  you can put any functionality you might want inside this function.
+	*/
+	typedef boost::function&lt;void(Body*)&gt; IteratorCallback;
+
+	//! init the singleton class.
+	/*!
+		This function must be called before any iterator functions are called!
+		\param world pointer to the OgreNewt::World.  
+	*/
+	void Init( const OgreNewt::World* world ) { m_world = world; }
+
+	//! perform an iteration
+	/*!
+		will call the provided function for all bodies in the world.
+		\param callback pointer to a function to be used
+	*/
+	void go( const Ogre::AxisAlignedBox &amp;aabb, IteratorCallback callback )
+	{
+		m_callback = callback;
+        NewtonWorldForEachBodyInAABBDo(m_world, &amp;aabb.getMinimum().x, &amp;aabb.getMaximum().x, newtonIterator);
+        
+	}
+	template &lt;class c&gt; void go( const Ogre::AxisAlignedBox &amp;aabb, boost::function&lt;void(c*, Body*)&gt; callback, c* instancedClassPointer )
+	{
+		go ( aabb, boost::bind(callback, instancedClassPointer, _1) );
+	}
+
+	//! get the singleton.
+	/*!
+		The body iterator is a singleton class, only one instance should exist per application.  you can perform many different
+		kinds of iterations by using different callback functions.
+	*/
+	static BodyInAABBIterator&amp; getSingleton()
+	{
+		static BodyInAABBIterator instance;
+		return instance;
+	}
+
+	//! destructor
+	~BodyInAABBIterator() {}
+
+protected:
+
+	BodyIterator()
+	{
+		m_world = NULL;
+		m_callback = NULL;
+	}
+
+	static void _CDECL newtonIterator( const NewtonBody* body )
+	{
+		OgreNewt::Body* bod = (OgreNewt::Body*)NewtonBodyGetUserData( body );
+		getSingleton().m_callback( bod );
+	}
+
+	const OgreNewt::World*			m_world;
+	IteratorCallback				m_callback;
+    
+};
+
+
+}	// end NAMESPACE OgreNewt
+
+#endif	// _INCLUDE_OGRENEWT_BODYINAABBITERATOR
+

Deleted: dependencies/OgreNewt_ngt/inc/OgreNewt_BodyIterator.h
===================================================================
--- dependencies/OgreNewt_ngt/inc/OgreNewt_BodyIterator.h	2009-01-28 19:18:55 UTC (rev 4727)
+++ dependencies/OgreNewt_ngt/inc/OgreNewt_BodyIterator.h	2009-01-30 22:13:30 UTC (rev 4728)
@@ -1,102 +0,0 @@
-/* 
-	OgreNewt Library
-
-	Ogre implementation of Newton Game Dynamics SDK
-
-	OgreNewt basically has no license, you may use any or all of the library however you desire... I hope it can help you in any way.
-
-		by Walaber
-
-*/
-
-#ifndef _INCLUDE_OGRENEWT_BODYITERATOR
-#define _INCLUDE_OGRENEWT_BODYITERATOR
-
-#include &lt;Newton.h&gt;
-
-#include &quot;OgreNewt_World.h&quot;
-#include &quot;OgreNewt_Body.h&quot;
-
-#include &lt;boost/function.hpp&gt;
-#include &lt;boost/bind.hpp&gt;
-
-// OgreNewt namespace.  all functions and classes use this namespace.
-namespace OgreNewt
-{
-
-
-//! Iterate through all bodies in the world.
-/*!
-	this class is an easy way to loop through all bodies in the world, performing some kind of action.
-*/
-class _OgreNewtExport BodyIterator
-{
-public:
-	//! function to be called for all bodies
-	/*!
-		This function will be called for every body iterated.  you can put any functionality you might want inside this function.
-	*/
-	typedef boost::function&lt;void(Body*)&gt; IteratorCallback;
-
-	//! init the singleton class.
-	/*!
-		This function must be called before any iterator functions are called!
-		\param world pointer to the OgreNewt::World.  
-	*/
-	void Init( const OgreNewt::World* world ) { m_world = world; }
-
-	//! perform an iteration
-	/*!
-		will call the provided function for all bodies in the world.
-		\param callback pointer to a function to be used
-	*/
-	void go( IteratorCallback callback )
-	{
-		m_callback = callback;
-                for( const NewtonBody* body = NewtonWorldGetFirstBody(m_world-&gt;getNewtonWorld()); body; NewtonWorldGetNextBody(m_world-&gt;getNewtonWorld(), body) )
-                    newtonIterator(body);
-	}
-	template &lt;class c&gt; void go( boost::function&lt;void(c*, Body*)&gt; callback, c* instancedClassPointer )
-	{
-		go ( boost::bind(callback, instancedClassPointer, _1) );
-	}
-
-	//! get the singleton.
-	/*!
-		The body iterator is a singleton class, only one instance should exist per application.  you can perform many different
-		kinds of iterations by using different callback functions.
-	*/
-	static BodyIterator&amp; getSingleton()
-	{
-		static BodyIterator instance;
-		return instance;
-	}
-
-	//! destructor
-	~BodyIterator() {}
-
-protected:
-
-	BodyIterator()
-	{
-		m_world = NULL;
-		m_callback = NULL;
-	}
-
-	static void newtonIterator( const NewtonBody* body )
-	{
-		OgreNewt::Body* bod = (OgreNewt::Body*)NewtonBodyGetUserData( body );
-
-		getSingleton().m_callback( bod );
-	}
-
-	const OgreNewt::World*			m_world;
-	IteratorCallback				m_callback;
-    
-};
-
-
-}	// end NAMESPACE OgreNewt
-
-#endif	// _INCLUDE_OGRENEWT_BODYITERATOR
-

Modified: dependencies/OgreNewt_ngt/inc/OgreNewt_Collision.h
===================================================================
--- dependencies/OgreNewt_ngt/inc/OgreNewt_Collision.h	2009-01-28 19:18:55 UTC (rev 4727)
+++ dependencies/OgreNewt_ngt/inc/OgreNewt_Collision.h	2009-01-30 22:13:30 UTC (rev 4728)
@@ -11,13 +11,16 @@
 #ifndef _INCLUDE_OGRENEWT_COLLISION
 #define _INCLUDE_OGRENEWT_COLLISION
 
-#include &lt;Newton.h&gt;
+
+#include &quot;OgreNewt_Prerequisites.h&quot;
 #include &quot;OgreNewt_World.h&quot;
 
 // OgreNewt namespace.  all functions and classes use this namespace.
 namespace OgreNewt
 {
 
+class World;
+
 /*
 	CLASS DEFINITION:
 

Modified: dependencies/OgreNewt_ngt/inc/OgreNewt_CollisionPrimitives.h
===================================================================
--- dependencies/OgreNewt_ngt/inc/OgreNewt_CollisionPrimitives.h	2009-01-28 19:18:55 UTC (rev 4727)
+++ dependencies/OgreNewt_ngt/inc/OgreNewt_CollisionPrimitives.h	2009-01-30 22:13:30 UTC (rev 4728)
@@ -11,8 +11,8 @@
 #ifndef _INCLUDE_OGRENEWT_COLLISIONPRIMITIVES
 #define _INCLUDE_OGRENEWT_COLLISIONPRIMITIVES
 
-#include &lt;Newton.h&gt;
-#include &quot;OgreNewt_World.h&quot;
+
+#include &quot;OgreNewt_Prerequisites.h&quot;
 #include &quot;OgreNewt_Collision.h&quot;
 
 

Modified: dependencies/OgreNewt_ngt/inc/OgreNewt_CollisionSerializer.h
===================================================================
--- dependencies/OgreNewt_ngt/inc/OgreNewt_CollisionSerializer.h	2009-01-28 19:18:55 UTC (rev 4727)
+++ dependencies/OgreNewt_ngt/inc/OgreNewt_CollisionSerializer.h	2009-01-30 22:13:30 UTC (rev 4728)
@@ -11,8 +11,8 @@
 #ifndef _INCLUDE_OGRENEWT_COLLISIONSERIALIZER
 #define _INCLUDE_OGRENEWT_COLLISIONSERIALIZER
 
-#include &lt;Newton.h&gt;
-#include &quot;OgreNewt_World.h&quot;
+
+#include &quot;OgreNewt_Prerequisites.h&quot;
 #include &quot;OgreSerializer.h&quot;
 #include &quot;OgreString.h&quot;
 
@@ -46,6 +46,7 @@
     */
     void importCollision(Ogre::DataStreamPtr&amp; stream, Collision* pDest);
 
+  private:
     /*!
     Callback function for Newton. It should never be called directly, but will be called by Newton to save the Collision to a stream.
     (Newton calls this function several times for each serialization, once for each chunk of its file format apparently)

Modified: dependencies/OgreNewt_ngt/inc/OgreNewt_ContactCallback.h
===================================================================
--- dependencies/OgreNewt_ngt/inc/OgreNewt_ContactCallback.h	2009-01-28 19:18:55 UTC (rev 4727)
+++ dependencies/OgreNewt_ngt/inc/OgreNewt_ContactCallback.h	2009-01-30 22:13:30 UTC (rev 4728)
@@ -11,13 +11,15 @@
 #ifndef _INCLUDE_OGRENEWT_CONTACTCALLBACK
 #define _INCLUDE_OGRENEWT_CONTACTCALLBACK
 
-#include &lt;Newton.h&gt;
-#include &quot;OgreNewt_Body.h&quot;
 
+#include &quot;OgreNewt_Prerequisites.h&quot;
+#include &quot;OgreNewt_ContactJoint.h&quot;
+
 // OgreNewt namespace.  all functions and classes use this namespace.
 namespace OgreNewt
 {
 
+class Body;
 
 //! custom contact behavior
 /*!
@@ -35,105 +37,21 @@
 	//! destructor
 	virtual ~ContactCallback();
 
-	// basic contact control commands...
-
-	//! disable the current contact.
-	//void disableContact() const { NewtonMaterialDisableContact( m_material ); }
-
-
-	//! get the face ID of a TreeCollision object
-	unsigned getContactFaceAttribute() const { return NewtonMaterialGetContactFaceAttribute( m_material ); }
-
-	//! get the Collision ID of a body currently colliding
-	unsigned getBodyCollisionID( OgreNewt::Body* body ) const { return NewtonMaterialGetBodyCollisionID( m_material, body-&gt;getNewtonBody() ); }
-
-	//! speed of the collision
-	Ogre::Real getContactNormalSpeed() const { return (Ogre::Real)NewtonMaterialGetContactNormalSpeed( m_material ); }
-
-	//! force of the collision
+	//! user-defined AABB-overlap function
 	/*!
-		only valid for objects in a stable state (sitting on top of each other, etc)
-	*/
-	Ogre::Vector3 getContactForce() const;
-
-	//! get positoin and normal of the collision
-	void getContactPositionAndNormal( Ogre::Vector3&amp; pos, Ogre::Vector3&amp; norm ) const;
-
-	//! get the tangent vectors of the collision
-	void getContactTangentDirections( Ogre::Vector3&amp; dir0, Ogre::Vector3&amp; dir1 ) const;
-
-	//! get tangent speed of the collision
-	Ogre::Real getContactTangentSpeed( int index ) const { return (Ogre::Real)NewtonMaterialGetContactTangentSpeed( m_material, index ); }
-
-	//! set softness of the current contact
-	void setContactSoftness( Ogre::Real softness ) const { NewtonMaterialSetContactSoftness( m_material, (float)softness ); }
-
-	//! set elasticity of the current contact
-	void setContactElasticity( Ogre::Real elasticity ) const { NewtonMaterialSetContactElasticity( m_material, (float)elasticity ); }
-
-	//! set friction state of current contact
-	void setContactFrictionState( int state, int index ) const { NewtonMaterialSetContactFrictionState( m_material, state, index ); }
-
-	//! set static friction for current contact
-	void setContactFrictionCoef( Ogre::Real stat, Ogre::Real kinetic, int index ) const { NewtonMaterialSetContactFrictionCoef( m_material, (float)stat, (float)kinetic, index ); }
-
-	//! set tangent acceleration for contact
-	void setContactTangentAcceleration( Ogre::Real accel, int index ) const { NewtonMaterialSetContactTangentAcceleration( m_material, (float)accel, index ); }
-
-	//! align tangent vectors with a user supplied direction
-	void rotateTangentDirections( const Ogre::Vector3&amp; dir ) const { NewtonMaterialContactRotateTangentDirections( m_material, &amp;dir.x ); }
-
-	//! manually set the normal for the collision.
-	void setContactNormalDirection( const Ogre::Vector3&amp; dir ) const { NewtonMaterialSetContactNormalDirection( m_material, &amp;dir.x ); }
-
-	//! manually set the acceleration along the collision normal.
-	void setContactNormalAcceleration( Ogre::Real accel ) const { NewtonMaterialSetContactNormalAcceleration( m_material, accel ); }
-
-
-
-	// user-defined callback function.
-	
-	//! user defined Begin function
-	/*!
 		this function is called when 2 bodies AABB overlap.  they have not yet collided, but *may* do so this loop.
 		at this point, m_body0 and m_body1 are defined, but the contact isn't yet valid, so none of the member functions
-		can be called yet.  they must be called from the userProcess() function.
+		can be called yet.  they must be called from the contacsProcess() function.
 		return 0 to ignore the collision, 1 to allow it.
 	*/
-	virtual int onAABBOverlap( int threadIndex ) { return 1; }
+	virtual int onAABBOverlap( OgreNewt::Body* body0, OgreNewt::Body* body1, int threadIndex ) { return 1; }
 
 	//! user-defined Process function
 	/*!
-		user process function.  is called for each contact between the 2 bodies.  all member functions are valid from
-		within this function, and will affect the current contact.  return 0 to ignore the collision, 1 to allow it.
+		user process function.  it is called for each colliding pair of bodies. you can use
+        the ContactJoint to iterate through all contact-points and change the &quot;material&quot; of each contact-point!
 	 */
-	virtual int contactProcess( Ogre::Real timeStep, int threadIndex ) { return 1; }
-
-	//! user-defined End function
-	/*!
-		called after all contacts between the 2 bodies have been processed. no member functions should be called from within this
-		function either, as all contacts have been processed at this point.
-	*/
-	//virtual void userEnd( int threadIndex ) {  } // doesn't exist any more!
-
-	//! get the NewtonMaterial from this callback.
-	NewtonMaterial* _getNewtonMaterial() { return m_material; }
-
-
-	//! internal function.
-	static int _CDECL onAABBOverlap( const NewtonMaterial* material, const NewtonBody* body0, const NewtonBody* body1, int threadIndex );
-	//! internal function.
-	static void _CDECL contactProcess(const NewtonJoint* contact, float timeStep, int threadIndex );
-	//! internal function.
-	//static void _CDECL contactEnd( const NewtonMaterial* material, const NewtonBody* body0, const NewtonBody* body1, int threadIndex );
-
-
-protected:
-
-	NewtonMaterial* m_material;
-
-	OgreNewt::Body* m_body0;
-	OgreNewt::Body* m_body1;
+	virtual void contactsProcess( OgreNewt::ContactJoint contactJoint, Ogre::Real timeStep, int threadIndex ) { }
 };
 
 

Added: dependencies/OgreNewt_ngt/inc/OgreNewt_ContactJoint.h
===================================================================
--- dependencies/OgreNewt_ngt/inc/OgreNewt_ContactJoint.h	2009-01-28 19:18:55 UTC (rev 4727)
+++ dependencies/OgreNewt_ngt/inc/OgreNewt_ContactJoint.h	2009-01-30 22:13:30 UTC (rev 4728)
@@ -0,0 +1,170 @@
+/* 
+	OgreNewt Library
+
+	Ogre implementation of Newton Game Dynamics SDK
+
+	OgreNewt basically has no license, you may use any or all of the library however you desire... I hope it can help you in any way.
+
+		by melven
+
+*/
+#ifndef _INCLUDE_OGRENEWT_CONTACTJOINT
+#define _INCLUDE_OGRENEWT_CONTACTJOINT
+
+
+#include &quot;OgreNewt_Prerequisites.h&quot;
+#include &quot;OgreNewt_Body.h&quot;
+
+// OgreNewt namespace.  all functions and classes use this namespace.
+namespace OgreNewt
+{
+
+class ContactJoint;
+class Contact;
+class MaterialPair;
+
+//! with this class you can iterate through all contacts
+/*!
+    this class must not be inherited or instantiated directly in any way, 
+    it is passed as argument in the contacsProcess-function of the ContactCallback!
+    for iterating through all contacts you can do something like this:
+    for(Contact contact = contactJoint.getFirstContact(); contact; contact.getNext())
+        ...
+*/
+class _OgreNewtExport ContactJoint
+{
+public:
+
+    //! constructor
+    ContactJoint(const NewtonJoint* contactJoint);
+
+    //! destructor
+    ~ContactJoint();
+
+    //! return the number of contacts
+    int getContactCount() const { return NewtonContactJointGetContactCount( m_contactjoint ); }
+
+    //! get the first contact
+    Contact getFirstContact();
+
+    //! get the first body
+    OgreNewt::Body* getBody0() { return (OgreNewt::Body*) NewtonBodyGetUserData(NewtonJointGetBody0(m_contactjoint)); }
+
+    //! get the second body
+    OgreNewt::Body* getBody1() { return (OgreNewt::Body*) NewtonBodyGetUserData(NewtonJointGetBody1(m_contactjoint)); }
+
+    //! get the newton ContactJoint
+    const NewtonJoint* _getNewtonContactJoint() { return m_contactjoint; }
+
+    //! get the MaterialPair with the basis material of this contact-joint
+    /*!
+        you shouldn't need to call this function, it's only used internally
+    */
+    MaterialPair* getMaterialPair();
+
+protected:
+    const NewtonJoint* m_contactjoint;
+};
+
+
+
+//! with the methods from this class you can set the behavior of each contac-point
+/*!
+	this class is for creating custom behavior between material GroupIDs.
+    this class must not be inherited or instantiated directly in any way,
+    you can obtain an object of this class in the contact-callback
+    from the contactJoint and iterate through all contacts using the 
+    getNext-function
+*/
+class _OgreNewtExport Contact
+{
+public:
+
+	//! constructor
+	Contact(void *contact, ContactJoint* parent);
+
+	//! destructor
+	~Contact();
+
+    //! return true, if this is not a valid contact (end of the contact-list!)
+    bool operator! () const { return m_contact != NULL; }
+
+    //! get the next contact from the parent contact-joint
+    Contact getNext() const;
+
+	// basic contact control commands... they can only be used, if this is a valid contact ( !contact == false )
+
+    //! get the first body
+    OgreNewt::Body* getBody0() const { return (OgreNewt::Body*) NewtonBodyGetUserData( NewtonJointGetBody0( m_parent-&gt;_getNewtonContactJoint() ) ); }
+    OgreNewt::Body* getBody1() const { return (OgreNewt::Body*) NewtonBodyGetUserData( NewtonJointGetBody1( m_parent-&gt;_getNewtonContactJoint() ) ); }
+
+	//! get the face ID of a TreeCollision object
+	unsigned getContactFaceAttribute() const { return NewtonMaterialGetContactFaceAttribute( m_material ); }
+
+	//! get the Collision ID of a body currently colliding
+	unsigned getBodyCollisionID( OgreNewt::Body* body ) const { return NewtonMaterialGetBodyCollisionID( m_material, body-&gt;getNewtonBody() ); }
+
+	//! speed of the collision
+	Ogre::Real getContactNormalSpeed() const { return (Ogre::Real)NewtonMaterialGetContactNormalSpeed( m_material ); }
+
+	//! force of the collision
+	/*!
+		only valid for objects in a stable state (sitting on top of each other, etc)
+	*/
+	Ogre::Vector3 getContactForce() const;
+
+	//! get positoin and normal of the collision
+	void getContactPositionAndNormal( Ogre::Vector3&amp; pos, Ogre::Vector3&amp; norm ) const { NewtonMaterialGetContactPositionAndNormal(m_material, &amp;pos.x, &amp;norm.x); }
+
+	//! get the tangent vectors of the collision
+	void getContactTangentDirections( Ogre::Vector3&amp; dir0, Ogre::Vector3&amp; dir1 ) const { NewtonMaterialGetContactTangentDirections(m_material, &amp;dir0.x, &amp;dir1.x); }
+
+	//! get tangent speed of the collision
+	Ogre::Real getContactTangentSpeed( int index ) const { return (Ogre::Real)NewtonMaterialGetContactTangentSpeed( m_material, index ); }
+
+	//! set softness of the current contact
+	void setContactSoftness( Ogre::Real softness ) { NewtonMaterialSetContactSoftness( m_material, (float)softness ); }
+
+	//! set elasticity of the current contact
+	void setContactElasticity( Ogre::Real elasticity ) { NewtonMaterialSetContactElasticity( m_material, (float)elasticity ); }
+
+	//! set friction state of current contact
+	void setContactFrictionState( int state, int index ) { NewtonMaterialSetContactFrictionState( m_material, state, index ); }
+
+	//! set static friction for current contact
+	void setContactFrictionCoef( Ogre::Real stat, Ogre::Real kinetic, int index ) { NewtonMaterialSetContactFrictionCoef( m_material, (float)stat, (float)kinetic, index ); }
+
+	//! set tangent acceleration for contact
+	void setContactTangentAcceleration( Ogre::Real accel, int index ) { NewtonMaterialSetContactTangentAcceleration( m_material, (float)accel, index ); }
+
+	//! align tangent vectors with a user supplied direction
+	void rotateTangentDirections( const Ogre::Vector3&amp; dir ) { NewtonMaterialContactRotateTangentDirections( m_material, &amp;dir.x ); }
+
+	//! manually set the normal for the collision.
+	void setContactNormalDirection( const Ogre::Vector3&amp; dir ) { NewtonMaterialSetContactNormalDirection( m_material, &amp;dir.x ); }
+
+	//! manually set the acceleration along the collision normal.
+	void setContactNormalAcceleration( Ogre::Real accel ) { NewtonMaterialSetContactNormalAcceleration( m_material, accel ); }
+
+    //! removes the contact from the parent contact-joint, this means newton doesn't process this contact
+    /*!
+        use this function, when you want to ignore this specific contact, but you need to get the next contact before,
+        because this will invalidate this class (set all pointers to zero!)
+    */
+    void remove();
+
+	//! get the NewtonMaterial from this callback.
+	NewtonMaterial* _getNewtonMaterial() { return m_material; }
+
+protected:
+    NewtonMaterial* m_material;
+    void* m_contact;
+    OgreNewt::ContactJoint* m_parent;
+};
+
+
+}	// end NAMESPACE OgreNewt
+
+#endif
+// _INCLUDE_OGRENEWT_CONTACTJOINT
+

Modified: dependencies/OgreNewt_ngt/inc/OgreNewt_Debugger.h
===================================================================
--- dependencies/OgreNewt_ngt/inc/OgreNewt_Debugger.h	2009-01-28 19:18:55 UTC (rev 4727)
+++ dependencies/OgreNewt_ngt/inc/OgreNewt_Debugger.h	2009-01-30 22:13:30 UTC (rev 4728)
@@ -12,15 +12,17 @@
 #define _INCLUDE_OGRENEWT_DEBUGGER
 
 
-#include &lt;Ogre.h&gt;
-#include &lt;Newton.h&gt;
-#include &quot;OgreNewt_World.h&quot;
-#include &quot;OgreNewt_Body.h&quot;
+#include &quot;OgreNewt_Prerequisites.h&quot;
 #include &quot;OgreNewt_Tools.h&quot;
 
 namespace OgreNewt
 {
 
+    class World;
+    class Body;
+    class MaterialID;
+    class Collision;
+
 	//! For viewing the Newton rigid bodies visually.
 	/*!
 		This class implements a debug view of the Newton world.  it is a Singleton!
@@ -91,7 +93,7 @@
 	protected:
 		Debugger();
 	
-	private:
+	protected:
 		Ogre::SceneNode*		m_debugnode;
         typedef std::map&lt;int, Ogre::ColourValue&gt; MaterialIdColorMap;
         MaterialIdColorMap      m_materialcolors;
@@ -115,8 +117,11 @@
         typedef std::map&lt;OgreNewt::Body*, BodyDebugData&gt; BodyDebugDataMap;
         BodyDebugDataMap m_cachemap;
 
+        // create debug information for one body
+        void processBody(Body* body);
 
-		static void newtonPerBody( const NewtonBody* body );
+
+    private:
 		static void _CDECL newtonPerPoly( void* userData, int vertexCount, const float* faceVertec, int id );
 	};
 

Modified: dependencies/OgreNewt_ngt/inc/OgreNewt_Joint.h
===================================================================
--- dependencies/OgreNewt_ngt/inc/OgreNewt_Joint.h	2009-01-28 19:18:55 UTC (rev 4727)
+++ dependencies/OgreNewt_ngt/inc/OgreNewt_Joint.h	2009-01-30 22:13:30 UTC (rev 4728)
@@ -11,14 +11,17 @@
 #ifndef _INCLUDE_OGRENEWT_JOINT
 #define _INCLUDE_OGRENEWT_JOINT
 
-#include &lt;Newton.h&gt;
-#include &quot;OgreNewt_World.h&quot;
-#include &quot;OgreNewt_Body.h&quot;
 
+#include &quot;OgreNewt_Prerequisites.h&quot;
+
+
 // OgreNewt namespace.  all functions and classes use this namespace.
 namespace OgreNewt
 {
 
+class World;
+class Body;
+
 //! base class for all joints.
 /*!
 	this class is inherited by all other specific joint types.
@@ -158,6 +161,7 @@
 	const OgreNewt::Body* m_body0;
 	const OgreNewt::Body* m_body1;
 
+private:
 	//! newton callback.  used internally.
 	static void _CDECL newtonSubmitConstraint( const NewtonJoint* me, float timeStep, int threadIndex );
 	static void _CDECL newtonGetInfo( const NewtonJoint* me, NewtonJointRecord* info );

Modified: dependencies/OgreNewt_ngt/inc/OgreNewt_MaterialID.h
===================================================================
--- dependencies/OgreNewt_ngt/inc/OgreNewt_MaterialID.h	2009-01-28 19:18:55 UTC (rev 4727)
+++ dependencies/OgreNewt_ngt/inc/OgreNewt_MaterialID.h	2009-01-30 22:13:30 UTC (rev 4728)
@@ -11,14 +11,14 @@
 #ifndef _INCLUDE_OGRENEWT_MATERIALID
 #define _INCLUDE_OGRENEWT_MATERIALID
 
-#include &lt;Newton.h&gt;
-#include &quot;OgreNewt_World.h&quot;
 
+#include &quot;OgreNewt_Prerequisites.h&quot;
+
 // OgreNewt namespace.  all functions and classes use this namespace.
 namespace OgreNewt
 {
 
-	class World;
+class World;
 
 //! represents a material
 class _OgreNewtExport MaterialID

Modified: dependencies/OgreNewt_ngt/inc/OgreNewt_MaterialPair.h
===================================================================
--- dependencies/OgreNewt_ngt/inc/OgreNewt_MaterialPair.h	2009-01-28 19:18:55 UTC (rev 4727)
+++ dependencies/OgreNewt_ngt/inc/OgreNewt_MaterialPair.h	2009-01-30 22:13:30 UTC (rev 4728)
@@ -11,7 +11,8 @@
 #ifndef _INCLUDE_OGRENEWT_MATERIALPAIR
 #define _INCLUDE_OGRENEWT_MATERIALPAIR
 
-#include &lt;Newton.h&gt;
+
+#include &quot;OgreNewt_Prerequisites.h&quot;
 #include &quot;OgreNewt_World.h&quot;
 #include &quot;OgreNewt_ContactCallback.h&quot;
 #include &quot;OgreNewt_MaterialID.h&quot;
@@ -76,13 +77,19 @@
 	void setContactCallback( OgreNewt::ContactCallback* callback );
 
 
-
 protected:
-
 	const MaterialID*	id0;
 	const MaterialID*	id1;
 	const World*		m_world;
+    OgreNewt::ContactCallback *m_contactcallback;
 
+private:
+	//! internal function.
+	static int _CDECL collisionCallback_onAABBOverlap( const NewtonMaterial* material, const NewtonBody* body0, const NewtonBody* body1, int threadIndex );
+	//! internal function.
+	static void _CDECL collisionCallback_contactsProcess(const NewtonJoint* contact, float timeStep, int threadIndex );
+
+
 };
 
 

Modified: dependencies/OgreNewt_ngt/inc/OgreNewt_PlayerController.h
===================================================================
--- dependencies/OgreNewt_ngt/inc/OgreNewt_PlayerController.h	2009-01-28 19:18:55 UTC (rev 4727)
+++ dependencies/OgreNewt_ngt/inc/OgreNewt_PlayerController.h	2009-01-30 22:13:30 UTC (rev 4728)
@@ -11,15 +11,19 @@
 #ifndef _INCLUDE_OGRENEWT_PLAYERCONTROLLER
 #define _INCLUDE_OGRENEWT_PLAYERCONTROLLER
 
-#include &lt;Newton.h&gt;
+
+#include &quot;OgreNewt_Prerequisites.h&quot;
 #include &quot;OgreNewt_Joint.h&quot;
-#include &quot;OgreNewt_Collision.h&quot;
 #include &quot;OgreNewt_RayCast.h&quot;
+#include &quot;OgreNewt_Body.h&quot;
 
 
 namespace OgreNewt
 {
 
+class Collision;
+class ConvexCollision;
+
 //! PlayerController
 /*!
     this class implements a player-controller based on the code of the CustomPlayerController-class in the Newton-CustomJoints library
@@ -35,7 +39,7 @@
     OgreNewt::Body* getControlledBody() const {return m_body;}
 
     //! set the characters velocity, the -Speed-values can be negative, sideSpeed positiv means move to the right, heading is in absolute space
-    void setVelocity(Ogre::Real forwardSpeed, Ogre::Real sideSpeed, Ogre::Radian heading);
+    void setVelocity(Ogre::Real forwardSpeed, Ogre::Real sideSpeed, Ogre::Degree heading);
 
     //! get currently set velocity
     void getVelocity(Ogre::Real &amp;forwardSpeed, Ogre::Real&amp; sideSpeed, Ogre::Radian&amp; heading) const;
@@ -58,12 +62,12 @@
     //! get currently set restitution
     Ogre::Real getRestitution() const;
 
-    //! set up-vector pin
-    void setPinVector(Ogre::Vector3 upVector);
+    // not supported yet
+    // set up-vector pin
+    //void setPinVector(Ogre::Vector3 upVector);
+    // get currently set up-vector pin
+    //Ogre::Vector3 getPinVector() const;
 
-    //! get currently set up-vector pin
-    Ogre::Vector3 getPinVector() const;
-
     //! is the body currently in the air (jumpin?)
     bool isInJumpState() const;
 

Modified: dependencies/OgreNewt_ngt/inc/OgreNewt_Prerequisites.h
===================================================================
--- dependencies/OgreNewt_ngt/inc/OgreNewt_Prerequisites.h	2009-01-28 19:18:55 UTC (rev 4727)
+++ dependencies/OgreNewt_ngt/inc/OgreNewt_Prerequisites.h	2009-01-30 22:13:30 UTC (rev 4728)
@@ -14,6 +14,7 @@
 #define __INCLUDE_OGRENEWT_PREREQ__
 
 #include &lt;Ogre.h&gt;
+#include &lt;Newton.h&gt;
 
 #if OGRE_PLATFORM == OGRE_PLATFORM_WIN32
 #   define _CDECL _cdecl

Modified: dependencies/OgreNewt_ngt/inc/OgreNewt_RayCast.h
===================================================================
--- dependencies/OgreNewt_ngt/inc/OgreNewt_RayCast.h	2009-01-28 19:18:55 UTC (rev 4727)
+++ dependencies/OgreNewt_ngt/inc/OgreNewt_RayCast.h	2009-01-30 22:13:30 UTC (rev 4728)
@@ -13,16 +13,16 @@
 #define _INCLUDE_OGRENEWT_RAYCAST
 
 
-#include &lt;Ogre.h&gt;
-#include &lt;Newton.h&gt;
-#include &quot;OgreNewt_World.h&quot;
-#include &quot;OgreNewt_Body.h&quot;
+#include &quot;OgreNewt_Prerequisites.h&quot;
 
-
 // OgreNewt namespace.  all functions and classes use this namespace.
 namespace OgreNewt
 {
 
+class World;
+class Body;
+class Collision;
+
 //! general raycast
 /*!
 	General class representing a raycast query in the Newton world.  this class should be inherited to create specific raycast behavior.

Modified: dependencies/OgreNewt_ngt/inc/OgreNewt_Tools.h
===================================================================
--- dependencies/OgreNewt_ngt/inc/OgreNewt_Tools.h	2009-01-28 19:18:55 UTC (rev 4727)
+++ dependencies/OgreNewt_ngt/inc/OgreNewt_Tools.h	2009-01-30 22:13:30 UTC (rev 4728)
@@ -12,15 +12,14 @@
 #define _INCLUDE_OGRENEWT_TOOLS
 
 
-#include &lt;Ogre.h&gt;
+#include &quot;OgreNewt_Prerequisites.h&quot;
 #include &lt;OgreMovableObject.h&gt;
 #include &lt;OgreRenderable.h&gt;
-#include &lt;Newton.h&gt;
-#include &quot;OgreNewt_World.h&quot;
-#include &quot;OgreNewt_Collision.h&quot;
 
 namespace OgreNewt
 {
+    class World;
+    class Collision;
 
 	//! set of handy convertors.
 	namespace Converters

Modified: dependencies/OgreNewt_ngt/inc/OgreNewt_Vehicle.h
===================================================================
--- dependencies/OgreNewt_ngt/inc/OgreNewt_Vehicle.h	2009-01-28 19:18:55 UTC (rev 4727)
+++ dependencies/OgreNewt_ngt/inc/OgreNewt_Vehicle.h	2009-01-30 22:13:30 UTC (rev 4728)
@@ -11,13 +11,14 @@
 #ifndef _INCLUDE_OGRENEWT_VEHICLE
 #define _INCLUDE_OGRENEWT_VEHICLE
 
-#include &lt;Newton.h&gt;
-#include &quot;OgreNewt_Body.h&quot;
+
+#include &quot;OgreNewt_Prerequisites.h&quot;
 #include &quot;OgreNewt_Joint.h&quot;
-#include &quot;OgreNewt_World.h&quot;
 
 namespace OgreNewt
 {
+    class Body;
+    class World;
 #ifdef INCLUDE_VEHICLE
 //! Represents a wheeled vehicle
 /*!

Modified: dependencies/OgreNewt_ngt/inc/OgreNewt_World.h
===================================================================
--- dependencies/OgreNewt_ngt/inc/OgreNewt_World.h	2009-01-28 19:18:55 UTC (rev 4727)
+++ dependencies/OgreNewt_ngt/inc/OgreNewt_World.h	2009-01-30 22:13:30 UTC (rev 4728)
@@ -10,10 +10,8 @@
 #ifndef _INCLUDE_OGRENEWT_WORLD
 #define _INCLUDE_OGRENEWT_WORLD
 
-#include &lt;Newton.h&gt;
-#include &lt;Ogre.h&gt;
+
 #include &quot;OgreNewt_Prerequisites.h&quot;
-#include &quot;OgreNewt_MaterialID.h&quot;
 #include &lt;boost/function.hpp&gt;
 #include &lt;boost/bind.hpp&gt;
 
@@ -25,9 +23,10 @@
 {
 
 
+class Body;
 class MaterialID;
-class Body;
 
+
 //! represents a physics world.
 /*!
 	this class represents a NewtonWorld, which is the basic space in which physics elements can exist.  It can have various Rigid Bodies, connected by joints, and other constraints.
@@ -137,6 +136,9 @@
 	*/
 	int getBodyCount() const { return NewtonWorldGetBodyCount( m_world ); }
 
+    //! get the number of constaints in the simulation
+    int getConstraintCount() const {return NewtonWorldGetConstraintCount( m_world ); }
+
 	//! multithread settings
 	void setMultithreadSolverOnSingleIsland( int mode ) { NewtonSetMultiThreadSolverOnSingleIsland( m_world, mode ); }
 
@@ -181,7 +183,16 @@
 		setLeaveWorldCallback( boost::bind(callback, instancedClassPointer, _1, _2) );
 	}
 
+    //! to iterate through all bodies call this function and then use body-&gt;getNext()
+    Body* getFirstBody();
 
+    /*
+    //! to iterate through all material-pairs use this function and then call matPair-&gt;getNext()
+    MaterialGroupID* getFirstMaterialGroupID();
+    */
+
+
+
 protected:
 	
 	NewtonWorld* m_world;

Modified: dependencies/OgreNewt_ngt/src/OgreNewt_BasicJoints.cpp
===================================================================
--- dependencies/OgreNewt_ngt/src/OgreNewt_BasicJoints.cpp	2009-01-28 19:18:55 UTC (rev 4727)
+++ dependencies/OgreNewt_ngt/src/OgreNewt_BasicJoints.cpp	2009-01-30 22:13:30 UTC (rev 4728)
@@ -1,7 +1,6 @@
-#include &lt;Newton.h&gt;
-#include &lt;OgreNewt_BasicJoints.h&gt;
-#include &lt;OgreNewt_World.h&gt;
-#include &lt;OgreNewt_Body.h&gt;
+#include &quot;OgreNewt_BasicJoints.h&quot;
+#include &quot;OgreNewt_World.h&quot;
+#include &quot;OgreNewt_Body.h&quot;
 
 namespace OgreNewt
 {
@@ -22,7 +21,8 @@
 	// all constructors inherited from Joint MUST call these 2 functions to make the joint function properly.
 	NewtonJointSetUserData( m_joint, this );
 	NewtonJointSetDestructor( m_joint, destructor );
-										
+
+    m_callback = NULL;
 }
 
 BallAndSocket::~BallAndSocket()
@@ -60,7 +60,14 @@
 }
 
 
+void _CDECL BallAndSocket::newtonBallCallback(const NewtonJoint* ball, float timestep)
+{
+    BallAndSocket* me = (BallAndSocket*)NewtonJointGetUserData(ball);
+    if( me-&gt;m_callback != NULL )
+        ( *me-&gt;m_callback )(me, timestep);
+}
 
+
 ///////////////////////////////////////////////////////////////////////////////////////////////
 ///////////////////////////////////////////////////////////////////////////////////////////////
 

Modified: dependencies/OgreNewt_ngt/src/OgreNewt_Body.cpp
===================================================================
--- dependencies/OgreNewt_ngt/src/OgreNewt_Body.cpp	2009-01-28 19:18:55 UTC (rev 4727)
+++ dependencies/OgreNewt_ngt/src/OgreNewt_Body.cpp	2009-01-30 22:13:30 UTC (rev 4728)
@@ -1,4 +1,6 @@
 #include &quot;OgreNewt_Body.h&quot;
+#include &quot;OgreNewt_World.h&quot;
+#include &quot;OgreNewt_Collision.h&quot;
 #include &quot;OgreNewt_Tools.h&quot;
 
 
@@ -359,7 +361,16 @@
 	addGlobalForce( globalforce, globalpoint );
 }
 
+Body* Body::getNext() const
+{
+    NewtonBody* body = NewtonWorldGetNextBody( m_world-&gt;getNewtonWorld(), m_body );
+    if( body )
+        return (Body*) NewtonBodyGetUserData(body);
 
+    return NULL;
+}
+
+
 // --------------------------------------------------------------------------------------
 
 

Modified: dependencies/OgreNewt_ngt/src/OgreNewt_Collision.cpp
===================================================================
--- dependencies/OgreNewt_ngt/src/OgreNewt_Collision.cpp	2009-01-28 19:18:55 UTC (rev 4727)
+++ dependencies/OgreNewt_ngt/src/OgreNewt_Collision.cpp	2009-01-30 22:13:30 UTC (rev 4728)
@@ -1,7 +1,5 @@
-#include &lt;Ogre.h&gt;
-#include &lt;OgreNewt_Collision.h&gt;
-#include &lt;OgreNewt_World.h&gt;
-#include &lt;OgreNewt_Tools.h&gt;
+#include &quot;OgreNewt_Collision.h&quot;
+#include &quot;OgreNewt_Tools.h&quot;
 
 
 namespace OgreNewt

Modified: dependencies/OgreNewt_ngt/src/OgreNewt_CollisionPrimitives.cpp
===================================================================
--- dependencies/OgreNewt_ngt/src/OgreNewt_CollisionPrimitives.cpp	2009-01-28 19:18:55 UTC (rev 4727)
+++ dependencies/OgreNewt_ngt/src/OgreNewt_CollisionPrimitives.cpp	2009-01-30 22:13:30 UTC (rev 4728)
@@ -1,5 +1,5 @@
-#include &lt;OgreNewt_CollisionPrimitives.h&gt;
-#include &lt;OgreNewt_Tools.h&gt;
+#include &quot;OgreNewt_CollisionPrimitives.h&quot;
+#include &quot;OgreNewt_Tools.h&quot;
 
 #include &quot;Ogre.h&quot;
 

Modified: dependencies/OgreNewt_ngt/src/OgreNewt_CollisionSerializer.cpp
===================================================================
--- dependencies/OgreNewt_ngt/src/OgreNewt_CollisionSerializer.cpp	2009-01-28 19:18:55 UTC (rev 4727)
+++ dependencies/OgreNewt_ngt/src/OgreNewt_CollisionSerializer.cpp	2009-01-30 22:13:30 UTC (rev 4728)
@@ -1,5 +1,5 @@
-#include &lt;OgreNewt_CollisionSerializer.h&gt;
-#include &lt;OgreNewt_Collision.h&gt;
+#include &quot;OgreNewt_CollisionSerializer.h&quot;
+#include &quot;OgreNewt_Collision.h&quot;
 
 #include &quot;Ogre.h&quot;
 

Deleted: dependencies/OgreNewt_ngt/src/OgreNewt_ContactCallback.cpp
===================================================================
--- dependencies/OgreNewt_ngt/src/OgreNewt_ContactCallback.cpp	2009-01-28 19:18:55 UTC (rev 4727)
+++ dependencies/OgreNewt_ngt/src/OgreNewt_ContactCallback.cpp	2009-01-30 22:13:30 UTC (rev 4728)
@@ -1,109 +0,0 @@
-#include &lt;OgreNewt_ContactCallback.h&gt;
-#include &lt;OgreNewt_Body.h&gt;
-
-
-namespace OgreNewt
-{
-
-	
-ContactCallback::ContactCallback()
-{
-
-}
-
-ContactCallback::~ContactCallback()
-{
-}
-
-int _CDECL ContactCallback::onAABBOverlap( const NewtonMaterial* material, const NewtonBody* body0, const NewtonBody* body1, int threadIndex )
-{
-	ContactCallback* me;
-
-	me = (ContactCallback*)NewtonMaterialGetMaterialPairUserData( material );
-
-	me-&gt;m_material = (NewtonMaterial*)material;
-
-	//save the bodies...
-	me-&gt;m_body0 = (OgreNewt::Body*)NewtonBodyGetUserData( body0 );
-	me-&gt;m_body1 = (OgreNewt::Body*)NewtonBodyGetUserData( body1 );
-
-	return me-&gt;onAABBOverlap( threadIndex );
-}
-
-void _CDECL ContactCallback::contactProcess(const NewtonJoint *contactJoint, float timeStep, int threadIndex )
-{
-/*    // pruefe ob nur TriggerVolume - funktioniert mit aktuellem newton noch nicht
-    if( NewtonCollisionIsTriggerVolume(NewtonBodyGetCollision(NewtonJointGetBody1(contactJoint))) ||
-        NewtonCollisionIsTriggerVolume(NewtonBodyGetCollision(NewtonJointGetBody1(contactJoint))) )
-    {
-	    ContactCallback *me = (ContactCallback*)NewtonJointGetUserData(contactJoint);
-        me-&gt;m_material = NULL;
-        me-&gt;m_body0 = (OgreNewt::Body*)NewtonBodyGetUserData( NewtonJointGetBody0(contactJoint) );
-    	me-&gt;m_body1 = (OgreNewt::Body*)NewtonBodyGetUserData( NewtonJointGetBody1(contactJoint) );
-        me-&gt;contactProcess( (Ogre::Real)timeStep, threadIndex );
-
-        return;
-    }
-*/
-bool test = false;
-        for (void* contact = NewtonContactJointGetFirstContact (contactJoint); contact; contact = NewtonContactJointGetNextContact (contactJoint, contact))
-        {
-	        ContactCallback *me;
-                NewtonMaterial* material = NewtonContactGetMaterial(contact);
-
-                me = (ContactCallback*)NewtonMaterialGetMaterialPairUserData( material );
-
-                me-&gt;m_material = material;
-                me-&gt;m_body0 = (OgreNewt::Body*)NewtonBodyGetUserData( NewtonJointGetBody0(contactJoint) );
-	        me-&gt;m_body1 = (OgreNewt::Body*)NewtonBodyGetUserData( NewtonJointGetBody1(contactJoint) );
-
-	        // call the user-defined callback function!
-	        if( !me-&gt;contactProcess( (Ogre::Real)timeStep, threadIndex ) )
-                {
-                    NewtonContactJointRemoveContact(contactJoint, contact);
-                }
-        }
-}
-
-/*
-void _CDECL ContactCallback::contactEnd( const NewtonMaterial* material, const NewtonBody* body0, const NewtonBody* body1, int threadIndex )
-{
-	ContactCallback* me;
-
-	me = (ContactCallback*)NewtonMaterialGetMaterialPairUserData( material );
-
-	me-&gt;m_material = (NewtonMaterial*)material;
-	me-&gt;m_body0 = (OgreNewt::Body*)NewtonBodyGetUserData( body0 );
-	me-&gt;m_body1 = (OgreNewt::Body*)NewtonBodyGetUserData( body1 );
-
-	me-&gt;userEnd( threadIndex );
-}
-*/
-
-
-
-
-Ogre::Vector3 ContactCallback::getContactForce() const 
-{
-	Ogre::Vector3 force;
-	NewtonMaterialGetContactForce( m_material, &amp;force.x );
-	return force;
-}
-
-
-void ContactCallback::getContactPositionAndNormal( Ogre::Vector3&amp; pos, Ogre::Vector3&amp; norm ) const 
-{
-	NewtonMaterialGetContactPositionAndNormal( m_material, &amp;pos.x, &amp;norm.x );
-}
-
-
-void ContactCallback::getContactTangentDirections( Ogre::Vector3&amp; dir0, Ogre::Vector3&amp; dir1 ) const 
-{
-	NewtonMaterialGetContactTangentDirections( m_material, &amp;dir0.x, &amp;dir1.x );
-}
-
-
-
-
-
-}

Added: dependencies/OgreNewt_ngt/src/OgreNewt_ContactJoint.cpp
===================================================================
--- dependencies/OgreNewt_ngt/src/OgreNewt_ContactJoint.cpp	2009-01-28 19:18:55 UTC (rev 4727)
+++ dependencies/OgreNewt_ngt/src/OgreNewt_ContactJoint.cpp	2009-01-30 22:13:30 UTC (rev 4728)
@@ -0,0 +1,71 @@
+#include &quot;OgreNewt_ContactJoint.h&quot;
+#include &quot;OgreNewt_World.h&quot;
+
+
+namespace OgreNewt
+{
+
+
+ContactJoint::ContactJoint(const NewtonJoint* contactJoint)
+{
+    m_contactjoint = contactJoint;
+}
+
+
+ContactJoint::~ContactJoint()
+{
+}
+
+
+Contact ContactJoint::getFirstContact()
+{
+    Contact contact(NewtonContactJointGetFirstContact(m_contactjoint), this);
+    return contact;
+}
+
+
+MaterialPair* ContactJoint::getMaterialPair()
+{
+    Body* body0 = getBody0();
+    Body* body1 = getBody1();
+    const World* world = body0-&gt;getWorld();
+
+    return (MaterialPair*) NewtonMaterialGetUserData(world-&gt;getNewtonWorld(), body0-&gt;getMaterialGroupID()-&gt;getID(), body1-&gt;getMaterialGroupID()-&gt;getID());
+}
+
+
+
+Contact::Contact(void* contact, ContactJoint* parent)
+{
+    m_parent = parent;
+    m_contact = contact;
+    m_material = NULL;
+    if( contact )
+    {
+        m_material = NewtonContactGetMaterial(contact);
+    }
+}
+
+Contact Contact::getNext() const
+{
+    Contact contact( NewtonContactJointGetNextContact(m_parent-&gt;_getNewtonContactJoint(), m_contact), m_parent);
+    return contact;
+}
+
+Ogre::Vector3 Contact::getContactForce() const 
+{
+	Ogre::Vector3 force;
+	NewtonMaterialGetContactForce( m_material, &amp;force.x );
+	return force;
+}
+
+void Contact::remove()
+{
+    NewtonContactJointRemoveContact(m_parent-&gt;_getNewtonContactJoint(), m_contact);
+    m_parent = NULL;
+    m_material = NULL;
+    m_contact = NULL;
+}
+
+
+}

Modified: dependencies/OgreNewt_ngt/src/OgreNewt_Debugger.cpp
===================================================================
--- dependencies/OgreNewt_ngt/src/OgreNewt_Debugger.cpp	2009-01-28 19:18:55 UTC (rev 4727)
+++ dependencies/OgreNewt_ngt/src/OgreNewt_Debugger.cpp	2009-01-30 22:13:30 UTC (rev 4728)
@@ -1,4 +1,7 @@
 #include &quot;OgreNewt_Debugger.h&quot;
+#include &quot;OgreNewt_World.h&quot;
+#include &quot;OgreNewt_Body.h&quot;
+#include &quot;OgreNewt_Collision.h&quot;
 #include &lt;sstream&gt;
 
 namespace OgreNewt
@@ -36,7 +39,6 @@
     if( !m_debugnode )
     {
         m_debugnode = smgr-&gt;getRootSceneNode()-&gt;createChildSceneNode(&quot;__OgreNewt__Debugger__Node__&quot;);
-        //m_debuglines = new Ogre::ManualObject(&quot;__OgreNewt__Debugger__Lines__&quot;);
     }
 
     if( !m_raycastsnode )
@@ -78,8 +80,11 @@
     m_debugnode-&gt;removeAllChildren();
 
     // make the new lines.
-    for( const NewtonBody* body = NewtonWorldGetFirstBody(world-&gt;getNewtonWorld()); body; body = NewtonWorldGetNextBody(world-&gt;getNewtonWorld(), body) )
-        newtonPerBody(body);
+    for( Body* body = world-&gt;getFirstBody(); body; body = body-&gt;getNext() )
+    {
+        processBody(body);
+    }
+        
 
 
     // delete old entries
@@ -115,14 +120,12 @@
     m_defaultcolor = col;
 }
 
-void _CDECL Debugger::newtonPerBody( const NewtonBody* body )
+void Debugger::processBody( OgreNewt::Body* bod )
 {
-    Debugger&amp; debugger (Debugger::getSingleton());
-    MaterialIdColorMap::iterator it = 
-        debugger.m_materialcolors.find( NewtonBodyGetMaterialGroupID(body) );
+    NewtonBody* newtonBody = bod-&gt;getNewtonBody();
+    MaterialIdColorMap::iterator it = m_materialcolors.find( NewtonBodyGetMaterialGroupID(newtonBody) );
 
 
-    Body *bod = (OgreNewt::Body*)NewtonBodyGetUserData(body);
     Ogre::Vector3 pos;
     Ogre::Quaternion ori;
     bod-&gt;getPositionOrientation(pos, ori);
@@ -175,7 +178,7 @@
         else
         {
             std::ostringstream oss;
-            oss &lt;&lt; &quot;__OgreNewt__Debugger__Lines__&quot; &lt;&lt; body &lt;&lt; &quot;__&quot;;
+            oss &lt;&lt; &quot;__OgreNewt__Debugger__Lines__&quot; &lt;&lt; bod &lt;&lt; &quot;__&quot;;
             data-&gt;m_lines = new Ogre::ManualObject(oss.str());
         }
 
@@ -197,15 +200,15 @@
         data-&gt;m_lines-&gt;begin(&quot;BaseWhiteNoLighting&quot;, Ogre::RenderOperation::OT_LINE_LIST );
 
         // set color
-        if( it != debugger.m_materialcolors.end() )
+        if( it != m_materialcolors.end() )
             data-&gt;m_lines-&gt;colour(it-&gt;second);
         else
-            data-&gt;m_lines-&gt;colour(debugger.m_defaultcolor);
+            data-&gt;m_lines-&gt;colour(m_defaultcolor);
 
         float matrix[16];
         Converters::QuatPosToMatrix(Ogre::Quaternion::IDENTITY, Ogre::Vector3::ZERO, &amp;matrix[0]);
         
-        NewtonCollisionForEachPolygonDo( NewtonBodyGetCollision(body), &amp;matrix[0], newtonPerPoly, data-&gt;m_lines );
+        NewtonCollisionForEachPolygonDo( NewtonBodyGetCollision(newtonBody), &amp;matrix[0], newtonPerPoly, data-&gt;m_lines );
         
         data-&gt;m_lines-&gt;end();
         data-&gt;m_node-&gt;attachObject(data-&gt;m_lines);

Modified: dependencies/OgreNewt_ngt/src/OgreNewt_Joint.cpp
===================================================================
--- dependencies/OgreNewt_ngt/src/OgreNewt_Joint.cpp	2009-01-28 19:18:55 UTC (rev 4727)
+++ dependencies/OgreNewt_ngt/src/OgreNewt_Joint.cpp	2009-01-30 22:13:30 UTC (rev 4728)
@@ -1,5 +1,7 @@
-#include &lt;assert.h&gt;
-#include &lt;OgreNewt_Joint.h&gt;
+/*  #include &lt;assert.h&gt;  why do we need this here? */
+#include &quot;OgreNewt_Joint.h&quot;
+#include &quot;OgreNewt_Body.h&quot;
+#include &quot;OgreNewt_World.h&quot;
 
 
 namespace OgreNewt

Modified: dependencies/OgreNewt_ngt/src/OgreNewt_MaterialID.cpp
===================================================================
--- dependencies/OgreNewt_ngt/src/OgreNewt_MaterialID.cpp	2009-01-28 19:18:55 UTC (rev 4727)
+++ dependencies/OgreNewt_ngt/src/OgreNewt_MaterialID.cpp	2009-01-30 22:13:30 UTC (rev 4728)
@@ -1,5 +1,5 @@
-#include &lt;OgreNewt_MaterialID.h&gt;
-#include &lt;OgreNewt_World.h&gt;
+#include &quot;OgreNewt_MaterialID.h&quot;
+#include &quot;OgreNewt_World.h&quot;
 
 namespace OgreNewt
 {

Modified: dependencies/OgreNewt_ngt/src/OgreNewt_MaterialPair.cpp
===================================================================
--- dependencies/OgreNewt_ngt/src/OgreNewt_MaterialPair.cpp	2009-01-28 19:18:55 UTC (rev 4727)
+++ dependencies/OgreNewt_ngt/src/OgreNewt_MaterialPair.cpp	2009-01-30 22:13:30 UTC (rev 4728)
@@ -1,6 +1,5 @@
-#include &lt;OgreNewt_MaterialPair.h&gt;
-#include &lt;OgreNewt_World.h&gt;
-#include &lt;OgreNewt_MaterialID.h&gt;
+#include &quot;OgreNewt_MaterialPair.h&quot;
+#include &quot;OgreNewt_ContactJoint.h&quot;
 
 namespace OgreNewt
 {
@@ -11,6 +10,7 @@
 	m_world = world;
 	id0 = mat1;
 	id1 = mat2;
+    m_contactcallback = NULL;
 }
 
 MaterialPair::~MaterialPair()
@@ -20,13 +20,67 @@
 
 void MaterialPair::setContactCallback( OgreNewt::ContactCallback* callback )
 {
-	// set the material callbacks to the functions inside the ContactCallback class.
-	NewtonMaterialSetCollisionCallback( m_world-&gt;getNewtonWorld(), id0-&gt;getID(), id1-&gt;getID(), callback,
-		callback-&gt;onAABBOverlap,
-		callback-&gt;contactProcess);
+    m_contactcallback = callback;
+    if( callback )
+    {
+	    NewtonMaterialSetCollisionCallback( m_world-&gt;getNewtonWorld(), id0-&gt;getID(), id1-&gt;getID(), this,
+		    collisionCallback_onAABBOverlap,
+    		collisionCallback_contactsProcess);
+    }
+    else
+    {
+	    NewtonMaterialSetCollisionCallback( m_world-&gt;getNewtonWorld(), id0-&gt;getID(), id1-&gt;getID(), NULL,
+		    NULL,
+    		NULL);
+    }
 }
 
 
+int _CDECL MaterialPair::collisionCallback_onAABBOverlap( const NewtonMaterial* material, const NewtonBody* newtonBody0, const NewtonBody* newtonBody1, int threadIndex )
+{
+    MaterialPair* me;
+	me = (MaterialPair*)NewtonMaterialGetMaterialPairUserData( material );
 
+	Body* body0 = (OgreNewt::Body*)NewtonBodyGetUserData( newtonBody0 );
+	Body* body1 = (OgreNewt::Body*)NewtonBodyGetUserData( newtonBody1 );
+
+	return me-&gt;m_contactcallback-&gt;onAABBOverlap( body0, body1, threadIndex );
 }
 
+void _CDECL MaterialPair::collisionCallback_contactsProcess(const NewtonJoint *newtonContactJoint, float timestep, int threadIndex )
+{
+    ContactJoint contactJoint(newtonContactJoint);
+
+    MaterialPair* me = contactJoint.getMaterialPair();
+    
+    if( me != NULL )
+    {
+        ( me-&gt;m_contactcallback-&gt;contactsProcess )(contactJoint, timestep, threadIndex);
+    }
+
+    /*
+     // OLD CODE!
+        for (void* contact = NewtonContactJointGetFirstContact (contactJoint); contact; contact = NewtonContactJointGetNextContact (contactJoint, contact))
+        {
+	        ContactCallback *me;
+                NewtonMaterial* material = NewtonContactGetMaterial(contact);
+
+                me = (ContactCallback*)NewtonMaterialGetMaterialPairUserData( material );
+
+                me-&gt;m_material = material;
+                me-&gt;m_body0 = (OgreNewt::Body*)NewtonBodyGetUserData( NewtonJointGetBody0(contactJoint) );
+	        me-&gt;m_body1 = (OgreNewt::Body*)NewtonBodyGetUserData( NewtonJointGetBody1(contactJoint) );
+
+	        // call the user-defined callback function!
+	        if( !me-&gt;contactProcess( (Ogre::Real)timeStep, threadIndex ) )
+                {
+                    NewtonContactJointRemoveContact(contactJoint, contact);
+                }
+        }
+    */
+
+}
+
+
+}
+

Modified: dependencies/OgreNewt_ngt/src/OgreNewt_PlayerController.cpp
===================================================================
--- dependencies/OgreNewt_ngt/src/OgreNewt_PlayerController.cpp	2009-01-28 19:18:55 UTC (rev 4727)
+++ dependencies/OgreNewt_ngt/src/OgreNewt_PlayerController.cpp	2009-01-30 22:13:30 UTC (rev 4728)
@@ -1,6 +1,8 @@
-#include &lt;OgreNewt_PlayerController.h&gt;
-#include &lt;OgreNewt_Tools.h&gt;
-#include &lt;OgreNewt_CollisionPrimitives.h&gt;
+#include &quot;OgreNewt_PlayerController.h&quot;
+#include &quot;OgreNewt_Tools.h&quot;
+#include &quot;OgreNewt_Collision.h&quot;
+#include &quot;OgreNewt_CollisionPrimitives.h&quot;
+#include &quot;OgreNewt_World.h&quot;
 
 namespace OgreNewt
 {
@@ -15,7 +17,7 @@
     m_heading = Ogre::Radian(0);
     Ogre::Real playerHeight, playerRadius;
     getPlayerHeightAndRadius(playerHeight, playerRadius);
-    m_maxStepHeight = playerHeight / 5;
+    m_maxStepHeight = playerHeight / 4;
     m_maxSlope = Ogre::Degree(45);
     m_restitution = 0;
     m_upVector = Ogre::Vector3::UNIT_Y;
@@ -173,6 +175,15 @@
 }
 
 
+void PlayerController::setVelocity(Ogre::Real forwardSpeed, Ogre::Real sideSpeed, Ogre::Degree heading)
+{
+    m_forwardSpeed = forwardSpeed;
+    m_sideSpeed = sideSpeed;
+    m_heading = heading;
+    m_body-&gt;unFreeze();
+}
+
+
 void PlayerController::submitConstraint( Ogre::Real timestep, int threadindex )
 {
 
@@ -190,46 +201,80 @@
     omega = m_body-&gt;getOmega();
     torqueAcc = m_body-&gt;getTorqueAcceleration();
 
-    // ----------- &quot;up-vector-pin&quot; -----------
-    // get the plane of rotation
-    Ogre::Vector3 oriChangeVec;
-    Ogre::Radian oriChangeAngle;
-    Ogre::Quaternion oriDiffFromLast = (ori * m_lastOri.Inverse());
-    oriDiffFromLast.ToAngleAxis(oriChangeAngle, oriChangeVec);
-    if( abs(oriChangeAngle.valueRadians()) &gt; 1.0e-3 )
-    {
-        // correct angle
-        addAngularRow(oriChangeAngle, oriChangeVec);
 
-        // additional correction, see newton CustomPlayerController
-        Ogre::Vector3 frontDir = ori*oriChangeVec;
-        addAngularRow(Ogre::Radian(0.0f), oriChangeVec);
-    }
+    // ----- &quot;up vector joint&quot; -----
+    Ogre::Quaternion yawOri;
+    yawOri.FromAngleAxis(ori.getYaw(), Ogre::Vector3::UNIT_Y);
+    Ogre::Vector3 yawX = yawOri * Ogre::Vector3::UNIT_X;
+    Ogre::Vector3 yawZ = yawOri * Ogre::Vector3::UNIT_Z;
+    Ogre::Radian relAngleErrorX, relAngleErrorZ;
+    Ogre::Vector3 dirErrorX, dirErrorZ;
+    ori.xAxis().getRotationTo(yawX, yawZ).ToAngleAxis(relAngleErrorX, dirErrorX);
+    ori.zAxis().getRotationTo(yawZ, yawX).ToAngleAxis(relAngleErrorZ, dirErrorZ);
+    if( abs(relAngleErrorX.valueRadians()) &lt; 0.001f )
+        addAngularRow(Ogre::Radian(0.0f), yawZ);
     else
-    {
-        addAngularRow(Ogre::Radian(0.0f), ori.yAxis());
-        addAngularRow(Ogre::Radian(0.0f), ori.xAxis());
-    }
+        addAngularRow(relAngleErrorX, dirErrorX);
+    if( abs(relAngleErrorZ.valueRadians()) &lt; 0.001f )
+        addAngularRow(Ogre::Radian(0.0f), yawX);
+    else
+        addAngularRow(relAngleErrorZ, dirErrorZ);
 
+
     // ----------- calculate torque -----------
     Ogre::Quaternion targetOri;
     targetOri.FromAngleAxis(m_heading, Ogre::Vector3::UNIT_Y);
-    Ogre::Quaternion oriDiff = (targetOri * ori.Inverse());
-    Ogre::Real turnOmega  = oriDiff.getYaw().valueRadians() / timestep;
-    torqueAcc = ori.yAxis() * (torqueAcc.dotProduct(ori.yAxis()));
-    Ogre::Vector3 torque = ori.yAxis() * (turnOmega - omega.y * inertia.y/timestep - torqueAcc.y);
+    Ogre::Radian yawDiff = ((ori*Ogre::Vector3::UNIT_Z).getRotationTo(targetOri*Ogre::Vector3::UNIT_Z)).getYaw();
+    Ogre::Real turnOmega = yawDiff.valueRadians() / timestep;
+    Ogre::Vector3 torque = Ogre::Vector3::UNIT_Y * ((turnOmega - omega.y) * inertia.y/timestep - torqueAcc.y);
     m_body-&gt;addTorque(torque);
 
 
 
     // ----------- find floor -----------
-    Ogre::Vector3 p1 = pos - Ogre::Vector3::UNIT_Y*m_lastPlayerHeight;
-    FindFloorRaycast findFloorCast(this, pos, p1, true);
+    //! perhaps calculate SLOPE differently, a convexcast with a rotated box should do it, but we'll see if it is needed!
+    Ogre::Vector3 findFloorCastP1 = pos - Ogre::Vector3::UNIT_Y*m_maxStepHeight;
+    // go a bit up from current position
+    Ogre::Vector3 findFloorCastP0 = pos + Ogre::Vector3::UNIT_Y*m_maxStepHeight;
+    FindFloorRaycast findFloorCast(this, findFloorCastP0, findFloorCastP1, true);
     if( findFloorCast.getHitCount() &gt; 0 )
     {
         // slope:
-        if( Ogre::Math::ACos(findFloorCast.getFirstHit().mNormal.y) &gt; m_maxSlope )
+        if( Ogre::Math::ASin(findFloorCast.getFirstHit().mNormal.y) &lt; m_maxSlope )
+        {
+            // try some more raycasts...
+            FindFloorRaycast findFloorCast_0(this, findFloorCastP0+0.1*Ogre::Vector3::UNIT_X, findFloorCastP1+0.1*Ogre::Vector3::UNIT_X, true);
+            FindFloorRaycast findFloorCast_1(this, findFloorCastP0-0.1*Ogre::Vector3::UNIT_X, findFloorCastP1-0.1*Ogre::Vector3::UNIT_X, true);
+            FindFloorRaycast findFloorCast_2(this, findFloorCastP0+0.1*Ogre::Vector3::UNIT_Z, findFloorCastP1+0.1*Ogre::Vector3::UNIT_Z, true);
+            FindFloorRaycast findFloorCast_3(this, findFloorCastP0-0.1*Ogre::Vector3::UNIT_Z, findFloorCastP1-0.1*Ogre::Vector3::UNIT_Z, true);
+            if( findFloorCast_0.getHitCount() &gt; 0 &amp;&amp; Ogre::Math::ASin(findFloorCast_0.getFirstHit().mNormal.y) &lt; m_maxSlope )
+            {
+                findFloorCastP0 += 0.1*Ogre::Vector3::UNIT_X;
+                findFloorCastP1 += 0.1*Ogre::Vector3::UNIT_X;
+                findFloorCast = findFloorCast_0;
+            }
+            else if( findFloorCast_1.getHitCount() &gt; 0 &amp;&amp; Ogre::Math::ASin(findFloorCast_1.getFirstHit().mNormal.y) &lt; m_maxSlope )
+            {
+                findFloorCastP0 -= 0.1*Ogre::Vector3::UNIT_X;
+                findFloorCastP1 -= 0.1*Ogre::Vector3::UNIT_X;
+                findFloorCast = findFloorCast_1;
+            }
+            else if( findFloorCast_2.getHitCount() &gt; 0 &amp;&amp; Ogre::Math::ASin(findFloorCast_2.getFirstHit().mNormal.y) &lt; m_maxSlope )
+            {
+                findFloorCastP0 += 0.1*Ogre::Vector3::UNIT_Z;
+                findFloorCastP1 += 0.1*Ogre::Vector3::UNIT_Z;
+                findFloorCast = findFloorCast_2;
+            }
+            else if( findFloorCast_3.getHitCount() &gt; 0 &amp;&amp; Ogre::Math::ASin(findFloorCast_3.getFirstHit().mNormal.y) &lt; m_maxSlope )
+            {
+                findFloorCastP0 -= 0.1*Ogre::Vector3::UNIT_Z;
+                findFloorCastP1 -= 0.1*Ogre::Vector3::UNIT_Z;
+                findFloorCast = findFloorCast_3;
+            }
+        }
         
+        if( Ogre::Math::ASin(findFloorCast.getFirstHit().mNormal.y) &gt; m_maxSlope )
+        
         {
             // desired velocity
             Ogre::Vector3 desiredVel = ori*(Ogre::Vector3::UNIT_Z * m_forwardSpeed + Ogre::Vector3::UNIT_Y*vel.y + Ogre::Vector3::UNIT_X * m_sideSpeed);
@@ -242,7 +287,7 @@
             {
 
                 // hit-body:
-                Ogre::Vector3 hitPoint = pos + (p1-pos) * findFloorCast.getFirstHit().mDistance;
+                Ogre::Vector3 hitPoint = findFloorCastP0 + (findFloorCastP1-findFloorCastP0) * findFloorCast.getFirstHit().mDistance;
                 Ogre::Vector3 hitOmega = findFloorCast.getFirstHit().mBody-&gt;getOmega();
                 Ogre::Vector3 hitVel = findFloorCast.getFirstHit().mBody-&gt;getVelocity();
                 Ogre::Vector3 hitPos;
@@ -255,10 +300,20 @@
 
 
 
+            // look ahead for obstacles in along the horizontal of the desired velocity
+            Ogre::Vector3 horizontalDesiredVel = desiredVel;
+            horizontalDesiredVel.y = 0;
 
 
+
+
+
             // calculate force needed for desired velocity
-//            m_body-&gt;
+            Ogre::Vector3 force = m_body-&gt;calculateInverseDynamicsForce(timestep, horizontalDesiredVel);
+            Ogre::Vector3 forceAcc = m_body-&gt;getForceAcceleration();
+            force -= forceAcc;
+            force.y = 0;
+            m_body-&gt;addForce(force);
 
         }
     }

Modified: dependencies/OgreNewt_ngt/src/OgreNewt_RayCast.cpp
===================================================================
--- dependencies/OgreNewt_ngt/src/OgreNewt_RayCast.cpp	2009-01-28 19:18:55 UTC (rev 4727)
+++ dependencies/OgreNewt_ngt/src/OgreNewt_RayCast.cpp	2009-01-30 22:13:30 UTC (rev 4728)
@@ -1,6 +1,8 @@
 #include &quot;OgreNewt_RayCast.h&quot;
 #include &quot;OgreNewt_Tools.h&quot;
 #include &quot;OgreNewt_Debugger.h&quot;
+#include &quot;OgreNewt_World.h&quot;
+#include &quot;OgreNewt_Collision.h&quot;
 
 
 namespace OgreNewt

Modified: dependencies/OgreNewt_ngt/src/OgreNewt_Tools.cpp
===================================================================
--- dependencies/OgreNewt_ngt/src/OgreNewt_Tools.cpp	2009-01-28 19:18:55 UTC (rev 4727)
+++ dependencies/OgreNewt_ngt/src/OgreNewt_Tools.cpp	2009-01-30 22:13:30 UTC (rev 4728)
@@ -1,4 +1,7 @@
 #include &quot;OgreNewt_Tools.h&quot;
+#include &quot;OgreNewt_World.h&quot;
+#include &quot;OgreNewt_Body.h&quot;
+#include &quot;OgreNewt_Collision.h&quot;
 #include &lt;iostream&gt;
 #include &lt;OgreFontManager.h&gt;
 

Modified: dependencies/OgreNewt_ngt/src/OgreNewt_Vehicle.cpp
===================================================================
--- dependencies/OgreNewt_ngt/src/OgreNewt_Vehicle.cpp	2009-01-28 19:18:55 UTC (rev 4727)
+++ dependencies/OgreNewt_ngt/src/OgreNewt_Vehicle.cpp	2009-01-30 22:13:30 UTC (rev 4728)
@@ -1,5 +1,5 @@
-#include &lt;OgreNewt_Vehicle.h&gt;
-#include &lt;OgreNewt_Tools.h&gt;
+#include &quot;OgreNewt_Vehicle.h&quot;
+#include &quot;OgreNewt_Tools.h&quot;
 
 namespace OgreNewt
 {

Modified: dependencies/OgreNewt_ngt/src/OgreNewt_World.cpp
===================================================================
--- dependencies/OgreNewt_ngt/src/OgreNewt_World.cpp	2009-01-28 19:18:55 UTC (rev 4727)
+++ dependencies/OgreNewt_ngt/src/OgreNewt_World.cpp	2009-01-30 22:13:30 UTC (rev 4728)
@@ -1,7 +1,5 @@
-#include &lt;OgreNewt_World.h&gt;
-#include &lt;OgreNewt_Body.h&gt;
-#include &lt;OgreNewt_MaterialID.h&gt;
-#include &lt;OgreNewt_Tools.h&gt;
+#include &quot;OgreNewt_World.h&quot;
+#include &quot;OgreNewt_MaterialID.h&quot;
 
 namespace OgreNewt
 {
@@ -80,6 +78,16 @@
 	}
 }
 
+Body* World::getFirstBody()
+{
+    NewtonBody* body = NewtonWorldGetFirstBody( m_world );
+    if( body )
+        return (Body*) NewtonBodyGetUserData(body);
+
+    return NULL;
+}
+
+
 // -------------------------------------------------------------------------------------------------------------
 // -------------------------------------------------------------------------------------------------------------
 // -------------------------------------------------------------------------------------------------------------


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001784.html">[Dsa-hl-svn] r4727 - in rl/branches/persistence: ai common	common/include core core/include core/include/fmod4driver	core/src core/src/fmod4driver rules script ui ui/include ui/src
</A></li>
	<LI>Next message: <A HREF="001786.html">[Dsa-hl-svn] r4729 - in dependencies/OgreNewt_ngt: . inc src
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1785">[ date ]</a>
              <a href="thread.html#1785">[ thread ]</a>
              <a href="subject.html#1785">[ subject ]</a>
              <a href="author.html#1785">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/dsa-hl-svn">More information about the Dsa-hl-svn
mailing list</a><br>
</body></html>
