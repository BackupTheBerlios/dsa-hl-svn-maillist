<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Dsa-hl-svn] r4367 - in rl/trunk/engine: ai/include ai/src	common/include common/src core/include core/src rules/include	rules/src script/include script/src ui/src
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/dsa-hl-svn/2008-April/index.html" >
   <LINK REL="made" HREF="mailto:dsa-hl-svn%40lists.berlios.de?Subject=Re%3A%20%5BDsa-hl-svn%5D%20r4367%20-%20in%20rl/trunk/engine%3A%20ai/include%20ai/src%0A%09common/include%20common/src%20core/include%20core/src%20rules/include%0A%09rules/src%20script/include%20script/src%20ui/src&In-Reply-To=%3C200804292311.m3TNBNNH023937%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001437.html">
   <LINK REL="Next"  HREF="001439.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Dsa-hl-svn] r4367 - in rl/trunk/engine: ai/include ai/src	common/include common/src core/include core/src rules/include	rules/src script/include script/src ui/src</H1>
    <B>melven at mail.berlios.de</B> 
    <A HREF="mailto:dsa-hl-svn%40lists.berlios.de?Subject=Re%3A%20%5BDsa-hl-svn%5D%20r4367%20-%20in%20rl/trunk/engine%3A%20ai/include%20ai/src%0A%09common/include%20common/src%20core/include%20core/src%20rules/include%0A%09rules/src%20script/include%20script/src%20ui/src&In-Reply-To=%3C200804292311.m3TNBNNH023937%40sheep.berlios.de%3E"
       TITLE="[Dsa-hl-svn] r4367 - in rl/trunk/engine: ai/include ai/src	common/include common/src core/include core/src rules/include	rules/src script/include script/src ui/src">melven at mail.berlios.de
       </A><BR>
    <I>Wed Apr 30 01:11:23 CEST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="001437.html">[Dsa-hl-svn] r4366 - in rl/trunk/engine/rules: include src
</A></li>
        <LI>Next message: <A HREF="001439.html">[Dsa-hl-svn] r4368 - modules/common/dsa
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1440">[ date ]</a>
              <a href="thread.html#1440">[ thread ]</a>
              <a href="subject.html#1440">[ subject ]</a>
              <a href="author.html#1440">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: melven
Date: 2008-04-30 01:10:58 +0200 (Wed, 30 Apr 2008)
New Revision: 4367

Modified:
   rl/trunk/engine/ai/include/DialogManager.h
   rl/trunk/engine/ai/src/DialogManager.cpp
   rl/trunk/engine/ai/src/WayPointGraph.cpp
   rl/trunk/engine/common/include/Properties.h
   rl/trunk/engine/common/include/XmlProcessor.h
   rl/trunk/engine/common/include/XmlPropertyReader.h
   rl/trunk/engine/common/include/XmlPropertyWriter.h
   rl/trunk/engine/common/src/Properties.cpp
   rl/trunk/engine/common/src/XmlProcessor.cpp
   rl/trunk/engine/common/src/XmlPropertyReader.cpp
   rl/trunk/engine/common/src/XmlPropertyWriter.cpp
   rl/trunk/engine/core/include/MessagePump.h
   rl/trunk/engine/core/include/SaveGameFile.h
   rl/trunk/engine/core/include/SaveGameFileReader.h
   rl/trunk/engine/core/include/SaveGameManager.h
   rl/trunk/engine/core/include/SceneQuery.h
   rl/trunk/engine/core/include/TimeSource.h
   rl/trunk/engine/core/include/ZoneManager.h
   rl/trunk/engine/core/src/CoreSubsystem.cpp
   rl/trunk/engine/core/src/DotSceneLoader.cpp
   rl/trunk/engine/core/src/JobScheduler.cpp
   rl/trunk/engine/core/src/MessagePump.cpp
   rl/trunk/engine/core/src/PhysicalThing.cpp
   rl/trunk/engine/core/src/PhysicsManager.cpp
   rl/trunk/engine/core/src/SaveGameFileReader.cpp
   rl/trunk/engine/core/src/SaveGameFileWriter.cpp
   rl/trunk/engine/core/src/SaveGameManager.cpp
   rl/trunk/engine/core/src/SceneQuery.cpp
   rl/trunk/engine/core/src/TimeSource.cpp
   rl/trunk/engine/core/src/ZoneManager.cpp
   rl/trunk/engine/rules/include/GameObjectManager.h
   rl/trunk/engine/rules/include/GlobalProperties.h
   rl/trunk/engine/rules/include/Quest.h
   rl/trunk/engine/rules/src/Creature.cpp
   rl/trunk/engine/rules/src/DsaDataLoader.cpp
   rl/trunk/engine/rules/src/GameObjectManager.cpp
   rl/trunk/engine/rules/src/GlobalProperties.cpp
   rl/trunk/engine/rules/src/Quest.cpp
   rl/trunk/engine/rules/src/QuestBook.cpp
   rl/trunk/engine/script/include/MapLoader.h
   rl/trunk/engine/script/src/MapLoader.cpp
   rl/trunk/engine/script/src/TriggerFactory.cpp
   rl/trunk/engine/ui/src/CloseConfirmationWindow.cpp
   rl/trunk/engine/ui/src/InputManager.cpp
   rl/trunk/engine/ui/src/MovementControlState.cpp
   rl/trunk/engine/ui/src/PropertiesWindow.cpp
Log:
* several small fixes (includes in &quot;Xml*&quot;-files, ...)
* fixed various memory leaks
  - doc-&gt;release() should not be called any more after XmlProcessor::loadDocument(...)!
  - changed PropertyRecord* to PropertyRecordPtr (SharedPtr)
  i searched for memory leaks with a debugger and with these changes there are definitly fever
  memory leaks, even if there are still some left, most of them appear in swig now.
  



Modified: rl/trunk/engine/ai/include/DialogManager.h
===================================================================
--- rl/trunk/engine/ai/include/DialogManager.h	2008-04-29 22:41:45 UTC (rev 4366)
+++ rl/trunk/engine/ai/include/DialogManager.h	2008-04-29 23:10:58 UTC (rev 4367)
@@ -18,8 +18,6 @@
 
 #include &quot;AiPrerequisites.h&quot;
 
-#include &lt;xercesc/dom/DOMElement.hpp&gt;
-
 #include &quot;Properties.h&quot;
 #include &quot;SaveGameData.h&quot;
 #include &quot;XmlProcessor.h&quot;
@@ -71,6 +69,8 @@
         class DialogPrototype
         {
         public:
+            DialogPrototype();
+            ~DialogPrototype();
             void addOption(DialogOption* option);
             DialogOption* getOption(const CeGuiString&amp; id) const;
             void addResponse(DialogResponse* option);

Modified: rl/trunk/engine/ai/src/DialogManager.cpp
===================================================================
--- rl/trunk/engine/ai/src/DialogManager.cpp	2008-04-29 22:41:45 UTC (rev 4366)
+++ rl/trunk/engine/ai/src/DialogManager.cpp	2008-04-29 23:10:58 UTC (rev 4367)
@@ -115,7 +115,7 @@
                 = mDialogStates.begin(); it != mDialogStates.end(); ++it)
             {
                 PropertyMap curDialogProp;
-                PropertyRecord* dialogProps = it-&gt;second-&gt;getAllProperties();
+                PropertyRecordPtr dialogProps = it-&gt;second-&gt;getAllProperties();
                 curDialogProp[DialogManager::PROPERTY_DIALOG] = dialogProps-&gt;toPropertyMap();
                 curDialogProp[DialogManager::PROPERTY_DIALOG_NAME] = Property(it-&gt;first.getName());
 
@@ -128,8 +128,6 @@
                 }
 
                 curDialogProp[DialogManager::PROPERTY_NPCS] = Property(npcs);
-
-                delete dialogProps;
             }
 
             return Property(vec);
@@ -154,17 +152,16 @@
     {
         LOG_MESSAGE(Logger::RULES, &quot;Saving dialogs&quot;);
 
-        PropertyRecord* set = getAllProperties();
+        PropertyRecordPtr set = getAllProperties();
         writer-&gt;writeEachProperty(this, set-&gt;toPropertyMap());
-        delete set;
     }
 
     void DialogManager::readData(SaveGameFileReader* reader)
     {
         LOG_MESSAGE(Logger::RULES, &quot;Loading dialogs&quot;);
 
-        PropertyRecord properties = reader-&gt;getAllPropertiesAsRecord(this);
-        setProperties(&amp;properties);
+        PropertyRecordPtr properties = reader-&gt;getAllPropertiesAsRecord(this);
+        setProperties(properties);
     }
 
     int DialogManager::getPriority() const
@@ -647,6 +644,23 @@
 		return dialog;
     }
 
+    DialogManager::DialogPrototype::DialogPrototype()
+    {
+    }
+
+    DialogManager::DialogPrototype::~DialogPrototype()
+    {
+        std::map&lt;CeGuiString, DialogOption*&gt;::iterator it;
+        for( it = mOptionCache.begin(); it != mOptionCache.end(); it++ )
+            if( it-&gt;second != NULL )
+                delete it-&gt;second;
+
+        std::map&lt;CeGuiString, DialogResponse*&gt;::iterator it1;
+        for( it1 = mResponseCache.begin(); it1 != mResponseCache.end(); it1++ )
+            if( it1-&gt;second != NULL )
+                delete it1-&gt;second;
+    }
+
     void DialogManager::DialogPrototype::addOption(DialogOption* option)
     {
         if (mOptionCache.find(option-&gt;getId()) != mOptionCache.end())

Modified: rl/trunk/engine/ai/src/WayPointGraph.cpp
===================================================================
--- rl/trunk/engine/ai/src/WayPointGraph.cpp	2008-04-29 22:41:45 UTC (rev 4366)
+++ rl/trunk/engine/ai/src/WayPointGraph.cpp	2008-04-29 23:10:58 UTC (rev 4367)
@@ -152,8 +152,6 @@
                 addDirectedConnection(lookupTable[source], lookupTable[destination]);
             }
         }
-
-        doc-&gt;release();
     }
 
     shutdownXml();

Modified: rl/trunk/engine/common/include/Properties.h
===================================================================
--- rl/trunk/engine/common/include/Properties.h	2008-04-29 22:41:45 UTC (rev 4366)
+++ rl/trunk/engine/common/include/Properties.h	2008-04-29 23:10:58 UTC (rev 4367)
@@ -33,9 +33,9 @@
         virtual const Property getProperty(const CeGuiString&amp; key) const = 0;
         virtual void setProperty(const CeGuiString&amp; key, const Property&amp; value) = 0;
         void setPropertyAsString(const Ogre::String&amp; key, const CeGuiString&amp; value);
-        PropertyRecord* getAllProperties() const;
+        PropertyRecordPtr getAllProperties() const;
         virtual PropertyKeys getAllPropertyKeys() const = 0;
-        void setProperties(const PropertyRecord* props);
+        void setProperties(const PropertyRecordPtr props);
         void setProperties(const PropertyMap&amp; propmap);
     };
 
@@ -48,7 +48,7 @@
         typedef std::map&lt;const CeGuiString, Property&gt; PropertyRecordMap;
 
         PropertyRecord();
-        PropertyRecord(const PropertyRecord* ps);
+        PropertyRecord(const PropertyRecordPtr ps);
         PropertyRecord(const PropertyMap&amp; propmap);
 
         virtual const Property getProperty(const CeGuiString&amp; key) const;
@@ -59,7 +59,7 @@
         const PropertyRecordMap::const_iterator end() const;
         PropertyMap toPropertyMap() const;
         
-        PropertyRecord* getDifference(PropertyRecord* differenceTo) const;
+        PropertyRecordPtr getDifference(const PropertyRecordPtr differenceTo) const;
     private:
         PropertyRecordMap mProperties;
 	};
@@ -76,6 +76,9 @@
         void destroy() { Ogre::SharedPtr&lt;PropertyRecord&gt;::destroy(); }
     };
 
+
+    typedef std::vector&lt;PropertyRecordPtr&gt; PropertyRecordVector;
+
 }
 
 #endif //__Properties_H__

Modified: rl/trunk/engine/common/include/XmlProcessor.h
===================================================================
--- rl/trunk/engine/common/include/XmlProcessor.h	2008-04-29 22:41:45 UTC (rev 4366)
+++ rl/trunk/engine/common/include/XmlProcessor.h	2008-04-29 23:10:58 UTC (rev 4367)
@@ -17,7 +17,7 @@
 #ifndef __XmlHelper_h__
 #define __XmlHelper_h__
 
-#include &lt;xercesc/dom/DOMElement.hpp&gt;
+#include &lt;xercesc/dom/DOM.hpp&gt;
 #include &lt;xercesc/util/XMLChar.hpp&gt;
 #include &lt;xercesc/util/TransService.hpp&gt;
 #include &lt;xercesc/sax/ErrorHandler.hpp&gt;
@@ -39,11 +39,10 @@
 #else
 #   include &lt;CEGUI/CEGUIString.h&gt;
 #endif
-using XERCES_CPP_NAMESPACE::XMLTranscoder;
-using XERCES_CPP_NAMESPACE::XMLTransService;
-using XERCES_CPP_NAMESPACE::Attributes;
-using CEGUI::utf8;
-using CEGUI::String;
+namespace XERCES_CPP_NAMESPACE
+{
+    class XercesDOMParser;
+}
 
 namespace rl {
 
@@ -55,7 +54,8 @@
     : public XERCES_CPP_NAMESPACE::ErrorHandler
 {
 public:
-    
+    XmlProcessor() : mOpenParser(NULL) {}
+
     /**
 	 * Erzeugt einen Kindknoten eines DOM-Elements, das einen bestimmten Namen hat, 
 	 * dieser ist wiederum ein Element-Knoten
@@ -113,7 +113,7 @@
      * @param utf Der zu setzende UTF String
 	 * @return the DOM element node
 	 */
-	void setValueAsUtf8(XERCES_CPP_NAMESPACE::DOMDocument* doc, XERCES_CPP_NAMESPACE::DOMElement* element, utf8* value) const;
+	void setValueAsUtf8(XERCES_CPP_NAMESPACE::DOMDocument* doc, XERCES_CPP_NAMESPACE::DOMElement* element, CEGUI::utf8* value) const;
     
     /**
 	 * Ermittelt den Text eines Elementknotens, als UTF-8
@@ -123,7 +123,7 @@
 	 * @return Text innerhalb der Element-Tags, als utf8* (muss selbst gel&#246;scht werden)
 	 * @see initializeTranscoder()
 	 */
-	utf8* getValueAsUtf8(XERCES_CPP_NAMESPACE::DOMElement* element) const;
+	CEGUI::utf8* getValueAsUtf8(XERCES_CPP_NAMESPACE::DOMElement* element) const;
 
 	
     /**
@@ -509,13 +509,14 @@
         virtual void resetErrors();
 
 protected:
-	static XMLTranscoder* sTranscoder;
-	static XMLTransService::Codes sFailCode;
+	static XERCES_CPP_NAMESPACE::XMLTranscoder* sTranscoder;
+	static XERCES_CPP_NAMESPACE::XMLTransService::Codes sFailCode;
 
         std::string toString( const std::string&amp; type,
                               const XERCES_CPP_NAMESPACE::SAXParseException&amp; exc ) const;
         
         std::string mOpenXmlFileName;
+        XERCES_CPP_NAMESPACE::XercesDOMParser *mOpenParser;
 
 	/**
 	 * Konvertiert ein Xerces-XMLCh* in einen UTF-8-String
@@ -525,7 +526,7 @@
 	 * @return Konvertierter Text als utf8* (muss selbst gel&#246;scht werden)
 	 * @see initializeTranscoder()
 	 */
-	utf8* transcodeToUtf8(const XMLCh* const string16) const;
+	CEGUI::utf8* transcodeToUtf8(const XMLCh* const string16) const;
 };
 
 class _RlCommonExport AutoXMLCh

Modified: rl/trunk/engine/common/include/XmlPropertyReader.h
===================================================================
--- rl/trunk/engine/common/include/XmlPropertyReader.h	2008-04-29 22:41:45 UTC (rev 4366)
+++ rl/trunk/engine/common/include/XmlPropertyReader.h	2008-04-29 23:10:58 UTC (rev 4367)
@@ -22,6 +22,7 @@
 #include &lt;xercesc/dom/DOMAttr.hpp&gt;
 #include &lt;xercesc/dom/DOMElement.hpp&gt;
 
+#include &quot;Properties.h&quot;
 #include &quot;XmlProcessor.h&quot;
 
 namespace rl 
@@ -36,16 +37,17 @@
     {
     public:
         XmlPropertyReader();
+        virtual ~XmlPropertyReader();
 
         void parseGameObjectFile(Ogre::DataStreamPtr &amp;stream, const Ogre::String &amp;groupName);
-        std::vector&lt;PropertyRecord*&gt; getPropertyRecords();
+        PropertyRecordVector getPropertyRecords();
 
         PropertyEntry processProperty(XERCES_CPP_NAMESPACE::DOMElement* domElem) const;
 		PropertyEntry processProperty(XERCES_CPP_NAMESPACE::DOMAttr* domAttr) const;
 
-        virtual PropertyRecord getPropertiesAsRecord(XERCES_CPP_NAMESPACE::DOMElement* parent);
+        virtual PropertyRecordPtr getPropertiesAsRecord(XERCES_CPP_NAMESPACE::DOMElement* parent);
     private:
-        std::vector&lt;PropertyRecord*&gt; mPropertyRecords;
+        PropertyRecordVector mPropertyRecords;
 
         Property getProperty(const Ogre::String&amp; key, const CeGuiString&amp; value);
     };

Modified: rl/trunk/engine/common/include/XmlPropertyWriter.h
===================================================================
--- rl/trunk/engine/common/include/XmlPropertyWriter.h	2008-04-29 22:41:45 UTC (rev 4366)
+++ rl/trunk/engine/common/include/XmlPropertyWriter.h	2008-04-29 23:10:58 UTC (rev 4367)
@@ -23,7 +23,7 @@
 #include &lt;xercesc/dom/DOMAttr.hpp&gt;
 #include &lt;xercesc/dom/DOMElement.hpp&gt;
 
-#include &quot;Property.h&quot;
+#include &quot;Properties.h&quot;
 #include &quot;XmlProcessor.h&quot;
 
 namespace rl 
@@ -42,18 +42,18 @@
 
         XERCES_CPP_NAMESPACE::DOMDocument* getDocument();
 
-        std::vector&lt;PropertyRecord*&gt; getPropertyRecords();
-        void setPropertyRecords(std::vector&lt;PropertyRecord*&gt; sets);
-        void addPropertyRecord(PropertyRecord* set);
+        PropertyRecordPtr getPropertyRecords();
+        void setPropertyRecords(PropertyRecordVector sets);
+        void addPropertyRecord(PropertyRecordPtr set);
 
-        XERCES_CPP_NAMESPACE::DOMElement* processProperty(XERCES_CPP_NAMESPACE::DOMElement* parent, PropertyEntry entry);
-        XERCES_CPP_NAMESPACE::DOMElement* processPropertyRecord(XERCES_CPP_NAMESPACE::DOMElement* parent, const char* const name, PropertyRecord set);
-        XERCES_CPP_NAMESPACE::DOMElement* processPropertyArray(XERCES_CPP_NAMESPACE::DOMElement* parent, const char* const name, PropertyArray vector);
-        XERCES_CPP_NAMESPACE::DOMElement* processPropertyMap(XERCES_CPP_NAMESPACE::DOMElement* parent, const char* const name, PropertyMap map);
+        XERCES_CPP_NAMESPACE::DOMElement* processProperty(XERCES_CPP_NAMESPACE::DOMElement* parent, const PropertyEntry&amp; entry);
+        XERCES_CPP_NAMESPACE::DOMElement* processPropertyRecord(XERCES_CPP_NAMESPACE::DOMElement* parent, const char* const name, const PropertyRecord&amp; set);
+        XERCES_CPP_NAMESPACE::DOMElement* processPropertyArray(XERCES_CPP_NAMESPACE::DOMElement* parent, const char* const name, const PropertyArray&amp; vector);
+        XERCES_CPP_NAMESPACE::DOMElement* processPropertyMap(XERCES_CPP_NAMESPACE::DOMElement* parent, const char* const name, const PropertyMap&amp; map);
 
         void writeEachPropertyToElem(XERCES_CPP_NAMESPACE::DOMElement* parent, const PropertyMap &amp;map);
     protected:
-        std::vector&lt;PropertyRecord*&gt; mPropertyRecords;
+        PropertyRecordVector mPropertyRecords;
 
         XERCES_CPP_NAMESPACE::DOMDocument* mDocument;
         XERCES_CPP_NAMESPACE::DOMImplementation* mImplementation;

Modified: rl/trunk/engine/common/src/Properties.cpp
===================================================================
--- rl/trunk/engine/common/src/Properties.cpp	2008-04-29 22:41:45 UTC (rev 4366)
+++ rl/trunk/engine/common/src/Properties.cpp	2008-04-29 23:10:58 UTC (rev 4367)
@@ -25,7 +25,7 @@
 
 namespace rl {
 
-    void PropertyHolder::setProperties(const PropertyRecord* props)
+    void PropertyHolder::setProperties(const PropertyRecordPtr props)
     {
         for (PropertyRecord::PropertyRecordMap::const_iterator it = props-&gt;begin();
             it != props-&gt;end(); it++)
@@ -43,9 +43,9 @@
         }
     }
 
-    PropertyRecord* PropertyHolder::getAllProperties() const
+    PropertyRecordPtr PropertyHolder::getAllProperties() const
     {
-        PropertyRecord* record = new PropertyRecord();
+        PropertyRecordPtr record(new PropertyRecord);
 
         PropertyKeys keys = getAllPropertyKeys();
         PropertyKeys::const_iterator end = keys.end();
@@ -71,7 +71,7 @@
         mProperties.clear();
     }
 
-    PropertyRecord::PropertyRecord(const PropertyRecord* ps)
+    PropertyRecord::PropertyRecord(const PropertyRecordPtr ps)
         : PropertyHolder()
     {
         mProperties.clear();
@@ -132,9 +132,9 @@
         return convertToPropertyMap(mProperties);
     }
 
-    PropertyRecord* PropertyRecord::getDifference(PropertyRecord* differenceTo) const
+    PropertyRecordPtr PropertyRecord::getDifference(const PropertyRecordPtr differenceTo) const
     {
-        PropertyRecord* record = new PropertyRecord();
+        PropertyRecordPtr record(new PropertyRecord());
         for(PropertyRecordMap::const_iterator it = begin(); it != end(); ++it)
         {
             if(!differenceTo-&gt;hasProperty(it-&gt;first))

Modified: rl/trunk/engine/common/src/XmlProcessor.cpp
===================================================================
--- rl/trunk/engine/common/src/XmlProcessor.cpp	2008-04-29 22:41:45 UTC (rev 4366)
+++ rl/trunk/engine/common/src/XmlProcessor.cpp	2008-04-29 23:10:58 UTC (rev 4367)
@@ -32,6 +32,7 @@
 
 using namespace Ogre;
 using namespace XERCES_CPP_NAMESPACE;
+using CEGUI::utf8;
 
 namespace rl 
 {
@@ -620,11 +621,16 @@
 DOMDocument* XmlProcessor::loadDocument(
     const Ogre::String&amp; resourceName, const Ogre::String&amp; resourceGroup)
 {
-	XercesDOMParser* parser = new XercesDOMParser();
+    if( mOpenParser != NULL )
+    {
+        LOG_WARNING(Logger::COMMON, 
+                &quot;XmlProcessor: there is already an opened DOMParser, but perhaps its still used, so we don't delete it&quot;);
+    }
+    mOpenParser = new XercesDOMParser();
 
-    parser-&gt;setValidationScheme(XercesDOMParser::Val_Auto);    // optional.
-    //parser-&gt;setIncludeIgnorableWhitespace(false); // optional, if you want to ignore whitespaces
-    parser-&gt;setDoNamespaces(true);    // optional
+    mOpenParser-&gt;setValidationScheme(XercesDOMParser::Val_Auto);    // optional.
+    //mOpenParser-&gt;setIncludeIgnorableWhitespace(false); // optional, if you want to ignore whitespaces
+    mOpenParser-&gt;setDoNamespaces(true);    // optional
 
     XmlPtr res = XmlResourceManager::getSingleton().getByName(resourceName);
     if (res.isNull())
@@ -641,33 +647,38 @@
 
     mOpenXmlFileName = resourceName;
 
-    if (!res.isNull() &amp;&amp; res-&gt;parseBy(parser, this))
+    if (!res.isNull() &amp;&amp; res-&gt;parseBy(mOpenParser, this))
     {
-        return parser-&gt;getDocument();
+        mOpenXmlFileName = &quot;&quot;;
+        return mOpenParser-&gt;getDocument();
     }
 
-    mOpenXmlFileName = &quot;&quot;;
 
     return NULL;
 }
 
 DOMDocument* XmlProcessor::loadDocument(const Ogre::DataStreamPtr&amp; stream)
 {
-	XercesDOMParser* parser = new XercesDOMParser();
+    if( mOpenParser != NULL )
+    {
+        LOG_WARNING(Logger::COMMON, 
+                &quot;XmlProcessor: there is already an opened DOMParser, but perhaps its still used, so we don't delete it&quot;);
+    }
+    mOpenParser = new XercesDOMParser();
 
-    parser-&gt;setValidationScheme(XercesDOMParser::Val_Auto);    // optional.
-    parser-&gt;setDoNamespaces(true);    // optional
+    mOpenParser-&gt;setValidationScheme(XercesDOMParser::Val_Auto);    // optional.
+    mOpenParser-&gt;setDoNamespaces(true);    // optional
 
     OgreInputSource source(stream);
-    parser-&gt;setErrorHandler(this);
+    mOpenParser-&gt;setErrorHandler(this);
 
     mOpenXmlFileName = stream-&gt;getName();
-    parser-&gt;parse(source);
+    mOpenParser-&gt;parse(source);
     mOpenXmlFileName = &quot;&quot;;
 
-    if (parser-&gt;getErrorCount() == 0)
+    if (mOpenParser-&gt;getErrorCount() == 0)
     {
-        return parser-&gt;getDocument();
+        return mOpenParser-&gt;getDocument();
     }
 
     return NULL;
@@ -684,6 +695,11 @@
 
 void XmlProcessor::shutdownXml()
 {
+    if( mOpenParser )
+    {
+        delete mOpenParser;
+        mOpenParser = NULL;
+    }
     delete sTranscoder;
     sTranscoder = NULL;
     

Modified: rl/trunk/engine/common/src/XmlPropertyReader.cpp
===================================================================
--- rl/trunk/engine/common/src/XmlPropertyReader.cpp	2008-04-29 22:41:45 UTC (rev 4366)
+++ rl/trunk/engine/common/src/XmlPropertyReader.cpp	2008-04-29 23:10:58 UTC (rev 4367)
@@ -35,6 +35,10 @@
 {
 }
 
+XmlPropertyReader::~XmlPropertyReader()
+{
+}
+
 void XmlPropertyReader::parseGameObjectFile(Ogre::DataStreamPtr &amp;stream, const Ogre::String &amp;groupName)
 {
     initializeXml();
@@ -44,7 +48,7 @@
     DOMNodeList* godefsXml = doc-&gt;getDocumentElement()-&gt;getElementsByTagName(AutoXMLCh(&quot;gameobjectclass&quot;).data());
     for (unsigned int idx = 0; idx &lt; godefsXml-&gt;getLength(); idx++)
     {
-		PropertyRecord* ps = new PropertyRecord();
+		PropertyRecordPtr ps(new PropertyRecord());
 		DOMElement* curNode = static_cast&lt;DOMElement*&gt;(godefsXml-&gt;item(idx));
 		
 		const DOMNamedNodeMap* godefAttrs = curNode-&gt;getAttributes();
@@ -73,12 +77,10 @@
         mPropertyRecords.push_back(ps);
     }
 	
-	doc-&gt;release();
-
     shutdownXml();
 }
 
-std::vector&lt;PropertyRecord*&gt; XmlPropertyReader::getPropertyRecords()
+PropertyRecordVector XmlPropertyReader::getPropertyRecords()
 {
     return mPropertyRecords;
 }
@@ -240,9 +242,9 @@
     return std::make_pair(key, prop);
 }
 
-PropertyRecord XmlPropertyReader::getPropertiesAsRecord(DOMElement *parent)
+PropertyRecordPtr XmlPropertyReader::getPropertiesAsRecord(DOMElement *parent)
 {
-    PropertyRecord ps;
+    PropertyRecordPtr ps(new PropertyRecord());
 
     DOMNodeList* propertyDefChildren = parent-&gt;getChildNodes();
     for (XMLSize_t childIdx = 0; childIdx &lt; propertyDefChildren-&gt;getLength(); childIdx++)
@@ -253,7 +255,7 @@
             PropertyEntry entry = processProperty(static_cast&lt;DOMElement*&gt;(curChild));
             if (entry.first != &quot;&quot;)
             {
-                ps.setProperty(entry.first, entry.second);
+                ps-&gt;setProperty(entry.first, entry.second);
             }
         }
     }

Modified: rl/trunk/engine/common/src/XmlPropertyWriter.cpp
===================================================================
--- rl/trunk/engine/common/src/XmlPropertyWriter.cpp	2008-04-29 22:41:45 UTC (rev 4366)
+++ rl/trunk/engine/common/src/XmlPropertyWriter.cpp	2008-04-29 23:10:58 UTC (rev 4367)
@@ -42,17 +42,17 @@
         return mDocument;
     }
 
-    void XmlPropertyWriter::setPropertyRecords(std::vector&lt;PropertyRecord*&gt; sets)
+    void XmlPropertyWriter::setPropertyRecords(PropertyRecordVector sets)
     {
         mPropertyRecords = sets;
     }
 
-    void XmlPropertyWriter::addPropertyRecord(PropertyRecord* set)
+    void XmlPropertyWriter::addPropertyRecord(PropertyRecordPtr set)
     {
         mPropertyRecords.push_back(set);
     }
 
-    DOMElement* XmlPropertyWriter::processProperty(DOMElement* parent, PropertyEntry entry)
+    DOMElement* XmlPropertyWriter::processProperty(DOMElement* parent, const PropertyEntry&amp; entry)
     {
         DOMElement* element = NULL;
         if(!entry.second.isEmpty())
@@ -97,21 +97,21 @@
         return element;
     }
 
-    DOMElement* XmlPropertyWriter::processPropertyRecord(DOMElement* parent, const char* const name, PropertyRecord set)
+    DOMElement* XmlPropertyWriter::processPropertyRecord(DOMElement* parent, const char* const name, const PropertyRecord&amp; set)
     {
         PropertyMap map = set.toPropertyMap();
 
         return processPropertyMap(parent, name, map);
     }
 
-    DOMElement* XmlPropertyWriter::processPropertyArray(DOMElement *parent, const char *const name, PropertyArray vector)
+    DOMElement* XmlPropertyWriter::processPropertyArray(DOMElement *parent, const char *const name, const PropertyArray&amp; vector)
     {
         DOMElement* element = appendChildElement(mDocument, parent, &quot;property&quot;);
         if(name[0] != '\0')
             setAttribute(element, &quot;name&quot;, name);
         setAttribute(element, &quot;type&quot;, &quot;ARRAY&quot;);
 
-        PropertyArray::iterator iter;
+        PropertyArray::const_iterator iter;
         for(iter = vector.begin(); iter != vector.end(); iter++)
         {
             processProperty(element, PropertyEntry(Ogre::String(),*iter));
@@ -119,14 +119,14 @@
         return element;
     }
 
-    DOMElement* XmlPropertyWriter::processPropertyMap(DOMElement *parent, const char *const name, PropertyMap map)
+    DOMElement* XmlPropertyWriter::processPropertyMap(DOMElement *parent, const char *const name, const PropertyMap&amp; map)
     {
         DOMElement* element = appendChildElement(mDocument, parent, &quot;property&quot;);
         if(name[0] != '\0')
             setAttribute(element, &quot;name&quot;, name);
         setAttribute(element, &quot;type&quot;, &quot;MAP&quot;);
 
-        PropertyMap::iterator iter;
+        PropertyMap::const_iterator iter;
         for(iter = map.begin(); iter != map.end(); iter++)
         {
             processProperty(element, PropertyEntry(iter-&gt;first.c_str(), iter-&gt;second));

Modified: rl/trunk/engine/core/include/MessagePump.h
===================================================================
--- rl/trunk/engine/core/include/MessagePump.h	2008-04-29 22:41:45 UTC (rev 4366)
+++ rl/trunk/engine/core/include/MessagePump.h	2008-04-29 23:10:58 UTC (rev 4367)
@@ -115,6 +115,7 @@
 
     public:
         MessagePump() : mNextConnectionId(0) {}
+        ~MessagePump();
 
         template&lt;typename _MessageType&gt;
         Connection addMessageHandler( const typename _MessageType::HandlerType&amp; handler )

Modified: rl/trunk/engine/core/include/SaveGameFile.h
===================================================================
--- rl/trunk/engine/core/include/SaveGameFile.h	2008-04-29 22:41:45 UTC (rev 4366)
+++ rl/trunk/engine/core/include/SaveGameFile.h	2008-04-29 23:10:58 UTC (rev 4367)
@@ -17,15 +17,16 @@
 #ifndef __SaveGameFile_H__
 #define __SaveGameFile_H__
 
-#include &quot;CorePrerequisites.h&quot;
 
-#include &lt;Property.h&gt;
-#include &lt;Properties.h&gt;
 
+#include &quot;CorePrerequisites.h&quot;
 #include &lt;xercesc/framework/XMLFormatter.hpp&gt;
-
 #include &lt;ctime&gt;
 
+#include &quot;Property.h&quot;
+#include &quot;Properties.h&quot;
+
+
 namespace rl
 {
     class _RlCoreExport SaveGameFile : public PropertyHolder, public Ogre::ScriptLoader

Modified: rl/trunk/engine/core/include/SaveGameFileReader.h
===================================================================
--- rl/trunk/engine/core/include/SaveGameFileReader.h	2008-04-29 22:41:45 UTC (rev 4366)
+++ rl/trunk/engine/core/include/SaveGameFileReader.h	2008-04-29 23:10:58 UTC (rev 4367)
@@ -18,7 +18,7 @@
 #define _SaveGameFileReader_H_
 
 #include &quot;SaveGameFile.h&quot;
-#include &lt;XmlPropertyReader.h&gt;
+#include &quot;XmlPropertyReader.h&quot;
 
 namespace rl
 {
@@ -34,7 +34,7 @@
         void parseSaveGameFile(SaveGameFile* file, const SaveGameDataOrderMap &amp;map);
         void parseSaveGameFileHeader(Ogre::DataStreamPtr &amp;stream, const Ogre::String &amp;groupName, SaveGameFile* file);
 
-        PropertyRecord getAllPropertiesAsRecord(SaveGameData* data);
+        PropertyRecordPtr getAllPropertiesAsRecord(SaveGameData* data);
 
         XERCES_CPP_NAMESPACE::DOMDocument* getDocument() {return mDocument;}
     };

Modified: rl/trunk/engine/core/include/SaveGameManager.h
===================================================================
--- rl/trunk/engine/core/include/SaveGameManager.h	2008-04-29 22:41:45 UTC (rev 4366)
+++ rl/trunk/engine/core/include/SaveGameManager.h	2008-04-29 23:10:58 UTC (rev 4367)
@@ -22,9 +22,10 @@
 #include &quot;SaveGameFile.h&quot;
 #include &quot;MessagePump.h&quot;
 
-#include &lt;XmlPropertyWriter.h&gt;
-#include &lt;XmlPropertyReader.h&gt;
+#include &quot;XmlPropertyWriter.h&quot;
+#include &quot;XmlPropertyReader.h&quot;
 
+
 //#include &lt;multimap&gt;
 
 namespace rl

Modified: rl/trunk/engine/core/include/SceneQuery.h
===================================================================
--- rl/trunk/engine/core/include/SceneQuery.h	2008-04-29 22:41:45 UTC (rev 4366)
+++ rl/trunk/engine/core/include/SceneQuery.h	2008-04-29 23:10:58 UTC (rev 4367)
@@ -131,6 +131,7 @@
     {
     public:
         HalfSphereSceneQuery(Ogre::SceneManager* smgr, unsigned long mask = 0xffffffff);
+        ~HalfSphereSceneQuery();
 
         virtual const ActorVector&amp; execute();
 
@@ -140,6 +141,7 @@
 
     protected:
         Ogre::SphereSceneQuery* mSceneQuery;
+        Ogre::SceneManager* mSceneManager;
         Ogre::Real mRadius;
     };
 }

Modified: rl/trunk/engine/core/include/TimeSource.h
===================================================================
--- rl/trunk/engine/core/include/TimeSource.h	2008-04-29 22:41:45 UTC (rev 4366)
+++ rl/trunk/engine/core/include/TimeSource.h	2008-04-29 23:10:58 UTC (rev 4367)
@@ -101,7 +101,8 @@
         /// defines the loading/saving order higher priority are saved last and loaded first
         virtual int getPriority() const;
     private:
-        std::map&lt;TimeSource::TimeSourceType, TimeSource*&gt; mTimeSources;
+        typedef std::map&lt;TimeSource::TimeSourceType, TimeSource*&gt; TimeSourceMap;
+        TimeSourceMap mTimeSources;
     };
 }
 

Modified: rl/trunk/engine/core/include/ZoneManager.h
===================================================================
--- rl/trunk/engine/core/include/ZoneManager.h	2008-04-29 22:41:45 UTC (rev 4366)
+++ rl/trunk/engine/core/include/ZoneManager.h	2008-04-29 23:10:58 UTC (rev 4367)
@@ -141,7 +141,7 @@
         void zoneLeft(Zone * zone);
         
         void doDestroyZone(Zone *zone);
-        void parseAreaProperties(const Ogre::String&amp; zoneName, const PropertyRecord &amp;properties); // adds an area created from properties to the zone
+        void parseAreaProperties(const Ogre::String&amp; zoneName, const PropertyRecordPtr properties); // adds an area created from properties to the zone
 	};
 }
 

Modified: rl/trunk/engine/core/src/CoreSubsystem.cpp
===================================================================
--- rl/trunk/engine/core/src/CoreSubsystem.cpp	2008-04-29 22:41:45 UTC (rev 4366)
+++ rl/trunk/engine/core/src/CoreSubsystem.cpp	2008-04-29 23:10:58 UTC (rev 4367)
@@ -73,32 +73,34 @@
         mDebugVisualsManager(NULL),
         mJobScheduler(NULL),
         mRenderWindow(NULL),
-		mZoneManager(NULL)
+        mZoneManager(NULL)
     {
         initializeCoreSubsystem();
     }
 
     CoreSubsystem::~CoreSubsystem()
     {
-		delete meshmagick::OgreEnvironment::getSingletonPtr();
-		delete mWorld;
+        delete meshmagick::OgreEnvironment::getSingletonPtr();
+        delete mWorld;
         delete mZoneManager;
         delete mGameEventManager;
-        delete mGameLoop;
         delete mMessagePump;
         delete mJobScheduler;
         delete mAnimationManager;
         delete mActorManager;
         delete mPhysicsManager;
-//        delete mXmlResourceManager;
         delete mScriptWrapper;
         delete mDebugVisualsManager;
-		delete ConfigurationManager::getSingletonPtr();
+        delete ConfigurationManager::getSingletonPtr();
         delete mSoundManager;
+        mRenderWindow-&gt;destroy();
         delete mOgreRoot;
         delete mRubyInterpreter;
         delete mTimeSourceManager;
-		delete mSaveGameManager;
+        delete mSaveGameManager;
+        delete mGameLoop;
+        //mXmlResourceManager-&gt;unloadAll();
+        //delete mXmlResourceManager;
     }
 
     void CoreSubsystem::startCore()

Modified: rl/trunk/engine/core/src/DotSceneLoader.cpp
===================================================================
--- rl/trunk/engine/core/src/DotSceneLoader.cpp	2008-04-29 22:41:45 UTC (rev 4366)
+++ rl/trunk/engine/core/src/DotSceneLoader.cpp	2008-04-29 23:10:58 UTC (rev 4367)
@@ -143,7 +143,6 @@
         else
             LOG_DEBUG(Logger::CORE, &quot; Keine statischen Geometrien erstellt&quot;);
 
-        doc-&gt;release();
         shutdownXml();
         LOG_DEBUG(Logger::CORE, &quot;Szenenbeschreibung aus &quot; + mSceneName +&quot; fertig geparst&quot;);
     }

Modified: rl/trunk/engine/core/src/JobScheduler.cpp
===================================================================
--- rl/trunk/engine/core/src/JobScheduler.cpp	2008-04-29 22:41:45 UTC (rev 4366)
+++ rl/trunk/engine/core/src/JobScheduler.cpp	2008-04-29 23:10:58 UTC (rev 4367)
@@ -292,8 +292,8 @@
                             LOG_ERROR(Logger::CORE, &quot;Fehler beim Erstellen eines Objekts der Job-Klasse '&quot; + className + &quot;'!&quot;);
                             continue;
                         }
-                        PropertyRecord properties = reader-&gt;getPropertiesAsRecord(xmlJob);
-                        job-&gt;setProperties(&amp;properties);
+                        PropertyRecordPtr properties = reader-&gt;getPropertiesAsRecord(xmlJob);
+                        job-&gt;setProperties(properties);
                         
                         
                         unsigned long ticket = ++mTicketCounter;

Modified: rl/trunk/engine/core/src/MessagePump.cpp
===================================================================
--- rl/trunk/engine/core/src/MessagePump.cpp	2008-04-29 22:41:45 UTC (rev 4366)
+++ rl/trunk/engine/core/src/MessagePump.cpp	2008-04-29 23:10:58 UTC (rev 4367)
@@ -21,7 +21,22 @@
 
 namespace rl
 {
+    MessagePump::~MessagePump()
+    {
 
+        while(!mMessageQueue.empty())
+        {
+        
+            delete mMessageQueue.front();
+            mMessageQueue.pop();    
+        }
+
+        MessageHandlerMap::iterator it = mMessageHandlerMap.begin();
+        for( ; it != mMessageHandlerMap.end(); it++ )
+            if( it-&gt;second != NULL )
+                delete it-&gt;second;
+    }
+
     void MessagePump::run(Ogre::Real elapsedTime)
     {
         static bool sending = false;

Modified: rl/trunk/engine/core/src/PhysicalThing.cpp
===================================================================
--- rl/trunk/engine/core/src/PhysicalThing.cpp	2008-04-29 22:41:45 UTC (rev 4366)
+++ rl/trunk/engine/core/src/PhysicalThing.cpp	2008-04-29 23:10:58 UTC (rev 4367)
@@ -52,7 +52,7 @@
 
     PhysicalThing::~PhysicalThing()
 	{
-		///@todo missing removal of list of collision objects here ...
+                mPoseCollisions.clear();
 		delete mBody;
 		mBody = NULL;
     }

Modified: rl/trunk/engine/core/src/PhysicsManager.cpp
===================================================================
--- rl/trunk/engine/core/src/PhysicsManager.cpp	2008-04-29 22:41:45 UTC (rev 4366)
+++ rl/trunk/engine/core/src/PhysicsManager.cpp	2008-04-29 23:10:58 UTC (rev 4367)
@@ -106,6 +106,7 @@
         // setup level quadtree extents
         mLevelBodiesQuadTree.setMaxData(20);
         mLevelBodiesQuadTree.setMaxDepth(10);
+        
         mLevelBodiesQuadTree.setLoosenessFactor(0.5f);
         mLevelBodiesQuadTree.setExtents(Ogre::Vector2(-100,-100), Ogre::Vector2(100,100));
     }
@@ -115,6 +116,12 @@
         // simply remove all collision ptrs (is this really ok?)
         mCollisionPrimitives.clear();
 
+        // remove all material-pairs
+        for (MaterialPairMap::iterator it = mMaterialPairs.begin(); it != mMaterialPairs.end(); it++)
+        {
+            delete it-&gt;second;
+        }
+
         // remove all materials
         for (MaterialMap::iterator it = mMaterials.begin(); it != mMaterials.end(); it++)
         {

Modified: rl/trunk/engine/core/src/SaveGameFileReader.cpp
===================================================================
--- rl/trunk/engine/core/src/SaveGameFileReader.cpp	2008-04-29 22:41:45 UTC (rev 4366)
+++ rl/trunk/engine/core/src/SaveGameFileReader.cpp	2008-04-29 23:10:58 UTC (rev 4367)
@@ -50,8 +50,6 @@
         }
 
 
-        mDocument-&gt;release();
-
         file-&gt;closeDataStream(); //make the save game writable
 
         mDocument = NULL;
@@ -84,17 +82,17 @@
                          }
                      }
                  }*/
-                 PropertyRecord set = getPropertiesAsRecord(elem);
-                 file-&gt;setProperties(&amp;set);
+                 PropertyRecordPtr set = getPropertiesAsRecord(elem);
+                 file-&gt;setProperties(set);
              }
         }
 
         shutdownXml();
     }
 
-    PropertyRecord SaveGameFileReader::getAllPropertiesAsRecord(SaveGameData* data)
+    PropertyRecordPtr SaveGameFileReader::getAllPropertiesAsRecord(SaveGameData* data)
     {
-        PropertyRecord properties;
+        PropertyRecordPtr properties(new PropertyRecord());
 
         initializeXml();
 

Modified: rl/trunk/engine/core/src/SaveGameFileWriter.cpp
===================================================================
--- rl/trunk/engine/core/src/SaveGameFileWriter.cpp	2008-04-29 22:41:45 UTC (rev 4366)
+++ rl/trunk/engine/core/src/SaveGameFileWriter.cpp	2008-04-29 23:10:58 UTC (rev 4367)
@@ -70,7 +70,7 @@
         //Write modul of save game
         DOMElement* header = appendChildElement(mDocument, mDocument-&gt;getDocumentElement(), &quot;header&quot;);
         
-        PropertyRecord* headerSet = file-&gt;getAllProperties();
+        PropertyRecordPtr headerSet = file-&gt;getAllProperties();
         for (PropertyRecord::PropertyRecordMap::const_iterator it_header = headerSet-&gt;begin(); it_header != headerSet-&gt;end(); it_header++)
         {
             this-&gt;processProperty(header, PropertyEntry(it_header-&gt;first.c_str(), it_header-&gt;second));

Modified: rl/trunk/engine/core/src/SaveGameManager.cpp
===================================================================
--- rl/trunk/engine/core/src/SaveGameManager.cpp	2008-04-29 22:41:45 UTC (rev 4366)
+++ rl/trunk/engine/core/src/SaveGameManager.cpp	2008-04-29 23:10:58 UTC (rev 4367)
@@ -25,7 +25,6 @@
 
 #include &quot;XmlProcessor.h&quot;
 
-#include &lt;xercesc/dom/DOM.hpp&gt;
 #include &lt;xercesc/framework/LocalFileFormatTarget.hpp&gt;
 
 template&lt;&gt; rl::SaveGameManager* Ogre::Singleton&lt;rl::SaveGameManager&gt;::ms_Singleton = 0;

Modified: rl/trunk/engine/core/src/SceneQuery.cpp
===================================================================
--- rl/trunk/engine/core/src/SceneQuery.cpp	2008-04-29 22:41:45 UTC (rev 4366)
+++ rl/trunk/engine/core/src/SceneQuery.cpp	2008-04-29 23:10:58 UTC (rev 4367)
@@ -213,11 +213,17 @@
     };
 
     HalfSphereSceneQuery::HalfSphereSceneQuery(SceneManager* smgr, unsigned long mask)
-        : SceneQuery(mask), mSceneQuery(NULL), mRadius(0.0f)
+        : SceneQuery(mask), mSceneQuery(NULL), mRadius(0.0f), mSceneManager(NULL)
     {
         mSceneQuery = smgr-&gt;createSphereQuery(Sphere());
+        mSceneManager = smgr;
     }
 
+    HalfSphereSceneQuery::~HalfSphereSceneQuery()
+    {
+        mSceneManager-&gt;destroyQuery(mSceneQuery);
+    }
+
     const ActorVector&amp; HalfSphereSceneQuery::execute()
     {
         // Discard results from last query

Modified: rl/trunk/engine/core/src/TimeSource.cpp
===================================================================
--- rl/trunk/engine/core/src/TimeSource.cpp	2008-04-29 22:41:45 UTC (rev 4366)
+++ rl/trunk/engine/core/src/TimeSource.cpp	2008-04-29 23:10:58 UTC (rev 4367)
@@ -124,13 +124,22 @@
 		SaveGameManager::getSingleton().registerSaveGameData(this);
     }
 
-	TimeSourceManager::~TimeSourceManager()
-	{
-		SaveGameManager::getSingleton().unregisterSaveGameData(this);
-	}
+    TimeSourceManager::~TimeSourceManager()
+    {
+        SaveGameManager::getSingleton().unregisterSaveGameData(this);
 
+        // delete TimeSources
+        TimeSourceMap::iterator it = mTimeSources.begin();
+        for( ; it != mTimeSources.end(); it++)
+            if( it-&gt;second != NULL )
+                delete it-&gt;second;
+    }
+
     void TimeSourceManager::registerTimeSource(TimeSource* ts)
     {
+        TimeSourceMap::iterator it = mTimeSources.find(ts-&gt;getType());
+        if( it != mTimeSources.end() )
+            delete it-&gt;second;
         mTimeSources[ts-&gt;getType()] = ts;
     }
 
@@ -209,11 +218,11 @@
                     {
 						TimeSource::TimeSourceType ID = (TimeSource::TimeSourceType)reader-&gt;getAttributeValueAsInteger(
 							static_cast&lt;DOMElement*&gt;(xmlTimeSource), &quot;ID&quot;);
-                        PropertyRecord properties = reader-&gt;getPropertiesAsRecord(static_cast&lt;DOMElement*&gt;(xmlTimeSource));
+                        PropertyRecordPtr properties = reader-&gt;getPropertiesAsRecord(static_cast&lt;DOMElement*&gt;(xmlTimeSource));
 	
 						std::map&lt;TimeSource::TimeSourceType, TimeSource*&gt;::const_iterator it_time_sources = mTimeSources.find(ID);
 						if(it_time_sources != mTimeSources.end())
-							it_time_sources-&gt;second-&gt;setClock(properties.toPropertyMap()[&quot;time&quot;].toInt());
+							it_time_sources-&gt;second-&gt;setClock(properties-&gt;toPropertyMap()[&quot;time&quot;].toInt());
                     }
 				}
 			}

Modified: rl/trunk/engine/core/src/ZoneManager.cpp
===================================================================
--- rl/trunk/engine/core/src/ZoneManager.cpp	2008-04-29 22:41:45 UTC (rev 4366)
+++ rl/trunk/engine/core/src/ZoneManager.cpp	2008-04-29 23:10:58 UTC (rev 4367)
@@ -56,7 +56,11 @@
 
         GameEventManager::getSingleton().removeAreaListener(this);
         GameEventManager::getSingleton().removeQueuedDeletionSources();
-		for (ZoneMap::iterator it = mZones.begin(); it != mZones.end(); ++it)
+        std::list&lt;Zone*&gt;::iterator it = mZonesToDelete.begin();
+        for( ; it != mZonesToDelete.end(); it++)
+            doDestroyZone(*it);
+        mZonesToDelete.clear();
+		for (std::map&lt;long, Zone*&gt;::iterator it = mZonesIdMap.begin(); it != mZonesIdMap.end(); ++it)
 		{
 			Zone* curZone = (*it).second;
             delete curZone;
@@ -631,7 +635,7 @@
                             for(XMLSize_t childIdx2 = 0; childIdx2 &lt; xmlAreas-&gt;getLength(); childIdx2++)
                             {
                                 DOMNode* xmlArea = xmlAreas-&gt;item(childIdx2);
-                                PropertyRecord properties = reader-&gt;getPropertiesAsRecord(static_cast&lt;DOMElement*&gt;(xmlArea));
+                                PropertyRecordPtr properties = reader-&gt;getPropertiesAsRecord(static_cast&lt;DOMElement*&gt;(xmlArea));
                                 parseAreaProperties(name, properties);
                             }
                         }
@@ -645,7 +649,7 @@
         reader-&gt;shutdownXml();
     }
 
-    void ZoneManager::parseAreaProperties(const Ogre::String&amp; name, const PropertyRecord &amp;properties)
+    void ZoneManager::parseAreaProperties(const Ogre::String&amp; name, const PropertyRecordPtr properties)
     {
         Ogre::AxisAlignedBox aabb;
         aabb.setMaximum(Vector3::ZERO);
@@ -661,7 +665,7 @@
         bool subtract = false;
         bool mesh = false;
 
-        for( PropertyRecord::PropertyRecordMap::const_iterator iter = properties.begin(); iter != properties.end(); iter++)
+        for( PropertyRecord::PropertyRecordMap::const_iterator iter = properties-&gt;begin(); iter != properties-&gt;end(); iter++)
         {
             if(iter-&gt;first == &quot;subtract&quot;)
                 subtract = iter-&gt;second.toBool();

Modified: rl/trunk/engine/rules/include/GameObjectManager.h
===================================================================
--- rl/trunk/engine/rules/include/GameObjectManager.h	2008-04-29 22:41:45 UTC (rev 4366)
+++ rl/trunk/engine/rules/include/GameObjectManager.h	2008-04-29 23:10:58 UTC (rev 4367)
@@ -20,7 +20,7 @@
 #include &quot;RulesPrerequisites.h&quot;
 #include &quot;GameObjectStateListener.h&quot;
 
-#include &quot;Property.h&quot;
+#include &quot;Properties.h&quot;
 #include &quot;SaveGameData.h&quot;
 
 #include &lt;map&gt;
@@ -28,8 +28,6 @@
 namespace rl
 {
     class GameObject;
-	class Property;
-    class PropertyRecord;
 
 
     class _RlRulesExport GameObjectFactory
@@ -85,7 +83,7 @@
         virtual void readData(SaveGameFileReader* reader);
         virtual int getPriority() const;
     private:
-        typedef std::map&lt;const Ogre::String, PropertyRecord*&gt; ClassPropertyMap;
+        typedef std::map&lt;const Ogre::String, PropertyRecordPtr&gt; ClassPropertyMap;
         typedef std::set&lt;GameObjectStateListener*&gt; GameObjectStateListenerSet;
 
         Ogre::StringVector mScriptPatterns;
@@ -97,8 +95,8 @@
         GameObjectStateListenerSet mGameObjectStateListeners;
 
         unsigned int generateId();
-        PropertyRecord* getClassProperties(const Ogre::String&amp; classId) const;
-        void applyProperties(GameObject* go, PropertyRecord* ps) const;
+        const PropertyRecordPtr getClassProperties(const Ogre::String&amp; classId) const;
+        void applyProperties(GameObject* go, PropertyRecordPtr ps) const;
 
         PropertyMap getPropertyMapDifference(PropertyMap map1, PropertyMap map2);
     };

Modified: rl/trunk/engine/rules/include/GlobalProperties.h
===================================================================
--- rl/trunk/engine/rules/include/GlobalProperties.h	2008-04-29 22:41:45 UTC (rev 4366)
+++ rl/trunk/engine/rules/include/GlobalProperties.h	2008-04-29 23:10:58 UTC (rev 4367)
@@ -48,7 +48,7 @@
         virtual void readData(SaveGameFileReader* reader);
         virtual int getPriority() const;
     protected:
-        PropertyRecord* mProperties;
+        PropertyRecord mProperties;
     };
 }
 

Modified: rl/trunk/engine/rules/include/Quest.h
===================================================================
--- rl/trunk/engine/rules/include/Quest.h	2008-04-29 22:41:45 UTC (rev 4366)
+++ rl/trunk/engine/rules/include/Quest.h	2008-04-29 23:10:58 UTC (rev 4367)
@@ -182,7 +182,7 @@
         State mState;
         Quest* mParent;
         QuestBook* mQuestBook;
-		PropertyRecord* mAdditionalProperties;
+        PropertyRecord mAdditionalProperties;
 
         void checkDone();
         void setParent(Quest* parentQuest);

Modified: rl/trunk/engine/rules/src/Creature.cpp
===================================================================
--- rl/trunk/engine/rules/src/Creature.cpp	2008-04-29 22:41:45 UTC (rev 4366)
+++ rl/trunk/engine/rules/src/Creature.cpp	2008-04-29 23:10:58 UTC (rev 4367)
@@ -262,7 +262,7 @@
         }
         else if (mCurrentLe &lt;= 0 &amp;&amp; oldLe &gt; 0)
         {
-            mEffectManager-&gt;addEffect(EffectFactoryManager::getSingleton().createEffect(&quot;UnconciousEffect&quot;));
+            mEffectManager-&gt;addEffect(EffectFactoryManager::getSingleton().createEffect(&quot;UnconsciousEffect&quot;));
         }
         else if (mCurrentLe &gt; 0 &amp;&amp; oldLe &lt;= 0)
         {

Modified: rl/trunk/engine/rules/src/DsaDataLoader.cpp
===================================================================
--- rl/trunk/engine/rules/src/DsaDataLoader.cpp	2008-04-29 22:41:45 UTC (rev 4366)
+++ rl/trunk/engine/rules/src/DsaDataLoader.cpp	2008-04-29 23:10:58 UTC (rev 4367)
@@ -60,8 +60,6 @@
 		initializeKampftechniken(getChildNamed(dataDocumentContent, &quot;Kampftechniken&quot;));
 		initializeCreatures(getChildNamed(dataDocumentContent, &quot;Personen&quot;));
 
-		doc-&gt;release();
-
         shutdownXml();
     }
 

Modified: rl/trunk/engine/rules/src/GameObjectManager.cpp
===================================================================
--- rl/trunk/engine/rules/src/GameObjectManager.cpp	2008-04-29 22:41:45 UTC (rev 4366)
+++ rl/trunk/engine/rules/src/GameObjectManager.cpp	2008-04-29 23:10:58 UTC (rev 4367)
@@ -71,10 +71,10 @@
     {
         XmlPropertyReader* propReader = new XmlPropertyReader();
         propReader-&gt;parseGameObjectFile(stream, groupName);
-        std::vector&lt;PropertyRecord*&gt; psset = propReader-&gt;getPropertyRecords();
-        for(std::vector&lt;PropertyRecord*&gt;::iterator it = psset.begin(); it != psset.end(); it++)
+        std::vector&lt;PropertyRecordPtr&gt; psset = propReader-&gt;getPropertyRecords();
+        for(std::vector&lt;PropertyRecordPtr&gt;::iterator it = psset.begin(); it != psset.end(); it++)
         {
-            PropertyRecord* curPs = *it;
+            PropertyRecordPtr curPs = *it;
             Ogre::String classId = curPs-&gt;getProperty(GameObject::PROPERTY_CLASS_ID).toString().c_str();
             mClassProperties[classId] = curPs;
         }
@@ -141,7 +141,7 @@
             goId = generateId();
         }
 
-        PropertyRecord* ps = getClassProperties(classId);
+        PropertyRecordPtr ps = getClassProperties(classId);
         Ogre::String classname =  ps-&gt;getProperty(GameObject::PROPERTY_BASE_CLASS).toString().c_str();
 
         GameObject* go = mGameObjectFactory
@@ -182,11 +182,11 @@
         }
     }
 
-    void GameObjectManager::applyProperties(GameObject* go, PropertyRecord* ps) const
+    void GameObjectManager::applyProperties(GameObject* go, PropertyRecordPtr ps) const
     {
         if (ps-&gt;hasProperty(GameObject::PROPERTY_INHERITS))
         {
-            PropertyRecord* superClassProps = 
+            PropertyRecordPtr superClassProps = 
                 getClassProperties(ps-&gt;getProperty(GameObject::PROPERTY_INHERITS).toString().c_str());
             applyProperties(go, superClassProps);
         }
@@ -214,7 +214,7 @@
 		return Property(go-&gt;getClassId() + &quot;|&quot; + CEGUI::PropertyHelper::uintToString(go-&gt;getId()));
 	}
 
-    PropertyRecord* GameObjectManager::getClassProperties(const Ogre::String&amp; classId) const
+    const PropertyRecordPtr GameObjectManager::getClassProperties(const Ogre::String&amp; classId) const
     {
         ClassPropertyMap::const_iterator it = mClassProperties.find(classId);
         if (it == mClassProperties.end())
@@ -344,7 +344,7 @@
                         Ogre::String classID = reader-&gt;getAttributeValueAsStdString(static_cast&lt;DOMElement*&gt;(xmlGameObject), &quot;ClassID&quot;);
                         GameObjectState state = (GameObjectState)reader-&gt;getAttributeValueAsInteger(static_cast&lt;DOMElement*&gt;(xmlGameObject), &quot;State&quot;);
                         int flags = reader-&gt;getAttributeValueAsInteger(static_cast&lt;DOMElement*&gt;(xmlGameObject), &quot;QueryFlags&quot;);
-                        PropertyRecord properties = reader-&gt;getPropertiesAsRecord(static_cast&lt;DOMElement*&gt;(xmlGameObject));
+                        PropertyRecordPtr properties = reader-&gt;getPropertiesAsRecord(static_cast&lt;DOMElement*&gt;(xmlGameObject));
 
                         GameObject* object = NULL;
                         if(getGameObject(ID) == NULL)
@@ -352,7 +352,7 @@
                         else
                             object = getGameObject(ID);
                         
-                        applyProperties(object, &amp;properties);
+                        applyProperties(object, properties);
                         // Placing the actor a a little bit higher in the scene. The actor will fall onto ground.
                         // Avoiding problems with the physics, because the character the creature is transfixed to ground
                         if(state == GOS_IN_SCENE)

Modified: rl/trunk/engine/rules/src/GlobalProperties.cpp
===================================================================
--- rl/trunk/engine/rules/src/GlobalProperties.cpp	2008-04-29 22:41:45 UTC (rev 4366)
+++ rl/trunk/engine/rules/src/GlobalProperties.cpp	2008-04-29 23:10:58 UTC (rev 4367)
@@ -28,12 +28,10 @@
     GlobalProperties::GlobalProperties()
     {
         SaveGameManager::getSingleton().registerSaveGameData(this);
-        mProperties = new PropertyRecord();
     }
 
     GlobalProperties::~GlobalProperties()
     {
-        delete mProperties;
         SaveGameManager::getSingleton().unregisterSaveGameData(this);
     }
 
@@ -41,22 +39,22 @@
     /// Overrides from PropertyHolder
     const Property GlobalProperties::getProperty(const CeGuiString&amp; key) const
     {
-        return mProperties-&gt;getProperty(key);
+        return mProperties.getProperty(key);
     }
 
     void GlobalProperties::setProperty(const CeGuiString&amp; key, const Property&amp; value)
     {
-        mProperties-&gt;setProperty(key, value);
+        mProperties.setProperty(key, value);
     }
 
     PropertyKeys GlobalProperties::getAllPropertyKeys() const
     {
-        return mProperties-&gt;getAllPropertyKeys();
+        return mProperties.getAllPropertyKeys();
     }
 
     bool GlobalProperties::hasProperty(const Ogre::String &amp;key) const
     {
-        return mProperties-&gt;hasProperty(key);
+        return mProperties.hasProperty(key);
     }
 
     /// Overrides from SaveGameData
@@ -70,7 +68,7 @@
     {
         DOMElement* elem = writer-&gt;appendChildElement(writer-&gt;getDocument(), writer-&gt;getDocument()-&gt;getDocumentElement(), getXmlNodeIdentifier().c_str());
 
-        writer-&gt;writeEachPropertyToElem(elem, mProperties-&gt;toPropertyMap());
+        writer-&gt;writeEachPropertyToElem(elem, mProperties.toPropertyMap());
     }
 
     void GlobalProperties::readData(SaveGameFileReader* reader)
@@ -82,9 +80,9 @@
         {
             DOMElement* elem = static_cast&lt;DOMElement*&gt;(rootNodeList-&gt;item(0));
 
-            PropertyRecord properties = reader-&gt;getPropertiesAsRecord(elem);
+            PropertyRecordPtr properties = reader-&gt;getPropertiesAsRecord(elem);
 
-            setProperties(&amp;properties);
+            setProperties(properties);
         }
 
         reader-&gt;shutdownXml();

Modified: rl/trunk/engine/rules/src/Quest.cpp
===================================================================
--- rl/trunk/engine/rules/src/Quest.cpp	2008-04-29 22:41:45 UTC (rev 4366)
+++ rl/trunk/engine/rules/src/Quest.cpp	2008-04-29 23:10:58 UTC (rev 4367)
@@ -30,15 +30,17 @@
 
 namespace rl {
 
-const CeGuiString	Quest::STATE_NAMES[5] =
-		{	&quot;OPEN&quot;,
+const CeGuiString Quest::STATE_NAMES[5] =
+            {
+            &quot;OPEN&quot;,
             &quot;ASSIGNED&quot;,
             &quot;FAILED&quot;,
             &quot;SUCCEEDED&quot;,
             &quot;COMPLETED&quot;};
 
-const CeGuiString	Quest::KNOWN_NAMES[2] =
-		{	&quot;UNKNOWN&quot;,
+const CeGuiString Quest::KNOWN_NAMES[2] =
+            {
+            &quot;UNKNOWN&quot;,
             &quot;KNOWN&quot;};
 
 const Ogre::String Quest::PROPERTY_ID = &quot;id&quot;;
@@ -50,18 +52,17 @@
 const Ogre::String Quest::PROPERTY_PARTSDONE = &quot;partsdone&quot;;
 
 Quest::Quest(const CeGuiString&amp; id, const CeGuiString&amp; name, const CeGuiString&amp; description)
-:	mId(id),
-	mName(name),
-	mDescription(description),
-	mPartsToDo(1),
-	mPartsDone(0),
-	mState(Quest::OPEN),
-	mKnown(false),
-	mParent(NULL),
-	mQuestBook(NULL),
-    mSubquests()
+:       mId(id),
+        mName(name),
+        mDescription(description),
+        mPartsToDo(1),
+        mPartsDone(0),
+        mState(Quest::OPEN),
+        mKnown(false),
+        mParent(NULL),
+        mQuestBook(NULL),
+        mSubquests()
 {
-	mAdditionalProperties = new PropertyRecord();
 }
 
 Quest::~Quest()
@@ -330,7 +331,7 @@
     }
     else
     {
-        return mAdditionalProperties-&gt;getProperty(key);
+        return mAdditionalProperties.getProperty(key);
     }
 }
 
@@ -366,7 +367,7 @@
     }
     else
     {
-        mAdditionalProperties-&gt;setProperty(key, value);
+        mAdditionalProperties.setProperty(key, value);
     }
 }
 
@@ -381,7 +382,7 @@
     keys.insert(PROPERTY_STATE);
     keys.insert(PROPERTY_PARTSTODO);
     keys.insert(PROPERTY_PARTSDONE);
-    PropertyKeys addKeys = mAdditionalProperties-&gt;getAllPropertyKeys();
+    PropertyKeys addKeys = mAdditionalProperties.getAllPropertyKeys();
     keys.insert(addKeys.begin(), addKeys.end());
 
     return keys;

Modified: rl/trunk/engine/rules/src/QuestBook.cpp
===================================================================
--- rl/trunk/engine/rules/src/QuestBook.cpp	2008-04-29 22:41:45 UTC (rev 4366)
+++ rl/trunk/engine/rules/src/QuestBook.cpp	2008-04-29 23:10:58 UTC (rev 4367)
@@ -314,7 +314,7 @@
     {
         LOG_MESSAGE(Logger::RULES, &quot;Saving questbook&quot;);
 
-        PropertyRecord* set = getAllProperties();
+        PropertyRecordPtr set = getAllProperties();
         writer-&gt;writeEachProperty(this, set-&gt;toPropertyMap());
     }
 
@@ -323,8 +323,8 @@
         LOG_MESSAGE(Logger::RULES, &quot;Loading questbook&quot;);
 
         clear();
-        PropertyRecord properties = reader-&gt;getAllPropertiesAsRecord(this);
-        setProperties(&amp;properties);
+        PropertyRecordPtr properties = reader-&gt;getAllPropertiesAsRecord(this);
+        setProperties(properties);
     }
 
     void QuestBook::clear()

Modified: rl/trunk/engine/script/include/MapLoader.h
===================================================================
--- rl/trunk/engine/script/include/MapLoader.h	2008-04-29 22:41:45 UTC (rev 4366)
+++ rl/trunk/engine/script/include/MapLoader.h	2008-04-29 23:10:58 UTC (rev 4367)
@@ -16,15 +16,14 @@
 #ifndef __MapLoader_H__
 #define __MapLoader_H__
 
-#include &lt;xercesc/dom/DOMElement.hpp&gt;
 
 #include &quot;ScriptPrerequisites.h&quot;
 
 #include &lt;list&gt;
-#include &lt;XmlProcessor.h&gt;
-#include &lt;ContentLoader.h&gt;
-#include &lt;MessagePump.h&gt;
-#include &lt;CoreMessages.h&gt;
+#include &quot;XmlProcessor.h&quot;
+#include &quot;ContentLoader.h&quot;
+#include &quot;MessagePump.h&quot;
+#include &quot;CoreMessages.h&quot;
 
 namespace rl {
    

Modified: rl/trunk/engine/script/src/MapLoader.cpp
===================================================================
--- rl/trunk/engine/script/src/MapLoader.cpp	2008-04-29 22:41:45 UTC (rev 4366)
+++ rl/trunk/engine/script/src/MapLoader.cpp	2008-04-29 23:10:58 UTC (rev 4367)
@@ -158,7 +158,6 @@
                     }
                 }
 
-                doc-&gt;release();
 
 			    CoreSubsystem::getSingleton().getWorld()-&gt;initializeDefaultCamera();
 			    ///@todo: Window fade jobs don't work if Core is paused, think about solution for: CoreSubsystem::getSingleton().setPaused(false);

Modified: rl/trunk/engine/script/src/TriggerFactory.cpp
===================================================================
--- rl/trunk/engine/script/src/TriggerFactory.cpp	2008-04-29 22:41:45 UTC (rev 4366)
+++ rl/trunk/engine/script/src/TriggerFactory.cpp	2008-04-29 23:10:58 UTC (rev 4367)
@@ -118,13 +118,13 @@
                         Ogre::String name = reader-&gt;getAttributeValueAsStdString(static_cast&lt;DOMElement*&gt;(xmlTrigger), &quot;name&quot;);
                         Ogre::String zoneName = reader-&gt;getAttributeValueAsStdString(static_cast&lt;DOMElement*&gt;(xmlTrigger), &quot;zone&quot;);
 
-                        PropertyRecord properties = reader-&gt;getPropertiesAsRecord(static_cast&lt;DOMElement*&gt;(xmlTrigger));
+                        PropertyRecordPtr properties = reader-&gt;getPropertiesAsRecord(static_cast&lt;DOMElement*&gt;(xmlTrigger));
 
 
                         Trigger *trigger = createTrigger(classname, name);
                         if( trigger ) // if not, there is an error-msg from the script!
                         {
-                            trigger-&gt;setProperties(&amp;properties);
+                            trigger-&gt;setProperties(properties);
                             Zone *zone = ZoneManager::getSingleton().getZone(zoneName);
                             if(zone == NULL)
                             {

Modified: rl/trunk/engine/ui/src/CloseConfirmationWindow.cpp
===================================================================
--- rl/trunk/engine/ui/src/CloseConfirmationWindow.cpp	2008-04-29 22:41:45 UTC (rev 4366)
+++ rl/trunk/engine/ui/src/CloseConfirmationWindow.cpp	2008-04-29 23:10:58 UTC (rev 4367)
@@ -43,6 +43,7 @@
 
 bool CloseConfirmationWindow::handleConfirm()
 {
+        setVisible(false, true);
 	GameLoop::getSingleton().quitGame();
 	return true;
 }

Modified: rl/trunk/engine/ui/src/InputManager.cpp
===================================================================
--- rl/trunk/engine/ui/src/InputManager.cpp	2008-04-29 22:41:45 UTC (rev 4366)
+++ rl/trunk/engine/ui/src/InputManager.cpp	2008-04-29 23:10:58 UTC (rev 4367)
@@ -89,6 +89,15 @@
         clearControlStates();
 
         GameLoop::getSingleton().removeTask(this);
+
+        // delete finished control states
+        for (ControlStateVector::iterator it = mFinishedControlStates.begin();
+            it != mFinishedControlStates.end(); ++it)
+        {
+            delete *it;
+        }
+        mFinishedControlStates.clear();
+
         if( mInputManager )
         {
             mInputManager-&gt;destroyInputObject( mMouse );
@@ -112,8 +121,8 @@
             pl.insert(std::make_pair(std::string(&quot;w32_keyboard&quot;), std::string(&quot;DISCL_EXCLUSIVE&quot;)));
             pl.insert(std::make_pair(std::string(&quot;w32_keyboard&quot;), std::string(&quot;DISCL_FOREGROUND&quot;)));
         #elif OGRE_PLATFORM == OGRE_PLATFORM_LINUX &amp; defined DEBUG
-            pl.insert(std::make_pair(std::string(&quot;x11_mouse_grab&quot;), std::string(&quot;false&quot;)));
-           pl.insert(std::make_pair(std::string(&quot;x11_keyboard_grab&quot;), std::string(&quot;false&quot;)));
+//            pl.insert(std::make_pair(std::string(&quot;x11_mouse_grab&quot;), std::string(&quot;false&quot;)));
+//            pl.insert(std::make_pair(std::string(&quot;x11_keyboard_grab&quot;), std::string(&quot;false&quot;)));
         #endif
 
         std::ostringstream windowHndStr;
@@ -296,7 +305,6 @@
             mKeyNames.insert(make_pair(keycode, s));
         }
 
-        doc-&gt;release();
         shutdownXml();
     }
 

Modified: rl/trunk/engine/ui/src/MovementControlState.cpp
===================================================================
--- rl/trunk/engine/ui/src/MovementControlState.cpp	2008-04-29 22:41:45 UTC (rev 4366)
+++ rl/trunk/engine/ui/src/MovementControlState.cpp	2008-04-29 23:10:58 UTC (rev 4367)
@@ -141,6 +141,9 @@
     MovementControlState::~MovementControlState()
     {
         delete mCombatSelector.getFilter();
+        mCombatSelector.setFilter(NULL);
+        delete mSelector.getFilter();
+        mSelector.setFilter(NULL);
         delete mRaycast;
 
         if (DebugWindow::getSingletonPtr())
@@ -1285,9 +1288,6 @@
             mCharacterActor-&gt;setVisible(true);
         
         LOG_MESSAGE(Logger::UI, &quot;Camera resetted.&quot;);
-        ///@todo remove this
-        mCharacter-&gt;modifyAu(100);
-        mCharacter-&gt;modifyLe(100);
     }
 
     //------------------------------------------------------------------------

Modified: rl/trunk/engine/ui/src/PropertiesWindow.cpp
===================================================================
--- rl/trunk/engine/ui/src/PropertiesWindow.cpp	2008-04-29 22:41:45 UTC (rev 4366)
+++ rl/trunk/engine/ui/src/PropertiesWindow.cpp	2008-04-29 23:10:58 UTC (rev 4367)
@@ -74,7 +74,7 @@
         fillHeader(object);
 
         // Get the property set of the object
-        PropertyRecord* props = object-&gt;getAllProperties();
+        PropertyRecordPtr props = object-&gt;getAllProperties();
 
         int row = 0;
         //  Iterate through all properties and add a row for
@@ -150,7 +150,6 @@
         mMainTable-&gt;autoSizeColumnHeader(1);
         mMainTable-&gt;autoSizeColumnHeader(2);
 
-		delete props;
 	}
 
 	void PropertiesWindow::update()


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001437.html">[Dsa-hl-svn] r4366 - in rl/trunk/engine/rules: include src
</A></li>
	<LI>Next message: <A HREF="001439.html">[Dsa-hl-svn] r4368 - modules/common/dsa
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1440">[ date ]</a>
              <a href="thread.html#1440">[ thread ]</a>
              <a href="subject.html#1440">[ subject ]</a>
              <a href="author.html#1440">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/dsa-hl-svn">More information about the Dsa-hl-svn
mailing list</a><br>
</body></html>
