<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Dsa-hl-svn] r4613 - in rl/branches/persistence: core/src	rules/include rules/src script/swig ui ui/include ui/src
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/dsa-hl-svn/2008-November/index.html" >
   <LINK REL="made" HREF="mailto:dsa-hl-svn%40lists.berlios.de?Subject=Re%3A%20%5BDsa-hl-svn%5D%20r4613%20-%20in%20rl/branches/persistence%3A%20core/src%0A%09rules/include%20rules/src%20script/swig%20ui%20ui/include%20ui/src&In-Reply-To=%3C200811261942.mAQJgHlb022232%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001669.html">
   <LINK REL="Next"  HREF="001671.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Dsa-hl-svn] r4613 - in rl/branches/persistence: core/src	rules/include rules/src script/swig ui ui/include ui/src</H1>
    <B>timm at mail.berlios.de</B> 
    <A HREF="mailto:dsa-hl-svn%40lists.berlios.de?Subject=Re%3A%20%5BDsa-hl-svn%5D%20r4613%20-%20in%20rl/branches/persistence%3A%20core/src%0A%09rules/include%20rules/src%20script/swig%20ui%20ui/include%20ui/src&In-Reply-To=%3C200811261942.mAQJgHlb022232%40sheep.berlios.de%3E"
       TITLE="[Dsa-hl-svn] r4613 - in rl/branches/persistence: core/src	rules/include rules/src script/swig ui ui/include ui/src">timm at mail.berlios.de
       </A><BR>
    <I>Wed Nov 26 20:42:17 CET 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="001669.html">[Dsa-hl-svn] r4612 - in rl/trunk/engine/ui: include src
</A></li>
        <LI>Next message: <A HREF="001671.html">[Dsa-hl-svn] r4614 - in dependencies/OgreNewt_ngt: inc src
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1670">[ date ]</a>
              <a href="thread.html#1670">[ thread ]</a>
              <a href="subject.html#1670">[ subject ]</a>
              <a href="author.html#1670">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: timm
Date: 2008-11-26 20:42:03 +0100 (Wed, 26 Nov 2008)
New Revision: 4613

Added:
   rl/branches/persistence/ui/include/CharacterSelectionWindow.h
   rl/branches/persistence/ui/src/CharacterSelectionWindow.cpp
Modified:
   rl/branches/persistence/core/src/ConfigurationManager.cpp
   rl/branches/persistence/core/src/JobScheduler.cpp
   rl/branches/persistence/rules/include/GameObject.h
   rl/branches/persistence/rules/include/Item.h
   rl/branches/persistence/rules/include/PartyManager.h
   rl/branches/persistence/rules/src/GameObject.cpp
   rl/branches/persistence/rules/src/Item.cpp
   rl/branches/persistence/script/swig/RlUi.swig
   rl/branches/persistence/ui/RlUI2005.vcproj
   rl/branches/persistence/ui/include/AbstractWindow.h
   rl/branches/persistence/ui/include/GameSettings.h
   rl/branches/persistence/ui/include/WindowFactory.h
   rl/branches/persistence/ui/src/AbstractWindow.cpp
   rl/branches/persistence/ui/src/CharacterStateWindow.cpp
   rl/branches/persistence/ui/src/GameSettings.cpp
   rl/branches/persistence/ui/src/InventoryWindow.cpp
   rl/branches/persistence/ui/src/WindowFactory.cpp
Log:
merged with trunk

Modified: rl/branches/persistence/core/src/ConfigurationManager.cpp
===================================================================
--- rl/branches/persistence/core/src/ConfigurationManager.cpp	2008-11-26 19:07:20 UTC (rev 4612)
+++ rl/branches/persistence/core/src/ConfigurationManager.cpp	2008-11-26 19:42:03 UTC (rev 4613)
@@ -111,6 +111,7 @@
         addSetting(&quot;Action keys&quot;, &quot;showjournalwindow&quot;, &quot;J&quot;);
         addSetting(&quot;Action keys&quot;, &quot;showcharactersheet&quot;, &quot;C&quot;);
         addSetting(&quot;Action keys&quot;, &quot;togglecharacterstatewindow&quot;, &quot;O&quot;);
+        addSetting(&quot;Action keys&quot;, &quot;togglecharacterselectionwindow&quot;, &quot;Y&quot;);
         addSetting(&quot;Action keys&quot;, &quot;toggleingameglobalmenu&quot;, &quot;F10&quot;);
         addSetting(&quot;Action keys&quot;, &quot;shownextdebugwindowpage&quot;, &quot;Ctrl+M&quot;);
         addSetting(&quot;Action keys&quot;, &quot;showobjectactions&quot;, &quot;U&quot;);

Modified: rl/branches/persistence/core/src/JobScheduler.cpp
===================================================================
--- rl/branches/persistence/core/src/JobScheduler.cpp	2008-11-26 19:07:20 UTC (rev 4612)
+++ rl/branches/persistence/core/src/JobScheduler.cpp	2008-11-26 19:42:03 UTC (rev 4613)
@@ -219,13 +219,26 @@
                 writer-&gt;setAttributeValueAsInt64(jobNode, &quot;timeLastCall&quot;, iter-&gt;timeLastCall);
                 writer-&gt;setAttributeValueAsBool(jobNode, &quot;called&quot;, iter-&gt;called);
                 writer-&gt;setAttributeValueAsString(jobNode, &quot;classname&quot;, iter-&gt;job-&gt;getClassName());
+                CeGuiString timeSource = &quot;unknown&quot;;
+                switch (iter-&gt;job-&gt;getTimeSource())
+                {
+                    case TimeSource::GAMETIME:
+                        timeSource = &quot;gametime&quot;;
+                        break;
+                    case TimeSource::REALTIME_CONTINUOUS:
+                        timeSource = &quot;realtime_continuous&quot;;
+                        break;
+                    case TimeSource::REALTIME_INTERRUPTABLE:
+                        timeSource = &quot;realtime_interruptable&quot;;
+                        break;
+                }
+                writer-&gt;setAttributeValueAsString(jobNode, &quot;time&quot;, timeSource);
 
                 PropertyMap map = iter-&gt;job-&gt;getAllProperties()-&gt;toPropertyMap();
                 writer-&gt;writeEachPropertyToElem(jobNode, map);
             }
         }
     }*/
-
     //void JobScheduler::readData(SaveGameFileReader* reader)
     //{
     //    // delete and discard old jobs
@@ -285,24 +298,37 @@
     //                        continue;
     //                    }
 
-    //                    AbstractJob* job = it-&gt;second();
-    //                    if (job == NULL)
-    //                    {
-    //                        LOG_ERROR(Logger::CORE, &quot;Fehler beim Erstellen eines Objekts der Job-Klasse '&quot; + className + &quot;'!&quot;);
-    //                        continue;
-    //                    }
-    //                    PropertyRecordPtr properties = reader-&gt;getPropertiesAsRecord(xmlJob);
-    //                    job-&gt;setProperties(properties);
-    //                    
-    //                    
-    //                    unsigned long ticket = ++mTicketCounter;
-    //                    TimeSource* ts = TimeSourceManager::getSingleton().getTimeSource(job-&gt;getTimeSource());
-    //                    JobEntry entry = {job, NULL, ticket, priority, tokens, start, end, timeLastCall, TimeSource::UNKNOWN, called, false};
-    //                    mJobQueue.push_back(entry);
-    //                }
-    //            }
-    //        }
-    //    }
+//                        AbstractJob* job = it-&gt;second();
+//                        if (job == NULL)
+//                        {
+//                            LOG_ERROR(Logger::CORE, &quot;Fehler beim Erstellen eines Objekts der Job-Klasse '&quot; + className + &quot;'!&quot;);//
+//                            continue;
+//                        }
+//                        PropertyRecordPtr properties = reader-&gt;getPropertiesAsRecord(xmlJob);
+//                       job-&gt;setProperties(properties);
+//                        
+//                        CeGuiString timeSourceStr = reader-&gt;getAttributeValueAsString(xmlJob, &quot;time&quot;);
+//                        TimeSource::TimeSourceType ts = TimeSource::UNKNOWN;
+//                        if (timeSourceStr == &quot;gametime&quot;) 
+//                        {
+//                            ts = TimeSource::GAMETIME;
+//                        }
+//                        else if (timeSourceStr == &quot;realtime_continuous&quot;) 
+//                        {
+//                            ts = TimeSource::REALTIME_CONTINUOUS;
+//                        }
+//                        else if (timeSourceStr == &quot;realtime_interruptable&quot;) 
+//                        {
+//                            ts = TimeSource::REALTIME_INTERRUPTABLE;
+//                        }
+//                        
+//                        unsigned long ticket = ++mTicketCounter;
+//                        JobEntry entry = {job, NULL, ticket, priority, tokens, start, end, timeLastCall, ts, called, false};
+//                        mJobQueue.push_back(entry);
+//                    }
+//                }
+//            }
+//        }
 
     //    reader-&gt;shutdownXml();
     //}

Modified: rl/branches/persistence/rules/include/GameObject.h
===================================================================
--- rl/branches/persistence/rules/include/GameObject.h	2008-11-26 19:07:20 UTC (rev 4612)
+++ rl/branches/persistence/rules/include/GameObject.h	2008-11-26 19:42:03 UTC (rev 4613)
@@ -65,6 +65,7 @@
         static const Ogre::String PROPERTY_MASS; 
         static const Ogre::String PROPERTY_ACTIONS; 
         static const Ogre::String PROPERTY_DEFAULT_ACTION;
+        static const Ogre::String PROPERTY_IMAGENAME;
 
         static const CeGuiString DEFAULT_VIEW_OBJECT_ACTION;
         static const CeGuiString DEFAULT_VIEW_OBJECT_ACTION_DEBUG;
@@ -81,6 +82,9 @@
         const CeGuiString&amp; getDescription() const;
         void setDescription(const CeGuiString&amp; description);
 
+		const CeGuiString&amp; getImageName() const;
+		void setImageName(const CeGuiString&amp; name);
+        
         const CeGuiString&amp; getMeshfile() const;
         void setMeshfile(const CeGuiString&amp; meshfile);
 
@@ -202,6 +206,7 @@
         
         CeGuiString mName;
         CeGuiString mDescription;
+        CeGuiString mImageName;
         CeGuiString mMeshfile;
 		MeshPartMap mMeshParts;
         CeGuiString mSubmeshPreName;

Modified: rl/branches/persistence/rules/include/Item.h
===================================================================
--- rl/branches/persistence/rules/include/Item.h	2008-11-26 19:07:20 UTC (rev 4612)
+++ rl/branches/persistence/rules/include/Item.h	2008-11-26 19:42:03 UTC (rev 4613)
@@ -58,7 +58,6 @@
         static const Ogre::String CLASS_NAME;
 
         static const Ogre::String PROPERTY_ITEMTYPE;
-        static const Ogre::String PROPERTY_IMAGENAME;
         static const Ogre::String PROPERTY_SIZE;
         static const Ogre::String PROPERTY_SUBMESHNAME;
 
@@ -68,9 +67,6 @@
 		void setItemType(ItemType itemType);
 		ItemType getItemType() const;
 
-		const CeGuiString&amp; getImageName() const;
-		void setImageName(const CeGuiString&amp; name);
-
         const CeGuiString&amp; getSubmeshName() const;
         void setSubmeshName(const CeGuiString&amp; name);
 
@@ -85,11 +81,11 @@
 
 
         /**
-         * F&#252;gt das Verhalten f&#252;r die GO-States: GOS_READY, GOS_HELD und GOS_IN_POSSESION hinzu.
-         * @warning Bevor einer der drei States gesetzt wird, sollte zun&#228;chst die Funktion removeOldState
-         * aufgerufen werden, dann m&#252;ssen Owner und ParentSlot/ParentContainer gesetzt werden und
+         * F&#184;gt das Verhalten f&#184;r die GO-States: GOS_READY, GOS_HELD und GOS_IN_POSSESION hinzu.
+         * @warning Bevor einer der drei States gesetzt wird, sollte zun&#137;chst die Funktion removeOldState
+         * aufgerufen werden, dann m&#184;ssen Owner und ParentSlot/ParentContainer gesetzt werden und
          * eventuell doCreateActor. Als letztes muss diese Funktion mit dem neuen State aufgerufen werden.
-         * Die Reihenfolge ist wichtig, damit die onStateChange-Funktionen funktionieren k&#246;nnen!
+         * Die Reihenfolge ist wichtig, damit die onStateChange-Funktionen funktionieren k&#136;nnen!
          **/
         virtual void setState(GameObjectState state);
         virtual void removeOldState();
@@ -110,7 +106,6 @@
         void doCreateActor();
     protected:
 		ItemType mItemType;
-		CeGuiString mImageName;
         CeGuiString mSubmeshName;
 		std::pair&lt;int,int&gt; mSize;
         GameObject* mOwner;

Modified: rl/branches/persistence/rules/include/PartyManager.h
===================================================================
--- rl/branches/persistence/rules/include/PartyManager.h	2008-11-26 19:07:20 UTC (rev 4612)
+++ rl/branches/persistence/rules/include/PartyManager.h	2008-11-26 19:42:03 UTC (rev 4613)
@@ -25,11 +25,11 @@
 {
     class Creature;
 
+    typedef std::vector&lt;Creature*&gt; Party;
+
     class _RlRulesExport PartyManager : public Ogre::Singleton&lt;PartyManager&gt;
     {
     public:
-		typedef std::vector&lt;Creature*&gt; Party;
-
 		PartyManager();
         
         Creature* getActiveCharacter() const;

Modified: rl/branches/persistence/rules/src/GameObject.cpp
===================================================================
--- rl/branches/persistence/rules/src/GameObject.cpp	2008-11-26 19:07:20 UTC (rev 4612)
+++ rl/branches/persistence/rules/src/GameObject.cpp	2008-11-26 19:42:03 UTC (rev 4613)
@@ -59,10 +59,12 @@
     const Ogre::String GameObject::PROPERTY_MASS = &quot;mass&quot;;
     const Ogre::String GameObject::PROPERTY_ACTIONS = &quot;actions&quot;;
     const Ogre::String GameObject::PROPERTY_DEFAULT_ACTION = &quot;defaultaction&quot;;
-
+    const Ogre::String GameObject::PROPERTY_IMAGENAME = &quot;imagename&quot;;
+    
 	GameObject::GameObject(const CeGuiString &amp;id)
         :   mName(&quot;&quot;),
             mDescription(&quot;&quot;),
+            mImageName(&quot;&quot;),
             mMeshfile(&quot;&quot;),
 			mMeshParts(),
             mQueryFlags(QUERYFLAG_GAMEOBJECT),
@@ -138,6 +140,16 @@
         mDescription = description;
     }
 
+	void GameObject::setImageName(const CeGuiString&amp; name)
+	{
+		mImageName = name;
+	}
+    
+	const CeGuiString&amp; GameObject::getImageName() const
+	{
+		return mImageName;
+	}
+    
     const CeGuiString&amp; GameObject::getMeshfile() const
     {
         return mMeshfile;
@@ -533,6 +545,10 @@
         {
             prop.setValue(mDescription);
         }
+        else if (key == PROPERTY_IMAGENAME)
+        {
+            prop.setValue(mImageName);
+        }
         else if (key == PROPERTY_MESHFILE)
         {
             prop.setValue(mMeshfile);
@@ -587,6 +603,10 @@
             {
                 setDescription(value.toString());
             }
+            else if (key == PROPERTY_IMAGENAME)
+            {
+                setImageName(value.toString());
+            }
             else if (key == PROPERTY_MESHFILE)
             {
                 setMeshfile(value.toString());
@@ -675,6 +695,7 @@
         keys.insert(PROPERTY_MESHPARTS);
         keys.insert(PROPERTY_GEOMETRY_TYPE);
         keys.insert(PROPERTY_MASS);
+        keys.insert(PROPERTY_IMAGENAME);
         return keys;
     }
 

Modified: rl/branches/persistence/rules/src/Item.cpp
===================================================================
--- rl/branches/persistence/rules/src/Item.cpp	2008-11-26 19:07:20 UTC (rev 4612)
+++ rl/branches/persistence/rules/src/Item.cpp	2008-11-26 19:42:03 UTC (rev 4613)
@@ -29,7 +29,6 @@
 {
     const Ogre::String Item::CLASS_NAME = &quot;Item&quot;;
 
-    const Ogre::String Item::PROPERTY_IMAGENAME = &quot;imagename&quot;;
     const Ogre::String Item::PROPERTY_ITEMTYPE = &quot;itemtype&quot;;
     const Ogre::String Item::PROPERTY_SIZE = &quot;size&quot;;
     const Ogre::String Item::PROPERTY_SUBMESHNAME = &quot;submeshfile&quot;;
@@ -37,7 +36,6 @@
 	Item::Item(const CeGuiString &amp;id)
         : GameObject(id),
 		mItemType(ITEMTYPE_OTHER),
-		mImageName(&quot;&quot;),
 		mSize(pair&lt;int,int&gt;(1,1)),
         mOwner(NULL),
         mParentSlot(NULL),
@@ -62,16 +60,6 @@
 		return mItemType;
 	}
 
-	void Item::setImageName(const CeGuiString&amp; name)
-	{
-		mImageName = name;
-	}
-
-	const CeGuiString&amp; Item::getImageName() const
-	{
-		return mImageName;
-	}
-
 	bool Item::isContainer() const
 	{
 		return false;
@@ -176,12 +164,8 @@
 
     void Item::setProperty(const CeGuiString&amp; key, const Property&amp; value)
     {
-        if (key == Item::PROPERTY_IMAGENAME)
+        if (key == Item::PROPERTY_SIZE)
         {
-            mImageName = value.toString();
-        }
-        else if (key == Item::PROPERTY_SIZE)
-        {
             mSize = value.toIntPair();
         }
         else if (key == Item::PROPERTY_ITEMTYPE)
@@ -200,12 +184,8 @@
 
     const Property Item::getProperty(const CeGuiString&amp; key) const
     {
-        if (key == Item::PROPERTY_IMAGENAME)
+        if (key == Item::PROPERTY_SIZE)
         {
-            return Property(mImageName);
-        }
-        else if (key == Item::PROPERTY_SIZE)
-        {
             return Property(mSize);
         }
         else if (key == Item::PROPERTY_ITEMTYPE)
@@ -225,7 +205,7 @@
     PropertyKeys Item::getAllPropertyKeys() const
     {
         PropertyKeys keys(GameObject::getAllPropertyKeys());
-        keys.insert(Item::PROPERTY_IMAGENAME);
+        keys.insert(Item::PROPERTY_SUBMESHNAME);
         keys.insert(Item::PROPERTY_SIZE);
         keys.insert(Item::PROPERTY_ITEMTYPE);
         return keys;

Modified: rl/branches/persistence/script/swig/RlUi.swig
===================================================================
--- rl/branches/persistence/script/swig/RlUi.swig	2008-11-26 19:07:20 UTC (rev 4612)
+++ rl/branches/persistence/script/swig/RlUi.swig	2008-11-26 19:42:03 UTC (rev 4613)
@@ -103,6 +103,7 @@
     void toggleConsole();
     void toggleDebugWindow();
     void toggleGameLogWindow();
+    void toggleCharacterSelectionWindow();
     void toggleCharacterStateWindow();
     void toggleInGameGlobalMenu();
     void toggleInventoryWindow();

Modified: rl/branches/persistence/ui/RlUI2005.vcproj
===================================================================
--- rl/branches/persistence/ui/RlUI2005.vcproj	2008-11-26 19:07:20 UTC (rev 4612)
+++ rl/branches/persistence/ui/RlUI2005.vcproj	2008-11-26 19:42:03 UTC (rev 4613)
@@ -432,6 +432,10 @@
 					&gt;
 				&lt;/File&gt;
 				&lt;File
+					RelativePath=&quot;.\include\CharacterSelectionWindow.h&quot;
+					&gt;
+				&lt;/File&gt;
+				&lt;File
 					RelativePath=&quot;.\include\CharacterSheetWindow.h&quot;
 					&gt;
 				&lt;/File&gt;
@@ -677,6 +681,10 @@
 					&gt;
 				&lt;/File&gt;
 				&lt;File
+					RelativePath=&quot;.\src\CharacterSelectionWindow.cpp&quot;
+					&gt;
+				&lt;/File&gt;
+				&lt;File
 					RelativePath=&quot;.\src\CharacterSheetWindow.cpp&quot;
 					&gt;
 				&lt;/File&gt;

Modified: rl/branches/persistence/ui/include/AbstractWindow.h
===================================================================
--- rl/branches/persistence/ui/include/AbstractWindow.h	2008-11-26 19:07:20 UTC (rev 4612)
+++ rl/branches/persistence/ui/include/AbstractWindow.h	2008-11-26 19:42:03 UTC (rev 4613)
@@ -1,140 +1,142 @@
-/* This source file is part of Rastullahs Lockenpracht.
- * Copyright (C) 2003-2008 Team Pantheon. <A HREF="http://www.team-pantheon.de">http://www.team-pantheon.de</A>
- * 
- *  This program is free software; you can redistribute it and/or modify
- *  it under the terms of the Clarified Artistic License.
- *
- *  This program is distributed in the hope that it will be useful,
- *  but WITHOUT ANY WARRANTY; without even the implied warranty of
- *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
- *  Clarified Artistic License for more details.
- *
- *  You should have received a copy of the Clarified Artistic License
- *  along with this program; if not you can get it here
- *  <A HREF="http://www.jpaulmorrison.com/fbp/artistic2.htm.">http://www.jpaulmorrison.com/fbp/artistic2.htm.</A>
- */
-
-#ifndef __AbstractWindow_H__
-#define __AbstractWindow_H__
-
-#include &quot;UiPrerequisites.h&quot;
-
-
-#include &lt;CEGUIWindow.h&gt;
-#include &lt;elements/CEGUIEditbox.h&gt;
-#include &lt;elements/CEGUIListbox.h&gt;
-#include &lt;elements/CEGUIMultiColumnList.h&gt;
-#include &lt;elements/CEGUIMultiLineEditbox.h&gt;
-#include &lt;elements/CEGUIProgressBar.h&gt;
-#include &lt;elements/CEGUIMenuBase.h&gt;
-#include &lt;elements/CEGUIMenuItem.h&gt;
-#include &lt;elements/CEGUIPushButton.h&gt;
-#include &lt;elements/CEGUICombobox.h&gt;
-#include &lt;elements/CEGUIComboDropList.h&gt;
-#include &lt;elements/CEGUIScrollablePane.h&gt;
-#include &lt;elements/CEGUISlider.h&gt;
-#include &lt;elements/CEGUITabControl.h&gt;
-
-namespace rl {
-
-	class WindowUpdateTask;
-
-	/**
-	 * This is the base class for all UI windows
-	 */
-	class _RlUiExport AbstractWindow
-	{
-	public:
-
-		enum WindowInputType
-		{
-			WIT_NONE = 0x00,
-			WIT_MOUSE_INPUT = 0x01,
-			WIT_KEYBOARD_INPUT = 0x02
-		};
-
-		virtual ~AbstractWindow();	
-
-		/// creates a CEGUI window from an XML file, should only be used to load window parts (e.g. buttons)
-		static CEGUI::Window* loadWindow(const CeGuiString&amp; xmlfile);
-
-		/// creates a CEGUI window from an XML file, should only be used to load window parts (e.g. buttons)
-		static CEGUI::Window* loadWindow(const CeGuiString&amp; xmlfile, CeGuiString&amp; prefix);
-
-		/// gets the CEGUI root
-		static CEGUI::Window* getRoot();
-
-		/// gets the wrapped CEGUI window
-		CEGUI::Window* getWindow();
-
-		CEGUI::Window* getWindow(const char* name, const char* requiredClass = NULL);
-		CEGUI::Editbox* getEditbox(const char* name);
-		CEGUI::Listbox* getListbox(const char* name);
-		CEGUI::MultiColumnList* getMultiColumnList(const char* name);
-		CEGUI::MultiLineEditbox* getMultiLineEditbox(const char* name);
-		CEGUI::ProgressBar* getProgressBar(const char* name);
-		CEGUI::MenuBase* getMenu(const char* name);
-		CEGUI::MenuItem* getMenuItem(const char* name);
-		CEGUI::PushButton* getPushButton(const char* name);
-		CEGUI::Combobox* getCombobox(const char* name);
-		CEGUI::ComboDropList* getComboDropList(const char* name);
-        CEGUI::ScrollablePane* getScrollablePane(const char* name);
-		CEGUI::Slider* getSlider(const char* name);
-		CEGUI::TabControl* getTabControl(const char* name);
-
-		int getWindowInputType();
-
-        virtual bool isVisible();
-        virtual void setVisible(bool visible, bool destroyAfterHide = false);
-
-		bool isModal();
-		bool isClosingOnEscape();
-
-		const CeGuiString&amp; getName() const;
-		const Ogre::Real&amp; getNormalAlpha() const;
-
-		virtual void windowHid();
-
-        // return true, if the specified key should be repeated if pressed down
-        virtual bool wantsKeyToRepeat(const int &amp;key) {return false;}
-
-	protected:
-		AbstractWindow(
-			const CeGuiString&amp; xmlfile, 
-			int inputType, 
-			bool closeOnEscape = true,
-			bool modal = false);
-
-		const CeGuiString&amp; getNamePrefix() const;
-		
-		void centerWindow();
-		bool destroyWindow();		
-		bool hideWindow();
-
-		void bindDestroyWindowToClick(CEGUI::Window* button);
-        void bindHideWindowToClick(CEGUI::Window* button);
-		void bindDestroyWindowToXButton();
-		void bindHideWindowToXButton();
-
-		const CeGuiString&amp; getUserDataType(CEGUI::Window* window) const;
-		void setUserDataType(CEGUI::Window* window, const CeGuiString&amp; typeDescription) const;
-
-		CEGUI::Window* mWindow;
-		bool mVisible;
-
-	private:
-		
-		int mWindowInputType;
-		CeGuiString mNamePrefix;
-		CeGuiString mName;
-		bool mModal;
-		bool mCloseOnEscape;
-		Ogre::Real mNormalAlpha;
-
-		static int sNumAbstractWindows;
-
-	};
-
-}
-
-#endif
+/* This source file is part of Rastullahs Lockenpracht.
+ * Copyright (C) 2003-2008 Team Pantheon. <A HREF="http://www.team-pantheon.de">http://www.team-pantheon.de</A>
+ * 
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the Clarified Artistic License.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  Clarified Artistic License for more details.
+ *
+ *  You should have received a copy of the Clarified Artistic License
+ *  along with this program; if not you can get it here
+ *  <A HREF="http://www.jpaulmorrison.com/fbp/artistic2.htm.">http://www.jpaulmorrison.com/fbp/artistic2.htm.</A>
+ */
+
+#ifndef __AbstractWindow_H__
+#define __AbstractWindow_H__
+
+#include &quot;UiPrerequisites.h&quot;
+
+
+#include &lt;CEGUIWindow.h&gt;
+#include &lt;elements/CEGUICheckbox.h&gt;
+#include &lt;elements/CEGUIEditbox.h&gt;
+#include &lt;elements/CEGUIListbox.h&gt;
+#include &lt;elements/CEGUIMultiColumnList.h&gt;
+#include &lt;elements/CEGUIMultiLineEditbox.h&gt;
+#include &lt;elements/CEGUIProgressBar.h&gt;
+#include &lt;elements/CEGUIMenuBase.h&gt;
+#include &lt;elements/CEGUIMenuItem.h&gt;
+#include &lt;elements/CEGUIPushButton.h&gt;
+#include &lt;elements/CEGUICombobox.h&gt;
+#include &lt;elements/CEGUIComboDropList.h&gt;
+#include &lt;elements/CEGUIScrollablePane.h&gt;
+#include &lt;elements/CEGUISlider.h&gt;
+#include &lt;elements/CEGUITabControl.h&gt;
+
+namespace rl {
+
+	class WindowUpdateTask;
+
+	/**
+	 * This is the base class for all UI windows
+	 */
+	class _RlUiExport AbstractWindow
+	{
+	public:
+
+		enum WindowInputType
+		{
+			WIT_NONE = 0x00,
+			WIT_MOUSE_INPUT = 0x01,
+			WIT_KEYBOARD_INPUT = 0x02
+		};
+
+		virtual ~AbstractWindow();	
+
+		/// creates a CEGUI window from an XML file, should only be used to load window parts (e.g. buttons)
+		static CEGUI::Window* loadWindow(const CeGuiString&amp; xmlfile);
+
+		/// creates a CEGUI window from an XML file, should only be used to load window parts (e.g. buttons)
+		static CEGUI::Window* loadWindow(const CeGuiString&amp; xmlfile, CeGuiString&amp; prefix);
+
+		/// gets the CEGUI root
+		static CEGUI::Window* getRoot();
+
+		/// gets the wrapped CEGUI window
+		CEGUI::Window* getWindow();
+
+		CEGUI::Window* getWindow(const char* name, const char* requiredClass = NULL);
+		CEGUI::Editbox* getEditbox(const char* name);
+		CEGUI::Listbox* getListbox(const char* name);
+		CEGUI::MultiColumnList* getMultiColumnList(const char* name);
+		CEGUI::MultiLineEditbox* getMultiLineEditbox(const char* name);
+		CEGUI::ProgressBar* getProgressBar(const char* name);
+		CEGUI::MenuBase* getMenu(const char* name);
+		CEGUI::MenuItem* getMenuItem(const char* name);
+		CEGUI::PushButton* getPushButton(const char* name);
+		CEGUI::Combobox* getCombobox(const char* name);
+		CEGUI::ComboDropList* getComboDropList(const char* name);
+        CEGUI::ScrollablePane* getScrollablePane(const char* name);
+		CEGUI::Slider* getSlider(const char* name);
+		CEGUI::TabControl* getTabControl(const char* name);
+        CEGUI::Checkbox* getCheckbox(const char* name);
+
+		int getWindowInputType();
+
+        virtual bool isVisible();
+        virtual void setVisible(bool visible, bool destroyAfterHide = false);
+
+		bool isModal();
+		bool isClosingOnEscape();
+
+		const CeGuiString&amp; getName() const;
+		const Ogre::Real&amp; getNormalAlpha() const;
+
+		virtual void windowHid();
+
+        // return true, if the specified key should be repeated if pressed down
+        virtual bool wantsKeyToRepeat(const int &amp;key) {return false;}
+
+	protected:
+		AbstractWindow(
+			const CeGuiString&amp; xmlfile, 
+			int inputType, 
+			bool closeOnEscape = true,
+			bool modal = false);
+
+		const CeGuiString&amp; getNamePrefix() const;
+		
+		void centerWindow();
+		bool destroyWindow();		
+		bool hideWindow();
+
+		void bindDestroyWindowToClick(CEGUI::Window* button);
+        void bindHideWindowToClick(CEGUI::Window* button);
+		void bindDestroyWindowToXButton();
+		void bindHideWindowToXButton();
+
+		const CeGuiString&amp; getUserDataType(CEGUI::Window* window) const;
+		void setUserDataType(CEGUI::Window* window, const CeGuiString&amp; typeDescription) const;
+
+		CEGUI::Window* mWindow;
+		bool mVisible;
+
+	private:
+		
+		int mWindowInputType;
+		CeGuiString mNamePrefix;
+		CeGuiString mName;
+		bool mModal;
+		bool mCloseOnEscape;
+		Ogre::Real mNormalAlpha;
+
+		static int sNumAbstractWindows;
+
+	};
+
+}
+
+#endif

Copied: rl/branches/persistence/ui/include/CharacterSelectionWindow.h (from rev 4612, rl/trunk/engine/ui/include/CharacterSelectionWindow.h)

Modified: rl/branches/persistence/ui/include/GameSettings.h
===================================================================
--- rl/branches/persistence/ui/include/GameSettings.h	2008-11-26 19:07:20 UTC (rev 4612)
+++ rl/branches/persistence/ui/include/GameSettings.h	2008-11-26 19:42:03 UTC (rev 4613)
@@ -82,11 +82,17 @@
 		 * configuration section.
 		 */
 		bool onRenderSystemChanged();
+        
+        void update();
 
 		std::list&lt;SoundDriverConfigComponent*&gt; mSoundDriverConfigs;   //!&lt; List of registered sounddriver configuration components
 		SoundDriverConfigComponent* mCurrentSoundDriverConfig;        //!&lt; Configuration component of currently selected sound driver
 		std::list&lt;RenderSystemConfigComponent*&gt; mRenderSystemConfigs; //!&lt; List of registered rendersystem configuration components
 		RenderSystemConfigComponent* mCurrentRenderSystemConfig;      //!&lt; Configuration component of currently selected rendersystem
+        
+        CEGUI::Combobox* mVideoRenderer;
+        CEGUI::Combobox* mVideoResolution;
+        CEGUI::Checkbox* mVideoFullscreen;
 	};
 }
 

Modified: rl/branches/persistence/ui/include/WindowFactory.h
===================================================================
--- rl/branches/persistence/ui/include/WindowFactory.h	2008-11-26 19:07:20 UTC (rev 4612)
+++ rl/branches/persistence/ui/include/WindowFactory.h	2008-11-26 19:42:03 UTC (rev 4613)
@@ -1,142 +1,145 @@
-/* This source file is part of Rastullahs Lockenpracht.
- * Copyright (C) 2003-2008 Team Pantheon. <A HREF="http://www.team-pantheon.de">http://www.team-pantheon.de</A>
- *
- *  This program is free software; you can redistribute it and/or modify
- *  it under the terms of the Clarified Artistic License.
- *
- *  This program is distributed in the hope that it will be useful,
- *  but WITHOUT ANY WARRANTY; without even the implied warranty of
- *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
- *  Clarified Artistic License for more details.
- *
- *  You should have received a copy of the Clarified Artistic License
- *  along with this program; if not you can get it here
- *  <A HREF="http://www.jpaulmorrison.com/fbp/artistic2.htm.">http://www.jpaulmorrison.com/fbp/artistic2.htm.</A>
- */
-
-#ifndef __WindowFactory_H__
-#define __WindowFactory_H__
-
-#include &quot;UiPrerequisites.h&quot;
-
-#include &quot;FixRubyHeaders.h&quot;        // die Makros sind hier vor Ruby schon definiert
-#include &lt;ruby.h&gt;
-#include &quot;FixRubyHeaders.h&quot;
-
-namespace rl {
-
-    class Actor;
-    class AbstractWindow;
-    class CharacterStateWindow;
-    class CharacterSheetWindow;
-    class CloseConfirmationWindow;
-    class CombatWindow;
-    class Console;
-    class Container;
-    class Creature;
-    class DebugWindow;
-    class DialogCharacter;
-    class GameLoggerWindow;
-    class GameObject;
-    class PropertiesWindow;
-    class GameSettings;
-    class InfoPopup;
-    class InGameMenuWindow;
-    class InventoryWindow;
-    class JournalWindow;
-    class LogWindow;
-    class MainMenuWindow;
-    class ObjectDescriptionWindow;
-    class GameSaveLoadWindow;
-    class MainMenuLoadWindow;
-    class WindowUpdater;
-
-    class _RlUiExport WindowFactory : public Ogre::Singleton&lt;WindowFactory&gt;
-    {
-    public:
-        enum PopupIcon
-        {
-            ICON_ERROR = 1,
-            ICON_QUEST
-        };
-
-        WindowFactory();
-        ~WindowFactory();
-
-        void initialize();
-
-        void setActiveCharacter(Creature* character);
-
-        void showActionChoice(GameObject* obj);
-        void showAboutWindow();
-        void showCharacterActionChoice();
-        void showCharacterSheet();
-        void showCharacterSheet(Creature* chara);
-        void showContainerContent(Container* container);
-        void showDescriptionWindow(GameObject* obj);
-        void showPropertiesWindow(GameObject* obj);
-        void showExitConfirmation();
-        void showJournalWindow();
-        void showLogfiles();
-        void showMessageWindow(const CeGuiString&amp; message);
-        void showMainMenu();
-        void showObjectDescription(GameObject* object);
-        void showPlaylist();
-        void showGameSaveLoadWindow();
-        void showMainMenuLoadWindow(MainMenuWindow* win);
-		void hideMainMenuLoadWindow();
-        void showPopupMessage(int popupTypes);
-        void showGameOverWindow();
-        /**
-         * Creates a GameSettings object and displays its layout file on screen
-         */
-        void showGameSettings();
-
-        void toggleConsole();
-        void toggleDebugWindow();
-        void toggleGameLogWindow();
-        void toggleCharacterStateWindow();
-        void toggleInGameGlobalMenu();
-        void toggleInventoryWindow();
-        void notifyInventoryWindowDestroyed();
-		bool isInventoryWindowDestroyed();
-
-        CombatWindow* getCombatWindow();
-
-        void checkForErrors();
-        GameLoggerWindow* getGameLogger();
-
-        void update();
-
-        /// Writes Text into the Console or other output media
-        void writeToConsole(std::string text);
-        static VALUE consoleWrite(VALUE self, VALUE str);
-
-        /// Change shown DebugWindow page
-        void showNextDebugWindowPage();
-
-    private:
-        void logAllWindows();
-
-        GameLoggerWindow* mGameLogger;
-        CharacterStateWindow* mCharacterStateWindow;
-        InGameMenuWindow* mInGameMenuWindow;
-        CharacterSheetWindow* mCharacterSheet;
-        JournalWindow* mJournalWindow;
-        InventoryWindow* mInventoryWindow;
-        LogWindow* mLogWindow;
-        DebugWindow* mDebugWindow;
-        Console* mConsole;
-        InfoPopup* mInfoPopup;
-        Actor* mObjectNameText;
-        GameObject* mShownObject;
-        ObjectDescriptionWindow* mObjectDescriptionWindow;
-        MainMenuWindow* mMainMenuWindow;
-		MainMenuLoadWindow* mMainMenuLoadWindow;
-        CloseConfirmationWindow* mCloseConfirmationWindow;
-        GameSettings* mGameSettings;
-        CombatWindow* mCombatWindow;
-    };
-}
-
-#endif
+/* This source file is part of Rastullahs Lockenpracht.
+ * Copyright (C) 2003-2008 Team Pantheon. <A HREF="http://www.team-pantheon.de">http://www.team-pantheon.de</A>
+ *
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the Clarified Artistic License.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  Clarified Artistic License for more details.
+ *
+ *  You should have received a copy of the Clarified Artistic License
+ *  along with this program; if not you can get it here
+ *  <A HREF="http://www.jpaulmorrison.com/fbp/artistic2.htm.">http://www.jpaulmorrison.com/fbp/artistic2.htm.</A>
+ */
+
+#ifndef __WindowFactory_H__
+#define __WindowFactory_H__
+
+#include &quot;UiPrerequisites.h&quot;
+
+#include &quot;FixRubyHeaders.h&quot;        // die Makros sind hier vor Ruby schon definiert
+#include &lt;ruby.h&gt;
+#include &quot;FixRubyHeaders.h&quot;
+
+namespace rl {
+
+    class Actor;
+    class AbstractWindow;
+    class CharacterSelectionWindow;
+    class CharacterSheetWindow;
+    class CharacterStateWindow;
+    class CloseConfirmationWindow;
+    class CombatWindow;
+    class Console;
+    class Container;
+    class Creature;
+    class DebugWindow;
+    class DialogCharacter;
+    class GameLoggerWindow;
+    class GameObject;
+    class PropertiesWindow;
+    class GameSettings;
+    class InfoPopup;
+    class InGameMenuWindow;
+    class InventoryWindow;
+    class JournalWindow;
+    class LogWindow;
+    class MainMenuWindow;
+    class ObjectDescriptionWindow;
+    class GameSaveLoadWindow;
+    class MainMenuLoadWindow;
+    class WindowUpdater;
+
+    class _RlUiExport WindowFactory : public Ogre::Singleton&lt;WindowFactory&gt;
+    {
+    public:
+        enum PopupIcon
+        {
+            ICON_ERROR = 1,
+            ICON_QUEST
+        };
+
+        WindowFactory();
+        ~WindowFactory();
+
+        void initialize();
+
+        void setActiveCharacter(Creature* character);
+
+        void showActionChoice(GameObject* obj);
+        void showAboutWindow();
+        void showCharacterActionChoice();
+        void showCharacterSheet();
+        void showCharacterSheet(Creature* chara);
+        void showContainerContent(Container* container);
+        void showDescriptionWindow(GameObject* obj);
+        void showPropertiesWindow(GameObject* obj);
+        void showExitConfirmation();
+        void showJournalWindow();
+        void showLogfiles();
+        void showMessageWindow(const CeGuiString&amp; message);
+        void showMainMenu();
+        void showObjectDescription(GameObject* object);
+        void showPlaylist();
+        void showGameSaveLoadWindow();
+        void showMainMenuLoadWindow(MainMenuWindow* win);
+		void hideMainMenuLoadWindow();
+        void showPopupMessage(int popupTypes);
+        void showGameOverWindow();
+        /**
+         * Creates a GameSettings object and displays its layout file on screen
+         */
+        void showGameSettings();
+
+        void toggleConsole();
+        void toggleDebugWindow();
+        void toggleGameLogWindow();
+        void toggleCharacterStateWindow();
+        void toggleCharacterSelectionWindow();
+        void toggleInGameGlobalMenu();
+        void toggleInventoryWindow();
+        void notifyInventoryWindowDestroyed();
+		bool isInventoryWindowDestroyed();
+
+        CombatWindow* getCombatWindow();
+
+        void checkForErrors();
+        GameLoggerWindow* getGameLogger();
+
+        void update();
+
+        /// Writes Text into the Console or other output media
+        void writeToConsole(std::string text);
+        static VALUE consoleWrite(VALUE self, VALUE str);
+
+        /// Change shown DebugWindow page
+        void showNextDebugWindowPage();
+
+    private:
+        void logAllWindows();
+
+        GameLoggerWindow* mGameLogger;
+        CharacterStateWindow* mCharacterStateWindow;
+        InGameMenuWindow* mInGameMenuWindow;
+        CharacterSheetWindow* mCharacterSheet;
+        JournalWindow* mJournalWindow;
+        InventoryWindow* mInventoryWindow;
+        LogWindow* mLogWindow;
+        DebugWindow* mDebugWindow;
+        Console* mConsole;
+        InfoPopup* mInfoPopup;
+        Actor* mObjectNameText;
+        GameObject* mShownObject;
+        ObjectDescriptionWindow* mObjectDescriptionWindow;
+        MainMenuWindow* mMainMenuWindow;
+		MainMenuLoadWindow* mMainMenuLoadWindow;
+        CloseConfirmationWindow* mCloseConfirmationWindow;
+        GameSettings* mGameSettings;
+        CombatWindow* mCombatWindow;
+        CharacterSelectionWindow* mCharacterSelectionWindow;
+    };
+}
+
+#endif

Modified: rl/branches/persistence/ui/src/AbstractWindow.cpp
===================================================================
--- rl/branches/persistence/ui/src/AbstractWindow.cpp	2008-11-26 19:07:20 UTC (rev 4612)
+++ rl/branches/persistence/ui/src/AbstractWindow.cpp	2008-11-26 19:42:03 UTC (rev 4613)
@@ -1,319 +1,325 @@
-/* This source file is part of Rastullahs Lockenpracht.
- * Copyright (C) 2003-2008 Team Pantheon. <A HREF="http://www.team-pantheon.de">http://www.team-pantheon.de</A>
- *
- *  This program is free software; you can redistribute it and/or modify
- *  it under the terms of the Clarified Artistic License.
- *
- *  This program is distributed in the hope that it will be useful,
- *  but WITHOUT ANY WARRANTY; without even the implied warranty of
- *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
- *  Clarified Artistic License for more details.
- *
- *  You should have received a copy of the Clarified Artistic License
- *  along with this program; if not you can get it here
- *  <A HREF="http://www.jpaulmorrison.com/fbp/artistic2.htm.">http://www.jpaulmorrison.com/fbp/artistic2.htm.</A>
- */
-#include &quot;stdinc.h&quot; //precompiled header
-
-#include &lt;boost/bind.hpp&gt;
-#include &lt;CEGUIWindowManager.h&gt;
-#include &lt;elements/CEGUIFrameWindow.h&gt;
-
-#include &quot;UiPrerequisites.h&quot;
-#include &quot;Exception.h&quot;
-
-#include &quot;UiSubsystem.h&quot;
-#include &quot;AbstractWindow.h&quot;
-#include &quot;CeGuiHelper.h&quot;
-#include &quot;WindowManager.h&quot;
-#include &quot;WindowFadeJob.h&quot;
-#include &quot;JobScheduler.h&quot;
-
-using namespace std;
-using namespace CEGUI;
-using namespace Ogre;
-
-namespace rl
-{
-
-	int AbstractWindow::sNumAbstractWindows = 0;
-
-	AbstractWindow::AbstractWindow(const CeGuiString&amp; xmlfile, int inputType, bool closeOnEscape, bool modal)
-	: mVisible(false),
-		mModal(modal),
-		mWindowInputType(inputType),
-		mCloseOnEscape(closeOnEscape)
-	{
-        LOG_MESSAGE(Logger::UI,
-		    &quot;Lade Fenster '&quot; + Ogre::String(xmlfile.c_str()) + &quot;'&quot;);
-   		mWindow = AbstractWindow::loadWindow(xmlfile, mNamePrefix);
-		if (mWindow == NULL)
-		{
-			Throw(rl::IllegalStateException, Ogre::String(&quot;Could not load window '&quot;)+xmlfile.c_str()+&quot;'.&quot;);
-		}
-
-		getRoot()-&gt;addChildWindow(mWindow);
-
-        if (modal)
-		{
-			mWindow-&gt;setModalState(true);
-			mWindow-&gt;setAlwaysOnTop(true);
-            mWindow-&gt;moveToFront();
-            mWindow-&gt;show();
-		}
-        else
-        {
-       		mWindow-&gt;hide();
-        }
-
-		mNormalAlpha = mWindow-&gt;getAlpha();
-		mName = mWindow-&gt;getName();
-		WindowManager::getSingleton().registerWindow(this);
-		mWindow-&gt;subscribeEvent(Window::EventActivated,
-			boost::bind(
-				&amp;rl::WindowManager::handleMovedToFront,
-				rl::WindowManager::getSingletonPtr(),
-				this));
-	}
-
-	AbstractWindow::~AbstractWindow()
-	{
-		mWindow-&gt;hide();
-		mWindow-&gt;removeAllEvents();
-		WindowManager::getSingleton().unregisterWindow(this);
-		getRoot()-&gt;removeChildWindow(mWindow);
-		CEGUI::WindowManager::getSingleton().destroyWindow(mWindow);
-	}
-
-	CEGUI::Window* AbstractWindow::loadWindow(const CeGuiString&amp; xmlfile)
-	{
-		CeGuiString prefix = &quot;&quot;;
-		return loadWindow(xmlfile, prefix);
-	}
-
-
-	CEGUI::Window* AbstractWindow::loadWindow(const CeGuiString&amp; xmlfile, CeGuiString&amp; prefix)
-	{
-		CeGuiString namePrefix;
-		if (prefix == &quot;&quot;)
-			prefix.assign(StringConverter::toString(sNumAbstractWindows));
-		sNumAbstractWindows++;
-
-		CEGUI::Window* window = NULL;
-		try
-		{
-			window = CEGUI::WindowManager::getSingleton().loadWindowLayout(xmlfile, prefix);
-		}
-		catch(...)
-		{
-		}
-
-		return window;
-	}
-
-	bool AbstractWindow::isVisible()
-	{
-		return mVisible;
-	}
-
-	void AbstractWindow::setVisible(bool visible, bool destroy)
-	{
-		if(mVisible != visible)
-		{
-			if (visible)
-			{
-                JobScheduler::getSingleton().addJob(
-                    new WindowFadeJob(this, WindowFadeJob::FADE_IN, mNormalAlpha));
-			}
-			else
-			{
-                JobScheduler::getSingleton().addJob(
-                    new WindowFadeJob(this,
-                    destroy ? WindowFadeJob::FADE_OUT_AND_DESTROY : WindowFadeJob::FADE_OUT,
-                    0.0f));
-			}
-            WindowManager::getSingleton()._visiblityChanged(this, visible);
-            mVisible = visible;
-		}
-	}
-
-	const Ogre::Real&amp; AbstractWindow::getNormalAlpha() const
-	{
-		return mNormalAlpha;
-	}
-
-	bool AbstractWindow::isModal()
-	{
-		return mModal;
-	}
-
-	bool AbstractWindow::isClosingOnEscape()
-	{
-		return mCloseOnEscape;
-	}
-
-	int AbstractWindow::getWindowInputType()
-	{
-		return mWindowInputType;
-	}
-
-	CEGUI::Window* AbstractWindow::getRoot()
-	{
-		return CEGUI::WindowManager::getSingleton().getWindow(
-			(utf8*)UiSubsystem::CEGUI_ROOT);
-	}
-
-	Window* AbstractWindow::getWindow(const char* name, const char* requiredClass)
-	{
-		CEGUI::Window* wnd =
-			CEGUI::WindowManager::getSingleton().getWindow(
-				mNamePrefix + (utf8*)name);
-
-		if (wnd == NULL)
-			Throw(
-				rl::NullPointerException,
-				&quot;Window &quot;
-				+ Ogre::String(name)
-				+ &quot; is NULL&quot;);
-
-		if (requiredClass != NULL &amp;&amp; !wnd-&gt;testClassName(requiredClass))
-			Throw(
-				rl::NullPointerException,
-				&quot;Window &quot;
-				+ Ogre::String(name)
-				+ &quot; has not the required class &quot;
-				+ Ogre::String(requiredClass));
-
-		return wnd;
-	}
-
-	Editbox* AbstractWindow::getEditbox(const char* name)
-	{
-		return static_cast&lt;Editbox*&gt;(getWindow(name, &quot;Editbox&quot;));
-	}
-
-	Listbox* AbstractWindow::getListbox(const char* name)
-	{
-		return static_cast&lt;Listbox*&gt;(getWindow(name, &quot;Listbox&quot;));
-	}
-
-	MultiColumnList* AbstractWindow::getMultiColumnList(const char* name)
-	{
-		return static_cast&lt;MultiColumnList*&gt;(getWindow(name, &quot;MultiColumnList&quot;));
-	}
-
-	MultiLineEditbox* AbstractWindow::getMultiLineEditbox(const char* name)
-	{
-		return static_cast&lt;MultiLineEditbox*&gt;(getWindow(name, &quot;MultiLineEditbox&quot;));
-	}
-
-	ProgressBar* AbstractWindow::getProgressBar(const char* name)
-	{
-		return static_cast&lt;ProgressBar*&gt;(getWindow(name, &quot;ProgressBar&quot;));
-	}
-
-	MenuBase* AbstractWindow::getMenu(const char* name)
-	{
-		return static_cast&lt;MenuBase*&gt;(getWindow(name, &quot;MenuBase&quot;));
-	}
-
-	MenuItem* AbstractWindow::getMenuItem(const char* name)
-	{
-		return static_cast&lt;MenuItem*&gt;(getWindow(name, &quot;MenuItem&quot;));
-	}
-
-	PushButton* AbstractWindow::getPushButton(const char* name)
-	{
-		return static_cast&lt;PushButton*&gt;(getWindow(name, &quot;PushButton&quot;));
-	}
-
-	Combobox* AbstractWindow::getCombobox(const char* name)
-	{
-		return static_cast&lt;Combobox*&gt;(getWindow(name, &quot;Combobox&quot;));
-	}
-
-	ComboDropList* AbstractWindow::getComboDropList(const char* name)
-	{
-		return static_cast&lt;ComboDropList*&gt;(getWindow(name, &quot;ComboDropList&quot;));
-	}
-
-    ScrollablePane* AbstractWindow::getScrollablePane(const char* name)
-    {
-		return static_cast&lt;ScrollablePane*&gt;(getWindow(name, &quot;ScrollablePane&quot;));
-    }
-
-	Slider* AbstractWindow::getSlider(const char* name)
-	{
-		return static_cast&lt;Slider*&gt;(getWindow(name, &quot;Slider&quot;));
-	}
-
-	TabControl* AbstractWindow::getTabControl(const char* name)
-	{
-		return static_cast&lt;TabControl*&gt;(getWindow(name, &quot;TabControl&quot;));
-	}
-
-	const CeGuiString&amp; AbstractWindow::getName() const
-	{
-		return mName;
-	}
-
-	void AbstractWindow::centerWindow()
-	{
-		CEGUI::Size screenSize = System::getSingleton().getRenderer()-&gt;getSize();
-		CEGUI::Size windowSize = mWindow-&gt;getPixelSize();
-		float x = 0.5f * (screenSize.d_width - windowSize.d_width);
-		float y = 0.5f * (screenSize.d_height - windowSize.d_height);
-		mWindow-&gt;setPosition(CeGuiHelper::asAbsolute(CEGUI::Vector2(x, y)));
-	}
-
-	void AbstractWindow::bindDestroyWindowToClick(CEGUI::Window* button)
-	{
-		button-&gt;subscribeEvent(Window::EventMouseClick,
-			boost::bind(&amp;AbstractWindow::destroyWindow, this));
-	}
-
-    void AbstractWindow::bindHideWindowToClick(CEGUI::Window* button)
-	{
-		button-&gt;subscribeEvent(Window::EventMouseClick,
-			boost::bind(&amp;AbstractWindow::hideWindow, this));
-	}
-
-	void AbstractWindow::bindDestroyWindowToXButton()
-	{
-		mWindow-&gt;subscribeEvent(FrameWindow::EventCloseClicked,
-			boost::bind(&amp;AbstractWindow::destroyWindow, this));
-	}
-
-	void AbstractWindow::bindHideWindowToXButton()
-	{
-		mWindow-&gt;subscribeEvent(FrameWindow::EventCloseClicked,
-			boost::bind(&amp;AbstractWindow::hideWindow, this));
-	}
-
-	bool AbstractWindow::destroyWindow()
-	{
-		setVisible(false, true);
-		return true;
-	}
-
-	bool AbstractWindow::hideWindow()
-	{
-		setVisible(false);
-		return true;
-	}
-
-	CEGUI::Window* AbstractWindow::getWindow()
-	{
-		return mWindow;
-	}
-
-	const CeGuiString&amp; AbstractWindow::getNamePrefix() const
-	{
-		return mNamePrefix;
-	}
-
-	void AbstractWindow::windowHid()
-	{
-	}
-
-}
+/* This source file is part of Rastullahs Lockenpracht.
+ * Copyright (C) 2003-2008 Team Pantheon. <A HREF="http://www.team-pantheon.de">http://www.team-pantheon.de</A>
+ *
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the Clarified Artistic License.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  Clarified Artistic License for more details.
+ *
+ *  You should have received a copy of the Clarified Artistic License
+ *  along with this program; if not you can get it here
+ *  <A HREF="http://www.jpaulmorrison.com/fbp/artistic2.htm.">http://www.jpaulmorrison.com/fbp/artistic2.htm.</A>
+ */
+#include &quot;stdinc.h&quot; //precompiled header
+
+#include &lt;boost/bind.hpp&gt;
+#include &lt;CEGUIWindowManager.h&gt;
+#include &lt;elements/CEGUIFrameWindow.h&gt;
+
+#include &quot;UiPrerequisites.h&quot;
+#include &quot;Exception.h&quot;
+
+#include &quot;UiSubsystem.h&quot;
+#include &quot;AbstractWindow.h&quot;
+#include &quot;CeGuiHelper.h&quot;
+#include &quot;WindowManager.h&quot;
+#include &quot;WindowFadeJob.h&quot;
+#include &quot;JobScheduler.h&quot;
+
+using namespace std;
+using namespace CEGUI;
+using namespace Ogre;
+
+namespace rl
+{
+
+	int AbstractWindow::sNumAbstractWindows = 0;
+
+	AbstractWindow::AbstractWindow(const CeGuiString&amp; xmlfile, int inputType, bool closeOnEscape, bool modal)
+	: mVisible(false),
+		mModal(modal),
+		mWindowInputType(inputType),
+		mCloseOnEscape(closeOnEscape)
+	{
+        LOG_MESSAGE(Logger::UI,
+		    &quot;Lade Fenster '&quot; + Ogre::String(xmlfile.c_str()) + &quot;'&quot;);
+   		mWindow = AbstractWindow::loadWindow(xmlfile, mNamePrefix);
+		if (mWindow == NULL)
+		{
+			Throw(rl::IllegalStateException, Ogre::String(&quot;Could not load window '&quot;)+xmlfile.c_str()+&quot;'.&quot;);
+		}
+
+		getRoot()-&gt;addChildWindow(mWindow);
+
+        if (modal)
+		{
+			mWindow-&gt;setModalState(true);
+			mWindow-&gt;setAlwaysOnTop(true);
+            mWindow-&gt;moveToFront();
+            mWindow-&gt;show();
+		}
+        else
+        {
+       		mWindow-&gt;hide();
+        }
+
+		mNormalAlpha = mWindow-&gt;getAlpha();
+		mName = mWindow-&gt;getName();
+		WindowManager::getSingleton().registerWindow(this);
+		mWindow-&gt;subscribeEvent(Window::EventActivated,
+			boost::bind(
+				&amp;rl::WindowManager::handleMovedToFront,
+				rl::WindowManager::getSingletonPtr(),
+				this));
+	}
+
+	AbstractWindow::~AbstractWindow()
+	{
+		mWindow-&gt;hide();
+		mWindow-&gt;removeAllEvents();
+		WindowManager::getSingleton().unregisterWindow(this);
+		getRoot()-&gt;removeChildWindow(mWindow);
+		CEGUI::WindowManager::getSingleton().destroyWindow(mWindow);
+	}
+
+	CEGUI::Window* AbstractWindow::loadWindow(const CeGuiString&amp; xmlfile)
+	{
+		CeGuiString prefix = &quot;&quot;;
+		return loadWindow(xmlfile, prefix);
+	}
+
+
+	CEGUI::Window* AbstractWindow::loadWindow(const CeGuiString&amp; xmlfile, CeGuiString&amp; prefix)
+	{
+		CeGuiString namePrefix;
+		if (prefix == &quot;&quot;)
+			prefix.assign(StringConverter::toString(sNumAbstractWindows));
+		sNumAbstractWindows++;
+
+		CEGUI::Window* window = NULL;
+		try
+		{
+			window = CEGUI::WindowManager::getSingleton().loadWindowLayout(xmlfile, prefix);
+		}
+		catch(...)
+		{
+		}
+
+		return window;
+	}
+
+	bool AbstractWindow::isVisible()
+	{
+		return mVisible;
+	}
+
+	void AbstractWindow::setVisible(bool visible, bool destroy)
+	{
+		if(mVisible != visible)
+		{
+			if (visible)
+			{
+                JobScheduler::getSingleton().addJob(
+                    new WindowFadeJob(this, WindowFadeJob::FADE_IN, mNormalAlpha));
+			}
+			else
+			{
+                JobScheduler::getSingleton().addJob(
+                    new WindowFadeJob(this,
+                    destroy ? WindowFadeJob::FADE_OUT_AND_DESTROY : WindowFadeJob::FADE_OUT,
+                    0.0f));
+			}
+            WindowManager::getSingleton()._visiblityChanged(this, visible);
+            mVisible = visible;
+		}
+	}
+
+	const Ogre::Real&amp; AbstractWindow::getNormalAlpha() const
+	{
+		return mNormalAlpha;
+	}
+
+	bool AbstractWindow::isModal()
+	{
+		return mModal;
+	}
+
+	bool AbstractWindow::isClosingOnEscape()
+	{
+		return mCloseOnEscape;
+	}
+
+	int AbstractWindow::getWindowInputType()
+	{
+		return mWindowInputType;
+	}
+
+	CEGUI::Window* AbstractWindow::getRoot()
+	{
+		return CEGUI::WindowManager::getSingleton().getWindow(
+			(utf8*)UiSubsystem::CEGUI_ROOT);
+	}
+
+	Window* AbstractWindow::getWindow(const char* name, const char* requiredClass)
+	{
+		CEGUI::Window* wnd =
+			CEGUI::WindowManager::getSingleton().getWindow(
+				mNamePrefix + (utf8*)name);
+
+		if (wnd == NULL)
+			Throw(
+				rl::NullPointerException,
+				&quot;Window &quot;
+				+ Ogre::String(name)
+				+ &quot; is NULL&quot;);
+
+		if (requiredClass != NULL &amp;&amp; !wnd-&gt;testClassName(requiredClass)) {
+            Throw(
+				rl::NullPointerException,
+				&quot;Window &quot;
+				+ Ogre::String(name)
+				+ &quot; has not the required class &quot;
+				+ Ogre::String(requiredClass));
+        }
+
+		return wnd;
+	}
+
+	Editbox* AbstractWindow::getEditbox(const char* name)
+	{
+		return static_cast&lt;Editbox*&gt;(getWindow(name, &quot;Editbox&quot;));
+	}
+    
+	Checkbox* AbstractWindow::getCheckbox(const char* name)
+	{
+		return static_cast&lt;Checkbox*&gt;(getWindow(name, &quot;Checkbox&quot;));
+	}
+    
+	Listbox* AbstractWindow::getListbox(const char* name)
+	{
+		return static_cast&lt;Listbox*&gt;(getWindow(name, &quot;Listbox&quot;));
+	}
+
+	MultiColumnList* AbstractWindow::getMultiColumnList(const char* name)
+	{
+		return static_cast&lt;MultiColumnList*&gt;(getWindow(name, &quot;MultiColumnList&quot;));
+	}
+
+	MultiLineEditbox* AbstractWindow::getMultiLineEditbox(const char* name)
+	{
+		return static_cast&lt;MultiLineEditbox*&gt;(getWindow(name, &quot;MultiLineEditbox&quot;));
+	}
+
+	ProgressBar* AbstractWindow::getProgressBar(const char* name)
+	{
+		return static_cast&lt;ProgressBar*&gt;(getWindow(name, &quot;ProgressBar&quot;));
+	}
+
+	MenuBase* AbstractWindow::getMenu(const char* name)
+	{
+		return static_cast&lt;MenuBase*&gt;(getWindow(name, &quot;MenuBase&quot;));
+	}
+
+	MenuItem* AbstractWindow::getMenuItem(const char* name)
+	{
+		return static_cast&lt;MenuItem*&gt;(getWindow(name, &quot;MenuItem&quot;));
+	}
+
+	PushButton* AbstractWindow::getPushButton(const char* name)
+	{
+		return static_cast&lt;PushButton*&gt;(getWindow(name, &quot;PushButton&quot;));
+	}
+
+	Combobox* AbstractWindow::getCombobox(const char* name)
+	{
+		return static_cast&lt;Combobox*&gt;(getWindow(name, &quot;Combobox&quot;));
+	}
+
+	ComboDropList* AbstractWindow::getComboDropList(const char* name)
+	{
+		return static_cast&lt;ComboDropList*&gt;(getWindow(name, &quot;ComboDropList&quot;));
+	}
+
+    ScrollablePane* AbstractWindow::getScrollablePane(const char* name)
+    {
+		return static_cast&lt;ScrollablePane*&gt;(getWindow(name, &quot;ScrollablePane&quot;));
+    }
+
+	Slider* AbstractWindow::getSlider(const char* name)
+	{
+		return static_cast&lt;Slider*&gt;(getWindow(name, &quot;Slider&quot;));
+	}
+
+	TabControl* AbstractWindow::getTabControl(const char* name)
+	{
+		return static_cast&lt;TabControl*&gt;(getWindow(name, &quot;TabControl&quot;));
+	}
+
+	const CeGuiString&amp; AbstractWindow::getName() const
+	{
+		return mName;
+	}
+
+	void AbstractWindow::centerWindow()
+	{
+		CEGUI::Size screenSize = System::getSingleton().getRenderer()-&gt;getSize();
+		CEGUI::Size windowSize = mWindow-&gt;getPixelSize();
+		float x = 0.5f * (screenSize.d_width - windowSize.d_width);
+		float y = 0.5f * (screenSize.d_height - windowSize.d_height);
+		mWindow-&gt;setPosition(CeGuiHelper::asAbsolute(CEGUI::Vector2(x, y)));
+	}
+
+	void AbstractWindow::bindDestroyWindowToClick(CEGUI::Window* button)
+	{
+		button-&gt;subscribeEvent(Window::EventMouseClick,
+			boost::bind(&amp;AbstractWindow::destroyWindow, this));
+	}
+
+    void AbstractWindow::bindHideWindowToClick(CEGUI::Window* button)
+	{
+		button-&gt;subscribeEvent(Window::EventMouseClick,
+			boost::bind(&amp;AbstractWindow::hideWindow, this));
+	}
+
+	void AbstractWindow::bindDestroyWindowToXButton()
+	{
+		mWindow-&gt;subscribeEvent(FrameWindow::EventCloseClicked,
+			boost::bind(&amp;AbstractWindow::destroyWindow, this));
+	}
+
+	void AbstractWindow::bindHideWindowToXButton()
+	{
+		mWindow-&gt;subscribeEvent(FrameWindow::EventCloseClicked,
+			boost::bind(&amp;AbstractWindow::hideWindow, this));
+	}
+
+	bool AbstractWindow::destroyWindow()
+	{
+		setVisible(false, true);
+		return true;
+	}
+
+	bool AbstractWindow::hideWindow()
+	{
+		setVisible(false);
+		return true;
+	}
+
+	CEGUI::Window* AbstractWindow::getWindow()
+	{
+		return mWindow;
+	}
+
+	const CeGuiString&amp; AbstractWindow::getNamePrefix() const
+	{
+		return mNamePrefix;
+	}
+
+	void AbstractWindow::windowHid()
+	{
+	}
+
+}

Copied: rl/branches/persistence/ui/src/CharacterSelectionWindow.cpp (from rev 4612, rl/trunk/engine/ui/src/CharacterSelectionWindow.cpp)

Modified: rl/branches/persistence/ui/src/CharacterStateWindow.cpp
===================================================================
--- rl/branches/persistence/ui/src/CharacterStateWindow.cpp	2008-11-26 19:07:20 UTC (rev 4612)
+++ rl/branches/persistence/ui/src/CharacterStateWindow.cpp	2008-11-26 19:42:03 UTC (rev 4613)
@@ -1,118 +1,134 @@
-/* This source file is part of Rastullahs Lockenpracht.
- * Copyright (C) 2003-2008 Team Pantheon. <A HREF="http://www.team-pantheon.de">http://www.team-pantheon.de</A>
- *
- *  This program is free software; you can redistribute it and/or modify
- *  it under the terms of the Clarified Artistic License.
- *
- *  This program is distributed in the hope that it will be useful,
- *  but WITHOUT ANY WARRANTY; without even the implied warranty of
- *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
- *  Clarified Artistic License for more details.
- *
- *  You should have received a copy of the Clarified Artistic License
- *  along with this program; if not you can get it here
- *  <A HREF="http://www.jpaulmorrison.com/fbp/artistic2.htm.">http://www.jpaulmorrison.com/fbp/artistic2.htm.</A>
- */
-#include &quot;stdinc.h&quot; //precompiled header
-
-#include &lt;boost/bind.hpp&gt;
-#include &quot;UiPrerequisites.h&quot;
-
-#include &quot;DsaManager.h&quot;
-#include &quot;Creature.h&quot;
-#include &quot;InputManager.h&quot;
-#include &quot;Talent.h&quot;
-
-#include &quot;CharacterStateWindow.h&quot;
-
-using namespace CEGUI;
-using namespace Ogre;
-
-
-namespace rl {
-
-CharacterStateWindow::CharacterStateWindow()
-: AbstractWindow(&quot;characterstatewindow.xml&quot;, WIT_NONE, false),
-	mCharacter(NULL)
-{
-	mLP = getProgressBar(&quot;CharacterStateWindow/LP&quot;);
-	mAP = getProgressBar(&quot;CharacterStateWindow/AP&quot;);
-	mAU = getProgressBar(&quot;CharacterStateWindow/AU&quot;);
-	mName = getWindow(&quot;CharacterStateWindow/Name&quot;);
-}
-
-CharacterStateWindow::~CharacterStateWindow()
-{
-    if (mCharacter != NULL)
-		mCharacter-&gt;removeObjectStateChangeListener(this);
-}
-
-void CharacterStateWindow::setCharacter(Creature* person)
-{
-	if (mCharacter != NULL)
-		mCharacter-&gt;removeObjectStateChangeListener(this);
-
-	mCharacter = person;
-    if(mCharacter)
-        mCharacter-&gt;addObjectStateChangeListener(this);
-	update();
-}
-
-void CharacterStateWindow::update()
-{
-	if (!isVisible())
-		return;
-	if (mCharacter == NULL)
-		return;
-
-	mName-&gt;setText(mCharacter-&gt;getName());
-
-	float lep;
-	if (mCharacter-&gt;getLeMax() &lt;= 0)
-		lep = 0.0;
-	else
-		lep = (float)mCharacter-&gt;getLe() / (float)mCharacter-&gt;getLeMax();
-	mLP-&gt;setProgress(lep);
-
-	float au;
-	if (mCharacter-&gt;getAuMax() &lt;= 0)
-		au = 0.0;
-	else
-		au = (float)mCharacter-&gt;getAu() / (float)mCharacter-&gt;getAuMax();
-	mAU-&gt;setProgress(au);
-
-	if (!mCharacter-&gt;isMagic())
-	{
-		if (mAP-&gt;isVisible())
-			mAP-&gt;setVisible(false);
-		return;
-	}
-
-	if (!mAP-&gt;isVisible())
-		mAP-&gt;setVisible(true);
-
-	float asp;
-	if (mCharacter-&gt;getAeMax() &lt;= 0)
-		asp = 0.0;
-	else
-		asp = (float)mCharacter-&gt;getAe() / (float)mCharacter-&gt;getAeMax();
-	mAP-&gt;setProgress(asp);
-
-}
-
-void CharacterStateWindow::objectStateChanged(ObjectStateChangeEvent* evt)
-{
-	update();
-}
-
-void CharacterStateWindow::setVisible(bool visible, bool destroyAfterHide)
-{
-	AbstractWindow::setVisible(visible, destroyAfterHide);
-	if (visible)
-	{
-		update();
-	}
-}
-
-
-}
+/* This source file is part of Rastullahs Lockenpracht.
+ * Copyright (C) 2003-2008 Team Pantheon. <A HREF="http://www.team-pantheon.de">http://www.team-pantheon.de</A>
+ *
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the Clarified Artistic License.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  Clarified Artistic License for more details.
+ *
+ *  You should have received a copy of the Clarified Artistic License
+ *  along with this program; if not you can get it here
+ *  <A HREF="http://www.jpaulmorrison.com/fbp/artistic2.htm.">http://www.jpaulmorrison.com/fbp/artistic2.htm.</A>
+ */
+#include &quot;stdinc.h&quot; //precompiled header
+
+#include &lt;boost/bind.hpp&gt;
+#include &quot;UiPrerequisites.h&quot;
+
+#include &quot;DsaManager.h&quot;
+#include &quot;Creature.h&quot;
+#include &quot;InputManager.h&quot;
+#include &quot;Talent.h&quot;
+
+#include &quot;CharacterStateWindow.h&quot;
+
+using namespace CEGUI;
+using namespace Ogre;
+
+
+namespace rl {
+
+CharacterStateWindow::CharacterStateWindow()
+: AbstractWindow(&quot;characterstatewindow.xml&quot;, WIT_NONE, false),
+	mCharacter(NULL)
+{
+	mLP = getProgressBar(&quot;CharacterStateWindow/LP&quot;);
+	mAP = getProgressBar(&quot;CharacterStateWindow/AP&quot;);
+	mAU = getProgressBar(&quot;CharacterStateWindow/AU&quot;);
+	mName = getWindow(&quot;CharacterStateWindow/Name&quot;);
+}
+
+CharacterStateWindow::~CharacterStateWindow()
+{
+    if (mCharacter != NULL)
+		mCharacter-&gt;removeObjectStateChangeListener(this);
+}
+
+void CharacterStateWindow::setCharacter(Creature* person)
+{
+	if (mCharacter != NULL)
+		mCharacter-&gt;removeObjectStateChangeListener(this);
+
+	mCharacter = person;
+    if(mCharacter)
+        mCharacter-&gt;addObjectStateChangeListener(this);
+	update();
+}
+
+void CharacterStateWindow::update()
+{
+	if (!isVisible() || mCharacter == NULL)
+    {
+		return;
+    }
+        
+	mName-&gt;setText(mCharacter-&gt;getName());
+
+	float lep;
+	if (mCharacter-&gt;getLeMax() &lt;= 0)
+    {
+		lep = 0.0;        
+    }
+	else
+    {
+		lep = (float)mCharacter-&gt;getLe() / (float)mCharacter-&gt;getLeMax();        
+    }
+	mLP-&gt;setProgress(lep);
+
+	float au;
+	if (mCharacter-&gt;getAuMax() &lt;= 0)
+    {
+		au = 0.0;        
+    }
+	else
+    {
+		au = (float)mCharacter-&gt;getAu() / (float)mCharacter-&gt;getAuMax();        
+    }
+	mAU-&gt;setProgress(au);
+
+	if (!mCharacter-&gt;isMagic())
+	{
+		if (mAP-&gt;isVisible()) 
+        {
+			mAP-&gt;setVisible(false);            
+        }
+	}
+    else 
+    {
+     	if (!mAP-&gt;isVisible()) 
+        {
+            mAP-&gt;setVisible(true);            
+        }
+        
+        float asp;
+        if (mCharacter-&gt;getAeMax() &lt;= 0)
+        {
+            asp = 0.0;
+        }
+        else
+        {
+            asp = (float)mCharacter-&gt;getAe() / (float)mCharacter-&gt;getAeMax();
+        }
+        mAP-&gt;setProgress(asp);        
+    }
+}
+
+void CharacterStateWindow::objectStateChanged(ObjectStateChangeEvent* evt)
+{
+	update();
+}
+
+void CharacterStateWindow::setVisible(bool visible, bool destroyAfterHide)
+{
+	AbstractWindow::setVisible(visible, destroyAfterHide);
+	if (visible)
+	{
+		update();
+	}
+}
+
+
+}

Modified: rl/branches/persistence/ui/src/GameSettings.cpp
===================================================================
--- rl/branches/persistence/ui/src/GameSettings.cpp	2008-11-26 19:07:20 UTC (rev 4612)
+++ rl/branches/persistence/ui/src/GameSettings.cpp	2008-11-26 19:42:03 UTC (rev 4613)
@@ -25,6 +25,8 @@
 #include &quot;SoundManager.h&quot;
 #include &quot;SoundDriver.h&quot;
 
+using namespace Ogre;
+
 namespace rl
 {
     GameSettings::GameSettings()
@@ -46,8 +48,12 @@
         getWindow()-&gt;subscribeEvent(CEGUI::FrameWindow::EventCloseClicked,
                                     boost::bind(&amp;GameSettings::onCancel, this));
 
+        mVideoRenderer = getCombobox(&quot;GameOptionsWindow/Video/Renderer&quot;);
+        mVideoResolution = getCombobox(&quot;GameOptionsWindow/Video/Resolution&quot;);
+        mVideoFullscreen = getCheckbox(&quot;GameOptionsWindow/Video/Fullscreen&quot;);
         centerWindow();
         setVisible(false);
+        update();
     }
 
     GameSettings::~GameSettings()
@@ -127,4 +133,54 @@
     {
         return true;
     }
+    
+    void GameSettings::update()
+    {
+        Root* root = Ogre::Root::getSingletonPtr();
+        RenderSystem* renderer = root-&gt;getRenderSystem();
+        
+        ConfigOptionMap config = renderer-&gt;getConfigOptions();
+        
+		ConfigOptionMap::iterator cfi;
+		
+		cfi = config.find( &quot;Full Screen&quot; );
+		if( cfi != config.end() )
+		{
+			mVideoFullscreen-&gt;setSelected(cfi-&gt;second.currentValue == &quot;Yes&quot;);
+		}
+        
+/*		cfi = config.find( &quot;FSAA&quot; );
+		if( cfi != config.end() )
+		{
+			if( cfi-&gt;second.currentValue == &quot;0&quot; )
+			{
+				SetControlValue( iFSAARef, 1 );
+			}
+			else if( cfi-&gt;second.currentValue == &quot;2&quot; )
+			{
+				SetControlValue( iFSAARef, 2 );
+			}
+			else if( cfi-&gt;second.currentValue == &quot;4&quot; )
+			{
+				SetControlValue( iFSAARef, 3 );
+			}
+			else if( cfi-&gt;second.currentValue == &quot;6&quot; )
+			{
+				SetControlValue( iFSAARef, 4 );
+			}
+		}
+        
+		cfi = config.find( &quot;Colour Depth&quot; );
+		if( cfi != config.end() )
+		{
+			if( cfi-&gt;second.currentValue == &quot;32&quot; )
+			{
+				SetControlValue( iColorDepthRef, 1 );
+			}
+			else
+			{
+				SetControlValue( iColorDepthRef, 2 );
+			}
+		}*/
+    }
 }

Modified: rl/branches/persistence/ui/src/InventoryWindow.cpp
===================================================================
--- rl/branches/persistence/ui/src/InventoryWindow.cpp	2008-11-26 19:07:20 UTC (rev 4612)
+++ rl/branches/persistence/ui/src/InventoryWindow.cpp	2008-11-26 19:42:03 UTC (rev 4613)
@@ -174,7 +174,6 @@
     ItemDragContainer* InventoryWindow::getItemDragContainer(const Item* item, bool description)
     {
 		CeGuiString dragContainerName = getDragContainerNameFromItem(item, description);
-		ItemDragContainer* itemhandler = NULL;
 
 		DndContainerMap::iterator iter = mWorldDragContainers.find(dragContainerName);
         if( iter != mWorldDragContainers.end() )

Modified: rl/branches/persistence/ui/src/WindowFactory.cpp
===================================================================
--- rl/branches/persistence/ui/src/WindowFactory.cpp	2008-11-26 19:07:20 UTC (rev 4612)
+++ rl/branches/persistence/ui/src/WindowFactory.cpp	2008-11-26 19:42:03 UTC (rev 4613)
@@ -20,6 +20,7 @@
 #include &quot;AboutWindow.h&quot;
 #include &quot;ActionChoiceWindow.h&quot;
 #include &quot;ActorManager.h&quot;
+#include &quot;CharacterSelectionWindow.h&quot;
 #include &quot;CharacterSheetWindow.h&quot;
 #include &quot;CharacterStateWindow.h&quot;
 #include &quot;CloseConfirmationWindow.h&quot;
@@ -85,7 +86,8 @@
         mMainMenuWindow(NULL),
 		mMainMenuLoadWindow(NULL),
         mGameSettings(NULL),
-        mCombatWindow(NULL)
+        mCombatWindow(NULL),
+        mCharacterSelectionWindow(NULL)
     {
     }
 
@@ -111,6 +113,8 @@
         RulesSubsystem::getSingleton().getQuestBook()-&gt;addQuestListener(mJournalWindow);
         //RulesSubsystem::getSingleton().getQuestBook()-&gt;addQuestListener(mInfoPopup);
         mMainMenuWindow = new MainMenuWindow( new MainMenuEngineWindow() );
+        
+        mCharacterSelectionWindow = new CharacterSelectionWindow();
 
         logAllWindows();
     }
@@ -292,7 +296,13 @@
     {
         mCharacterStateWindow-&gt;setVisible(!mCharacterStateWindow-&gt;isVisible());
     }
-
+    
+    void WindowFactory::toggleCharacterSelectionWindow()
+    {
+        mCharacterSelectionWindow-&gt;setVisible(!mCharacterSelectionWindow-&gt;isVisible());
+        mCharacterSelectionWindow-&gt;update();
+    }
+    
     void WindowFactory::toggleInGameGlobalMenu()
     {
         mInGameMenuWindow-&gt;setVisible(!mInGameMenuWindow-&gt;isVisible());


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001669.html">[Dsa-hl-svn] r4612 - in rl/trunk/engine/ui: include src
</A></li>
	<LI>Next message: <A HREF="001671.html">[Dsa-hl-svn] r4614 - in dependencies/OgreNewt_ngt: inc src
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1670">[ date ]</a>
              <a href="thread.html#1670">[ thread ]</a>
              <a href="subject.html#1670">[ subject ]</a>
              <a href="author.html#1670">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/dsa-hl-svn">More information about the Dsa-hl-svn
mailing list</a><br>
</body></html>
