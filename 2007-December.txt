From timm at mail.berlios.de  Wed Dec  5 18:03:25 2007
From: timm at mail.berlios.de (timm at mail.berlios.de)
Date: Wed, 5 Dec 2007 18:03:25 +0100
Subject: [Dsa-hl-svn] r4015 - rl/trunk/engine/ui/src
Message-ID: <200712051703.lB5H3Ppo018690@sheep.berlios.de>

Author: timm
Date: 2007-12-05 18:03:18 +0100 (Wed, 05 Dec 2007)
New Revision: 4015

Modified:
   rl/trunk/engine/ui/src/WindowFactory.cpp
Log:
removed unnecessary update call

Modified: rl/trunk/engine/ui/src/WindowFactory.cpp
===================================================================
--- rl/trunk/engine/ui/src/WindowFactory.cpp	2007-11-29 00:59:44 UTC (rev 4014)
+++ rl/trunk/engine/ui/src/WindowFactory.cpp	2007-12-05 17:03:18 UTC (rev 4015)
@@ -342,7 +342,6 @@
     void WindowFactory::setActiveCharacter(Creature* character)
     {
         mCharacterStateWindow->setCharacter(character);
-        mCharacterStateWindow->update();
         LOG_MESSAGE(Logger::UI, "CharacterStateWindow updated");
     }
 



From blakharaz at mail.berlios.de  Wed Dec  5 20:24:44 2007
From: blakharaz at mail.berlios.de (blakharaz at mail.berlios.de)
Date: Wed, 5 Dec 2007 20:24:44 +0100
Subject: [Dsa-hl-svn] r4016 - in rl/trunk/engine/ui: include src
Message-ID: <200712051924.lB5JOiJK012466@sheep.berlios.de>

Author: blakharaz
Date: 2007-12-05 20:24:38 +0100 (Wed, 05 Dec 2007)
New Revision: 4016

Modified:
   rl/trunk/engine/ui/include/Makefile.am
   rl/trunk/engine/ui/src/Makefile.am
Log:
Fix Makefiles

Modified: rl/trunk/engine/ui/include/Makefile.am
===================================================================
--- rl/trunk/engine/ui/include/Makefile.am	2007-12-05 17:03:18 UTC (rev 4015)
+++ rl/trunk/engine/ui/include/Makefile.am	2007-12-05 19:24:38 UTC (rev 4016)
@@ -20,7 +20,7 @@
     FreeflightControlState.h \
     GameLoggerWindow.h \
     GameObjectInfoWindow.h \
-    SaveLoadWindow.h \
+    GameSaveLoadWindow.h \
     GameSettings.h \
     InfoPopup.h \
     InGameMenuWindow.h \
@@ -41,7 +41,6 @@
     ProgressWindow.h \
     PropertiesWindow.h \
     RenderSystemConfigComponent.h \
-    SaveLoadWindow.h \
     SoundDriverConfigComponent.h \
     SubtitleWindow.h \
     UiPrerequisites.h \

Modified: rl/trunk/engine/ui/src/Makefile.am
===================================================================
--- rl/trunk/engine/ui/src/Makefile.am	2007-12-05 17:03:18 UTC (rev 4015)
+++ rl/trunk/engine/ui/src/Makefile.am	2007-12-05 19:24:38 UTC (rev 4016)
@@ -28,6 +28,7 @@
     FreeflightControlState.cpp \
     GameLoggerWindow.cpp \
     GameObjectInfoWindow.cpp \
+    GameSaveLoadWindow.cpp \
     GameSettings.cpp \
     InfoPopup.cpp \
     InGameMenuWindow.cpp \
@@ -48,7 +49,6 @@
     ProgressWindow.cpp \
     PropertiesWindow.cpp \
     RenderSystemConfigComponent.cpp \
-    SaveLoadWindow.cpp \
     SoundConfig.cpp \
     SoundDriverConfigComponent.cpp \
     SubtitleWindow.cpp \



From timm at mail.berlios.de  Wed Dec  5 20:45:16 2007
From: timm at mail.berlios.de (timm at mail.berlios.de)
Date: Wed, 5 Dec 2007 20:45:16 +0100
Subject: [Dsa-hl-svn] r4017 - rl/trunk/engine/core/src
Message-ID: <200712051945.lB5JjGKg014686@sheep.berlios.de>

Author: timm
Date: 2007-12-05 20:45:10 +0100 (Wed, 05 Dec 2007)
New Revision: 4017

Modified:
   rl/trunk/engine/core/src/SaveGameManager.cpp
Log:
sending more messages

Modified: rl/trunk/engine/core/src/SaveGameManager.cpp
===================================================================
--- rl/trunk/engine/core/src/SaveGameManager.cpp	2007-12-05 19:24:38 UTC (rev 4016)
+++ rl/trunk/engine/core/src/SaveGameManager.cpp	2007-12-05 19:45:10 UTC (rev 4017)
@@ -92,6 +92,8 @@
 
     void SaveGameManager::saveSaveGameFile(const CeGuiString &name)
     {
+        MessagePump::getSingleton().sendMessage<MessageType_SaveGameSaving>();
+
         time_t rawTime;
         tm* localTime; 
         time(&rawTime);
@@ -117,13 +119,15 @@
     {
         if(SaveGameFileExists(name))
         {
+            MessagePump::getSingleton().sendMessage<MessageType_SaveGameLoading>();
+
             SaveGameFile file(name);
             SaveGameFileReader reader;
             reader.parseSaveGameFile(&file, mSaveGameDataOrderMap);
             ///@todo: SaveGameReader
+
+            MessagePump::getSingleton().sendMessage<MessageType_SaveGameLoaded>();
         }
-
-        MessagePump::getSingleton().sendMessage<MessageType_SaveGameLoaded>();
     }
 
     void SaveGameManager::deleteSaveGameFile(const CeGuiString &name)



From timm at mail.berlios.de  Wed Dec  5 20:48:52 2007
From: timm at mail.berlios.de (timm at mail.berlios.de)
Date: Wed, 5 Dec 2007 20:48:52 +0100
Subject: [Dsa-hl-svn] r4018 - in rl/trunk/engine: rules/src ui/include ui/src
Message-ID: <200712051948.lB5Jmq3g014940@sheep.berlios.de>

Author: timm
Date: 2007-12-05 20:48:29 +0100 (Wed, 05 Dec 2007)
New Revision: 4018

Modified:
   rl/trunk/engine/rules/src/CreatureController.cpp
   rl/trunk/engine/rules/src/GameObjectManager.cpp
   rl/trunk/engine/ui/include/UiSubsystem.h
   rl/trunk/engine/ui/src/CharacterStateWindow.cpp
   rl/trunk/engine/ui/src/UiSubsystem.cpp
Log:
- setting material id in create controller
- removing game objects from scene before loading
- fix a crash after removing the actors from scene

Modified: rl/trunk/engine/rules/src/CreatureController.cpp
===================================================================
--- rl/trunk/engine/rules/src/CreatureController.cpp	2007-12-05 19:45:10 UTC (rev 4017)
+++ rl/trunk/engine/rules/src/CreatureController.cpp	2007-12-05 19:48:29 UTC (rev 4018)
@@ -1779,6 +1779,14 @@
     bool CreatureController::refetchCreature()
     {
         mCreature = static_cast<Creature*>(GameObjectManager::getSingleton().getGameObject(mGameObjectId));
+
+        //mOldMaterialId = mCreature->getActor()->getPhysicalThing()->_getBody()->getMaterialGroupID();
+
+        const OgreNewt::MaterialID *material = PhysicsManager::getSingleton().getMaterialID("character");
+        mCreature->getActor()->getPhysicalThing()->setMaterialID(material);
+
+        mCreature->getActor()->getPhysicalThing()->setPhysicsController(this);
+
         return false;
     }
 }

Modified: rl/trunk/engine/rules/src/GameObjectManager.cpp
===================================================================
--- rl/trunk/engine/rules/src/GameObjectManager.cpp	2007-12-05 19:45:10 UTC (rev 4017)
+++ rl/trunk/engine/rules/src/GameObjectManager.cpp	2007-12-05 19:48:29 UTC (rev 4018)
@@ -176,7 +176,7 @@
         {
             GameObject* go = itr->second;
             mGameObjects.erase(itr++);
-            //go->setState(GOS_LOADED);  // this causes problems here, because of the relations between gofs
+            go->setState(GOS_LOADED);  // this causes problems here, because of the relations between gofs
             delete go;
         }
     }

Modified: rl/trunk/engine/ui/include/UiSubsystem.h
===================================================================
--- rl/trunk/engine/ui/include/UiSubsystem.h	2007-12-05 19:45:10 UTC (rev 4017)
+++ rl/trunk/engine/ui/include/UiSubsystem.h	2007-12-05 19:48:29 UTC (rev 4018)
@@ -61,13 +61,18 @@
         void setActiveCharacter(Person* person);
 
         virtual bool onBeforeClearScene();
+        virtual bool onBeforeGameObjectsLoaded();
+        virtual bool onGameObjectsLoaded();
 
         void initializeSubsystem();
 
     private:
         Person* mCharacter;
+        int mCharacterId;
 
 	    MessagePump::ScopedConnection mSceneClearingConnection;
+        MessagePump::ScopedConnection mGameObjectsLoadedConnection;
+        MessagePump::ScopedConnection mBeforeLoadingGameObjectsConnection;
 
         // Singletons
         InputManager* mInputManager;

Modified: rl/trunk/engine/ui/src/CharacterStateWindow.cpp
===================================================================
--- rl/trunk/engine/ui/src/CharacterStateWindow.cpp	2007-12-05 19:45:10 UTC (rev 4017)
+++ rl/trunk/engine/ui/src/CharacterStateWindow.cpp	2007-12-05 19:48:29 UTC (rev 4018)
@@ -53,7 +53,8 @@
 		mCharacter->removeObjectStateChangeListener(this);
 
 	mCharacter = person;
-	mCharacter->addObjectStateChangeListener(this);
+    if(mCharacter)
+        mCharacter->addObjectStateChangeListener(this);
 	update();
 }
 

Modified: rl/trunk/engine/ui/src/UiSubsystem.cpp
===================================================================
--- rl/trunk/engine/ui/src/UiSubsystem.cpp	2007-12-05 19:45:10 UTC (rev 4017)
+++ rl/trunk/engine/ui/src/UiSubsystem.cpp	2007-12-05 19:48:29 UTC (rev 4018)
@@ -39,6 +39,7 @@
 #include "SoundManager.h"
 #include "WindowFactory.h"
 #include "WindowManager.h"
+#include "GameObjectManager.h"
 
 using namespace Ogre;
 template<> rl::UiSubsystem* Singleton<rl::UiSubsystem>::ms_Singleton = 0;
@@ -58,6 +59,12 @@
         mSceneClearingConnection =
             MessagePump::getSingleton().addMessageHandler<MessageType_SceneClearing>(
 			    boost::bind(&UiSubsystem::onBeforeClearScene, this));
+        mGameObjectsLoadedConnection =
+            MessagePump::getSingleton().addMessageHandler<MessageType<RLMSG_SAVEGAME_GOS_LOADED>>(
+                boost::bind(&UiSubsystem::onGameObjectsLoaded, this));
+        mBeforeLoadingGameObjectsConnection = 
+            MessagePump::getSingleton().addMessageHandler<MessageType<RLMSG_SAVEGAME_LOADING>>(
+                boost::bind(&UiSubsystem::onBeforeGameObjectsLoaded, this));
         mWindowFactory = new WindowFactory();
     }
 
@@ -187,4 +194,43 @@
 
         return true;
     }
+
+    bool UiSubsystem::onGameObjectsLoaded()
+    {
+        if(mCharacterId != -1)
+        {
+            Person* person = static_cast<Person*>(GameObjectManager::getSingleton().getGameObject(mCharacterId));
+
+            ScriptWrapper::getSingleton().owned( person );
+            mCharacter = person;
+
+            mWindowFactory->setActiveCharacter(person);
+
+            mCharacter->getActor()->attach(SoundManager::getSingleton().getListenerActor());
+            LOG_MESSAGE(Logger::UI, "SoundListener attached.");
+
+            // Reset control stack for the new Character and set to movement.
+            //mInputManager->setControlState(CST_MOVEMENT);
+        }
+        return false;
+    }
+
+    bool UiSubsystem::onBeforeGameObjectsLoaded()
+    {
+        LOG_MESSAGE(Logger::UI, "UiSubsystem::onBeforeGameObjectsLoaded()");
+        if(mCharacter)
+        {
+            ScriptWrapper::getSingleton().disowned( mCharacter );
+            mCharacter->getActor()->detach(SoundManager::getSingleton().getListenerActor());
+
+            mWindowFactory->setActiveCharacter(NULL);
+
+            mCharacterId = mCharacter->getId();
+        }
+        else
+            mCharacterId = -1;
+
+        //mInputManager->clearControlStates();
+        return false;
+    }
 }



From timm at mail.berlios.de  Wed Dec  5 20:58:31 2007
From: timm at mail.berlios.de (timm at mail.berlios.de)
Date: Wed, 5 Dec 2007 20:58:31 +0100
Subject: [Dsa-hl-svn] r4019 - in rl/trunk/engine/ui: include src
Message-ID: <200712051958.lB5JwVfp015436@sheep.berlios.de>

Author: timm
Date: 2007-12-05 20:58:21 +0100 (Wed, 05 Dec 2007)
New Revision: 4019

Modified:
   rl/trunk/engine/ui/include/Makefile.am
   rl/trunk/engine/ui/src/Makefile.am
Log:
Fixed makefiles, too

Modified: rl/trunk/engine/ui/include/Makefile.am
===================================================================
--- rl/trunk/engine/ui/include/Makefile.am	2007-12-05 19:48:29 UTC (rev 4018)
+++ rl/trunk/engine/ui/include/Makefile.am	2007-12-05 19:58:21 UTC (rev 4019)
@@ -20,10 +20,10 @@
     FreeflightControlState.h \
     GameLoggerWindow.h \
     GameObjectInfoWindow.h \
-    GameSaveLoadWindow.h \
     GameSettings.h \
     InfoPopup.h \
     InGameMenuWindow.h \
+	InGameSaveLoadWindow.h \
     InputManager.h \
     InventoryWindow.h \
     ItemDragContainer.h \
@@ -34,6 +34,7 @@
     LogWindow.h \
     MainMenuWindow.h \
     MainMenuEngineWindow.h \
+	MainMenuLoadWindow.h \
     MessageWindow.h \
     MovementControlState.h \
     ObjectDescriptionWindow.h \

Modified: rl/trunk/engine/ui/src/Makefile.am
===================================================================
--- rl/trunk/engine/ui/src/Makefile.am	2007-12-05 19:48:29 UTC (rev 4018)
+++ rl/trunk/engine/ui/src/Makefile.am	2007-12-05 19:58:21 UTC (rev 4019)
@@ -28,10 +28,10 @@
     FreeflightControlState.cpp \
     GameLoggerWindow.cpp \
     GameObjectInfoWindow.cpp \
-    GameSaveLoadWindow.cpp \
     GameSettings.cpp \
     InfoPopup.cpp \
     InGameMenuWindow.cpp \
+	InGameSaveLoadWindow.cpp \
     InputManager.cpp \
     InventoryWindow.cpp \
     ItemDragContainer.cpp \
@@ -42,6 +42,7 @@
     LogWindow.cpp \
     MainMenuWindow.cpp \
     MainMenuEngineWindow.cpp \
+	MainMenuLoadWindow.cpp \
     MessageWindow.cpp \
     MovementControlState.cpp \
     ObjectDescriptionWindow.cpp \



From timm at mail.berlios.de  Wed Dec  5 22:16:47 2007
From: timm at mail.berlios.de (timm at mail.berlios.de)
Date: Wed, 5 Dec 2007 22:16:47 +0100
Subject: [Dsa-hl-svn] r4020 - in rl/trunk/engine/ui: include src
Message-ID: <200712052116.lB5LGlft020163@sheep.berlios.de>

Author: timm
Date: 2007-12-05 22:16:43 +0100 (Wed, 05 Dec 2007)
New Revision: 4020

Modified:
   rl/trunk/engine/ui/include/Makefile.am
   rl/trunk/engine/ui/src/Makefile.am
Log:
fixed makefiles

Modified: rl/trunk/engine/ui/include/Makefile.am
===================================================================
--- rl/trunk/engine/ui/include/Makefile.am	2007-12-05 19:58:21 UTC (rev 4019)
+++ rl/trunk/engine/ui/include/Makefile.am	2007-12-05 21:16:43 UTC (rev 4020)
@@ -20,10 +20,10 @@
     FreeflightControlState.h \
     GameLoggerWindow.h \
     GameObjectInfoWindow.h \
+	GameSaveLoadWindow.h \
     GameSettings.h \
     InfoPopup.h \
     InGameMenuWindow.h \
-	InGameSaveLoadWindow.h \
     InputManager.h \
     InventoryWindow.h \
     ItemDragContainer.h \

Modified: rl/trunk/engine/ui/src/Makefile.am
===================================================================
--- rl/trunk/engine/ui/src/Makefile.am	2007-12-05 19:58:21 UTC (rev 4019)
+++ rl/trunk/engine/ui/src/Makefile.am	2007-12-05 21:16:43 UTC (rev 4020)
@@ -28,10 +28,10 @@
     FreeflightControlState.cpp \
     GameLoggerWindow.cpp \
     GameObjectInfoWindow.cpp \
+	GameSaveLoadWindow.cpp \
     GameSettings.cpp \
     InfoPopup.cpp \
     InGameMenuWindow.cpp \
-	InGameSaveLoadWindow.cpp \
     InputManager.cpp \
     InventoryWindow.cpp \
     ItemDragContainer.cpp \



From blakharaz at mail.berlios.de  Fri Dec  7 23:02:57 2007
From: blakharaz at mail.berlios.de (blakharaz at mail.berlios.de)
Date: Fri, 7 Dec 2007 23:02:57 +0100
Subject: [Dsa-hl-svn] r4021 - rl/trunk/engine/ui/src
Message-ID: <200712072202.lB7M2vgU007069@sheep.berlios.de>

Author: blakharaz
Date: 2007-12-07 23:02:55 +0100 (Fri, 07 Dec 2007)
New Revision: 4021

Modified:
   rl/trunk/engine/ui/src/UiSubsystem.cpp
Log:
GCC doesn't like >> in templates


Modified: rl/trunk/engine/ui/src/UiSubsystem.cpp
===================================================================
--- rl/trunk/engine/ui/src/UiSubsystem.cpp	2007-12-05 21:16:43 UTC (rev 4020)
+++ rl/trunk/engine/ui/src/UiSubsystem.cpp	2007-12-07 22:02:55 UTC (rev 4021)
@@ -60,10 +60,10 @@
             MessagePump::getSingleton().addMessageHandler<MessageType_SceneClearing>(
 			    boost::bind(&UiSubsystem::onBeforeClearScene, this));
         mGameObjectsLoadedConnection =
-            MessagePump::getSingleton().addMessageHandler<MessageType<RLMSG_SAVEGAME_GOS_LOADED>>(
+            MessagePump::getSingleton().addMessageHandler<MessageType<RLMSG_SAVEGAME_GOS_LOADED> >(
                 boost::bind(&UiSubsystem::onGameObjectsLoaded, this));
         mBeforeLoadingGameObjectsConnection = 
-            MessagePump::getSingleton().addMessageHandler<MessageType<RLMSG_SAVEGAME_LOADING>>(
+            MessagePump::getSingleton().addMessageHandler<MessageType<RLMSG_SAVEGAME_LOADING> >(
                 boost::bind(&UiSubsystem::onBeforeGameObjectsLoaded, this));
         mWindowFactory = new WindowFactory();
     }



From pnyx at mail.berlios.de  Wed Dec 12 15:17:59 2007
From: pnyx at mail.berlios.de (pnyx at mail.berlios.de)
Date: Wed, 12 Dec 2007 15:17:59 +0100
Subject: [Dsa-hl-svn] r4022 - in modules: common/materials/programs
	common/materials/tiled common/models ruchin/maps
	ruchin/materials ruchin/materials/textures ruchin/models
	ruchin/scripts ruchin/scripts/maps techdemo2/materials/textures
Message-ID: <200712121417.lBCEHxaW019752@sheep.berlios.de>

Author: pnyx
Date: 2007-12-12 15:10:26 +0100 (Wed, 12 Dec 2007)
New Revision: 4022

Added:
   modules/common/materials/programs/Basic_Pixel_Shader_AO.source
   modules/common/materials/programs/Basic_Vertex_Shader_AO.material
   modules/common/models/men_human_female_hair_long01_normal.mesh
   modules/ruchin/materials/textures/ruchin_ao_ground.png
   modules/ruchin/materials/textures/ruchin_ao_n.png
   modules/ruchin/materials/textures/ruchin_ao_p.png
   modules/ruchin/materials/textures/ruchin_ao_s.png
   modules/ruchin/models/Ruchin_Graveyard_wall.mesh
Removed:
   modules/ruchin/materials/textures/Ruchin_ao_Ground.dds
   modules/ruchin/materials/textures/Ruchin_ao_l.dds
   modules/ruchin/materials/textures/Ruchin_ao_l_inside.dds
   modules/ruchin/materials/textures/Ruchin_ao_m.dds
   modules/ruchin/materials/textures/Ruchin_ao_p.dds
   modules/ruchin/materials/textures/Ruchin_ao_s.dds
   modules/ruchin/materials/textures/ruchin_ao_s_n.png
Modified:
   modules/common/materials/programs/TerrainVColorBlending.material
   modules/common/materials/programs/TerrainVColorBlending_Pixel_Shader.source
   modules/common/materials/programs/TerrainVColorBlending_Vertex_Shader.source
   modules/common/materials/tiled/erdboden01.dds
   modules/common/materials/tiled/laub01.dds
   modules/common/models/men_human_female.skeleton
   modules/common/models/men_human_female_armor_garethplatte.mesh
   modules/common/models/men_human_female_armor_kroetenhaut.mesh
   modules/common/models/men_human_female_backpack_leather_01.mesh
   modules/common/models/men_human_female_backpack_leather_01_smalll.mesh
   modules/common/models/men_human_female_cloth_long.mesh
   modules/common/models/men_human_female_cloth_short.mesh
   modules/common/models/men_human_female_cloth_short_02.mesh
   modules/common/models/men_human_female_feet_boots_01.mesh
   modules/common/models/men_human_female_feet_nude.mesh
   modules/common/models/men_human_female_hair_long_01_normal.mesh
   modules/common/models/men_human_female_hand_nude.mesh
   modules/common/models/men_human_female_head_02.mesh
   modules/common/models/men_human_female_leg_pants_01_long.mesh
   modules/common/models/men_human_female_legs_underpants.mesh
   modules/common/models/men_human_female_torso.mesh
   modules/common/models/men_human_male.skeleton
   modules/ruchin/maps/ruchin_lightzones.rlmap.xml
   modules/ruchin/materials/feuertest.material
   modules/ruchin/materials/feuertest.particle
   modules/ruchin/materials/textures/Statue_02_normals.png
   modules/ruchin/materials/textures/ruchin_atlasmap.png
   modules/ruchin/models/House_dummies.mesh
   modules/ruchin/models/Ruchin_Hesi_innen.mesh
   modules/ruchin/models/Ruchin_Hexe_innen.mesh
   modules/ruchin/models/Ruchin_g.mesh
   modules/ruchin/models/Ruchin_ground.material
   modules/ruchin/models/Ruchin_ground.mesh
   modules/ruchin/models/Ruchin_l.mesh
   modules/ruchin/models/Ruchin_l_innen.mesh
   modules/ruchin/models/Ruchin_map.mesh
   modules/ruchin/models/Ruchin_n.mesh
   modules/ruchin/models/Ruchin_p.mesh
   modules/ruchin/models/Ruchin_plateau.mesh
   modules/ruchin/models/Ruchin_s.mesh
   modules/ruchin/models/Ruchin_t.mesh
   modules/ruchin/models/Ruchintest.material
   modules/ruchin/models/arc_regal_02.mesh
   modules/ruchin/models/ruchin_terrain.material
   modules/ruchin/scripts/maps/maptest.rb
   modules/ruchin/scripts/particle.rb
   modules/techdemo2/materials/textures/nat_baum_shadix_03.dds
Log:
added some aoMaps to Ruchin and other stuff


Added: modules/common/materials/programs/Basic_Pixel_Shader_AO.source
===================================================================
--- modules/common/materials/programs/Basic_Pixel_Shader_AO.source	2007-12-07 22:02:55 UTC (rev 4021)
+++ modules/common/materials/programs/Basic_Pixel_Shader_AO.source	2007-12-12 14:10:26 UTC (rev 4022)
@@ -0,0 +1,21 @@
+sampler2D baseMap;
+sampler2D aoMap;
+
+struct PS_INPUT 
+{
+   float2 Texcoord : TEXCOORD0;
+   float2 Texcoord1: TEXCOORD1;
+   float2 Texcoord2: TEXCOORD2;
+   float4 Color    : TEXCOORD3;
+   
+};
+
+float4 ps_main( PS_INPUT Input ) : COLOR0
+{
+	float4 color =  tex2D( baseMap, Input.Texcoord );
+   return float4( color.rgb * Input.Color * saturate(tex2D(aoMap, Input.Texcoord1)+0.5)  	,color.a);
+   
+}
+
+
+

Added: modules/common/materials/programs/Basic_Vertex_Shader_AO.material
===================================================================
--- modules/common/materials/programs/Basic_Vertex_Shader_AO.material	2007-12-07 22:02:55 UTC (rev 4021)
+++ modules/common/materials/programs/Basic_Vertex_Shader_AO.material	2007-12-12 14:10:26 UTC (rev 4022)
@@ -0,0 +1,87 @@
+//Effect: Textured
+
+//DirectX 9.0 HLSL Pixel Shader ps_2_0
+fragment_program Basic_Pixel_Shader_AO hlsl
+{
+	source Basic_Pixel_Shader_AO.source
+	target ps_2_0
+	entry_point ps_main
+}
+
+
+material Basic_Vertex_Shader_AO
+{
+	technique hlsl
+	{
+		receive_shadows on
+		//Rendering Pass: Pass 0 (pass index: #0 )
+		pass
+		{
+			alpha_rejection greater 128
+			//DirectX 9.0 HLSL Pixel Shader ps_2_0
+			fragment_program_ref Basic_Pixel_Shader_AO
+			{
+			}
+			//DirectX 9.0 HLSL Vertex Shader vs_2_0
+			vertex_program_ref Basic_Vertex_Shader
+			{
+				// param_named_auto
+
+				param_named_auto Light1_attenuation light_attenuation 0
+				param_named_auto Light1_color light_diffuse_colour 0
+				param_named_auto Light1_position light_position_object_space 0
+				param_named Light1_spec_power float 0.3
+				
+				param_named_auto Light2_attenuation light_attenuation 1
+				param_named_auto Light2_color light_diffuse_colour 1
+				param_named_auto Light2_position light_position_object_space 1
+				param_named Light2_spec_power float 0.3
+				
+				param_named_auto Light3_attenuation light_attenuation 2
+				param_named_auto Light3_color light_diffuse_colour 2
+				param_named_auto Light3_position light_position_object_space 2
+				param_named Light3_spec_power float 0.3
+				
+				
+				param_named_auto matViewProjection worldviewproj_matrix
+				param_named_auto vViewPosition camera_position_object_space
+				
+				
+				param_named skycolor float4 0.5 0.5 0.5 1.0
+				param_named groundcolor float4 0.10 0.10 0.10 1.0
+			}
+			
+			// HLSL Vertex Shader
+			shadow_receiver_vertex_program_ref Basic_Vertex_Shader_SR
+			{
+				//Shader Constant: matWorldViewProjection
+				param_named_auto matWorldViewProjection worldviewproj_matrix
+				//Shader Constant: matWorld
+				param_named_auto matWorld world_matrix
+				//Shader Constant: matTextureViewProjection
+				param_named_auto matTextureViewProjection texture_viewproj_matrix
+			}
+
+			texture_unit
+			{
+				texture_alias diffuse
+
+			}
+			texture_unit
+			{
+				texture_alias ambient
+
+			}
+		}
+	}
+	technique
+	{
+        pass
+        {
+            texture_unit
+            {
+                texture_alias diffuse
+            }
+        }
+    }
+}

Modified: modules/common/materials/programs/TerrainVColorBlending.material
===================================================================
--- modules/common/materials/programs/TerrainVColorBlending.material	2007-12-07 22:02:55 UTC (rev 4021)
+++ modules/common/materials/programs/TerrainVColorBlending.material	2007-12-12 14:10:26 UTC (rev 4022)
@@ -54,17 +54,19 @@
 			vertex_program_ref TerrainVColorBlending_Vertex_Shader_glsl
 			{
 				param_named_auto matViewProjection worldviewproj_matrix
-				param_named Light_Ambient float4 0.000000 0.000000 0.000000 1.000000
 				
 				//Lights:
 				param_named_auto Light_Attenuation0 light_attenuation 0
 				param_named_auto Light_Attenuation1 light_attenuation 1
+				param_named_auto Light_Attenuation2 light_attenuation 2
 				
 				param_named_auto Light_Color0  light_diffuse_colour 0
 				param_named_auto Light_Color1  light_diffuse_colour 1
+				param_named_auto Light_Color2  light_diffuse_colour 2
 				
 				param_named_auto Light_Position0 light_position 0
 				param_named_auto Light_Position1 light_position 1
+				param_named_auto Light_Position2 light_position 2
 
 				param_named skycolor float4 0.2 0.2 0.2 1.0
 				param_named groundcolor float4 0.10 0.10 0.10 1.0
@@ -90,18 +92,10 @@
 			
 			
 			
-			shadow_receiver_vertex_program_ref Basic_Vertex_Shader_SR
-			{
-				//Shader Constant: matWorldViewProjection
-				param_named_auto matWorldViewProjection worldviewproj_matrix
-				//Shader Constant: matWorld
-				param_named_auto matWorld world_matrix
-				//Shader Constant: matTextureViewProjection
-				param_named_auto matTextureViewProjection texture_viewproj_matrix
-			}
 			
 			
 			
+			
 			//Texture Schwarz
 			texture_unit
 			{
@@ -159,17 +153,18 @@
 			vertex_program_ref TerrainVColorBlending_Vertex_Shader
 			{
 				param_named_auto matViewProjection worldviewproj_matrix
-				param_named Light_Ambient float4 0.000000 0.000000 0.000000 1.000000
-				
 				//Lights:
 				param_named_auto Light_Attenuation0 light_attenuation 0
 				param_named_auto Light_Attenuation1 light_attenuation 1
+				param_named_auto Light_Attenuation2 light_attenuation 2
 				
 				param_named_auto Light_Color0  light_diffuse_colour 0
 				param_named_auto Light_Color1  light_diffuse_colour 1
+				param_named_auto Light_Color2  light_diffuse_colour 2
 				
 				param_named_auto Light_Position0 light_position 0
 				param_named_auto Light_Position1 light_position 1
+				param_named_auto Light_Position2 light_position 2
 
 				param_named skycolor float4 0.2 0.2 0.2 1.0
 				param_named groundcolor float4 0.10 0.10 0.10 1.0
@@ -195,18 +190,10 @@
 			
 			
 			
-			shadow_receiver_vertex_program_ref Basic_Vertex_Shader_SR
-			{
-				//Shader Constant: matWorldViewProjection
-				param_named_auto matWorldViewProjection worldviewproj_matrix
-				//Shader Constant: matWorld
-				param_named_auto matWorld world_matrix
-				//Shader Constant: matTextureViewProjection
-				param_named_auto matTextureViewProjection texture_viewproj_matrix
-			}
 			
 			
 			
+			
 			//Texture Schwarz
 			texture_unit
 			{

Modified: modules/common/materials/programs/TerrainVColorBlending_Pixel_Shader.source
===================================================================
--- modules/common/materials/programs/TerrainVColorBlending_Pixel_Shader.source	2007-12-07 22:02:55 UTC (rev 4021)
+++ modules/common/materials/programs/TerrainVColorBlending_Pixel_Shader.source	2007-12-12 14:10:26 UTC (rev 4022)
@@ -13,12 +13,12 @@
                float4 UV2 : TEXCOORD2,
                float4 UV3 : TEXCOORD3,
                float4 UV4 : TEXCOORD4,
-               float4 Light:COLOR1) : COLOR0
+               float4 Light:TEXCOORD5) : COLOR0
 {   
    
 ///*   
 
-
+	float4 ambient = saturate(tex2D(Texture5,UV4.zw)+0.5);
    
    float4 TexColor = float4(tex2D(Texture0,UV0.xy).rgb,tex2D(Texture0,UV0.zw).a);
    TexColor = lerp(TexColor,float4(tex2D(Texture1,UV1.xy).rgb,tex2D(Texture1,UV1.zw).a),Color.r);
@@ -26,8 +26,9 @@
    TexColor = lerp(TexColor,float4(tex2D(Texture3,UV3.xy).rgb,tex2D(Texture3,UV3.zw).a),Color.b);
    TexColor = lerp(float4(tex2D(Texture4,UV4.xy).rgb,tex2D(Texture4,UV4.zw * scale_Detail4).a),TexColor,Color.a);
    
+   
 
-  return TexColor * (TexColor.a+ 0.5) * ((tex2D(Texture5,UV4.zw)-0.5) + Light);
+  return TexColor * (TexColor.a+ 0.5) * ( float4(Light.xyz,1)* ambient) ;
   //return float4(Color.aaaa);
 
 }

Modified: modules/common/materials/programs/TerrainVColorBlending_Vertex_Shader.source
===================================================================
--- modules/common/materials/programs/TerrainVColorBlending_Vertex_Shader.source	2007-12-07 22:02:55 UTC (rev 4021)
+++ modules/common/materials/programs/TerrainVColorBlending_Vertex_Shader.source	2007-12-12 14:10:26 UTC (rev 4022)
@@ -11,7 +11,6 @@
 uniform float scale_Detail2;
 uniform float scale_Detail3;
 
-uniform float4 Light_Ambient;
 uniform float4 Light_Color0;
 uniform float4 Light_Position0;
 uniform float4 Light_Attenuation0;
@@ -20,10 +19,14 @@
 uniform float4 Light_Position1;
 uniform float4 Light_Attenuation1;
 
-float4 skycolor;
-float4 groundcolor;
+uniform float4 Light_Color2;
+uniform float4 Light_Position2;
+uniform float4 Light_Attenuation2;
 
+uniform float4 skycolor;
+uniform float4 groundcolor;
 
+
 struct VS_OUTPUT 
 {
    float4 Position : POSITION0;
@@ -33,7 +36,7 @@
    float4 UV2 : TEXCOORD2;
    float4 UV3 : TEXCOORD3;
    float4 UV4 : TEXCOORD4;
-   float4 Light: COLOR1;
+   float4 Light:TEXCOORD5;
 };
 
 VS_OUTPUT vs_main( float4 Position : POSITION0,
@@ -42,7 +45,6 @@
                    float3 Normal: NORMAL)
 {
    VS_OUTPUT Output;
-   UV = Position.xz /4;
    
    Output.UV0 = float4(UV*scale_Texture0,UV*scale_Detail0);
    Output.UV1 = float4(UV*scale_Texture1,UV*scale_Detail1);
@@ -50,36 +52,51 @@
    Output.UV3 = float4(UV*scale_Texture3,UV*scale_Detail3);
    Output.UV4 = float4(UV*scale_Texture4,UV);
    
+   Output.Light = lerp(skycolor,groundcolor,(dot(Normal, float3(0,-1,0))+1)/2 );
    
    Output.Position = mul( matViewProjection, Position );
    
    Output.Color = Color;
    
    // ######## Light 0 #########
-   float3 LightDir0 = Light_Position0 - Position * Light_Position0.w;
-   float Dist0 = length(LightDir0);
-   LightDir0 /= Dist0;
+   float3 LightDir = Light_Position0 - Position * Light_Position0.w;
+   float Dist = length(LightDir);
+   LightDir /= Dist;
    
-   float DistAttn0 = saturate(1/(Light_Attenuation0.y +
-                                Light_Attenuation0.z * Dist0 +
-                                Light_Attenuation0.w * Dist0 * Dist0));
-   float AngleAttn0= saturate(dot(Normal,LightDir0));
+   float DistAttn = clamp(1/ (Light_Attenuation0.y +
+                              Light_Attenuation0.z * Dist +
+                              Light_Attenuation0.w * Dist * Dist)*saturate(Light_Attenuation0.x-Dist)
+                          ,0,1);
+   float AngleAttn= saturate(dot(Normal,LightDir));
+   Output.Light += Light_Color0 * DistAttn * AngleAttn;
    
-   
    // ######## Light 1 #########
-   float3 LightDir1 = Light_Position1 - Position * Light_Position1.w;
-   float Dist1 = length(LightDir1);
-   LightDir1 /= Dist1;
+   LightDir = Light_Position1 - Position * Light_Position1.w;
+   Dist = length(LightDir);
+   LightDir /= Dist;
    
-   float DistAttn1 = saturate(1/(Light_Attenuation1.y +
-                                Light_Attenuation1.z * Dist1 +
-                                Light_Attenuation1.w * Dist1 * Dist1));
-   float AngleAttn1= saturate(dot(Normal,LightDir1));
+   DistAttn = clamp(1/ (Light_Attenuation1.y +
+                              Light_Attenuation1.z * Dist +
+                              Light_Attenuation1.w * Dist * Dist)*saturate(Light_Attenuation1.x-Dist)
+                          ,0,1);
+   AngleAttn= saturate(dot(Normal,LightDir));
+   Output.Light += Light_Color1 * DistAttn * AngleAttn;
    
+   // ######## Light 2 #########
+   LightDir = Light_Position2 - Position * Light_Position2.w;
+   Dist = length(LightDir);
+   LightDir /= Dist;
    
-   // Light Output
-   Output.Light =lerp(skycolor,groundcolor,(dot(Normal, float3(0,-1,0))+1)/2 ) +(Light_Ambient-0.5 + ((Light_Color0 * DistAttn0 * AngleAttn0) + (Light_Color1 * DistAttn1 * AngleAttn1))*1.25);
+   DistAttn = clamp(1/ (Light_Attenuation2.y +
+                              Light_Attenuation2.z * Dist +
+                              Light_Attenuation2.w * Dist * Dist)*saturate(Light_Attenuation2.x-Dist)
+                          ,0,1);
+   AngleAttn= saturate(dot(Normal,LightDir));
+   Output.Light += Light_Color2 * DistAttn * AngleAttn;
    
+   // Light Output 
+   //Output.Light +=(Light_Color0 * DistAttn0 * AngleAttn0) + (Light_Color1 * DistAttn1 * AngleAttn1)+ (Light_Color2 * DistAttn2 * AngleAttn2);
+   
    return( Output );
    
 }

Modified: modules/common/materials/tiled/erdboden01.dds
===================================================================
(Binary files differ)

Modified: modules/common/materials/tiled/laub01.dds
===================================================================
(Binary files differ)

Modified: modules/common/models/men_human_female.skeleton
===================================================================
(Binary files differ)

Modified: modules/common/models/men_human_female_armor_garethplatte.mesh
===================================================================
(Binary files differ)

Modified: modules/common/models/men_human_female_armor_kroetenhaut.mesh
===================================================================
(Binary files differ)

Modified: modules/common/models/men_human_female_backpack_leather_01.mesh
===================================================================
(Binary files differ)

Modified: modules/common/models/men_human_female_backpack_leather_01_smalll.mesh
===================================================================
(Binary files differ)

Modified: modules/common/models/men_human_female_cloth_long.mesh
===================================================================
(Binary files differ)

Modified: modules/common/models/men_human_female_cloth_short.mesh
===================================================================
(Binary files differ)

Modified: modules/common/models/men_human_female_cloth_short_02.mesh
===================================================================
(Binary files differ)

Modified: modules/common/models/men_human_female_feet_boots_01.mesh
===================================================================
(Binary files differ)

Modified: modules/common/models/men_human_female_feet_nude.mesh
===================================================================
(Binary files differ)

Added: modules/common/models/men_human_female_hair_long01_normal.mesh
===================================================================
(Binary files differ)


Property changes on: modules/common/models/men_human_female_hair_long01_normal.mesh
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Modified: modules/common/models/men_human_female_hair_long_01_normal.mesh
===================================================================
(Binary files differ)

Modified: modules/common/models/men_human_female_hand_nude.mesh
===================================================================
(Binary files differ)

Modified: modules/common/models/men_human_female_head_02.mesh
===================================================================
(Binary files differ)

Modified: modules/common/models/men_human_female_leg_pants_01_long.mesh
===================================================================
(Binary files differ)

Modified: modules/common/models/men_human_female_legs_underpants.mesh
===================================================================
(Binary files differ)

Modified: modules/common/models/men_human_female_torso.mesh
===================================================================
(Binary files differ)

Modified: modules/common/models/men_human_male.skeleton
===================================================================
(Binary files differ)

Modified: modules/ruchin/maps/ruchin_lightzones.rlmap.xml
===================================================================
--- modules/ruchin/maps/ruchin_lightzones.rlmap.xml	2007-12-07 22:02:55 UTC (rev 4021)
+++ modules/ruchin/maps/ruchin_lightzones.rlmap.xml	2007-12-12 14:10:26 UTC (rev 4022)
@@ -1,6 +1,13 @@
 <?xml version="1.0" encoding="UTF-8" standalone="no" ?>
 <rastullahmap formatVersion="0.4.0">
 	<nodes>
+		<entity name="Ruchin_Graveyard_wall" meshfile="Ruchin_Graveyard_wall.mesh" visible="true" receivesShadow="true">
+			<position x="30.0" y="0.0" z="60.0" />
+			<rotation qx="0.0" qy="0.0" qz="0.0" qw="1.0" />
+			<scale x="1.0" y="1.0" z="1.0" />
+			<staticgeometrygroup id="0"/>
+			<renderingdistance data="100" /> 
+		</entity>	
 	
 		<entity name="Ruchin_plateau" meshfile="Ruchin_plateau.mesh" visible="true" receivesShadow="true">
 			<position x="100.0" y="0.0" z="-80.0" />
@@ -158,7 +165,7 @@
 			<renderingdistance data="100" />
 		</entity>
 		<entity name="Ruchin_ground" meshfile ="Ruchin_ground.mesh" visible="true" receivesShadow="true">
-			<position x="35.0" y="0.0" z="-20.0" />
+			<position x="0.0" y="0.0" z="0.0" />
 			<rotation qx="0.0" qy="0.0" qz="0.0" qw="0.0" />
 			<scale x="1.0" y="1.0" z="1.0" />
 			<staticgeometrygroup id="2"/>
@@ -337,18 +344,15 @@
 		</light>
 		
 		<light name="sun" type="directional" visible="true" castShadows="true">
-			<colourDiffuse r="0.8" g="0.8" b="0.8" />
-			<colourDiffuse r="0.8" g="0.8" b="0.8" />
+			<colourDiffuse r="0.9" g="0.8" b="0.8" />
 			<direction x="-0.17101" y="-0.873647" z="0.969846" />
 		</light>
 	</nodes>
 	<zones>
 		<zone name="default">
 			<light name="sun"/>
-			<light name="Ruchin_l_Light2"/>
-			<light name="Ruchin_l_Light1"/>
-			<light name="templeLight1"/>
-			<light name="templeLight2"/>
+			
+			<sound name="ruchin001.ogg"/>
 		</zone>
 		<zone name="temple_zone">
 			<area type="mesh" meshfile="temple_lightzone.mesh">

Modified: modules/ruchin/materials/feuertest.material
===================================================================
--- modules/ruchin/materials/feuertest.material	2007-12-07 22:02:55 UTC (rev 4021)
+++ modules/ruchin/materials/feuertest.material	2007-12-12 14:10:26 UTC (rev 4022)
@@ -1,4 +1,4 @@
-material feuertest
+material feuertest2
 {
 	technique
 	{

Modified: modules/ruchin/materials/feuertest.particle
===================================================================
--- modules/ruchin/materials/feuertest.particle	2007-12-07 22:02:55 UTC (rev 4021)
+++ modules/ruchin/materials/feuertest.particle	2007-12-12 14:10:26 UTC (rev 4022)
@@ -1,4 +1,4 @@
-feuertest
+feuertest2
 {
 	quota	70
 	material	feuertest

Deleted: modules/ruchin/materials/textures/Ruchin_ao_Ground.dds
===================================================================
(Binary files differ)

Deleted: modules/ruchin/materials/textures/Ruchin_ao_l.dds
===================================================================
(Binary files differ)

Deleted: modules/ruchin/materials/textures/Ruchin_ao_l_inside.dds
===================================================================
(Binary files differ)

Deleted: modules/ruchin/materials/textures/Ruchin_ao_m.dds
===================================================================
(Binary files differ)

Deleted: modules/ruchin/materials/textures/Ruchin_ao_p.dds
===================================================================
(Binary files differ)

Deleted: modules/ruchin/materials/textures/Ruchin_ao_s.dds
===================================================================
(Binary files differ)

Modified: modules/ruchin/materials/textures/Statue_02_normals.png
===================================================================
(Binary files differ)

Added: modules/ruchin/materials/textures/ruchin_ao_ground.png
===================================================================
(Binary files differ)


Property changes on: modules/ruchin/materials/textures/ruchin_ao_ground.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: modules/ruchin/materials/textures/ruchin_ao_n.png
===================================================================
(Binary files differ)


Property changes on: modules/ruchin/materials/textures/ruchin_ao_n.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: modules/ruchin/materials/textures/ruchin_ao_p.png
===================================================================
(Binary files differ)


Property changes on: modules/ruchin/materials/textures/ruchin_ao_p.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: modules/ruchin/materials/textures/ruchin_ao_s.png
===================================================================
(Binary files differ)


Property changes on: modules/ruchin/materials/textures/ruchin_ao_s.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Deleted: modules/ruchin/materials/textures/ruchin_ao_s_n.png
===================================================================
(Binary files differ)

Modified: modules/ruchin/materials/textures/ruchin_atlasmap.png
===================================================================
(Binary files differ)

Modified: modules/ruchin/models/House_dummies.mesh
===================================================================
(Binary files differ)

Added: modules/ruchin/models/Ruchin_Graveyard_wall.mesh
===================================================================
(Binary files differ)


Property changes on: modules/ruchin/models/Ruchin_Graveyard_wall.mesh
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Modified: modules/ruchin/models/Ruchin_Hesi_innen.mesh
===================================================================
(Binary files differ)

Modified: modules/ruchin/models/Ruchin_Hexe_innen.mesh
===================================================================
(Binary files differ)

Modified: modules/ruchin/models/Ruchin_g.mesh
===================================================================
(Binary files differ)

Modified: modules/ruchin/models/Ruchin_ground.material
===================================================================
--- modules/ruchin/models/Ruchin_ground.material	2007-12-07 22:02:55 UTC (rev 4021)
+++ modules/ruchin/models/Ruchin_ground.material	2007-12-12 14:10:26 UTC (rev 4022)
@@ -1,12 +1,12 @@
+
 material Ruchin_ground: TerrainVColorBlending
 {
-
    set_texture_alias black       erdboden01.dds
    set_texture_alias red         laub01.dds
    set_texture_alias green       nat_gras_01.dds
    set_texture_alias blue        nat_steingrund_01.dds
-   set_texture_alias alpha       nat_steingrund_01.dds
-   set_texture_alias Lightingmap Ligthingmap_default.png
+   set_texture_alias alpha       felsen2.dds
+   set_texture_alias Lightingmap Ruchin_ao_ground.png
    
    
    technique glsl
@@ -15,26 +15,26 @@
       {
          fragment_program_ref
          {
-            param_named scale_Detail4 float 0.050000 // Alpha
+            param_named scale_Detail4 float 30.050000 // Alpha
          }
 
          vertex_program_ref
          {
             param_named Light_Ambient float4 0.500000 0.500000 0.500000 1.000000
 
-            param_named scale_Texture0 float 0.58000 // Schwarz
-            param_named scale_Detail0 float 0.020000
+            param_named scale_Texture0 float 30.58000 // Schwarz
+            param_named scale_Detail0 float 30.020000
 
-            param_named scale_Texture1 float 0.5700 // Rot
-            param_named scale_Detail1 float 1.00000
+            param_named scale_Texture1 float 30.7500 // Rot
+            param_named scale_Detail1 float 30.00000
 
-            param_named scale_Texture2 float 0.28500 // Gruen
-            param_named scale_Detail2 float 0.60000
+            param_named scale_Texture2 float 30.28500 // Gruen
+            param_named scale_Detail2 float 30.60000
 
-            param_named scale_Texture3 float 0.88000 // Blau
-            param_named scale_Detail3 float 1.00000
+            param_named scale_Texture3 float 30.88000 // Blau
+            param_named scale_Detail3 float 30.00000
 
-            param_named scale_Texture4 float 0.016000 // Alpha
+            param_named scale_Texture4 float 30.016000 // Alpha
          }
       }
    }
@@ -45,26 +45,26 @@
       {
          fragment_program_ref
          {
-            param_named scale_Detail4 float 0.050000 // Alpha
+            param_named scale_Detail4 float 30.050000 // Alpha
          }
 
          vertex_program_ref
          {
             param_named Light_Ambient float4 0.500000 0.500000 0.500000 1.000000
 
-            param_named scale_Texture0 float 0.58000 // Schwarz
-            param_named scale_Detail0 float 0.020000
+            param_named scale_Texture0 float 30.58000 // Schwarz
+            param_named scale_Detail0 float 30.020000
 
-            param_named scale_Texture1 float 0.5700 // Rot
-            param_named scale_Detail1 float 1.00000
+            param_named scale_Texture1 float 30.7500 // Rot
+            param_named scale_Detail1 float 30.00000
 
-            param_named scale_Texture2 float 0.28500 // Gruen
-            param_named scale_Detail2 float 0.60000
+            param_named scale_Texture2 float 30.28500 // Gruen
+            param_named scale_Detail2 float 30.60000
 
-            param_named scale_Texture3 float 0.88000 // Blau
-            param_named scale_Detail3 float 1.00000
+            param_named scale_Texture3 float 30.88000 // Blau
+            param_named scale_Detail3 float 30.00000
 
-            param_named scale_Texture4 float 0.016000 // Alpha
+            param_named scale_Texture4 float 30.016000 // Alpha
          }
       }
    }

Modified: modules/ruchin/models/Ruchin_ground.mesh
===================================================================
(Binary files differ)

Modified: modules/ruchin/models/Ruchin_l.mesh
===================================================================
(Binary files differ)

Modified: modules/ruchin/models/Ruchin_l_innen.mesh
===================================================================
(Binary files differ)

Modified: modules/ruchin/models/Ruchin_map.mesh
===================================================================
(Binary files differ)

Modified: modules/ruchin/models/Ruchin_n.mesh
===================================================================
(Binary files differ)

Modified: modules/ruchin/models/Ruchin_p.mesh
===================================================================
(Binary files differ)

Modified: modules/ruchin/models/Ruchin_plateau.mesh
===================================================================
(Binary files differ)

Modified: modules/ruchin/models/Ruchin_s.mesh
===================================================================
(Binary files differ)

Modified: modules/ruchin/models/Ruchin_t.mesh
===================================================================
(Binary files differ)

Modified: modules/ruchin/models/Ruchintest.material
===================================================================
--- modules/ruchin/models/Ruchintest.material	2007-12-07 22:02:55 UTC (rev 4021)
+++ modules/ruchin/models/Ruchintest.material	2007-12-12 14:10:26 UTC (rev 4022)
@@ -109,32 +109,43 @@
 } 
 
 
-material Ruchin_s : Basic_Vertex_Shader
+
+material Ruchin/base : Basic_Vertex_Shader
 {
 set_texture_alias diffuse ruchin_atlasmap.png
 
 }
 
-material Ruchin_p : Basic_Vertex_Shader
+material Ruchin/Schiefer : Basic_Vertex_Shader
 {
-set_texture_alias diffuse ruchin_atlasmap.png
+set_texture_alias diffuse arc_schieferdach.png
 
 }
 
-material Ruchin/base : Basic_Vertex_Shader
+material Ruchin/glas : Basic_Vertex_Shader_Alpha
 {
+set_texture_alias diffuse ruchin_atlasmap.dds
+
+}
+// ruchin_ao_n.png
+
+material Ruchin_n : Basic_Vertex_Shader_AO
+{
 set_texture_alias diffuse ruchin_atlasmap.png
+set_texture_alias ambient ruchin_ao_n.png
 
 }
 
-material Ruchin/Schiefer : Basic_Vertex_Shader
+material Ruchin_p : Basic_Vertex_Shader_AO
 {
-set_texture_alias diffuse arc_schieferdach.png
+set_texture_alias diffuse ruchin_atlasmap.png
+set_texture_alias ambient ruchin_ao_p.png
 
 }
 
-material Ruchin/glas : Basic_Vertex_Shader_Alpha
+material Ruchin_s : Basic_Vertex_Shader_AO
 {
-set_texture_alias diffuse ruchin_atlasmap.dds
+set_texture_alias diffuse ruchin_atlasmap.png
+set_texture_alias ambient ruchin_ao_s.png
 
 }

Modified: modules/ruchin/models/arc_regal_02.mesh
===================================================================
(Binary files differ)

Modified: modules/ruchin/models/ruchin_terrain.material
===================================================================
--- modules/ruchin/models/ruchin_terrain.material	2007-12-07 22:02:55 UTC (rev 4021)
+++ modules/ruchin/models/ruchin_terrain.material	2007-12-12 14:10:26 UTC (rev 4022)
@@ -15,26 +15,26 @@
       {
          fragment_program_ref
          {
-            param_named scale_Detail4 float 0.050000 // Alpha
+            param_named scale_Detail4 float 20.050000 // Alpha
          }
 
          vertex_program_ref
          {
             param_named Light_Ambient float4 0.500000 0.500000 0.500000 1.000000
 
-            param_named scale_Texture0 float 0.018000 // Schwarz
-            param_named scale_Detail0 float 0.020000
+            param_named scale_Texture0 float 20.018000 // Schwarz
+            param_named scale_Detail0 float 20.020000
 
-            param_named scale_Texture1 float 0.005700 // Rot
-            param_named scale_Detail1 float 0.100000
+            param_named scale_Texture1 float 20.005700 // Rot
+            param_named scale_Detail1 float 20.100000
 
-            param_named scale_Texture2 float 0.028500 // Gruen
-            param_named scale_Detail2 float 0.060000
+            param_named scale_Texture2 float 20.028500 // Gruen
+            param_named scale_Detail2 float 20.060000
 
-            param_named scale_Texture3 float 0.008000 // Blau
-            param_named scale_Detail3 float 0.050000
+            param_named scale_Texture3 float 20.008000 // Blau
+            param_named scale_Detail3 float 20.050000
 
-            param_named scale_Texture4 float 0.016000 // Alpha
+            param_named scale_Texture4 float 20.016000 // Alpha
          }
       }
    }
@@ -45,26 +45,26 @@
       {
          fragment_program_ref
          {
-            param_named scale_Detail4 float 0.050000 // Alpha
+            param_named scale_Detail4 float 20.050000 // Alpha
          }
 
          vertex_program_ref
          {
             param_named Light_Ambient float4 0.500000 0.500000 0.500000 1.000000
 
-            param_named scale_Texture0 float 0.018000 // Schwarz
-            param_named scale_Detail0 float 0.020000
+            param_named scale_Texture0 float 20.018000 // Schwarz
+            param_named scale_Detail0 float 20.020000
 
-            param_named scale_Texture1 float 0.005700 // Rot
-            param_named scale_Detail1 float 0.100000
+            param_named scale_Texture1 float 20.005700 // Rot
+            param_named scale_Detail1 float 20.100000
 
-            param_named scale_Texture2 float 0.028500 // Gruen
-            param_named scale_Detail2 float 0.060000
+            param_named scale_Texture2 float 20.028500 // Gruen
+            param_named scale_Detail2 float 20.060000
 
-            param_named scale_Texture3 float 0.008000 // Blau
-            param_named scale_Detail3 float 0.050000
+            param_named scale_Texture3 float 20.008000 // Blau
+            param_named scale_Detail3 float 20.050000
 
-            param_named scale_Texture4 float 0.016000 // Alpha
+            param_named scale_Texture4 float 20.016000 // Alpha
          }
       }
    }

Modified: modules/ruchin/scripts/maps/maptest.rb
===================================================================
--- modules/ruchin/scripts/maps/maptest.rb	2007-12-07 22:02:55 UTC (rev 4021)
+++ modules/ruchin/scripts/maps/maptest.rb	2007-12-12 14:10:26 UTC (rev 4022)
@@ -4,6 +4,7 @@
 require 'hero.rb'
 require 'mckhero.rb'
 require 'door.rb'
+require 'torch.rb'
 
 # Physik aktivieren
 $PM.setEnabled(true);
@@ -78,6 +79,13 @@
 loader = MapLoader.new("ruchin");
 loader.loadMap("ruchin_lightzones.rlmap.xml");
 
+$SCRIPT.log("Fackellicht erstellen..");
+fackellicht = $AM.createLightActor("Das Licht der Fackel", LightObject::LT_POINT );
+fackellicht.getControlledObject().setCastShadows(false);
+fackellicht.getControlledObject().setDiffuseColour(0.8,0.7,0.6);
+fackellicht.getControlledObject().setAttenuation(5.0, 0.79,  -0.21, 0.268 );
+$hero.getActor().attachToSlot( fackellicht, "Bip01 R SlotHand" );
+$SCRIPT.log("Fackellicht erstellt.");
 ##########################
 
 load "particle.rb"

Modified: modules/ruchin/scripts/particle.rb
===================================================================
--- modules/ruchin/scripts/particle.rb	2007-12-07 22:02:55 UTC (rev 4021)
+++ modules/ruchin/scripts/particle.rb	2007-12-12 14:10:26 UTC (rev 4022)
@@ -1,12 +1,12 @@
 
 
-tavernfire1 = $AM.createParticleSystemActor("tavernfire1", "feuertest" );
+tavernfire1 = $AM.createParticleSystemActor("tavernfire1", "feuertest2" );
 tavernfire1.placeIntoScene( 36.74,-3.90,35.93, 1.0, 0.0, 0.0, 0.0 );
 
-templefire1 = $AM.createParticleSystemActor("templefire1", "feuertest" );
+templefire1 = $AM.createParticleSystemActor("templefire1", "feuertest2" );
 templefire1.placeIntoScene( 123.28,3.0,-22.19, 1.0, 0.0, 0.0, 0.0 );
 
-templefire2 = $AM.createParticleSystemActor("templefire2", "feuertest" );
+templefire2 = $AM.createParticleSystemActor("templefire2", "feuertest2" );
 templefire2.placeIntoScene( 123.28,3.0,-18.93, 1.0, 0.0, 0.0, 0.0 );
 
 #nebel = $AM.createParticleSystemActor("nebel", "nebel" );

Modified: modules/techdemo2/materials/textures/nat_baum_shadix_03.dds
===================================================================
(Binary files differ)



From pnyx at mail.berlios.de  Thu Dec 13 20:35:03 2007
From: pnyx at mail.berlios.de (pnyx at mail.berlios.de)
Date: Thu, 13 Dec 2007 20:35:03 +0100
Subject: [Dsa-hl-svn] r4023 - in modules: common/materials/programs
	ruchin/maps ruchin/materials/textures ruchin/models
	ruchin/scripts/maps
Message-ID: <200712131935.lBDJZ38X024189@sheep.berlios.de>

Author: pnyx
Date: 2007-12-13 20:31:58 +0100 (Thu, 13 Dec 2007)
New Revision: 4023

Added:
   modules/ruchin/materials/textures/ruchin_ao_m.png
   modules/ruchin/models/Ruchin_m_innen.mesh
   modules/ruchin/models/Ruchin_m_lightzone_Keller.mesh
   modules/ruchin/models/Ruchin_m_lightzone_Wirtshaus.mesh
Modified:
   modules/common/materials/programs/Basic_Pixel_Shader_AO.source
   modules/common/materials/programs/Basic_Vertex_Shader.program
   modules/common/materials/programs/Basic_Vertex_Shader_AO.material
   modules/common/materials/programs/TerrainVColorBlending.material
   modules/common/materials/programs/TerrainVColorBlending_Pixel_Shader.source
   modules/ruchin/maps/ruchin_lightzones.rlmap.xml
   modules/ruchin/models/Ruchin_m.mesh
   modules/ruchin/models/Ruchin_p.mesh
   modules/ruchin/models/Ruchintest.material
   modules/ruchin/scripts/maps/maptest.rb
Log:
created Lightzone for the Inn

Modified: modules/common/materials/programs/Basic_Pixel_Shader_AO.source
===================================================================
--- modules/common/materials/programs/Basic_Pixel_Shader_AO.source	2007-12-12 14:10:26 UTC (rev 4022)
+++ modules/common/materials/programs/Basic_Pixel_Shader_AO.source	2007-12-13 19:31:58 UTC (rev 4023)
@@ -13,7 +13,7 @@
 float4 ps_main( PS_INPUT Input ) : COLOR0
 {
 	float4 color =  tex2D( baseMap, Input.Texcoord );
-   return float4( color.rgb * Input.Color * saturate(tex2D(aoMap, Input.Texcoord1)+0.5)  	,color.a);
+   return float4( color.rgb * Input.Color * saturate(tex2D(aoMap, Input.Texcoord1)/2 +0.5)  	,color.a);
    
 }
 

Modified: modules/common/materials/programs/Basic_Vertex_Shader.program
===================================================================
--- modules/common/materials/programs/Basic_Vertex_Shader.program	2007-12-12 14:10:26 UTC (rev 4022)
+++ modules/common/materials/programs/Basic_Vertex_Shader.program	2007-12-13 19:31:58 UTC (rev 4023)
@@ -217,8 +217,8 @@
 				param_named_auto vViewPosition camera_position_object_space
 				
 				
-				param_named skycolor float4 0.2 0.2 0.2 1.0
-				param_named groundcolor float4 0.10 0.10 0.10 1.0
+				param_named skycolor float4 0.0 0.0 0.0 1.0
+				param_named groundcolor float4 0.00 0.00 0.00 1.0
 			}
 			
 			texture_unit
@@ -265,8 +265,8 @@
 				//param_named_auto vViewPosition camera_position_object_space
 				
 				
-				param_named skycolor float4 0.2 0.2 0.2 1.0
-				param_named groundcolor float4 0.10 0.10 0.10 1.0
+				param_named skycolor float4 0.0 0.0 0.0 1.0
+				param_named groundcolor float4 0.00 0.00 0.00 1.0
 			}
 			
 			texture_unit

Modified: modules/common/materials/programs/Basic_Vertex_Shader_AO.material
===================================================================
--- modules/common/materials/programs/Basic_Vertex_Shader_AO.material	2007-12-12 14:10:26 UTC (rev 4022)
+++ modules/common/materials/programs/Basic_Vertex_Shader_AO.material	2007-12-13 19:31:58 UTC (rev 4023)
@@ -11,9 +11,10 @@
 
 material Basic_Vertex_Shader_AO
 {
+receive_shadows off
 	technique hlsl
 	{
-		receive_shadows on
+		
 		//Rendering Pass: Pass 0 (pass index: #0 )
 		pass
 		{

Modified: modules/common/materials/programs/TerrainVColorBlending.material
===================================================================
--- modules/common/materials/programs/TerrainVColorBlending.material	2007-12-12 14:10:26 UTC (rev 4022)
+++ modules/common/materials/programs/TerrainVColorBlending.material	2007-12-13 19:31:58 UTC (rev 4023)
@@ -29,6 +29,7 @@
 
 material TerrainVColorBlending
 {
+receive_shadows on
 	technique glsl
 	{
 

Modified: modules/common/materials/programs/TerrainVColorBlending_Pixel_Shader.source
===================================================================
--- modules/common/materials/programs/TerrainVColorBlending_Pixel_Shader.source	2007-12-12 14:10:26 UTC (rev 4022)
+++ modules/common/materials/programs/TerrainVColorBlending_Pixel_Shader.source	2007-12-13 19:31:58 UTC (rev 4023)
@@ -18,7 +18,7 @@
    
 ///*   
 
-	float4 ambient = saturate(tex2D(Texture5,UV4.zw)+0.5);
+	float4 ambient = saturate(tex2D(Texture5,UV4.zw)/2 +0.5);
    
    float4 TexColor = float4(tex2D(Texture0,UV0.xy).rgb,tex2D(Texture0,UV0.zw).a);
    TexColor = lerp(TexColor,float4(tex2D(Texture1,UV1.xy).rgb,tex2D(Texture1,UV1.zw).a),Color.r);

Modified: modules/ruchin/maps/ruchin_lightzones.rlmap.xml
===================================================================
--- modules/ruchin/maps/ruchin_lightzones.rlmap.xml	2007-12-12 14:10:26 UTC (rev 4022)
+++ modules/ruchin/maps/ruchin_lightzones.rlmap.xml	2007-12-13 19:31:58 UTC (rev 4023)
@@ -1,7 +1,7 @@
 <?xml version="1.0" encoding="UTF-8" standalone="no" ?>
 <rastullahmap formatVersion="0.4.0">
 	<nodes>
-		<entity name="Ruchin_Graveyard_wall" meshfile="Ruchin_Graveyard_wall.mesh" visible="true" receivesShadow="true">
+		<entity name="Ruchin_Graveyard_wall" meshfile="Ruchin_Graveyard_wall.mesh" visible="true" receivesShadow="false">
 			<position x="30.0" y="0.0" z="60.0" />
 			<rotation qx="0.0" qy="0.0" qz="0.0" qw="1.0" />
 			<scale x="1.0" y="1.0" z="1.0" />
@@ -9,7 +9,7 @@
 			<renderingdistance data="100" /> 
 		</entity>	
 	
-		<entity name="Ruchin_plateau" meshfile="Ruchin_plateau.mesh" visible="true" receivesShadow="true">
+		<entity name="Ruchin_plateau" meshfile="Ruchin_plateau.mesh" visible="true" receivesShadow="false">
 			<position x="100.0" y="0.0" z="-80.0" />
 			<rotation qx="0.0" qy="0.0" qz="0.0" qw="1.0" />
 			<scale x="1.0" y="1.0" z="1.0" />
@@ -17,7 +17,7 @@
 			<renderingdistance data="100" /> 
 		</entity>
 		
-		<entity name="Ruchin_Hesi_innen" meshfile="Ruchin_Hesi_innen.mesh" visible="true" receivesShadow="true">
+		<entity name="Ruchin_Hesi_innen" meshfile="Ruchin_Hesi_innen.mesh" visible="true" receivesShadow="false">
 			<position x="130.0" y="0.0" z="-50.0" />
 			<rotation qx="0.0" qy="0.0" qz="0.0" qw="1.0" />
 			<scale x="1.0" y="1.0" z="1.0" />
@@ -25,14 +25,14 @@
 			<renderingdistance data="100" /> 
 		</entity>
 		
-		<entity name="Ruchin_Hexe_innen" meshfile="Ruchin_Hexe_innen.mesh" visible="true" receivesShadow="true">
+		<entity name="Ruchin_Hexe_innen" meshfile="Ruchin_Hexe_innen.mesh" visible="true" receivesShadow="false">
 			<position x="30.0" y="0.0" z="30.0" />
 			<rotation qx="0.0" qy="0.0" qz="0.0" qw="1.0" />
 			<scale x="1.0" y="1.0" z="1.0" />
 			<staticgeometrygroup id="0"/>
 			<renderingdistance data="100" /> 
 		</entity>
-		<entity name="Ruchin_t" meshfile="Ruchin_t.mesh" visible="true" receivesShadow="true">
+		<entity name="Ruchin_t" meshfile="Ruchin_t.mesh" visible="true" receivesShadow="false">
 			<position x="30.0" y="0.0" z="30.0" />
 			<rotation qx="0.0" qy="0.0" qz="0.0" qw="1.0" />
 			<scale x="1.0" y="1.0" z="1.0" />
@@ -40,7 +40,7 @@
 			<renderingdistance data="100" /> 
 		</entity>
 		
-		<entity name="Ruchin_g" meshfile="Ruchin_g.mesh" visible="true" receivesShadow="true">
+		<entity name="Ruchin_g" meshfile="Ruchin_g.mesh" visible="true" receivesShadow="false">
 			<position x="120.0" y="0.0" z="-50.0" />
 			<rotation qx="0.0" qy="0.0" qz="0.0" qw="1.0" />
 			<scale x="1.0" y="1.0" z="1.0" />
@@ -48,7 +48,7 @@
 			<renderingdistance data="100" /> 
 		</entity>
 	
-		<entity name="Ruchin_l_innen" meshfile="Ruchin_l_innen.mesh" visible="true" receivesShadow="true">
+		<entity name="Ruchin_l_innen" meshfile="Ruchin_l_innen.mesh" visible="true" receivesShadow="false">
 			<position x="65.2876" y="6.02141" z="-66.9458" />
 			<rotation qx="0.0" qy="0.0" qz="0.0" qw="1.0" />
 			<scale x="1.0" y="1.0" z="1.0" />
@@ -62,7 +62,7 @@
 			<staticgeometrygroup id="1"/>
 			<renderingdistance data="100" />
 		</entity>
-		<entity name="Ruchin_Stadtwache" meshfile ="Ruchin_Stadtwache.mesh" visible="true" receivesShadow="true">
+		<entity name="Ruchin_Stadtwache" meshfile ="Ruchin_Stadtwache.mesh" visible="true" receivesShadow="false">
 			<position x="105.0" y="0.0" z="45.0" />
 			<rotation qx="0.0" qy="0.0" qz="0.0" qw="1.0" />
 			<scale x="1.0" y="1.0" z="1.0" />
@@ -70,77 +70,84 @@
 			<renderingdistance data="100" />
 		</entity>
 		
-		<entity name="Ruchin_s" meshfile ="Ruchin_s.mesh" visible="true" receivesShadow="true">
+		<entity name="Ruchin_s" meshfile ="Ruchin_s.mesh" visible="true" receivesShadow="false" castsShadows="true">
 			<position x="-6.85993" y="0.405498" z="11.2053" />
 			<rotation qx="0.0" qy="0.0" qz="0.0" qw="1.0" />
 			<scale x="1.0" y="1.0" z="1.0" />
 			<staticgeometrygroup id="0"/>
 			<renderingdistance data="100" />
 		</entity>	
-		<entity name="Ruchin_n" meshfile ="Ruchin_n.mesh" visible="true" receivesShadow="true">
+		<entity name="Ruchin_n" meshfile ="Ruchin_n.mesh" visible="true" receivesShadow="false">
 			<position x="9.28835" y="4.25027" z="-52.6695" />
 			<rotation qx="0.0" qy="0.0" qz="0.0" qw="1.0" />
 			<scale x="1.0" y="1.0" z="1.0" />
 			<staticgeometrygroup id="0"/>
 			<renderingdistance data="100" />
 		</entity>
-		<entity name="Ruchin_p" meshfile ="Ruchin_p.mesh" visible="true" receivesShadow="true">
+		<entity name="Ruchin_p" meshfile ="Ruchin_p.mesh" visible="true" receivesShadow="false">
 			<position x="29.574" y="2.872" z="-7.966" />
 			<rotation qx="0.0" qy="0.0" qz="0.0" qw="1.0" />
 			<scale x="1.0" y="1.0" z="1.0" />
 			<staticgeometrygroup id="0"/>
 			<renderingdistance data="100" />
 		</entity>
-		<entity name="Ruchin_m" meshfile ="Ruchin_m.mesh" visible="true" receivesShadow="true">
+		<entity name="Ruchin_m" meshfile ="Ruchin_m.mesh" visible="true" receivesShadow="false">
 			<position x="36.6777" y="2.04379" z="-51.148" />
 			<rotation qx="0.0" qy="0.0" qz="0.0" qw="1.0" />
 			<scale x="1.0" y="1.0" z="1.0" />
 			<staticgeometrygroup id="0"/>
 			<renderingdistance data="100" />
+			
+		</entity><entity name="Ruchin_m_innen" meshfile ="Ruchin_m_innen.mesh" visible="true" receivesShadow="false">
+			<position x="45.0" y="0.0" z="-30.00" />
+			<rotation qx="0.0" qy="0.0" qz="0.0" qw="1.0" />
+			<scale x="1.0" y="1.0" z="1.0" />
+			<staticgeometrygroup id="0"/>
+			<renderingdistance data="100" />
 		</entity>
-		<entity name="Ruchin_l" meshfile ="Ruchin_l.mesh" visible="true" receivesShadow="true">
+		<entity name="Ruchin_l" meshfile ="Ruchin_l.mesh" visible="true" receivesShadow="false">
 			<position x="65.2876" y="6.02141" z="-66.9458" />
 			<rotation qx="0.0" qy="0.0" qz="0.0" qw="1.0" />
 			<scale x="1.0" y="1.0" z="1.0" />
 			<staticgeometrygroup id="0"/>
 			<renderingdistance data="100" />
 		</entity>
-		<entity name="Ruchin_r" meshfile ="Ruchin_r.mesh" visible="true" receivesShadow="true">
+		<entity name="Ruchin_r" meshfile ="Ruchin_r.mesh" visible="true" receivesShadow="false">
 			<position x="70.0" y="0.0" z="30.0" />
 			<rotation qx="0.0" qy="0.0" qz="0.0" qw="1.0" />
 			<scale x="1.0" y="1.0" z="1.0" />
 			<staticgeometrygroup id="0"/>
 			<renderingdistance data="100" />
 		</entity>
-		<entity name="Ruchin_v" meshfile ="Ruchin_v.mesh" visible="true" receivesShadow="true">
+		<entity name="Ruchin_v" meshfile ="Ruchin_v.mesh" visible="true" receivesShadow="false">
 			<position x="88.3245" y="1.09103" z="78.1543" />
 			<rotation qx="0.0" qy="0.0" qz="0.0" qw="1.0" />
 			<scale x="1.0" y="1.0" z="1.0" />
 			<staticgeometrygroup id="0"/>
 			<renderingdistance data="100" />
 		</entity>
-		<entity name="Ruchin_i" meshfile ="Ruchin_i.mesh" visible="true" receivesShadow="true">
+		<entity name="Ruchin_i" meshfile ="Ruchin_i.mesh" visible="true" receivesShadow="false">
 			<position x="-5.0" y="0.0" z="-100.0" />
 			<rotation qx="0.0" qy="0.0" qz="0.0" qw="1.0" />
 			<scale x="1.0" y="1.0" z="1.0" />
 			<staticgeometrygroup id="0"/>
 			<renderingdistance data="100" />
 		</entity>
-		<entity name="Ruchin_j" meshfile ="Ruchin_j.mesh" visible="true" receivesShadow="true">
+		<entity name="Ruchin_j" meshfile ="Ruchin_j.mesh" visible="true" receivesShadow="false">
 			<position x="40.0" y="0.0" z="-100.0" />
 			<rotation qx="0.0" qy="0.0" qz="0.0" qw="1.0" />
 			<scale x="1.0" y="1.0" z="1.0" />
 			<staticgeometrygroup id="0"/>
 			<renderingdistance data="100" />
 		</entity>
-		<entity name="Ruchin_u" meshfile ="Ruchin_u.mesh" visible="true" receivesShadow="true">
+		<entity name="Ruchin_u" meshfile ="Ruchin_u.mesh" visible="true" receivesShadow="false">
 			<position x="100.0" y="0.0" z="50.0" />
 			<rotation qx="0.0" qy="0.0" qz="0.0" qw="1.0" />
 			<scale x="1.0" y="1.0" z="1.0" />
 			<staticgeometrygroup id="0"/>
 			<renderingdistance data="100" />
 		</entity>
-		<entity name="House_dummies" meshfile ="House_dummies.mesh" visible="true" receivesShadow="true">
+		<entity name="House_dummies" meshfile ="House_dummies.mesh" visible="true" receivesShadow="false">
 			<position x="0.0" y="0.0" z="0.0" />
 			<rotation qx="0.0" qy="0.0" qz="0.0" qw="0.0" />
 			<scale x="1.0" y="1.0" z="1.0" />
@@ -150,7 +157,7 @@
 		
 		
 		
-		<entity name="Ruchin_map" meshfile ="Ruchin_map.mesh" visible="true" receivesShadow="true">
+		<entity name="Ruchin_map" meshfile ="Ruchin_map.mesh" visible="true" receivesShadow="false">
 			<position x="68.5845" y="-0.00679748" z="-47.3902" />
 			<rotation qx="0.0" qy="0.0" qz="0.0" qw="1.0" />
 			<scale x="1.0" y="1.0" z="1.0" />
@@ -173,28 +180,28 @@
 		</entity>
 		
 		
-		<entity name="temple_outside" meshfile ="temple_outside.mesh" visible="true" receivesShadow="true">
+		<entity name="temple_outside" meshfile ="temple_outside.mesh" visible="true" receivesShadow="false">
 			<position x="122.11" y="0.076957" z="-20.5749" />
 			<rotation qx="0.0" qy="0.0" qz="0.0" qw="1.0" />
 			<scale x="1.0" y="1.0" z="1.0" />
 			<staticgeometrygroup id="3"/>
 			<renderingdistance data="100" />
 		</entity>
-		<entity name="temple_innen" meshfile ="temple_innen.mesh" visible="true" receivesShadow="true">
+		<entity name="temple_innen" meshfile ="temple_innen.mesh" visible="true" receivesShadow="false">
 			<position x="122.11" y="0.076957" z="-20.5749" />
 			<rotation qx="0.0" qy="0.0" qz="0.0" qw="1.0" />
 			<scale x="1.0" y="1.0" z="1.0" />
 			<staticgeometrygroup id="3"/>
 			<renderingdistance data="100" />
 		</entity>
-		<entity name="Statue_01" meshfile ="Statue_01.mesh" visible="true" receivesShadow="true">
+		<entity name="Statue_01" meshfile ="Statue_01.mesh" visible="true" receivesShadow="false">
 			<position x="112.486" y="1.53497" z="-17.18" />
 			<rotation qx="0.0" qy="-0.707107" qz="0.0" qw="0.707107" />
 			<scale x="1.0" y="1.0" z="1.0" />
 			<staticgeometrygroup id="3"/>
 			<renderingdistance data="100" />
 		</entity>
-		<entity name="Statue_02" meshfile ="Statue_02.mesh" visible="true" receivesShadow="true">
+		<entity name="Statue_02" meshfile ="Statue_02.mesh" visible="true" receivesShadow="false">
 			<position x="112.486" y="1.53497" z="-24.0179" />
 			<rotation qx="0.0" qy="-0.707107" qz="0.0" qw="0.707107" />
 			<scale x="1.0" y="1.0" z="1.0" />
@@ -204,28 +211,28 @@
 		
 		
 		
-		<entity name="dome_sun" meshfile ="dome_sun.mesh" visible="true" receivesShadow="true">
+		<entity name="dome_sun" meshfile ="dome_sun.mesh" visible="true" receivesShadow="false">
 			<position x="614.1" y="1980.49" z="-3609.07" />
 			<rotation qx="0.838383" qy="-0.00269342" qz="0.163517" qw="0.51997" />
 			<scale x="38.9469" y="38.9469" z="38.9469" />
 			<staticgeometrygroup id="2"/>
 			<renderingdistance data="10000" />
 		</entity>
-		<entity name="dome_clouds_near" meshfile ="dome_clouds_near.mesh" visible="true" receivesShadow="true">
+		<entity name="dome_clouds_near" meshfile ="dome_clouds_near.mesh" visible="true" receivesShadow="false">
 			<position x="0.0" y="0.0" z="0.0" />
 			<rotation qx="0.0" qy="0.0" qz="0.0" qw="1.0" />
 			<scale x="5.08402" y="4.00516" z="4.00516" />
 			<staticgeometrygroup id="2"/>
 			<renderingdistance data="10000" />
 		</entity>
-		<entity name="dome_clouds_far" meshfile ="dome_clouds_far.mesh" visible="true" receivesShadow="true">
+		<entity name="dome_clouds_far" meshfile ="dome_clouds_far.mesh" visible="true" receivesShadow="false">
 			<position x="0.0" y="0.0" z="0.0" />
 			<rotation qx="0.0" qy="0.0" qz="0.0" qw="1.0" />
 			<scale x="1.7353" y="1.7353" z="1.7353" />
 			<staticgeometrygroup id="2"/>
 			<renderingdistance data="10000" />
 		</entity>
-		<entity name="dome" meshfile ="dome.mesh" visible="true" receivesShadow="true">
+		<entity name="dome" meshfile ="dome.mesh" visible="true" receivesShadow="false">
 			<position x="170.899" y="-451.645" z="-112.896" />
 			<rotation qx="0.0" qy="0.0" qz="0.0" qw="1.0" />
 			<scale x="3.14024" y="3.14024" z="3.14024" />
@@ -342,6 +349,30 @@
 			<lightAttenuation range="10" constant="1.0" linear="0.001"
 				quadratic="0.2" />
 		</light>
+		<light name="Ruchin_Wirtshaus_Light1" type="point" visible="false"
+			castShadows="false">
+			<position x="53.188" y="1.963" z="-33.053" />
+			<colourDiffuse r="0.8" g="0.8" b="0.5" />
+			<colourSpecular r="0.8" g="0.8" b="0.5" />
+			<lightAttenuation range="10" constant="1.0" linear="0.001"
+				quadratic="0.2" />
+		</light>
+		<light name="Ruchin_Wirtshaus_Light2" type="point" visible="false"
+			castShadows="false">
+			<position x="44.472" y="1.146" z="-27.568" />
+			<colourDiffuse r="0.8" g="0.8" b="0.5" />
+			<colourSpecular r="0.8" g="0.8" b="0.5" />
+			<lightAttenuation range="10" constant="1.0" linear="0.001"
+				quadratic="0.2" />
+		</light>
+		<light name="Ruchin_Wirtshaus_Light3" type="point" visible="false"
+			castShadows="false">
+			<position x="43.17" y="5.455" z="-23.66" />
+			<colourDiffuse r="0.8" g="0.8" b="0.5" />
+			<colourSpecular r="0.8" g="0.8" b="0.5" />
+			<lightAttenuation range="10" constant="1.0" linear="0.001"
+				quadratic="0.2" />
+		</light>
 		
 		<light name="sun" type="directional" visible="true" castShadows="true">
 			<colourDiffuse r="0.9" g="0.8" b="0.8" />
@@ -354,6 +385,24 @@
 			
 			<sound name="ruchin001.ogg"/>
 		</zone>
+		
+		<zone name="Ruchin_m_lightzone_Wirtshaus">
+			<area type="mesh" meshfile="Ruchin_m_lightzone_Wirtshaus.mesh">
+				<position x="45" y="0" z="-30.0"/>
+			</area>
+			<light name="Ruchin_Wirtshaus_Light1"/>
+			<light name="Ruchin_Wirtshaus_Light2"/>
+			<light name="Ruchin_Wirtshaus_Light3"/>
+		</zone>
+		
+		<zone name="Ruchin_m_lightzone_Keller">
+			<area type="mesh" meshfile="Ruchin_m_lightzone_Keller.mesh">
+				<position x="45" y="0" z="-30.0"/>
+			</area>
+			<light name="Ruchin_Wirtshaus_Light3"/>
+
+		</zone>
+		
 		<zone name="temple_zone">
 			<area type="mesh" meshfile="temple_lightzone.mesh">
 				<position x="123.798" y="0" z="-20.5"/>

Added: modules/ruchin/materials/textures/ruchin_ao_m.png
===================================================================
(Binary files differ)


Property changes on: modules/ruchin/materials/textures/ruchin_ao_m.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Modified: modules/ruchin/models/Ruchin_m.mesh
===================================================================
(Binary files differ)

Added: modules/ruchin/models/Ruchin_m_innen.mesh
===================================================================
(Binary files differ)


Property changes on: modules/ruchin/models/Ruchin_m_innen.mesh
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: modules/ruchin/models/Ruchin_m_lightzone_Keller.mesh
===================================================================
(Binary files differ)


Property changes on: modules/ruchin/models/Ruchin_m_lightzone_Keller.mesh
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: modules/ruchin/models/Ruchin_m_lightzone_Wirtshaus.mesh
===================================================================
(Binary files differ)


Property changes on: modules/ruchin/models/Ruchin_m_lightzone_Wirtshaus.mesh
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Modified: modules/ruchin/models/Ruchin_p.mesh
===================================================================
(Binary files differ)

Modified: modules/ruchin/models/Ruchintest.material
===================================================================
--- modules/ruchin/models/Ruchintest.material	2007-12-12 14:10:26 UTC (rev 4022)
+++ modules/ruchin/models/Ruchintest.material	2007-12-13 19:31:58 UTC (rev 4023)
@@ -149,3 +149,17 @@
 set_texture_alias ambient ruchin_ao_s.png
 
 }
+
+material Ruchin_m : Basic_Vertex_Shader_AO
+{
+set_texture_alias diffuse ruchin_atlasmap.png
+set_texture_alias ambient ruchin_ao_m.png
+
+}
+
+material Ruchin_m_Schiefer : Basic_Vertex_Shader_AO
+{
+set_texture_alias diffuse arc_schieferdach.png
+set_texture_alias ambient ruchin_ao_m.png
+
+}
\ No newline at end of file

Modified: modules/ruchin/scripts/maps/maptest.rb
===================================================================
--- modules/ruchin/scripts/maps/maptest.rb	2007-12-12 14:10:26 UTC (rev 4022)
+++ modules/ruchin/scripts/maps/maptest.rb	2007-12-13 19:31:58 UTC (rev 4023)
@@ -84,7 +84,7 @@
 fackellicht.getControlledObject().setCastShadows(false);
 fackellicht.getControlledObject().setDiffuseColour(0.8,0.7,0.6);
 fackellicht.getControlledObject().setAttenuation(5.0, 0.79,  -0.21, 0.268 );
-$hero.getActor().attachToSlot( fackellicht, "Bip01 R SlotHand" );
+#$hero.getActor().attachToSlot( fackellicht, "Bip01 R SlotHand" );
 $SCRIPT.log("Fackellicht erstellt.");
 ##########################
 



From pnyx at mail.berlios.de  Sat Dec 15 17:09:14 2007
From: pnyx at mail.berlios.de (pnyx at mail.berlios.de)
Date: Sat, 15 Dec 2007 17:09:14 +0100
Subject: [Dsa-hl-svn] r4024 - in modules:
	common/materials/programs/Normalmapping
	regressiontest/scripts/maps ruchin/materials/textures
	ruchin/models ruchin/scripts/maps
Message-ID: <200712151609.lBFG9EVm009057@sheep.berlios.de>

Author: pnyx
Date: 2007-12-15 17:06:34 +0100 (Sat, 15 Dec 2007)
New Revision: 4024

Added:
   modules/common/materials/programs/Normalmapping/Architecture_Normalmapping.material
   modules/common/materials/programs/Normalmapping/Basic_Normalmapping_architecture_PS.hlsl
   modules/common/materials/programs/Normalmapping/Basic_Normalmapping_architecture_VS.hlsl
Modified:
   modules/common/materials/programs/Normalmapping/Normalmapping.program
   modules/regressiontest/scripts/maps/regressiontest.rb
   modules/ruchin/materials/textures/ruchin_atlas_normal.png
   modules/ruchin/models/Ruchin_n.mesh
   modules/ruchin/models/Ruchintest.material
   modules/ruchin/scripts/maps/maptest.rb
Log:
testing normalmaps for architecture

Added: modules/common/materials/programs/Normalmapping/Architecture_Normalmapping.material
===================================================================
--- modules/common/materials/programs/Normalmapping/Architecture_Normalmapping.material	2007-12-13 19:31:58 UTC (rev 4023)
+++ modules/common/materials/programs/Normalmapping/Architecture_Normalmapping.material	2007-12-15 16:06:34 UTC (rev 4024)
@@ -0,0 +1,70 @@
+material Architecture_Normalmapping 
+{
+	//lod_distances 70 100
+	
+    technique hlsl
+    {
+	    //lod_index 0
+        pass
+        {
+            vertex_program_ref Basic_Normalmapping_architecture_VS_HLSL
+            {
+                param_named_auto matViewProjection worldviewproj_matrix
+                param_named_auto LightPosition_0 light_position_object_space 0
+                param_named_auto LightPosition_1 light_position_object_space 1
+                param_named_auto LightPosition_2 light_position_object_space 2
+                
+                param_named_auto LightAttn_0 light_attenuation 0
+                param_named_auto LightAttn_1 light_attenuation 1
+                param_named_auto LightAttn_2 light_attenuation 2
+                
+                param_named_auto vViewPosition	 camera_position_object_space
+            }
+
+            fragment_program_ref Basic_Normalmapping_architecture_PS_HLSL
+            {
+                param_named_auto LightColor_0  light_diffuse_colour  0
+                param_named_auto LightColor_1  light_diffuse_colour  1
+                param_named_auto LightColor_2  light_diffuse_colour  2
+                
+                param_named groundcolor float4 0.1 0.1 0.1 1.0
+                param_named skycolor float4 0.5 0.5 0.5 1.0
+                param_named SpecColor float4 0.1 0.1 0.1 1.0
+                param_named SpecExp float 16.0
+            }
+			
+            // Base diffuse texture map
+            texture_unit DiffuseMap
+            {
+                texture_alias DiffuseMap
+            }
+
+            // Normal map
+            texture_unit NormalMap
+            {
+                texture_alias NormalMap
+            }
+            texture_unit AOMap
+            {
+                texture_alias AOMap
+            }
+        }
+    }
+
+    technique fixed_function
+    {
+	    lod_index 2
+        pass
+        {
+            ambient 0.6 0.6 0.6 1.0
+            diffuse 0.7 0.7 0.7 1.0
+            specular 0.3 0.3 0.3 1.0 16.0
+
+            // Base diffuse texture map
+            texture_unit DiffuseMap
+            {
+                texture_alias DiffuseMap
+            }
+        } 
+    }
+}
\ No newline at end of file

Added: modules/common/materials/programs/Normalmapping/Basic_Normalmapping_architecture_PS.hlsl
===================================================================
--- modules/common/materials/programs/Normalmapping/Basic_Normalmapping_architecture_PS.hlsl	2007-12-13 19:31:58 UTC (rev 4023)
+++ modules/common/materials/programs/Normalmapping/Basic_Normalmapping_architecture_PS.hlsl	2007-12-15 16:06:34 UTC (rev 4024)
@@ -0,0 +1,68 @@
+float4 LightColor_0;
+float4 LightColor_1;
+float4 LightColor_2;
+float4 groundcolor;
+float4 skycolor;
+float4 SpecColor;
+float SpecExp;
+sampler DiffuseMap;
+sampler NormalMap;
+sampler AOMap;
+
+
+float4 ps_main(
+               float4 UV        : TEXCOORD0,// uv 0 +1
+               float4 LightDir_0  : TEXCOORD1,
+               float3 HalfVect_0  : TEXCOORD2,
+               float4 LightDir_1 : TEXCOORD3,
+               float3 HalfVect_1 : TEXCOORD4,
+               float4 LightDir_2 : TEXCOORD5,
+               float4 HalfVect_2 : TEXCOORD6, //uv2.x
+               float4 SkyDir     : TEXCOORD7 //uv2.y
+               ) : COLOR0
+{ 
+
+   float3 normal = tex2D(NormalMap,UV.xy).rgb *2 -1;
+   float4 ambient= lerp(skycolor , groundcolor, ((dot(normal, SkyDir) + 1.0)/2.0));
+   float4 ao = saturate(0.5+(tex2D(AOMap,UV.zw)/2));
+   	
+   float specAttn;
+   float specAttn1;
+   float specAttn2;
+   float4 AngleAttn;
+   float4 AngleAttn1;
+   float4 AngleAttn2;
+   
+   
+   AngleAttn= saturate(dot(normal,LightDir_0.xyz));
+   AngleAttn1= saturate(dot(normal,LightDir_1.xyz));
+   AngleAttn2= saturate(dot(normal,LightDir_2.xyz));
+   
+   if (AngleAttn.r > 0.0)
+   {
+      specAttn = LightColor_0 * pow(clamp(dot(normal,normalize(HalfVect_0)),0,1),SpecExp)* LightDir_0.w;
+      AngleAttn *= LightColor_0 * LightDir_0.w;
+   }
+   
+   if (AngleAttn1.r > 0.0)
+   {
+      specAttn1  =LightColor_1 *  pow(clamp(dot(normal,normalize(HalfVect_1)),0,1),SpecExp)* LightDir_1.w;
+      AngleAttn1 *= LightColor_1 * LightDir_1.w;
+   }
+  
+   if (AngleAttn2.r > 0.0)
+   {
+      specAttn2  =LightColor_2 *  pow(clamp(dot(normal,normalize(HalfVect_2)),0,1),SpecExp)* LightDir_2.w;
+      AngleAttn2 *= LightColor_2 * LightDir_2.w;
+   }
+  
+  
+   float4 Diffuse = AngleAttn + AngleAttn1 + AngleAttn2;
+   float4 specular = SpecColor * (specAttn + specAttn1 + specAttn2) * Diffuse;
+   
+   
+   return (tex2D(DiffuseMap,UV) * (ambient + Diffuse)*ao) +specular;
+}
+
+
+

Added: modules/common/materials/programs/Normalmapping/Basic_Normalmapping_architecture_VS.hlsl
===================================================================
--- modules/common/materials/programs/Normalmapping/Basic_Normalmapping_architecture_VS.hlsl	2007-12-13 19:31:58 UTC (rev 4023)
+++ modules/common/materials/programs/Normalmapping/Basic_Normalmapping_architecture_VS.hlsl	2007-12-15 16:06:34 UTC (rev 4024)
@@ -0,0 +1,107 @@
+float4x4 matViewProjection;
+float4 LightPosition_0;
+float4 LightPosition_1;
+float4 LightPosition_2;
+float4 vViewPosition;
+float4 LightAttn_0;
+float4 LightAttn_1;
+float4 LightAttn_2;
+
+struct VS_OUTPUT 
+{
+   float4 Position   : POSITION0;
+   float4 UV         : TEXCOORD0; // uv1 / 2
+   float4 LightDir_0 : TEXCOORD1;
+   float3 HalfVect_0 : TEXCOORD2;
+   float4 LightDir_1 : TEXCOORD3;
+   float3 HalfVect_1 : TEXCOORD4;
+   float4 LightDir_2 : TEXCOORD5;
+   float4 HalfVect_2 : TEXCOORD6; // uv2 x
+   float4 SkyDir     : TEXCOORD7; // uv2 y
+   
+};
+
+VS_OUTPUT vs_main(      float4 inPosition : POSITION0,
+                        float3 inNormal : NORMAL0,
+                        float3 inTangent : TANGENT0,
+                        float2 inUV:   TEXCOORD0,
+                        float2 inUV1:   TEXCOORD1,
+                        float2 inUV2:   TEXCOORD2  )
+{
+   VS_OUTPUT Output;
+
+   Output.Position = mul( matViewProjection, inPosition );
+   Output.UV.xy = inUV;
+   Output.UV.zw = inUV1;
+   Output.HalfVect_2.w = inUV2.x;
+   Output.SkyDir.w = inUV2.y;
+   
+   float3x3 TangentSpace;
+   
+   TangentSpace[0] = inTangent;   
+   TangentSpace[1] = cross(inTangent,inNormal);   
+   TangentSpace[2] = inNormal;
+   
+   float3 EyeVector = normalize(vViewPosition - inPosition);
+   
+   //################# Light 0  ################
+   float4 LightDir;
+   LightDir.xyz = LightPosition_0 - inPosition * LightPosition_0.w;
+   float Dist = length(LightDir.xyz);
+   LightDir.xyz = LightDir.xyz /Dist;
+   
+   if (LightPosition_0.w != 0.0)
+   LightDir.w = saturate(1/(LightAttn_0.y +
+                            LightAttn_0.z * Dist +
+                            LightAttn_0.w * Dist * Dist)*saturate(LightAttn_0.x-Dist));
+   else
+   LightDir.w = saturate(dot(LightDir.xyz,inNormal )+0.2);                         
+   
+   
+   Output.HalfVect_0 = mul(TangentSpace, normalize(LightDir.xyz + EyeVector));
+   Output.LightDir_0 = float4(mul(TangentSpace,LightDir.xyz),LightDir.w);
+   
+   //################# Light 1  ################
+   LightDir;
+   LightDir.xyz = LightPosition_1 - inPosition * LightPosition_1.w;
+   Dist = length(LightDir.xyz);
+   LightDir.xyz = LightDir.xyz /Dist;
+   
+   if (LightPosition_1.w != 0.0)
+   LightDir.w = saturate(1/(LightAttn_1.y +
+                            LightAttn_1.z * Dist +
+                            LightAttn_1.w * Dist * Dist)*saturate(LightAttn_1.x-Dist));
+   else
+   LightDir.w = saturate(dot(LightDir.xyz,inNormal )+0.2);                         
+   
+   Output.HalfVect_1 = mul(TangentSpace, normalize(LightDir.xyz + EyeVector));
+   Output.LightDir_1 = float4(mul(TangentSpace,LightDir.xyz),LightDir.w);
+   
+   //################# Light 2  ################
+   LightDir;
+   LightDir.xyz = LightPosition_2 - inPosition * LightPosition_2.w;
+   Dist = length(LightDir.xyz);
+   LightDir.xyz = LightDir.xyz /Dist;
+   
+   if (LightPosition_2.w != 0.0)
+   LightDir.w = saturate(1/(LightAttn_2.y +
+                            LightAttn_2.z * Dist +
+                            LightAttn_2.w * Dist * Dist)*saturate(LightAttn_2.x-Dist));
+   else
+   LightDir.w = saturate(dot(LightDir.xyz,inNormal )+0.2);                         
+
+
+   Output.HalfVect_2.xyz = mul(TangentSpace, normalize(LightDir.xyz + EyeVector));
+   Output.LightDir_2 = float4(mul(TangentSpace,LightDir.xyz),LightDir.w);
+   
+   
+   // SkyLight
+   Output.SkyDir.xyz    = mul(TangentSpace, float3(0,-1,0));
+   
+   
+   return( Output );
+   
+}
+
+
+

Modified: modules/common/materials/programs/Normalmapping/Normalmapping.program
===================================================================
--- modules/common/materials/programs/Normalmapping/Normalmapping.program	2007-12-13 19:31:58 UTC (rev 4023)
+++ modules/common/materials/programs/Normalmapping/Normalmapping.program	2007-12-15 16:06:34 UTC (rev 4024)
@@ -5,6 +5,13 @@
     target vs_1_1
 }
 
+vertex_program Basic_Normalmapping_architecture_VS_HLSL hlsl
+{
+    source Basic_Normalmapping_architecture_VS.hlsl
+    entry_point vs_main
+    target vs_1_1
+}
+
 vertex_program Basic_Normalmapping_UV0_noDirectional_VS_HLSL hlsl
 {
     source Basic_Normalmapping_UV0_noDirectional_VS.hlsl
@@ -32,6 +39,12 @@
     entry_point ps_main
     target ps_2_0
 }
+fragment_program Basic_Normalmapping_architecture_PS_HLSL hlsl
+{
+    source Basic_Normalmapping_architecture_PS.hlsl
+    entry_point ps_main
+    target ps_2_0
+}
 
 
 fragment_program Basic_Normalmapping_mirrored_PS_HLSL hlsl

Modified: modules/regressiontest/scripts/maps/regressiontest.rb
===================================================================
--- modules/regressiontest/scripts/maps/regressiontest.rb	2007-12-13 19:31:58 UTC (rev 4023)
+++ modules/regressiontest/scripts/maps/regressiontest.rb	2007-12-15 16:06:34 UTC (rev 4024)
@@ -40,22 +40,22 @@
 
 
  MaterialSlotTest.new([-15, 0, -5]).run()
-#    LightzoneTest.new([-10, 0, -5]).run()
-#ErrorHandlingTest.new([-10, 0, 5]).run()
-#         TimeTest.new([ -5, 0, -5]).run()
-#   MapLoadingTest.new([ -5, 0, -10]).run()
+    LightzoneTest.new([-10, 0, -5]).run()
+ErrorHandlingTest.new([-10, 0, 5]).run()
+         TimeTest.new([ -5, 0, -5]).run()
+   MapLoadingTest.new([ -5, 0, -10]).run()
           NpcTest.new([ -5, 0, 5]).run()
-#GameObjectCreationTest.new([0, 0, -10]).run()
-#         DoorTest.new([  0, 0, -5]).run()
-#	  WalkJobTest.new([  0, 0, -3]).run()
-#   NpcCapsuleTest.new([  0, 0, 5]).run()
-#    InventoryTest.new([  0, 0, 10]).run()
-#  JobSequenceTest.new([  5, 0, -5]).run()
-#     SelectorTest.new([  5, 0, 0]).run()
-#       EffectTest.new([  5, 0, 5]).run()
-#MergeableMeshTest.new([ 10, 0, 0]).run()
-#        SoundTest.new([ 10, 0, 10]).run()
-#     MeshAreaTest.new([-50, 0,-55]).run()
+GameObjectCreationTest.new([0, 0, -10]).run()
+         DoorTest.new([  0, 0, -5]).run()
+	  WalkJobTest.new([  0, 0, -3]).run()
+   NpcCapsuleTest.new([  0, 0, 5]).run()
+    InventoryTest.new([  0, 0, 10]).run()
+  JobSequenceTest.new([  5, 0, -5]).run()
+     SelectorTest.new([  5, 0, 0]).run()
+       EffectTest.new([  5, 0, 5]).run()
+MergeableMeshTest.new([ 10, 0, 0]).run()
+        SoundTest.new([ 10, 0, 10]).run()
+     MeshAreaTest.new([-50, 0,-55]).run()
 
 $SCRIPT.log("tests initialisiert.");
 

Modified: modules/ruchin/materials/textures/ruchin_atlas_normal.png
===================================================================
(Binary files differ)

Modified: modules/ruchin/models/Ruchin_n.mesh
===================================================================
(Binary files differ)

Modified: modules/ruchin/models/Ruchintest.material
===================================================================
--- modules/ruchin/models/Ruchintest.material	2007-12-13 19:31:58 UTC (rev 4023)
+++ modules/ruchin/models/Ruchintest.material	2007-12-15 16:06:34 UTC (rev 4024)
@@ -101,11 +101,26 @@
 
 }
 
-
-material Ruchin_map : Basic_Vertex_Shader_Ground
+//set_texture_alias diffuse karte_fliped.jpg
+//: Basic_Vertex_Shader_Ground
+material Ruchin_map 
 {
-set_texture_alias diffuse karte_fliped.jpg
 
+	technique
+	{
+		pass
+		{ 
+
+     	    //depth_write off
+			texture_unit
+			{
+				texture karte_fliped.jpg
+				
+			}
+			
+		}
+
+	}
 } 
 
 
@@ -129,32 +144,37 @@
 }
 // ruchin_ao_n.png
 
-material Ruchin_n : Basic_Vertex_Shader_AO
+material Ruchin_n : Architecture_Normalmapping
 {
-set_texture_alias diffuse ruchin_atlasmap.png
-set_texture_alias ambient ruchin_ao_n.png
+set_texture_alias DiffuseMap ruchin_atlasmap.png
+set_texture_alias NormalMap ruchin_atlas_normal.png
+set_texture_alias AOMap ruchin_ao_n.png
 
 }
 
-material Ruchin_p : Basic_Vertex_Shader_AO
+material Ruchin_p : Architecture_Normalmapping
 {
-set_texture_alias diffuse ruchin_atlasmap.png
-set_texture_alias ambient ruchin_ao_p.png
+set_texture_alias DiffuseMap ruchin_atlasmap.png
+set_texture_alias NormalMap ruchin_atlas_normal.png
+set_texture_alias AOMap ruchin_ao_p.png
 
 }
 
-material Ruchin_s : Basic_Vertex_Shader_AO
+material Ruchin_s : Architecture_Normalmapping
 {
-set_texture_alias diffuse ruchin_atlasmap.png
-set_texture_alias ambient ruchin_ao_s.png
+set_texture_alias DiffuseMap ruchin_atlasmap.png
+set_texture_alias NormalMap ruchin_atlas_normal.png
+set_texture_alias AOMap ruchin_ao_s.png
 
 }
 
-material Ruchin_m : Basic_Vertex_Shader_AO
+material Ruchin_m : Architecture_Normalmapping
 {
-set_texture_alias diffuse ruchin_atlasmap.png
-set_texture_alias ambient ruchin_ao_m.png
+set_texture_alias DiffuseMap ruchin_atlasmap.png
+set_texture_alias NormalMap ruchin_atlas_normal.png
+set_texture_alias AOMap ruchin_ao_m.png
 
+
 }
 
 material Ruchin_m_Schiefer : Basic_Vertex_Shader_AO

Modified: modules/ruchin/scripts/maps/maptest.rb
===================================================================
--- modules/ruchin/scripts/maps/maptest.rb	2007-12-13 19:31:58 UTC (rev 4023)
+++ modules/ruchin/scripts/maps/maptest.rb	2007-12-15 16:06:34 UTC (rev 4024)
@@ -84,7 +84,7 @@
 fackellicht.getControlledObject().setCastShadows(false);
 fackellicht.getControlledObject().setDiffuseColour(0.8,0.7,0.6);
 fackellicht.getControlledObject().setAttenuation(5.0, 0.79,  -0.21, 0.268 );
-#$hero.getActor().attachToSlot( fackellicht, "Bip01 R SlotHand" );
+$hero.getActor().attachToSlot( fackellicht, "Bip01 R SlotHand" );
 $SCRIPT.log("Fackellicht erstellt.");
 ##########################
 



From pnyx at mail.berlios.de  Sat Dec 15 17:55:55 2007
From: pnyx at mail.berlios.de (pnyx at mail.berlios.de)
Date: Sat, 15 Dec 2007 17:55:55 +0100
Subject: [Dsa-hl-svn] r4025 - in modules/ruchin: maps materials
	materials/textures models
Message-ID: <200712151655.lBFGtt2X012277@sheep.berlios.de>

Author: pnyx
Date: 2007-12-15 17:55:16 +0100 (Sat, 15 Dec 2007)
New Revision: 4025

Modified:
   modules/ruchin/maps/ruchin_lightzones.rlmap.xml
   modules/ruchin/materials/statue02.material
   modules/ruchin/materials/textures/Ingrimiane_normal.png
   modules/ruchin/models/Statue01.material
   modules/ruchin/models/Statue_01.mesh
   modules/ruchin/models/Statue_02.mesh
Log:
Temple Statues using default Normalmapping shader now

Modified: modules/ruchin/maps/ruchin_lightzones.rlmap.xml
===================================================================
--- modules/ruchin/maps/ruchin_lightzones.rlmap.xml	2007-12-15 16:06:34 UTC (rev 4024)
+++ modules/ruchin/maps/ruchin_lightzones.rlmap.xml	2007-12-15 16:55:16 UTC (rev 4025)
@@ -157,7 +157,7 @@
 		
 		
 		
-		<entity name="Ruchin_map" meshfile ="Ruchin_map.mesh" visible="true" receivesShadow="false">
+		<entity name="Ruchin_map" meshfile ="Ruchin_map.mesh" visible="true" receivesShadow="true">
 			<position x="68.5845" y="-0.00679748" z="-47.3902" />
 			<rotation qx="0.0" qy="0.0" qz="0.0" qw="1.0" />
 			<scale x="1.0" y="1.0" z="1.0" />

Modified: modules/ruchin/materials/statue02.material
===================================================================
--- modules/ruchin/materials/statue02.material	2007-12-15 16:06:34 UTC (rev 4024)
+++ modules/ruchin/materials/statue02.material	2007-12-15 16:55:16 UTC (rev 4025)
@@ -1,7 +1,7 @@
-material Statue_02 : NormalMapMaterialSpecular2Lights1UV
+material Statue_02 : Basic_Normalmapping_Spec
 {
-	set_texture_alias diffusemap Statue_02_diffuse.png
-	set_texture_alias normalmap Statue_02_normals.png
-	set_texture_alias specmap Statue_02_specular.png
+	set_texture_alias DiffuseMap Statue_02_diffuse.png
+	set_texture_alias NormalMap Statue_02_normals.png
+	set_texture_alias SpecMap Statue_02_specular.png
 
 }

Modified: modules/ruchin/materials/textures/Ingrimiane_normal.png
===================================================================
(Binary files differ)

Modified: modules/ruchin/models/Statue01.material
===================================================================
--- modules/ruchin/models/Statue01.material	2007-12-15 16:06:34 UTC (rev 4024)
+++ modules/ruchin/models/Statue01.material	2007-12-15 16:55:16 UTC (rev 4025)
@@ -1,6 +1,6 @@
-material Statue_01 : NormalMapMaterialSpecular2Lights2UV
+material Statue_01 : Basic_Normalmapping_Spec
 {
-			set_texture_alias normalmap Ingrimiane_normal.png
-			set_texture_alias diffusemap Ingrimiane_diffuse.png
-			set_texture_alias specmap Ingrimiane_spec.png
+			set_texture_alias NormalMap Ingrimiane_normal.png
+			set_texture_alias DiffuseMap Ingrimiane_diffuse.png
+			set_texture_alias SpecMap Ingrimiane_spec.png
 }
\ No newline at end of file

Modified: modules/ruchin/models/Statue_01.mesh
===================================================================
(Binary files differ)

Modified: modules/ruchin/models/Statue_02.mesh
===================================================================
(Binary files differ)



From timm at mail.berlios.de  Mon Dec 17 22:46:19 2007
From: timm at mail.berlios.de (timm at mail.berlios.de)
Date: Mon, 17 Dec 2007 22:46:19 +0100
Subject: [Dsa-hl-svn] r4026 - in rl/trunk/engine: core/include core/src
	ui/include ui/src
Message-ID: <200712172146.lBHLkJAf004707@sheep.berlios.de>

Author: timm
Date: 2007-12-17 22:46:11 +0100 (Mon, 17 Dec 2007)
New Revision: 4026

Modified:
   rl/trunk/engine/core/include/SaveGameManager.h
   rl/trunk/engine/core/src/SaveGameFile.cpp
   rl/trunk/engine/core/src/SaveGameManager.cpp
   rl/trunk/engine/ui/include/GameSaveLoadWindow.h
   rl/trunk/engine/ui/src/GameSaveLoadWindow.cpp
   rl/trunk/engine/ui/src/MainMenuLoadWindow.cpp
Log:
- saving save games in the format <save game name>.<module id>.save
- deleting save games
- select save games in the list

Modified: rl/trunk/engine/core/include/SaveGameManager.h
===================================================================
--- rl/trunk/engine/core/include/SaveGameManager.h	2007-12-15 16:55:16 UTC (rev 4025)
+++ rl/trunk/engine/core/include/SaveGameManager.h	2007-12-17 21:46:11 UTC (rev 4026)
@@ -77,6 +77,7 @@
         void loadSaveGameFile(const CeGuiString &name);
         void deleteSaveGameFile(const CeGuiString &name);
         bool SaveGameFileExists(const CeGuiString &name);
+        SaveGameFile* getSaveGameFile(const CeGuiString &name);
 
         virtual const Ogre::StringVector&  getScriptPatterns(void) const;
         virtual void parseScript(Ogre::DataStreamPtr &stream, const Ogre::String &groupName);

Modified: rl/trunk/engine/core/src/SaveGameFile.cpp
===================================================================
--- rl/trunk/engine/core/src/SaveGameFile.cpp	2007-12-15 16:55:16 UTC (rev 4025)
+++ rl/trunk/engine/core/src/SaveGameFile.cpp	2007-12-17 21:46:11 UTC (rev 4026)
@@ -33,8 +33,6 @@
     SaveGameFile::SaveGameFile(const CeGuiString &name) : mStream((Ogre::DataStream*)NULL)
     {
         mName = name;
-
-        
     }
 
     SaveGameFile::~SaveGameFile()
@@ -43,7 +41,7 @@
 
     CeGuiString SaveGameFile::buildFilename()
     {
-        return ConfigurationManager::getSingleton().getModulesRootDirectory() + "/saves/" + mName + ".save";
+        return ConfigurationManager::getSingleton().getModulesRootDirectory() + "/saves/" + mName + "." + mModuleID + ".save";
     }
 
     CeGuiString SaveGameFile::getName()

Modified: rl/trunk/engine/core/src/SaveGameManager.cpp
===================================================================
--- rl/trunk/engine/core/src/SaveGameManager.cpp	2007-12-15 16:55:16 UTC (rev 4025)
+++ rl/trunk/engine/core/src/SaveGameManager.cpp	2007-12-17 21:46:11 UTC (rev 4026)
@@ -146,6 +146,14 @@
             return true;
         return false;
     }
+
+    SaveGameFile* SaveGameManager::getSaveGameFile(const CeGuiString &name)
+    {
+        SaveGameEntryMap::const_iterator it = mSaveGames.find(name);
+        if(it != mSaveGames.end())
+            return it->second;
+        return NULL;
+    }
     
     const Ogre::StringVector& SaveGameManager::getScriptPatterns() const
     {
@@ -161,6 +169,8 @@
     {
         Ogre::String name = stream->getName();
         name = name.substr(0, name.length()-5); //delete ".save" at the and of the name
+        int pointpos = name.find_last_of(".");
+        name = name.substr(0, pointpos);
 
         SaveGameFile* file = new SaveGameFile(name);
         

Modified: rl/trunk/engine/ui/include/GameSaveLoadWindow.h
===================================================================
--- rl/trunk/engine/ui/include/GameSaveLoadWindow.h	2007-12-15 16:55:16 UTC (rev 4025)
+++ rl/trunk/engine/ui/include/GameSaveLoadWindow.h	2007-12-17 21:46:11 UTC (rev 4026)
@@ -59,6 +59,7 @@
         bool handleLoadEvent();
         bool handleSaveEvent();
         bool handleDeleteEvent();
+        bool handleSelectSaveGame();
 
         void listSaveGames();
         

Modified: rl/trunk/engine/ui/src/GameSaveLoadWindow.cpp
===================================================================
--- rl/trunk/engine/ui/src/GameSaveLoadWindow.cpp	2007-12-15 16:55:16 UTC (rev 4025)
+++ rl/trunk/engine/ui/src/GameSaveLoadWindow.cpp	2007-12-17 21:46:11 UTC (rev 4026)
@@ -60,6 +60,9 @@
         mSaveGameTable->addColumn( (utf8*)"Filename", 0, cegui_reldim(0.7));
         mSaveGameTable->addColumn( (utf8*)"Date", 1, cegui_reldim(0.3));
 
+        mSaveGameTable->setSelectionMode(MultiColumnList::RowSingle);
+        mSaveGameTable->subscribeEvent(MultiColumnList::EventSelectionChanged, boost::bind(&GameSaveLoadWindow::handleSelectSaveGame, this));
+
         centerWindow();
 
         getPushButton("GameSaveLoadWindow/ButtonSheet/LoadButton")->subscribeEvent(
@@ -157,6 +160,11 @@
     bool GameSaveLoadWindow::handleDeleteEvent()
     {
         LOG_MESSAGE(Logger::UI, "Delete Button pressed");
+        if(SaveGameManager::getSingleton().SaveGameFileExists(mFilename->getText()))
+        {
+            SaveGameManager::getSingleton().deleteSaveGameFile(mFilename->getText());
+            listSaveGames();
+        }
         return true;
     }
 
@@ -181,4 +189,11 @@
         //mSaveGameTable->autoSizeColumnHeader(1);
     }
 
+    bool GameSaveLoadWindow::handleSelectSaveGame()
+    {
+        if(mSaveGameTable->getFirstSelectedItem())
+            mFilename->setText(mSaveGameTable->getFirstSelectedItem()->getText());
+        return true;
+    }
+
 } // namespace rl

Modified: rl/trunk/engine/ui/src/MainMenuLoadWindow.cpp
===================================================================
--- rl/trunk/engine/ui/src/MainMenuLoadWindow.cpp	2007-12-15 16:55:16 UTC (rev 4025)
+++ rl/trunk/engine/ui/src/MainMenuLoadWindow.cpp	2007-12-17 21:46:11 UTC (rev 4026)
@@ -161,6 +161,11 @@
     bool MainMenuLoadWindow::handleDeleteEvent()
     {
         LOG_MESSAGE(Logger::UI, "Delete Button pressed");
+        if(SaveGameManager::getSingleton().SaveGameFileExists(mFilename->getText()))
+        {
+            SaveGameManager::getSingleton().deleteSaveGameFile(mFilename->getText());
+            listSaveGames();
+        }
         return true;
     }
 



From timm at mail.berlios.de  Tue Dec 18 21:00:51 2007
From: timm at mail.berlios.de (timm at mail.berlios.de)
Date: Tue, 18 Dec 2007 21:00:51 +0100
Subject: [Dsa-hl-svn] r4027 - rl/trunk/engine/core/src
Message-ID: <200712182000.lBIK0p0u015786@sheep.berlios.de>

Author: timm
Date: 2007-12-18 21:00:43 +0100 (Tue, 18 Dec 2007)
New Revision: 4027

Modified:
   rl/trunk/engine/core/src/SaveGameFile.cpp
   rl/trunk/engine/core/src/SaveGameManager.cpp
Log:
fixed loading save games

Modified: rl/trunk/engine/core/src/SaveGameFile.cpp
===================================================================
--- rl/trunk/engine/core/src/SaveGameFile.cpp	2007-12-17 21:46:11 UTC (rev 4026)
+++ rl/trunk/engine/core/src/SaveGameFile.cpp	2007-12-18 20:00:43 UTC (rev 4027)
@@ -53,7 +53,7 @@
     {
         Ogre::ResourceGroupManager::getSingleton().createResourceGroup("SaveGame");
 
-        mScriptPatterns.push_back((mName + ".save").c_str());
+        mScriptPatterns.push_back((mName + "." + mModuleID + ".save").c_str());
 
         Ogre::ResourceGroupManager::getSingleton()._registerScriptLoader(this);
 

Modified: rl/trunk/engine/core/src/SaveGameManager.cpp
===================================================================
--- rl/trunk/engine/core/src/SaveGameManager.cpp	2007-12-17 21:46:11 UTC (rev 4026)
+++ rl/trunk/engine/core/src/SaveGameManager.cpp	2007-12-18 20:00:43 UTC (rev 4027)
@@ -122,6 +122,7 @@
             MessagePump::getSingleton().sendMessage<MessageType_SaveGameLoading>();
 
             SaveGameFile file(name);
+            file.setProperty(SaveGameFile::PROPERTY_MODULEID, Property(CoreSubsystem::getSingleton().getActiveAdventureModule()->getName()));
             SaveGameFileReader reader;
             reader.parseSaveGameFile(&file, mSaveGameDataOrderMap);
             ///@todo: SaveGameReader



From blakharaz at mail.berlios.de  Tue Dec 18 22:46:56 2007
From: blakharaz at mail.berlios.de (blakharaz at mail.berlios.de)
Date: Tue, 18 Dec 2007 22:46:56 +0100
Subject: [Dsa-hl-svn] r4028 - in rl/trunk/engine: common/include common/src
	core/include core/src rules/src script/src
Message-ID: <200712182146.lBILkulf023988@sheep.berlios.de>

Author: blakharaz
Date: 2007-12-18 22:46:46 +0100 (Tue, 18 Dec 2007)
New Revision: 4028

Modified:
   rl/trunk/engine/common/include/XmlPropertyWriter.h
   rl/trunk/engine/common/src/XmlPropertyWriter.cpp
   rl/trunk/engine/core/include/SaveGameFileReader.h
   rl/trunk/engine/core/include/SaveGameFileWriter.h
   rl/trunk/engine/core/src/SaveGameFileReader.cpp
   rl/trunk/engine/core/src/SaveGameFileWriter.cpp
   rl/trunk/engine/rules/src/GameObjectManager.cpp
   rl/trunk/engine/rules/src/QuestBook.cpp
   rl/trunk/engine/script/src/TriggerFactory.cpp
Log:
Refactoring: Remove DOM elements from SaveGameData interface

Modified: rl/trunk/engine/common/include/XmlPropertyWriter.h
===================================================================
--- rl/trunk/engine/common/include/XmlPropertyWriter.h	2007-12-18 20:00:43 UTC (rev 4027)
+++ rl/trunk/engine/common/include/XmlPropertyWriter.h	2007-12-18 21:46:46 UTC (rev 4028)
@@ -52,7 +52,7 @@
         XERCES_CPP_NAMESPACE::DOMElement* processPropertyArray(XERCES_CPP_NAMESPACE::DOMElement* parent, const char* const name, PropertyVector vector);
         XERCES_CPP_NAMESPACE::DOMElement* processPropertyMap(XERCES_CPP_NAMESPACE::DOMElement* parent, const char* const name, PropertyMap map);
 
-        void writeEachProperty(XERCES_CPP_NAMESPACE::DOMElement* parent, const PropertyMap &map);
+        void writeEachPropertyToElem(XERCES_CPP_NAMESPACE::DOMElement* parent, const PropertyMap &map);
     protected:
         std::vector<PropertyRecord*> mPropertyRecords;
 

Modified: rl/trunk/engine/common/src/XmlPropertyWriter.cpp
===================================================================
--- rl/trunk/engine/common/src/XmlPropertyWriter.cpp	2007-12-18 20:00:43 UTC (rev 4027)
+++ rl/trunk/engine/common/src/XmlPropertyWriter.cpp	2007-12-18 21:46:46 UTC (rev 4028)
@@ -135,7 +135,7 @@
         return element;
     }
 
-    void XmlPropertyWriter::writeEachProperty(DOMElement* parent, const rl::PropertyMap &map)
+    void XmlPropertyWriter::writeEachPropertyToElem(DOMElement* parent, const rl::PropertyMap &map)
     {
         PropertyMap::const_iterator it_properties;
         for(it_properties = map.begin(); it_properties != map.end(); it_properties++)

Modified: rl/trunk/engine/core/include/SaveGameFileReader.h
===================================================================
--- rl/trunk/engine/core/include/SaveGameFileReader.h	2007-12-18 20:00:43 UTC (rev 4027)
+++ rl/trunk/engine/core/include/SaveGameFileReader.h	2007-12-18 21:46:46 UTC (rev 4028)
@@ -34,6 +34,8 @@
         void parseSaveGameFile(SaveGameFile* file, const SaveGameDataOrderMap &map);
         void parseSaveGameFileHeader(Ogre::DataStreamPtr &stream, const Ogre::String &groupName, SaveGameFile* file);
 
+        PropertyRecord getAllPropertiesAsRecord(SaveGameData* data);
+
         XERCES_CPP_NAMESPACE::DOMDocument* getDocument() {return mDocument;}
     };
 }

Modified: rl/trunk/engine/core/include/SaveGameFileWriter.h
===================================================================
--- rl/trunk/engine/core/include/SaveGameFileWriter.h	2007-12-18 20:00:43 UTC (rev 4027)
+++ rl/trunk/engine/core/include/SaveGameFileWriter.h	2007-12-18 21:46:46 UTC (rev 4028)
@@ -33,6 +33,7 @@
     {
     public:
         void buildSaveGameFile(SaveGameFile *file, const SaveGameDataOrderMap &map);
+        void writeEachProperty(SaveGameData* data, const rl::PropertyMap &map);
     };
 }
 

Modified: rl/trunk/engine/core/src/SaveGameFileReader.cpp
===================================================================
--- rl/trunk/engine/core/src/SaveGameFileReader.cpp	2007-12-18 20:00:43 UTC (rev 4027)
+++ rl/trunk/engine/core/src/SaveGameFileReader.cpp	2007-12-18 21:46:46 UTC (rev 4028)
@@ -83,4 +83,23 @@
 
         shutdownXml();
     }
+
+    PropertyRecord SaveGameFileReader::getAllPropertiesAsRecord(SaveGameData* data)
+    {
+        PropertyRecord properties;
+
+        initializeXml();
+
+        DOMNodeList* rootNodeList = getDocument()->getDocumentElement()->getElementsByTagName(AutoXMLCh(data->getXmlNodeIdentifier().c_str()).data());
+
+        if (rootNodeList->getLength())
+        {
+            DOMNode* xmlPropElem = rootNodeList->item(0);
+            properties = getPropertiesAsRecord(static_cast<DOMElement*>(xmlPropElem));
+        }
+
+        shutdownXml();
+
+        return properties;
+    }
 }
\ No newline at end of file

Modified: rl/trunk/engine/core/src/SaveGameFileWriter.cpp
===================================================================
--- rl/trunk/engine/core/src/SaveGameFileWriter.cpp	2007-12-18 20:00:43 UTC (rev 4027)
+++ rl/trunk/engine/core/src/SaveGameFileWriter.cpp	2007-12-18 21:46:46 UTC (rev 4028)
@@ -92,4 +92,11 @@
 
         shutdownXml();
     }
+
+    void SaveGameFileWriter::writeEachProperty(SaveGameData* data, const rl::PropertyMap &map)
+    {
+        DOMElement* saveElem = appendChildElement(getDocument(), getDocument()->getDocumentElement(), data->getXmlNodeIdentifier().c_str());
+
+        XmlPropertyWriter::writeEachPropertyToElem(saveElem, map);
+    }
 }

Modified: rl/trunk/engine/rules/src/GameObjectManager.cpp
===================================================================
--- rl/trunk/engine/rules/src/GameObjectManager.cpp	2007-12-18 20:00:43 UTC (rev 4027)
+++ rl/trunk/engine/rules/src/GameObjectManager.cpp	2007-12-18 21:46:46 UTC (rev 4028)
@@ -317,7 +317,7 @@
             writer->setAttributeValueAsInteger(gameobject, "State", (int)(*it_gameobjects)->getState());
 
             PropertyMap map = (*it_gameobjects)->getAllProperties()->toPropertyMap();
-            writer->writeEachProperty(gameobject, map);
+            writer->writeEachPropertyToElem(gameobject, map);
         } 
     }
 

Modified: rl/trunk/engine/rules/src/QuestBook.cpp
===================================================================
--- rl/trunk/engine/rules/src/QuestBook.cpp	2007-12-18 20:00:43 UTC (rev 4027)
+++ rl/trunk/engine/rules/src/QuestBook.cpp	2007-12-18 21:46:46 UTC (rev 4028)
@@ -265,16 +265,12 @@
         return "questbook";
     }
 
-    using namespace XERCES_CPP_NAMESPACE;
-
     void QuestBook::writeData(SaveGameFileWriter *writer)
     {
         LOG_MESSAGE(Logger::RULES, "Saving questbook");
 
-        DOMElement* quests = writer->appendChildElement(writer->getDocument(), writer->getDocument()->getDocumentElement(), getXmlNodeIdentifier().c_str());
-
         PropertyRecord* set = getAllProperties();
-        writer->writeEachProperty(quests, set->toPropertyMap());
+        writer->writeEachProperty(this, set->toPropertyMap());
     }
 
     void QuestBook::readData(SaveGameFileReader* reader)
@@ -282,19 +278,8 @@
         LOG_MESSAGE(Logger::RULES, "Loading questbook");
 
         clear();
-        reader->initializeXml();
-
-        DOMNodeList* rootNodeList = reader->getDocument()->getDocumentElement()->getElementsByTagName(AutoXMLCh(getXmlNodeIdentifier().c_str()).data());
-
-        if(rootNodeList->getLength())
-        {
-            DOMNode* xmlQuestBook = rootNodeList->item(0);
-            PropertyRecord properties = reader->getPropertiesAsRecord(static_cast<DOMElement*>(xmlQuestBook));
-
-            setProperties(&properties);
-        }
-
-        reader->shutdownXml();
+        PropertyRecord properties = reader->getAllPropertiesAsRecord(this);
+        setProperties(&properties);
     }
 
     void QuestBook::clear()

Modified: rl/trunk/engine/script/src/TriggerFactory.cpp
===================================================================
--- rl/trunk/engine/script/src/TriggerFactory.cpp	2007-12-18 20:00:43 UTC (rev 4027)
+++ rl/trunk/engine/script/src/TriggerFactory.cpp	2007-12-18 21:46:46 UTC (rev 4028)
@@ -63,7 +63,7 @@
                     writer->setAttributeValueAsStdString(triggerNode, "zone", zone->first);
 
                     PropertyMap map = (*trigger)->getAllProperties()->toPropertyMap();
-                    writer->writeEachProperty(triggerNode, map);
+                    writer->writeEachPropertyToElem(triggerNode, map);
                 }
             }
         }



From blakharaz at mail.berlios.de  Tue Dec 18 22:49:31 2007
From: blakharaz at mail.berlios.de (blakharaz at mail.berlios.de)
Date: Tue, 18 Dec 2007 22:49:31 +0100
Subject: [Dsa-hl-svn] r4029 - in rl/trunk/engine/rules: include src
Message-ID: <200712182149.lBILnV17024354@sheep.berlios.de>

Author: blakharaz
Date: 2007-12-18 22:49:27 +0100 (Tue, 18 Dec 2007)
New Revision: 4029

Modified:
   rl/trunk/engine/rules/include/Container.h
   rl/trunk/engine/rules/include/Slot.h
   rl/trunk/engine/rules/src/Container.cpp
   rl/trunk/engine/rules/src/Item.cpp
   rl/trunk/engine/rules/src/Slot.cpp
Log:
Change item state transitions (possible recursion must be avoided by removing callbacks)

Modified: rl/trunk/engine/rules/include/Container.h
===================================================================
--- rl/trunk/engine/rules/include/Container.h	2007-12-18 21:46:46 UTC (rev 4028)
+++ rl/trunk/engine/rules/include/Container.h	2007-12-18 21:49:27 UTC (rev 4029)
@@ -112,9 +112,10 @@
 
         /*
          * recursive function
-         * @return true, if the item is this container or any of his parents
+         * @param cont a container
+         * @return true, if cont is this container or any of his parents
         */
-        bool findContainerRecursion(Item* item);
+        bool isParent(Container* cont);
     };
 }
 

Modified: rl/trunk/engine/rules/include/Slot.h
===================================================================
--- rl/trunk/engine/rules/include/Slot.h	2007-12-18 21:46:46 UTC (rev 4028)
+++ rl/trunk/engine/rules/include/Slot.h	2007-12-18 21:49:27 UTC (rev 4029)
@@ -26,7 +26,10 @@
 class _RlRulesExport Slot
 {
 public:
-    virtual void setItem(Item* item) = 0;
+    // provides standard behaviour, sets
+    // item-state etc, returns true, if succeeded to set item, false indicates to to nothing
+    // subclasses MUST call this method when overriding
+    virtual bool setItem(Item* item);
     Item* getItem() const;
     bool isAllowed(const Item* item) const;
     bool isEmpty() const {return mItem == NULL;}
@@ -37,9 +40,6 @@
 protected:
     Slot(Creature* owner, const CeGuiString& name, int itemReadyMask, int itemHeldMask);
 
-    // intended to be used in setItem-Function, provides standard behaviour, sets
-    // item-state etc, returns true, if succeeded to set item, false indicates to to nothing
-    bool standardSetItem(Item* item);
 
     Creature* mOwner;
     Item* mItem;
@@ -56,7 +56,7 @@
 {
 public:
     BoneSlot(Creature* owner, const CeGuiString& name, int itemReadyMask, int itemHeldMask, const Ogre::String& bone);
-    virtual void setItem(Item* item);
+    virtual bool setItem(Item* item);
 
 private:
     Ogre::String mBone;
@@ -66,7 +66,7 @@
 {
 public:
     SubmeshSlot(Creature* owner, const CeGuiString& name, int itemReadyMask, int itemHeldMask, const Ogre::String& submesh);
-    virtual void setItem(Item* item);
+    virtual bool setItem(Item* item);
 
 private:
     Ogre::String mSubmesh;
@@ -76,7 +76,7 @@
 {
 public:
     MaterialSlot(Creature* owner, const CeGuiString& name, int itemReadyMask, int itemHeldMask, const Ogre::String& submesh);
-    virtual void setItem(Item* item);
+    virtual bool setItem(Item* item);
 
 private:
     Ogre::String mSubmesh;

Modified: rl/trunk/engine/rules/src/Container.cpp
===================================================================
--- rl/trunk/engine/rules/src/Container.cpp	2007-12-18 21:46:46 UTC (rev 4028)
+++ rl/trunk/engine/rules/src/Container.cpp	2007-12-18 21:49:27 UTC (rev 4029)
@@ -22,6 +22,7 @@
 #include "Exception.h"
 #include "GameObjectManager.h"
 #include "Item.h"
+#include "Slot.h"
 
 using namespace std;
 
@@ -89,50 +90,50 @@
         return mItems;
     }
 
-    bool Container::findContainerRecursion(Item* item)
+    bool Container::isParent(Container* cont)
     {
-        if( item == this )
+        if (cont == this)
             return true;
 
         Item* parent = this->getParentContainer();
-        while( parent )
+        while (parent)
         {
-            if( item == parent )
+            if (cont == parent)
                 return true;
             parent = parent->getParentContainer();
         }
-        
-        Container* itemAsContainer = dynamic_cast<Container*>(item);
-        if( !itemAsContainer )
+         
+         // c++ allows nasty accesses like this ;-)
+        for (ItemSet::iterator iter = cont->mItems.begin(); 
+            iter != cont->mItems.end(); ++iter)
         {
-            Throw(NullPointerException, "Could not cast item to Container!");
-        }
-
-        ItemSet::iterator iter = itemAsContainer->mItems.begin(); // c++ allows nasty accesses like this ;-)
-        for( ; iter != itemAsContainer->mItems.end(); iter++)
-        {
-            if( (*iter)->isContainer() )
-                if( findContainerRecursion(*iter) )
+            if ((*iter)->isContainer())
+            {
+                if (isParent(dynamic_cast<Container*>(*iter)))
+                {
                     return true;
+                }
+            }
         }
         return false;
     }
 
     bool Container::addItem(Item* item, IntPair position)
     {
-        if(item == NULL)
+        if (item == NULL)
         {
             Throw(NullPointerException, "Item ist null.");
         }
 
         // find recursions, we cannot place the container in the same container etc
-        if( item->isContainer() )
+        if (item->isContainer())
         {
-            if( findContainerRecursion(item) )
+            if (isParent(dynamic_cast<Container*>(item)))
+            {
                 return false;
+            } 
         }
 
-
         IntPair pos = position;
 		if (!canPlaceAt(item, pos.first, pos.second))
 		{
@@ -141,13 +142,21 @@
 
 		if (pos != NO_SPACE_FOR_ITEM)
 		{
-            item->removeOldState();
+            if (item->getParentSlot())
+            {
+                item->getParentSlot()->setItem(NULL);
+            }
+            if (item->getParentContainer())
+            {
+                item->getParentContainer()->removeItem(item);
+            }
+            item->setOwner(NULL);
 
             mItemPositions[item] = pos;
 			mItems.insert(item);
 
             item->setParentContainer(this);
-            if(mOwner)
+            if (mOwner)
                 item->setOwner(mOwner);
             else
                 item->setOwner(this);
@@ -171,7 +180,7 @@
             
             // this is the case, if the item is removed automatically
             // don't change this without looking at Item::setState
-            if( item->getState() != GOS_LOADED )
+            if (item->getState() != GOS_LOADED)
                 item->setState(GOS_LOADED);
         }
         else
@@ -192,16 +201,16 @@
 
 		bool free = true;
 
-        // Es wird versucht, das Item au?erhalb des Containers zu platzieren
+        // Es wird versucht, das Item au???erhalb des Containers zu platzieren
         if (xPos + xSize > mVolume.first
             || yPos + ySize > mVolume.second)
         {
             return false;
         }
 
-		for (int x = xPos; x < (xPos + xSize); x++)
+		for (int x = xPos; x < (xPos + xSize); ++x)
         {
-			for (int y = yPos; y < (yPos + ySize); y++)
+			for (int y = yPos; y < (yPos + ySize); ++y)
             {
                 LOG_DEBUG2(Logger::RULES,
 					Ogre::String("Checking Point in Backpack: Point x:")
@@ -211,9 +220,9 @@
                     "Container::canPlaceAt()");
 
                 Item* itemFound = getItemAt(x, y);
-                if( itemFound == NULL )
+                if (itemFound == NULL)
                     continue;
-                if( itemFound == item )
+                if (itemFound == item)
                     continue;
 
 				return false;
@@ -262,7 +271,7 @@
 
     bool Container::checkSpace(int xStart, int yStart, pair<int,int> space) const
     {
-		// Falls K?stchen nicht mehr im Rucksack, ist auch kein Platz mehr :)
+		// Falls K???stchen nicht mehr im Rucksack, ist auch kein Platz mehr :)
         if ((xStart+space.first) > mVolume.first
             || (yStart+space.second) > mVolume.second)
         {

Modified: rl/trunk/engine/rules/src/Item.cpp
===================================================================
--- rl/trunk/engine/rules/src/Item.cpp	2007-12-18 21:46:46 UTC (rev 4028)
+++ rl/trunk/engine/rules/src/Item.cpp	2007-12-18 21:49:27 UTC (rev 4029)
@@ -106,66 +106,103 @@
 // --------------- Warning ------------
 // do not change this function without
 // having a look at the containers and slots
-    void Item::setState(GameObjectState targetstate)
+    void Item::setState(GameObjectState targetState)
     {
-        if (mState == targetstate)
+        if (mState == targetState)
         {
             return;
         }
+        
+        // This should do nothing if target or current state is not GOS_LOADED or GOS_IN_SCENE
+        GameObject::setState(targetState); 
 
-        GameObjectState oldState = mState;
-
-
-        if (targetstate != GOS_HELD &&
-            targetstate != GOS_IN_POSSESSION &&
-            targetstate != GOS_READY)
+        if (targetState == GOS_IN_POSSESSION)
         {
-            if (mState == GOS_HELD ||
-                mState == GOS_IN_POSSESSION ||
-                mState == GOS_READY)
+            if (mState == GOS_LOADED)
             {
-                mState = GOS_LOADED; // <- this is important to avoid endless recursion!
-                onStateChange(oldState, mState);
-
-                if (getParentSlot())
-                    getParentSlot()->setItem(NULL);
-                setParentSlot(NULL);
-                if (getParentContainer())
-                    getParentContainer()->removeItem(this);
-                setParentContainer(NULL);
+                onStateChange(mState, targetState);
+            }
+            else if (mState == GOS_IN_SCENE)
+            {
+                destroyActor();
+                onStateChange(mState, targetState);
+            }
+            else if (mState == GOS_HELD
+                || mState == GOS_READY)
+            {
                 doLoose();
-                setOwner(NULL);
+                onStateChange(mState, targetState);
             }
-
-            GameObject::setState(targetstate);
         }
-        else
+        else if (targetState == GOS_HELD || targetState == GOS_READY)
         {
-            if (mState == GOS_HELD ||
-                mState == GOS_IN_POSSESSION ||
-                mState == GOS_READY)
+            if (mState == GOS_LOADED)
             {
-                LOG_WARNING(Logger::RULES, 
-                    "Item::removeOldState() or Item::setState(GOS_LOADED) should be called  \
-                    before setting one of the States GOS_HELD, GOS_IN_POSSESSION or GOS_READY!");
+                doCreateActor();
+                doHold();
+                onStateChange(mState, targetState);
             }
-            else
+            else if (mState == GOS_IN_SCENE)
             {
-                if (mState != GOS_LOADED)
-                {
-                    GameObject::setState(GOS_LOADED);
-                    oldState = GOS_LOADED;
-                }
+                mActor->removeFromScene();
+                doHold();
+                onStateChange(mState, targetState);
+            }
+        }
 
-                if (targetstate == GOS_HELD)
-                {
-                    doHold();
-                }
+        mState = targetState;
 
-                mState = targetstate;
-                onStateChange(oldState, mState);
-            }
-        }
+
+        //if (targetstate != GOS_HELD &&
+        //    targetstate != GOS_IN_POSSESSION &&
+        //    targetstate != GOS_READY)
+        //{
+        //    if (mState == GOS_HELD ||
+        //        mState == GOS_IN_POSSESSION ||
+        //        mState == GOS_READY)
+        //    {
+        //        mState = GOS_LOADED; // <- this is important to avoid endless recursion!
+        //        
+
+        //        if (getParentSlot())
+        //            getParentSlot()->setItem(NULL);
+        //        setParentSlot(NULL);
+        //        if (getParentContainer())
+        //            getParentContainer()->removeItem(this);
+        //        setParentContainer(NULL);
+        //        doLoose();
+        //        setOwner(NULL);
+        //    }
+
+        //    GameObject::setState(targetstate);
+        //}
+        //else
+        //{
+        //    if (mState == GOS_HELD ||
+        //        mState == GOS_IN_POSSESSION ||
+        //        mState == GOS_READY)
+        //    {
+        //        LOG_WARNING(Logger::RULES, 
+        //            "Item::removeOldState() or Item::setState(GOS_LOADED) should be called  \
+        //            before setting one of the States GOS_HELD, GOS_IN_POSSESSION or GOS_READY!");
+        //    }
+        //    else
+        //    {
+        //        if (mState != GOS_LOADED)
+        //        {
+        //            GameObject::setState(GOS_LOADED);
+        //            oldState = GOS_LOADED;
+        //        }
+
+        //        if (targetstate == GOS_HELD)
+        //        {
+        //            doHold();
+        //        }
+
+        //        mState = targetstate;
+        //        onStateChange(oldState, mState);
+        //    }
+        //}
     }
 
     void Item::setProperty(const Ogre::String &key, const rl::Property &value)

Modified: rl/trunk/engine/rules/src/Slot.cpp
===================================================================
--- rl/trunk/engine/rules/src/Slot.cpp	2007-12-18 21:46:46 UTC (rev 4028)
+++ rl/trunk/engine/rules/src/Slot.cpp	2007-12-18 21:49:27 UTC (rev 4029)
@@ -56,7 +56,7 @@
         return (type & mItemReadyMask) == type;
     }
 
-    bool Slot::standardSetItem(Item* item)
+    bool Slot::setItem(Item* item)
     {
         if (item)
         {
@@ -88,7 +88,6 @@
             if (mItem->getState() != GOS_LOADED)
                 mItem->setState(GOS_LOADED);
             mItem = NULL;
-
         }
 
         return true;
@@ -100,10 +99,12 @@
     {
     }
 
-    void BoneSlot::setItem(Item* item)
+    bool BoneSlot::setItem(Item* item)
     {
-        if (!standardSetItem(item))
-            return;
+        if (!Slot::setItem(item))
+        {
+            return false;
+        }
 
         if (item)
         {
@@ -111,13 +112,15 @@
                 || mOwner->getState() == GOS_HELD
                 || mOwner->getState() == GOS_READY)
             {
-                if (!mItem->getActor())
+                if (!item->getActor())
                 {
-                    mItem->doCreateActor();
+                    item->doCreateActor();
                 }
-                mOwner->getActor()->attachToSlot(mItem->getActor(), mBone);
+                mOwner->getActor()->attachToSlot(item->getActor(), mBone);
             }
         }
+
+        return true;
     }
 
 
@@ -126,13 +129,14 @@
     {
     }
 
-    void SubmeshSlot::setItem(Item* item)
+    bool SubmeshSlot::setItem(Item* item)
     {
         Item* oldItem = mItem;
-        if (!standardSetItem(item))
-            return;
+        if (!Slot::setItem(item))
+        {
+            return false;
+        }
 
-
 	    if (mOwner->getActor())
 	    {
 		    MergeableMeshObject* mmo = dynamic_cast<MergeableMeshObject*>(
@@ -170,6 +174,8 @@
                 mOwner->getActor()->getPhysicalThing()->updatePhysicsProxy();
             }
 	    }
+
+        return true;
     }
 
     MaterialSlot::MaterialSlot(Creature* owner, const CeGuiString& name, int itemReadyMask, int itemHeldMask, const Ogre::String& submesh)
@@ -178,12 +184,13 @@
     {
     }
 
-    void MaterialSlot::setItem(Item* item)
+    bool MaterialSlot::setItem(Item* item)
     {
-        if (!standardSetItem(item))
-            return;
+        if (!Slot::setItem(item))
+        {
+            return false;
+        }
 
-
         if (item)
         {
             try
@@ -215,6 +222,8 @@
         {
             ///@todo reset material?
         }
+
+        return true;
     }
 
 } // namespace rl



From blakharaz at mail.berlios.de  Tue Dec 18 22:51:04 2007
From: blakharaz at mail.berlios.de (blakharaz at mail.berlios.de)
Date: Tue, 18 Dec 2007 22:51:04 +0100
Subject: [Dsa-hl-svn] r4030 - in rl/trunk/engine: ai/include ai/src
	script/swig ui/src
Message-ID: <200712182151.lBILp46w024430@sheep.berlios.de>

Author: blakharaz
Date: 2007-12-18 22:50:58 +0100 (Tue, 18 Dec 2007)
New Revision: 4030

Modified:
   rl/trunk/engine/ai/include/Dialog.h
   rl/trunk/engine/ai/include/DialogManager.h
   rl/trunk/engine/ai/src/Dialog.cpp
   rl/trunk/engine/ai/src/DialogManager.cpp
   rl/trunk/engine/script/swig/RlAi.swig
   rl/trunk/engine/ui/src/DialogWindow.cpp
Log:
Save dialogs, introduce option for multiple pcs and npcs

Modified: rl/trunk/engine/ai/include/Dialog.h
===================================================================
--- rl/trunk/engine/ai/include/Dialog.h	2007-12-18 21:49:27 UTC (rev 4029)
+++ rl/trunk/engine/ai/include/Dialog.h	2007-12-18 21:50:58 UTC (rev 4030)
@@ -32,7 +32,7 @@
     public:
 		static const Ogre::String PROP_EXIT_REQUESTED;
 
-        Dialog(Creature* pc, Creature* npc);
+        Dialog(const std::vector<Creature*>& pc, const std::vector<Creature*>& npc);
         ~Dialog();
 
         DialogResponse* getDialogStart() const;

Modified: rl/trunk/engine/ai/include/DialogManager.h
===================================================================
--- rl/trunk/engine/ai/include/DialogManager.h	2007-12-18 21:49:27 UTC (rev 4029)
+++ rl/trunk/engine/ai/include/DialogManager.h	2007-12-18 21:50:58 UTC (rev 4030)
@@ -22,10 +22,12 @@
 
 #include <OgreScriptLoader.h>
 #include "Properties.h"
+#include "SaveGameManager.h"
 #include "XmlProcessor.h"
 
 namespace rl
 {
+    class Creature;
     class Dialog;
     class DialogCondition;
     class DialogElement;
@@ -34,22 +36,37 @@
     class DialogParagraph;
     class DialogResponse;
     class DialogVariable;
-    class Creature;
 
     class _RlAiExport DialogManager 
         : public Ogre::Singleton<DialogManager>, 
         public Ogre::ScriptLoader, 
+        public PropertyHolder,
+        public SaveGameData,
         private XmlProcessor
     {
     public:
+        static const Ogre::String PROPERTY_DIALOGS;
+        static const Ogre::String PROPERTY_DIALOG;
+        static const Ogre::String PROPERTY_DIALOG_NAME;
+        static const Ogre::String PROPERTY_NPCS;
+
         DialogManager();
         ~DialogManager();
 
         virtual const Ogre::StringVector& getScriptPatterns() const;
         virtual void parseScript(Ogre::DataStreamPtr& stream, const Ogre::String& groupName);
 		virtual Ogre::Real getLoadingOrder() const;
-        Dialog* createDialog(const Ogre::String& name, Creature* pc, Creature* npc);
+        Dialog* createDialog(const Ogre::String& name, rl::Creature* npc, rl::Creature* pc);
+        Dialog* createDialog(const Ogre::String& name, const std::vector<Creature*>& pcs, const std::vector<Creature*>& npcs);
 
+        virtual const Property getProperty(const Ogre::String& key) const;
+        virtual void setProperty(const Ogre::String& key, const Property& value);
+        virtual PropertyRecord* getAllProperties() const;
+        virtual void writeData(SaveGameFileWriter *writer);
+        virtual void readData(SaveGameFileReader* reader);
+        virtual CeGuiString getXmlNodeIdentifier() const;
+        virtual int getPriority() const;
+
     private:
 
         class DialogPrototype
@@ -61,7 +78,7 @@
             DialogResponse* getResponse(int id) const;
 
             void setStartResponse(DialogResponse* response);
-            Dialog* createDialog(Creature* pc, Creature* npc);
+            Dialog* createDialog(const std::vector<Creature*>& pcs, const std::vector<Creature*>& npcs);
             void setProperty(const Ogre::String& key, const Property& value);
 
         private:
@@ -71,6 +88,21 @@
             PropertyRecord mPropertyVariables;
         };
 
+        class DialogConfiguration
+        {
+        public:
+            DialogConfiguration(const Ogre::String& name, const std::vector<Creature*>& npcs);
+
+            const Ogre::String& getName() const;
+            const std::vector<Creature*>& getNpcs() const;
+            
+            bool operator==(const DialogConfiguration&) const;
+            bool operator<(const DialogConfiguration&) const;
+        private:
+            Ogre::String mDialogName;
+            std::vector<Creature*> mNpcs;
+        };
+
         void processDialog(XERCES_CPP_NAMESPACE::DOMElement* dialogXml);
         DialogResponse* processResponseClasses(XERCES_CPP_NAMESPACE::DOMNode *node, DialogPrototype* dialogPrototype);
         DialogResponse* processResponse(XERCES_CPP_NAMESPACE::DOMElement* responseXml, DialogPrototype* dialogPrototype, bool subelements);
@@ -89,6 +121,7 @@
 
         Ogre::StringVector mScriptPatterns;
         std::map<Ogre::String, DialogPrototype*> mDialogs;
+        std::map<DialogConfiguration, Dialog*> mDialogStates;
     };
 
 }

Modified: rl/trunk/engine/ai/src/Dialog.cpp
===================================================================
--- rl/trunk/engine/ai/src/Dialog.cpp	2007-12-18 21:49:27 UTC (rev 4029)
+++ rl/trunk/engine/ai/src/Dialog.cpp	2007-12-18 21:50:58 UTC (rev 4030)
@@ -22,10 +22,10 @@
 {
 	const Ogre::String Dialog::PROP_EXIT_REQUESTED = "exit_requested";
 
-    Dialog::Dialog(Creature* npc, Creature* pc)
+    Dialog::Dialog(const std::vector<Creature*>& npc, const std::vector<Creature*>& pc)
     {
-        mNonPlayerCharacters.push_back(npc);
-        mPlayerCharacters.push_back(pc);
+        mNonPlayerCharacters = npc;
+        mPlayerCharacters = pc;
     }
 
     Dialog::~Dialog()

Modified: rl/trunk/engine/ai/src/DialogManager.cpp
===================================================================
--- rl/trunk/engine/ai/src/DialogManager.cpp	2007-12-18 21:49:27 UTC (rev 4029)
+++ rl/trunk/engine/ai/src/DialogManager.cpp	2007-12-18 21:50:58 UTC (rev 4030)
@@ -19,6 +19,7 @@
 
 #include <xercesc/dom/DOM.hpp>
 
+#include "Creature.h"
 #include "Dialog.h"
 #include "DialogCondition.h"
 #include "DialogElement.h"
@@ -27,6 +28,7 @@
 #include "DialogParagraph.h"
 #include "DialogResponse.h"
 #include "DialogVariable.h"
+#include "GameObjectManager.h"
 #include "XmlPropertyReader.h"
 
 using namespace Ogre;
@@ -37,15 +39,21 @@
 
 namespace rl
 {
+    const Ogre::String DialogManager::PROPERTY_DIALOGS = "dialogs";
+    const Ogre::String DialogManager::PROPERTY_DIALOG = "dialog";
+    const Ogre::String DialogManager::PROPERTY_DIALOG_NAME = "name";
+    const Ogre::String DialogManager::PROPERTY_NPCS = "npc";
 
     DialogManager::DialogManager()
         : XmlProcessor(), ScriptLoader()
     {
         mScriptPatterns.push_back("*.dialog");
+        SaveGameManager::getSingleton().registerSaveGameData(this);
     }
 
     DialogManager::~DialogManager()
     {
+        SaveGameManager::getSingleton().unregisterSaveGameData(this);
     }
 
     const StringVector& DialogManager::getScriptPatterns() const
@@ -77,6 +85,78 @@
         shutdownXml();
     }
 
+    const Property DialogManager::getProperty(const Ogre::String &key) const
+    {
+        if (key == DialogManager::PROPERTY_DIALOGS)
+        {
+            PropertyVector vec;
+            for (std::map<DialogConfiguration, Dialog*>::const_iterator it
+                = mDialogStates.begin(); it != mDialogStates.end(); ++it)
+            {
+                PropertyMap curDialogProp;
+                PropertyRecord* dialogProps = it->second->getAllProperties();
+                curDialogProp[DialogManager::PROPERTY_DIALOG] = dialogProps->toPropertyMap();
+                curDialogProp[DialogManager::PROPERTY_DIALOG_NAME] = Property(it->first.getName());
+
+                PropertyVector npcs;
+
+                for (std::vector<Creature*>::const_iterator itNpc = it->first.getNpcs().begin();
+                    itNpc != it->first.getNpcs().end(); ++itNpc)
+                {
+                    npcs.push_back(GameObjectManager::getSingleton().toProperty(*itNpc));
+                }
+
+                curDialogProp[DialogManager::PROPERTY_NPCS] = Property(npcs);
+
+                delete dialogProps;
+            }
+
+            return Property(vec);
+        }
+
+        Throw(IllegalArgumentException, key + " is not a property of DialogManager");
+    }
+
+    PropertyRecord* DialogManager::getAllProperties() const
+    {
+        PropertyRecord* pr = new PropertyRecord();
+        pr->setProperty(DialogManager::PROPERTY_DIALOGS, getProperty(DialogManager::PROPERTY_DIALOGS));
+        return pr;
+    }
+
+    void DialogManager::setProperty(const Ogre::String& key, const Property& value)
+    {
+        ///@todo implement
+    }
+
+    void DialogManager::writeData(SaveGameFileWriter *writer)
+    {
+        LOG_MESSAGE(Logger::RULES, "Saving dialogs");
+
+        PropertyRecord* set = getAllProperties();
+        writer->writeEachProperty(this, set->toPropertyMap());
+        delete set;
+    }
+
+    void DialogManager::readData(SaveGameFileReader* reader)
+    {
+        LOG_MESSAGE(Logger::RULES, "Loading dialogs");
+
+        PropertyRecord properties = reader->getAllPropertiesAsRecord(this);
+        setProperties(&properties);
+    }
+
+    int DialogManager::getPriority() const
+    {
+        return 50;
+    }
+
+    CeGuiString DialogManager::getXmlNodeIdentifier() const
+    {
+        return "dialogs";
+    }
+
+
     void DialogManager::processDialog(DOMElement* dialogElem)
     {
         DialogPrototype* dialogPrototype = new DialogPrototype();
@@ -425,16 +505,38 @@
         return cond;
     }
 
-    Dialog* DialogManager::createDialog(const Ogre::String& name, Creature* pc, Creature* npc)
+    Dialog* DialogManager::createDialog(const Ogre::String& name, Creature* npc, Creature* pc)
     {
-        std::map<Ogre::String, DialogPrototype*>::iterator it = mDialogs.find(name);
-        if (it == mDialogs.end())
+        std::vector<Creature*> npcs;
+        npcs.push_back(npc);
+        std::vector<Creature*> pcs;
+        pcs.push_back(pc);
+
+        return createDialog(name, npcs, pcs);
+    }
+
+    Dialog* DialogManager::createDialog(const Ogre::String& name, const std::vector<Creature*>& pcs, const std::vector<Creature*>& npcs)
+    {
+        std::map<DialogConfiguration, Dialog*>::iterator it 
+            = mDialogStates.find(DialogConfiguration(name, npcs));
+
+        Dialog* dialog;
+        if (it != mDialogStates.end())
         {
-            return NULL;
+            dialog = (*it).second;
         }
+        else 
+        {
+            std::map<Ogre::String, DialogPrototype*>::iterator it = mDialogs.find(name);
+            if (it == mDialogs.end())
+            {
+                return NULL;
+            }
 
-        Dialog* dialog = it->second->createDialog(pc, npc); ///@todo save dialogs
-		dialog->initialize();
+            dialog = it->second->createDialog(pcs, npcs); ///@todo save dialogs
+            dialog->initialize();
+            mDialogStates[DialogConfiguration(name, npcs)] = dialog;
+        }
 		return dialog;
     }
 
@@ -478,9 +580,9 @@
         return it->second;
     }
 
-    Dialog* DialogManager::DialogPrototype::createDialog(Creature* pc, Creature* npc)
+    Dialog* DialogManager::DialogPrototype::createDialog(const std::vector<Creature*>& pcs, const std::vector<Creature*>& npcs)
     {
-        Dialog* dialog = new Dialog(pc, npc);
+        Dialog* dialog = new Dialog(pcs, npcs);
         dialog->setStartResponse(mDialogStart);
         
         for (PropertyRecord::PropertyRecordMap::const_iterator it = mPropertyVariables.begin(); 
@@ -502,6 +604,32 @@
         mDialogStart = start;
     }
 
+    DialogManager::DialogConfiguration::DialogConfiguration(const Ogre::String& name, const std::vector<Creature*>& npcs)
+        : mDialogName(name), mNpcs(npcs)
+    {
+    }
+
+    const Ogre::String& DialogManager::DialogConfiguration::getName() const
+    {
+        return mDialogName;
+    }
+
+    const std::vector<Creature*>& DialogManager::DialogConfiguration::getNpcs() const
+    {
+        return mNpcs;
+    }
+
+    bool DialogManager::DialogConfiguration::operator <(const rl::DialogManager::DialogConfiguration & other) const
+    {
+        return mDialogName < other.mDialogName;
+    }
+
+    bool DialogManager::DialogConfiguration::operator ==(const rl::DialogManager::DialogConfiguration & other) const
+    {
+        return (mDialogName == other.mDialogName) 
+            && (mNpcs == other.mNpcs);
+    }
+
     DialogCondition* DialogManager::processConditionClasses(DOMElement* conditionXml)
     {
         if (hasNodeName(conditionXml, "equals"))

Modified: rl/trunk/engine/script/swig/RlAi.swig
===================================================================
--- rl/trunk/engine/script/swig/RlAi.swig	2007-12-18 21:49:27 UTC (rev 4029)
+++ rl/trunk/engine/script/swig/RlAi.swig	2007-12-18 21:50:58 UTC (rev 4030)
@@ -280,6 +280,7 @@
     public:
         static rl::DialogManager& getSingleton();
         rl::Dialog* createDialog(const Ogre::String& name, rl::Creature* npc, rl::Creature* pc);
+        rl::Dialog* createDialog(const Ogre::String& name, const std::vector<rl::Creature*>& npcs, const std::vector<rl::Creature*>& pcs);
     private:
         DialogManager();
     };

Modified: rl/trunk/engine/ui/src/DialogWindow.cpp
===================================================================
--- rl/trunk/engine/ui/src/DialogWindow.cpp	2007-12-18 21:49:27 UTC (rev 4029)
+++ rl/trunk/engine/ui/src/DialogWindow.cpp	2007-12-18 21:50:58 UTC (rev 4030)
@@ -111,7 +111,7 @@
                 text = cur->getLabel();
             }
 
-			if(optionCount < mDialogOptions->getItemCount())
+			if (optionCount < mDialogOptions->getItemCount())
 			{
 				item = static_cast<ListboxWrappedTextItem*>(
 					mDialogOptions->getListboxItemFromIndex(optionCount));



From timm at mail.berlios.de  Wed Dec 19 20:02:25 2007
From: timm at mail.berlios.de (timm at mail.berlios.de)
Date: Wed, 19 Dec 2007 20:02:25 +0100
Subject: [Dsa-hl-svn] r4031 - modules/common/gui/windows
Message-ID: <200712191902.lBJJ2Pkd017400@sheep.berlios.de>

Author: timm
Date: 2007-12-19 20:02:21 +0100 (Wed, 19 Dec 2007)
New Revision: 4031

Modified:
   modules/common/gui/windows/mainmenuloadwindow.xml
Log:
changed layout of the main menu load window (save games)

Modified: modules/common/gui/windows/mainmenuloadwindow.xml
===================================================================
--- modules/common/gui/windows/mainmenuloadwindow.xml	2007-12-18 21:50:58 UTC (rev 4030)
+++ modules/common/gui/windows/mainmenuloadwindow.xml	2007-12-19 19:02:21 UTC (rev 4031)
@@ -10,32 +10,12 @@
         <Window Type="DefaultGUISheet" Name="MainMenuLoadWindow/FileSheet">
             <Property Name="UnifiedPosition" Value="{{0,30},{0,30}}"/>
             <Property Name="UnifiedSize" Value="{{0,350},{0,385}}"/>
-           
-            <!-- Filename edit box to enter the savegame name -->
-                     
-            <Window Type="RastullahLook/StaticText" Name="MainMenuLoadWindow/FileSheet/File">
-                <Property Name="UnifiedPosition" Value="{{0,0},{0,0}}"/>
-                <Property Name="UnifiedSize" Value="{{0,80},{0,28}}"/>
-                <Property Name="Text" Value="Filename:"/>
-                <Property Name="FrameEnabled" Value="False"/>
-                <Property Name="HorzFormatting" Value="LeftAligned" />
-                <Property Name="Font" Value="Vera Serif-10"/>
-            </Window>
-            
-            <Window Type="RastullahLook/Editbox" Name="MainMenuLoadWindow/FileSheet/Filename">
-                <Property Name="UnifiedPosition" Value="{{0,80},{0,6}}"/>
-                <Property Name="UnifiedSize" Value="{{0,200},{0,28}}"/>
-                <Property Name="Text" Value="enter name"/>
-                <Property Name="FrameEnabled" Value="False"/>
-                <Property Name="HorzFormatting" Value="LeftAligned" />
-                <Property Name="Font" Value="Vera Serif-10"/>
-            </Window>
                    
             <!-- Table with two columns for the filename an save date of saved games -->
             
             <Window Type="RastullahLook/MultiColumnList" Name="MainMenuLoadWindow/FileSheet/SaveGameTable">
-                <Property Name="UnifiedPosition" Value="{{0,0},{0,60}}"/>
-                <Property Name="UnifiedSize" Value="{{1,0},{0,320}}"/>
+                <Property Name="UnifiedPosition" Value="{{0,0},{0,30}}"/>
+                <Property Name="UnifiedSize" Value="{{1,0},{0,380}}"/>
                 <Property Name="Text" Value="SaveGames"/>
                 <Property Name="SortSettingEnabled" Value="False"/>
                 <Property Name="Font" Value="Vera Serif-8"/>
@@ -47,33 +27,26 @@
         <!-- Button sheet for the Load, Save, delete and cancel button -->
         
         <Window Type="DefaultGUISheet" Name="MainMenuLoadWindow/ButtonSheet">
-            <Property Name="UnifiedPosition" Value="{{0,30},{0,415}}"/>
+            <Property Name="UnifiedPosition" Value="{{0,30},{0,435}}"/>
             <Property Name="UnifiedSize" Value="{{0,350},{0,85}}"/>
             
             <Window Type="RastullahLook/Button" Name="MainMenuLoadWindow/ButtonSheet/LoadButton">
                 <Property Name="UnifiedPosition" Value="{{0,0},{0,0}}"/>
-                <Property Name="UnifiedSize" Value="{{0,125},{0,28}}"/>
+                <Property Name="UnifiedSize" Value="{{0,110},{0,28}}"/>
                 <Property Name="Font" Value="Vera Serif-10"/>
                 <Property Name="Text" Value="Load"/>
             </Window>
-            
-            <Window Type="RastullahLook/Button" Name="MainMenuLoadWindow/ButtonSheet/SaveButton">
-                <Property Name="UnifiedPosition" Value="{{0,130},{0,0}}"/>
-                <Property Name="UnifiedSize" Value="{{0,125},{0,28}}"/>
-                <Property Name="Font" Value="Vera Serif-10"/>
-                <Property Name="Text" Value="Save"/>
-            </Window>
          
             <Window Type="RastullahLook/Button" Name="MainMenuLoadWindow/ButtonSheet/DeleteButton">
-                <Property Name="UnifiedPosition" Value="{{0,0},{0,30}}"/>
-                <Property Name="UnifiedSize" Value="{{0,125},{0,28}}"/>
+                <Property Name="UnifiedPosition" Value="{{0,115},{0,0}}"/>
+                <Property Name="UnifiedSize" Value="{{0,110},{0,28}}"/>
                 <Property Name="Font" Value="Vera Serif-10"/>
                 <Property Name="Text" Value="Delete"/>
             </Window>
             
             <Window Type="RastullahLook/Button" Name="MainMenuLoadWindow/ButtonSheet/CancelButton">
-                <Property Name="UnifiedPosition" Value="{{0,130},{0,30}}"/>
-                <Property Name="UnifiedSize" Value="{{0,125},{0,28}}"/>
+                <Property Name="UnifiedPosition" Value="{{0,230},{0,0}}"/>
+                <Property Name="UnifiedSize" Value="{{0,110},{0,28}}"/>
                 <Property Name="Font" Value="Vera Serif-10"/>
                 <Property Name="Text" Value="Cancel"/>
             </Window>



From timm at mail.berlios.de  Wed Dec 19 20:06:07 2007
From: timm at mail.berlios.de (timm at mail.berlios.de)
Date: Wed, 19 Dec 2007 20:06:07 +0100
Subject: [Dsa-hl-svn] r4032 - in rl/trunk/engine: common/include common/src
	core/include core/src ui/include ui/src
Message-ID: <200712191906.lBJJ67iO017609@sheep.berlios.de>

Author: timm
Date: 2007-12-19 20:06:01 +0100 (Wed, 19 Dec 2007)
New Revision: 4032

Modified:
   rl/trunk/engine/common/include/XmlProcessor.h
   rl/trunk/engine/common/src/XmlProcessor.cpp
   rl/trunk/engine/common/src/XmlPropertyWriter.cpp
   rl/trunk/engine/core/include/SaveGameManager.h
   rl/trunk/engine/core/src/SaveGameManager.cpp
   rl/trunk/engine/ui/include/MainMenuLoadWindow.h
   rl/trunk/engine/ui/src/GameSaveLoadWindow.cpp
   rl/trunk/engine/ui/src/MainMenuLoadWindow.cpp
Log:
- added AttributeValueAsQuaternion reading/writing functions
- fixed writing quaternions
- changed layout of MainMenuLoadWindow

Modified: rl/trunk/engine/common/include/XmlProcessor.h
===================================================================
--- rl/trunk/engine/common/include/XmlProcessor.h	2007-12-19 19:02:21 UTC (rev 4031)
+++ rl/trunk/engine/common/include/XmlProcessor.h	2007-12-19 19:06:01 UTC (rev 4032)
@@ -313,7 +313,7 @@
 	 *
 	 * @param element Das DOM-Element
 	 * @param name Name des Attributes
-     * @return Zahlendubel des Attributes
+     * @return Zahlentripel des Attributes
 	 */
     Tripel<int> getAttributeValueAsIntegerTriple(XERCES_CPP_NAMESPACE::DOMElement* element, const char* const name) const;
 	
@@ -330,13 +330,33 @@
 
     /**
 	 * Ermittelt den Text eines DOMElement-Attributes und parst ihn, 
-	 * um eine Ganzzahltripel daraus zu machen
+	 * um ein Vector3 daraus zu machen
 	 *
 	 * @param element Das DOM-Element
 	 * @param name Name des Attributes
-     * @return Zahlendubel des Attributes
+     * @return Vector3 des Attributes
 	 */
     Ogre::Vector3 getAttributeValueAsVector3(XERCES_CPP_NAMESPACE::DOMElement* element, const char* const name) const;
+
+    /**
+	 * Wandelt eine Quaternion in einen Text um und setzt diesen als Attribut 
+	 *
+	 * @param element Das DOM-Element
+	 * @param name Name des Attributes
+     * @param value das zu setzende Quaternion
+	 * @return Das DOM-Element
+	 */
+    XERCES_CPP_NAMESPACE::DOMElement* setAttributeValueAsQuaternion(XERCES_CPP_NAMESPACE::DOMElement* element, const char* const name, Ogre::Quaternion value) const;
+
+    /**
+	 * Ermittelt den Text eines DOMElement-Attributes und parst ihn, 
+	 * um eine Quaternion daraus zu machen
+	 *
+	 * @param element Das DOM-Element
+	 * @param name Name des Attributes
+     * @return Quaternion des Attributes
+	 */
+    Ogre::Quaternion getAttributeValueAsQuaternion(XERCES_CPP_NAMESPACE::DOMElement* element, const char* const name) const;
     
 
     /**

Modified: rl/trunk/engine/common/src/XmlProcessor.cpp
===================================================================
--- rl/trunk/engine/common/src/XmlProcessor.cpp	2007-12-19 19:02:21 UTC (rev 4031)
+++ rl/trunk/engine/common/src/XmlProcessor.cpp	2007-12-19 19:06:01 UTC (rev 4032)
@@ -442,6 +442,59 @@
         getAttributeValueAsReal(element, "w"));
 }
 
+DOMElement* XmlProcessor::setAttributeValueAsQuaternion(DOMElement *element, const char* const name, Ogre::Quaternion value) const
+{
+    RlAssert(element != NULL, "XmlProcessor::setAttributeValueAsQuaternion: Element must not be NULL");
+	AutoXMLCh attrName(name);
+    CeGuiString temp = Ogre::StringConverter::toString(value.x) + "," + Ogre::StringConverter::toString(value.y) + "," + Ogre::StringConverter::toString(value.z) + "," + Ogre::StringConverter::toString(value.w);
+    element->setAttribute(attrName.data(), XMLString::transcode(temp.c_str()));
+
+    return element;
+}
+
+Ogre::Quaternion XmlProcessor::getAttributeValueAsQuaternion(DOMElement* element, const char* const name) const
+{
+    RlAssert(element != NULL, "XmlProcessor::getAttributeValueAsQuaternion: Element must not be NULL");
+	AutoXMLCh attrName(name);
+	const XMLCh* attribute = element->getAttribute(attrName.data());
+
+    CeGuiString value = transcodeToString(attribute);
+
+    CeGuiString::size_type comma1 = value.find(",");
+    CeGuiString::size_type comma2 = value.find(",", comma1 + 1);
+    CeGuiString::size_type comma3 = value.find(",", comma2 + 1);
+
+    Ogre::Quaternion quat(Ogre::Quaternion::IDENTITY);
+    if (comma1 != CeGuiString::npos 
+        && comma2 != CeGuiString::npos 
+        && comma3 != CeGuiString::npos)
+    {
+        quat.w = CEGUI::PropertyHelper::stringToFloat(value.substr(0, comma1));
+        quat.x = CEGUI::PropertyHelper::stringToFloat(value.substr(comma1 + 1, comma2 - comma1 - 1));
+        quat.y = CEGUI::PropertyHelper::stringToFloat(value.substr(comma2 + 1, comma3 - comma2 - 1));
+        quat.z = CEGUI::PropertyHelper::stringToFloat(value.substr(comma3 + 1));
+    }
+    else if (comma1 != CeGuiString::npos 
+        && comma2 != CeGuiString::npos 
+        && comma3 == CeGuiString::npos)
+    {
+        Quaternion rotX, rotY, rotZ;
+
+        rotX.FromAngleAxis(
+		    Ogre::Degree(CEGUI::PropertyHelper::stringToFloat(value.substr(0, comma1))), 
+		    Ogre::Vector3::UNIT_X);
+        rotY.FromAngleAxis(
+		    Ogre::Degree(CEGUI::PropertyHelper::stringToFloat(value.substr(comma1 + 1, comma2 - comma1 - 1))), 
+		    Ogre::Vector3::UNIT_Y);
+        rotZ.FromAngleAxis(
+		    Ogre::Degree(CEGUI::PropertyHelper::stringToFloat(value.substr(comma2 + 1))), 
+		    Ogre::Vector3::UNIT_Z);
+
+        quat = rotX * rotY * rotZ;
+    }
+    return quat;
+}
+
 utf8* XmlProcessor::transcodeToUtf8(const XMLCh* const string16) const
 {
 	unsigned int str16len = XMLString::stringLen(string16);

Modified: rl/trunk/engine/common/src/XmlPropertyWriter.cpp
===================================================================
--- rl/trunk/engine/common/src/XmlPropertyWriter.cpp	2007-12-19 19:02:21 UTC (rev 4031)
+++ rl/trunk/engine/common/src/XmlPropertyWriter.cpp	2007-12-19 19:06:01 UTC (rev 4032)
@@ -86,7 +86,7 @@
                 else if(entry.second.isIntTriple())
                     setAttributeValueAsIntegerTriple(element, "data", entry.second.toIntTriple());
                 else if(entry.second.isQuaternion())
-                    setValueAsQuaternion(element, entry.second.toQuaternion());
+                    setAttributeValueAsQuaternion(element, "data", entry.second.toQuaternion());
                 else if(entry.second.isReal())
                     setAttributeValueAsReal(element, "data", entry.second.toReal());
                 else if(entry.second.isString())

Modified: rl/trunk/engine/core/include/SaveGameManager.h
===================================================================
--- rl/trunk/engine/core/include/SaveGameManager.h	2007-12-19 19:02:21 UTC (rev 4031)
+++ rl/trunk/engine/core/include/SaveGameManager.h	2007-12-19 19:06:01 UTC (rev 4032)
@@ -74,7 +74,7 @@
         SaveGameEntryMap listSaveGames(void);
         SaveGameEntryMap listSaveGames(const CeGuiString &moduleName);
         void saveSaveGameFile(const CeGuiString &name);
-        void loadSaveGameFile(const CeGuiString &name);
+        void loadSaveGameFile(const CeGuiString &name, const CeGuiString& moduleID);
         void deleteSaveGameFile(const CeGuiString &name);
         bool SaveGameFileExists(const CeGuiString &name);
         SaveGameFile* getSaveGameFile(const CeGuiString &name);

Modified: rl/trunk/engine/core/src/SaveGameManager.cpp
===================================================================
--- rl/trunk/engine/core/src/SaveGameManager.cpp	2007-12-19 19:02:21 UTC (rev 4031)
+++ rl/trunk/engine/core/src/SaveGameManager.cpp	2007-12-19 19:06:01 UTC (rev 4032)
@@ -115,14 +115,14 @@
         MessagePump::getSingleton().sendMessage<MessageType_SaveGameSaved>();
     }
 
-    void SaveGameManager::loadSaveGameFile(const CeGuiString &name)
+    void SaveGameManager::loadSaveGameFile(const CeGuiString &name, const CeGuiString &moduleID)
     {
         if(SaveGameFileExists(name))
         {
             MessagePump::getSingleton().sendMessage<MessageType_SaveGameLoading>();
 
             SaveGameFile file(name);
-            file.setProperty(SaveGameFile::PROPERTY_MODULEID, Property(CoreSubsystem::getSingleton().getActiveAdventureModule()->getName()));
+            file.setProperty(SaveGameFile::PROPERTY_MODULEID, Property(moduleID));
             SaveGameFileReader reader;
             reader.parseSaveGameFile(&file, mSaveGameDataOrderMap);
             ///@todo: SaveGameReader

Modified: rl/trunk/engine/ui/include/MainMenuLoadWindow.h
===================================================================
--- rl/trunk/engine/ui/include/MainMenuLoadWindow.h	2007-12-19 19:02:21 UTC (rev 4031)
+++ rl/trunk/engine/ui/include/MainMenuLoadWindow.h	2007-12-19 19:06:01 UTC (rev 4032)
@@ -57,14 +57,12 @@
         
     private:
         bool handleLoadEvent();
-        bool handleSaveEvent();
         bool handleDeleteEvent();
         bool handleSelectSaveGame();
 
         void listSaveGames();
         
         CEGUI::MultiColumnList     *mSaveGameTable;     //!< SaveGame table
-        CEGUI::Editbox             *mFilename;         //!< Filename for the savegame 
     };
 }
 

Modified: rl/trunk/engine/ui/src/GameSaveLoadWindow.cpp
===================================================================
--- rl/trunk/engine/ui/src/GameSaveLoadWindow.cpp	2007-12-19 19:02:21 UTC (rev 4031)
+++ rl/trunk/engine/ui/src/GameSaveLoadWindow.cpp	2007-12-19 19:06:01 UTC (rev 4032)
@@ -118,7 +118,7 @@
         {
 
             if(SaveGameManager::getSingleton().SaveGameFileExists(filename))
-                SaveGameManager::getSingleton().loadSaveGameFile(filename);
+                SaveGameManager::getSingleton().loadSaveGameFile(filename, CoreSubsystem::getSingleton().getActiveAdventureModule()->getName());
             else
             {
                 LOG_ERROR(Logger::UI, "Save Game " + filename + " doesn't exist!");

Modified: rl/trunk/engine/ui/src/MainMenuLoadWindow.cpp
===================================================================
--- rl/trunk/engine/ui/src/MainMenuLoadWindow.cpp	2007-12-19 19:02:21 UTC (rev 4031)
+++ rl/trunk/engine/ui/src/MainMenuLoadWindow.cpp	2007-12-19 19:06:01 UTC (rev 4032)
@@ -47,12 +47,6 @@
     MainMenuLoadWindow::MainMenuLoadWindow() :
         AbstractWindow("mainmenuloadwindow.xml", WIT_MOUSE_INPUT | WIT_KEYBOARD_INPUT)
     {
-        // Get a access to the filename edit box
-        mFilename = getEditbox("MainMenuLoadWindow/FileSheet/Filename");
-        RlAssert(mFilename != NULL, "MainMenuLoadWindow/FileSheet/Filename is null");
-
-        mFilename->activate();
-
         // Get a access to the savegame table
         mSaveGameTable = getMultiColumnList("MainMenuLoadWindow/FileSheet/SaveGameTable");
         RlAssert(mSaveGameTable != NULL, "MainMenuLoadWindow/FileSheet/SaveGameTable is null");
@@ -61,7 +55,7 @@
         mSaveGameTable->addColumn( (utf8*)"Module", 1, cegui_reldim(0.2));
         mSaveGameTable->addColumn( (utf8*)"Date", 2, cegui_reldim(0.2));
 
-        mSaveGameTable->setSelectionMode(MultiColumnList::RowSingle);
+        mSaveGameTable->setSelectionMode(MultiColumnList::NominatedRowSingle);
         mSaveGameTable->subscribeEvent(MultiColumnList::EventSelectionChanged, boost::bind(&MainMenuLoadWindow::handleSelectSaveGame, this));
 
         centerWindow();
@@ -73,13 +67,6 @@
             this
         ));
 
-        getPushButton("MainMenuLoadWindow/ButtonSheet/SaveButton")->subscribeEvent(
-        CEGUI::Window::EventMouseClick,
-        boost::bind(
-            &MainMenuLoadWindow::handleSaveEvent,
-            this
-        ));
-
         getPushButton("MainMenuLoadWindow/ButtonSheet/DeleteButton")->subscribeEvent(
         CEGUI::Window::EventMouseClick,
         boost::bind(
@@ -113,59 +100,15 @@
     {
         LOG_MESSAGE(Logger::UI, "Load Button pressed");
 
-        CeGuiString filename = mFilename->getText();
-
-        if(filename != "")
-        {
-
-            if(SaveGameManager::getSingleton().SaveGameFileExists(filename))
-                SaveGameManager::getSingleton().loadSaveGameFile(filename);
-            else
-            {
-                LOG_ERROR(Logger::UI, "Save Game " + filename + " doesn't exist!");
-                WindowFactory::getSingleton().showMessageWindow("Der Spielstand existiert nicht");
-            }
-        }
-
         return true;
     }
 
-    //------------------------------------------------------- SaveEvent
-
-    bool MainMenuLoadWindow::handleSaveEvent()
-    {
-        LOG_MESSAGE(Logger::UI, "Save Button pressed");
-
-        CeGuiString filename = mFilename->getText();
-
-        if(filename != "")
-        {
-            LOG_MESSAGE(Logger::UI, "Create a SaveGameFile");
-
-            SaveGameManager::getSingleton().saveSaveGameFile(filename);
-
-            LOG_MESSAGE(Logger::UI, "Created save game");
-        }
-        else
-        {
-            WindowFactory::getSingleton().showMessageWindow("Bitte einen Namen f?r den Spielstand eingeben");
-        }
-
-        listSaveGames();
-
-        return true;
-    }
-
     //------------------------------------------------------- DeleteEvent
 
     bool MainMenuLoadWindow::handleDeleteEvent()
     {
         LOG_MESSAGE(Logger::UI, "Delete Button pressed");
-        if(SaveGameManager::getSingleton().SaveGameFileExists(mFilename->getText()))
-        {
-            SaveGameManager::getSingleton().deleteSaveGameFile(mFilename->getText());
-            listSaveGames();
-        }
+
         return true;
     }
 
@@ -195,8 +138,9 @@
 
     bool MainMenuLoadWindow::handleSelectSaveGame()
     {
-        if(mSaveGameTable->getFirstSelectedItem())
-            mFilename->setText(mSaveGameTable->getFirstSelectedItem()->getText());
+        mSaveGameTable->getFirstSelectedItem()->setSelectionColours(CEGUI::colour(0.0f,0.0f,1.0f));
+        /*if(mSaveGameTable->getFirstSelectedItem())
+            mFilename->setText(mSaveGameTable->getFirstSelectedItem()->getText());*/
         return true;
     }
 



From melven at mail.berlios.de  Wed Dec 19 20:32:00 2007
From: melven at mail.berlios.de (melven at mail.berlios.de)
Date: Wed, 19 Dec 2007 20:32:00 +0100
Subject: [Dsa-hl-svn] r4033 - in modules/common/scripts: . triggers
Message-ID: <200712191932.lBJJW07b018676@sheep.berlios.de>

Author: melven
Date: 2007-12-19 20:31:48 +0100 (Wed, 19 Dec 2007)
New Revision: 4033

Modified:
   modules/common/scripts/areahelper.rb
   modules/common/scripts/triggers/limitedtimestrigger.rb
Log:
_Create*Trigger now uses a string as argument instead of a Proc, because procs cannot be serialized. So the code can now be saved and loaded

Modified: modules/common/scripts/areahelper.rb
===================================================================
--- modules/common/scripts/areahelper.rb	2007-12-19 19:06:01 UTC (rev 4032)
+++ modules/common/scripts/areahelper.rb	2007-12-19 19:31:48 UTC (rev 4033)
@@ -1,7 +1,9 @@
 require "triggers/limitedtimestrigger.rb"
 
 # creates a zone with a trigger, that is destroyed if actived 'times' of times
-# Example: _CreateLimitedTimesTrigger("uniquename", PhysicsManager::GT_SPHERE, [-20,0,5], [1,0,0,0], [2,2,2], 5, Proc.new{print "entered"}, Proc.new{print "left"})
+# Example: _CreateLimitedTimesTrigger("uniquename", PhysicsManager::GT_SPHERE, [-20,0,5], [1,0,0,0], [2,2,2], 5, %q{print "entered"}, %q{print "left"})
+# the enter- and leaveproc must be given as string, because there is no other way to serialize them if
+# the trigger will be saved
 def _CreateLimitedTimesTrigger(name, geom_type, pos, orientation, size, times, enter_proc, leave_proc = nil)
   unless ( ZoneManager.getSingleton().getZone("limitedTimesTriggerZone_" + name) == nil )
     raise ArgumentError, "A limitedTimesTrigger with name " + name + " already exists!", caller
@@ -13,8 +15,8 @@
     "limitedTimesTriggerZone_" + name, 
     size, geom_type, pos, [0,0,0], orientation, 0.2, RlScript::QUERYFLAG_PLAYER);
   trigger.setProperty("number", times);
-  trigger.setEnterCode( &enter_proc );
-  trigger.setLeaveCode( &leave_proc );
+  trigger.setEnterCode( enter_proc );
+  trigger.setLeaveCode( leave_proc );
   trigger.setProperty("zone", "limitedTimesTriggerZone_" + name )
   zone.addTrigger(trigger)
   return trigger

Modified: modules/common/scripts/triggers/limitedtimestrigger.rb
===================================================================
--- modules/common/scripts/triggers/limitedtimestrigger.rb	2007-12-19 19:06:01 UTC (rev 4032)
+++ modules/common/scripts/triggers/limitedtimestrigger.rb	2007-12-19 19:31:48 UTC (rev 4033)
@@ -1,5 +1,12 @@
 # this trigger is intended to be used by areahelper
 # a trigger, that saves an command the appropriate zone and deletes it when finished
+# 
+# In order to save the trigger, we need the code for enter- and leave-command to
+# be a string, because Proc's cannot be serialized
+# The string will be transformed to a Proc, so local variables etc can be used
+#
+# Example:
+# tr.setEnterCode( %q{ print "hello"} )
 class LimitedTimesTrigger < Trigger
   def initialize(classname, name)
     super(classname, name, true);
@@ -7,12 +14,24 @@
     @_prop_leave_command = nil;
     @_prop_zone = "";
     @_prop_number = 0; # 0 infty, -1 once, -2 deactivated
+    @_prop_enter_command_string = nil;
+    @_prop_leave_command_string = nil;
   end
-  def setEnterCode(&code)
-    @_prop_enter_command = code
+  def setEnterCode(code)
+    if( code == nil )
+      @_prop_enter_command = nil
+    else	
+      @_prop_enter_command_string = code
+    end
+    @_prop_enter_command = eval "Proc.new{ #{code} }"
   end
-  def setLeaveCode(&code)
-    @_prop_leave_command = code
+  def setLeaveCode(code)
+    if( code == nil )
+      @_prop_leave_command = nil
+    else
+      @_prop_leave_command_string = code
+    end
+    @_prop_leave_command = eval "Proc.new{ #{code} }"
   end
 
   def activate()
@@ -58,7 +77,11 @@
     if (name == "number")
       @_prop_number = value;
     elsif (name == "zone")
-      @_prop_zone = value
+      @_prop_zone = value;
+    elsif (name == "enter_code")
+      setEnterCode(value);
+    elsif (name = "leave_code")
+      setLeaveCode(value);
     else
       super(name, value)
     end
@@ -68,6 +91,10 @@
       return @_prop_zone
     elsif (name == "number")
       return @_prop_number
+    elsif (name == "enter_code")
+      return @_prop_enter_command_string
+    elsif (name == "leave_code")
+      return @_prop_leave_command_string
     else
       super(name)
     end
@@ -76,6 +103,8 @@
     ps = super();
     ps.setProperty("zone", @_prop_zone)
     ps.setProperty("number", @_prop_number)
+    ps.setProperty("enter_code", @_prop_enter_command_string)
+    ps.setProperty("leave_code", @_prop_leave_command_string)
     return ps
   end
 end



From melven at mail.berlios.de  Wed Dec 19 22:47:48 2007
From: melven at mail.berlios.de (melven at mail.berlios.de)
Date: Wed, 19 Dec 2007 22:47:48 +0100
Subject: [Dsa-hl-svn] r4034 - in rl/trunk/engine: rules/src ui/src
Message-ID: <200712192147.lBJLlmPK024658@sheep.berlios.de>

Author: melven
Date: 2007-12-19 22:47:41 +0100 (Wed, 19 Dec 2007)
New Revision: 4034

Modified:
   rl/trunk/engine/rules/src/CreatureController.cpp
   rl/trunk/engine/ui/src/MovementControlState.cpp
Log:
enable char to move forward/backward while jumping (Hochsprung)

Modified: rl/trunk/engine/rules/src/CreatureController.cpp
===================================================================
--- rl/trunk/engine/rules/src/CreatureController.cpp	2007-12-19 19:31:48 UTC (rev 4033)
+++ rl/trunk/engine/rules/src/CreatureController.cpp	2007-12-19 21:47:41 UTC (rev 4034)
@@ -753,7 +753,7 @@
     class Hochsprung : public AbstractMovement
     {
     public:
-        Hochsprung(CreatureController *creature) : AbstractMovement(creature), mState(DOWN), mHeight(0), mJumpNow(false), mTimer(0) {}
+        Hochsprung(CreatureController *creature) : AbstractMovement(creature), mState(DOWN), mHeight(0), mJumpNow(false), mTimer(0), mMoveForward(0) {}
         virtual CreatureController::MovementType getId() const {return CreatureController::MT_HOCHSPRUNG;}
         virtual CreatureController::MovementType getFallBackMovement() const {return CreatureController::MT_STEHEN;}
         virtual void activate()
@@ -843,12 +843,34 @@
                     0);
                 mMovingCreature->setAbstractLocation( CreatureController::AL_AIRBORNE );
             }
+            else if (mState == UP && mMoveForward != 0) // try to move forward, if wanted
+            {
+                // low velocity towards this direction
+                if(mMoveForward > 0)
+                    mMoveForward = 1.0;
+                else
+                    mMoveForward = -1.0;
 
+
+
+                Real mass;
+                Vector3 inertia;
+                OgreNewt::Body *body = mMovingCreature->getCreature()->getActor()->getPhysicalThing()->_getBody();
+                body->getMassMatrix(mass, inertia);
+
+                Vector3 vel = mMovingCreature->getVelocity();
+                Real delay = 0.05;//(2 * PhysicsManager::getSingleton().getMaxTimestep());
+                Real diff = (mMoveForward - vel.z);
+                force.z += mass * diff / delay;
+            }
+
             Vector3 omega = mMovingCreature->getCreature()->getActor()->getPhysicalThing()->_getBody()->getOmega();
             torque = -omega / PhysicsManager::getSingleton().getMaxTimestep() * 2 * mass;
         }
         virtual bool run(Ogre::Real elapsedTime,  Ogre::Vector3 direction, Ogre::Vector3 rotation)
         {
+            mMoveForward = direction.z;
+
             if( mState == DOWN )
             {
                 mMovingCreature->setMovement(CreatureController::MT_STEHEN, direction, rotation);
@@ -892,10 +914,10 @@
         virtual bool isDirectionPossible(Ogre::Vector3 &direction) const
         {
             Vector3 oldDirection(direction);
-            direction.z = direction.x = 0;
+            direction.x = 0;
             if(direction.y < 0)
                 direction.y = 0;
-            return oldDirection.x == 0 && oldDirection.z == 0 && oldDirection.y > 0;
+            return oldDirection.x == 0 && oldDirection.y > 0;
         }
         virtual bool isRotationPossible(Ogre::Vector3 &rotation) const
         {
@@ -911,6 +933,7 @@
         Ogre::Real mHeight;
         bool mJumpNow;
         Ogre::Real mTimer;
+        Ogre::Real mMoveForward;
     };
 
 
@@ -1088,7 +1111,7 @@
             if( mState == UP )
             {
                 mTimer += elapsedTime;
-                if( mTimer < 0.5f )
+                if( mTimer < 0.1f )
                 {
                     mMovingCreature->setAbstractLocation( CreatureController::AL_AIRBORNE );
                 }

Modified: rl/trunk/engine/ui/src/MovementControlState.cpp
===================================================================
--- rl/trunk/engine/ui/src/MovementControlState.cpp	2007-12-19 19:31:48 UTC (rev 4033)
+++ rl/trunk/engine/ui/src/MovementControlState.cpp	2007-12-19 21:47:41 UTC (rev 4034)
@@ -369,8 +369,22 @@
 
             if( mViewMode != VM_PNYX_MODE )
             {
-                if( movement & MOVE_SNEAK )
+                if( mController->getMovementId() == CreatureController::MT_HOCHSPRUNG )
                 {
+                    // move forward or backward if wanted
+                    Vector3 direction = Vector3::UNIT_Y;
+                    if( movement & MOVE_FORWARD )
+                        direction += Vector3::NEGATIVE_UNIT_Z;
+                    else if( movement & MOVE_BACKWARD )
+                        direction += Vector3::UNIT_Z;
+
+                    mController->setMovement(
+                        CreatureController::MT_HOCHSPRUNG,
+                        direction,
+                        Vector3(0, rotation.valueRadians(), 0) );
+                }
+                else if( movement & MOVE_SNEAK )
+                {
                     Vector3 direction(Vector3::ZERO);
                     if (movement & MOVE_FORWARD)
                         direction.z = -1;



From timm at mail.berlios.de  Wed Dec 19 23:16:32 2007
From: timm at mail.berlios.de (timm at mail.berlios.de)
Date: Wed, 19 Dec 2007 23:16:32 +0100
Subject: [Dsa-hl-svn] r4035 - in rl/trunk/engine: common/src ui/src
Message-ID: <200712192216.lBJMGWhU026323@sheep.berlios.de>

Author: timm
Date: 2007-12-19 23:16:21 +0100 (Wed, 19 Dec 2007)
New Revision: 4035

Modified:
   rl/trunk/engine/common/src/XmlProcessor.cpp
   rl/trunk/engine/ui/src/MainMenuLoadWindow.cpp
Log:
restoring rotation of game objects should work now

Modified: rl/trunk/engine/common/src/XmlProcessor.cpp
===================================================================
--- rl/trunk/engine/common/src/XmlProcessor.cpp	2007-12-19 21:47:41 UTC (rev 4034)
+++ rl/trunk/engine/common/src/XmlProcessor.cpp	2007-12-19 22:16:21 UTC (rev 4035)
@@ -446,7 +446,7 @@
 {
     RlAssert(element != NULL, "XmlProcessor::setAttributeValueAsQuaternion: Element must not be NULL");
 	AutoXMLCh attrName(name);
-    CeGuiString temp = Ogre::StringConverter::toString(value.x) + "," + Ogre::StringConverter::toString(value.y) + "," + Ogre::StringConverter::toString(value.z) + "," + Ogre::StringConverter::toString(value.w);
+    CeGuiString temp = Ogre::StringConverter::toString(value.w) + "," + Ogre::StringConverter::toString(value.x) + "," + Ogre::StringConverter::toString(value.y) + "," + Ogre::StringConverter::toString(value.z);
     element->setAttribute(attrName.data(), XMLString::transcode(temp.c_str()));
 
     return element;

Modified: rl/trunk/engine/ui/src/MainMenuLoadWindow.cpp
===================================================================
--- rl/trunk/engine/ui/src/MainMenuLoadWindow.cpp	2007-12-19 21:47:41 UTC (rev 4034)
+++ rl/trunk/engine/ui/src/MainMenuLoadWindow.cpp	2007-12-19 22:16:21 UTC (rev 4035)
@@ -55,7 +55,7 @@
         mSaveGameTable->addColumn( (utf8*)"Module", 1, cegui_reldim(0.2));
         mSaveGameTable->addColumn( (utf8*)"Date", 2, cegui_reldim(0.2));
 
-        mSaveGameTable->setSelectionMode(MultiColumnList::NominatedRowSingle);
+        mSaveGameTable->setSelectionMode(MultiColumnList::RowSingle);
         mSaveGameTable->subscribeEvent(MultiColumnList::EventSelectionChanged, boost::bind(&MainMenuLoadWindow::handleSelectSaveGame, this));
 
         centerWindow();



From timm at mail.berlios.de  Wed Dec 19 23:58:50 2007
From: timm at mail.berlios.de (timm at mail.berlios.de)
Date: Wed, 19 Dec 2007 23:58:50 +0100
Subject: [Dsa-hl-svn] r4036 - in rl/trunk/engine/ui: include src
Message-ID: <200712192258.lBJMwodJ029199@sheep.berlios.de>

Author: timm
Date: 2007-12-19 23:58:43 +0100 (Wed, 19 Dec 2007)
New Revision: 4036

Modified:
   rl/trunk/engine/ui/include/MovementControlState.h
   rl/trunk/engine/ui/src/MovementControlState.cpp
Log:
fixed crash because of using setHighlighted(false) on a game object which doesn't exist anymore

Modified: rl/trunk/engine/ui/include/MovementControlState.h
===================================================================
--- rl/trunk/engine/ui/include/MovementControlState.h	2007-12-19 22:16:21 UTC (rev 4035)
+++ rl/trunk/engine/ui/include/MovementControlState.h	2007-12-19 22:58:43 UTC (rev 4036)
@@ -84,6 +84,7 @@
         virtual void updatePrimitive();
 
         bool updateAfterGameObjectLoading();
+        bool beforeLoadingSaveGame();
 
     protected:
         virtual void doCreatePrimitive();
@@ -178,6 +179,7 @@
         Ogre::Vector3 calculateOptimalCameraPosition(bool SlowlyMoveBackward, const Ogre::Real &timestep);
 
         MessagePump::ScopedConnection mMessageType_GameObjectsLoaded_Handler;
+        MessagePump::ScopedConnection mMessageType_SaveGameLoading_Handler;
     };
 }
 #endif

Modified: rl/trunk/engine/ui/src/MovementControlState.cpp
===================================================================
--- rl/trunk/engine/ui/src/MovementControlState.cpp	2007-12-19 22:16:21 UTC (rev 4035)
+++ rl/trunk/engine/ui/src/MovementControlState.cpp	2007-12-19 22:58:43 UTC (rev 4036)
@@ -139,7 +139,10 @@
         mSelector.setFilter(new InSceneSelectionFilter());
 
         mMessageType_GameObjectsLoaded_Handler = MessagePump::getSingleton().addMessageHandler<MessageType_GameObjectsLoaded>(
-                boost::bind(&MovementControlState::updateAfterGameObjectLoading, this));
+            boost::bind(&MovementControlState::updateAfterGameObjectLoading, this));
+
+        mMessageType_SaveGameLoading_Handler = MessagePump::getSingleton().addMessageHandler<MessageType_SaveGameLoading>(
+            boost::bind(&MovementControlState::beforeLoadingSaveGame, this));
     }
 
     //------------------------------------------------------------------------
@@ -1422,4 +1425,11 @@
 
         return false;
     }
+
+    bool MovementControlState::beforeLoadingSaveGame()  //unhighlight selected go
+    {
+        if(mSelector.getFirstSelectedObject())
+            mSelector.getFirstSelectedObject()->setHighlighted(false);
+        return false;
+    }
 }



From timm at mail.berlios.de  Thu Dec 20 23:46:02 2007
From: timm at mail.berlios.de (timm at mail.berlios.de)
Date: Thu, 20 Dec 2007 23:46:02 +0100
Subject: [Dsa-hl-svn] r4037 - in rl/trunk/engine: core/src ui/src
Message-ID: <200712202246.lBKMk2Ak012859@sheep.berlios.de>

Author: timm
Date: 2007-12-20 23:45:55 +0100 (Thu, 20 Dec 2007)
New Revision: 4037

Modified:
   rl/trunk/engine/core/src/Actor.cpp
   rl/trunk/engine/ui/src/MovementControlState.cpp
Log:
- control of the character works after loading
- restoring the orientation doesn't work really :(

Modified: rl/trunk/engine/core/src/Actor.cpp
===================================================================
--- rl/trunk/engine/core/src/Actor.cpp	2007-12-19 22:58:43 UTC (rev 4036)
+++ rl/trunk/engine/core/src/Actor.cpp	2007-12-20 22:45:55 UTC (rev 4037)
@@ -387,7 +387,9 @@
     {
         SceneManager* mgr =
             CoreSubsystem::getSingletonPtr()->getWorld()->getSceneManager();
-        placeIntoNode( mgr->getRootSceneNode(), position, orientation, physicsBone );
+        // Placing the actor a a little bit higher in the scene. The actor will fall onto ground.
+        // Avoiding problems with the physics, because the character the creature is transfixed to ground
+        placeIntoNode( mgr->getRootSceneNode(), position+Ogre::Vector3(0.0f,0.1f,0.0f), orientation, physicsBone );
     }
 
     void Actor::placeIntoNode(

Modified: rl/trunk/engine/ui/src/MovementControlState.cpp
===================================================================
--- rl/trunk/engine/ui/src/MovementControlState.cpp	2007-12-19 22:58:43 UTC (rev 4036)
+++ rl/trunk/engine/ui/src/MovementControlState.cpp	2007-12-20 22:45:55 UTC (rev 4037)
@@ -1413,15 +1413,16 @@
 
     bool MovementControlState::updateAfterGameObjectLoading()
     {
-        // We want to check for visibility from char's POV.
-        mSelector.setCheckVisibility(true, GameObjectManager::getSingleton().getGameObject(mCharacterId));
-        mSelector.track(mCharacter);
-        mSelector.setRadius(3.0);
+        resume(); //saving/loading only possible in movement state
+        //// We want to check for visibility from char's POV.
+        //mSelector.setCheckVisibility(true, GameObjectManager::getSingleton().getGameObject(mCharacterId));
+        //mSelector.track(mCharacter);
+        //mSelector.setRadius(3.0);
 
-        // Same for combat selector
-        mCombatSelector.setCheckVisibility(true, GameObjectManager::getSingleton().getGameObject(mCharacterId));
-        mCombatSelector.track(mCharacter);
-        mCombatSelector.setRadius(10.0);
+        //// Same for combat selector
+        //mCombatSelector.setCheckVisibility(true, GameObjectManager::getSingleton().getGameObject(mCharacterId));
+        //mCombatSelector.track(mCharacter);
+        //mCombatSelector.setRadius(10.0);
 
         return false;
     }
@@ -1429,7 +1430,12 @@
     bool MovementControlState::beforeLoadingSaveGame()  //unhighlight selected go
     {
         if(mSelector.getFirstSelectedObject())
+        {
             mSelector.getFirstSelectedObject()->setHighlighted(false);
+        }
+
+        pause(); //saving/loading only possible in movement state
+
         return false;
     }
 }



From timm at mail.berlios.de  Thu Dec 20 23:59:01 2007
From: timm at mail.berlios.de (timm at mail.berlios.de)
Date: Thu, 20 Dec 2007 23:59:01 +0100
Subject: [Dsa-hl-svn] r4038 - in rl/trunk/engine: core/src rules/src
Message-ID: <200712202259.lBKMx1Hb013565@sheep.berlios.de>

Author: timm
Date: 2007-12-20 23:58:52 +0100 (Thu, 20 Dec 2007)
New Revision: 4038

Modified:
   rl/trunk/engine/core/src/Actor.cpp
   rl/trunk/engine/rules/src/GameObjectManager.cpp
Log:
moved some code from Actor to GameObjectManager

Modified: rl/trunk/engine/core/src/Actor.cpp
===================================================================
--- rl/trunk/engine/core/src/Actor.cpp	2007-12-20 22:45:55 UTC (rev 4037)
+++ rl/trunk/engine/core/src/Actor.cpp	2007-12-20 22:58:52 UTC (rev 4038)
@@ -387,9 +387,7 @@
     {
         SceneManager* mgr =
             CoreSubsystem::getSingletonPtr()->getWorld()->getSceneManager();
-        // Placing the actor a a little bit higher in the scene. The actor will fall onto ground.
-        // Avoiding problems with the physics, because the character the creature is transfixed to ground
-        placeIntoNode( mgr->getRootSceneNode(), position+Ogre::Vector3(0.0f,0.1f,0.0f), orientation, physicsBone );
+        placeIntoNode( mgr->getRootSceneNode(), position, orientation, physicsBone );
     }
 
     void Actor::placeIntoNode(

Modified: rl/trunk/engine/rules/src/GameObjectManager.cpp
===================================================================
--- rl/trunk/engine/rules/src/GameObjectManager.cpp	2007-12-20 22:45:55 UTC (rev 4037)
+++ rl/trunk/engine/rules/src/GameObjectManager.cpp	2007-12-20 22:58:52 UTC (rev 4038)
@@ -345,7 +345,11 @@
                         PropertyRecord properties = reader->getPropertiesAsRecord(static_cast<DOMElement*>(xmlGameObject));
                         GameObject* object = createGameObject(classID, ID);
                         
-                        applyProperties(object, &properties); 
+                        applyProperties(object, &properties);
+                        // Placing the actor a a little bit higher in the scene. The actor will fall onto ground.
+                        // Avoiding problems with the physics, because the character the creature is transfixed to ground
+                        object->setProperty(GameObject::PROPERTY_POSITION, 
+                            Property(object->getProperty(GameObject::PROPERTY_POSITION).toVector3() + Ogre::Vector3(0.0f,0.01f,0.0f)));
                         object->setState(state);
                     }
                 }



