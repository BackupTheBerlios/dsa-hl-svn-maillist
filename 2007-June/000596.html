<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Dsa-hl-svn] r3525 - in rl/trunk/engine: startup ui ui/include	ui/src
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/dsa-hl-svn/2007-June/index.html" >
   <LINK REL="made" HREF="mailto:dsa-hl-svn%40lists.berlios.de?Subject=Re%3A%20%5BDsa-hl-svn%5D%20r3525%20-%20in%20rl/trunk/engine%3A%20startup%20ui%20ui/include%0A%09ui/src&In-Reply-To=%3C200706082249.l58MnVXS025543%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000595.html">
   <LINK REL="Next"  HREF="000597.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Dsa-hl-svn] r3525 - in rl/trunk/engine: startup ui ui/include	ui/src</H1>
    <B>tanis at mail.berlios.de</B> 
    <A HREF="mailto:dsa-hl-svn%40lists.berlios.de?Subject=Re%3A%20%5BDsa-hl-svn%5D%20r3525%20-%20in%20rl/trunk/engine%3A%20startup%20ui%20ui/include%0A%09ui/src&In-Reply-To=%3C200706082249.l58MnVXS025543%40sheep.berlios.de%3E"
       TITLE="[Dsa-hl-svn] r3525 - in rl/trunk/engine: startup ui ui/include	ui/src">tanis at mail.berlios.de
       </A><BR>
    <I>Sat Jun  9 00:49:31 CEST 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="000595.html">[Dsa-hl-svn] r3524 - rl/trunk/engine/core
</A></li>
        <LI>Next message: <A HREF="000597.html">[Dsa-hl-svn] r3526 - modules/common/gui/windows
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#596">[ date ]</a>
              <a href="thread.html#596">[ thread ]</a>
              <a href="subject.html#596">[ subject ]</a>
              <a href="author.html#596">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: tanis
Date: 2007-06-09 00:47:58 +0200 (Sat, 09 Jun 2007)
New Revision: 3525

Added:
   rl/trunk/engine/ui/include/CombatWindow.h
   rl/trunk/engine/ui/src/CombatWindow.cpp
Modified:
   rl/trunk/engine/startup/RlStartup2005.vcproj
   rl/trunk/engine/ui/RlUI2005.vcproj
   rl/trunk/engine/ui/include/AbstractWindow.h
   rl/trunk/engine/ui/include/CharacterController.h
   rl/trunk/engine/ui/include/CombatCharacterController.h
   rl/trunk/engine/ui/include/CutsceneCharacterController.h
   rl/trunk/engine/ui/include/DialogCharacterController.h
   rl/trunk/engine/ui/include/FreeFlightCharacterController.h
   rl/trunk/engine/ui/include/InputManager.h
   rl/trunk/engine/ui/include/MovementCharacterController.h
   rl/trunk/engine/ui/include/WindowFactory.h
   rl/trunk/engine/ui/include/WindowManager.h
   rl/trunk/engine/ui/src/AboutWindow.cpp
   rl/trunk/engine/ui/src/AbstractWindow.cpp
   rl/trunk/engine/ui/src/ActionChoiceWindow.cpp
   rl/trunk/engine/ui/src/CharacterController.cpp
   rl/trunk/engine/ui/src/CharacterSheetWindow.cpp
   rl/trunk/engine/ui/src/CharacterStateWindow.cpp
   rl/trunk/engine/ui/src/CloseConfirmationWindow.cpp
   rl/trunk/engine/ui/src/CombatCharacterController.cpp
   rl/trunk/engine/ui/src/CommandMapper.cpp
   rl/trunk/engine/ui/src/Console.cpp
   rl/trunk/engine/ui/src/ContainerContentWindow.cpp
   rl/trunk/engine/ui/src/CutsceneCharacterController.cpp
   rl/trunk/engine/ui/src/DebugWindow.cpp
   rl/trunk/engine/ui/src/DialogCharacterController.cpp
   rl/trunk/engine/ui/src/DialogWindow.cpp
   rl/trunk/engine/ui/src/FreeFlightCharacterController.cpp
   rl/trunk/engine/ui/src/GameLoggerWindow.cpp
   rl/trunk/engine/ui/src/GameObjectInfoWindow.cpp
   rl/trunk/engine/ui/src/GameObjectPropsWindow.cpp
   rl/trunk/engine/ui/src/GameSettings.cpp
   rl/trunk/engine/ui/src/InGameMenuWindow.cpp
   rl/trunk/engine/ui/src/InfoPopup.cpp
   rl/trunk/engine/ui/src/InputManager.cpp
   rl/trunk/engine/ui/src/InventoryWindow.cpp
   rl/trunk/engine/ui/src/JournalWindow.cpp
   rl/trunk/engine/ui/src/LogWindow.cpp
   rl/trunk/engine/ui/src/MainMenuEngineWindow.cpp
   rl/trunk/engine/ui/src/MainMenuWindow.cpp
   rl/trunk/engine/ui/src/MessageWindow.cpp
   rl/trunk/engine/ui/src/MovementCharacterController.cpp
   rl/trunk/engine/ui/src/ObjectDescriptionWindow.cpp
   rl/trunk/engine/ui/src/PlaylistWindow.cpp
   rl/trunk/engine/ui/src/ProgressWindow.cpp
   rl/trunk/engine/ui/src/SaveLoadWindow.cpp
   rl/trunk/engine/ui/src/SoundConfig.cpp
   rl/trunk/engine/ui/src/SubtitleWindow.cpp
   rl/trunk/engine/ui/src/WindowFactory.cpp
   rl/trunk/engine/ui/src/WindowManager.cpp
Log:
Restructuring of input handling. InputManager doesn't preview input events anymore. Instead it only initialises and delegates input to the active control state, which handles all input now.
Specialised Control States handle the input they know about and deligate all other events back to the base class, which handles cegui and global game actions.
Now control states can decide for themself whether something is sent to cegui or handled inside the controller.

Modified: rl/trunk/engine/startup/RlStartup2005.vcproj
===================================================================
--- rl/trunk/engine/startup/RlStartup2005.vcproj	2007-06-08 11:41:47 UTC (rev 3524)
+++ rl/trunk/engine/startup/RlStartup2005.vcproj	2007-06-08 22:47:58 UTC (rev 3525)
@@ -41,7 +41,7 @@
 			&lt;Tool
 				Name=&quot;VCCLCompilerTool&quot;
 				Optimization=&quot;0&quot;
-				AdditionalIncludeDirectories=&quot;.\include;..\core\include;..\dialog\include;..\rules\include;..\ai\include;..\ui\include;..\common\include;..\script\include;..\..\dependencies\ogrenew\OgreMain\include;..\..\dependencies\cegui_mk2\include;&quot;..\..\dependencies\ruby\lib\ruby\1.8\i386-mswin32&quot;;..\..\dependencies\xerces\include;..\..\dependencies\boost\include;..\..\dependencies\OgreNewt\include\OgreNewt;..\..\dependencies\NewtonSDK\sdk;..\..\dependencies\ogrenew\dependencies\include&quot;
+				AdditionalIncludeDirectories=&quot;.\include;..\core\include;..\dialog\include;..\rules\include;..\ai\include;..\ui\include;..\common\include;..\script\include;..\..\dependencies\ogrenew\OgreMain\include;..\..\dependencies\cegui_mk2\include;&quot;..\..\dependencies\ruby\lib\ruby\1.8\i386-mswin32&quot;;..\..\dependencies\xerces\include;..\..\dependencies\boost\include;..\..\dependencies\OgreNewt\include\OgreNewt;..\..\dependencies\NewtonSDK\sdk;..\..\dependencies\ogrenew\dependencies\include;..\..\dependencies\ois\includes&quot;
 				PreprocessorDefinitions=&quot;WIN32;_DEBUG;_WINDOWS;_CRT_SECURE_NO_DEPRECATE&quot;
 				MinimalRebuild=&quot;true&quot;
 				BasicRuntimeChecks=&quot;3&quot;
@@ -131,7 +131,7 @@
 				Optimization=&quot;2&quot;
 				InlineFunctionExpansion=&quot;1&quot;
 				OmitFramePointers=&quot;true&quot;
-				AdditionalIncludeDirectories=&quot;.\include;..\core\include;..\dialog\include;..\rules\include;..\ai\include;..\ui\include;..\common\include;..\script\include;..\..\dependencies\ogrenew\OgreMain\include;..\..\dependencies\cegui_mk2\include;&quot;..\..\dependencies\ruby\lib\ruby\1.8\i386-mswin32&quot;;..\..\dependencies\xerces\include;..\..\dependencies\boost\include;..\..\dependencies\OgreNewt\include\OgreNewt;..\..\dependencies\NewtonSDK\sdk;..\..\dependencies\ogrenew\dependencies\include&quot;
+				AdditionalIncludeDirectories=&quot;.\include;..\core\include;..\dialog\include;..\rules\include;..\ai\include;..\ui\include;..\common\include;..\script\include;..\..\dependencies\ogrenew\OgreMain\include;..\..\dependencies\cegui_mk2\include;&quot;..\..\dependencies\ruby\lib\ruby\1.8\i386-mswin32&quot;;..\..\dependencies\xerces\include;..\..\dependencies\boost\include;..\..\dependencies\OgreNewt\include\OgreNewt;..\..\dependencies\NewtonSDK\sdk;..\..\dependencies\ogrenew\dependencies\include;..\..\dependencies\ois\includes&quot;
 				PreprocessorDefinitions=&quot;WIN32;NDEBUG;_WINDOWS;_CRT_SECURE_NO_DEPRECATE&quot;
 				StringPooling=&quot;true&quot;
 				RuntimeLibrary=&quot;2&quot;
@@ -217,7 +217,7 @@
 				Optimization=&quot;2&quot;
 				InlineFunctionExpansion=&quot;1&quot;
 				OmitFramePointers=&quot;true&quot;
-				AdditionalIncludeDirectories=&quot;.\include;..\core\include;..\dialog\include;..\rules\include;..\ai\include;..\ui\include;..\common\include;..\script\include;..\..\dependencies\ogrenew\OgreMain\include;..\..\dependencies\cegui_mk2\include;&quot;..\..\dependencies\ruby\lib\ruby\1.8\i386-mswin32&quot;;..\..\dependencies\xerces\include;..\..\dependencies\boost\include;..\..\dependencies\OgreNewt\include\OgreNewt;..\..\dependencies\NewtonSDK\sdk;..\..\dependencies\ogrenew\dependencies\include&quot;
+				AdditionalIncludeDirectories=&quot;.\include;..\core\include;..\dialog\include;..\rules\include;..\ai\include;..\ui\include;..\common\include;..\script\include;..\..\dependencies\ogrenew\OgreMain\include;..\..\dependencies\cegui_mk2\include;&quot;..\..\dependencies\ruby\lib\ruby\1.8\i386-mswin32&quot;;..\..\dependencies\xerces\include;..\..\dependencies\boost\include;..\..\dependencies\OgreNewt\include\OgreNewt;..\..\dependencies\NewtonSDK\sdk;..\..\dependencies\ogrenew\dependencies\include;..\..\dependencies\ois\includes&quot;
 				PreprocessorDefinitions=&quot;WIN32;NDEBUG;_WINDOWS;_CRT_SECURE_NO_DEPRECATE&quot;
 				StringPooling=&quot;true&quot;
 				RuntimeLibrary=&quot;2&quot;

Modified: rl/trunk/engine/ui/RlUI2005.vcproj
===================================================================
--- rl/trunk/engine/ui/RlUI2005.vcproj	2007-06-08 11:41:47 UTC (rev 3524)
+++ rl/trunk/engine/ui/RlUI2005.vcproj	2007-06-08 22:47:58 UTC (rev 3525)
@@ -425,6 +425,10 @@
 					&gt;
 				&lt;/File&gt;
 				&lt;File
+					RelativePath=&quot;.\include\CombatWindow.h&quot;
+					&gt;
+				&lt;/File&gt;
+				&lt;File
 					RelativePath=&quot;.\include\ConfigComponent.h&quot;
 					&gt;
 				&lt;/File&gt;
@@ -614,6 +618,10 @@
 					&gt;
 				&lt;/File&gt;
 				&lt;File
+					RelativePath=&quot;.\src\CombatWindow.cpp&quot;
+					&gt;
+				&lt;/File&gt;
+				&lt;File
 					RelativePath=&quot;.\src\ConfigComponent.cpp&quot;
 					&gt;
 				&lt;/File&gt;

Modified: rl/trunk/engine/ui/include/AbstractWindow.h
===================================================================
--- rl/trunk/engine/ui/include/AbstractWindow.h	2007-06-08 11:41:47 UTC (rev 3524)
+++ rl/trunk/engine/ui/include/AbstractWindow.h	2007-06-08 22:47:58 UTC (rev 3525)
@@ -43,13 +43,13 @@
 	{
 	public:
 
-		enum WindowType
+		enum WindowInputType
 		{
-			WND_SHOW,
-			WND_MOUSE_INPUT,
-			WND_KEYBOARD_INPUT,
-			WND_ALL_INPUT,
+			WIT_NONE = 0x00,
+			WIT_MOUSE_INPUT = 0x01,
+			WIT_KEYBOARD_INPUT = 0x02
 		};
+
 		virtual ~AbstractWindow();	
 
 		CEGUI::Window* getWindow();
@@ -72,7 +72,7 @@
 		static CEGUI::Window* loadWindow(const CeGuiString&amp; xmlfile);
 		static CEGUI::Window* getRoot();
 
-		WindowType getWindowType();
+		int getWindowInputType();
 
         virtual bool isVisible();
         virtual void setVisible(bool visible, bool destroyAfterHide = false);
@@ -88,7 +88,7 @@
 	protected:
 		AbstractWindow(
 			const CeGuiString&amp; xmlfile, 
-			WindowType type, 
+			int inputType, 
 			bool closeOnEscape = true,
 			bool modal = false);
 
@@ -112,7 +112,7 @@
 
 	private:
 		
-		WindowType mWindowType;
+		int mWindowInputType;
 		CeGuiString mNamePrefix;
 		CeGuiString mName;
 		bool mModal;

Modified: rl/trunk/engine/ui/include/CharacterController.h
===================================================================
--- rl/trunk/engine/ui/include/CharacterController.h	2007-06-08 11:41:47 UTC (rev 3524)
+++ rl/trunk/engine/ui/include/CharacterController.h	2007-06-08 22:47:58 UTC (rev 3525)
@@ -19,8 +19,12 @@
 
 #include &quot;UiPrerequisites.h&quot;
 #include &quot;GameTask.h&quot;
+
 #include &lt;OgreNewt.h&gt;
 
+#include &lt;OISMouse.h&gt;
+#include &lt;OISKeyboard.h&gt;
+
 namespace rl {
 
     class Actor;
@@ -31,7 +35,7 @@
     /**
      * This class handles character control via user input.
      */
-	class _RlUiExport CharacterController
+    class _RlUiExport CharacterController : public OIS::KeyListener, public OIS::MouseListener
     {
 	public:
 
@@ -39,7 +43,8 @@
          *  @throw NullPointerException if camera or character is NULL.
          *  @throw InvalidArgumentException if character is not placed in the scene.
          */
-        CharacterController(CommandMapper* commandMapper, Actor* camera, Person* character);
+        CharacterController(CommandMapper* commandMapper, Actor* camera, Person* character,
+            ControlStateType type);
 		virtual ~CharacterController()= 0;
 
         virtual void pause() = 0;
@@ -47,14 +52,24 @@
 
         virtual void run(Ogre::Real elapsedTime) = 0;
 
-		virtual bool injectMouseDown(int mouseButtonMask) { return false; }
-		virtual bool injectMouseUp(int mouseButtonMask) { return false; }
-		virtual bool injectKeyDown(int keycode) { return false; }
-		virtual bool injectKeyUp(int keycode) { return false; }	
+        virtual bool mousePressed(const OIS::MouseEvent&amp; evt, OIS::MouseButtonID id);
+        virtual bool mouseReleased(const OIS::MouseEvent&amp; evt, OIS::MouseButtonID id);
+        virtual bool mouseMoved(const OIS::MouseEvent&amp; evt);
+        virtual bool keyPressed(const OIS::KeyEvent&amp; evt);
+        virtual bool keyReleased(const OIS::KeyEvent&amp; evt);
 
 	protected:
 		static bool startAction(const CeGuiString&amp; actionName, Creature* character = NULL);
 
+        /// Returns true, if there is at least one window open,
+        /// that requires keyboard and/or mouse input. 
+        bool isCeguiActive() const;
+
+        /// Returns true, if the key event should be injected into CEGUI
+        /// This is the case, if an open window requests key input and it is
+        /// an input or navigation key.
+        bool CharacterController::sendKeyToCeGui(const OIS::KeyEvent&amp; evt) const;
+
         Person* mCharacter;
 
         Actor* mCameraActor;
@@ -64,6 +79,8 @@
         OgreNewt::Body* mCharBody;
 
 		CommandMapper* mCommandMapper;
+
+        ControlStateType mType;
     };
 }
 #endif

Modified: rl/trunk/engine/ui/include/CombatCharacterController.h
===================================================================
--- rl/trunk/engine/ui/include/CombatCharacterController.h	2007-06-08 11:41:47 UTC (rev 3524)
+++ rl/trunk/engine/ui/include/CombatCharacterController.h	2007-06-08 22:47:58 UTC (rev 3525)
@@ -24,8 +24,9 @@
 
 namespace rl {
 
-    class CombatManager;
     class Combat;
+    class CombatManager;
+    class CombatWindow;
 
 	class _RlUiExport CombatCharacterController : public CharacterController
 	{
@@ -41,15 +42,11 @@
 
 		void run(Ogre::Real elapsedTime);
 
-		virtual bool injectMouseDown(int mouseButtonMask);
-		virtual bool injectMouseUp(int mouseButtonMask);
-		virtual bool injectKeyDown(int keycode);
-		virtual bool injectKeyUp(int keycode);
-
     private:
         CombatManager* mCombatManager;
         // Current combat that is controlled.
         Combat* mCombat;
+        CombatWindow* mCombatWindow;
         HalfSphereSelector mEnemySelector;
 	};
 }

Added: rl/trunk/engine/ui/include/CombatWindow.h
===================================================================
--- rl/trunk/engine/ui/include/CombatWindow.h	2007-06-08 11:41:47 UTC (rev 3524)
+++ rl/trunk/engine/ui/include/CombatWindow.h	2007-06-08 22:47:58 UTC (rev 3525)
@@ -0,0 +1,32 @@
+/* This source file is part of Rastullahs Lockenpracht.
+ * Copyright (C) 2003-2007 Team Pantheon. <A HREF="http://www.team-pantheon.de">http://www.team-pantheon.de</A>
+ * 
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the Clarified Artistic License.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  Clarified Artistic License for more details.
+ *
+ *  You should have received a copy of the Clarified Artistic License
+ *  along with this program; if not you can get it here
+ *  <A HREF="http://www.jpaulmorrison.com/fbp/artistic2.htm.">http://www.jpaulmorrison.com/fbp/artistic2.htm.</A>
+ */
+
+#ifndef __CombatWindow_H__
+#define __CombatWindow_H__
+
+#include &quot;UiPrerequisites.h&quot;
+#include &quot;AbstractWindow.h&quot;
+
+namespace rl {
+	
+	class _RlUiExport CombatWindow : public AbstractWindow
+	{
+	public:
+		CombatWindow();
+	};
+}
+
+#endif

Modified: rl/trunk/engine/ui/include/CutsceneCharacterController.h
===================================================================
--- rl/trunk/engine/ui/include/CutsceneCharacterController.h	2007-06-08 11:41:47 UTC (rev 3524)
+++ rl/trunk/engine/ui/include/CutsceneCharacterController.h	2007-06-08 22:47:58 UTC (rev 3525)
@@ -41,8 +41,6 @@
         void setCameraPosition(const Ogre::Vector3&amp; pos);
         void setCameraOrientation(const Ogre::Quaternion&amp; orient);
         void lookAt(const Ogre::Vector3&amp; point);
-
-        virtual bool injectKeyUp(int keycode);
 	};
 }
 #endif

Modified: rl/trunk/engine/ui/include/DialogCharacterController.h
===================================================================
--- rl/trunk/engine/ui/include/DialogCharacterController.h	2007-06-08 11:41:47 UTC (rev 3524)
+++ rl/trunk/engine/ui/include/DialogCharacterController.h	2007-06-08 22:47:58 UTC (rev 3525)
@@ -61,13 +61,12 @@
 		void setDialogPartner(Actor* partner);
 
 		/// Antwort eines der Dialogf&#252;hrenden
-		void response(
-			Actor* actor, const CeGuiString&amp; text, const Ogre::String&amp; soundFile = &quot;&quot;);
+		void response(Actor* actor, const CeGuiString&amp; text, const Ogre::String&amp; soundFile = &quot;&quot;);
 
 		void setDialogWindow(DialogWindow* dialog);
 		void setSubtitleWindow(SubtitleWindow* subtitles);
 	
-		bool injectMouseUp(int mouseButtonMask);
+        virtual bool mouseReleased(const OIS::MouseEvent&amp; evt, OIS::MouseButtonID id);
 	private:
 		/// Die Zielkameraposition in lokalen Koordinaten
 		Ogre::Vector3 mTargetCameraPosition;

Modified: rl/trunk/engine/ui/include/FreeFlightCharacterController.h
===================================================================
--- rl/trunk/engine/ui/include/FreeFlightCharacterController.h	2007-06-08 11:41:47 UTC (rev 3524)
+++ rl/trunk/engine/ui/include/FreeFlightCharacterController.h	2007-06-08 22:47:58 UTC (rev 3525)
@@ -46,8 +46,8 @@
 
 		virtual void run(Ogre::Real elapsedTime);
 
-		bool injectKeyDown(int keycode);
-		bool injectKeyUp(int keycode);
+        virtual bool keyPressed(const OIS::KeyEvent&amp; evt);
+        virtual bool keyReleased(const OIS::KeyEvent&amp; evt);
 
 	    void toggleCameraCollision();
 	    void resetCamera();

Modified: rl/trunk/engine/ui/include/InputManager.h
===================================================================
--- rl/trunk/engine/ui/include/InputManager.h	2007-06-08 11:41:47 UTC (rev 3524)
+++ rl/trunk/engine/ui/include/InputManager.h	2007-06-08 22:47:58 UTC (rev 3525)
@@ -39,9 +39,7 @@
 
     class _RlUiExport InputManager
         :    public Ogre::Singleton&lt;InputManager&gt;,
-            public GameTask,
-            public OIS::KeyListener,
-            public OIS::MouseListener
+            public GameTask
     {
     public:
 
@@ -56,16 +54,6 @@
 
         void run(Ogre::Real elapsedTime);
 
-        void registerAbstractWindow(AbstractWindow* window);
-        void unregisterAbstractWindow(AbstractWindow* window);
-        bool isCeguiActive() const;
-
-        virtual bool mousePressed(const OIS::MouseEvent &amp; arg, OIS::MouseButtonID id);
-        virtual bool mouseReleased(const OIS::MouseEvent &amp; arg, OIS::MouseButtonID id);
-        virtual bool mouseMoved(const OIS::MouseEvent &amp;arg);
-        virtual bool keyPressed(const OIS::KeyEvent &amp;arg);
-        virtual bool keyReleased(const OIS::KeyEvent &amp;arg);
-
         CeGuiString getKeyName(int scancode, int syskeys);
         CeGuiString getKeyName(int combinedKeyCode);
         int getScanCode(const CeGuiString&amp; name);
@@ -92,14 +80,14 @@
 
         CharacterController* getCharacterController() const;
 
+        int getModifierCode() const;
+        const CEGUI::utf8&amp; getKeyChar(int keycode, int modifiers) const;
+
     private:
         enum { NUM_MOUSE_BUTTON=4, NUM_KEYS=256 };
         enum Modifiers {ALT_MASK = 1, CTRL_MASK = 2, SHIFT_MASK = 4, SUPER_MASK = 8};
 
         void initializeOis(Ogre::RenderWindow* wnd);
-        bool sendKeyToCeGui(const OIS::KeyEvent&amp; e) const;
-        int getModifierCode() const;
-        const CEGUI::utf8&amp; getKeyChar(int keycode, int modifiers) const;
 
         Ogre::Vector3 mSavedMouseState;
 
@@ -120,10 +108,6 @@
         typedef std::map&lt;int, CeGuiString&gt; KeyCommandMap;
         KeyCommandMap mKeyRubyCommand;
 
-        int mNumActiveWindowsMouseInput;
-        int mNumActiveWindowsKeyboardInput;
-        int mNumActiveWindowsAllInput;
-
         typedef std::stack&lt;CharacterController*&gt; ControlStateStack;
         typedef std::vector&lt;CharacterController*&gt; ControlStateVector;
         ControlStateStack mControlStates;

Modified: rl/trunk/engine/ui/include/MovementCharacterController.h
===================================================================
--- rl/trunk/engine/ui/include/MovementCharacterController.h	2007-06-08 11:41:47 UTC (rev 3524)
+++ rl/trunk/engine/ui/include/MovementCharacterController.h	2007-06-08 22:47:58 UTC (rev 3525)
@@ -75,10 +75,9 @@
         */
         void resetCamera();
 
-		virtual bool injectMouseDown(int mouseButtonMask);
-		virtual bool injectMouseUp(int mouseButtonMask);
-		virtual bool injectKeyDown(int keycode);
-		virtual bool injectKeyUp(int keycode);		
+        virtual bool mouseReleased(const OIS::MouseEvent&amp; evt, OIS::MouseButtonID id);
+        virtual bool keyPressed(const OIS::KeyEvent&amp; evt);
+        virtual bool keyReleased(const OIS::KeyEvent&amp; evt);
 
         // Overrides from DebugVisualisable
         virtual DebugVisualisableFlag getFlag() const;

Modified: rl/trunk/engine/ui/include/WindowFactory.h
===================================================================
--- rl/trunk/engine/ui/include/WindowFactory.h	2007-06-08 11:41:47 UTC (rev 3524)
+++ rl/trunk/engine/ui/include/WindowFactory.h	2007-06-08 22:47:58 UTC (rev 3525)
@@ -36,6 +36,7 @@
     class CharacterStateWindow;
     class CharacterSheetWindow;
     class CloseConfirmationWindow;
+    class CombatWindow;
     class Console;
     class Container;
     class Creature;
@@ -105,6 +106,7 @@
 
         DialogWindow* getDialogWindow();
         SubtitleWindow* getSubtitleWindow();
+        CombatWindow* getCombatWindow();
 
         void checkForErrors();
         GameLoggerWindow* getGameLogger();
@@ -139,6 +141,7 @@
         MainMenuWindow* mMainMenuWindow;
         CloseConfirmationWindow* mCloseConfirmationWindow;
         GameSettings* mGameSettings;
+        CombatWindow* mCombatWindow;
     };
 }
 

Modified: rl/trunk/engine/ui/include/WindowManager.h
===================================================================
--- rl/trunk/engine/ui/include/WindowManager.h	2007-06-08 11:41:47 UTC (rev 3524)
+++ rl/trunk/engine/ui/include/WindowManager.h	2007-06-08 22:47:58 UTC (rev 3525)
@@ -45,8 +45,17 @@
 		bool handleMovedToFront(AbstractWindow* window);
 		bool handleMovedToBack(AbstractWindow* window);
 
+        /// Returns the combined input mask of all open windows
+        int getWindowInputMask() const;
+
+        /// Callback for Windows, called when there visibility is changed.
+        void _visiblityChanged(AbstractWindow* window, bool isVisible);
+
 	private:
 		std::list&lt;AbstractWindow*&gt; mWindowList;
+
+        unsigned short mNumActiveWindowsMouseInput;
+        unsigned short mNumActiveWindowsKeyboardInput;
 	};
 }
 

Modified: rl/trunk/engine/ui/src/AboutWindow.cpp
===================================================================
--- rl/trunk/engine/ui/src/AboutWindow.cpp	2007-06-08 11:41:47 UTC (rev 3524)
+++ rl/trunk/engine/ui/src/AboutWindow.cpp	2007-06-08 22:47:58 UTC (rev 3525)
@@ -22,7 +22,7 @@
 namespace rl {
 
 AboutWindow::AboutWindow() :
-    AbstractWindow(&quot;aboutwindow.xml&quot;, WND_MOUSE_INPUT)
+    AbstractWindow(&quot;aboutwindow.xml&quot;, WIT_MOUSE_INPUT)
 {
     getWindow(&quot;AboutWindow/Text&quot;)-&gt;setText(&quot;Rastullahs Lockenpracht\n\nCopyright 2003-2007 Team Pantheon\
 \n\nBenutzte Bibliotheken: Ogre, fmod, Newton, boost, ...&quot;);

Modified: rl/trunk/engine/ui/src/AbstractWindow.cpp
===================================================================
--- rl/trunk/engine/ui/src/AbstractWindow.cpp	2007-06-08 11:41:47 UTC (rev 3524)
+++ rl/trunk/engine/ui/src/AbstractWindow.cpp	2007-06-08 22:47:58 UTC (rev 3525)
@@ -23,7 +23,6 @@
 #include &quot;UiSubsystem.h&quot;
 #include &quot;AbstractWindow.h&quot;
 #include &quot;CeGuiHelper.h&quot;
-#include &quot;InputManager.h&quot;
 #include &quot;WindowManager.h&quot;
 #include &quot;WindowFadeJob.h&quot;
 #include &quot;JobScheduler.h&quot;
@@ -37,10 +36,10 @@
 
 	int AbstractWindow::sNumAbstractWindows = 0;
 
-	AbstractWindow::AbstractWindow(const CeGuiString&amp; xmlfile, WindowType type, bool closeOnEscape, bool modal)
+	AbstractWindow::AbstractWindow(const CeGuiString&amp; xmlfile, int inputType, bool closeOnEscape, bool modal)
 	: mVisible(false),
 		mModal(modal),
-		mWindowType(type),
+		mWindowInputType(inputType),
 		mCloseOnEscape(closeOnEscape)
 	{
         LOG_MESSAGE(Logger::UI, 
@@ -117,18 +116,17 @@
 		{
 			if (visible)
 			{
-				InputManager::getSingleton().registerAbstractWindow(this);
                 JobScheduler::getSingleton().addJob(
                     new WindowFadeJob(this, WindowFadeJob::FADE_IN, mNormalAlpha));
 			}
 			else
 			{
-				InputManager::getSingleton().unregisterAbstractWindow(this);
                 JobScheduler::getSingleton().addJob(
                     new WindowFadeJob(this,
                     destroy ? WindowFadeJob::FADE_OUT_AND_DESTROY : WindowFadeJob::FADE_OUT,
                     0.0f));
 			}
+            WindowManager::getSingleton()._visiblityChanged(this, visible);
             mVisible = visible;
 		}
 	}
@@ -148,9 +146,9 @@
 		return mCloseOnEscape;
 	}
 
-	AbstractWindow::WindowType AbstractWindow::getWindowType()
+	int AbstractWindow::getWindowInputType()
 	{
-		return mWindowType;
+		return mWindowInputType;
 	}
 
 	CEGUI::Window* AbstractWindow::getRoot()

Modified: rl/trunk/engine/ui/src/ActionChoiceWindow.cpp
===================================================================
--- rl/trunk/engine/ui/src/ActionChoiceWindow.cpp	2007-06-08 11:41:47 UTC (rev 3524)
+++ rl/trunk/engine/ui/src/ActionChoiceWindow.cpp	2007-06-08 22:47:58 UTC (rev 3525)
@@ -38,7 +38,7 @@
 	const int MAX_NUM_SUBACTIONS = 7;
 
 	ActionChoiceWindow::ActionChoiceWindow(Person* actor)
-		:	AbstractWindow(&quot;actionchoicewindow.xml&quot;, WND_MOUSE_INPUT),
+		:	AbstractWindow(&quot;actionchoicewindow.xml&quot;, WIT_MOUSE_INPUT),
 			mActor(actor)
 	{
 		mHint = getWindow(&quot;ActionChoiceWindow/Hint&quot;);

Modified: rl/trunk/engine/ui/src/CharacterController.cpp
===================================================================
--- rl/trunk/engine/ui/src/CharacterController.cpp	2007-06-08 11:41:47 UTC (rev 3524)
+++ rl/trunk/engine/ui/src/CharacterController.cpp	2007-06-08 22:47:58 UTC (rev 3525)
@@ -17,15 +17,19 @@
 
 #include &lt;OgreSceneManager.h&gt;
 
+#include &quot;AbstractWindow.h&quot;
 #include &quot;Action.h&quot;
 #include &quot;ActionManager.h&quot;
 #include &quot;Actor.h&quot;
 #include &quot;CameraObject.h&quot;
+#include &quot;CommandMapper.h&quot;
 #include &quot;CoreSubsystem.h&quot;
 #include &quot;Creature.h&quot;
 #include &quot;Exception.h&quot;
+#include &quot;InputManager.h&quot;
 #include &quot;Person.h&quot;
 #include &quot;PhysicalThing.h&quot;
+#include &quot;WindowManager.h&quot;
 #include &quot;World.h&quot;
 
 using namespace Ogre;
@@ -33,13 +37,14 @@
 namespace rl {
 
 	CharacterController::CharacterController(CommandMapper* commandMapper,
-        Actor* camera, Person* character)
+        Actor* camera, Person* character, ControlStateType type)
 		: mCharacter(character),
         mCameraActor(camera),
 		mCharacterActor(NULL),
 		mCamBody(NULL),
 		mCharBody(NULL),
-        mCommandMapper(commandMapper)
+        mCommandMapper(commandMapper),
+        mType(type)
 	{
 		if (mCameraActor == NULL)
 		{
@@ -117,7 +122,125 @@
 			character-&gt;doAction(actionName, character, character);
 		}
 		return true;
+	}
 
-		return false;
-	}
+    bool CharacterController::mousePressed(const OIS::MouseEvent&amp; evt, OIS::MouseButtonID id)
+    {
+        if (WindowManager::getSingleton().getWindowInputMask() &amp; AbstractWindow::WIT_MOUSE_INPUT)
+        {
+            CEGUI::System::getSingleton().injectMouseButtonDown(
+                static_cast&lt;CEGUI::MouseButton&gt;(id));
+            return true;
+        }
+        else
+        {
+            return false;
+        }
+    }
+
+    bool CharacterController::mouseReleased(const OIS::MouseEvent&amp; evt, OIS::MouseButtonID id)
+    {
+        if (WindowManager::getSingleton().getWindowInputMask() &amp; AbstractWindow::WIT_MOUSE_INPUT)
+        {
+            CEGUI::System::getSingleton().injectMouseButtonUp(static_cast&lt;CEGUI::MouseButton&gt;(id));
+            return true;
+        }
+        else
+        {
+            return false;
+        }
+    }
+
+    bool CharacterController::mouseMoved(const OIS::MouseEvent&amp; evt)
+    {
+        if (WindowManager::getSingleton().getWindowInputMask() &amp; AbstractWindow::WIT_MOUSE_INPUT)
+        {
+            CEGUI::Renderer* renderer = CEGUI::System::getSingleton().getRenderer();
+            CEGUI::System::getSingleton().injectMouseMove(evt.state.X.rel, evt.state.Y.rel);
+            return true;
+        }
+        else
+        {
+            return false;
+        }
+    }
+
+    bool CharacterController::keyPressed(const OIS::KeyEvent&amp; evt)
+    {
+        InputManager* im = InputManager::getSingletonPtr();
+
+        if (sendKeyToCeGui(evt))
+        {
+            CEGUI::System&amp; cegui = CEGUI::System::getSingleton();
+            cegui.injectKeyUp(evt.key);
+            return true;
+        }
+        else
+        {
+            return false;
+        }
+    }
+
+    bool CharacterController::keyReleased(const OIS::KeyEvent&amp; evt)
+    {
+        InputManager* im = InputManager::getSingletonPtr();
+
+        if (sendKeyToCeGui(evt))
+        {
+            CEGUI::System&amp; cegui = CEGUI::System::getSingleton();
+            cegui.injectKeyDown(evt.key);
+            cegui.injectChar(im-&gt;getKeyChar(evt.key, im-&gt;getModifierCode()));
+            return true;
+        }
+        else
+        {
+            int code = CommandMapper::encodeKey(evt.key, im-&gt;getModifierCode());
+
+            // First see, if a control state action is defined
+		    CeGuiString action = mCommandMapper-&gt;getControlStateAction(code, mType);
+            if (action == &quot;&quot;)
+            {
+                // No. So try global actions.
+                action = mCommandMapper-&gt;getGlobalAction(code);
+            }
+            return startAction(action, mCharacter);
+        }
+    }
+
+    bool CharacterController::isCeguiActive() const
+    {
+        return WindowManager::getSingleton().getWindowInputMask() != 0;
+    }
+
+    bool CharacterController::sendKeyToCeGui(const OIS::KeyEvent&amp; evt) const
+    {
+        InputManager* im = InputManager::getSingletonPtr();
+
+        // Wenn kein Fenster mit Tastatureingabe aktiv ist, kriegt CEGUI keine KeyEvents
+        if ((WindowManager::getSingleton().getWindowInputMask()
+            &amp; AbstractWindow::WIT_KEYBOARD_INPUT) == 0)
+        {
+            return false;
+        }
+
+        // ---- Tastatureingabe gefordert ----
+
+        // Tasten, die Zeichen liefern sollen an CEGUI gesendet werden
+        if (im-&gt;getKeyChar(evt.key, im-&gt;getModifierCode()) != 0)
+        {
+            return true;
+        }
+
+        if (evt.key == OIS::KC_RETURN
+            || evt.key == OIS::KC_HOME || evt.key == OIS::KC_END
+            || evt.key == OIS::KC_LEFT || evt.key == OIS::KC_RIGHT
+            || evt.key == OIS::KC_BACK || evt.key == OIS::KC_DELETE
+            || evt.key == OIS::KC_UP   || evt.key == OIS::KC_DOWN
+            || evt.key == OIS::KC_RMENU)
+        {
+            return true;
+        }
+
+        return false;
+    }
 }

Modified: rl/trunk/engine/ui/src/CharacterSheetWindow.cpp
===================================================================
--- rl/trunk/engine/ui/src/CharacterSheetWindow.cpp	2007-06-08 11:41:47 UTC (rev 3524)
+++ rl/trunk/engine/ui/src/CharacterSheetWindow.cpp	2007-06-08 22:47:58 UTC (rev 3525)
@@ -33,7 +33,7 @@
 namespace rl {
 
 CharacterSheetWindow::CharacterSheetWindow()
-	: AbstractWindow(&quot;charactersheet.xml&quot;, WND_MOUSE_INPUT)
+	: AbstractWindow(&quot;charactersheet.xml&quot;, WIT_MOUSE_INPUT)
 {
 	mTalentTable = getMultiColumnList(&quot;CharacterSheet/TalentSheet/Table&quot;);
 	mTalentTable-&gt;addColumn((utf8*)&quot;Talent&quot;, 0, cegui_reldim(0.5));

Modified: rl/trunk/engine/ui/src/CharacterStateWindow.cpp
===================================================================
--- rl/trunk/engine/ui/src/CharacterStateWindow.cpp	2007-06-08 11:41:47 UTC (rev 3524)
+++ rl/trunk/engine/ui/src/CharacterStateWindow.cpp	2007-06-08 22:47:58 UTC (rev 3525)
@@ -30,7 +30,7 @@
 namespace rl {
 
 CharacterStateWindow::CharacterStateWindow()
-: AbstractWindow(&quot;characterstatewindow.xml&quot;, WND_SHOW, false),
+: AbstractWindow(&quot;characterstatewindow.xml&quot;, WIT_NONE, false),
 	mCharacter(NULL)
 {
 	mLP = getProgressBar(&quot;CharacterStateWindow/LP&quot;);

Modified: rl/trunk/engine/ui/src/CloseConfirmationWindow.cpp
===================================================================
--- rl/trunk/engine/ui/src/CloseConfirmationWindow.cpp	2007-06-08 11:41:47 UTC (rev 3524)
+++ rl/trunk/engine/ui/src/CloseConfirmationWindow.cpp	2007-06-08 22:47:58 UTC (rev 3525)
@@ -22,7 +22,7 @@
 namespace rl {
 
 CloseConfirmationWindow::CloseConfirmationWindow()
-: AbstractWindow(&quot;closeconfirmationwindow.xml&quot;, AbstractWindow::WND_ALL_INPUT, true, true)
+: AbstractWindow(&quot;closeconfirmationwindow.xml&quot;, WIT_MOUSE_INPUT | WIT_KEYBOARD_INPUT, true, true)
 {
 	getPushButton(&quot;CloseConfirmationWindow/YesButton&quot;)-&gt;subscribeEvent(
 		CEGUI::Window::EventMouseClick,

Modified: rl/trunk/engine/ui/src/CombatCharacterController.cpp
===================================================================
--- rl/trunk/engine/ui/src/CombatCharacterController.cpp	2007-06-08 11:41:47 UTC (rev 3524)
+++ rl/trunk/engine/ui/src/CombatCharacterController.cpp	2007-06-08 22:47:58 UTC (rev 3525)
@@ -19,26 +19,32 @@
 #include &quot;Actor.h&quot;
 #include &quot;Combat.h&quot;
 #include &quot;CombatManager.h&quot;
+#include &quot;CombatWindow.h&quot;
 #include &quot;CoreSubsystem.h&quot;
 #include &quot;Creature.h&quot;
 #include &quot;InputManager.h&quot;
+#include &quot;MeshObject.h&quot;
 #include &quot;Person.h&quot;
 #include &quot;PhysicalThing.h&quot;
 #include &quot;Selector.h&quot;
+#include &quot;WindowFactory.h&quot;
 #include &quot;World.h&quot;
 
 namespace rl {
     CombatCharacterController::CombatCharacterController(CommandMapper* cmdMapper,
         Actor* camera, Person* character)
-        : CharacterController(cmdMapper, camera, character),
+        : CharacterController(cmdMapper, camera, character, CST_COMBAT),
           mCombatManager(CombatManager::getSingletonPtr()),
           mCombat(NULL),
+          mCombatWindow(NULL),
           mEnemySelector(CoreSubsystem::getSingleton().getWorld()-&gt;getSceneManager(),
             QUERYFLAG_CREATURE)
     {
         CreatureSelectionFilter* filter = new CreatureSelectionFilter();
         filter-&gt;setAlignmentMask(Creature::ALIGNMENT_ENEMY);
         mEnemySelector.setFilter(filter);
+
+        mCombatWindow = WindowFactory::getSingleton().getCombatWindow();
     }
 
 	CombatCharacterController::~CombatCharacterController()
@@ -51,6 +57,10 @@
         mCameraActor-&gt;getPhysicalThing()-&gt;freeze();
         mCharacterActor-&gt;getPhysicalThing()-&gt;freeze();
 
+        ///\todo Richtig machen, nur tempor&#228;r Ani hier setzen.
+        static_cast&lt;MeshObject*&gt;(mCharacterActor-&gt;getControlledObject())
+            -&gt;startAnimation(&quot;kampf_schwerter_idle&quot;);
+
         // Set reference to character
         mEnemySelector.setCheckVisibility(true, mCharacter);
         mEnemySelector.track(mCharacter);
@@ -84,12 +94,16 @@
                 return;
             }
         }
+        mCombatWindow-&gt;setVisible(true);
     }
 
     void CombatCharacterController::pause()
     {
+        mCombatWindow-&gt;setVisible(false);
+
         mCameraActor-&gt;getPhysicalThing()-&gt;unfreeze();
         mCharacterActor-&gt;getPhysicalThing()-&gt;unfreeze();
+        static_cast&lt;MeshObject*&gt;(mCharacterActor-&gt;getControlledObject())-&gt;stopAllAnimations();
 
         // reset current combat, in order to avoid a potential dangling pointer
         mCombat = NULL;
@@ -98,24 +112,4 @@
 	void CombatCharacterController::run(Ogre::Real elapsedTime)
     {
     }
-
-	bool CombatCharacterController::injectMouseDown(int mouseButtonMask)
-    {
-        return false;
-    }
-
-    bool CombatCharacterController::injectMouseUp(int mouseButtonMask)
-    {
-        return false;
-    }
-
-    bool CombatCharacterController::injectKeyDown(int keycode)
-    {
-        return false;
-    }
-
-    bool CombatCharacterController::injectKeyUp(int keycode)
-    {
-        return false;
-    }
 }

Added: rl/trunk/engine/ui/src/CombatWindow.cpp
===================================================================
--- rl/trunk/engine/ui/src/CombatWindow.cpp	2007-06-08 11:41:47 UTC (rev 3524)
+++ rl/trunk/engine/ui/src/CombatWindow.cpp	2007-06-08 22:47:58 UTC (rev 3525)
@@ -0,0 +1,29 @@
+/* This source file is part of Rastullahs Lockenpracht.
+ * Copyright (C) 2003-2007 Team Pantheon. <A HREF="http://www.team-pantheon.de">http://www.team-pantheon.de</A>
+ *
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the Clarified Artistic License.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  Clarified Artistic License for more details.
+ *
+ *  You should have received a copy of the Clarified Artistic License
+ *  along with this program; if not you can get it here
+ *  <A HREF="http://www.jpaulmorrison.com/fbp/artistic2.htm.">http://www.jpaulmorrison.com/fbp/artistic2.htm.</A>
+ */
+
+#include &quot;CombatWindow.h&quot;
+#include &quot;CoreSubsystem.h&quot;
+#include &quot;ContentModule.h&quot;
+
+using namespace CEGUI;
+
+namespace rl {
+
+    CombatWindow::CombatWindow() : AbstractWindow(&quot;combatwindow.xml&quot;, WIT_NONE)
+    {
+    }
+
+}

Modified: rl/trunk/engine/ui/src/CommandMapper.cpp
===================================================================
--- rl/trunk/engine/ui/src/CommandMapper.cpp	2007-06-08 11:41:47 UTC (rev 3524)
+++ rl/trunk/engine/ui/src/CommandMapper.cpp	2007-06-08 22:47:58 UTC (rev 3525)
@@ -169,11 +169,12 @@
 
             for (size_t i = 0; i &lt; keys.size(); i++)
             {
-                cmdMap[getKeyCode(keys[i])] = CeGuiString(it-&gt;first);
+                int keycode = getKeyCode(keys[i]);
+                cmdMap[keycode] = CeGuiString(it-&gt;first);
                 LOG_MESSAGE(Logger::UI,
                     Ogre::String(&quot;Key &quot;) + keys[i] + &quot; (&quot;
-                    + StringConverter::toString(getKeyCode(keys[i]))
-                    + &quot;) is assigned to command &quot; + it-&gt;first + &quot; globally&quot;);
+                    + StringConverter::toString(keycode)
+                    + &quot;) is assigned to command &quot; + it-&gt;first);
             }
         }
     }

Modified: rl/trunk/engine/ui/src/Console.cpp
===================================================================
--- rl/trunk/engine/ui/src/Console.cpp	2007-06-08 11:41:47 UTC (rev 3524)
+++ rl/trunk/engine/ui/src/Console.cpp	2007-06-08 22:47:58 UTC (rev 3525)
@@ -31,7 +31,7 @@
 namespace rl 
 {
 	Console::Console() : 
-		AbstractWindow(&quot;console.xml&quot;, WND_KEYBOARD_INPUT)
+		AbstractWindow(&quot;console.xml&quot;, WIT_KEYBOARD_INPUT)
 	{
 		using namespace CEGUI;
 		

Modified: rl/trunk/engine/ui/src/ContainerContentWindow.cpp
===================================================================
--- rl/trunk/engine/ui/src/ContainerContentWindow.cpp	2007-06-08 11:41:47 UTC (rev 3524)
+++ rl/trunk/engine/ui/src/ContainerContentWindow.cpp	2007-06-08 22:47:58 UTC (rev 3525)
@@ -33,7 +33,7 @@
 	int ContainerContentWindow::sItemCount = 0;
 
 	ContainerContentWindow::ContainerContentWindow(Container* container) 
-		: AbstractWindow(&quot;containercontentwindow.xml&quot;, WND_MOUSE_INPUT),
+		: AbstractWindow(&quot;containercontentwindow.xml&quot;, WIT_MOUSE_INPUT),
 		mContainer(container)
 	{
 		mContentWindow = getWindow(&quot;ContainerContentWindow/Content&quot;);

Modified: rl/trunk/engine/ui/src/CutsceneCharacterController.cpp
===================================================================
--- rl/trunk/engine/ui/src/CutsceneCharacterController.cpp	2007-06-08 11:41:47 UTC (rev 3524)
+++ rl/trunk/engine/ui/src/CutsceneCharacterController.cpp	2007-06-08 22:47:58 UTC (rev 3525)
@@ -27,7 +27,7 @@
 namespace rl {
 
 	CutsceneCharacterController::CutsceneCharacterController(CommandMapper* cmdMapper,
-        Actor* camera) : CharacterController(cmdMapper, camera, NULL)
+        Actor* camera) : CharacterController(cmdMapper, camera, NULL, CST_CUTSCENE)
 	{
 	}
 
@@ -67,9 +67,4 @@
         dynamic_cast&lt;Ogre::Camera*&gt;(mCameraActor-&gt;getControlledObject()-&gt;getMovableObject())
             -&gt;lookAt(point);
     }
-
-    bool CutsceneCharacterController::injectKeyUp(int keycode)
-	{
-		return startAction(mCommandMapper-&gt;getControlStateAction(keycode, CST_CUTSCENE));		
-	}
 }

Modified: rl/trunk/engine/ui/src/DebugWindow.cpp
===================================================================
--- rl/trunk/engine/ui/src/DebugWindow.cpp	2007-06-08 11:41:47 UTC (rev 3524)
+++ rl/trunk/engine/ui/src/DebugWindow.cpp	2007-06-08 22:47:58 UTC (rev 3525)
@@ -35,7 +35,7 @@
 
 namespace rl
 {
-    DebugWindow::DebugWindow() : AbstractWindow(&quot;debugwindow.xml&quot;, WND_SHOW),
+    DebugWindow::DebugWindow() : AbstractWindow(&quot;debugwindow.xml&quot;, WIT_NONE),
           mMessageText(),
           mPageCaption(),
           mPageText(),

Modified: rl/trunk/engine/ui/src/DialogCharacterController.cpp
===================================================================
--- rl/trunk/engine/ui/src/DialogCharacterController.cpp	2007-06-08 11:41:47 UTC (rev 3524)
+++ rl/trunk/engine/ui/src/DialogCharacterController.cpp	2007-06-08 22:47:58 UTC (rev 3525)
@@ -49,7 +49,7 @@
 
     DialogCharacterController::DialogCharacterController(CommandMapper* cmdMapper,
         Actor* camera, Person* character)
-        : CharacterController(cmdMapper, camera, character),
+        : CharacterController(cmdMapper, camera, character, CST_DIALOG),
         mTargetCameraPosition(Vector3::ZERO),
         mTargetCameraDirection(Vector3::UNIT_Z),
         mCurrFadeTextTime(0),
@@ -281,10 +281,11 @@
         }
     }
 
-    bool DialogCharacterController::injectMouseUp(int mouseButtonMask)
+    bool DialogCharacterController::mouseReleased(const OIS::MouseEvent&amp; evt,
+        OIS::MouseButtonID id)
     {
 
-        if( mTextShown &amp;&amp; (mCurrFadeTextTime+0.25)&lt;mTotalFadeTextTime )
+        if (mTextShown &amp;&amp; (mCurrFadeTextTime + 0.25) &lt; mTotalFadeTextTime)
         {
             mCurrFadeTextTime = -1;
 

Modified: rl/trunk/engine/ui/src/DialogWindow.cpp
===================================================================
--- rl/trunk/engine/ui/src/DialogWindow.cpp	2007-06-08 11:41:47 UTC (rev 3524)
+++ rl/trunk/engine/ui/src/DialogWindow.cpp	2007-06-08 22:47:58 UTC (rev 3525)
@@ -45,7 +45,7 @@
 const CeGuiString DialogWindow::DIALOG_EXIT = &quot;EXIT&quot;;
 
 DialogWindow::DialogWindow(GameLoggerWindow* gamelogger)
-  : AbstractWindow(&quot;dialogwindow.xml&quot;, WND_MOUSE_INPUT, false),
+  : AbstractWindow(&quot;dialogwindow.xml&quot;, WIT_MOUSE_INPUT, false),
 	mBot(NULL), 
 	mCurrentResponse(NULL),
     mCurrentResponseText(&quot;&quot;),

Modified: rl/trunk/engine/ui/src/FreeFlightCharacterController.cpp
===================================================================
--- rl/trunk/engine/ui/src/FreeFlightCharacterController.cpp	2007-06-08 11:41:47 UTC (rev 3524)
+++ rl/trunk/engine/ui/src/FreeFlightCharacterController.cpp	2007-06-08 22:47:58 UTC (rev 3525)
@@ -15,6 +15,7 @@
 */
 
 #include &quot;FreeFlightCharacterController.h&quot;
+
 #include &quot;CoreSubsystem.h&quot;
 #include &quot;ConfigurationManager.h&quot;
 #include &quot;Exception.h&quot;
@@ -34,7 +35,7 @@
 
 	FreeFlightCharacterController::FreeFlightCharacterController(CommandMapper* cmdMapper,
         Actor* camera, Person* character)
-		: CharacterController(cmdMapper, camera, character),
+		: CharacterController(cmdMapper, camera, character, CST_FREEFLIGHT),
 		mMovementSpeed(5.0f),
 		mSpeedRange(0.03f, 90.0f),
 		mSpeedIncrement(0.02f),
@@ -108,6 +109,8 @@
 
 	void FreeFlightCharacterController::run(Real elapsedTime)
 	{
+        if (isCeguiActive()) return;
+
 		InputManager* im = InputManager::getSingletonPtr();
 
 		// Fetch current movement state
@@ -224,26 +227,22 @@
         mPitch = Degree(0);
 	}
 
-	bool FreeFlightCharacterController::injectKeyDown(int keycode)
+    bool FreeFlightCharacterController::keyPressed(const OIS::KeyEvent&amp; evt)
 	{
-        int scancode;
-        mCommandMapper-&gt;decodeKey(keycode, &amp;scancode, NULL);
-        int movement = mCommandMapper-&gt;getMovement(scancode);
+        int movement = mCommandMapper-&gt;getMovement(evt.key);
 
-
 		if (movement != MOVE_NONE)
 		{
 			mCurrentMovementState |= movement;
 			return true;
 		}
+
 		return false;
 	}
 
-	bool FreeFlightCharacterController::injectKeyUp(int keycode)
+    bool FreeFlightCharacterController::keyReleased(const OIS::KeyEvent&amp; evt)
 	{
-        int scancode;
-        mCommandMapper-&gt;decodeKey(keycode, &amp;scancode, NULL);
-        int movement = mCommandMapper-&gt;getMovement(scancode);
+        int movement = mCommandMapper-&gt;getMovement(evt.key);
 
 		if (movement != MOVE_NONE)
 		{
@@ -252,6 +251,8 @@
 		}
         else
         {
+            InputManager* im = InputManager::getSingletonPtr();
+            int keycode = CommandMapper::encodeKey(evt.key, im-&gt;getModifierCode());
             CeGuiString command = mCommandMapper-&gt;getControlStateAction(keycode, CST_FREEFLIGHT);
             if (command == &quot;back_to_character_movement&quot;)
             {
@@ -265,14 +266,11 @@
             }
             else 
             {
-                return startAction(command);
+                return CharacterController::keyReleased(evt);
             }
         }
-			
-		return false;
 	}
 
-
     int FreeFlightCharacterController::userProcess()
     {
         if (m_body0 == mCamBody || m_body1 == mCamBody)

Modified: rl/trunk/engine/ui/src/GameLoggerWindow.cpp
===================================================================
--- rl/trunk/engine/ui/src/GameLoggerWindow.cpp	2007-06-08 11:41:47 UTC (rev 3524)
+++ rl/trunk/engine/ui/src/GameLoggerWindow.cpp	2007-06-08 22:47:58 UTC (rev 3525)
@@ -27,7 +27,7 @@
 CEGUI::colour GameLoggerWindow::COLOR_MISC(      0xFFFFFFFF);
 
 GameLoggerWindow::GameLoggerWindow() : 
-	AbstractWindow(&quot;gameloggerwindow.xml&quot;, WND_SHOW)
+	AbstractWindow(&quot;gameloggerwindow.xml&quot;, WIT_NONE)
 {
 	mLog = getListbox (&quot;GameLogger/Log&quot;);
 	bindDestroyWindowToXButton();

Modified: rl/trunk/engine/ui/src/GameObjectInfoWindow.cpp
===================================================================
--- rl/trunk/engine/ui/src/GameObjectInfoWindow.cpp	2007-06-08 11:41:47 UTC (rev 3524)
+++ rl/trunk/engine/ui/src/GameObjectInfoWindow.cpp	2007-06-08 22:47:58 UTC (rev 3525)
@@ -35,7 +35,7 @@
     //------------------------------------------------------- Constructor
 
 	GameObjectInfoWindow::GameObjectInfoWindow(GameObject* go, Creature* character) 
-	 :  AbstractWindow(&quot;gameobjectinfowindow.xml&quot;, WND_MOUSE_INPUT),
+	 :  AbstractWindow(&quot;gameobjectinfowindow.xml&quot;, WIT_MOUSE_INPUT),
 		mGameObject(go),
 		mCharacter(character),
 		mNumActionButtons(0)

Modified: rl/trunk/engine/ui/src/GameObjectPropsWindow.cpp
===================================================================
--- rl/trunk/engine/ui/src/GameObjectPropsWindow.cpp	2007-06-08 11:41:47 UTC (rev 3524)
+++ rl/trunk/engine/ui/src/GameObjectPropsWindow.cpp	2007-06-08 22:47:58 UTC (rev 3525)
@@ -35,7 +35,7 @@
     //------------------------------------------------------- Constructor
 
 	GameObjectPropsWindow::GameObjectPropsWindow() :
-        AbstractWindow(&quot;gameobjectpropswindow.xml&quot;, WND_MOUSE_INPUT)
+        AbstractWindow(&quot;gameobjectpropswindow.xml&quot;, WIT_MOUSE_INPUT)
 	{
         // Get access to the tab control
         mTabPane = getTabControl(&quot;GameObjectPropsWindow/PropertiesTabPane&quot;);

Modified: rl/trunk/engine/ui/src/GameSettings.cpp
===================================================================
--- rl/trunk/engine/ui/src/GameSettings.cpp	2007-06-08 11:41:47 UTC (rev 3524)
+++ rl/trunk/engine/ui/src/GameSettings.cpp	2007-06-08 22:47:58 UTC (rev 3525)
@@ -26,7 +26,7 @@
 namespace rl
 {
     GameSettings::GameSettings()
-        : AbstractWindow(&quot;gamesettings.xml&quot;, WND_MOUSE_INPUT)
+        : AbstractWindow(&quot;gamesettings.xml&quot;, WIT_MOUSE_INPUT)
     {
         // Register sound driver components
         std::list&lt;SoundDriver*&gt; soundDriverList = SoundManager::getSingleton().getDriverList();

Modified: rl/trunk/engine/ui/src/InGameMenuWindow.cpp
===================================================================
--- rl/trunk/engine/ui/src/InGameMenuWindow.cpp	2007-06-08 11:41:47 UTC (rev 3524)
+++ rl/trunk/engine/ui/src/InGameMenuWindow.cpp	2007-06-08 22:47:58 UTC (rev 3525)
@@ -33,7 +33,7 @@
 namespace rl {
 
 InGameMenuWindow::InGameMenuWindow()
-: AbstractWindow(&quot;ingamemenuwindow.xml&quot;, WND_MOUSE_INPUT)
+: AbstractWindow(&quot;ingamemenuwindow.xml&quot;, WIT_MOUSE_INPUT)
 {
 	update();
 }

Modified: rl/trunk/engine/ui/src/InfoPopup.cpp
===================================================================
--- rl/trunk/engine/ui/src/InfoPopup.cpp	2007-06-08 11:41:47 UTC (rev 3524)
+++ rl/trunk/engine/ui/src/InfoPopup.cpp	2007-06-08 22:47:58 UTC (rev 3525)
@@ -22,7 +22,7 @@
 namespace rl {
 
 	InfoPopup::InfoPopup()
-		: AbstractWindow(&quot;infopopup.xml&quot;, AbstractWindow::WND_SHOW, false)
+		: AbstractWindow(&quot;infopopup.xml&quot;, AbstractWindow::WIT_NONE, false)
 	{
 		mErrorIcon = getWindow(&quot;InfoPopup/ErrorIcon&quot;);
 		mQuestIcon = getWindow(&quot;InfoPopup/QuestIcon&quot;);

Modified: rl/trunk/engine/ui/src/InputManager.cpp
===================================================================
--- rl/trunk/engine/ui/src/InputManager.cpp	2007-06-08 11:41:47 UTC (rev 3524)
+++ rl/trunk/engine/ui/src/InputManager.cpp	2007-06-08 22:47:58 UTC (rev 3525)
@@ -60,9 +60,6 @@
 namespace rl {
 
     InputManager::InputManager(Ogre::RenderWindow* win) :
-        mNumActiveWindowsMouseInput(0),
-        mNumActiveWindowsKeyboardInput(0),
-        mNumActiveWindowsAllInput(0),
         mKeyMapNormal(),
         mKeyMapShift(),
         mKeyMapAlt(),
@@ -131,9 +128,6 @@
         mMouse-&gt;getMouseState().width = width;
         mMouse-&gt;getMouseState().height = height;
 
-        mKeyboard-&gt;setEventCallback(this);
-        mMouse-&gt;setEventCallback(this);
-
         LOG_DEBUG(Logger::UI, &quot;Done initializing input manager.&quot;);
     }
 
@@ -158,192 +152,27 @@
         }
     }
 
-    bool InputManager::mousePressed(const OIS::MouseEvent &amp; e, MouseButtonID id)
-    {
-        if (isCeguiActive())
-        {
-            System::getSingleton().injectMouseButtonDown(
-                static_cast&lt;CEGUI::MouseButton&gt;(id));
-        }
-        else
-        {
-            if (!mControlStates.empty())
-            {
-                mControlStates.top()-&gt;injectMouseDown(
-                    CommandMapper::encodeKey(id, getModifierCode()));
-            }
-        }
-        return true;
-    }
-
     bool InputManager::isMouseButtonDown( OIS::MouseButtonID buttonID )
     {
         OIS::MouseState ms = mMouse-&gt;getMouseState();
         return ms.buttonDown( buttonID );
     }
 
-
-    bool InputManager::mouseReleased(const OIS::MouseEvent &amp; arg, MouseButtonID id)
-    {
-        if (isCeguiActive())
-        {
-            System::getSingleton().injectMouseButtonUp(
-                static_cast&lt;CEGUI::MouseButton&gt;(id));
-            // return true;
-        }
-        else if (!mControlStates.empty())
-        {
-            mControlStates.top()-&gt;injectMouseUp(
-                CommandMapper::encodeKey(id, getModifierCode()));
-        }
-
-        return true;
-    }
-
-    bool InputManager::mouseMoved(const OIS::MouseEvent &amp;arg)
-    {
-        if (isCeguiActive())
-        {
-            CEGUI::Renderer* renderer  = System::getSingleton().getRenderer();
-            System::getSingleton().injectMouseMove(arg.state.X.rel, arg.state.Y.rel);
-
-            return true;
-        }
-        return false;
-    }
-
     Ogre::Real InputManager::getMouseRelativeX() const
     {
-        if (isCeguiActive())
-        {
-            return 0;
-            return mSavedMouseState.x;
-        }
         return (float)mMouse-&gt;getMouseState().X.rel;
     }
 
     Ogre::Real InputManager::getMouseRelativeY() const
     {
-        if (isCeguiActive())
-        {
-            return 0;
-            return mSavedMouseState.y;
-        }
         return (float)mMouse-&gt;getMouseState().Y.rel;
     }
 
     Ogre::Real InputManager::getMouseRelativeZ() const
     {
-        if (isCeguiActive())
-        {
-            return 0;
-            return mSavedMouseState.z;
-        }
         return (float)mMouse-&gt;getMouseState().Z.rel;
     }
 
-    bool InputManager::sendKeyToCeGui(const OIS::KeyEvent&amp; e) const
-    {
-        // Fenster, die alle Inputs wollen
-        if (mNumActiveWindowsAllInput &gt; 0)
-        {
-            return true;
-        }
-
-        // Wenn kein Fenster mit Tastatureingabe aktiv ist, kriegt CEGUI keine KeyEvents
-        if (mNumActiveWindowsKeyboardInput == 0)
-        {
-            return false;
-        }
-
-        // ---- Tastatureingabe gefordert ----
-
-        // Tasten, die Zeichen liefern sollen an CEGUI gesendet werden
-        if (getKeyChar(e.key, getModifierCode()) != 0)
-        {
-            return true;
-        }
-
-        if (e.key == OIS::KC_RETURN
-            || e.key == OIS::KC_HOME || e.key == OIS::KC_END
-            || e.key == OIS::KC_LEFT || e.key == OIS::KC_RIGHT
-            || e.key == OIS::KC_BACK || e.key == OIS::KC_DELETE
-            || e.key == OIS::KC_UP   || e.key == OIS::KC_DOWN
-            || e.key == OIS::KC_RMENU)
-        {
-            return true;
-        }
-
-        return false;
-    }
-
-    bool InputManager::keyPressed(const OIS::KeyEvent&amp; e)
-    {
-        if (sendKeyToCeGui(e))
-        {   // Send all events to CEGUI
-            CEGUI::System&amp; cegui = CEGUI::System::getSingleton();
-            cegui.injectKeyDown(e.key);
-            cegui.injectChar(getKeyChar(e.key, getModifierCode()));
-        }
-        else
-        {
-            int code = CommandMapper::encodeKey(e.key, getModifierCode());
-
-            // is there a ruby script command linked?
-            KeyCommandMap::iterator it;
-            it = mKeyRubyCommand.find(code);
-            if( it != mKeyRubyCommand.end() )
-            {
-                if( it-&gt;second.length() &gt; 0 )
-                {
-                    bool error = CoreSubsystem::getSingleton().getRubyInterpreter()-&gt;execute(it-&gt;second.c_str());
-                    LOG_MESSAGE(Logger::UI, &quot; (keyboard shortcut) execution of ruby command '&quot; + it-&gt;second + &quot;' &quot; + (error == false ? &quot;success.&quot; : &quot;failure.&quot;));
-                    return true;
-                }
-            }
-
-            if (!mControlStates.empty())
-            {
-                mControlStates.top()-&gt;injectKeyDown(code);
-            }
-        }
-
-        return true;
-    }
-
-    bool InputManager::keyReleased(const OIS::KeyEvent&amp; e)
-    {
-        LOG_MESSAGE2(Logger::UI, &quot;Key released: &quot; + mKeyboard-&gt;getAsString(e.key) ,
-            &quot;InputManager::keyReleased&quot;);
-        if (sendKeyToCeGui(e))
-        {
-            CEGUI::System&amp; cegui = CEGUI::System::getSingleton();
-            cegui.injectKeyUp(e.key);
-            LOG_MESSAGE2(Logger::UI, &quot;    fed to cegui&quot;, &quot;InputManager::keyReleased&quot;);
-        }
-        else
-        {
-            int code = CommandMapper::encodeKey(e.key, getModifierCode());
-            Action* action = ActionManager::getSingleton().getInGameGlobalAction(
-                mCommandMapper-&gt;getGlobalAction(code));
-            if (action != NULL)
-            {
-                action-&gt;doAction(NULL, NULL, NULL);
-                LOG_MESSAGE2(Logger::UI, &quot;    invoked action &quot; + action-&gt;getName(),
-                    &quot;InputManager::keyReleased&quot;);
-            }
-
-            if (!mControlStates.empty())
-            {
-                mControlStates.top()-&gt;injectKeyUp(e.key);
-                LOG_MESSAGE2(Logger::UI, &quot;    fed to char controller&quot;,
-                    &quot;InputManager::keyReleased&quot;);
-            }
-        }
-
-        return true;
-    }
-
     CeGuiString InputManager::getKeyName(int combinedKeyCode)
     {
         int scancode, syskeys;
@@ -409,71 +238,6 @@
         return rval;
     }
 
-    void InputManager::registerAbstractWindow(AbstractWindow* window)
-    {
-        if (window-&gt;getWindowType() == AbstractWindow::WND_SHOW)
-            return;
-
-        bool active = isCeguiActive();
-
-        if (window-&gt;getWindowType() == AbstractWindow::WND_MOUSE_INPUT)
-        {
-            mNumActiveWindowsMouseInput++;
-        }
-        else if (window-&gt;getWindowType() == AbstractWindow::WND_KEYBOARD_INPUT)
-        {
-            mNumActiveWindowsKeyboardInput++;
-        }
-        else if (window-&gt;getWindowType() == AbstractWindow::WND_ALL_INPUT)
-        {
-            mNumActiveWindowsAllInput++;
-        }
-
-        if (!active &amp;&amp; isCeguiActive()) // war nicht aktiv, sollte jetzt aktiv sein -&gt; anschalten
-        {
-            mSavedMouseState.x = mMouse-&gt;getMouseState().X.rel;
-            mSavedMouseState.y = mMouse-&gt;getMouseState().Y.rel;
-            mSavedMouseState.z = mMouse-&gt;getMouseState().Z.rel;
-            CEGUI::MouseCursor::getSingleton().show();
-        }
-    }
-
-    void InputManager::unregisterAbstractWindow(AbstractWindow* window)
-    {
-        if (window-&gt;getWindowType() == AbstractWindow::WND_SHOW)
-        {
-            return;
-        }
-
-        bool active = isCeguiActive();
-
-        if (window-&gt;getWindowType() == AbstractWindow::WND_MOUSE_INPUT)
-        {
-            mNumActiveWindowsMouseInput--;
-        }
-        else if (window-&gt;getWindowType() == AbstractWindow::WND_KEYBOARD_INPUT)
-        {
-            mNumActiveWindowsKeyboardInput--;
-        }
-        else if (window-&gt;getWindowType() == AbstractWindow::WND_ALL_INPUT)
-        {
-            mNumActiveWindowsAllInput--;
-        }
-
-        if (active &amp;&amp; !isCeguiActive()) // war aktiv, sollte nicht mehr aktiv sein -&gt; ausschalten
-        {
-            CEGUI::MouseCursor::getSingleton().hide();
-        }
-    }
-
-    bool InputManager::isCeguiActive() const
-    {
-        return
-            mNumActiveWindowsKeyboardInput &gt; 0 ||
-            mNumActiveWindowsMouseInput &gt; 0 ||
-            mNumActiveWindowsAllInput &gt; 0;
-    }
-
     void InputManager::loadKeyMapping(const Ogre::String&amp; filename)
     {
         using namespace XERCES_CPP_NAMESPACE;
@@ -666,6 +430,10 @@
         {
             mControlStates.top()-&gt;pause();
         }
+
+        mKeyboard-&gt;setEventCallback(controller);
+        mMouse-&gt;setEventCallback(controller);
+
         mControlStates.push(controller);
         mControlStates.top()-&gt;resume();
     }
@@ -679,8 +447,16 @@
 
         if (!mControlStates.empty())
         {
-            mControlStates.top()-&gt;resume();
+            CharacterController* newController = mControlStates.top();
+            mKeyboard-&gt;setEventCallback(newController);
+            mMouse-&gt;setEventCallback(newController);
+            newController-&gt;resume();
         }
+        else
+        {
+            mKeyboard-&gt;setEventCallback(NULL);
+            mMouse-&gt;setEventCallback(NULL);
+        }
     }
 
     void InputManager::clearControlStates()

Modified: rl/trunk/engine/ui/src/InventoryWindow.cpp
===================================================================
--- rl/trunk/engine/ui/src/InventoryWindow.cpp	2007-06-08 11:41:47 UTC (rev 3524)
+++ rl/trunk/engine/ui/src/InventoryWindow.cpp	2007-06-08 22:47:58 UTC (rev 3525)
@@ -32,7 +32,7 @@
 	const Ogre::String InventoryWindow::SLOTNAME = &quot;slotname&quot;;
 
     InventoryWindow::InventoryWindow(const Ogre::String&amp; inventoryWindow, Inventory* inventory)
-        : AbstractWindow(inventoryWindow, AbstractWindow::WND_MOUSE_INPUT)
+        : AbstractWindow(inventoryWindow, AbstractWindow::WIT_MOUSE_INPUT)
     {
         mInventory = inventory;
 

Modified: rl/trunk/engine/ui/src/JournalWindow.cpp
===================================================================
--- rl/trunk/engine/ui/src/JournalWindow.cpp	2007-06-08 11:41:47 UTC (rev 3524)
+++ rl/trunk/engine/ui/src/JournalWindow.cpp	2007-06-08 22:47:58 UTC (rev 3525)
@@ -29,7 +29,7 @@
 namespace rl {
 
     JournalWindow::JournalWindow()
-        : AbstractWindow(&quot;journalwindow.xml&quot;, WND_MOUSE_INPUT),
+        : AbstractWindow(&quot;journalwindow.xml&quot;, WIT_MOUSE_INPUT),
         mQuests(0),
         mQuestTitle(0),
         mQuestState(0),

Modified: rl/trunk/engine/ui/src/LogWindow.cpp
===================================================================
--- rl/trunk/engine/ui/src/LogWindow.cpp	2007-06-08 11:41:47 UTC (rev 3524)
+++ rl/trunk/engine/ui/src/LogWindow.cpp	2007-06-08 22:47:58 UTC (rev 3525)
@@ -23,7 +23,7 @@
 namespace rl
 {
 	LogWindow::LogWindow()
-		: AbstractWindow(&quot;logwindow.xml&quot;, WND_MOUSE_INPUT)
+		: AbstractWindow(&quot;logwindow.xml&quot;, WIT_MOUSE_INPUT)
 	{
 		mRastullahLog = getMultiLineEditbox(&quot;LogWindow/RastullahLog/Text&quot;);
 		mOgreLog = getMultiLineEditbox(&quot;LogWindow/OgreLog/Text&quot;);

Modified: rl/trunk/engine/ui/src/MainMenuEngineWindow.cpp
===================================================================
--- rl/trunk/engine/ui/src/MainMenuEngineWindow.cpp	2007-06-08 11:41:47 UTC (rev 3524)
+++ rl/trunk/engine/ui/src/MainMenuEngineWindow.cpp	2007-06-08 22:47:58 UTC (rev 3525)
@@ -26,7 +26,7 @@
 namespace rl {
 
     MainMenuEngineWindow::MainMenuEngineWindow() :
-        AbstractWindow(&quot;mainmenuenginewindow.xml&quot;, WND_SHOW, false)
+        AbstractWindow(&quot;mainmenuenginewindow.xml&quot;, WIT_NONE, false)
     {
         getWindow(&quot;MainMenu/EngineVersion&quot;)-&gt;setText(
             CoreSubsystem::getSingleton().getEngineVersionString()+

Modified: rl/trunk/engine/ui/src/MainMenuWindow.cpp
===================================================================
--- rl/trunk/engine/ui/src/MainMenuWindow.cpp	2007-06-08 11:41:47 UTC (rev 3524)
+++ rl/trunk/engine/ui/src/MainMenuWindow.cpp	2007-06-08 22:47:58 UTC (rev 3525)
@@ -31,7 +31,7 @@
 namespace rl {
 
 	MainMenuWindow::MainMenuWindow(MainMenuEngineWindow* enginewindow) :
-		AbstractWindow(&quot;mainmenuwindow.xml&quot;, WND_MOUSE_INPUT, false, false),
+		AbstractWindow(&quot;mainmenuwindow.xml&quot;, WIT_MOUSE_INPUT, false, false),
 		mActiveModule(NULL),
 		mEngineWindow(enginewindow)
 	{

Modified: rl/trunk/engine/ui/src/MessageWindow.cpp
===================================================================
--- rl/trunk/engine/ui/src/MessageWindow.cpp	2007-06-08 11:41:47 UTC (rev 3524)
+++ rl/trunk/engine/ui/src/MessageWindow.cpp	2007-06-08 22:47:58 UTC (rev 3525)
@@ -20,7 +20,7 @@
 namespace rl {
 
 MessageWindow::MessageWindow() :
-	AbstractWindow(&quot;messagewindow.xml&quot;, WND_MOUSE_INPUT)
+	AbstractWindow(&quot;messagewindow.xml&quot;, WIT_MOUSE_INPUT)
 {
 	mTextField = getWindow(&quot;MessageWindow/Text&quot;);
 

Modified: rl/trunk/engine/ui/src/MovementCharacterController.cpp
===================================================================
--- rl/trunk/engine/ui/src/MovementCharacterController.cpp	2007-06-08 11:41:47 UTC (rev 3524)
+++ rl/trunk/engine/ui/src/MovementCharacterController.cpp	2007-06-08 22:47:58 UTC (rev 3525)
@@ -67,7 +67,7 @@
 
     MovementCharacterController::MovementCharacterController(CommandMapper* cmdMapper,
         Actor* camera, Person* character)
-        : CharacterController(cmdMapper, camera, character),
+        : CharacterController(cmdMapper, camera, character, CST_MOVEMENT),
         mMovingCreature(NULL),
         mCharacterState(),
         mDesiredDistance(2.00),
@@ -225,6 +225,8 @@
     //------------------------------------------------------------------------
     void MovementCharacterController::run(Real elapsedTime)
     {
+        if (isCeguiActive()) return;
+
         InputManager* im = InputManager::getSingletonPtr();
 
         updateCharacter(elapsedTime);
@@ -306,7 +308,7 @@
                     rotation = -elapsedTime * baseVel;
 
                 // mouse
-                if( !im-&gt;isCeguiActive() &amp;&amp; mViewMode == VM_FIRST_PERSON || mViewMode == VM_THIRD_PERSON )
+                if( !isCeguiActive() &amp;&amp; mViewMode == VM_FIRST_PERSON || mViewMode == VM_THIRD_PERSON )
                 {
                     if( !(movement &amp; TURN_LEFT || movement &amp; TURN_RIGHT) )
                     {
@@ -431,7 +433,7 @@
             mDesiredDistance = mDistanceRange.second;
         }
 
-        if( !im-&gt;isCeguiActive() &amp;&amp; mViewMode == VM_FREE_CAMERA )
+        if( !isCeguiActive() &amp;&amp; mViewMode == VM_FREE_CAMERA )
         {
             mCamYaw -= 2 * mMouseSensitivity / 4.0 * mRotationSpeed * Degree(im-&gt;getMouseRelativeX() / 15);
 
@@ -510,7 +512,6 @@
         }
     }
 
-
     // -------------------------------------------------------------
     // character collision moved to MovingCreature(Manager)
     int MovementCharacterController::userProcess()
@@ -994,9 +995,9 @@
     //------------------------------------------------------------------------
     void MovementCharacterController::updateSelection()
     {
+        if (isCeguiActive()) return;
+
         InputManager* im = InputManager::getSingletonPtr();
-        if( im-&gt;isCeguiActive() )
-            return;
 
         GameObject* oldGo = mSelector.getFirstSelectedObject();
 
@@ -1146,12 +1147,12 @@
     }
 
     //------------------------------------------------------------------------
-    bool MovementCharacterController::injectKeyDown(int keycode)
+    bool MovementCharacterController::keyPressed(const OIS::KeyEvent&amp; evt)
     {
-        int scancode;
-        mCommandMapper-&gt;decodeKey(keycode, &amp;scancode, NULL);
-        int movement = mCommandMapper-&gt;getMovement(scancode);
+        if (CharacterController::keyPressed(evt)) return true;
 
+        int movement = mCommandMapper-&gt;getMovement(evt.key);
+
         if (movement &amp; MOVE_RUN_LOCK) // dieses einrasten lassen
         {
             mCharacterState.mCurrentMovementState ^= MOVE_RUN_LOCK;
@@ -1166,12 +1167,16 @@
     }
 
     //------------------------------------------------------------------------
-    bool MovementCharacterController::injectKeyUp(int keycode)
+    bool MovementCharacterController::keyReleased(const OIS::KeyEvent&amp; evt)
     {
-        int scancode;
-        mCommandMapper-&gt;decodeKey(keycode, &amp;scancode, NULL);
-        int movement = mCommandMapper-&gt;getMovement(scancode);
+        // CEGUI is handled by base class, so hand it down if necessary.
+        if (sendKeyToCeGui(evt))
+        {
+            return CharacterController::keyReleased(evt);
+        }
 
+        int movement = mCommandMapper-&gt;getMovement(evt.key);
+
         if (movement != MOVE_NONE)
         {
             mCharacterState.mCurrentMovementState &amp;= (~movement | MOVE_RUN_LOCK);
@@ -1179,6 +1184,8 @@
         }
         else
         {
+            InputManager* im = InputManager::getSingletonPtr();
+            int keycode = CommandMapper::encodeKey(evt.key, im-&gt;getModifierCode());
             CeGuiString command = mCommandMapper-&gt;getControlStateAction(keycode, CST_MOVEMENT);
             if (command == &quot;freeflight_mode&quot;)
             {
@@ -1197,7 +1204,8 @@
             }
             else
             {
-                return startAction(command);
+                // Nothing we handle here, see if base class can make something of this input.
+                return CharacterController::keyReleased(evt);
             }
         }
 
@@ -1205,22 +1213,19 @@
     }
 
     //------------------------------------------------------------------------
-    bool MovementCharacterController::injectMouseDown(int mouseButtonMask)
+    bool MovementCharacterController::mouseReleased(const OIS::MouseEvent&amp; evt,
+        OIS::MouseButtonID id)
     {
-        return false;
-    }
-
-    //------------------------------------------------------------------------
-    bool MovementCharacterController::injectMouseUp(int mouseButtonMask)
-    {
-        if (!InputManager::getSingleton().isCeguiActive())
+        if (!isCeguiActive())
         {
+            InputManager* im = InputManager::getSingletonPtr();
+            int mouseButtonMask = CommandMapper::encodeKey(id, im-&gt;getModifierCode());
             return startAction(mCommandMapper-&gt;getControlStateAction(mouseButtonMask,
                 CST_MOVEMENT), mCharacter);
         }
         else
         {
-            return false;
+            return CharacterController::mouseReleased(evt, id);
         }
     }
 

Modified: rl/trunk/engine/ui/src/ObjectDescriptionWindow.cpp
===================================================================
--- rl/trunk/engine/ui/src/ObjectDescriptionWindow.cpp	2007-06-08 11:41:47 UTC (rev 3524)
+++ rl/trunk/engine/ui/src/ObjectDescriptionWindow.cpp	2007-06-08 22:47:58 UTC (rev 3525)
@@ -21,7 +21,7 @@
 namespace rl
 {
 	ObjectDescriptionWindow::ObjectDescriptionWindow()
-		: AbstractWindow(&quot;objectdescriptionwindow.xml&quot;, WND_SHOW)
+		: AbstractWindow(&quot;objectdescriptionwindow.xml&quot;, WIT_NONE)
 	{
 		mDescription = getMultiLineEditbox(&quot;ObjectDescriptionWindow/Text&quot;);
 	}

Modified: rl/trunk/engine/ui/src/PlaylistWindow.cpp
===================================================================
--- rl/trunk/engine/ui/src/PlaylistWindow.cpp	2007-06-08 11:41:47 UTC (rev 3524)
+++ rl/trunk/engine/ui/src/PlaylistWindow.cpp	2007-06-08 22:47:58 UTC (rev 3525)
@@ -29,7 +29,7 @@
 namespace rl {
 
 PlaylistWindow::PlaylistWindow()
-	: AbstractWindow(&quot;playlistwindow.xml&quot;, WND_MOUSE_INPUT)
+	: AbstractWindow(&quot;playlistwindow.xml&quot;, WIT_MOUSE_INPUT)
 {
 	mPlaylistTable = getMultiColumnList(&quot;PlaylistSheet/PlaylistSheet/Table&quot;);
 	mPlaylistTable-&gt;addColumn((utf8*)&quot;Name&quot;, 0, cegui_reldim(0.5));

Modified: rl/trunk/engine/ui/src/ProgressWindow.cpp
===================================================================
--- rl/trunk/engine/ui/src/ProgressWindow.cpp	2007-06-08 11:41:47 UTC (rev 3524)
+++ rl/trunk/engine/ui/src/ProgressWindow.cpp	2007-06-08 22:47:58 UTC (rev 3525)
@@ -19,7 +19,7 @@
 namespace rl {
 
 ProgressWindow::ProgressWindow()
-: AbstractWindow(&quot;progresswindow.xml&quot;, AbstractWindow::WND_SHOW, false, true)
+: AbstractWindow(&quot;progresswindow.xml&quot;, WIT_NONE, false, true)
 {
 	mProgressBar = getProgressBar(&quot;ProgressWindow/ProgressBar&quot;);
     mText = getWindow(&quot;ProgressWindow/Text&quot;);

Modified: rl/trunk/engine/ui/src/SaveLoadWindow.cpp
===================================================================
--- rl/trunk/engine/ui/src/SaveLoadWindow.cpp	2007-06-08 11:41:47 UTC (rev 3524)
+++ rl/trunk/engine/ui/src/SaveLoadWindow.cpp	2007-06-08 22:47:58 UTC (rev 3525)
@@ -36,7 +36,7 @@
     //------------------------------------------------------- Constructor
 
     SaveLoadWindow::SaveLoadWindow() :
-        AbstractWindow(&quot;saveloadwindow.xml&quot;, WND_MOUSE_INPUT)
+        AbstractWindow(&quot;saveloadwindow.xml&quot;, WIT_MOUSE_INPUT)
     {
         // Get a access to the filename edit box
         mFilename = getEditbox(&quot;SaveLoadWindow/FileSheet/Filename&quot;);

Modified: rl/trunk/engine/ui/src/SoundConfig.cpp
===================================================================
--- rl/trunk/engine/ui/src/SoundConfig.cpp	2007-06-08 11:41:47 UTC (rev 3524)
+++ rl/trunk/engine/ui/src/SoundConfig.cpp	2007-06-08 22:47:58 UTC (rev 3525)
@@ -31,7 +31,7 @@
 {
 
 	SoundConfig::SoundConfig()
-		: AbstractWindow(&quot;soundconfig.xml&quot;, WND_ALL_INPUT),
+		: AbstractWindow(&quot;soundconfig.xml&quot;, WIT_MOUSE_INPUT | WIT_KEYBOARD_INPUT),
 		mDriverBox(NULL),
 		mVolumeSound(0),
 		mVolumeMusic(0),

Modified: rl/trunk/engine/ui/src/SubtitleWindow.cpp
===================================================================
--- rl/trunk/engine/ui/src/SubtitleWindow.cpp	2007-06-08 11:41:47 UTC (rev 3524)
+++ rl/trunk/engine/ui/src/SubtitleWindow.cpp	2007-06-08 22:47:58 UTC (rev 3525)
@@ -21,7 +21,7 @@
 namespace rl
 {
 	SubtitleWindow::SubtitleWindow()
-		: AbstractWindow(&quot;subtitlewindow.xml&quot;, WND_SHOW, false)
+		: AbstractWindow(&quot;subtitlewindow.xml&quot;, WIT_NONE, false)
 	{
 		mSubtitle = getMultiLineEditbox(&quot;SubtitleWindow/Text&quot;);
 	}

Modified: rl/trunk/engine/ui/src/WindowFactory.cpp
===================================================================
--- rl/trunk/engine/ui/src/WindowFactory.cpp	2007-06-08 11:41:47 UTC (rev 3524)
+++ rl/trunk/engine/ui/src/WindowFactory.cpp	2007-06-08 22:47:58 UTC (rev 3525)
@@ -21,6 +21,7 @@
 #include &quot;CharacterSheetWindow.h&quot;
 #include &quot;CharacterStateWindow.h&quot;
 #include &quot;CloseConfirmationWindow.h&quot;
+#include &quot;CombatWindow.h&quot;
 #include &quot;Console.h&quot;
 #include &quot;ContainerContentWindow.h&quot;
 #include &quot;CoreSubsystem.h&quot;
@@ -82,7 +83,8 @@
         mObjectDescriptionWindow(NULL),
         mMainMenuWindow(NULL),
         mCloseConfirmationWindow(NULL),
-        mGameSettings(NULL)
+        mGameSettings(NULL),
+        mCombatWindow(NULL)
     {
     }
 
@@ -103,8 +105,6 @@
         mJournalWindow = new JournalWindow();
         mInfoPopup = new InfoPopup();
         mObjectDescriptionWindow = new ObjectDescriptionWindow();
-        mCloseConfirmationWindow = NULL;
-        mGameSettings = NULL;
 
         RulesSubsystem::getSingleton().getQuestBook()-&gt;addQuestListener(mJournalWindow);
         RulesSubsystem::getSingleton().getQuestBook()-&gt;addQuestListener(mInfoPopup);
@@ -131,6 +131,7 @@
         delete mGameSettings;
         delete mDialogWindow;
         delete mSubtitleWindow;
+        delete mCombatWindow;
     }
 
     void WindowFactory::showCharacterActionChoice()
@@ -426,4 +427,13 @@
         }
         return mSubtitleWindow;
     }
+
+    CombatWindow* WindowFactory::getCombatWindow()
+    {
+        if (mCombatWindow == NULL)
+        {
+            mCombatWindow = new CombatWindow();
+        }
+        return mCombatWindow;
+    }
 }

Modified: rl/trunk/engine/ui/src/WindowManager.cpp
===================================================================
--- rl/trunk/engine/ui/src/WindowManager.cpp	2007-06-08 11:41:47 UTC (rev 3524)
+++ rl/trunk/engine/ui/src/WindowManager.cpp	2007-06-08 22:47:58 UTC (rev 3525)
@@ -28,7 +28,10 @@
 
 namespace rl {
 
-	WindowManager::WindowManager()
+    WindowManager::WindowManager()
+        : mWindowList(),
+          mNumActiveWindowsMouseInput(0),
+          mNumActiveWindowsKeyboardInput(0)
 	{
 	}
 
@@ -78,4 +81,33 @@
 		mWindowList.push_back(window);
 		return true;
 	}
+
+    void WindowManager::_visiblityChanged(AbstractWindow* window, bool isVisible)
+    {
+        if (window-&gt;getWindowInputType() &amp; AbstractWindow::WIT_MOUSE_INPUT)
+        {
+            mNumActiveWindowsMouseInput += isVisible ? +1 : -1;
+        }
+        else if (window-&gt;getWindowInputType() &amp; AbstractWindow::WIT_KEYBOARD_INPUT)
+        {
+            mNumActiveWindowsKeyboardInput += isVisible ? +1 : -1;
+        }
+
+        if (mNumActiveWindowsMouseInput == 1)
+        {
+            CEGUI::MouseCursor::getSingleton().show();
+        }
+        else if (mNumActiveWindowsMouseInput == 0)
+        {
+            CEGUI::MouseCursor::getSingleton().hide();
+        }
+    }
+
+    int WindowManager::getWindowInputMask() const
+    {
+        int mask = 0;
+        mask |= mNumActiveWindowsMouseInput &gt; 0 ? AbstractWindow::WIT_MOUSE_INPUT : 0;
+        mask |= mNumActiveWindowsKeyboardInput &gt; 0 ? AbstractWindow::WIT_KEYBOARD_INPUT : 0;
+        return mask;
+    }
 }


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000595.html">[Dsa-hl-svn] r3524 - rl/trunk/engine/core
</A></li>
	<LI>Next message: <A HREF="000597.html">[Dsa-hl-svn] r3526 - modules/common/gui/windows
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#596">[ date ]</a>
              <a href="thread.html#596">[ thread ]</a>
              <a href="subject.html#596">[ subject ]</a>
              <a href="author.html#596">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/dsa-hl-svn">More information about the Dsa-hl-svn
mailing list</a><br>
</body></html>
