<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Dsa-hl-svn] r3884 - in rl/trunk/engine: ai/src common/include	common/src core core/include core/src rules rules/include	rules/src ui/src
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/dsa-hl-svn/2007-September/index.html" >
   <LINK REL="made" HREF="mailto:dsa-hl-svn%40lists.berlios.de?Subject=Re%3A%20%5BDsa-hl-svn%5D%20r3884%20-%20in%20rl/trunk/engine%3A%20ai/src%20common/include%0A%09common/src%20core%20core/include%20core/src%20rules%20rules/include%0A%09rules/src%20ui/src&In-Reply-To=%3C200709301050.l8UAoUVc012502%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000954.html">
   <LINK REL="Next"  HREF="000956.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Dsa-hl-svn] r3884 - in rl/trunk/engine: ai/src common/include	common/src core core/include core/src rules rules/include	rules/src ui/src</H1>
    <B>timm at mail.berlios.de</B> 
    <A HREF="mailto:dsa-hl-svn%40lists.berlios.de?Subject=Re%3A%20%5BDsa-hl-svn%5D%20r3884%20-%20in%20rl/trunk/engine%3A%20ai/src%20common/include%0A%09common/src%20core%20core/include%20core/src%20rules%20rules/include%0A%09rules/src%20ui/src&In-Reply-To=%3C200709301050.l8UAoUVc012502%40sheep.berlios.de%3E"
       TITLE="[Dsa-hl-svn] r3884 - in rl/trunk/engine: ai/src common/include	common/src core core/include core/src rules rules/include	rules/src ui/src">timm at mail.berlios.de
       </A><BR>
    <I>Sun Sep 30 12:50:30 CEST 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="000954.html">[Dsa-hl-svn] r3883 - rl/trunk/engine/common/include
</A></li>
        <LI>Next message: <A HREF="000956.html">[Dsa-hl-svn] r3885 - in rl/trunk/engine: core/include core/src	rules/include rules/src
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#955">[ date ]</a>
              <a href="thread.html#955">[ thread ]</a>
              <a href="subject.html#955">[ subject ]</a>
              <a href="author.html#955">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: timm
Date: 2007-09-30 12:49:35 +0200 (Sun, 30 Sep 2007)
New Revision: 3884

Added:
   rl/trunk/engine/core/include/SaveGameFile.h
   rl/trunk/engine/core/include/SaveGameFileReader.h
   rl/trunk/engine/core/include/SaveGameFileWriter.h
   rl/trunk/engine/core/include/SaveGameManager.h
   rl/trunk/engine/core/src/SaveGameFile.cpp
   rl/trunk/engine/core/src/SaveGameFileReader.cpp
   rl/trunk/engine/core/src/SaveGameFileWriter.cpp
   rl/trunk/engine/core/src/SaveGameManager.cpp
Removed:
   rl/trunk/engine/rules/include/SaveGameFile.h
   rl/trunk/engine/rules/include/SaveGameFileWriter.h
   rl/trunk/engine/rules/include/SaveGameManager.h
   rl/trunk/engine/rules/src/SaveGameFile.cpp
   rl/trunk/engine/rules/src/SaveGameFileWriter.cpp
   rl/trunk/engine/rules/src/SaveGameManager.cpp
Modified:
   rl/trunk/engine/ai/src/AgentManager.cpp
   rl/trunk/engine/common/include/XmlPropertyWriter.h
   rl/trunk/engine/common/src/XmlPropertyWriter.cpp
   rl/trunk/engine/core/RlCore2005.vcproj
   rl/trunk/engine/core/include/CoreSubsystem.h
   rl/trunk/engine/core/src/CoreSubsystem.cpp
   rl/trunk/engine/rules/RlRules2005.vcproj
   rl/trunk/engine/rules/include/GameObjectManager.h
   rl/trunk/engine/rules/include/QuestBook.h
   rl/trunk/engine/rules/include/RulesSubsystem.h
   rl/trunk/engine/rules/src/GameObjectManager.cpp
   rl/trunk/engine/rules/src/QuestBook.cpp
   rl/trunk/engine/rules/src/RulesSubsystem.cpp
   rl/trunk/engine/ui/src/SaveLoadWindow.cpp
Log:
- moved game saving from rules to core
- saving/loading data from the save game file is the task of the managers (GameObjectManager, QuestBook etc.) now
- beginning of the save game file loader

Modified: rl/trunk/engine/ai/src/AgentManager.cpp
===================================================================
--- rl/trunk/engine/ai/src/AgentManager.cpp	2007-09-27 21:26:30 UTC (rev 3883)
+++ rl/trunk/engine/ai/src/AgentManager.cpp	2007-09-30 10:49:35 UTC (rev 3884)
@@ -103,7 +103,7 @@
 
 const Ogre::String&amp; AgentManager::getName() const
 {
-    static String NAME = &quot;AgentManager&quot;;
+    static Ogre::String NAME = &quot;AgentManager&quot;;
 
     return NAME;
 }

Modified: rl/trunk/engine/common/include/XmlPropertyWriter.h
===================================================================
--- rl/trunk/engine/common/include/XmlPropertyWriter.h	2007-09-27 21:26:30 UTC (rev 3883)
+++ rl/trunk/engine/common/include/XmlPropertyWriter.h	2007-09-30 10:49:35 UTC (rev 3884)
@@ -35,12 +35,14 @@
     typedef std::pair&lt;Ogre::String, Property&gt; PropertyEntry;
 
     class _RlCommonExport XmlPropertyWriter
-        : protected XmlProcessor
+        : public XmlProcessor
     {
     public:
         XmlPropertyWriter();
         virtual ~XmlPropertyWriter();
 
+        XERCES_CPP_NAMESPACE::DOMDocument* getDocument();
+
         std::vector&lt;PropertySet*&gt; getPropertySets();
         void setPropertySets(std::vector&lt;PropertySet*&gt; sets);
         void addPropertySet(PropertySet* set);
@@ -49,6 +51,8 @@
         XERCES_CPP_NAMESPACE::DOMElement* processPropertySet(XERCES_CPP_NAMESPACE::DOMElement* parent, const char* const name, PropertySet set);
         XERCES_CPP_NAMESPACE::DOMElement* processPropertyArray(XERCES_CPP_NAMESPACE::DOMElement* parent, const char* const name, PropertyVector vector);
         XERCES_CPP_NAMESPACE::DOMElement* processPropertyMap(XERCES_CPP_NAMESPACE::DOMElement* parent, const char* const name, PropertyMap map);
+
+        void writeEachProperty(XERCES_CPP_NAMESPACE::DOMElement* parent, const PropertyMap &amp;map);
     protected:
         std::vector&lt;PropertySet*&gt; mPropertySets;
 

Modified: rl/trunk/engine/common/src/XmlPropertyWriter.cpp
===================================================================
--- rl/trunk/engine/common/src/XmlPropertyWriter.cpp	2007-09-27 21:26:30 UTC (rev 3883)
+++ rl/trunk/engine/common/src/XmlPropertyWriter.cpp	2007-09-30 10:49:35 UTC (rev 3884)
@@ -38,6 +38,11 @@
     {
     }
 
+    DOMDocument* XmlPropertyWriter::getDocument()
+    {
+        return mDocument;
+    }
+
     void XmlPropertyWriter::setPropertySets(std::vector&lt;PropertySet*&gt; sets)
     {
         mPropertySets = sets;
@@ -127,4 +132,13 @@
         }
         return element;
     }
+
+    void XmlPropertyWriter::writeEachProperty(DOMElement* parent, const rl::PropertyMap &amp;map)
+    {
+        PropertyMap::const_iterator it_properties;
+        for(it_properties = map.begin(); it_properties != map.end(); it_properties++)
+        {
+            this-&gt;processProperty(parent, PropertyEntry(it_properties-&gt;first.c_str(), it_properties-&gt;second));
+        }
+    }
 }

Modified: rl/trunk/engine/core/RlCore2005.vcproj
===================================================================
--- rl/trunk/engine/core/RlCore2005.vcproj	2007-09-27 21:26:30 UTC (rev 3883)
+++ rl/trunk/engine/core/RlCore2005.vcproj	2007-09-30 10:49:35 UTC (rev 3884)
@@ -564,6 +564,22 @@
 				&gt;
 			&lt;/File&gt;
 			&lt;File
+				RelativePath=&quot;.\include\SaveGameFile.h&quot;
+				&gt;
+			&lt;/File&gt;
+			&lt;File
+				RelativePath=&quot;.\include\SaveGameFileReader.h&quot;
+				&gt;
+			&lt;/File&gt;
+			&lt;File
+				RelativePath=&quot;.\include\SaveGameFileWriter.h&quot;
+				&gt;
+			&lt;/File&gt;
+			&lt;File
+				RelativePath=&quot;.\include\SaveGameManager.h&quot;
+				&gt;
+			&lt;/File&gt;
+			&lt;File
 				RelativePath=&quot;.\include\SceneQuery.h&quot;
 				&gt;
 			&lt;/File&gt;
@@ -829,6 +845,22 @@
 				&gt;
 			&lt;/File&gt;
 			&lt;File
+				RelativePath=&quot;.\src\SaveGameFile.cpp&quot;
+				&gt;
+			&lt;/File&gt;
+			&lt;File
+				RelativePath=&quot;.\src\SaveGameFileReader.cpp&quot;
+				&gt;
+			&lt;/File&gt;
+			&lt;File
+				RelativePath=&quot;.\src\SaveGameFileWriter.cpp&quot;
+				&gt;
+			&lt;/File&gt;
+			&lt;File
+				RelativePath=&quot;.\src\SaveGameManager.cpp&quot;
+				&gt;
+			&lt;/File&gt;
+			&lt;File
 				RelativePath=&quot;.\src\SceneQuery.cpp&quot;
 				&gt;
 			&lt;/File&gt;

Modified: rl/trunk/engine/core/include/CoreSubsystem.h
===================================================================
--- rl/trunk/engine/core/include/CoreSubsystem.h	2007-09-27 21:26:30 UTC (rev 3883)
+++ rl/trunk/engine/core/include/CoreSubsystem.h	2007-09-30 10:49:35 UTC (rev 3884)
@@ -46,6 +46,7 @@
 class XmlResourceManager;
 class SoundManager;
 class DebugVisualsManager;
+class SaveGameManager;
 class JobScheduler;
 class ZoneManager;
 class TimeSourceManager;
@@ -138,6 +139,7 @@
     GameEventManager* mGameEventManager;
     SoundManager* mSoundManager;
     DebugVisualsManager* mDebugVisualsManager;
+    SaveGameManager* mSaveGameManager;
     JobScheduler* mJobScheduler;
 	ZoneManager* mZoneManager;
     TimeSourceManager* mTimeSourceManager;

Added: rl/trunk/engine/core/include/SaveGameFile.h
===================================================================
--- rl/trunk/engine/core/include/SaveGameFile.h	2007-09-27 21:26:30 UTC (rev 3883)
+++ rl/trunk/engine/core/include/SaveGameFile.h	2007-09-30 10:49:35 UTC (rev 3884)
@@ -0,0 +1,58 @@
+/* This source file is part of Rastullahs Lockenpracht.
+* Copyright (C) 2003-2007 Team Pantheon. <A HREF="http://www.team-pantheon.de">http://www.team-pantheon.de</A>
+* 
+*  This program is free software; you can redistribute it and/or modify
+*  it under the terms of the Clarified Artistic License.
+*
+*  This program is distributed in the hope that it will be useful,
+*  but WITHOUT ANY WARRANTY; without even the implied warranty of
+*  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+*  Clarified Artistic License for more details.
+*
+*  You should have received a copy of the Clarified Artistic License
+*  along with this program; if not you can get it here
+*  <A HREF="http://www.jpaulmorrison.com/fbp/artistic2.htm.">http://www.jpaulmorrison.com/fbp/artistic2.htm.</A>
+*/
+
+#ifndef __SaveGameFile_H__
+#define __SaveGameFile_H__
+
+#include &quot;CorePrerequisites.h&quot;
+#include &lt;OgreDataStream.h&gt;
+
+#include &lt;Property.h&gt;
+#include &lt;Properties.h&gt;
+
+#include &lt;xercesc/framework/XMLFormatter.hpp&gt;
+
+#include &lt;ctime&gt;
+
+namespace rl
+{
+    class _RlCoreExport SaveGameFile : public PropertyHolder
+    {
+    public:
+        SaveGameFile(const CeGuiString &amp;name);
+        ~SaveGameFile();
+        CeGuiString buildFilename();
+        CeGuiString getName();
+        bool saveGameExists();
+
+        void setDataStream(const Ogre::DataStreamPtr &amp;stream);
+        Ogre::DataStreamPtr getDataStream() const;
+        XERCES_CPP_NAMESPACE::XMLFormatTarget* getFormatTarget();
+        void deleteFileFromStorage();
+
+        virtual const Property getProperty(const Ogre::String&amp; key) const;
+        virtual void setProperty(const Ogre::String&amp; key, const Property&amp; value);
+        virtual PropertySet* getAllProperties() const;
+    protected:
+        CeGuiString mName;
+        CeGuiString mModuleID;
+        CeGuiString mLocalTime;
+
+        Ogre::DataStreamPtr mStream;
+    };
+}
+
+#endif

Added: rl/trunk/engine/core/include/SaveGameFileReader.h
===================================================================
--- rl/trunk/engine/core/include/SaveGameFileReader.h	2007-09-27 21:26:30 UTC (rev 3883)
+++ rl/trunk/engine/core/include/SaveGameFileReader.h	2007-09-30 10:49:35 UTC (rev 3884)
@@ -0,0 +1,36 @@
+/* This source file is part of Rastullahs Lockenpracht.
+ * Copyright (C) 2003-2007 Team Pantheon. <A HREF="http://www.team-pantheon.de">http://www.team-pantheon.de</A>
+ *
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the Clarified Artistic License.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  Clarified Artistic License for more details.
+ *
+ *  You should have received a copy of the Clarified Artistic License
+ *  along with this program; if not you can get it here
+ *  <A HREF="http://www.jpaulmorrison.com/fbp/artistic2.htm.">http://www.jpaulmorrison.com/fbp/artistic2.htm.</A>
+ */
+
+#ifndef _SaveGameFileReader_H_
+#define _SaveGameFileReader_H_
+
+#include &quot;SaveGameFile.h&quot;
+#include &lt;XmlPropertyReader.h&gt;
+
+namespace rl
+{
+    class SaveGameData;
+    typedef std::set&lt;SaveGameData*&gt; SaveGameDataSet;
+
+    class _RlCoreExport SaveGameFileReader : public XmlPropertyReader
+    {
+    public:
+        SaveGameFileReader();
+        void parseSaveGameFile(SaveGameFile* file, const SaveGameDataSet &amp;set);
+    };
+}
+
+#endif //#ifndef _SaveGameFileReader_H_
\ No newline at end of file

Added: rl/trunk/engine/core/include/SaveGameFileWriter.h
===================================================================
--- rl/trunk/engine/core/include/SaveGameFileWriter.h	2007-09-27 21:26:30 UTC (rev 3883)
+++ rl/trunk/engine/core/include/SaveGameFileWriter.h	2007-09-30 10:49:35 UTC (rev 3884)
@@ -0,0 +1,40 @@
+/* This source file is part of Rastullahs Lockenpracht.
+* Copyright (C) 2003-2007 Team Pantheon. <A HREF="http://www.team-pantheon.de">http://www.team-pantheon.de</A>
+* 
+*  This program is free software; you can redistribute it and/or modify
+*  it under the terms of the Clarified Artistic License.
+*
+*  This program is distributed in the hope that it will be useful,
+*  but WITHOUT ANY WARRANTY; without even the implied warranty of
+*  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+*  Clarified Artistic License for more details.
+*
+*  You should have received a copy of the Clarified Artistic License
+*  along with this program; if not you can get it here
+*  <A HREF="http://www.jpaulmorrison.com/fbp/artistic2.htm.">http://www.jpaulmorrison.com/fbp/artistic2.htm.</A>
+*/
+
+#ifndef _SaveGameFileWriter_H_
+#define _SaveGameFileWriter_H_
+
+#include &quot;CorePrerequisites.h&quot;
+
+#include &lt;XmlPropertyWriter.h&gt;
+
+#include &quot;SaveGameFile.h&quot;
+
+namespace rl
+{
+    class SaveGameData;
+    typedef std::set&lt;SaveGameData*&gt; SaveGameDataSet;
+
+    class _RlCoreExport SaveGameFileWriter 
+        : public XmlPropertyWriter
+    {
+    public:
+        void buildSaveGameFile(SaveGameFile *file, const SaveGameDataSet &amp;set);
+    };
+}
+
+#endif
+

Added: rl/trunk/engine/core/include/SaveGameManager.h
===================================================================
--- rl/trunk/engine/core/include/SaveGameManager.h	2007-09-27 21:26:30 UTC (rev 3883)
+++ rl/trunk/engine/core/include/SaveGameManager.h	2007-09-30 10:49:35 UTC (rev 3884)
@@ -0,0 +1,78 @@
+/* 
+ * (C) 2003-2007. Team Pantheon. www.team-pantheon.de
+ * 
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the Clarified Artistic License.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  Clarified Artistic License for more details.
+ *
+ *  You should have received a copy of the Clarified Artistic License
+ *  along with this program; if not you can get it here:
+ *  <A HREF="http://www.jpaulmorrison.com/fbp/artistic2.htm">http://www.jpaulmorrison.com/fbp/artistic2.htm</A>
+ */
+#ifndef _SaveGameManager_H_
+#define _SaveGameManager_H_
+
+#include &quot;CorePrerequisites.h&quot;
+#include &quot;SaveGameFileWriter.h&quot;
+#include &quot;SaveGameFileReader.h&quot;
+#include &quot;SaveGameFile.h&quot;
+
+#include &lt;XmlPropertyWriter.h&gt;
+#include &lt;XmlPropertyReader.h&gt;
+
+namespace rl
+{
+    class _RlCoreExport SaveGameData
+    {
+    public:
+        SaveGameData();
+        virtual ~SaveGameData();
+        virtual CeGuiString getXmlNodeIdentifier() const = 0;
+        virtual void writeData(SaveGameFileWriter* writer) = 0;
+        virtual void readData(SaveGameFileReader* reader) = 0; //no reader yet
+    };
+
+    typedef std::set&lt;SaveGameData*&gt; SaveGameDataSet;
+
+    typedef std::map&lt;CeGuiString, SaveGameFile*&gt; SaveGameEntryMap;
+
+    class SaveGameHeaderReader : public XmlPropertyReader
+    {
+    public:
+        SaveGameHeaderReader();
+        void parseHeader(Ogre::DataStreamPtr &amp;stream, const Ogre::String &amp;groupName, SaveGameFile* file);
+    };
+
+    class _RlCoreExport SaveGameManager : public Ogre::Singleton&lt;SaveGameManager&gt;, public Ogre::ScriptLoader
+    {
+    public:
+        SaveGameManager(void);
+        virtual ~SaveGameManager(void);    
+
+        SaveGameEntryMap listSaveGames(void);
+        void saveSaveGameFile(const CeGuiString &amp;name);
+        void loadSaveGameFile(const CeGuiString &amp;name);
+        void deleteSaveGameFile(const CeGuiString &amp;name);
+        bool SaveGameFileExists(const CeGuiString &amp;name);
+
+        virtual const Ogre::StringVector&amp;  getScriptPatterns(void) const;
+        virtual void parseScript(Ogre::DataStreamPtr &amp;stream, const Ogre::String &amp;groupName);
+        virtual Ogre::Real getLoadingOrder(void) const;
+
+        void registerSaveGameData(SaveGameData* data);
+        void unregisterSaveGameData(SaveGameData* data);
+    protected:
+        void freeSaveGameMap();
+
+        Ogre::StringVector mScriptPatterns;
+        SaveGameEntryMap mSaveGames;
+
+        SaveGameDataSet mSaveGameDataSet;
+    };
+}
+
+#endif

Modified: rl/trunk/engine/core/src/CoreSubsystem.cpp
===================================================================
--- rl/trunk/engine/core/src/CoreSubsystem.cpp	2007-09-27 21:26:30 UTC (rev 3883)
+++ rl/trunk/engine/core/src/CoreSubsystem.cpp	2007-09-30 10:49:35 UTC (rev 3884)
@@ -40,6 +40,7 @@
 #include &quot;MessagePump.h&quot;
 #include &quot;PhysicsManager.h&quot;
 #include &quot;RubyInterpreter.h&quot;
+#include &quot;SaveGameManager.h&quot;
 #include &quot;ScriptWrapper.h&quot;
 #include &quot;SoundManager.h&quot;
 #include &quot;TimeSource.h&quot;
@@ -91,6 +92,7 @@
         delete mGameLoop;
         delete mMessagePump;
         delete mJobScheduler;
+        delete mSaveGameManager;
         delete mAnimationManager;
         delete mActorManager;
         delete mPhysicsManager;
@@ -290,6 +292,9 @@
         GameLoop::getSingleton().addTask(mDebugVisualsManager, GameLoop::TG_GRAPHICS);
         LOG_MESSAGE(Logger::CORE,&quot;DebugVisualsManager erzeugt&quot;);
 
+        mSaveGameManager = new SaveGameManager();
+        LOG_MESSAGE(Logger::RULES, &quot;SaveGameManager erzeugt&quot;);
+
         mJobScheduler = new JobScheduler();
         GameLoop::getSingleton().addTask(mJobScheduler, GameLoop::TG_GRAPHICS);
         LOG_MESSAGE(Logger::CORE,&quot;JobScheduler erzeugt&quot;);

Added: rl/trunk/engine/core/src/SaveGameFile.cpp
===================================================================
--- rl/trunk/engine/core/src/SaveGameFile.cpp	2007-09-27 21:26:30 UTC (rev 3883)
+++ rl/trunk/engine/core/src/SaveGameFile.cpp	2007-09-30 10:49:35 UTC (rev 3884)
@@ -0,0 +1,113 @@
+/* This source file is part of Rastullahs Lockenpracht.
+* Copyright (C) 2003-2007 Team Pantheon. <A HREF="http://www.team-pantheon.de">http://www.team-pantheon.de</A>
+* 
+*  This program is free software; you can redistribute it and/or modify
+*  it under the terms of the Clarified Artistic License.
+*
+*  This program is distributed in the hope that it will be useful,
+*  but WITHOUT ANY WARRANTY; without even the implied warranty of
+*  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+*  Clarified Artistic License for more details.
+*
+*  You should have received a copy of the Clarified Artistic License
+*  along with this program; if not you can get it here
+*  <A HREF="http://www.jpaulmorrison.com/fbp/artistic2.htm.">http://www.jpaulmorrison.com/fbp/artistic2.htm.</A>
+*/
+
+#include &quot;stdinc.h&quot; //precompiled header
+
+#include &quot;SaveGameFile.h&quot;
+#include &quot;OgreString.h&quot;
+#include &lt;xercesc/framework/LocalFileFormatTarget.hpp&gt;
+
+#include &lt;ConfigurationManager.h&gt;
+#include &lt;CoreSubsystem.h&gt;
+#include &lt;ContentModule.h&gt;
+
+namespace rl
+{
+
+    SaveGameFile::SaveGameFile(const CeGuiString &amp;name) : mStream((Ogre::DataStream*)NULL)
+    {
+        mName = name;
+    }
+
+    SaveGameFile::~SaveGameFile()
+    {
+        if(mStream.isNull())
+            delete mStream.get();
+    }
+
+    CeGuiString SaveGameFile::buildFilename()
+    {
+        return ConfigurationManager::getSingleton().getModulesRootDirectory() + /*&quot;/&quot; 
+            + CoreSubsystem::getSingleton().getActiveAdventureModule()-&gt;getId()*/ + &quot;/saves/&quot; + mName + &quot;.save&quot;;
+    }
+
+    CeGuiString SaveGameFile::getName()
+    {
+        return mName;
+    }
+
+    void SaveGameFile::setDataStream(const Ogre::DataStreamPtr &amp;stream)
+    {
+        mStream = stream;
+    }
+
+    Ogre::DataStreamPtr SaveGameFile::getDataStream() const
+    {
+        ///@todo: decryption
+        return mStream;
+    }
+
+    XERCES_CPP_NAMESPACE::XMLFormatTarget* SaveGameFile::getFormatTarget()
+    {
+        ///@todo: encryption
+        return new XERCES_CPP_NAMESPACE::LocalFileFormatTarget(this-&gt;buildFilename().c_str());
+    }
+
+    void SaveGameFile::deleteFileFromStorage()
+    {
+        if(remove(buildFilename().c_str()))
+            LOG_ERROR(Logger::RULES, &quot;SaveGameFile is not removed from filesystem. The file doesn't exists!&quot;);
+        else 
+            LOG_MESSAGE(Logger::RULES,&quot;SaveGameFile successfully removed from filesystem&quot;);
+    }
+
+    bool SaveGameFile::saveGameExists()
+    {
+        return !Ogre::DataStreamPtr( new Ogre::FileHandleDataStream(fopen(this-&gt;buildFilename().c_str(), &quot;r&quot;))).isNull();
+    }
+
+    const Property SaveGameFile::getProperty(const Ogre::String&amp; key) const
+    {
+        if(key == &quot;ModuleID&quot;)
+            return Property(mModuleID);
+        else if(key == &quot;Time&quot;)
+            return Property(mLocalTime);
+        else
+            return Property();
+    }
+
+    void SaveGameFile::setProperty(const Ogre::String&amp; key, const Property&amp; value)
+    {
+        if(key == &quot;ModuleID&quot;)
+        {
+            if(value.isString())
+                mModuleID = value.toString();
+        }
+        else if(key == &quot;Time&quot;)
+        {
+            if(value.isString())
+                mLocalTime = value.toString();
+        }
+    }
+
+    PropertySet* SaveGameFile::getAllProperties() const
+    {
+        PropertySet* set = new PropertySet();
+        set-&gt;setProperty(&quot;ModuleID&quot;, getProperty(&quot;ModuleID&quot;));
+        set-&gt;setProperty(&quot;Time&quot;, getProperty(&quot;Time&quot;));
+        return set;
+    }
+}

Added: rl/trunk/engine/core/src/SaveGameFileReader.cpp
===================================================================
--- rl/trunk/engine/core/src/SaveGameFileReader.cpp	2007-09-27 21:26:30 UTC (rev 3883)
+++ rl/trunk/engine/core/src/SaveGameFileReader.cpp	2007-09-30 10:49:35 UTC (rev 3884)
@@ -0,0 +1,43 @@
+/* This source file is part of Rastullahs Lockenpracht.
+ * Copyright (C) 2003-2007 Team Pantheon. <A HREF="http://www.team-pantheon.de">http://www.team-pantheon.de</A>
+ *
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the Clarified Artistic License.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  Clarified Artistic License for more details.
+ *
+ *  You should have received a copy of the Clarified Artistic License
+ *  along with this program; if not you can get it here
+ *  <A HREF="http://www.jpaulmorrison.com/fbp/artistic2.htm.">http://www.jpaulmorrison.com/fbp/artistic2.htm.</A>
+ */
+
+#include &quot;stdinc.h&quot;
+
+#include &lt;xercesc/dom/DOM.hpp&gt;
+
+#include &quot;SaveGameFileReader.h&quot;
+
+#include &quot;SaveGameManager.h&quot;
+
+using namespace XERCES_CPP_NAMESPACE;
+
+namespace rl
+{
+    SaveGameFileReader::SaveGameFileReader()
+    {
+    }
+
+    void SaveGameFileReader::parseSaveGameFile(SaveGameFile* file, const SaveGameDataSet &amp;set)
+    {
+        initializeXml();
+
+        DOMDocument* doc = loadDocument(file-&gt;getDataStream());
+
+        doc-&gt;release();
+
+        shutdownXml();
+    }
+}
\ No newline at end of file

Added: rl/trunk/engine/core/src/SaveGameFileWriter.cpp
===================================================================
--- rl/trunk/engine/core/src/SaveGameFileWriter.cpp	2007-09-27 21:26:30 UTC (rev 3883)
+++ rl/trunk/engine/core/src/SaveGameFileWriter.cpp	2007-09-30 10:49:35 UTC (rev 3884)
@@ -0,0 +1,146 @@
+/* This source file is part of Rastullahs Lockenpracht.
+* Copyright (C) 2003-2007 Team Pantheon. <A HREF="http://www.team-pantheon.de">http://www.team-pantheon.de</A>
+* 
+*  This program is free software; you can redistribute it and/or modify
+*  it under the terms of the Clarified Artistic License.
+*
+*  This program is distributed in the hope that it will be useful,
+*  but WITHOUT ANY WARRANTY; without even the implied warranty of
+*  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+*  Clarified Artistic License for more details.
+*
+*  You should have received a copy of the Clarified Artistic License
+*  along with this program; if not you can get it here
+*  <A HREF="http://www.jpaulmorrison.com/fbp/artistic2.htm.">http://www.jpaulmorrison.com/fbp/artistic2.htm.</A>
+*/
+
+#include &quot;stdinc.h&quot;
+
+#include &quot;SaveGameFileWriter.h&quot;
+
+#include &quot;SaveGameManager.h&quot;
+
+#include &lt;XmlProcessor.h&gt;
+#include &lt;xercesc/dom/DOM.hpp&gt;
+#include &lt;xercesc/dom/DOMAttr.hpp&gt;
+#include &lt;xercesc/dom/DOMElement.hpp&gt;
+#include &lt;Properties.h&gt;
+
+#include &lt;OgreResourceManager.h&gt;
+#include &lt;CEGUIPropertyHelper.h&gt;
+#include &lt;CoreSubsystem.h&gt;
+#include &lt;ContentModule.h&gt;
+#include &lt;TimeSource.h&gt;
+
+#include &lt;ctime&gt;
+
+using namespace XERCES_CPP_NAMESPACE;
+using namespace Ogre;
+
+namespace rl
+{
+    void SaveGameFileWriter::buildSaveGameFile(SaveGameFile *file, const SaveGameDataSet &amp;set)
+    {
+        //@toto: build
+        initializeXml();
+
+        XMLCh tempStr[100];
+        XMLString::transcode(&quot;LS&quot;, tempStr, 99);
+        mImplementation = DOMImplementationRegistry::getDOMImplementation(tempStr);
+        mWriter = static_cast&lt;DOMImplementationLS*&gt;(mImplementation)-&gt;createDOMWriter();
+        mTarget = file-&gt;getFormatTarget();
+        mDocument = static_cast&lt;DOMImplementation*&gt;(mImplementation)-&gt;createDocument(0, XMLString::transcode(&quot;SaveGameFile&quot;), 0);
+
+        if (mWriter-&gt;canSetFeature(XMLUni::fgDOMWRTDiscardDefaultContent, true))
+            mWriter-&gt;setFeature(XMLUni::fgDOMWRTDiscardDefaultContent, true);
+
+        if (mWriter-&gt;canSetFeature(XMLUni::fgDOMWRTFormatPrettyPrint, true))
+             mWriter-&gt;setFeature(XMLUni::fgDOMWRTFormatPrettyPrint, true);
+
+        mDocument-&gt;setNodeValue(XMLString::transcode(&quot;SaveGameFile&quot;)); //Set name of document root node
+
+        //Write SaveGameVersion
+        setAttributeValueAsString(mDocument-&gt;getDocumentElement(), &quot;Version&quot;, &quot;0.1&quot;);
+
+        //Write modul of save game
+        DOMElement* header = appendChildElement(mDocument, mDocument-&gt;getDocumentElement(), &quot;header&quot;);
+        
+        PropertySet* headerSet = file-&gt;getAllProperties();
+        for(PropertySetMap::const_iterator it_header = headerSet-&gt;begin(); it_header != headerSet-&gt;end(); it_header++)
+        {
+            this-&gt;processProperty(header, PropertyEntry(it_header-&gt;first.c_str(), it_header-&gt;second));
+        }
+
+        /*setAttributeValueAsString(header, &quot;ModuleID&quot;, CoreSubsystem::getSingleton().getActiveAdventureModule()-&gt;getId());
+        setAttributeValueAsInteger(header, &quot;EngineVersion&quot;, CoreSubsystem::getSingleton().getEngineBuildNumber());
+        setAttributeValueAsString(header, &quot;LocalTime&quot;, file-&gt;getProperty(&quot;Time&quot;).toString());*/
+
+        //Write date and time
+        //DOMElement* timeNode = appendChildElement(mDocument, mDocument-&gt;getDocumentElement(), &quot;time&quot;);
+        
+        /*tm* timeinfo = file-&gt;getLocalTime();
+
+        setAttributeValueAsInteger(timeNode, &quot;day&quot;, timeinfo-&gt;tm_mday);
+        setAttributeValueAsInteger(timeNode, &quot;month&quot;, timeinfo-&gt;tm_mon);
+        setAttributeValueAsInteger(timeNode, &quot;year&quot;, timeinfo-&gt;tm_year+1900);
+
+        setAttributeValueAsInteger(timeNode, &quot;hour&quot;, timeinfo-&gt;tm_hour);
+        setAttributeValueAsInteger(timeNode, &quot;minute&quot;, timeinfo-&gt;tm_min);
+        setAttributeValueAsInteger(timeNode, &quot;second&quot;, timeinfo-&gt;tm_sec);*/
+
+        //Write globals
+        DOMElement* globals = appendChildElement(mDocument, mDocument-&gt;getDocumentElement(), &quot;globals&quot;);
+        DOMElement* gameTime = appendChildElement(mDocument, globals, &quot;gametime&quot;);
+        TimeSource* gameTimeSource = TimeSourceManager::getSingleton().getTimeSource(TimeSource::GAMETIME);
+        setAttributeValueAsInteger(gameTime, &quot;milliseconds&quot;, gameTimeSource-&gt;getClock());
+
+        ////Write Quests
+        //DOMElement* quests = appendChildElement(mDocument, mDocument-&gt;getDocumentElement(), &quot;quests&quot;);
+        //QuestBook* questBook = RulesSubsystem::getSingleton().getQuestBook();
+        //PropertySet* set = questBook-&gt;getAllProperties();
+        //for(PropertySetMap::const_iterator it_quests = set-&gt;begin(); it_quests != set-&gt;end(); it_quests++)
+        //{
+        //    this-&gt;processProperty(quests, PropertyEntry(it_quests-&gt;first.c_str(), it_quests-&gt;second));
+        //}
+
+        ////Write game objects
+        //DOMElement* gameobjects = appendChildElement(mDocument, mDocument-&gt;getDocumentElement(), &quot;gameobjects&quot;);
+        //
+
+        //std::list&lt;const GameObject*&gt; gos = GameObjectManager::getSingleton().getAllGameObjects();
+
+        //for(std::list&lt;const GameObject*&gt;::const_iterator it_gameobjects = gos.begin(); it_gameobjects != gos.end(); it_gameobjects++)
+        //{
+        //    DOMElement* gameobject = appendChildElement(mDocument, gameobjects, &quot;gameobject&quot;);
+        //    setAttributeValueAsInteger(gameobject, &quot;ID&quot;, (*it_gameobjects)-&gt;getId());
+        //    setAttributeValueAsString(gameobject, &quot;ClassID&quot;, (*it_gameobjects)-&gt;getClassId());
+
+        //    PropertyMap map = (*it_gameobjects)-&gt;getAllProperties()-&gt;toPropertyMap();
+        //    PropertyMap::iterator it_properties;
+        //    for(it_properties = map.begin(); it_properties != map.end(); it_properties++)
+        //    {
+        //        this-&gt;processProperty(gameobject, PropertyEntry(it_properties-&gt;first.c_str(), it_properties-&gt;second));
+        //    }
+        //}        
+
+        ////Write Zones?
+
+        ////Write scripts
+        //DOMElement* scripts = appendChildElement(mDocument, mDocument-&gt;getDocumentElement(), &quot;scripts&quot;);
+
+        for(SaveGameDataSet::const_iterator data_iter = set.begin(); data_iter != set.end(); data_iter++)
+        {
+            (*data_iter)-&gt;writeData(this);
+        }
+
+        mWriter-&gt;writeNode(mTarget, *mDocument);
+
+
+        mWriter-&gt;release();
+
+        delete mDocument;
+        delete mTarget;
+
+        shutdownXml();
+    }
+}

Added: rl/trunk/engine/core/src/SaveGameManager.cpp
===================================================================
--- rl/trunk/engine/core/src/SaveGameManager.cpp	2007-09-27 21:26:30 UTC (rev 3883)
+++ rl/trunk/engine/core/src/SaveGameManager.cpp	2007-09-30 10:49:35 UTC (rev 3884)
@@ -0,0 +1,207 @@
+/* 
+ * (C) 2003-2007. Team Pantheon. www.team-pantheon.de
+ * 
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the Clarified Artistic License.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  Clarified Artistic License for more details.
+ *
+ *  You should have received a copy of the Clarified Artistic License
+ *  along with this program; if not you can get it here:
+ *  <A HREF="http://www.jpaulmorrison.com/fbp/artistic2.htm">http://www.jpaulmorrison.com/fbp/artistic2.htm</A>
+ */
+
+#include &quot;stdinc.h&quot;
+
+#include &quot;SaveGameManager.h&quot;
+
+#include &lt;CoreSubsystem.h&gt;
+#include &lt;ContentModule.h&gt;
+#include &lt;ConfigurationManager.h&gt;
+
+#include &lt;XmlProcessor.h&gt;
+
+#include &lt;xercesc/dom/DOM.hpp&gt;
+#include &lt;xercesc/framework/LocalFileFormatTarget.hpp&gt;
+
+template&lt;&gt; rl::SaveGameManager* Ogre::Singleton&lt;rl::SaveGameManager&gt;::ms_Singleton = 0;
+
+using namespace XERCES_CPP_NAMESPACE;
+
+namespace rl
+{
+    SaveGameData::SaveGameData()
+    {
+        SaveGameManager::getSingleton().registerSaveGameData(this);
+    }
+
+    SaveGameData::~SaveGameData()
+    {
+        SaveGameManager::getSingleton().unregisterSaveGameData(this);
+    }
+
+    CeGuiString printTimeAsString(tm* time)
+    {
+        CeGuiString string = ((Ogre::String)(Ogre::StringConverter::toString(time-&gt;tm_mday) + &quot;.&quot; 
+            + Ogre::StringConverter::toString(time-&gt;tm_mon) + &quot;.&quot;
+            + Ogre::StringConverter::toString(time-&gt;tm_year + 1900) + &quot; - &quot; 
+            + Ogre::StringConverter::toString(time-&gt;tm_hour) + &quot;:&quot;
+            + Ogre::StringConverter::toString(time-&gt;tm_min) + &quot;:&quot; 
+            + Ogre::StringConverter::toString(time-&gt;tm_sec))).c_str();
+        return string;
+    }
+
+    SaveGameHeaderReader::SaveGameHeaderReader()
+    {
+    }
+
+    void SaveGameHeaderReader::parseHeader(Ogre::DataStreamPtr &amp;stream, const Ogre::String &amp;groupName, SaveGameFile* file)
+    {
+        initializeXml();
+
+        if(stream-&gt;size())
+        {
+            DOMDocument* doc = loadDocument(stream);
+
+             DOMNodeList* headerDefsXml = doc-&gt;getDocumentElement()-&gt;getElementsByTagName(AutoXMLCh(&quot;header&quot;).data());
+             if(headerDefsXml-&gt;getLength())
+             {
+                 DOMElement* elem = static_cast&lt;DOMElement*&gt;(headerDefsXml-&gt;item(0));
+                 DOMNodeList* headerDefChildren = elem-&gt;getChildNodes();
+                 for(XMLSize_t childIdx = 0; childIdx &lt; headerDefChildren-&gt;getLength(); childIdx++)
+                 {
+                     DOMNode* curChild = headerDefChildren-&gt;item(childIdx);
+                     if (curChild-&gt;getNodeType() == DOMNode::ELEMENT_NODE)
+                     {
+                         PropertyEntry entry = processProperty(static_cast&lt;DOMElement*&gt;(curChild));
+                         if(entry.first != &quot;&quot;)
+                         {
+                            file-&gt;setProperty(entry.first, entry.second);
+                         }
+                     }
+                 }
+             }
+        }
+
+        shutdownXml();
+    }
+
+    SaveGameManager::SaveGameManager()
+    { 
+        Ogre::ResourceGroupManager::getSingleton().createResourceGroup(&quot;SaveGames&quot;);
+
+        mScriptPatterns.push_back(&quot;*.save&quot;);
+        Ogre::ResourceGroupManager::getSingleton()._registerScriptLoader(this);
+
+        Ogre::ResourceGroupManager::getSingleton().addResourceLocation(ConfigurationManager::getSingleton().getModulesRootDirectory() 
+            + &quot;/saves&quot;, &quot;FileSystem&quot;, &quot;SaveGames&quot;);
+        Ogre::ResourceGroupManager::getSingleton().initialiseResourceGroup(&quot;SaveGames&quot;);
+        Ogre::ResourceGroupManager::getSingleton().clearResourceGroup(&quot;SaveGames&quot;); //close all resource files -&gt; make them writable
+    }
+
+    SaveGameManager::~SaveGameManager()
+    {
+        freeSaveGameMap();
+    }
+
+    SaveGameEntryMap SaveGameManager::listSaveGames()
+    {
+        return mSaveGames;
+    }
+
+    void SaveGameManager::saveSaveGameFile(const CeGuiString &amp;name)
+    {
+        time_t rawTime;
+        tm* localTime; 
+        time(&amp;rawTime);
+        localTime = localtime(&amp;rawTime); 
+        SaveGameFile* file = new SaveGameFile(name);
+        file-&gt;setProperty(&quot;Time&quot;, Property(printTimeAsString(localTime)));
+        file-&gt;setProperty(&quot;ModuleID&quot;, Property(CoreSubsystem::getSingleton().getActiveAdventureModule()-&gt;getName()));
+
+        mSaveGames[name] = file;
+
+        SaveGameFileWriter writer;
+        writer.buildSaveGameFile(file, mSaveGameDataSet);
+
+        freeSaveGameMap();
+
+        Ogre::ResourceGroupManager::getSingleton().initialiseResourceGroup(&quot;SaveGames&quot;);
+        Ogre::ResourceGroupManager::getSingleton().clearResourceGroup(&quot;SaveGames&quot;); //close all resource files -&gt; make them writable
+    }
+
+    void SaveGameManager::loadSaveGameFile(const CeGuiString &amp;name)
+    {
+        if(SaveGameFileExists(name))
+        {
+            SaveGameFile file(name);
+            ///@todo: SaveGameReader
+        }
+    }
+
+    void SaveGameManager::deleteSaveGameFile(const CeGuiString &amp;name)
+    {
+        if(SaveGameFileExists(name))
+        {
+            static_cast&lt;SaveGameFile*&gt;(mSaveGames[name])-&gt;deleteFileFromStorage();
+            delete mSaveGames[name];
+            mSaveGames.erase(name);
+        }
+    }
+
+    bool SaveGameManager::SaveGameFileExists(const CeGuiString &amp;name)
+    {
+        if(mSaveGames.find(name) != mSaveGames.end())
+            return true;
+        return false;
+    }
+    
+    const Ogre::StringVector&amp; SaveGameManager::getScriptPatterns() const
+    {
+        return mScriptPatterns;
+    }
+
+    Ogre::Real SaveGameManager::getLoadingOrder() const
+    {
+        return 2000.0f;
+    }
+
+    void SaveGameManager::parseScript(Ogre::DataStreamPtr &amp;stream, const Ogre::String &amp;groupName)
+    {
+        Ogre::String name = stream-&gt;getName();
+        name = name.substr(0, name.length()-5); //delete &quot;.save&quot; at the and of the name
+
+        SaveGameFile* file = new SaveGameFile(name);
+        
+        LOG_MESSAGE(Logger::RULES, &quot;Parsing header of save game: &quot; + name);
+        SaveGameHeaderReader reader;
+        reader.parseHeader(stream, groupName, file);
+
+        Ogre::DataStream* _stream = new Ogre::MemoryDataStream(*stream, false); //making a copy of the data stream. searching for a better alternative
+        file-&gt;setDataStream(Ogre::DataStreamPtr(_stream));
+        
+        mSaveGames[name] = file;
+    }
+
+    void SaveGameManager::registerSaveGameData(SaveGameData* data)
+    {
+        mSaveGameDataSet.insert(data);
+    }
+
+    void SaveGameManager::unregisterSaveGameData(SaveGameData* data)
+    {
+        mSaveGameDataSet.erase(data);
+    }
+
+    void SaveGameManager::freeSaveGameMap()
+    {
+        for(SaveGameEntryMap::const_iterator iter = mSaveGames.begin(); iter != mSaveGames.end(); iter++)
+        {
+            delete iter-&gt;second;
+        }
+        mSaveGames.clear();
+    }
+}

Modified: rl/trunk/engine/rules/RlRules2005.vcproj
===================================================================
--- rl/trunk/engine/rules/RlRules2005.vcproj	2007-09-27 21:26:30 UTC (rev 3883)
+++ rl/trunk/engine/rules/RlRules2005.vcproj	2007-09-30 10:49:35 UTC (rev 3884)
@@ -403,18 +403,6 @@
 				&gt;
 			&lt;/File&gt;
 			&lt;File
-				RelativePath=&quot;.\src\SaveGameFile.cpp&quot;
-				&gt;
-			&lt;/File&gt;
-			&lt;File
-				RelativePath=&quot;.\src\SaveGameFileWriter.cpp&quot;
-				&gt;
-			&lt;/File&gt;
-			&lt;File
-				RelativePath=&quot;.\src\SaveGameManager.cpp&quot;
-				&gt;
-			&lt;/File&gt;
-			&lt;File
 				RelativePath=&quot;.\src\SelectionHelper.cpp&quot;
 				&gt;
 			&lt;/File&gt;
@@ -641,18 +629,6 @@
 				&gt;
 			&lt;/File&gt;
 			&lt;File
-				RelativePath=&quot;.\include\SaveGameFile.h&quot;
-				&gt;
-			&lt;/File&gt;
-			&lt;File
-				RelativePath=&quot;.\include\SaveGameFileWriter.h&quot;
-				&gt;
-			&lt;/File&gt;
-			&lt;File
-				RelativePath=&quot;.\include\SaveGameManager.h&quot;
-				&gt;
-			&lt;/File&gt;
-			&lt;File
 				RelativePath=&quot;.\include\SelectionHelper.h&quot;
 				&gt;
 			&lt;/File&gt;

Modified: rl/trunk/engine/rules/include/GameObjectManager.h
===================================================================
--- rl/trunk/engine/rules/include/GameObjectManager.h	2007-09-27 21:26:30 UTC (rev 3883)
+++ rl/trunk/engine/rules/include/GameObjectManager.h	2007-09-30 10:49:35 UTC (rev 3884)
@@ -20,6 +20,8 @@
 #include &quot;RulesPrerequisites.h&quot;
 #include &quot;GameObjectStateListener.h&quot;
 
+#include &lt;SaveGameManager.h&gt;
+
 #include &lt;OgreScriptLoader.h&gt;
 #include &lt;OgreSingleton.h&gt;
 #include &lt;map&gt;
@@ -42,7 +44,8 @@
     class _RlRulesExport GameObjectManager : 
         public Ogre::Singleton&lt;GameObjectManager&gt;,
         public GameObjectStateListener,
-        public Ogre::ScriptLoader
+        public Ogre::ScriptLoader,
+        public SaveGameData
     {
     public:
         GameObjectManager();
@@ -68,6 +71,13 @@
         void registerGameObjectStateListener(GameObjectStateListener* listener);
         void unregisterGameObjectStateListener(GameObjectStateListener* listener);
 
+        /// Override from SaveGameData
+        /// Manages saving and loading from the SaveGameFile
+
+        virtual CeGuiString getXmlNodeIdentifier() const;
+        virtual void writeData(SaveGameFileWriter* writer);
+        virtual void readData(SaveGameFileReader* reader);
+
     private:
         typedef std::map&lt;const Ogre::String, PropertySet*&gt; ClassPropertyMap;
         typedef std::set&lt;GameObjectStateListener*&gt; GameObjectStateListenerSet;

Modified: rl/trunk/engine/rules/include/QuestBook.h
===================================================================
--- rl/trunk/engine/rules/include/QuestBook.h	2007-09-27 21:26:30 UTC (rev 3883)
+++ rl/trunk/engine/rules/include/QuestBook.h	2007-09-30 10:49:35 UTC (rev 3884)
@@ -28,12 +28,17 @@
 #include &quot;QuestEvent.h&quot;
 #include &quot;QuestListener.h&quot;
 
+#include &lt;SaveGameManager.h&gt;
+
 #include &lt;vector&gt;
 
 namespace rl {
 
 ///@todo Rename this class to reflect scope changes.
-class _RlRulesExport QuestBook : public EventSource, public PropertyHolder
+class _RlRulesExport QuestBook : 
+    public EventSource, 
+    public PropertyHolder, 
+    public SaveGameData
 {
 public:
     static const Ogre::String PROPERTY_QUESTS;
@@ -75,6 +80,13 @@
     virtual void setProperty(const Ogre::String&amp; key, const Property&amp; value);
     virtual PropertySet* getAllProperties() const;
 
+    /// Override from SaveGameData
+    /// Manages saving and loading from the SaveGameFile
+
+    virtual CeGuiString getXmlNodeIdentifier() const;
+    virtual void writeData(SaveGameFileWriter* writer);
+    virtual void readData(SaveGameFileReader* reader);
+
 private:
 	Quest* getQuest(Quest* parent, const CeGuiString id) const;
     void clear();

Modified: rl/trunk/engine/rules/include/RulesSubsystem.h
===================================================================
--- rl/trunk/engine/rules/include/RulesSubsystem.h	2007-09-27 21:26:30 UTC (rev 3883)
+++ rl/trunk/engine/rules/include/RulesSubsystem.h	2007-09-30 10:49:35 UTC (rev 3884)
@@ -28,7 +28,6 @@
     class CombatManager;
     class DsaManager;
     class CreatureControllerManager;
-    class SaveGameManager;
     class XdimlLoader;
 
 	class _RlRulesExport RulesSubsystem : public Ogre::Singleton&lt;RulesSubsystem&gt;
@@ -46,7 +45,6 @@
         CombatManager* mCombatManager;
         DsaManager* mDsaManager;
         CreatureControllerManager *mMovingCreatureManager;
-        SaveGameManager* mSaveGameManager;
         XdimlLoader* mXdimlLoader;
     };
 }

Deleted: rl/trunk/engine/rules/include/SaveGameFile.h
===================================================================
--- rl/trunk/engine/rules/include/SaveGameFile.h	2007-09-27 21:26:30 UTC (rev 3883)
+++ rl/trunk/engine/rules/include/SaveGameFile.h	2007-09-30 10:49:35 UTC (rev 3884)
@@ -1,58 +0,0 @@
-/* This source file is part of Rastullahs Lockenpracht.
-* Copyright (C) 2003-2007 Team Pantheon. <A HREF="http://www.team-pantheon.de">http://www.team-pantheon.de</A>
-* 
-*  This program is free software; you can redistribute it and/or modify
-*  it under the terms of the Clarified Artistic License.
-*
-*  This program is distributed in the hope that it will be useful,
-*  but WITHOUT ANY WARRANTY; without even the implied warranty of
-*  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-*  Clarified Artistic License for more details.
-*
-*  You should have received a copy of the Clarified Artistic License
-*  along with this program; if not you can get it here
-*  <A HREF="http://www.jpaulmorrison.com/fbp/artistic2.htm.">http://www.jpaulmorrison.com/fbp/artistic2.htm.</A>
-*/
-
-#ifndef __SaveGameFile_H__
-#define __SaveGameFile_H__
-
-#include &quot;RulesPrerequisites.h&quot;
-#include &lt;OgreDataStream.h&gt;
-
-#include &lt;Property.h&gt;
-#include &lt;Properties.h&gt;
-
-#include &lt;xercesc/framework/XMLFormatter.hpp&gt;
-
-#include &lt;ctime&gt;
-
-namespace rl
-{
-    class _RlRulesExport SaveGameFile : public PropertyHolder
-    {
-    public:
-        SaveGameFile(const CeGuiString &amp;name);
-        ~SaveGameFile();
-        CeGuiString buildFilename();
-        CeGuiString getName();
-        bool saveGameExists();
-
-        void setDataStream(const Ogre::DataStreamPtr &amp;stream);
-        Ogre::DataStreamPtr getDataStream() const;
-        XERCES_CPP_NAMESPACE::XMLFormatTarget* getFormatTarget();
-        void deleteFileFromStorage();
-
-        virtual const Property getProperty(const Ogre::String&amp; key) const;
-        virtual void setProperty(const Ogre::String&amp; key, const Property&amp; value);
-        virtual PropertySet* getAllProperties() const;
-    protected:
-        CeGuiString mName;
-        CeGuiString mModuleID;
-        CeGuiString mLocalTime;
-
-        Ogre::DataStreamPtr mStream;
-    };
-}
-
-#endif

Deleted: rl/trunk/engine/rules/include/SaveGameFileWriter.h
===================================================================
--- rl/trunk/engine/rules/include/SaveGameFileWriter.h	2007-09-27 21:26:30 UTC (rev 3883)
+++ rl/trunk/engine/rules/include/SaveGameFileWriter.h	2007-09-30 10:49:35 UTC (rev 3884)
@@ -1,38 +0,0 @@
-/* This source file is part of Rastullahs Lockenpracht.
-* Copyright (C) 2003-2007 Team Pantheon. <A HREF="http://www.team-pantheon.de">http://www.team-pantheon.de</A>
-* 
-*  This program is free software; you can redistribute it and/or modify
-*  it under the terms of the Clarified Artistic License.
-*
-*  This program is distributed in the hope that it will be useful,
-*  but WITHOUT ANY WARRANTY; without even the implied warranty of
-*  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-*  Clarified Artistic License for more details.
-*
-*  You should have received a copy of the Clarified Artistic License
-*  along with this program; if not you can get it here
-*  <A HREF="http://www.jpaulmorrison.com/fbp/artistic2.htm.">http://www.jpaulmorrison.com/fbp/artistic2.htm.</A>
-*/
-
-#ifndef _SaveGameFileWriter_H_
-#define _SaveGameFileWriter_H_
-
-#include &quot;RulesPrerequisites.h&quot;
-
-#include &lt;XmlPropertyWriter.h&gt;
-
-#include &quot;GameObject.h&quot;
-#include &quot;SaveGameFile.h&quot;
-
-namespace rl
-{
-    class _RlRulesExport SaveGameFileWriter 
-        : protected XmlPropertyWriter
-    {
-    public:
-        void buildSaveGameFile(SaveGameFile *file);
-    };
-}
-
-#endif
-

Deleted: rl/trunk/engine/rules/include/SaveGameManager.h
===================================================================
--- rl/trunk/engine/rules/include/SaveGameManager.h	2007-09-27 21:26:30 UTC (rev 3883)
+++ rl/trunk/engine/rules/include/SaveGameManager.h	2007-09-30 10:49:35 UTC (rev 3884)
@@ -1,60 +0,0 @@
-/* 
- * (C) 2003-2007. Team Pantheon. www.team-pantheon.de
- * 
- *  This program is free software; you can redistribute it and/or modify
- *  it under the terms of the Clarified Artistic License.
- *
- *  This program is distributed in the hope that it will be useful,
- *  but WITHOUT ANY WARRANTY; without even the implied warranty of
- *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
- *  Clarified Artistic License for more details.
- *
- *  You should have received a copy of the Clarified Artistic License
- *  along with this program; if not you can get it here:
- *  <A HREF="http://www.jpaulmorrison.com/fbp/artistic2.htm">http://www.jpaulmorrison.com/fbp/artistic2.htm</A>
- */
-#ifndef _SaveGameManager_H_
-#define _SaveGameManager_H_
-
-#include &quot;RulesPrerequisites.h&quot;
-#include &quot;SaveGameFileWriter.h&quot;
-#include &quot;SaveGameFile.h&quot;
-
-#include &lt;XmlPropertyWriter.h&gt;
-#include &lt;XmlPropertyReader.h&gt;
-
-namespace rl
-{
-    typedef std::map&lt;CeGuiString, SaveGameFile*&gt; SaveGameEntryMap;
-
-    class SaveGameHeaderReader : public XmlPropertyReader
-    {
-    public:
-        SaveGameHeaderReader();
-        void parseHeader(Ogre::DataStreamPtr &amp;stream, const Ogre::String &amp;groupName, SaveGameFile* file);
-    };
-
-    class _RlRulesExport SaveGameManager : public Ogre::Singleton&lt;SaveGameManager&gt;, public Ogre::ScriptLoader
-    {
-    public:
-        SaveGameManager(void);
-        virtual ~SaveGameManager(void);    
-
-        SaveGameEntryMap listSaveGames(void);
-        void saveSaveGameFile(const CeGuiString &amp;name);
-        void loadSaveGameFile(const CeGuiString &amp;name);
-        void deleteSaveGameFile(const CeGuiString &amp;name);
-        bool SaveGameFileExists(const CeGuiString &amp;name);
-
-        virtual const Ogre::StringVector&amp;  getScriptPatterns(void) const;
-        virtual void parseScript(Ogre::DataStreamPtr &amp;stream, const Ogre::String &amp;groupName);
-        virtual Ogre::Real getLoadingOrder(void) const;
-    protected:
-        void freeSaveGameMap();
-
-        Ogre::StringVector mScriptPatterns;
-        SaveGameEntryMap mSaveGames;
-    };
-}
-
-#endif

Modified: rl/trunk/engine/rules/src/GameObjectManager.cpp
===================================================================
--- rl/trunk/engine/rules/src/GameObjectManager.cpp	2007-09-27 21:26:30 UTC (rev 3883)
+++ rl/trunk/engine/rules/src/GameObjectManager.cpp	2007-09-30 10:49:35 UTC (rev 3884)
@@ -253,4 +253,30 @@
 
         return createRubyGameObject(classname, id);
     }
+
+    CeGuiString GameObjectManager::getXmlNodeIdentifier() const
+    {
+        return &quot;gameobjects&quot;;
+    }
+    
+    void GameObjectManager::writeData(SaveGameFileWriter *writer)
+    {
+        XERCES_CPP_NAMESPACE::DOMElement* gameobjects = writer-&gt;appendChildElement(writer-&gt;getDocument(), writer-&gt;getDocument()-&gt;getDocumentElement(), &quot;gameobjects&quot;);
+
+        std::list&lt;const GameObject*&gt; gos = GameObjectManager::getSingleton().getAllGameObjects();
+
+        for(std::list&lt;const GameObject*&gt;::const_iterator it_gameobjects = gos.begin(); it_gameobjects != gos.end(); it_gameobjects++)
+        {
+            XERCES_CPP_NAMESPACE::DOMElement* gameobject = writer-&gt;appendChildElement(writer-&gt;getDocument(), gameobjects, &quot;gameobject&quot;);
+            writer-&gt;setAttributeValueAsInteger(gameobject, &quot;ID&quot;, (*it_gameobjects)-&gt;getId());
+            writer-&gt;setAttributeValueAsString(gameobject, &quot;ClassID&quot;, (*it_gameobjects)-&gt;getClassId());
+
+            PropertyMap map = (*it_gameobjects)-&gt;getAllProperties()-&gt;toPropertyMap();
+            writer-&gt;writeEachProperty(gameobject, map);
+        } 
+    }
+
+    void GameObjectManager::readData(rl::SaveGameFileReader *reader)
+    {
+    }
 }

Modified: rl/trunk/engine/rules/src/QuestBook.cpp
===================================================================
--- rl/trunk/engine/rules/src/QuestBook.cpp	2007-09-27 21:26:30 UTC (rev 3883)
+++ rl/trunk/engine/rules/src/QuestBook.cpp	2007-09-30 10:49:35 UTC (rev 3884)
@@ -241,4 +241,21 @@
         }
         return quests;
     }
+
+    CeGuiString QuestBook::getXmlNodeIdentifier() const
+    {
+        return &quot;questbook&quot;;
+    }
+
+    void QuestBook::writeData(SaveGameFileWriter *writer)
+    {
+        XERCES_CPP_NAMESPACE::DOMElement* quests = writer-&gt;appendChildElement(writer-&gt;getDocument(), writer-&gt;getDocument()-&gt;getDocumentElement(), &quot;quests&quot;);
+
+        PropertySet* set = getAllProperties();
+        writer-&gt;writeEachProperty(quests, set-&gt;toPropertyMap());
+    }
+
+    void QuestBook::readData(SaveGameFileReader* reader)
+    {
+    }
 }

Modified: rl/trunk/engine/rules/src/RulesSubsystem.cpp
===================================================================
--- rl/trunk/engine/rules/src/RulesSubsystem.cpp	2007-09-27 21:26:30 UTC (rev 3883)
+++ rl/trunk/engine/rules/src/RulesSubsystem.cpp	2007-09-30 10:49:35 UTC (rev 3884)
@@ -24,7 +24,6 @@
 #include &quot;EffectFactory.h&quot;
 #include &quot;Logger.h&quot;
 #include &quot;CreatureControllerManager.h&quot;
-#include &quot;SaveGameManager.h&quot;
 #include &quot;GameObjectManager.h&quot;
 #include &quot;QuestBook.h&quot;
 #include &quot;GameTimeSource.h&quot;
@@ -58,8 +57,6 @@
 		LOG_MESSAGE(Logger::RULES, &quot;DsaManager erzeugt&quot;);
         mMovingCreatureManager = new CreatureControllerManager();
 		LOG_MESSAGE(Logger::RULES, &quot;CreatureControllerManager erzeugt&quot;);
-        mSaveGameManager = new SaveGameManager();
-        LOG_MESSAGE(Logger::RULES, &quot;SaveGameManager erzeugt&quot;);
 		resetQuestBook();
 		LOG_MESSAGE(Logger::RULES, &quot;Questverwaltung erzeugt&quot;);
 
@@ -76,7 +73,6 @@
     {
         delete mQuestBook;
         delete mDsaManager;
-        delete mSaveGameManager;
         delete mMovingCreatureManager;
         delete mCombatManager;
         delete mActionManager;

Deleted: rl/trunk/engine/rules/src/SaveGameFile.cpp
===================================================================
--- rl/trunk/engine/rules/src/SaveGameFile.cpp	2007-09-27 21:26:30 UTC (rev 3883)
+++ rl/trunk/engine/rules/src/SaveGameFile.cpp	2007-09-30 10:49:35 UTC (rev 3884)
@@ -1,113 +0,0 @@
-/* This source file is part of Rastullahs Lockenpracht.
-* Copyright (C) 2003-2007 Team Pantheon. <A HREF="http://www.team-pantheon.de">http://www.team-pantheon.de</A>
-* 
-*  This program is free software; you can redistribute it and/or modify
-*  it under the terms of the Clarified Artistic License.
-*
-*  This program is distributed in the hope that it will be useful,
-*  but WITHOUT ANY WARRANTY; without even the implied warranty of
-*  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-*  Clarified Artistic License for more details.
-*
-*  You should have received a copy of the Clarified Artistic License
-*  along with this program; if not you can get it here
-*  <A HREF="http://www.jpaulmorrison.com/fbp/artistic2.htm.">http://www.jpaulmorrison.com/fbp/artistic2.htm.</A>
-*/
-
-#include &quot;stdinc.h&quot; //precompiled header
-
-#include &quot;SaveGameFile.h&quot;
-#include &quot;OgreString.h&quot;
-#include &lt;xercesc/framework/LocalFileFormatTarget.hpp&gt;
-
-#include &lt;ConfigurationManager.h&gt;
-#include &lt;CoreSubsystem.h&gt;
-#include &lt;ContentModule.h&gt;
-
-namespace rl
-{
-
-    SaveGameFile::SaveGameFile(const CeGuiString &amp;name) : mStream((Ogre::DataStream*)NULL)
-    {
-        mName = name;
-    }
-
-    SaveGameFile::~SaveGameFile()
-    {
-        if(mStream.isNull())
-            delete mStream.get();
-    }
-
-    CeGuiString SaveGameFile::buildFilename()
-    {
-        return ConfigurationManager::getSingleton().getModulesRootDirectory() + /*&quot;/&quot; 
-            + CoreSubsystem::getSingleton().getActiveAdventureModule()-&gt;getId()*/ + &quot;/saves/&quot; + mName + &quot;.save&quot;;
-    }
-
-    CeGuiString SaveGameFile::getName()
-    {
-        return mName;
-    }
-
-    void SaveGameFile::setDataStream(const Ogre::DataStreamPtr &amp;stream)
-    {
-        mStream = stream;
-    }
-
-    Ogre::DataStreamPtr SaveGameFile::getDataStream() const
-    {
-        ///@todo: decryption
-        return mStream;
-    }
-
-    XERCES_CPP_NAMESPACE::XMLFormatTarget* SaveGameFile::getFormatTarget()
-    {
-        ///@todo: encryption
-        return new XERCES_CPP_NAMESPACE::LocalFileFormatTarget(this-&gt;buildFilename().c_str());
-    }
-
-    void SaveGameFile::deleteFileFromStorage()
-    {
-        if(remove(buildFilename().c_str()))
-            LOG_ERROR(Logger::RULES, &quot;SaveGameFile is not removed from filesystem. The file doesn't exists!&quot;);
-        else 
-            LOG_MESSAGE(Logger::RULES,&quot;SaveGameFile successfully removed from filesystem&quot;);
-    }
-
-    bool SaveGameFile::saveGameExists()
-    {
-        return !Ogre::DataStreamPtr( new Ogre::FileHandleDataStream(fopen(this-&gt;buildFilename().c_str(), &quot;r&quot;))).isNull();
-    }
-
-    const Property SaveGameFile::getProperty(const Ogre::String&amp; key) const
-    {
-        if(key == &quot;ModuleID&quot;)
-            return Property(mModuleID);
-        else if(key == &quot;Time&quot;)
-            return Property(mLocalTime);
-        else
-            return Property();
-    }
-
-    void SaveGameFile::setProperty(const Ogre::String&amp; key, const Property&amp; value)
-    {
-        if(key == &quot;ModuleID&quot;)
-        {
-            if(value.isString())
-                mModuleID = value.toString();
-        }
-        else if(key == &quot;Time&quot;)
-        {
-            if(value.isString())
-                mLocalTime = value.toString();
-        }
-    }
-
-    PropertySet* SaveGameFile::getAllProperties() const
-    {
-        PropertySet* set = new PropertySet();
-        set-&gt;setProperty(&quot;ModuleID&quot;, getProperty(&quot;ModuleID&quot;));
-        set-&gt;setProperty(&quot;Time&quot;, getProperty(&quot;Time&quot;));
-        return set;
-    }
-}

Deleted: rl/trunk/engine/rules/src/SaveGameFileWriter.cpp
===================================================================
--- rl/trunk/engine/rules/src/SaveGameFileWriter.cpp	2007-09-27 21:26:30 UTC (rev 3883)
+++ rl/trunk/engine/rules/src/SaveGameFileWriter.cpp	2007-09-30 10:49:35 UTC (rev 3884)
@@ -1,143 +0,0 @@
-/* This source file is part of Rastullahs Lockenpracht.
-* Copyright (C) 2003-2007 Team Pantheon. <A HREF="http://www.team-pantheon.de">http://www.team-pantheon.de</A>
-* 
-*  This program is free software; you can redistribute it and/or modify
-*  it under the terms of the Clarified Artistic License.
-*
-*  This program is distributed in the hope that it will be useful,
-*  but WITHOUT ANY WARRANTY; without even the implied warranty of
-*  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-*  Clarified Artistic License for more details.
-*
-*  You should have received a copy of the Clarified Artistic License
-*  along with this program; if not you can get it here
-*  <A HREF="http://www.jpaulmorrison.com/fbp/artistic2.htm.">http://www.jpaulmorrison.com/fbp/artistic2.htm.</A>
-*/
-
-#include &quot;stdinc.h&quot;
-
-#include &quot;SaveGameFileWriter.h&quot;
-
-#include &lt;XmlProcessor.h&gt;
-#include &lt;xercesc/dom/DOM.hpp&gt;
-#include &lt;xercesc/dom/DOMAttr.hpp&gt;
-#include &lt;xercesc/dom/DOMElement.hpp&gt;
-#include &lt;Properties.h&gt;
-
-#include &quot;GameObjectManager.h&quot;
-#include &quot;QuestBook.h&quot;
-#include &quot;RulesSubsystem.h&quot;
-
-#include &lt;OgreResourceManager.h&gt;
-#include &lt;CEGUIPropertyHelper.h&gt;
-#include &lt;CoreSubsystem.h&gt;
-#include &lt;ContentModule.h&gt;
-#include &lt;TimeSource.h&gt;
-
-#include &lt;ctime&gt;
-
-using namespace XERCES_CPP_NAMESPACE;
-using namespace Ogre;
-
-namespace rl
-{
-    void SaveGameFileWriter::buildSaveGameFile(SaveGameFile *file)
-    {
-        //@toto: build
-        initializeXml();
-
-        XMLCh tempStr[100];
-        XMLString::transcode(&quot;LS&quot;, tempStr, 99);
-        mImplementation = DOMImplementationRegistry::getDOMImplementation(tempStr);
-        mWriter = static_cast&lt;DOMImplementationLS*&gt;(mImplementation)-&gt;createDOMWriter();
-        mTarget = file-&gt;getFormatTarget();
-        mDocument = static_cast&lt;DOMImplementation*&gt;(mImplementation)-&gt;createDocument(0, XMLString::transcode(&quot;SaveGameFile&quot;), 0);
-
-        if (mWriter-&gt;canSetFeature(XMLUni::fgDOMWRTDiscardDefaultContent, true))
-            mWriter-&gt;setFeature(XMLUni::fgDOMWRTDiscardDefaultContent, true);
-
-        if (mWriter-&gt;canSetFeature(XMLUni::fgDOMWRTFormatPrettyPrint, true))
-             mWriter-&gt;setFeature(XMLUni::fgDOMWRTFormatPrettyPrint, true);
-
-        mDocument-&gt;setNodeValue(XMLString::transcode(&quot;SaveGameFile&quot;)); //Set name of document root node
-
-        //Write SaveGameVersion
-        setAttributeValueAsString(mDocument-&gt;getDocumentElement(), &quot;Version&quot;, &quot;0.1&quot;);
-
-        //Write modul of save game
-        DOMElement* header = appendChildElement(mDocument, mDocument-&gt;getDocumentElement(), &quot;header&quot;);
-        
-        PropertySet* headerSet = file-&gt;getAllProperties();
-        for(PropertySetMap::const_iterator it_header = headerSet-&gt;begin(); it_header != headerSet-&gt;end(); it_header++)
-        {
-            this-&gt;processProperty(header, PropertyEntry(it_header-&gt;first.c_str(), it_header-&gt;second));
-        }
-
-        /*setAttributeValueAsString(header, &quot;ModuleID&quot;, CoreSubsystem::getSingleton().getActiveAdventureModule()-&gt;getId());
-        setAttributeValueAsInteger(header, &quot;EngineVersion&quot;, CoreSubsystem::getSingleton().getEngineBuildNumber());
-        setAttributeValueAsString(header, &quot;LocalTime&quot;, file-&gt;getProperty(&quot;Time&quot;).toString());*/
-
-        //Write date and time
-        //DOMElement* timeNode = appendChildElement(mDocument, mDocument-&gt;getDocumentElement(), &quot;time&quot;);
-        
-        /*tm* timeinfo = file-&gt;getLocalTime();
-
-        setAttributeValueAsInteger(timeNode, &quot;day&quot;, timeinfo-&gt;tm_mday);
-        setAttributeValueAsInteger(timeNode, &quot;month&quot;, timeinfo-&gt;tm_mon);
-        setAttributeValueAsInteger(timeNode, &quot;year&quot;, timeinfo-&gt;tm_year+1900);
-
-        setAttributeValueAsInteger(timeNode, &quot;hour&quot;, timeinfo-&gt;tm_hour);
-        setAttributeValueAsInteger(timeNode, &quot;minute&quot;, timeinfo-&gt;tm_min);
-        setAttributeValueAsInteger(timeNode, &quot;second&quot;, timeinfo-&gt;tm_sec);*/
-
-        //Write globals
-        DOMElement* globals = appendChildElement(mDocument, mDocument-&gt;getDocumentElement(), &quot;globals&quot;);
-        DOMElement* gameTime = appendChildElement(mDocument, globals, &quot;gametime&quot;);
-        TimeSource* gameTimeSource = TimeSourceManager::getSingleton().getTimeSource(TimeSource::GAMETIME);
-        setAttributeValueAsInteger(gameTime, &quot;milliseconds&quot;, gameTimeSource-&gt;getClock());
-
-        //Write Quests
-        DOMElement* quests = appendChildElement(mDocument, mDocument-&gt;getDocumentElement(), &quot;quests&quot;);
-        QuestBook* questBook = RulesSubsystem::getSingleton().getQuestBook();
-        PropertySet* set = questBook-&gt;getAllProperties();
-        for(PropertySetMap::const_iterator it_quests = set-&gt;begin(); it_quests != set-&gt;end(); it_quests++)
-        {
-            this-&gt;processProperty(quests, PropertyEntry(it_quests-&gt;first.c_str(), it_quests-&gt;second));
-        }
-
-        //Write game objects
-        DOMElement* gameobjects = appendChildElement(mDocument, mDocument-&gt;getDocumentElement(), &quot;gameobjects&quot;);
-        
-
-        std::list&lt;const GameObject*&gt; gos = GameObjectManager::getSingleton().getAllGameObjects();
-
-        for(std::list&lt;const GameObject*&gt;::const_iterator it_gameobjects = gos.begin(); it_gameobjects != gos.end(); it_gameobjects++)
-        {
-            DOMElement* gameobject = appendChildElement(mDocument, gameobjects, &quot;gameobject&quot;);
-            setAttributeValueAsInteger(gameobject, &quot;ID&quot;, (*it_gameobjects)-&gt;getId());
-            setAttributeValueAsString(gameobject, &quot;ClassID&quot;, (*it_gameobjects)-&gt;getClassId());
-
-            PropertyMap map = (*it_gameobjects)-&gt;getAllProperties()-&gt;toPropertyMap();
-            PropertyMap::iterator it_properties;
-            for(it_properties = map.begin(); it_properties != map.end(); it_properties++)
-            {
-                this-&gt;processProperty(gameobject, PropertyEntry(it_properties-&gt;first.c_str(), it_properties-&gt;second));
-            }
-        }        
-
-        //Write Zones?
-
-        //Write scripts
-        DOMElement* scripts = appendChildElement(mDocument, mDocument-&gt;getDocumentElement(), &quot;scripts&quot;);
-
-        mWriter-&gt;writeNode(mTarget, *mDocument);
-
-
-        mWriter-&gt;release();
-
-        delete mDocument;
-        delete mTarget;
-
-        shutdownXml();
-    }
-}

Deleted: rl/trunk/engine/rules/src/SaveGameManager.cpp
===================================================================
--- rl/trunk/engine/rules/src/SaveGameManager.cpp	2007-09-27 21:26:30 UTC (rev 3883)
+++ rl/trunk/engine/rules/src/SaveGameManager.cpp	2007-09-30 10:49:35 UTC (rev 3884)
@@ -1,187 +0,0 @@
-/* 
- * (C) 2003-2007. Team Pantheon. www.team-pantheon.de
- * 
- *  This program is free software; you can redistribute it and/or modify
- *  it under the terms of the Clarified Artistic License.
- *
- *  This program is distributed in the hope that it will be useful,
- *  but WITHOUT ANY WARRANTY; without even the implied warranty of
- *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
- *  Clarified Artistic License for more details.
- *
- *  You should have received a copy of the Clarified Artistic License
- *  along with this program; if not you can get it here:
- *  <A HREF="http://www.jpaulmorrison.com/fbp/artistic2.htm">http://www.jpaulmorrison.com/fbp/artistic2.htm</A>
- */
-
-#include &quot;stdinc.h&quot;
-
-#include &quot;SaveGameManager.h&quot;
-
-#include &lt;CoreSubsystem.h&gt;
-#include &lt;ContentModule.h&gt;
-#include &lt;ConfigurationManager.h&gt;
-
-#include &lt;XmlProcessor.h&gt;
-
-#include &lt;xercesc/dom/DOM.hpp&gt;
-#include &lt;xercesc/framework/LocalFileFormatTarget.hpp&gt;
-
-template&lt;&gt; rl::SaveGameManager* Ogre::Singleton&lt;rl::SaveGameManager&gt;::ms_Singleton = 0;
-
-using namespace XERCES_CPP_NAMESPACE;
-
-namespace rl
-{
-    CeGuiString printTimeAsString(tm* time)
-    {
-        CeGuiString string = ((Ogre::String)(Ogre::StringConverter::toString(time-&gt;tm_mday) + &quot;.&quot; 
-            + Ogre::StringConverter::toString(time-&gt;tm_mon) + &quot;.&quot;
-            + Ogre::StringConverter::toString(time-&gt;tm_year + 1900) + &quot; - &quot; 
-            + Ogre::StringConverter::toString(time-&gt;tm_hour) + &quot;:&quot;
-            + Ogre::StringConverter::toString(time-&gt;tm_min) + &quot;:&quot; 
-            + Ogre::StringConverter::toString(time-&gt;tm_sec))).c_str();
-        return string;
-    }
-
-    SaveGameHeaderReader::SaveGameHeaderReader()
-    {
-    }
-
-    void SaveGameHeaderReader::parseHeader(Ogre::DataStreamPtr &amp;stream, const Ogre::String &amp;groupName, SaveGameFile* file)
-    {
-        initializeXml();
-
-        if(stream-&gt;size())
-        {
-            DOMDocument* doc = loadDocument(stream);
-
-             DOMNodeList* headerDefsXml = doc-&gt;getDocumentElement()-&gt;getElementsByTagName(AutoXMLCh(&quot;header&quot;).data());
-             if(headerDefsXml-&gt;getLength())
-             {
-                 DOMElement* elem = static_cast&lt;DOMElement*&gt;(headerDefsXml-&gt;item(0));
-                 DOMNodeList* headerDefChildren = elem-&gt;getChildNodes();
-                 for(XMLSize_t childIdx = 0; childIdx &lt; headerDefChildren-&gt;getLength(); childIdx++)
-                 {
-                     DOMNode* curChild = headerDefChildren-&gt;item(childIdx);
-                     if (curChild-&gt;getNodeType() == DOMNode::ELEMENT_NODE)
-                     {
-                         PropertyEntry entry = processProperty(static_cast&lt;DOMElement*&gt;(curChild));
-                         if(entry.first != &quot;&quot;)
-                         {
-                            file-&gt;setProperty(entry.first, entry.second);
-                         }
-                     }
-                 }
-             }
-        }
-
-        shutdownXml();
-    }
-
-    SaveGameManager::SaveGameManager()
-    { 
-        Ogre::ResourceGroupManager::getSingleton().createResourceGroup(&quot;SaveGames&quot;);
-
-        mScriptPatterns.push_back(&quot;*.save&quot;);
-        Ogre::ResourceGroupManager::getSingleton()._registerScriptLoader(this);
-
-        Ogre::ResourceGroupManager::getSingleton().addResourceLocation(ConfigurationManager::getSingleton().getModulesRootDirectory() 
-            + &quot;/saves&quot;, &quot;FileSystem&quot;, &quot;SaveGames&quot;);
-        Ogre::ResourceGroupManager::getSingleton().initialiseResourceGroup(&quot;SaveGames&quot;);
-        Ogre::ResourceGroupManager::getSingleton().clearResourceGroup(&quot;SaveGames&quot;); //close all resource files -&gt; make them writable
-    }
-
-    SaveGameManager::~SaveGameManager()
-    {
-        freeSaveGameMap();
-    }
-
-    SaveGameEntryMap SaveGameManager::listSaveGames()
-    {
-        return mSaveGames;
-    }
-
-    void SaveGameManager::saveSaveGameFile(const CeGuiString &amp;name)
-    {
-        time_t rawTime;
-        tm* localTime; 
-        time(&amp;rawTime);
-        localTime = localtime(&amp;rawTime); 
-        SaveGameFile* file = new SaveGameFile(name);
-        file-&gt;setProperty(&quot;Time&quot;, Property(printTimeAsString(localTime)));
-        file-&gt;setProperty(&quot;ModuleID&quot;, Property(CoreSubsystem::getSingleton().getActiveAdventureModule()-&gt;getName()));
-
-        mSaveGames[name] = file;
-
-        SaveGameFileWriter writer;
-        writer.buildSaveGameFile(file);
-
-        freeSaveGameMap();
-
-        Ogre::ResourceGroupManager::getSingleton().initialiseResourceGroup(&quot;SaveGames&quot;);
-        Ogre::ResourceGroupManager::getSingleton().clearResourceGroup(&quot;SaveGames&quot;); //close all resource files -&gt; make them writable
-    }
-
-    void SaveGameManager::loadSaveGameFile(const CeGuiString &amp;name)
-    {
-        if(SaveGameFileExists(name))
-        {
-            SaveGameFile file(name);
-            ///@todo: SaveGameReader
-        }
-    }
-
-    void SaveGameManager::deleteSaveGameFile(const CeGuiString &amp;name)
-    {
-        if(SaveGameFileExists(name))
-        {
-            static_cast&lt;SaveGameFile*&gt;(mSaveGames[name])-&gt;deleteFileFromStorage();
-            delete mSaveGames[name];
-            mSaveGames.erase(name);
-        }
-    }
-
-    bool SaveGameManager::SaveGameFileExists(const CeGuiString &amp;name)
-    {
-        if(mSaveGames.find(name) != mSaveGames.end())
-            return true;
-        return false;
-    }
-    
-    const Ogre::StringVector&amp; SaveGameManager::getScriptPatterns() const
-    {
-        return mScriptPatterns;
-    }
-
-    Ogre::Real SaveGameManager::getLoadingOrder() const
-    {
-        return 2000.0f;
-    }
-
-    void SaveGameManager::parseScript(Ogre::DataStreamPtr &amp;stream, const Ogre::String &amp;groupName)
-    {
-        Ogre::String name = stream-&gt;getName();
-        name = name.substr(0, name.length()-5); //delete &quot;.save&quot; at the and of the name
-
-        SaveGameFile* file = new SaveGameFile(name);
-        
-        LOG_MESSAGE(Logger::RULES, &quot;Parsing header of save game: &quot; + name);
-        SaveGameHeaderReader reader;
-        reader.parseHeader(stream, groupName, file);
-
-        Ogre::DataStream* _stream = new Ogre::MemoryDataStream(*stream, false); //making a copy of the data stream. searching for a better alternative
-        file-&gt;setDataStream(Ogre::DataStreamPtr(_stream));
-        
-        mSaveGames[name] = file;
-    }
-
-    void SaveGameManager::freeSaveGameMap()
-    {
-        for(SaveGameEntryMap::const_iterator iter = mSaveGames.begin(); iter != mSaveGames.end(); iter++)
-        {
-            delete iter-&gt;second;
-        }
-        mSaveGames.clear();
-    }
-}

Modified: rl/trunk/engine/ui/src/SaveLoadWindow.cpp
===================================================================
--- rl/trunk/engine/ui/src/SaveLoadWindow.cpp	2007-09-27 21:26:30 UTC (rev 3883)
+++ rl/trunk/engine/ui/src/SaveLoadWindow.cpp	2007-09-30 10:49:35 UTC (rev 3884)
@@ -31,6 +31,8 @@
 #include &lt;OgreResourceGroupManager.h&gt;
 
 #include &quot;SaveLoadWindow.h&quot;
+#include &quot;MessageWindow.h&quot;
+#include &quot;WindowFactory.h&quot;
 #include &quot;ConfigurationManager.h&quot;
 #include &quot;SaveGameManager.h&quot;
 
@@ -104,6 +106,18 @@
     bool SaveLoadWindow::handleLoadEvent()
     {
         LOG_MESSAGE(Logger::UI, &quot;Load Button pressed&quot;);
+
+        CeGuiString filename = mFilename-&gt;getText();
+
+        if(filename != &quot;&quot;)
+        {
+
+            if(SaveGameManager::getSingleton().SaveGameFileExists(filename))
+                SaveGameManager::getSingleton().loadSaveGameFile(filename);
+            else
+                LOG_ERROR(Logger::UI, &quot;Save Game &quot; + filename + &quot; doesn't exist!&quot;);
+        }
+
         return true;
     }
 
@@ -113,27 +127,21 @@
     {
         LOG_MESSAGE(Logger::UI, &quot;Save Button pressed&quot;);
 
-        LOG_MESSAGE(Logger::UI, &quot;Create a SaveGameFile&quot;);
+        CeGuiString filename = mFilename-&gt;getText();
 
-        //SaveGameFile saveGameFile(mFilename-&gt;getText());
+        if(filename != &quot;&quot;)
+        {
+            LOG_MESSAGE(Logger::UI, &quot;Create a SaveGameFile&quot;);
 
-        /*std::list&lt;const GameObject*&gt;::const_iterator it;
-        std::list&lt;const GameObject*&gt; gos;
-        gos = GameObjectManager::getSingleton().getAllGameObjects();
+            SaveGameManager::getSingleton().saveSaveGameFile(filename);
 
-        std::vector&lt;PropertySet*&gt; sets;
-        for( it=gos.begin(); it!=gos.end(); ++it )
+            LOG_MESSAGE(Logger::UI, &quot;Created save game&quot;);
+        }
+        else
         {
-            sets.push_back((*it)-&gt;getAllProperties());
-        }*/
-        //SaveGameFileWriter saveGameFileWriter;
-        //saveGameFileWriter.setPropertySets(sets);
-        //saveGameFileWriter.buildSaveGameFile(&amp;saveGameFile);
+            WindowFactory::getSingleton().showMessageWindow(&quot;Bitte einen Namen f&#252;r den Spielstand eingeben&quot;);
+        }
 
-        SaveGameManager::getSingleton().saveSaveGameFile(mFilename-&gt;getText());
-
-        LOG_MESSAGE(Logger::UI, &quot;Created save game&quot;);
-
         listSaveGames();
 
         return true;
@@ -164,6 +172,8 @@
             mSaveGameTable-&gt;setItem(new CEGUI::ListboxTextItem(it-&gt;second-&gt;getProperty(&quot;Time&quot;)), 1, saveGameNum);
             saveGameNum++;
         }
+        mSaveGameTable-&gt;autoSizeColumnHeader(0);
+        mSaveGameTable-&gt;autoSizeColumnHeader(1);
     }
 
 } // namespace rl


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000954.html">[Dsa-hl-svn] r3883 - rl/trunk/engine/common/include
</A></li>
	<LI>Next message: <A HREF="000956.html">[Dsa-hl-svn] r3885 - in rl/trunk/engine: core/include core/src	rules/include rules/src
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#955">[ date ]</a>
              <a href="thread.html#955">[ thread ]</a>
              <a href="subject.html#955">[ subject ]</a>
              <a href="author.html#955">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/dsa-hl-svn">More information about the Dsa-hl-svn
mailing list</a><br>
</body></html>
