<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Dsa-hl-svn] r3223 - modules/common/gui/imagesets	modules/common/gui/windows modules/common/scripts	modules/regressiontest/dsa modules/regressiontest/scripts	rl/trunk/engine/rules/include rl/trunk/engine/rules/src	rl/trunk/engine/script/swig rl/trunk/engine/ui	rl/trunk/engine/ui/include rl/trunk/engine/ui/src
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/dsa-hl-svn/2007-April/index.html" >
   <LINK REL="made" HREF="mailto:dsa-hl-svn%40lists.berlios.de?Subject=Re%3A%20%5BDsa-hl-svn%5D%20r3223%20-%20modules/common/gui/imagesets%0A%09modules/common/gui/windows%20modules/common/scripts%0A%09modules/regressiontest/dsa%20modules/regressiontest/scripts%0A%09rl/trunk/engine/rules/include%20rl/trunk/engine/rules/src%0A%09rl/trunk/engine/script/swig%20rl/trunk/engine/ui%0A%09rl/trunk/engine/ui/include%20rl/trunk/engine/ui/src&In-Reply-To=%3C200704021854.l32IsJ8j017499%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000293.html">
   <LINK REL="Next"  HREF="000295.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Dsa-hl-svn] r3223 - modules/common/gui/imagesets	modules/common/gui/windows modules/common/scripts	modules/regressiontest/dsa modules/regressiontest/scripts	rl/trunk/engine/rules/include rl/trunk/engine/rules/src	rl/trunk/engine/script/swig rl/trunk/engine/ui	rl/trunk/engine/ui/include rl/trunk/engine/ui/src</H1>
    <B>blakharaz at mail.berlios.de</B> 
    <A HREF="mailto:dsa-hl-svn%40lists.berlios.de?Subject=Re%3A%20%5BDsa-hl-svn%5D%20r3223%20-%20modules/common/gui/imagesets%0A%09modules/common/gui/windows%20modules/common/scripts%0A%09modules/regressiontest/dsa%20modules/regressiontest/scripts%0A%09rl/trunk/engine/rules/include%20rl/trunk/engine/rules/src%0A%09rl/trunk/engine/script/swig%20rl/trunk/engine/ui%0A%09rl/trunk/engine/ui/include%20rl/trunk/engine/ui/src&In-Reply-To=%3C200704021854.l32IsJ8j017499%40sheep.berlios.de%3E"
       TITLE="[Dsa-hl-svn] r3223 - modules/common/gui/imagesets	modules/common/gui/windows modules/common/scripts	modules/regressiontest/dsa modules/regressiontest/scripts	rl/trunk/engine/rules/include rl/trunk/engine/rules/src	rl/trunk/engine/script/swig rl/trunk/engine/ui	rl/trunk/engine/ui/include rl/trunk/engine/ui/src">blakharaz at mail.berlios.de
       </A><BR>
    <I>Mon Apr  2 20:54:19 CEST 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="000293.html">[Dsa-hl-svn] r3222 - in rl/trunk/engine/rules: include src
</A></li>
        <LI>Next message: <A HREF="000295.html">[Dsa-hl-svn] r3224 - rl/trunk/engine/rules/src
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#294">[ date ]</a>
              <a href="thread.html#294">[ thread ]</a>
              <a href="subject.html#294">[ subject ]</a>
              <a href="author.html#294">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: blakharaz
Date: 2007-04-02 20:53:55 +0200 (Mon, 02 Apr 2007)
New Revision: 3223

Added:
   rl/trunk/engine/ui/include/ItemDragContainer.h
   rl/trunk/engine/ui/src/ItemDragContainer.cpp
Modified:
   modules/common/gui/imagesets/ModelThumbnails.imageset
   modules/common/gui/windows/inventory_human.xml
   modules/common/scripts/hero.rb
   modules/regressiontest/dsa/gameobjectdefinitions.gof
   modules/regressiontest/scripts/InventoryTest.rb
   rl/trunk/engine/rules/include/Container.h
   rl/trunk/engine/rules/include/Inventory.h
   rl/trunk/engine/rules/src/Container.cpp
   rl/trunk/engine/rules/src/Inventory.cpp
   rl/trunk/engine/rules/src/Slot.cpp
   rl/trunk/engine/script/swig/RlRules.swig
   rl/trunk/engine/ui/RlUI2005.vcproj
   rl/trunk/engine/ui/include/AbstractWindow.h
   rl/trunk/engine/ui/include/InventoryWindow.h
   rl/trunk/engine/ui/include/Makefile.am
   rl/trunk/engine/ui/src/ContainerContentWindow.cpp
   rl/trunk/engine/ui/src/InventoryWindow.cpp
   rl/trunk/engine/ui/src/Makefile.am
Log:
Inventory
- now reacts on drag and drop between slots and container windows
- removed container tabs from inventory window (all containers can be inspected in their own windows)

Modified: modules/common/gui/imagesets/ModelThumbnails.imageset
===================================================================
--- modules/common/gui/imagesets/ModelThumbnails.imageset	2007-04-02 18:41:56 UTC (rev 3222)
+++ modules/common/gui/imagesets/ModelThumbnails.imageset	2007-04-02 18:53:55 UTC (rev 3223)
@@ -1,5 +1,6 @@
 &lt;?xml version=&quot;1.0&quot; ?&gt;
 &lt;Imageset Name=&quot;ModelThumbnails&quot; Imagefile=&quot;ModelThumbnails.png&quot; NativeHorzRes=&quot;256&quot; NativeVertRes=&quot;256&quot; AutoScaled=&quot;false&quot; &gt;
+    &lt;Image Name=&quot;item_unknown&quot; XPos=&quot;1&quot; YPos=&quot;55&quot; Width=&quot;30&quot; Height=&quot;30&quot;/&gt;
     &lt;Image Name=&quot;Trank&quot; XPos=&quot;1&quot; YPos=&quot;1&quot; Width=&quot;30&quot; Height=&quot;30&quot; /&gt;
 	&lt;Image Name=&quot;Handschuhe&quot; XPos=&quot;26&quot; YPos=&quot;1&quot; Width=&quot;60&quot; Height=&quot;60&quot; /&gt;
 	&lt;Image Name=&quot;Rucksack&quot; XPos=&quot;94&quot; YPos=&quot;1&quot; Width=&quot;60&quot; Height=&quot;60&quot; /&gt;

Modified: modules/common/gui/windows/inventory_human.xml
===================================================================
--- modules/common/gui/windows/inventory_human.xml	2007-04-02 18:41:56 UTC (rev 3222)
+++ modules/common/gui/windows/inventory_human.xml	2007-04-02 18:53:55 UTC (rev 3223)
@@ -2,12 +2,12 @@
     &lt;Window Type=&quot;RastullahLook/FrameWindow&quot; Name=&quot;InventoryWindow&quot;&gt;
 		&lt;Property Name=&quot;VerticalAlignment&quot; Value=&quot;Centre&quot; /&gt;
 		&lt;Property Name=&quot;HorizontalAlignment&quot; Value=&quot;Centre&quot; /&gt;
-		&lt;Property Name=&quot;UnifiedSize&quot; Value=&quot;{{0,830},{0,560}}&quot; /&gt;
+		&lt;Property Name=&quot;UnifiedSize&quot; Value=&quot;{{0,420},{0,560}}&quot; /&gt;
 		&lt;Property Name=&quot;Text&quot; Value=&quot;Inventar&quot; /&gt;
 		
 		&lt;Window Type=&quot;RastullahLook/InventoryBackground&quot; Name=&quot;InventoryWindow/Slots&quot;&gt;
 			&lt;Property Name=&quot;UnifiedPosition&quot; Value=&quot;{{0,5},{0,5}}&quot; /&gt;
-			&lt;Property Name=&quot;UnifiedSize&quot; Value=&quot;{{0,820},{0,540}}&quot; /&gt;
+			&lt;Property Name=&quot;UnifiedSize&quot; Value=&quot;{{0,400},{0,540}}&quot; /&gt;
 			
 			&lt;Window Type=&quot;RastullahLook/Container&quot; Name=&quot;InventoryWindow/Slots/Head&quot;&gt;
 				&lt;Property Name=&quot;UnifiedPosition&quot; Value=&quot;{{0.0,150},{0,40}}&quot; /&gt;
@@ -94,68 +94,8 @@
 				&lt;Property Name=&quot;UnifiedPosition&quot; Value=&quot;{{0,270},{0,280}}&quot; /&gt;
 				&lt;Property Name=&quot;UnifiedSize&quot; Value=&quot;{{0,60},{0,120}}&quot; /&gt;
 			&lt;/Window&gt;
-			
-						
-			
-			&lt;!--
-			*** Helden wechsel ***
-			
-			&lt;Window Type=&quot;RastullahLook/Listbox&quot; Name=&quot;InventoryWindow/Heroes&quot;&gt;
-				&lt;Property Name=&quot;Text&quot; Value=&quot;Heroes&quot;/&gt;
-				&lt;Property Name=&quot;UnifiedAreaRect&quot; Value=&quot;{{0,30},{0,475},{0,330},{0,525}}&quot; /&gt;
-			&lt;/Window&gt;
-			--&gt;
-			&lt;!-- Rechte Seite --&gt; 
-			
-			&lt;!-- Itembild --&gt;
-			&lt;Window Type=&quot;RastullahLook/StaticImage&quot; Name=&quot;InventoryWindow/ItemPicture&quot;&gt;
-				&lt;Property Name=&quot;Text&quot; Value=&quot;Itempicture&quot;/&gt;
-				&lt;Property Name=&quot;UnifiedAreaRect&quot; Value=&quot;{{0,370},{0,20},{0,498},{0,148}}&quot; /&gt;
-			&lt;/Window&gt;
-			
-			&lt;Window Type=&quot;RastullahLook/ScrollablePane&quot; Name=&quot;InventoryWindow/Description&quot;&gt;
-				&lt;Property Name=&quot;Text&quot; Value=&quot;&quot;/&gt;
-				&lt;Property Name=&quot;UnifiedAreaRect&quot; Value=&quot;{{0,508},{0,20},{1,-25},{0,148}}&quot; /&gt;
-			&lt;/Window&gt;
-	
-			&lt;Window Type=&quot;RastullahLook/MultiLineEditbox&quot; Name=&quot;InventoryWindow/Infos&quot;&gt;
-				&lt;Property Name=&quot;Font&quot; Value=&quot;Vera Serif-10&quot; /&gt;
-                &lt;!--&lt;Property Name=&quot;FrameEnabled&quot; Value=&quot;false&quot; /&gt;--&gt;
-				&lt;Property Name=&quot;Text&quot; Value=&quot;BE: 0, AT: 5, Traglast: 0 Stein, Max: 50 Stein, Guthaben: 5 Dukaten, Ausdauer: 25&quot;/&gt;
-				
-				&lt;Property Name=&quot;UnifiedAreaRect&quot; Value=&quot;{{0,370},{0,158},{1,-25},{0,210}}&quot; /&gt;
-			&lt;/Window&gt;
-				
-			&lt;Window Type=&quot;RastullahLook/TabControl&quot; Name=&quot;InventoryWindow/Tabs&quot;&gt;
-				&lt;Property Name=&quot;UnifiedAreaRect&quot; Value=&quot;{{0,370},{0,220},{1,-25},{0.9,-20}}&quot; /&gt;
-			&lt;/Window&gt;
-			
-			&lt;!-- Das Ruestungsfenster --&gt;
-			&lt;Window Type=&quot;RastullahLook/TransparentStaticImage&quot; Name=&quot;InventoryWindow/ArmorValueWindow&quot;&gt;
-				&lt;Property Name=&quot;UnifiedPosition&quot; Value=&quot;{{0,370},{0,475}}&quot; /&gt;
-				&lt;Property Name=&quot;UnifiedSize&quot; Value=&quot;{{0,50},{0,50}}&quot; /&gt;
-				
-				&lt;Window Type=&quot;RastullahLook/TransparentStaticText&quot; Name=&quot;InventoryWindow/ArmorValue&quot;&gt;
-					&lt;Property Name=&quot;UnifiedPosition&quot; Value=&quot;{{0,6},{0,0}}&quot; /&gt;
-					&lt;Property Name=&quot;UnifiedSize&quot; Value=&quot;{{1,0},{0.67,0}}&quot; /&gt;
-				&lt;/Window&gt;
-				
-				&lt;Window Type=&quot;RastullahLook/TransparentStaticText&quot; Name=&quot;InventoryWindow/HandicapValue&quot;&gt;
-					&lt;Property Name=&quot;UnifiedPosition&quot; Value=&quot;{{0,24},{0,0}}&quot; /&gt;
-					&lt;Property Name=&quot;UnifiedSize&quot; Value=&quot;{{1,0},{0.67,0}}&quot; /&gt;
-				&lt;/Window&gt;
-			&lt;/Window&gt;
-			&lt;!-- Das Gewichtsfenster --&gt;
-			&lt;Window Type=&quot;RastullahLook/TransparentStaticImage&quot; Name=&quot;InventoryWindow/WeightWindow&quot;&gt;
-				&lt;Property Name=&quot;UnifiedPosition&quot; Value=&quot;{{0,430},{0,475}}&quot; /&gt;
-				&lt;Property Name=&quot;UnifiedSize&quot; Value=&quot;{{0,45},{0,50}}&quot; /&gt;
 
-				&lt;Window Type=&quot;RastullahLook/TransparentStaticText&quot; Name=&quot;InventoryWindow/TotalWeight&quot;&gt;
-					&lt;Property Name=&quot;UnifiedPosition&quot; Value=&quot;{{0,6},{0,4}}&quot; /&gt;
-					&lt;Property Name=&quot;UnifiedSize&quot; Value=&quot;{{1,0},{1,-4}}&quot; /&gt;
-				&lt;/Window&gt;
-			&lt;/Window&gt;
-			
+				
 		&lt;/Window&gt;
 	&lt;/Window&gt;
 &lt;/GUILayout&gt;

Modified: modules/common/scripts/hero.rb
===================================================================
--- modules/common/scripts/hero.rb	2007-04-02 18:41:56 UTC (rev 3222)
+++ modules/common/scripts/hero.rb	2007-04-02 18:53:55 UTC (rev 3223)
@@ -3,9 +3,9 @@
 class Hero &lt; Person
     def initialize(id)
         super(id);
-	setName(&quot;Alrike&quot;);
-	setDescription(&quot;Heldin von Berufung&quot;);
-	$SCRIPT.log(&quot;Gute Eigenschaften zuweisen...&quot;);
+		setName(&quot;Alrike&quot;);
+		setDescription(&quot;Heldin von Berufung&quot;);
+		$SCRIPT.log(&quot;Gute Eigenschaften zuweisen...&quot;);
 
         setEigenschaft(&quot;MU&quot;, 12);
         setEigenschaft(&quot;KL&quot;, 8);
@@ -17,30 +17,30 @@
         setEigenschaft(&quot;KK&quot;, 14); #KK
         setWert(2, 10); # LE-Mod
 
-	$SCRIPT.log(&quot;LeP und AuP auff&#195;&#188;llen&quot;);
+		$SCRIPT.log(&quot;LeP und AuP auff&#195;&#188;llen&quot;);
         modifyLe(1000, false); # LeP = LE
         modifyAu(1000); # Au = voll
-        # modifyLe(-20); # 10 LeP abziehen
+        #modifyLe(-20); # 10 LeP abziehen
 
-	$SCRIPT.log(&quot;Talente hinzuf&#195;&#188;gen&quot;);
-	addTalent(&quot;Athletik&quot;, 3);
-	#addTalent(&quot;K&#195;&#182;rperbeherrschung&quot;, 3);
+		$SCRIPT.log(&quot;Talente hinzuf&#195;&#188;gen&quot;);
+		addTalent(&quot;Athletik&quot;, 3);
+		#addTalent(&quot;K&#195;&#182;rperbeherrschung&quot;, 3);
 
         $SCRIPT.log(&quot;Heldenaktor beschreiben...&quot;);
         setProperty(&quot;meshfile&quot;, &quot;men_alrike.mesh&quot;)
-	setProperty(&quot;physicsbody&quot;, PhysicsManager::GT_ELLIPSOID)
-	setProperty(&quot;mass&quot;, 75.0);
+		setProperty(&quot;physicsbody&quot;, PhysicsManager::GT_ELLIPSOID)
+		setProperty(&quot;mass&quot;, 75.0);
+	
+		$SCRIPT.log(&quot;Inventar konfigurieren.&quot;);
+		inv = getInventory();
+		inv.addSlot(&quot;Left Ring&quot;, &quot;l_finger_2&quot;, Item::ITEMTYPE_RING);
+		inv.addSlot(&quot;Right Ring&quot;, &quot;r_finger_2&quot;, Item::ITEMTYPE_RING);
+		inv.addSlot(&quot;Left Hand&quot;, &quot;l_hand&quot;, Item::ITEMTYPE_ALL_ITEMS);
+		inv.addSlot(&quot;Right Hand&quot;, &quot;r_hand&quot;, Item::ITEMTYPE_ALL_ITEMS);
+		inv.addSlot(&quot;Head&quot;, &quot;kopf&quot;, Item::ITEMTYPE_HELMET);
+		inv.addSlot(&quot;Back&quot;, &quot;hals&quot;, Item::ITEMTYPE_ALL_ITEMS);
 
-	$SCRIPT.log(&quot;Inventar konfigurieren.&quot;);
-	inv = getInventory();
-	inv.addSlot(&quot;Left Ring&quot;, &quot;l_finger_2&quot;, Item::ITEMTYPE_RING);
-	inv.addSlot(&quot;Right Ring&quot;, &quot;r_finger_2&quot;, Item::ITEMTYPE_RING);
-	inv.addSlot(&quot;Left Hand&quot;, &quot;l_hand&quot;, Item::ITEMTYPE_ALL_ITEMS);
-	inv.addSlot(&quot;Right Hand&quot;, &quot;r_hand&quot;, Item::ITEMTYPE_ALL_ITEMS);
-	inv.addSlot(&quot;Head&quot;, &quot;kopf&quot;, Item::ITEMTYPE_HELMET);
-	inv.addSlot(&quot;Back&quot;, &quot;hals&quot;, Item::ITEMTYPE_ALL_ITEMS);
-
-#       addSounds()
+		#addSounds()
         $SCRIPT.log(&quot;done.&quot;);
     end
 

Modified: modules/regressiontest/dsa/gameobjectdefinitions.gof
===================================================================
--- modules/regressiontest/dsa/gameobjectdefinitions.gof	2007-04-02 18:41:56 UTC (rev 3222)
+++ modules/regressiontest/dsa/gameobjectdefinitions.gof	2007-04-02 18:53:55 UTC (rev 3223)
@@ -61,6 +61,8 @@
         &lt;property name=&quot;description&quot; type=&quot;STRING&quot; data=&quot;Ein ordin&#195;&#164;res Kurzschwert - scharf, aber langweilig&quot;/&gt;
         &lt;property name=&quot;meshfile&quot; type=&quot;STRING&quot; data=&quot;waf_kurzschwert_01.mesh&quot;/&gt;
 		&lt;property name=&quot;imagename&quot; type=&quot;STRING&quot; data=&quot;set:ModelThumbnails image:waf_kurzschwert_01&quot;/&gt;
+		&lt;property name=&quot;mass&quot; type=&quot;REAL&quot; data=&quot;3.0&quot;/&gt;
+		&lt;property name=&quot;size&quot; type=&quot;INTPAIR&quot; data=&quot;2,4&quot;/&gt;
     &lt;/gameobjectclass&gt;
 
     &lt;gameobjectclass&gt;
@@ -68,8 +70,17 @@
         &lt;property name=&quot;baseclass&quot; type=&quot;STRING&quot; data=&quot;Container&quot;/&gt; 
         &lt;property name=&quot;description&quot; type=&quot;STRING&quot; data=&quot;Ein Lederrucksack (oder so)&quot;/&gt;
         &lt;property name=&quot;meshfile&quot; type=&quot;STRING&quot; data=&quot;ins_rucksack.mesh&quot;/&gt;
+		&lt;property name=&quot;imagename&quot; type=&quot;STRING&quot; data=&quot;set:ModelThumbnails image:Rucksack&quot;/&gt;
+        &lt;property name=&quot;capacity&quot; type=&quot;REAL&quot; data=&quot;20.0&quot;/&gt;
+        &lt;property name=&quot;volume&quot; type=&quot;INTPAIR&quot; data=&quot;8,6&quot;/&gt;
+        &lt;property name=&quot;size&quot; type=&quot;INTPAIR&quot; data=&quot;2,2&quot;/&gt;
+        &lt;property name=&quot;actions&quot; type=&quot;ARRAY&quot;&gt;
+        	&lt;property type=&quot;STRING&quot; data=&quot;act_showcontainercontent&quot;/&gt;
+        &lt;/property&gt;
+        &lt;property name=&quot;defaultaction&quot; type=&quot;STRING&quot; data=&quot;act_showcontainercontent&quot;/&gt;
     &lt;/gameobjectclass&gt;
 
+    &lt;!-- ErrorHandlingTest --&gt;
     &lt;gameobjectclass&gt;
         &lt;property name=&quot;classid&quot; type=&quot;STRING&quot; data=&quot;ErrorHandling&quot;/&gt;
         &lt;property name=&quot;baseclass&quot; type=&quot;STRING&quot; data=&quot;GameObject&quot; /&gt;

Modified: modules/regressiontest/scripts/InventoryTest.rb
===================================================================
--- modules/regressiontest/scripts/InventoryTest.rb	2007-04-02 18:41:56 UTC (rev 3222)
+++ modules/regressiontest/scripts/InventoryTest.rb	2007-04-02 18:53:55 UTC (rev 3223)
@@ -7,7 +7,7 @@
 
     hero = $GOM.getGameObjectProxy(1).getGameObject();
     backpack = $GOM.createGameObjectProxy(&quot;leather backpack&quot;).getGameObject();
-    backpack.setVolume(5, 5);
+    #backpack.addAction(ShowContainerContentAction.new());
     #backpack.setPosition(center);
     #backpack.placeIntoScene();
     
@@ -26,6 +26,7 @@
     $SCRIPT.log(&quot;InventoryTest #4: Put an object attached to the hero into container.&quot;);
     sword_held_to_inventory = $GOM.createGameObjectProxy(&quot;shortsword&quot;).getGameObject();
     hero.getInventory().hold(sword_held_to_inventory, &quot;Left Hand&quot;);
+    hero.getInventory().dropItem(&quot;Left Hand&quot;)
     hero.getInventory().getItem(&quot;Back&quot;).addItem(sword_held_to_inventory);
 
     $SCRIPT.log(&quot;InventoryTest #5: Put an object from a container into the hero's hand.&quot;);

Modified: rl/trunk/engine/rules/include/Container.h
===================================================================
--- rl/trunk/engine/rules/include/Container.h	2007-04-02 18:41:56 UTC (rev 3222)
+++ rl/trunk/engine/rules/include/Container.h	2007-04-02 18:53:55 UTC (rev 3223)
@@ -44,8 +44,8 @@
         /// Fassungsvermoegen in Unzen
         void setCapacity(Ogre::Real capacity);
 
-	// Volumen in x (breite) * y (hoehe)
-	void setVolume(unsigned int x, unsigned int y);
+		// Volumen in x (breite) * y (hoehe)
+		void setVolume(unsigned int x, unsigned int y);
         std::pair&lt;unsigned int, unsigned int&gt; getVolume() const;
 
         /// ist dieser Gegenstand ein Container
@@ -55,30 +55,38 @@
         Ogre::Real getContentWeight() const;
         virtual Ogre::Real getWeight() const;
 
-        void addItem(Item* item);
+		/**
+		 * Add an item to the container's content
+		 * @param item the item
+		 * @return &lt;code&gt;true&lt;/code&gt; if adding was successful, &lt;code&gt;false&lt;/code&gt; otherwise (e.g. not enough space)
+		 */
+        bool addItem(Item* item);
         void removeItem(Item* item);
 
         ItemSet getItems() const;
 
-	int getItemCount() const;
+		int getItemCount() const;
 
         bool isFree(unsigned int x, unsigned int y) const;
         Item* getItemAt(unsigned int x, unsigned int y) const;
         void putItemAt(Item* item, unsigned int x, unsigned int y);
         bool canPlaceAt(Item* item, unsigned int xPos, unsigned int yPos) const;
         void setItemPosition(Item* item, unsigned int xPos, unsigned int yPos);
+        std::pair&lt;unsigned int,unsigned int&gt; getItemPosition(Item* item) const;
 
         virtual const Property getProperty(const Ogre::String&amp; key) const;
         virtual void setProperty(const Ogre::String&amp; key, const Property&amp; value);
         virtual PropertySet* getAllProperties() const;
 
     private:
+		static const std::pair&lt;unsigned int, unsigned int&gt; NO_SPACE_FOR_ITEM;
+
         Ogre::Real mCapacity;
-	std::pair&lt;unsigned int,unsigned int&gt; mVolume;
+		std::pair&lt;unsigned int,unsigned int&gt; mVolume;
 		
 		// Speichert, wo die Items sich im Container befinden.
 		// Speichert also die IDs der Objekte in die einzelnen Volumenfelder
-	int objIDMap [1][1];
+		int objIDMap [1][1];
 
         ItemSet mItems;
 

Modified: rl/trunk/engine/rules/include/Inventory.h
===================================================================
--- rl/trunk/engine/rules/include/Inventory.h	2007-04-02 18:41:56 UTC (rev 3222)
+++ rl/trunk/engine/rules/include/Inventory.h	2007-04-02 18:53:55 UTC (rev 3223)
@@ -58,7 +58,7 @@
 	* NUR die erste Hierarchieebene der Items wird zurckgegeben
 	* Was in den Items drinnen ist, ist vernachlaessigt
 	*/
-	ItemList getAllItems();
+	ItemList getAllItems() const;
 
 
 	/**
@@ -80,12 +80,16 @@
     // Das Inventar der Kreatur wird durch das Inventarobjekt verwaltet.
     void addToInventory(Item* item, const CeGuiString&amp; containerName);
     void hold(Item* item, const CeGuiString&amp; slotName);
+    bool canHold(Item* item, const CeGuiString&amp; slotName) const;
+	void dropItem(const CeGuiString&amp; slotName);
     void ready(Item* item);
 
     Item* getItem(const CeGuiString&amp; slotName) const;
     void addSlot(const CeGuiString&amp; name, const Ogre::String&amp; bone, int itemMask);
     const SlotMap&amp; getAllSlots() const;
 
+	Creature* getOwner() const;
+
 private:
 	bool mValuesUpToDate;
 	int mCurrentWeight;

Modified: rl/trunk/engine/rules/src/Container.cpp
===================================================================
--- rl/trunk/engine/rules/src/Container.cpp	2007-04-02 18:41:56 UTC (rev 3222)
+++ rl/trunk/engine/rules/src/Container.cpp	2007-04-02 18:53:55 UTC (rev 3223)
@@ -23,6 +23,8 @@
 
 namespace rl {
 
+	const std::pair&lt;unsigned int, unsigned int&gt; Container::NO_SPACE_FOR_ITEM = make_pair(1999999999, 1999999999);
+
     const Ogre::String Container::CLASS_NAME = &quot;Container&quot;;
 
     const Ogre::String Container::PROPERTY_CAPACITY = &quot;capacity&quot;;
@@ -30,7 +32,8 @@
 
     Container::Container(unsigned int id)
         : Item(id),
-          mCapacity(0.0)
+          mCapacity(0.0),
+		  mVolume(std::make_pair(1,1))
     {
     }
 
@@ -78,16 +81,25 @@
         return mItems;
     }
 
-    void Container::addItem(Item* item)
+    bool Container::addItem(Item* item)
     {
-        if(item == 0)
+        if(item == NULL)
         {
             Throw(NullPointerException, &quot;Item ist null.&quot;);
         }
+
         pair&lt;unsigned int, unsigned int&gt; pos = findPositionWithEnoughSpace(item-&gt;getSize());
-        mItemPositions[item] = pos;
-        mItems.insert(item);
-        item-&gt;setState(GOS_IN_POSSESSION);
+		if (pos != NO_SPACE_FOR_ITEM)
+		{
+			mItemPositions[item] = pos;
+			mItems.insert(item);
+			item-&gt;setState(GOS_IN_POSSESSION);
+			return true;
+		}
+		else
+		{
+			return false;
+		}
     }
 
     void Container::removeItem(Item* item)
@@ -118,8 +130,8 @@
 		bool free = true;
 
         // Es wird versucht, das Item au&#223;erhalb des Containers zu platzieren
-        if (xPos + xSize &gt;= mVolume.first 
-            || yPos + ySize &gt;= mVolume.second)
+        if (xPos + xSize &gt; mVolume.first 
+            || yPos + ySize &gt; mVolume.second)
         {
             return false;
         }
@@ -146,7 +158,6 @@
 		return true;
 	}
 
-
     void Container::setItemPosition(Item* item, unsigned int xPos, unsigned int yPos)
     {
         if (mItemPositions.find(item) == mItemPositions.end())
@@ -157,6 +168,18 @@
         mItemPositions[item] = make_pair(xPos, yPos);
     }
 
+	std::pair&lt;unsigned int, unsigned int&gt; Container::getItemPosition(Item* item) const
+    {
+		std::map&lt;Item*, std::pair&lt;unsigned int, unsigned int&gt; &gt;::const_iterator it = 
+			mItemPositions.find(item);
+        if (it == mItemPositions.end())
+        {
+            Throw(IllegalArgumentException, &quot;Item not in Container.&quot;);
+        }
+
+		return (*it).second;
+    }
+
     pair&lt;unsigned int, unsigned int&gt; Container::findPositionWithEnoughSpace(pair&lt;unsigned int, unsigned int&gt; space) const
     {
 		for (unsigned int x = 0; x &lt; mVolume.first; x++)
@@ -165,18 +188,18 @@
             {
 				if (isFree(x, y) &amp;&amp; checkSpace(x, y, space))
                 {
-					return pair&lt;unsigned int, unsigned int&gt;(x,y);
+					return make_pair(x,y);
 				}
 			}
 		}
-		Throw(IllegalStateException, &quot;Rucksack hat keinen Platz f&#252;r das Item&quot;);
+		return NO_SPACE_FOR_ITEM;
 	}
 
     bool Container::checkSpace(unsigned int xStart, unsigned int yStart, pair&lt;unsigned int,unsigned int&gt; space) const
     {
 		// Falls K&#228;stchen nicht mehr im Rucksack, ist auch kein Platz mehr :)
-        if ((xStart+space.first) &gt;= mVolume.first 
-            || (yStart+space.second) &gt;= mVolume.second)
+        if ((xStart+space.first) &gt; mVolume.first 
+            || (yStart+space.second) &gt; mVolume.second)
         {
 			return false;
 		}
@@ -209,8 +232,8 @@
 
             if (pos.first &lt;= x 
                 &amp;&amp; pos.second &lt;= y 
-                &amp;&amp; x &lt;= pos.first + item-&gt;getSize().first
-                &amp;&amp; y &lt;= pos.second + item-&gt;getSize().second)
+                &amp;&amp; x &lt; pos.first + item-&gt;getSize().first
+                &amp;&amp; y &lt; pos.second + item-&gt;getSize().second)
             {
                 return item;
             }

Modified: rl/trunk/engine/rules/src/Inventory.cpp
===================================================================
--- rl/trunk/engine/rules/src/Inventory.cpp	2007-04-02 18:41:56 UTC (rev 3222)
+++ rl/trunk/engine/rules/src/Inventory.cpp	2007-04-02 18:53:55 UTC (rev 3223)
@@ -68,18 +68,22 @@
 	Inventory::~Inventory() 
 	{
 	}
-
 	
 	void Inventory::markDirty()
 	{
 		mValuesUpToDate = false;
 	}
 
-	Inventory::ItemList Inventory::getAllItems()
+	Creature* Inventory::getOwner() const
 	{
+		return mOwner;
+	}
+
+	Inventory::ItemList Inventory::getAllItems() const
+	{
 		ItemList allItems(0);
 
-        for (SlotMap::iterator iter = mSlots.begin(); iter != mSlots.end(); ++iter)
+        for (SlotMap::const_iterator iter = mSlots.begin(); iter != mSlots.end(); ++iter)
         {
             Item* item = (*iter).second-&gt;getItem();
             if (item != NULL)
@@ -91,21 +95,21 @@
 		return allItems;
 	}
 
-	int Inventory::getOverallWeight()
+	int Inventory::getOverallWeight() 
 	{
 		if (!mValuesUpToDate)
 			updateStats();
 		return mCurrentWeight;
 	}
 
-	pair&lt;int,int&gt; Inventory::getOverallBe()
+	pair&lt;int,int&gt; Inventory::getOverallBe() 
 	{
 		if (!mValuesUpToDate)
 			updateStats();
 		return make_pair&lt;int,int&gt;(mCurrentBe, mCurrentBeByWeight);
 	}
 
-	int Inventory::getOverallRs()
+	int Inventory::getOverallRs() 
 	{
 		if (!mValuesUpToDate)
 			updateStats();
@@ -161,6 +165,16 @@
 		//}
 	}
 
+	void Inventory::dropItem(const CeGuiString&amp; slotName)
+	{
+		std::map&lt;CeGuiString, Slot*&gt;::iterator slotIter = mSlots.find(slotName);
+        if (slotIter == mSlots.end())
+        {
+            Throw(rl::IllegalArgumentException, Ogre::String(&quot;Slot '&quot;)+slotName.c_str()+&quot;' doesn't exist.&quot;);
+        }
+        (*slotIter).second-&gt;setItem(NULL);
+	}
+
     void Inventory::hold(Item* item, const CeGuiString&amp; slotName)
     {
         std::map&lt;CeGuiString, Slot*&gt;::iterator slotIter = mSlots.find(slotName);
@@ -172,6 +186,17 @@
         (*slotIter).second-&gt;setItem(item);
     }
 
+	bool Inventory::canHold(Item* item, const CeGuiString&amp; slotName) const
+    {
+        std::map&lt;CeGuiString, Slot*&gt;::const_iterator slotIter = mSlots.find(slotName);
+        if (slotIter == mSlots.end())
+        {
+            Throw(rl::IllegalArgumentException, Ogre::String(&quot;Slot '&quot;)+slotName.c_str()+&quot;' doesn't exist.&quot;);
+        }
+        
+		return (*slotIter).second-&gt;isAllowed(item);
+    }
+
     Item* Inventory::getItem(const CeGuiString&amp; slotName) const
     {
         std::map&lt;CeGuiString, Slot*&gt;::const_iterator slotIter = mSlots.find(slotName);

Modified: rl/trunk/engine/rules/src/Slot.cpp
===================================================================
--- rl/trunk/engine/rules/src/Slot.cpp	2007-04-02 18:41:56 UTC (rev 3222)
+++ rl/trunk/engine/rules/src/Slot.cpp	2007-04-02 18:53:55 UTC (rev 3223)
@@ -34,8 +34,19 @@
 
     void Slot::setItem(Item* item)
     {
+		if (item == NULL)
+		{
+			mItem = NULL;
+			return;
+		}
+
         if (isAllowed(item))
         {
+			if (mItem != NULL)
+			{
+				/// @todo What to do with the item which was already in the slot (or should we throw an exception if the item is not NULL)
+			}
+
             mItem = item;
             if (mOwner-&gt;getState() == GOS_IN_SCENE)
             {

Modified: rl/trunk/engine/script/swig/RlRules.swig
===================================================================
--- rl/trunk/engine/script/swig/RlRules.swig	2007-04-02 18:41:56 UTC (rev 3222)
+++ rl/trunk/engine/script/swig/RlRules.swig	2007-04-02 18:53:55 UTC (rev 3223)
@@ -417,6 +417,7 @@
 
         virtual const rl::Property getProperty(const Ogre::String&amp; key) const;
         virtual void setProperty(const Ogre::String&amp; key, const rl::Property&amp; value);
+        virtual bool isContainer();
     };
     
     %feature(&quot;director&quot;) Weapon;
@@ -632,8 +633,9 @@
         Inventory(rl::Creature* owner);
 	public:
 	    void addSlot(const rl::CeGuiString&amp; name, const Ogre::String&amp; bone, int itemMask);
-	    rl::Item* getItem(const rl::CeGuiString&amp; slotName);
-        void hold(rl::Item* item, const rl::CeGuiString&amp; slot);
+	    rl::Item* getItem(const rl::CeGuiString&amp; slotName) const;
+	    void hold(rl::Item* item, const rl::CeGuiString&amp; slot);
+	    void dropItem(const rl::CeGuiString&amp; slotName);
 	};
 
     %feature(&quot;director&quot;) Creature;

Modified: rl/trunk/engine/ui/RlUI2005.vcproj
===================================================================
--- rl/trunk/engine/ui/RlUI2005.vcproj	2007-04-02 18:41:56 UTC (rev 3222)
+++ rl/trunk/engine/ui/RlUI2005.vcproj	2007-04-02 18:53:55 UTC (rev 3223)
@@ -477,6 +477,10 @@
 					&gt;
 				&lt;/File&gt;
 				&lt;File
+					RelativePath=&quot;.\include\ItemDragContainer.h&quot;
+					&gt;
+				&lt;/File&gt;
+				&lt;File
 					RelativePath=&quot;.\include\JournalWindow.h&quot;
 					&gt;
 				&lt;/File&gt;
@@ -662,6 +666,10 @@
 					&gt;
 				&lt;/File&gt;
 				&lt;File
+					RelativePath=&quot;.\src\ItemDragContainer.cpp&quot;
+					&gt;
+				&lt;/File&gt;
+				&lt;File
 					RelativePath=&quot;.\src\JournalWindow.cpp&quot;
 					&gt;
 				&lt;/File&gt;

Modified: rl/trunk/engine/ui/include/AbstractWindow.h
===================================================================
--- rl/trunk/engine/ui/include/AbstractWindow.h	2007-04-02 18:41:56 UTC (rev 3222)
+++ rl/trunk/engine/ui/include/AbstractWindow.h	2007-04-02 18:53:55 UTC (rev 3223)
@@ -102,6 +102,9 @@
 
 		static CEGUI::Window* loadWindow(const CeGuiString&amp; xmlfile, CeGuiString&amp; prefix);
 
+		const CeGuiString&amp; getUserDataType(CEGUI::Window* window) const;
+		void setUserDataType(CEGUI::Window* window, const CeGuiString&amp; typeDescription) const;
+
 		CEGUI::Window* mWindow;
 		bool mVisible;
 

Modified: rl/trunk/engine/ui/include/InventoryWindow.h
===================================================================
--- rl/trunk/engine/ui/include/InventoryWindow.h	2007-04-02 18:41:56 UTC (rev 3222)
+++ rl/trunk/engine/ui/include/InventoryWindow.h	2007-04-02 18:53:55 UTC (rev 3223)
@@ -43,14 +43,20 @@
 		InventoryWindow(const Ogre::String&amp; inventoryWindow, Inventory* inventory);
 		~InventoryWindow();
 
+		static const Ogre::String ICON_UNKNOWN_ITEM;
+		static const Ogre::String SLOTNAME;
+
     private:
         Inventory* mInventory;
         std::map&lt;CeGuiString, CEGUI::Window*&gt; mSlotWindows;
 
-        CEGUI::Window* mContainerTabs;
-
         void createSlotWindows(Inventory* inventory);
         void initInventoryWindow(Inventory* inventory);
+
+		CEGUI::Window* createItemWindow(const CeGuiString&amp; containerName, Item* item);
+		bool handleItemDroppedOnSlot(const CEGUI::EventArgs&amp; evt);
+		bool handleItemMouseClick(const CEGUI::EventArgs&amp; evt, Item* item);
+		bool handleItemDoubleClick(const CEGUI::EventArgs&amp; evt, Item* item);
     };
 }
 

Added: rl/trunk/engine/ui/include/ItemDragContainer.h
===================================================================
--- rl/trunk/engine/ui/include/ItemDragContainer.h	2007-04-02 18:41:56 UTC (rev 3222)
+++ rl/trunk/engine/ui/include/ItemDragContainer.h	2007-04-02 18:53:55 UTC (rev 3223)
@@ -0,0 +1,54 @@
+/* This source file is part of Rastullahs Lockenpracht.
+ * Copyright (C) 2003-2007 Team Pantheon. <A HREF="http://www.team-pantheon.de">http://www.team-pantheon.de</A>
+ * 
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the Clarified Artistic License.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  Clarified Artistic License for more details.
+ *
+ *  You should have received a copy of the Clarified Artistic License
+ *  along with this program; if not you can get it here
+ *  <A HREF="http://www.jpaulmorrison.com/fbp/artistic2.htm.">http://www.jpaulmorrison.com/fbp/artistic2.htm.</A>
+ */
+#ifndef __ItemDragContainer_H__
+#define __ItemDragContainer_H__
+
+#include &quot;UiPrerequisites.h&quot;
+
+#include &lt;elements/CEGUIDragContainer.h&gt;
+
+namespace rl 
+{
+	class Container;
+	class Inventory;
+	class Item;
+	class Slot;
+
+	class ItemDragContainer : public CEGUI::DragContainer
+	{
+	public:
+		ItemDragContainer(Item* item, const CeGuiString&amp; name);
+		
+		void setItemParent(Container* container);
+		void setItemParent(Inventory* inventory, const CeGuiString&amp; slotname);
+		Container* getItemParentContainer() const;
+		const CeGuiString&amp; getItemParentSlot() const;
+		Inventory* getItemParentInventory() const;
+		Item* getItem() const;
+
+	protected:
+		virtual bool testClassName_impl(const CEGUI::String&amp; class_name) const;
+
+	private:
+		Item* mItem;
+		Container* mParentContainer;
+		CeGuiString mParentSlot;
+		Inventory* mInventory;
+	};
+
+} // namespace rl
+
+#endif //__ItemDragContainer_H__
\ No newline at end of file

Modified: rl/trunk/engine/ui/include/Makefile.am
===================================================================
--- rl/trunk/engine/ui/include/Makefile.am	2007-04-02 18:41:56 UTC (rev 3222)
+++ rl/trunk/engine/ui/include/Makefile.am	2007-04-02 18:53:55 UTC (rev 3223)
@@ -24,6 +24,7 @@
 	InGameMenuWindow.h \
 	InputManager.h \
 	InventoryWindow.h \
+	ItemDragContainer.h \
 	JournalWindow.h \
 	ListboxWrappedTextItem.h \
 	LogWindow.h \

Modified: rl/trunk/engine/ui/src/ContainerContentWindow.cpp
===================================================================
--- rl/trunk/engine/ui/src/ContainerContentWindow.cpp	2007-04-02 18:41:56 UTC (rev 3222)
+++ rl/trunk/engine/ui/src/ContainerContentWindow.cpp	2007-04-02 18:53:55 UTC (rev 3223)
@@ -20,10 +20,10 @@
 #include &lt;CEGUIImagesetManager.h&gt;
 #include &lt;CEGUIPropertyHelper.h&gt;
 #include &lt;CEGUIWindowManager.h&gt;
-#include &lt;elements/CEGUIDragContainer.h&gt;
 
 #include &quot;Container.h&quot;
 #include &quot;InventoryWindow.h&quot;
+#include &quot;ItemDragContainer.h&quot;
 
 using namespace CEGUI;
 
@@ -72,9 +72,27 @@
 	bool ContainerContentWindow::handleItemDroppedOnContainer(const EventArgs&amp; evt)
 	{
 		const DragDropEventArgs&amp; evtArgs = static_cast&lt;const DragDropEventArgs&amp;&gt;(evt);
-		Item* item = static_cast&lt;Item*&gt;(evtArgs.dragDropItem-&gt;getUserData());
-		
-		return true;
+
+		if (evtArgs.dragDropItem-&gt;testClassName(&quot;ItemDragContainer&quot;))
+		{
+			ItemDragContainer* dragcont = static_cast&lt;ItemDragContainer*&gt;(
+				evtArgs.dragDropItem);
+			Item* item = dragcont-&gt;getItem();
+
+			if (dragcont-&gt;getItemParentContainer() != NULL)
+			{
+				dragcont-&gt;getItemParentContainer()-&gt;removeItem(item);
+				mContainer-&gt;addItem(item);
+			}
+			else if (dragcont-&gt;getItemParentSlot() != &quot;&quot;)
+			{
+				dragcont-&gt;getItemParentInventory()-&gt;dropItem(dragcont-&gt;getItemParentSlot());
+				mContainer-&gt;addItem(item);
+			}
+			
+			return true;
+		}
+		return false;
 	}
 
 	Window* ContainerContentWindow::createItemWindow(Item* item)
@@ -98,10 +116,9 @@
             UVector2(cegui_absdim(item-&gt;getSize().first*30),
                      cegui_absdim(item-&gt;getSize().second*30)));
 
-		DragContainer* itemhandler = static_cast&lt;DragContainer*&gt;(
-		CEGUI::WindowManager::getSingletonPtr()-&gt;createWindow(
-			&quot;DragContainer&quot;, 
-			&quot;DragContainer_&quot;+itemWindow-&gt;getName()));
+		ItemDragContainer* itemhandler = new ItemDragContainer(item, 
+			&quot;DragContainer_&quot;+itemWindow-&gt;getName());
+		itemhandler-&gt;setItemParent(mContainer);
 		itemhandler-&gt;setPosition(UVector2(cegui_reldim(0), cegui_reldim(0)));
 		itemhandler-&gt;setSize(
 			UVector2(cegui_absdim(item-&gt;getSize().first*30),
@@ -109,9 +126,7 @@
 		itemhandler-&gt;setUserData(item);
 		itemhandler-&gt;setTooltipText(item-&gt;getName());
 		itemhandler-&gt;addChildWindow(itemWindow);
-		//itemhandler-&gt;subscribeEvent(
-		//	Window::EventMouseClick,
-		//	Event::Subscriber(&amp;InventoryWindow::handleMouseClicked,	this));
+		
 
 		return itemhandler;
 	}

Modified: rl/trunk/engine/ui/src/InventoryWindow.cpp
===================================================================
--- rl/trunk/engine/ui/src/InventoryWindow.cpp	2007-04-02 18:41:56 UTC (rev 3222)
+++ rl/trunk/engine/ui/src/InventoryWindow.cpp	2007-04-02 18:53:55 UTC (rev 3223)
@@ -15,26 +15,27 @@
  */
 #include &quot;InventoryWindow.h&quot;
 
-
 #include &lt;boost/bind.hpp&gt;
 #include &lt;CEGUIImageset.h&gt;
 #include &lt;CEGUIImagesetManager.h&gt;
 #include &lt;CEGUIWindowManager.h&gt;
-#include &lt;elements/CEGUIDragContainer.h&gt;
-#include &lt;elements/CEGUIFrameWindow.h&gt;
 
+#include &quot;ItemDragContainer.h&quot;
+#include &quot;WindowFactory.h&quot;
 
 using namespace CEGUI;
 using namespace std;
 
 namespace rl {
 
+	const Ogre::String InventoryWindow::ICON_UNKNOWN_ITEM = &quot;set:ModelThumbnails image:item_unknown&quot;;
+	const Ogre::String InventoryWindow::SLOTNAME = &quot;slotname&quot;;
+
     InventoryWindow::InventoryWindow(const Ogre::String&amp; inventoryWindow, Inventory* inventory)
         : AbstractWindow(inventoryWindow, AbstractWindow::WND_MOUSE_INPUT)
     {
         mInventory = inventory;
 
-        mContainerTabs = getTabControl(&quot;InventoryWindow/Tabs&quot;);
         //mSquareSize = ...;
 
         createSlotWindows(inventory);
@@ -49,11 +50,11 @@
     {
         std::map&lt;CeGuiString, Window*&gt; slotsInWindowDefinition;
 
-        Window* containers = getWindow(&quot;InventoryWindow/Slots&quot;);
+        Window* slotWindowParent = getWindow(&quot;InventoryWindow/Slots&quot;);
 
-        for (size_t idx = 0; idx &lt; containers-&gt;getChildCount(); idx++)
+        for (size_t idx = 0; idx &lt; slotWindowParent-&gt;getChildCount(); idx++)
         {
-            Window* curWnd = containers-&gt;getChildAtIdx(idx);
+            Window* curWnd = slotWindowParent-&gt;getChildAtIdx(idx);
             CeGuiString curWndName = curWnd-&gt;getName();
             if (curWndName.find(&quot;InventoryWindow/Slots/&quot;) != CeGuiString::npos)
             {
@@ -78,6 +79,7 @@
             if (slotInWindowFile != slotsInWindowDefinition.end())
             {
                 mSlotWindows[slotName] = (*slotInWindowFile).second; 
+				mSlotWindows[slotName]-&gt;setUserString(SLOTNAME, slotName);
                 slotsInWindowDefinition.erase(slotInWindowFile);
                 LOG_DEBUG(Logger::UI, &quot;Found slot &quot;+slotName);
             }
@@ -89,7 +91,7 @@
             }
         }
 
-        ///@todo deactivate all remaining elements of slotsInWindowDefinition
+		///@todo deactivate all remaining elements of slotsInWindowDefinition
     }
 
     void InventoryWindow::initInventoryWindow(Inventory* inventory)
@@ -98,25 +100,125 @@
         {
             CeGuiString slotName = (*it).first;
             Item* item = inventory-&gt;getItem(slotName);
+			Window* slotWindow = (*it).second;
+			slotWindow-&gt;setDragDropTarget(true);
+			slotWindow-&gt;subscribeEvent(Window::EventDragDropItemDropped, 
+				boost::bind(&amp;InventoryWindow::handleItemDroppedOnSlot, this, _1));
+
             if (item != NULL)
             {
-                LOG_MESSAGE(Logger::UI, (*it).first + &quot; - &quot; + item-&gt;getDescription());
-                CeGuiString icon = item-&gt;getImageName();
-                if (icon != &quot;&quot; /*&amp;&amp; icon.find(&quot;/&quot;) != CeGuiString::npos*/)
-                {
-                    LOG_MESSAGE(&quot;IW&quot;, icon);
-                    Window* itemWindow = 
-				        CEGUI::WindowManager::getSingletonPtr()-&gt;createWindow(
-					    &quot;RastullahLook/StaticImage&quot;, 
-                        mWindow-&gt;getName() + &quot;/&quot; + slotName + &quot;/&quot; + icon);
-                    itemWindow-&gt;setProperty(&quot;Image&quot;, icon);
-                    (*it).second-&gt;addChildWindow(itemWindow);
-                    itemWindow-&gt;setPosition(UVector2(cegui_reldim(0), cegui_reldim(0)));
-                    itemWindow-&gt;setSize(
-                        UVector2(cegui_absdim(item-&gt;getSize().first*30),
-                                 cegui_absdim(item-&gt;getSize().second*30)));
-                }
+                LOG_MESSAGE(Logger::UI, slotName + &quot; - &quot; + item-&gt;getDescription());
+				Window* itemWindow = createItemWindow(slotName, item);
+				if (itemWindow != NULL)
+				{
+					slotWindow-&gt;addChildWindow(itemWindow);
+				}
             }
         }
     }
+
+	Window* InventoryWindow::createItemWindow(const CeGuiString&amp; slotName, Item* item)
+	{
+        CeGuiString icon = item-&gt;getImageName();
+
+		if (icon == &quot;&quot;)
+		{
+			icon = ICON_UNKNOWN_ITEM;
+		}
+
+        LOG_MESSAGE(&quot;IW&quot;, icon);
+        Window* itemWindow = 
+	        CEGUI::WindowManager::getSingletonPtr()-&gt;createWindow(
+		    &quot;RastullahLook/StaticImage&quot;, 
+            mWindow-&gt;getName() + &quot;/&quot; + slotName + &quot;/&quot; + icon);
+        itemWindow-&gt;setProperty(&quot;Image&quot;, icon);
+        itemWindow-&gt;setPosition(UVector2(cegui_reldim(0), cegui_reldim(0)));
+        itemWindow-&gt;setSize(
+            UVector2(cegui_absdim(item-&gt;getSize().first*30),
+                     cegui_absdim(item-&gt;getSize().second*30)));
+
+		itemWindow-&gt;subscribeEvent(
+			Window::EventMouseClick,
+			boost::bind(&amp;InventoryWindow::handleItemMouseClick, this, _1, item));
+
+		itemWindow-&gt;subscribeEvent(
+			Window::EventMouseDoubleClick,
+			boost::bind(&amp;InventoryWindow::handleItemDoubleClick, this, _1, item));
+		
+		ItemDragContainer* itemhandler = new ItemDragContainer(item, &quot;DragContainer_&quot;+itemWindow-&gt;getName());
+		itemhandler-&gt;setItemParent(mInventory, slotName);
+
+		itemhandler-&gt;setPosition(UVector2(cegui_reldim(0), cegui_reldim(0)));
+		itemhandler-&gt;setSize(
+			UVector2(cegui_absdim(item-&gt;getSize().first*30),
+					 cegui_absdim(item-&gt;getSize().second*30))); 
+		itemhandler-&gt;setTooltipText(item-&gt;getName());
+		itemhandler-&gt;addChildWindow(itemWindow);
+		
+		return itemhandler;
+	}
+
+	bool InventoryWindow::handleItemDroppedOnSlot(const EventArgs&amp; evt)
+	{
+		const DragDropEventArgs&amp; evtArgs = static_cast&lt;const DragDropEventArgs&amp;&gt;(evt);
+
+		if (evtArgs.dragDropItem-&gt;testClassName(&quot;ItemDragContainer&quot;))
+		{
+			ItemDragContainer* dragcont = static_cast&lt;ItemDragContainer*&gt;(
+				evtArgs.dragDropItem);
+			Item* item = dragcont-&gt;getItem();
+			CeGuiString targetSlot = evtArgs.window-&gt;getUserString(SLOTNAME);
+
+			if (mInventory-&gt;canHold(item, targetSlot))
+			{
+				if (dragcont-&gt;getItemParentContainer() != NULL)
+				{
+					dragcont-&gt;getItemParentContainer()-&gt;removeItem(item);
+					mInventory-&gt;hold(item, targetSlot);
+				}
+				else if (dragcont-&gt;getItemParentSlot() != &quot;&quot;)
+				{
+					dragcont-&gt;getItemParentInventory()-&gt;dropItem(dragcont-&gt;getItemParentSlot());
+					mInventory-&gt;hold(item, targetSlot);
+				}
+				
+				return true;
+			}
+			else
+			{
+				return false;
+			}
+		}
+
+		return false;
+	}
+
+	bool InventoryWindow::handleItemMouseClick(const EventArgs&amp; evt, Item* item)
+	{
+		const MouseEventArgs&amp; mevt = static_cast&lt;const MouseEventArgs&amp;&gt;(evt);
+		if (mevt.button == RightButton)
+		{
+			WindowFactory::getSingleton().showActionChoice(item);
+			return true;
+		}
+		else
+		{
+			return false;
+		}
+	}
+
+	bool InventoryWindow::handleItemDoubleClick(const EventArgs&amp; evt, Item* item)
+	{
+		const MouseEventArgs&amp; mevt = static_cast&lt;const MouseEventArgs&amp;&gt;(evt);
+		if (mevt.button == LeftButton)
+		{
+			item-&gt;doDefaultAction(mInventory-&gt;getOwner(), NULL);
+			return true;
+		}
+		else
+		{
+			return false;
+		}
+	}
+
 }

Added: rl/trunk/engine/ui/src/ItemDragContainer.cpp
===================================================================
--- rl/trunk/engine/ui/src/ItemDragContainer.cpp	2007-04-02 18:41:56 UTC (rev 3222)
+++ rl/trunk/engine/ui/src/ItemDragContainer.cpp	2007-04-02 18:53:55 UTC (rev 3223)
@@ -0,0 +1,67 @@
+/* This source file is part of Rastullahs Lockenpracht.
+ * Copyright (C) 2003-2007 Team Pantheon. <A HREF="http://www.team-pantheon.de">http://www.team-pantheon.de</A>
+ * 
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the Clarified Artistic License.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  Clarified Artistic License for more details.
+ *
+ *  You should have received a copy of the Clarified Artistic License
+ *  along with this program; if not you can get it here
+ *  <A HREF="http://www.jpaulmorrison.com/fbp/artistic2.htm.">http://www.jpaulmorrison.com/fbp/artistic2.htm.</A>
+ */
+#include &quot;ItemDragContainer.h&quot;
+
+namespace rl {
+
+	ItemDragContainer::ItemDragContainer(Item* item, const CeGuiString&amp; name)
+		: CEGUI::DragContainer(&quot;DragContainer&quot;, name),
+		mItem(item),
+		mParentContainer(NULL),
+		mParentSlot(&quot;&quot;)
+	{
+	}
+		
+	void ItemDragContainer::setItemParent(Container* container)
+	{
+		mParentContainer = container;
+		mParentSlot = &quot;&quot;;
+		mInventory = NULL;
+	}
+	
+	void ItemDragContainer::setItemParent(Inventory* inventory, const CeGuiString&amp; slotname)
+	{
+		mParentSlot = slotname;
+		mParentContainer = NULL;
+		mInventory = inventory;
+	}
+	
+	Container* ItemDragContainer::getItemParentContainer() const
+	{
+		return mParentContainer;
+	}
+
+	const CeGuiString&amp; ItemDragContainer::getItemParentSlot() const
+	{
+		return mParentSlot;
+	}
+
+	Inventory* ItemDragContainer::getItemParentInventory() const
+	{
+		return mInventory;
+	}
+
+	bool ItemDragContainer::testClassName_impl(const CEGUI::String&amp; class_name) const
+	{
+		if (class_name==&quot;ItemDragContainer&quot;)	return true;
+		return DragContainer::testClassName_impl(class_name);
+	}
+
+	Item* ItemDragContainer::getItem() const
+	{
+		return mItem;
+	}
+}

Modified: rl/trunk/engine/ui/src/Makefile.am
===================================================================
--- rl/trunk/engine/ui/src/Makefile.am	2007-04-02 18:41:56 UTC (rev 3222)
+++ rl/trunk/engine/ui/src/Makefile.am	2007-04-02 18:53:55 UTC (rev 3223)
@@ -33,6 +33,7 @@
 	InGameMenuWindow.cpp \
 	InputManager.cpp \
 	InventoryWindow.cpp \
+	ItemDragContainer.cpp \
 	JournalWindow.cpp \
 	ListboxWrappedTextItem.cpp \
 	LogWindow.cpp \


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000293.html">[Dsa-hl-svn] r3222 - in rl/trunk/engine/rules: include src
</A></li>
	<LI>Next message: <A HREF="000295.html">[Dsa-hl-svn] r3224 - rl/trunk/engine/rules/src
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#294">[ date ]</a>
              <a href="thread.html#294">[ thread ]</a>
              <a href="subject.html#294">[ subject ]</a>
              <a href="author.html#294">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/dsa-hl-svn">More information about the Dsa-hl-svn
mailing list</a><br>
</body></html>
