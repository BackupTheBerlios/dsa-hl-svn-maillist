<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Dsa-hl-svn] r3341 - modules/regressiontest/dsa	modules/regressiontest/maps modules/regressiontest/scripts	modules/regressiontest/scripts/maps rl/trunk/docs/documents	rl/trunk/engine/common/include rl/trunk/engine/common/src	rl/trunk/engine/core/include rl/trunk/engine/core/src	rl/trunk/engine/rules/include rl/trunk/engine/rules/src	rl/trunk/engine/script/swig
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/dsa-hl-svn/2007-April/index.html" >
   <LINK REL="made" HREF="mailto:dsa-hl-svn%40lists.berlios.de?Subject=Re%3A%20%5BDsa-hl-svn%5D%20r3341%20-%20modules/regressiontest/dsa%0A%09modules/regressiontest/maps%20modules/regressiontest/scripts%0A%09modules/regressiontest/scripts/maps%20rl/trunk/docs/documents%0A%09rl/trunk/engine/common/include%20rl/trunk/engine/common/src%0A%09rl/trunk/engine/core/include%20rl/trunk/engine/core/src%0A%09rl/trunk/engine/rules/include%20rl/trunk/engine/rules/src%0A%09rl/trunk/engine/script/swig&In-Reply-To=%3C200704261914.l3QJEaSB025234%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000411.html">
   <LINK REL="Next"  HREF="000413.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Dsa-hl-svn] r3341 - modules/regressiontest/dsa	modules/regressiontest/maps modules/regressiontest/scripts	modules/regressiontest/scripts/maps rl/trunk/docs/documents	rl/trunk/engine/common/include rl/trunk/engine/common/src	rl/trunk/engine/core/include rl/trunk/engine/core/src	rl/trunk/engine/rules/include rl/trunk/engine/rules/src	rl/trunk/engine/script/swig</H1>
    <B>blakharaz at mail.berlios.de</B> 
    <A HREF="mailto:dsa-hl-svn%40lists.berlios.de?Subject=Re%3A%20%5BDsa-hl-svn%5D%20r3341%20-%20modules/regressiontest/dsa%0A%09modules/regressiontest/maps%20modules/regressiontest/scripts%0A%09modules/regressiontest/scripts/maps%20rl/trunk/docs/documents%0A%09rl/trunk/engine/common/include%20rl/trunk/engine/common/src%0A%09rl/trunk/engine/core/include%20rl/trunk/engine/core/src%0A%09rl/trunk/engine/rules/include%20rl/trunk/engine/rules/src%0A%09rl/trunk/engine/script/swig&In-Reply-To=%3C200704261914.l3QJEaSB025234%40sheep.berlios.de%3E"
       TITLE="[Dsa-hl-svn] r3341 - modules/regressiontest/dsa	modules/regressiontest/maps modules/regressiontest/scripts	modules/regressiontest/scripts/maps rl/trunk/docs/documents	rl/trunk/engine/common/include rl/trunk/engine/common/src	rl/trunk/engine/core/include rl/trunk/engine/core/src	rl/trunk/engine/rules/include rl/trunk/engine/rules/src	rl/trunk/engine/script/swig">blakharaz at mail.berlios.de
       </A><BR>
    <I>Thu Apr 26 21:14:36 CEST 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="000411.html">[Dsa-hl-svn] r3340 - in modules: common/materials/model	ruchin/materials/textures techdemo2/materials/textures
</A></li>
        <LI>Next message: <A HREF="000413.html">[Dsa-hl-svn] r3342 - modules/techdemo/scripts	modules/techdemo/scripts/maps rl/trunk/engine/rules	rl/trunk/engine/rules/include rl/trunk/engine/rules/src	rl/trunk/engine/script/swig
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#412">[ date ]</a>
              <a href="thread.html#412">[ thread ]</a>
              <a href="subject.html#412">[ subject ]</a>
              <a href="author.html#412">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: blakharaz
Date: 2007-04-26 21:14:18 +0200 (Thu, 26 Apr 2007)
New Revision: 3341

Added:
   modules/regressiontest/dsa/maploadingtest.gof
   modules/regressiontest/maps/regressiontest_maploadingtest.rlmap.xml
Modified:
   modules/regressiontest/maps/regressiontest_lights.rlmap.xml
   modules/regressiontest/scripts/LightzoneTest.rb
   modules/regressiontest/scripts/MapLoadingTest.rb
   modules/regressiontest/scripts/maps/regressiontest.rb
   modules/regressiontest/scripts/moduleconfig.rb
   rl/trunk/docs/documents/scene_format_proposal.xml
   rl/trunk/engine/common/include/XmlHelper.h
   rl/trunk/engine/common/src/XmlHelper.cpp
   rl/trunk/engine/core/include/World.h
   rl/trunk/engine/core/include/Zone.h
   rl/trunk/engine/core/include/ZoneManager.h
   rl/trunk/engine/core/src/World.cpp
   rl/trunk/engine/core/src/Zone.cpp
   rl/trunk/engine/core/src/ZoneManager.cpp
   rl/trunk/engine/rules/include/MapLoader.h
   rl/trunk/engine/rules/src/MapLoader.cpp
   rl/trunk/engine/script/swig/RlCore.swig
Log:
* Create zones and sky from information in RL map files
* Added test cases from map loading and RL map light zones

Added: modules/regressiontest/dsa/maploadingtest.gof
===================================================================
--- modules/regressiontest/dsa/maploadingtest.gof	2007-04-26 19:06:07 UTC (rev 3340)
+++ modules/regressiontest/dsa/maploadingtest.gof	2007-04-26 19:14:18 UTC (rev 3341)
@@ -0,0 +1,16 @@
+&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; standalone=&quot;no&quot; ?&gt;
+&lt;GameObjectDefinitions&gt;
+
+    &lt;gameobjectclass classid=&quot;builtin_go&quot; baseclass=&quot;GameObject&quot;&gt;
+        &lt;property name=&quot;name&quot; type=&quot;STRING&quot; data=&quot;Built-in GameObject class&quot;/&gt;        
+        &lt;property name=&quot;description&quot; type=&quot;STRING&quot; data=&quot;This is an instance of a built-in GameObject class&quot;/&gt;
+        &lt;property name=&quot;meshfile&quot; type=&quot;STRING&quot; data=&quot;ver_holzscheit_01.mesh&quot;/&gt;
+    &lt;/gameobjectclass&gt;
+
+    &lt;gameobjectclass classid=&quot;custom_go&quot; baseclass=&quot;GameObjectDerived&quot;&gt;
+        &lt;property name=&quot;name&quot; type=&quot;STRING&quot; data=&quot;Custom GameObject class&quot;/&gt;        
+        &lt;property name=&quot;description&quot; type=&quot;STRING&quot; data=&quot;This is an instance of a customn GameObject class&quot;/&gt;
+        &lt;property name=&quot;meshfile&quot; type=&quot;STRING&quot; data=&quot;arc_hebel_01.mesh&quot;/&gt;
+    &lt;/gameobjectclass&gt;
+
+&lt;/GameObjectDefinitions&gt;

Modified: modules/regressiontest/maps/regressiontest_lights.rlmap.xml
===================================================================
--- modules/regressiontest/maps/regressiontest_lights.rlmap.xml	2007-04-26 19:06:07 UTC (rev 3340)
+++ modules/regressiontest/maps/regressiontest_lights.rlmap.xml	2007-04-26 19:14:18 UTC (rev 3341)
@@ -1,28 +1,40 @@
 &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; standalone=&quot;no&quot; ?&gt;
 &lt;rastullahmap formatVersion=&quot;0.4.0&quot;&gt;
 	&lt;nodes&gt;
-		&lt;light name=&quot;light1&quot; type=&quot;point&quot; visible=&quot;true&quot;
+		&lt;light name=&quot;red pointlight&quot; type=&quot;point&quot; visible=&quot;false&quot;
 			castShadows=&quot;false&quot;&gt;
 			&lt;position x=&quot;-10.0&quot; y=&quot;1&quot; z=&quot;-5.0&quot; /&gt;
 			&lt;colourDiffuse r=&quot;1&quot; g=&quot;0&quot; b=&quot;0&quot; /&gt;
 			&lt;colourSpecular r=&quot;1&quot; g=&quot;0&quot; b=&quot;0&quot; /&gt;
-			&lt;lightAttenuation range=&quot;5.0&quot; constant=&quot;1.0&quot; linear=&quot;0.0&quot;
+			&lt;lightAttenuation range=&quot;5.0&quot; constant=&quot;1.0&quot; linear=&quot;0.0&quot;
 				quadratic=&quot;0.0&quot; /&gt;
 		&lt;/light&gt;
-		&lt;light name=&quot;light2&quot; type=&quot;spot&quot; visible=&quot;true&quot;
+		&lt;light name=&quot;green spotlight&quot; type=&quot;spot&quot; visible=&quot;false&quot;
 			castShadows=&quot;false&quot;&gt;
 			&lt;position x=&quot;-12.0&quot; y=&quot;1&quot; z=&quot;-5.0&quot; /&gt;
 			&lt;colourDiffuse r=&quot;0&quot; g=&quot;1&quot; b=&quot;0&quot; /&gt;
 			&lt;colourSpecular r=&quot;0&quot; g=&quot;1&quot; b=&quot;0&quot; /&gt;
-			&lt;lightAttenuation range=&quot;10.0&quot; constant=&quot;1.0&quot; linear=&quot;0.0&quot;
+			&lt;lightAttenuation range=&quot;10.0&quot; constant=&quot;1.0&quot; linear=&quot;0.0&quot;
 				quadratic=&quot;0.0&quot; /&gt;
 			&lt;spotlightrange inner=&quot;10&quot; outer=&quot;20&quot; falloff=&quot;1&quot; /&gt;
 			&lt;direction x=&quot;0&quot; y=&quot;-1&quot; z=&quot;0.5&quot; /&gt;
 		&lt;/light&gt;
-		&lt;!--  &lt;light name=&quot;light3&quot; type=&quot;directional&quot; visible=&quot;true&quot; castShadows=&quot;false&quot;&gt;
-			&lt;colourDiffuse r=&quot;0&quot; g=&quot;0&quot; b=&quot;1&quot; /&gt;
-			&lt;colourSpecular r=&quot;0&quot; g=&quot;0&quot; b=&quot;1&quot; /&gt;
-			&lt;direction x=&quot;1&quot; y=&quot;-1&quot; z=&quot;0&quot; /&gt;
-			&lt;/light&gt; --&gt;
+		&lt;light name=&quot;blue sun&quot; type=&quot;directional&quot; visible=&quot;true&quot; castShadows=&quot;false&quot;&gt;
+			&lt;colourDiffuse r=&quot;0&quot; g=&quot;0&quot; b=&quot;1&quot; /&gt;
+			&lt;colourSpecular r=&quot;0&quot; g=&quot;0&quot; b=&quot;1&quot; /&gt;
+			&lt;direction x=&quot;1&quot; y=&quot;-1&quot; z=&quot;0&quot; /&gt;
+		&lt;/light&gt;
 	&lt;/nodes&gt;
+	&lt;zones&gt;
+		&lt;zone type=&quot;default&quot;&gt;
+			&lt;light name=&quot;blue sun&quot;/&gt;
+		&lt;/zone&gt;
+		&lt;zone type=&quot;sphere&quot; name=&quot;Testzone&quot;&gt;
+			&lt;center x=&quot;-10&quot; y=&quot;0&quot; z=&quot;-5&quot;/&gt;
+			&lt;radius r=&quot;3&quot;/&gt;
+			&lt;light name=&quot;red pointlight&quot;/&gt;
+			&lt;light name=&quot;green spotlight&quot;/&gt;
+			&lt;sound name=&quot;lachen.ogg&quot;/&gt;
+		&lt;/zone&gt;
+	&lt;/zones&gt;
 &lt;/rastullahmap&gt;

Added: modules/regressiontest/maps/regressiontest_maploadingtest.rlmap.xml
===================================================================
--- modules/regressiontest/maps/regressiontest_maploadingtest.rlmap.xml	2007-04-26 19:06:07 UTC (rev 3340)
+++ modules/regressiontest/maps/regressiontest_maploadingtest.rlmap.xml	2007-04-26 19:14:18 UTC (rev 3341)
@@ -0,0 +1,11 @@
+&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; standalone=&quot;no&quot; ?&gt;
+&lt;rastullahmap formatVersion=&quot;0.4.0&quot;&gt;
+	&lt;nodes&gt;
+		&lt;gameobject class=&quot;builtin_go&quot; id=&quot;10&quot; state=&quot;IN_SCENE&quot;&gt;
+			&lt;position x=&quot;-5.0&quot; y=&quot;0&quot; z=&quot;-10.0&quot; /&gt;
+		&lt;/gameobject&gt;
+		&lt;gameobject class=&quot;custom_go&quot; id=&quot;11&quot; state=&quot;IN_SCENE&quot;&gt;
+			&lt;position x=&quot;-5.0&quot; y=&quot;0&quot; z=&quot;-11.0&quot; /&gt;
+		&lt;/gameobject&gt;
+	&lt;/nodes&gt;
+&lt;/rastullahmap&gt;

Modified: modules/regressiontest/scripts/LightzoneTest.rb
===================================================================
--- modules/regressiontest/scripts/LightzoneTest.rb	2007-04-26 19:06:07 UTC (rev 3340)
+++ modules/regressiontest/scripts/LightzoneTest.rb	2007-04-26 19:14:18 UTC (rev 3341)
@@ -9,20 +9,11 @@
       min_base = [-3, 0.05, -3]
       max_base = [3, height, 3]
       base = $AM.createBoxPrimitiveActor(&quot;LightzoneTestBase&quot;,
-                                         min_base, max_base, &quot;alpha_green&quot;)
+                                         min_base, max_base, &quot;alpha_gray&quot;)
       base.placeIntoScene(center);
+	  
+	  MapLoader.new(&quot;regressiontest&quot;).loadMap(&quot;regressiontest_lights.rlmap.xml&quot;)
 
-      sunlight = $AM.createLightActor(&quot;sunlight&quot;, LightObject::LT_DIRECTIONAL);
-      sunlight.getControlledObject().setDirection(0.7, -2.0, 0.8);
-      sunlight.getControlledObject().setDiffuseColour(1, 1, 1);
-      ZoneManager.getSingleton().getDefaultZone().addLight(sunlight)
-
-      interiorlight = $AM.createLightActor(&quot;interiorlight&quot;, LightObject::LT_POINT);
-      interiorlight.getControlledObject().setDiffuseColour(1, 0, 0);
-      interiorlight.placeIntoScene(center);
-      interiorlight.setVisible(false)
-      lzone = ZoneManager.getSingleton().createZone(center, 3, RlScript::QUERYFLAG_PLAYER);
-      lzone.addLight(interiorlight)
   end
 end
 

Modified: modules/regressiontest/scripts/MapLoadingTest.rb
===================================================================
--- modules/regressiontest/scripts/MapLoadingTest.rb	2007-04-26 19:06:07 UTC (rev 3340)
+++ modules/regressiontest/scripts/MapLoadingTest.rb	2007-04-26 19:14:18 UTC (rev 3341)
@@ -1,10 +1,43 @@
 require 'testcase.rb'
 
+class GameObjectDerived &lt; GameObject
+end
+
 class MapLoadingTest &lt; TestCase
     def initialize(center)
         super(center)
-
-	loader = MapLoader.new(&quot;regressiontest&quot;);
-        loader.loadMap(&quot;regressiontest_lights.rlmap.xml&quot;);
+
+		loader = MapLoader.new(&quot;regressiontest&quot;);
+        loader.loadMap(&quot;regressiontest_maploadingtest.rlmap.xml&quot;);
+        
+		p &quot;--- Built-in GO class, created by MapLoader ---&quot;
+        builtIn = GameObjectManager.getSingleton().getGameObjectProxy(10)
+        p builtIn
+        p builtIn.getGameObject()
+        p builtIn.getGameObject().getActor()
+
+		p &quot;--- Custom GO class, created by MapLoader ---&quot;
+        custom = GameObjectManager.getSingleton().getGameObjectProxy(11)
+        p custom
+        p custom.getGameObject()
+        p custom.getGameObject().getActor()
+        
+		p &quot;--- Built-in GO class, created by Ruby script ---&quot;
+        builtIn2 = GameObjectManager.getSingleton().createGameObjectProxy(&quot;builtin_go&quot;, 10)
+        builtIn2.getGameObject().setName(builtIn2.getGameObject().getName() + &quot;_2&quot;)
+        builtIn2.getGameObject().setPosition([-6, 0, -10.0])
+        builtIn2.getGameObject().setState(GOS_IN_SCENE)
+        p builtIn2
+        p builtIn2.getGameObject()
+        p builtIn2.getGameObject().getActor()
+
+		p &quot;--- Custom GO class, created by Ruby script ---&quot;
+        custom2 = GameObjectManager.getSingleton().createGameObjectProxy(&quot;custom_go&quot;, 11)
+        custom2.getGameObject().setName(custom2.getGameObject().getName() + &quot;_2&quot;)
+        custom2.getGameObject().setPosition([-6, 0, -11.0])
+        custom2.getGameObject().setState(GOS_IN_SCENE)
+        p custom2
+        p custom2.getGameObject()
+        p custom2.getGameObject().getActor()
     end
 end

Modified: modules/regressiontest/scripts/maps/regressiontest.rb
===================================================================
--- modules/regressiontest/scripts/maps/regressiontest.rb	2007-04-26 19:06:07 UTC (rev 3340)
+++ modules/regressiontest/scripts/maps/regressiontest.rb	2007-04-26 19:14:18 UTC (rev 3341)
@@ -13,7 +13,7 @@
 require 'JobSequenceTest.rb'
 require 'SoundTest.rb'
 require 'effecttest.rb'
-#require 'LightzoneTest.rb'
+require 'LightzoneTest.rb'
 require 'MapLoadingTest.rb'
 
 # Physik aktivieren
@@ -26,9 +26,10 @@
 
 $SCRIPT.log(&quot;Place hero into scene&quot;)
 #$hero.getGameObject().setPosition([0.0, 1.0, 0.0]);
-$hero.getGameObject().placeIntoScene()
+$hero.getGameObject().setState(GOS_IN_SCENE)
 
 
+
 $SCRIPT.log(&quot;Prepare hero for being the active character&quot;)
 PlayerSettings.preparePlayer($hero.getGameObject())
 
@@ -50,8 +51,8 @@
 JobSequenceTest.new([5, 0, -5])
 EffectTest.new([5, 0, 5])
 SoundTest.new([10, 0, 10])
-#LightzoneTest.new([20, 0, 0])
-MapLoadingTest.new([-10, 0, -5])
+LightzoneTest.new([-10, 0, -5])
+MapLoadingTest.new([-5, 0, -10])
 
 
 $SCRIPT.log(&quot;tests initialisiert.&quot;);

Modified: modules/regressiontest/scripts/moduleconfig.rb
===================================================================
--- modules/regressiontest/scripts/moduleconfig.rb	2007-04-26 19:06:07 UTC (rev 3340)
+++ modules/regressiontest/scripts/moduleconfig.rb	2007-04-26 19:14:18 UTC (rev 3341)
@@ -22,8 +22,7 @@
     end
 
     def start()
-        $CORE.loadMap(&quot;Octree&quot;, &quot;regressiontest.scene&quot;,
-            &quot;regressiontest&quot;)
+        $CORE.loadMap(&quot;Octree&quot;, &quot;regressiontest.scene&quot;, &quot;regressiontest&quot;)
         load &quot;regressiontest.rb&quot;
         $World = $CORE.getWorld();
     end

Modified: rl/trunk/docs/documents/scene_format_proposal.xml
===================================================================
--- rl/trunk/docs/documents/scene_format_proposal.xml	2007-04-26 19:06:07 UTC (rev 3340)
+++ rl/trunk/docs/documents/scene_format_proposal.xml	2007-04-26 19:14:18 UTC (rev 3341)
@@ -163,12 +163,11 @@
 
 
 	&lt;!-- Sky Box --&gt;
-	&lt;sky type=&quot;box&quot; material=&quot;ruchinsky&quot; drawfirst=&quot;true&quot; /&gt;
+	&lt;sky type=&quot;box&quot; material=&quot;ruchinsky&quot; drawfirst=&quot;true&quot; distance=&quot;600&quot;/&gt;
 
 	&lt;!-- Sky Dome --&gt;
 	&lt;sky type=&quot;dome&quot; material=&quot;ruchinsky&quot; drawfirst=&quot;true&quot;&gt;
 		&lt;skydomesettings curvature=&quot;10&quot; tiling = &quot;8&quot; /&gt;
 	&lt;/sky&gt;
 
-
-&lt;/rastullahmap&gt;
\ No newline at end of file
+&lt;/rastullahmap&gt;

Modified: rl/trunk/engine/common/include/XmlHelper.h
===================================================================
--- rl/trunk/engine/common/include/XmlHelper.h	2007-04-26 19:06:07 UTC (rev 3340)
+++ rl/trunk/engine/common/include/XmlHelper.h	2007-04-26 19:14:18 UTC (rev 3341)
@@ -91,6 +91,15 @@
 	static int getValueAsInteger(XERCES_CPP_NAMESPACE::DOMElement* element);
 
 	/**
+	 * Processes an element node of shape &lt;any_node_name x=&quot;0&quot; y=&quot;0&quot; z=&quot;0&quot;/&gt;
+	 * into a three component Ogre vector
+	 *
+	 * @param element The DOM element
+	 * @return the vector
+	 */
+	static Ogre::Vector3 getValueAsVector3(XERCES_CPP_NAMESPACE::DOMElement* element);
+
+	/**
 	 * Ermittelt, ob ein DOMElement ein bestimmtes Attribut bestitzt
 	 *
 	 * @param element Das DOM-Element

Modified: rl/trunk/engine/common/src/XmlHelper.cpp
===================================================================
--- rl/trunk/engine/common/src/XmlHelper.cpp	2007-04-26 19:06:07 UTC (rev 3340)
+++ rl/trunk/engine/common/src/XmlHelper.cpp	2007-04-26 19:14:18 UTC (rev 3341)
@@ -41,24 +41,20 @@
 	if( parent == NULL )
 		Throw( NullPointerException, &quot;parent darf nicht NULL sein&quot; );
 
-	DOMNodeList* nodes = parent-&gt;getChildNodes();
-	XMLCh* nameXml = XMLString::transcode(name);
+	AutoXMLCh nameXml = name;
 
 	DOMElement* rval = 0;
 	
-	for (unsigned int idx = 0; idx &lt; nodes-&gt;getLength(); idx++)
+	for (DOMNode* cur = parent-&gt;getFirstChild(); cur != NULL; cur = cur-&gt;getNextSibling())
 	{
-		DOMNode* item = nodes-&gt;item(idx);
-		if (item-&gt;getNodeType() == DOMNode::ELEMENT_NODE &amp;&amp;
-			XMLString::compareString(item-&gt;getNodeName(), nameXml)==0 )
+		if (cur-&gt;getNodeType() == DOMNode::ELEMENT_NODE &amp;&amp;
+			XMLString::compareString(cur-&gt;getNodeName(), nameXml.data()) == 0)
 		{
-			rval = static_cast&lt;DOMElement*&gt;(item);
+			rval = static_cast&lt;DOMElement*&gt;(cur);
 			break;
 		}
 	}
 
-	XMLString::release(&amp;nameXml);
-
 	return rval;
 }
 
@@ -158,6 +154,20 @@
 	return XMLString::parseInt(element-&gt;getFirstChild()-&gt;getNodeValue());
 }
 
+Ogre::Vector3 XmlHelper::getValueAsVector3(DOMElement* element)
+{
+	RlAssert(element != NULL, &quot;Element must not be NULL&quot;);
+	RlAssert(
+		hasAttribute(element, &quot;x&quot;) 
+		&amp;&amp; hasAttribute(element, &quot;y&quot;) 
+		&amp;&amp; hasAttribute(element, &quot;z&quot;),
+		&quot;Element must have attributes x, y and z&quot;);
+	return Ogre::Vector3(
+		getAttributeValueAsReal(element, &quot;x&quot;),
+		getAttributeValueAsReal(element, &quot;y&quot;),
+		getAttributeValueAsReal(element, &quot;z&quot;));
+}
+
 utf8* XmlHelper::transcodeToUtf8(const XMLCh* const string16)
 {
 	unsigned int str16len = XMLString::stringLen(string16);

Modified: rl/trunk/engine/core/include/World.h
===================================================================
--- rl/trunk/engine/core/include/World.h	2007-04-26 19:06:07 UTC (rev 3340)
+++ rl/trunk/engine/core/include/World.h	2007-04-26 19:14:18 UTC (rev 3341)
@@ -56,17 +56,17 @@
         //Enables / disables a 'sky plane' i.e.
         virtual void setSkyPlane(bool enable, const Ogre::Plane &amp;plane,
             const Ogre::String &amp;materialName,
-            Ogre::Real scale=1000000, Ogre::Real tiling=10,
+            Ogre::Real scale=10000, Ogre::Real tiling=10,
             bool drawFirst=true, Ogre::Real bow=0);
 
         //Enables / disables a 'sky box' i.e.
         virtual void setSkyBox(bool enable, const Ogre::String &amp;materialName,
-            Ogre::Real distance=500000, bool drawFirst=true );
+            Ogre::Real distance=5000, bool drawFirst=true );
 
         //Enables / disables a 'sky dome' i.e.
         virtual void setSkyDome(bool enable, const Ogre::String &amp;materialName,
             Ogre::Real curvature=10, Ogre::Real tiling=8,
-            Ogre::Real distance=500000,
+            Ogre::Real distance=5000,
             bool drawFirst=true );
 
         //Sets the fogging mode applied to the scene.

Modified: rl/trunk/engine/core/include/Zone.h
===================================================================
--- rl/trunk/engine/core/include/Zone.h	2007-04-26 19:06:07 UTC (rev 3340)
+++ rl/trunk/engine/core/include/Zone.h	2007-04-26 19:14:18 UTC (rev 3341)
@@ -40,7 +40,7 @@
 
 	private:
 		std::vector&lt;Actor*&gt; mLights;
-		std::vector&lt;Actor*&gt; mSounds;
+		std::vector&lt;Ogre::String&gt; mSounds;
 	};
 
 }

Modified: rl/trunk/engine/core/include/ZoneManager.h
===================================================================
--- rl/trunk/engine/core/include/ZoneManager.h	2007-04-26 19:06:07 UTC (rev 3340)
+++ rl/trunk/engine/core/include/ZoneManager.h	2007-04-26 19:14:18 UTC (rev 3341)
@@ -30,16 +30,18 @@
 
         Zone* createZone(const Ogre::String&amp; name, const Ogre::Vector3&amp; position, const Ogre::Real radius, unsigned long queryflags);
 		Zone* getDefaultZone() const;
+		Zone* getZone(const Ogre::String&amp; name) const;
 
 		void areaLeft(Zone* zone);
 	    void areaEntered(Zone* zone);
 		
 	private:
-		std::vector&lt;Zone*&gt; mZones;
+		std::map&lt;const Ogre::String, Zone*&gt; mZones;
 		std::list&lt;Zone*&gt; mActiveZones;
 		Zone* mDefaultZone;
 
 		void switchLights();
+		void switchSounds();
 	};
 }
 

Modified: rl/trunk/engine/core/src/World.cpp
===================================================================
--- rl/trunk/engine/core/src/World.cpp	2007-04-26 19:06:07 UTC (rev 3340)
+++ rl/trunk/engine/core/src/World.cpp	2007-04-26 19:14:18 UTC (rev 3341)
@@ -67,7 +67,6 @@
     }
 
     //Enables / disables a 'sky dome' i.e.
-	///@todo eventuell in BSPWorld ueberschreiben
     void World::setSkyDome(bool enable, const String &amp;materialName,
         Real curvature, Real tiling, Real distance, bool drawFirst)
     {   

Modified: rl/trunk/engine/core/src/Zone.cpp
===================================================================
--- rl/trunk/engine/core/src/Zone.cpp	2007-04-26 19:06:07 UTC (rev 3340)
+++ rl/trunk/engine/core/src/Zone.cpp	2007-04-26 19:14:18 UTC (rev 3341)
@@ -41,13 +41,30 @@
 
 	void Zone::addLight(Actor* lo)
 	{
-		mLights.push_back(lo);
+		if (lo != NULL)
+		{
+			mLights.push_back(lo);
+		}
 	}
 
+	void Zone::addSound(const Ogre::String&amp; sound)
+	{
+		if (sound.length() &gt; 0)
+		{
+			mSounds.push_back(sound);
+		}
+	}
+
 	std::vector&lt;Actor*&gt; Zone::getLights() const
 	{
 		std::vector&lt;Actor*&gt; rval(mLights);
 		return rval;
 	}
+	
+	std::vector&lt;Ogre::String&gt; Zone::getSounds() const
+	{
+		std::vector&lt;Ogre::String&gt; rval(mSounds);
+		return rval;
+	}
 
 }

Modified: rl/trunk/engine/core/src/ZoneManager.cpp
===================================================================
--- rl/trunk/engine/core/src/ZoneManager.cpp	2007-04-26 19:06:07 UTC (rev 3340)
+++ rl/trunk/engine/core/src/ZoneManager.cpp	2007-04-26 19:14:18 UTC (rev 3341)
@@ -28,18 +28,18 @@
 	ZoneManager::ZoneManager()
 		: Ogre::Singleton&lt;ZoneManager&gt;()
 	{
-		// the default light zone is active when no other Zone is active
+		// the default zone is active when no other Zone is active
 		mDefaultZone = new Zone();
-		mZones.push_back(mDefaultZone);
 		mActiveZones.push_front(mDefaultZone); 
 	}
 
 	ZoneManager::~ZoneManager()
 	{
-		for (std::vector&lt;Zone*&gt;::iterator it = mZones.begin(); it != mZones.end(); ++it)
+		for (std::map&lt;const Ogre::String, Zone*&gt;::iterator it = mZones.begin(); it != mZones.end(); ++it)
 		{
-			delete *it;
+			delete (*it).second;
 		}
+		delete mDefaultZone;
 	}
 
 	Zone* ZoneManager::getDefaultZone() const
@@ -47,10 +47,24 @@
 		return mDefaultZone;
 	}
 
+	Zone* ZoneManager::getZone(const Ogre::String&amp; name) const
+	{
+		std::map&lt;const Ogre::String, Zone*&gt;::const_iterator it = mZones.find(name);
+		if (it == mZones.end())
+		{
+			LOG_ERROR(Logger::CORE, &quot;Zone '&quot;+name+&quot;' not found.&quot;);
+			return NULL;
+		}
+		else
+		{
+			return (*it).second;
+		}
+	}
+
     Zone* ZoneManager::createZone(const Ogre::String&amp; name, const Ogre::Vector3&amp; position, const Ogre::Real radius, unsigned long queryflags)
 	{
 		Zone* lz = new Zone();
-		mZones.push_back(lz);
+		mZones[name] = lz;
 
 		Actor* kugelDings = ActorManager::getSingleton().createEmptyActor(&quot;Light zone center&quot;);
 		kugelDings-&gt;placeIntoScene(position);
@@ -63,12 +77,14 @@
 	{
 		mActiveZones.remove(zone);
 		switchLights();
+		switchSounds();
 	}
 
 	void ZoneManager::areaEntered(Zone* zone)
 	{
 		mActiveZones.push_front(zone);
 		switchLights();
+		switchSounds();
 	}
 
 	void ZoneManager::switchLights()
@@ -83,16 +99,59 @@
 			(*it)-&gt;setVisible(true);
 		}
 
-		for (std::vector&lt;Zone*&gt;::const_iterator it = mZones.begin(); it != mZones.end(); it++)
+		for (std::map&lt;const Ogre::String, Zone*&gt;::const_iterator itZones = mZones.begin(); itZones != mZones.end(); itZones++)
 		{
-			std::vector&lt;Actor*&gt; curLights = (*it)-&gt;getLights();
-			for (std::vector&lt;Actor*&gt;::const_iterator it = curLights.begin(); it != curLights.end(); it++)
+			std::vector&lt;Actor*&gt; curLights = (*itZones).second-&gt;getLights();
+			for (std::vector&lt;Actor*&gt;::const_iterator itLights = curLights.begin(); itLights != curLights.end(); itLights++)
 			{
-				if (activeLights.find(*it) == activeLights.end())
+				if (activeLights.find(*itLights) == activeLights.end())
 				{
-					(*it)-&gt;setVisible(false);
+					(*itLights)-&gt;setVisible(false);
 				}
 			}
 		}
+
+		std::vector&lt;Actor*&gt; defLights = mDefaultZone-&gt;getLights();
+		for (std::vector&lt;Actor*&gt;::const_iterator itLights = defLights.begin(); itLights != defLights.end(); itLights++)
+		{
+			if (activeLights.find(*itLights) == activeLights.end())
+			{
+				(*itLights)-&gt;setVisible(false);
+			}
+		}
 	}
+	
+	void ZoneManager::switchSounds()
+	{
+		Zone* currentZone = mActiveZones.front();
+		std::set&lt;Ogre::String&gt; activeSounds;
+
+		std::vector&lt;Ogre::String&gt; curSounds = currentZone-&gt;getSounds();
+		for (std::vector&lt;Ogre::String&gt;::const_iterator it = curSounds.begin(); it != curSounds.end(); it++)
+		{
+			activeSounds.insert(*it);
+			///@todo switch sound on
+		}
+
+		for (std::map&lt;const Ogre::String, Zone*&gt;::const_iterator itZones = mZones.begin(); itZones != mZones.end(); itZones++)
+		{
+			std::vector&lt;Ogre::String&gt; curSounds = (*itZones).second-&gt;getSounds();
+			for (std::vector&lt;Ogre::String&gt;::const_iterator itSounds = curSounds.begin(); itSounds != curSounds.end(); itSounds++)
+			{
+				if (activeSounds.find(*itSounds) == activeSounds.end())
+				{
+					//@todo switch sound off
+				}
+			}
+		}
+
+		std::vector&lt;Ogre::String&gt; defSounds = mDefaultZone-&gt;getSounds();
+		for (std::vector&lt;Ogre::String&gt;::const_iterator itSounds = defSounds.begin(); itSounds != defSounds.end(); itSounds++)
+		{
+			if (activeSounds.find(*itSounds) == activeSounds.end())
+			{
+				//@todo switch sound off
+			}
+		}
+	}
 }

Modified: rl/trunk/engine/rules/include/MapLoader.h
===================================================================
--- rl/trunk/engine/rules/include/MapLoader.h	2007-04-26 19:06:07 UTC (rev 3340)
+++ rl/trunk/engine/rules/include/MapLoader.h	2007-04-26 19:14:18 UTC (rev 3341)
@@ -53,7 +53,9 @@
         Ogre::String mResourceGroup;
 
         void setRootSceneNode(Ogre::SceneNode* node);
-        void processNodes(XERCES_CPP_NAMESPACE::DOMElement* docElem, bool loadGameObjects);
+        void processSceneNodes(XERCES_CPP_NAMESPACE::DOMElement* nodesElem, bool loadGameObjects);
+        void processZones(XERCES_CPP_NAMESPACE::DOMElement* zonesElem);
+		void processSkySettings(XERCES_CPP_NAMESPACE::DOMElement* skyElem);
     };
 
 } // namespace rl

Modified: rl/trunk/engine/rules/src/MapLoader.cpp
===================================================================
--- rl/trunk/engine/rules/src/MapLoader.cpp	2007-04-26 19:06:07 UTC (rev 3340)
+++ rl/trunk/engine/rules/src/MapLoader.cpp	2007-04-26 19:14:18 UTC (rev 3341)
@@ -27,6 +27,7 @@
 #include &quot;ContentModule.h&quot;
 #include &quot;CoreSubsystem.h&quot;
 #include &quot;EntityNodeProcessor.h&quot;
+#include &quot;GameObjectConstants.h&quot;
 #include &quot;GameObjectNodeProcessor.h&quot;
 #include &quot;LightNodeProcessor.h&quot;
 #include &quot;PropertyReader.h&quot;
@@ -35,6 +36,8 @@
 #include &quot;XmlHelper.h&quot;
 #include &quot;XmlResource.h&quot;
 #include &quot;XmlResourceManager.h&quot;
+#include &quot;Zone.h&quot;
+#include &quot;ZoneManager.h&quot;
 
 using namespace Ogre;
 using namespace XERCES_CPP_NAMESPACE;
@@ -104,11 +107,10 @@
                         
             LOG_MESSAGE(Logger::RULES, &quot;Processing nodes&quot;);
             
-            processNodes(dataDocumentContent, loadGameObjects);
-            ///@todo process zones
-            ///@todo skies
+            processSceneNodes(XmlHelper::getChildNamed(dataDocumentContent, &quot;nodes&quot;), loadGameObjects);
+            processZones(XmlHelper::getChildNamed(dataDocumentContent, &quot;zones&quot;));
+            processSkySettings(XmlHelper::getChildNamed(dataDocumentContent, &quot;sky&quot;));
             
-            
             LOG_MESSAGE(Logger::RULES, &quot;Map loaded&quot;);
     
             doc-&gt;release();
@@ -123,13 +125,15 @@
 		XMLPlatformUtils::Terminate();
     }
 
-    void MapLoader::processNodes(DOMElement* dataDocumentContent, bool loadGameObjects)
+    void MapLoader::processSceneNodes(DOMElement* nodesElem, bool loadGameObjects)
     {
-        DOMElement* nodesElem = XmlHelper::getChildNamed(dataDocumentContent, &quot;nodes&quot;);
-        DOMNodeList* nodeNodes = nodesElem-&gt;getChildNodes();
-        for (XMLSize_t idx = 0; idx &lt; nodeNodes-&gt;getLength(); idx++)
+		if (nodesElem == NULL)
+		{
+			return;
+		}
+
+        for (DOMNode* cur = nodesElem-&gt;getFirstChild(); cur != NULL; cur = cur-&gt;getNextSibling())
         {
-            DOMNode* cur = nodeNodes-&gt;item(idx);
             if (cur-&gt;getNodeType() == DOMNode::ELEMENT_NODE)
             {
                 DOMElement* curElem = static_cast&lt;DOMElement*&gt;(cur);
@@ -149,7 +153,146 @@
         }
     }
 
+	void MapLoader::processZones(xercesc_2_7::DOMElement *zonesElem)
+	{
+		if (zonesElem == NULL)
+		{
+			return; // no zones
+		}
 
+        for (DOMNode* cur = zonesElem-&gt;getFirstChild(); cur != NULL; cur = cur-&gt;getNextSibling())
+        {
+            if (cur-&gt;getNodeType() == DOMNode::ELEMENT_NODE
+				&amp;&amp; XmlHelper::hasNodeName(cur, &quot;zone&quot;))
+            {
+				DOMElement* curZoneElem = static_cast&lt;DOMElement*&gt;(cur);
+				if (XmlHelper::hasAttribute(curZoneElem, &quot;type&quot;))
+				{
+					Ogre::String type = XmlHelper::getAttributeValueAsStdString(curZoneElem, &quot;type&quot;);
+					Zone* zone = NULL;
+					if (type == &quot;default&quot;)
+					{
+						zone = ZoneManager::getSingleton().getDefaultZone();
+					}
+					else if (type == &quot;mesh&quot;)
+					{
+						///@todo: zone = ZoneManager::getSingleton().createZone(...);
+					}
+					else if (type == &quot;sphere&quot;)
+					{						
+						Vector3 center = Vector3::ZERO;
+						DOMElement* centerElem = XmlHelper::getChildNamed(curZoneElem, &quot;center&quot;);
+						if (centerElem != NULL)
+						{
+							center = XmlHelper::getValueAsVector3(centerElem);
+						}
+
+						Real radius = 1;
+						DOMElement* radiusElem = XmlHelper::getChildNamed(curZoneElem, &quot;radius&quot;);
+						if (radiusElem != NULL)
+						{
+							radius = XmlHelper::getAttributeValueAsReal(radiusElem, &quot;r&quot;);
+						}
+
+						Ogre::String name = XmlHelper::getAttributeValueAsStdString(curZoneElem, &quot;name&quot;);
+
+						zone = ZoneManager::getSingleton().createZone(
+							name, center, radius, QUERYFLAG_PLAYER);
+					}
+
+					if (zone != NULL)
+					{
+						for (DOMNode* cur = curZoneElem-&gt;getFirstChild(); cur != NULL; cur = cur-&gt;getNextSibling())
+						{
+							if (cur-&gt;getNodeType() == DOMNode::ELEMENT_NODE)
+							{
+								DOMElement* curElem = static_cast&lt;DOMElement*&gt;(cur);
+								if (XmlHelper::hasNodeName(curElem, &quot;light&quot;))
+								{
+									Ogre::String name = XmlHelper::getAttributeValueAsStdString(curElem, &quot;name&quot;);
+									zone-&gt;addLight(ActorManager::getSingleton().getActor(name));
+								}
+								else if (XmlHelper::hasNodeName(curElem, &quot;sound&quot;))
+								{
+									Ogre::String name = XmlHelper::getAttributeValueAsStdString(curElem, &quot;name&quot;);
+									zone-&gt;addSound(name);
+								}
+							}
+						}
+					}
+					else
+					{
+						LOG_ERROR(Logger::RULES, &quot;Zone of type '&quot;+type+&quot;' could not be processes.&quot;);
+					}
+				}
+				else
+				{
+					LOG_ERROR(Logger::RULES, &quot;&lt;zone&gt; element must have attribute 'type'.&quot;);
+				}
+			}
+		}
+	}
+
+	void MapLoader::processSkySettings(XERCES_CPP_NAMESPACE::DOMElement* skyElem)
+	{
+        if (skyElem == NULL)
+		{
+			return;
+		}
+
+		if (!XmlHelper::hasAttribute(skyElem, &quot;material&quot;) 
+			|| !XmlHelper::hasAttribute(skyElem, &quot;type&quot;))
+		{
+			LOG_ERROR(Logger::RULES, &quot;&lt;sky&gt; element must have at least attributes 'type' and 'material'.&quot;);
+		}
+		else
+		{
+			Ogre::String type = XmlHelper::getAttributeValueAsStdString(skyElem, &quot;type&quot;);
+			Ogre::String material = XmlHelper::getAttributeValueAsStdString(skyElem, &quot;material&quot;);
+
+			bool drawFirst = true;
+			if (XmlHelper::hasAttribute(skyElem, &quot;drawfirst&quot;))
+			{
+				drawFirst = XmlHelper::getAttributeValueAsBool(skyElem, &quot;drawfirst&quot;);
+			}
+			
+			Ogre::Real distance = 5000;
+			if (XmlHelper::hasAttribute(skyElem, &quot;distance&quot;))
+			{
+				drawFirst = XmlHelper::getAttributeValueAsBool(skyElem, &quot;distance&quot;);
+			}				
+
+			if (type == &quot;dome&quot;)
+			{
+				Ogre::Real curvature = 10;
+				Ogre::Real tiling = 8;
+
+				DOMElement* domeSettings = XmlHelper::getChildNamed(skyElem, &quot;skydomesettings&quot;);
+				if (domeSettings != NULL)
+				{
+					if (XmlHelper::hasAttribute(domeSettings, &quot;curvature&quot;))
+					{
+						curvature = XmlHelper::getAttributeValueAsReal(domeSettings, &quot;curvature&quot;);
+					}
+					if (XmlHelper::hasAttribute(domeSettings, &quot;tiling&quot;))
+					{
+						curvature = XmlHelper::getAttributeValueAsReal(domeSettings, &quot;tiling&quot;);
+					}
+				}
+				CoreSubsystem::getSingleton().getWorld()-&gt;setSkyDome(
+					true, material, curvature, tiling, distance, drawFirst);
+			}
+			else if (type == &quot;box&quot;)
+			{
+				CoreSubsystem::getSingleton().getWorld()-&gt;setSkyBox(true, material, distance, drawFirst);
+			}
+			else if (type == &quot;plane&quot;)
+			{
+				LOG_ERROR(Logger::RULES, &quot;Sky Plane is not implemented yet.&quot;);
+			}
+		}
+	}
+
     void MapLoader::setRootSceneNode(SceneNode* node)
     {
         mRootSceneNode = node;

Modified: rl/trunk/engine/script/swig/RlCore.swig
===================================================================
--- rl/trunk/engine/script/swig/RlCore.swig	2007-04-26 19:06:07 UTC (rev 3340)
+++ rl/trunk/engine/script/swig/RlCore.swig	2007-04-26 19:14:18 UTC (rev 3341)
@@ -856,6 +856,7 @@
 {
 public:
 	void addLight(Actor* light);
+	void addSound(const Ogre::String&amp; sound);
 };
 
 class ZoneManager
@@ -864,6 +865,7 @@
 	static const ZoneManager&amp; getSingleton();
 	Zone* createZone(const Ogre::String&amp; name, const Ogre::Vector3&amp; position, const Ogre::Real radius, unsigned long queryflags);
 	Zone* getDefaultZone() const;
+	Zone* getZone(const Ogre::String&amp; name) const;
 };
 
 


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000411.html">[Dsa-hl-svn] r3340 - in modules: common/materials/model	ruchin/materials/textures techdemo2/materials/textures
</A></li>
	<LI>Next message: <A HREF="000413.html">[Dsa-hl-svn] r3342 - modules/techdemo/scripts	modules/techdemo/scripts/maps rl/trunk/engine/rules	rl/trunk/engine/rules/include rl/trunk/engine/rules/src	rl/trunk/engine/script/swig
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#412">[ date ]</a>
              <a href="thread.html#412">[ thread ]</a>
              <a href="subject.html#412">[ subject ]</a>
              <a href="author.html#412">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/dsa-hl-svn">More information about the Dsa-hl-svn
mailing list</a><br>
</body></html>
