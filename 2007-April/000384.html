<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Dsa-hl-svn] r3313 - in rl/trunk/engine: core/include core/src	dialog/include dialog/src script script/swig ui ui/include ui/src
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/dsa-hl-svn/2007-April/index.html" >
   <LINK REL="made" HREF="mailto:dsa-hl-svn%40lists.berlios.de?Subject=Re%3A%20%5BDsa-hl-svn%5D%20r3313%20-%20in%20rl/trunk/engine%3A%20core/include%20core/src%0A%09dialog/include%20dialog/src%20script%20script/swig%20ui%20ui/include%20ui/src&In-Reply-To=%3C200704182007.l3IK7Fpn024931%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000382.html">
   <LINK REL="Next"  HREF="000385.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Dsa-hl-svn] r3313 - in rl/trunk/engine: core/include core/src	dialog/include dialog/src script script/swig ui ui/include ui/src</H1>
    <B>tanis at mail.berlios.de</B> 
    <A HREF="mailto:dsa-hl-svn%40lists.berlios.de?Subject=Re%3A%20%5BDsa-hl-svn%5D%20r3313%20-%20in%20rl/trunk/engine%3A%20core/include%20core/src%0A%09dialog/include%20dialog/src%20script%20script/swig%20ui%20ui/include%20ui/src&In-Reply-To=%3C200704182007.l3IK7Fpn024931%40sheep.berlios.de%3E"
       TITLE="[Dsa-hl-svn] r3313 - in rl/trunk/engine: core/include core/src	dialog/include dialog/src script script/swig ui ui/include ui/src">tanis at mail.berlios.de
       </A><BR>
    <I>Wed Apr 18 22:07:15 CEST 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="000382.html">[Dsa-hl-svn] r3312 - modules/techdemo2/scripts
</A></li>
        <LI>Next message: <A HREF="000385.html">[Dsa-hl-svn] r3314 - in modules: combattest/scripts/maps	common/scripts intro/scripts regressiontest/dialogs
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#384">[ date ]</a>
              <a href="thread.html#384">[ thread ]</a>
              <a href="subject.html#384">[ subject ]</a>
              <a href="author.html#384">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: tanis
Date: 2007-04-18 22:06:35 +0200 (Wed, 18 Apr 2007)
New Revision: 3313

Removed:
   rl/trunk/engine/ui/include/CommandMapperWindow.h
   rl/trunk/engine/ui/src/CommandMapperWindow.cpp
Modified:
   rl/trunk/engine/core/include/ConfigurationManager.h
   rl/trunk/engine/core/src/ConfigurationManager.cpp
   rl/trunk/engine/core/src/CoreSubsystem.cpp
   rl/trunk/engine/core/src/DotSceneLoader.cpp
   rl/trunk/engine/core/src/DotSceneOctreeWorld.cpp
   rl/trunk/engine/dialog/include/DialogCharacter.h
   rl/trunk/engine/dialog/include/DialogSubsystem.h
   rl/trunk/engine/dialog/src/DialogSubsystem.cpp
   rl/trunk/engine/script/RlScript2005.vcproj
   rl/trunk/engine/script/swig/RlUi.head.swig
   rl/trunk/engine/script/swig/RlUi.swig
   rl/trunk/engine/ui/RlUI2005.vcproj
   rl/trunk/engine/ui/include/CharacterController.h
   rl/trunk/engine/ui/include/CombatCharacterController.h
   rl/trunk/engine/ui/include/CommandMapper.h
   rl/trunk/engine/ui/include/CutsceneCharacterController.h
   rl/trunk/engine/ui/include/DialogCharacterController.h
   rl/trunk/engine/ui/include/DialogWindow.h
   rl/trunk/engine/ui/include/FreeFlightCharacterController.h
   rl/trunk/engine/ui/include/InputManager.h
   rl/trunk/engine/ui/include/MovementCharacterController.h
   rl/trunk/engine/ui/include/UiPrerequisites.h
   rl/trunk/engine/ui/include/UiSubsystem.h
   rl/trunk/engine/ui/include/WindowFactory.h
   rl/trunk/engine/ui/src/CharacterController.cpp
   rl/trunk/engine/ui/src/CombatCharacterController.cpp
   rl/trunk/engine/ui/src/CommandMapper.cpp
   rl/trunk/engine/ui/src/CutsceneCharacterController.cpp
   rl/trunk/engine/ui/src/DialogCharacterController.cpp
   rl/trunk/engine/ui/src/DialogWindow.cpp
   rl/trunk/engine/ui/src/FreeFlightCharacterController.cpp
   rl/trunk/engine/ui/src/InputManager.cpp
   rl/trunk/engine/ui/src/MovementCharacterController.cpp
   rl/trunk/engine/ui/src/UiSubsystem.cpp
   rl/trunk/engine/ui/src/WindowFactory.cpp
Log:
* ConfigurationManager now uses Strings to identify sections rather than a hard-wired enum.
* Remove defunct and unused CommandMapperWindow. The functionality will be provided by the options window.
*Action keys are now stored as global and as per control state.
* Controllers are now managed by InputManager and the Controller interface has been changed. ControlStates are now managed as a stack rather than an amorphous mass. Each control state now handles all non-global input and can be paused and resumed.
*DialogWindow/DialogController-interaction improved. But still much to do here.
DialogWindow is now reused instead of created/discarded for each dialog.
* DialogController is now a concrete class. former abstract methods got a default implementation.

Modified: rl/trunk/engine/core/include/ConfigurationManager.h
===================================================================
--- rl/trunk/engine/core/include/ConfigurationManager.h	2007-04-18 18:58:56 UTC (rev 3312)
+++ rl/trunk/engine/core/include/ConfigurationManager.h	2007-04-18 20:06:35 UTC (rev 3313)
@@ -44,14 +44,6 @@
     class _RlCoreExport ConfigurationManager : protected Ogre::Singleton&lt;ConfigurationManager&gt;
     {
         public:
-            /// Sections where settings can be queried from
-            enum ConfigurationSection
-            {
-                CS_GENERAL = 1,
-                CS_GRAPHICS,
-                CS_SOUND,
-                CS_INPUT
-            };
 
             ~ConfigurationManager();
 
@@ -133,7 +125,7 @@
              * @param key The key of the key-value pair
              * @param value The value of the key-value pair
              */
-            void addSetting(const ConfigurationSection&amp; section, const Ogre::String&amp; key, const Ogre::String&amp; value);
+            void addSetting(const Ogre::String&amp; section, const Ogre::String&amp; key, const Ogre::String&amp; value);
 
             /**
              * Returns the string value for a specific key in a specific section
@@ -142,7 +134,7 @@
              * @param key The key, for which a value will be returned
              * @return string value for the specific key in the specific section
              */
-            Ogre::String getStringSetting(const ConfigurationSection&amp; section, const Ogre::String&amp; key) const;
+            Ogre::String getStringSetting(const Ogre::String&amp; section, const Ogre::String&amp; key) const;
 
             /**
              * Returns the int value for a specific key in a specific section
@@ -151,7 +143,7 @@
              * @param key The key, for which a value will be returned
              * @return int value for the specific key in the specific section
              */
-            int getIntSetting(const ConfigurationSection&amp; section, const Ogre::String&amp; key) const;
+            int getIntSetting(const Ogre::String&amp; section, const Ogre::String&amp; key) const;
 
             /**
              * Returns the boolean value for a specific key in a specific section
@@ -160,7 +152,7 @@
              * @param key The key, for which a value will be returned
              * @return boolean value for the specific key in the specific section
              */
-            bool getBoolSetting(const ConfigurationSection&amp; section, const Ogre::String&amp; key) const;
+            bool getBoolSetting(const Ogre::String&amp; section, const Ogre::String&amp; key) const;
 
             /**
              * Returns the real value for a specific key in a specific section
@@ -169,30 +161,16 @@
              * @param key The key, for which a value will be returned
              * @return real value for the specific key in the specific section
              */
-            Ogre::Real getRealSetting(const ConfigurationSection&amp; section, const Ogre::String&amp; key) const;
+            Ogre::Real getRealSetting(const Ogre::String&amp; section, const Ogre::String&amp; key) const;
 
             /**
-             * Returns a pointer to the graphical settings for the OGRE renderer
-             *
+             * Returns a pointer to the settings of the named section.
+             * @param section name of the section to get settings of.
              * @return key-value list of graphic settings
              */
-            Ogre::NameValuePairList getGraphicSettings() const;
+            Ogre::NameValuePairList getSettings(const Ogre::String&amp; section) const;
 
             /**
-             * Returns a pointer to the sound settings for the Rl::SoundManager
-             *
-             * @return key-value list of sound settings
-             */
-            Ogre::NameValuePairList getSoundSettings() const;
-
-            /**
-             * Returns the input settings for the CommandMapper
-             *
-             * @return key-value list of input settings
-             */
-            Ogre::NameValuePairList getInputSettings() const;
-
-            /**
              * Returns a list of Ogre plugins specific to the OS
              *
              * @return vector of plugin names
@@ -236,6 +214,7 @@
             void saveConfig() const;
 
         private:
+
             /**
              * Constructs a new ConfigurationManager object.
              *
@@ -276,7 +255,7 @@
              * @param key The key, for which a value will be returned
              * @return value if key exits, otherwise NULL
              */
-            Ogre::String findSetting(const ConfigurationSection&amp; section, const Ogre::String&amp; key) const;
+            Ogre::String findSetting(const Ogre::String&amp; section, const Ogre::String&amp; key) const;
 
             Ogre::String mRastullahCfgFile;           //!&lt; Filename of the Rastullah configuration file
             Ogre::String mOgreLogFile;                //!&lt; Filename of the logfile written by OGRE
@@ -287,12 +266,12 @@
             Ogre::String mRastullahLogDirectory;      //!&lt; Directory where all logfiles are stored
             Ogre::String mRastullahCfgPath;           //!&lt; List of directories containing Rastullah configuration files
             Ogre::String mOgrePluginDirectory;        //!&lt; Directory where OGRE stores its plugins
-            Ogre::NameValuePairList mGeneralSettings; //!&lt; General settings for Rastullah
-            Ogre::NameValuePairList mGraphicSettings; //!&lt; Graphic settings for the OGRE Renderer
-            Ogre::NameValuePairList mSoundSettings;   //!&lt; Sound settings for the Rastullah soundsystem
-            Ogre::NameValuePairList mInputSettings;   //!&lt; Input settings for the Rastullah inputsystem
             Ogre::StringVector mModuleList;           //!&lt; List of Rastullah game modules
             Ogre::StringVector mPluginList;           //!&lt; List of OGRE Plugins, which will be loaded by CoreSubsystem
+
+            typedef std::map&lt;Ogre::String, Ogre::NameValuePairList&gt; SectionMap;
+            /// Stores settings per section in a NameValuePairList
+            SectionMap mSettings;                     
     };
 }
 

Modified: rl/trunk/engine/core/src/ConfigurationManager.cpp
===================================================================
--- rl/trunk/engine/core/src/ConfigurationManager.cpp	2007-04-18 18:58:56 UTC (rev 3312)
+++ rl/trunk/engine/core/src/ConfigurationManager.cpp	2007-04-18 20:06:35 UTC (rev 3313)
@@ -25,8 +25,6 @@
 
 template&lt;&gt; rl::ConfigurationManager* Ogre::Singleton&lt;rl::ConfigurationManager&gt;::ms_Singleton = 0;
 
-using namespace std;
-
 namespace rl
 {
     ConfigurationManager* ConfigurationManager::getSingletonPtr()
@@ -59,64 +57,68 @@
         mModulesCfgFile = &quot;modules.cfg&quot;;
 
         // Setup general default values
-        mGeneralSettings.insert(make_pair(&quot;Log Level&quot;, &quot;2&quot;));
-        mGeneralSettings.insert(make_pair(&quot;Subtitle Speed&quot;, &quot;0.0&quot;));
+        addSetting(&quot;General&quot;, &quot;LogLevel&quot;, &quot;2&quot;);
+        addSetting(&quot;General&quot;, &quot;Subtitle Speed&quot;, &quot;0.0&quot;);
 
         // Setup sound default values
-        mSoundSettings.insert(make_pair(&quot;DefaultMusicVolume&quot;, &quot;0.4&quot;));
-        mSoundSettings.insert(make_pair(&quot;DefaultSoundVolume&quot;, &quot;0.9&quot;));
-        mSoundSettings.insert(make_pair(&quot;MasterVolume&quot;, &quot;1&quot;));
+        addSetting(&quot;Sound&quot;, &quot;DefaultMusicVolume&quot;, &quot;0.4&quot;);
+        addSetting(&quot;Sound&quot;, &quot;DefaultSoundVolume&quot;, &quot;0.9&quot;);
+        addSetting(&quot;Sound&quot;, &quot;MasterVolume&quot;, &quot;1&quot;);
 
         // Setup graphic default values
 #       if OGRE_PLATFORM == OGRE_PLATFORM_WIN32
-        mGraphicSettings.insert(make_pair(&quot;Render System&quot;, &quot;Direct3D9 Rendering Subsystem&quot;));
+        addSetting(&quot;Video&quot;, &quot;Render System&quot;, &quot;Direct3D9 Rendering Subsystem&quot;);
 #       else
-        mGraphicSettings.insert(make_pair(&quot;Render System&quot;,&quot;OpenGL Rendering Subsystem&quot;));
-        mGraphicSettings.insert(make_pair(&quot;RTT Preferred Mode&quot;, &quot;FBO&quot;));
+        addSetting(&quot;Video&quot;, &quot;Render System&quot;,&quot;OpenGL Rendering Subsystem&quot;);
+        addSetting(&quot;Video&quot;, &quot;RTT Preferred Mode&quot;, &quot;FBO&quot;);
 #       endif
-        mGraphicSettings.insert(make_pair(&quot;Fullscreen&quot;, &quot;no&quot;));
-        mGraphicSettings.insert(make_pair(&quot;FSAA&quot;, &quot;0&quot;));
-        mGraphicSettings.insert(make_pair(&quot;Video Mode&quot;, &quot;800 x 600&quot;));
-        mGraphicSettings.insert(make_pair(&quot;Use Static Geometry&quot;, &quot;auto&quot;));
-        mGraphicSettings.insert(make_pair(&quot;Max Anisotropy&quot;, &quot;1&quot;));
-		mGraphicSettings.insert(make_pair(&quot;Cast Shadows&quot;, &quot;yes&quot;));
-		mGraphicSettings.insert(make_pair(&quot;Shadow Texture Size&quot;, &quot;512&quot;));
+        addSetting(&quot;Video&quot;, &quot;Fullscreen&quot;, &quot;no&quot;);
+        addSetting(&quot;Video&quot;, &quot;FSAA&quot;, &quot;0&quot;);
+        addSetting(&quot;Video&quot;, &quot;Video Mode&quot;, &quot;800 x 600&quot;);
+        addSetting(&quot;Video&quot;, &quot;Use Static Geometry&quot;, &quot;auto&quot;);
+        addSetting(&quot;Video&quot;, &quot;Max Anisotropy&quot;, &quot;1&quot;);
+		addSetting(&quot;Video&quot;, &quot;Cast Shadows&quot;, &quot;yes&quot;);
+		addSetting(&quot;Video&quot;, &quot;Shadow Texture Size&quot;, &quot;512&quot;);
 
         // Setup input default values
-        mInputSettings.insert(make_pair(&quot;Mouse Sensitivity&quot;, &quot;4&quot;));
-        mInputSettings.insert(make_pair(&quot;Mouse Invert&quot;, &quot;no&quot;));
-        mInputSettings.insert(make_pair(&quot;mov_turn_left&quot;, &quot;Q&quot;));
-        mInputSettings.insert(make_pair(&quot;mov_turn_right&quot;, &quot;E&quot;));
-        mInputSettings.insert(make_pair(&quot;mov_move_left&quot;, &quot;A&quot;));
-        mInputSettings.insert(make_pair(&quot;mov_move_right&quot;, &quot;D&quot;));
-        mInputSettings.insert(make_pair(&quot;mov_move_forward&quot;, &quot;W&quot;));
-        mInputSettings.insert(make_pair(&quot;mov_move_backward&quot;, &quot;S&quot;));
-        mInputSettings.insert(make_pair(&quot;mov_jump&quot;, &quot;Leertaste&quot;));
-        mInputSettings.insert(make_pair(&quot;mov_run&quot;, &quot;Umschalt links&quot;));
-        mInputSettings.insert(make_pair(&quot;mov_sneak&quot;, &quot;Strg links&quot;));
-        mInputSettings.insert(make_pair(&quot;mov_run_lock&quot;, &quot;&lt; | &gt;&quot;));
-        mInputSettings.insert(make_pair(&quot;act_quitgame&quot;, &quot;Ctrl+X&quot;));
-		mInputSettings.insert(make_pair(&quot;act_forcequitgame&quot;, &quot;Alt+F4&quot;));
-        mInputSettings.insert(make_pair(&quot;act_closecurrentwindow&quot;, &quot;Escape&quot;));
-        mInputSettings.insert(make_pair(&quot;act_toggleconsole&quot;, &quot;Tabulator&quot;));
-        mInputSettings.insert(make_pair(&quot;act_toggledebugwindow&quot;, &quot;F2&quot;));
-        mInputSettings.insert(make_pair(&quot;act_togglegamelogwindow&quot;, &quot;F3&quot;));
-        mInputSettings.insert(make_pair(&quot;act_toggleviewmode&quot;, &quot;F&quot;));
-        mInputSettings.insert(make_pair(&quot;act_resetcamera&quot;, &quot;0 (Nummernblock)&quot;));
-        mInputSettings.insert(make_pair(&quot;act_makescreenshot&quot;, &quot;P,Ctrl+P&quot;));
-        mInputSettings.insert(make_pair(&quot;act_togglecollisiondebug&quot;, &quot;L,Ctrl+L&quot;));
-        mInputSettings.insert(make_pair(&quot;act_toggledebugvisualisation&quot;, &quot;Ctrl+O&quot;));
-        mInputSettings.insert(make_pair(&quot;act_togglevanitymode&quot;, &quot;V&quot;));
-        mInputSettings.insert(make_pair(&quot;act_usecurrentobjectdefaultaction&quot;, &quot;R&quot;));
-        mInputSettings.insert(make_pair(&quot;act_toggleinventorywindow&quot;, &quot;I&quot;));
-        mInputSettings.insert(make_pair(&quot;act_showjournalwindow&quot;, &quot;J&quot;));
-        mInputSettings.insert(make_pair(&quot;act_showcharactersheet&quot;, &quot;C&quot;));
-        mInputSettings.insert(make_pair(&quot;act_togglecharacterstatewindow&quot;, &quot;O&quot;));
-        mInputSettings.insert(make_pair(&quot;act_toggleingameglobalmenu&quot;, &quot;F10&quot;));
-        mInputSettings.insert(make_pair(&quot;act_togglecharactercontroller&quot;, &quot;M&quot;));
-        mInputSettings.insert(make_pair(&quot;act_shownextdebugwindowpage&quot;, &quot;Ctrl+M&quot;));
-        mInputSettings.insert(make_pair(&quot;act_showobjectactions&quot;, &quot;U&quot;));
+        addSetting(&quot;Input&quot;, &quot;Mouse Sensitivity&quot;, &quot;4&quot;);
+        addSetting(&quot;Input&quot;, &quot;Mouse Invert&quot;, &quot;no&quot;);
 
+        addSetting(&quot;Movement keys&quot;, &quot;turn_left&quot;, &quot;Q&quot;);
+        addSetting(&quot;Movement keys&quot;, &quot;turn_right&quot;, &quot;E&quot;);
+        addSetting(&quot;Movement keys&quot;, &quot;move_left&quot;, &quot;A&quot;);
+        addSetting(&quot;Movement keys&quot;, &quot;move_right&quot;, &quot;D&quot;);
+        addSetting(&quot;Movement keys&quot;, &quot;move_forward&quot;, &quot;W&quot;);
+        addSetting(&quot;Movement keys&quot;, &quot;move_backward&quot;, &quot;S&quot;);
+        addSetting(&quot;Movement keys&quot;, &quot;jump&quot;, &quot;Leertaste&quot;);
+        addSetting(&quot;Movement keys&quot;, &quot;run&quot;, &quot;Umschalt links&quot;);
+        addSetting(&quot;Movement keys&quot;, &quot;sneak&quot;, &quot;Strg links&quot;);
+        addSetting(&quot;Movement keys&quot;, &quot;run_lock&quot;, &quot;&lt; | &gt;&quot;);
+
+        addSetting(&quot;Action keys&quot;, &quot;quitgame&quot;, &quot;Ctrl+X&quot;);
+        addSetting(&quot;Action keys&quot;, &quot;closecurrentwindow&quot;, &quot;Escape&quot;);
+        addSetting(&quot;Action keys&quot;, &quot;toggleconsole&quot;, &quot;Tabulator&quot;);
+        addSetting(&quot;Action keys&quot;, &quot;toggledebugwindow&quot;, &quot;F2&quot;);
+        addSetting(&quot;Action keys&quot;, &quot;togglegamelogwindow&quot;, &quot;F3&quot;);
+        addSetting(&quot;Action keys&quot;, &quot;toggleviewmode&quot;, &quot;F&quot;);
+        addSetting(&quot;Action keys&quot;, &quot;resetcamera&quot;, &quot;0 (Nummernblock)&quot;);
+        addSetting(&quot;Action keys&quot;, &quot;makescreenshot&quot;, &quot;P,Ctrl+P&quot;);
+        addSetting(&quot;Action keys&quot;, &quot;togglecollisiondebug&quot;, &quot;L,Ctrl+L&quot;);
+        addSetting(&quot;Action keys&quot;, &quot;toggledebugvisualisation&quot;, &quot;Ctrl+O&quot;);
+        addSetting(&quot;Action keys&quot;, &quot;togglevanitymode&quot;, &quot;V&quot;);
+        addSetting(&quot;Action keys&quot;, &quot;usecurrentobjectdefaultaction&quot;, &quot;R&quot;);
+        addSetting(&quot;Action keys&quot;, &quot;toggleinventorywindow&quot;, &quot;I&quot;);
+        addSetting(&quot;Action keys&quot;, &quot;showjournalwindow&quot;, &quot;J&quot;);
+        addSetting(&quot;Action keys&quot;, &quot;showcharactersheet&quot;, &quot;C&quot;);
+        addSetting(&quot;Action keys&quot;, &quot;togglecharacterstatewindow&quot;, &quot;O&quot;);
+        addSetting(&quot;Action keys&quot;, &quot;toggleingameglobalmenu&quot;, &quot;F10&quot;);
+        addSetting(&quot;Action keys&quot;, &quot;shownextdebugwindowpage&quot;, &quot;Ctrl+M&quot;);
+        addSetting(&quot;Action keys&quot;, &quot;showobjectactions&quot;, &quot;U&quot;);
+
+        addSetting(&quot;FreeflightController keys&quot;, &quot;back_to_character_movement&quot;, &quot;M&quot;);
+
+        addSetting(&quot;MovementController keys&quot;, &quot;freeflight_mode&quot;, &quot;M&quot;);
+
         setRastullahCfgPath();
     }
 
@@ -149,21 +151,19 @@
         return mRastullahLogDirectory;
     }
 
-    Ogre::NameValuePairList ConfigurationManager::getGraphicSettings() const
+    Ogre::NameValuePairList ConfigurationManager::getSettings(const Ogre::String&amp; section) const
     {
-        return mGraphicSettings;
+        SectionMap::const_iterator it = mSettings.find(section);
+        if (it != mSettings.end())
+        {
+            return it-&gt;second;
+        }
+        else
+        {
+            return Ogre::NameValuePairList();
+        }
     }
 
-    Ogre::NameValuePairList ConfigurationManager::getSoundSettings() const
-    {
-        return mSoundSettings;
-    }
-
-    Ogre::NameValuePairList ConfigurationManager::getInputSettings() const
-    {
-        return mInputSettings;
-    }
-
     Ogre::StringVector ConfigurationManager::getPluginList() const
     {
         return mPluginList;
@@ -210,98 +210,37 @@
                          &quot;' nicht laden! Defaulteinstellungen werden benutzt.&quot;,&quot;Configuration&quot;);
                 }
 
-                // Set log, modules and OGRE plugin directory
-                if (!configfile-&gt;getSetting(&quot;LogDirectory&quot;, &quot;Paths&quot;).empty())
-                {
-                    mRastullahLogDirectory = configfile-&gt;getSetting(&quot;LogDirectory&quot;, &quot;Paths&quot;);
-                }
-
-                if (!configfile-&gt;getSetting(&quot;ModulesDirectory&quot;, &quot;Paths&quot;).empty())
-                {
-                    mModulesRootDirectory = configfile-&gt;getSetting(&quot;ModulesDirectory&quot;, &quot;Paths&quot;);
-                }
-
-                if (!configfile-&gt;getSetting(&quot;OgrePluginDirectory&quot;, &quot;Paths&quot;).empty())
-                {
-                    mOgrePluginDirectory = configfile-&gt;getSetting(&quot;OgrePluginDirectory&quot;, &quot;Paths&quot;);
-                }
-
-                // Get general settings
                 try
                 {
-                    for (ConfigFile::SettingsIterator it =
-                        configfile-&gt;getSettingsIterator(&quot;General&quot;);
-                        it.hasMoreElements(); it.moveNext())
+                    for (ConfigFile::SectionIterator it = configfile-&gt;getSectionIterator();
+                            it.hasMoreElements(); it.moveNext())
                     {
-                        addSetting(CS_GENERAL, it.peekNextKey(), it.peekNextValue());
+                        Ogre::String sectionName = it.peekNextKey();
+                        Ogre::NameValuePairList settings = mSettings[sectionName];
+                        for (ConfigFile::SettingsIterator it =
+                            configfile-&gt;getSettingsIterator(sectionName);
+                            it.hasMoreElements(); it.moveNext())
+                        {
+                            settings[it.peekNextKey()] = it.peekNextValue();
+                        }
+                        mSettings[sectionName] = settings;
                     }
                 }
                 catch (Ogre::Exception&amp;)
                 {
                     // Log it as information
                     LOG_WARNING(Logger::CORE, &quot;Configuration File &quot; + cfg_paths[i] +
-                        mRastullahCfgFile +
-                        &quot; does not contain a section 'General'. Defaults will be used.&quot;);
+                        mRastullahCfgFile + &quot; - Error on parsing.&quot;);
                 }
-
-                // Get video settings
-                try
-                {
-                    for (ConfigFile::SettingsIterator it =
-                        configfile-&gt;getSettingsIterator(&quot;Video&quot;);
-                        it.hasMoreElements(); it.moveNext())
-                    {
-                        addSetting(CS_GRAPHICS, it.peekNextKey(), it.peekNextValue());
-                    }
-                }
-                catch (Ogre::Exception&amp;)
-                {
-                    // Log it as information
-                    LOG_WARNING(Logger::CORE, &quot;Configuration File &quot; + cfg_paths[i] +
-                        mRastullahCfgFile +
-                        &quot; does not contain a section 'Video'. Defaults will be used.&quot;);
-                }
-
-                // Get sound settings
-                try
-                {
-                    for (ConfigFile::SettingsIterator it =
-                        configfile-&gt;getSettingsIterator(&quot;Sound&quot;);
-                        it.hasMoreElements(); it.moveNext())
-                    {
-                        addSetting(CS_SOUND, it.peekNextKey(), it.peekNextValue());
-                    }
-                }
-                catch (Ogre::Exception&amp;)
-                {
-                    // Log it as information
-                    LOG_WARNING(Logger::CORE, &quot;Configuration File &quot; + cfg_paths[i] +
-                        mRastullahCfgFile +
-                        &quot; does not contain a section 'Video'. Defaults will be used.&quot;);
-                }
-
-                // Get input settings
-                try
-                {
-                    for (ConfigFile::SettingsIterator it =
-                        configfile-&gt;getSettingsIterator(&quot;Input&quot;);
-                        it.hasMoreElements(); it.moveNext())
-                    {
-                        addSetting(CS_INPUT, it.peekNextKey(), it.peekNextValue());
-                    }
-                }
-                catch (Ogre::Exception&amp;)
-                {
-                    // Log it as information
-                    LOG_WARNING(Logger::CORE, &quot;Configuration File &quot; + cfg_paths[i] +
-                        mRastullahCfgFile +
-                        &quot; does not contain a section 'Input'. Defaults will be used.&quot;);
-                }
             }
 
             delete configfile;
         }
 
+        mRastullahLogDirectory = findSetting(&quot;Paths&quot;, &quot;LogDirectory&quot;);
+        mModulesRootDirectory = findSetting(&quot;Paths&quot;, &quot;ModulesDirectory&quot;);
+        mOgrePluginDirectory = findSetting(&quot;Paths&quot;, &quot;OgrePluginDirectory&quot;);
+
         if (mRastullahLogDirectory.empty())
         {
 #           if OGRE_PLATFORM == OGRE_PLATFORM_LINUX
@@ -362,144 +301,74 @@
     {
         ConfigFile* cfgfile = new ConfigFile();
 
-        // Create the path list
-        Ogre::NameValuePairList* PathSettings = new Ogre::NameValuePairList();
-        PathSettings-&gt;insert(make_pair(&quot;ModulesDirectory&quot;, mModulesRootDirectory));
-        PathSettings-&gt;insert(make_pair(&quot;OgrePluginDirectory&quot;, mOgrePluginDirectory));
-        PathSettings-&gt;insert(make_pair(&quot;LogDirectory&quot;, mRastullahLogDirectory));
+        for (SectionMap::const_iterator it = mSettings.begin(); it != mSettings.end(); ++it)
+        {
+            cfgfile-&gt;addSection(it-&gt;first, it-&gt;second);
+        }
 
-        // Add General settings
-        cfgfile-&gt;addSection(&quot;General&quot;, mGeneralSettings);
-        // Add Path settings
-        cfgfile-&gt;addSection(&quot;Paths&quot;, *PathSettings);
-        // Add Video settings
-        cfgfile-&gt;addSection(&quot;Video&quot;, mGraphicSettings);
-        // Add Sound settings
-        cfgfile-&gt;addSection(&quot;Sound&quot;, mSoundSettings);
-        // Add Input settings
-        cfgfile-&gt;addSection(&quot;Input&quot;, mInputSettings);
-
 #       if OGRE_PLATFORM == OGRE_PLATFORM_WIN32
         cfgfile-&gt;save(fs::path(&quot;./modules/config/&quot; + mRastullahCfgFile).native_file_string());
 #       else
         cfgfile-&gt;save(Ogre::String(::getenv(&quot;HOME&quot;)) + &quot;/.rastullah/&quot; + mRastullahCfgFile);
 #       endif
 
-        // Clean up
-        delete PathSettings;
         delete cfgfile;
     }
 
     Logger::LogLevel ConfigurationManager::getLogLevel() const
     {
-        return static_cast&lt;Logger::LogLevel&gt;(getIntSetting(ConfigurationManager::CS_GENERAL,
+        return static_cast&lt;Logger::LogLevel&gt;(getIntSetting(&quot;General&quot;,
             &quot;Log Level&quot;));
     }
 
-    Ogre::String ConfigurationManager::getStringSetting(const ConfigurationSection&amp; section,
+    Ogre::String ConfigurationManager::getStringSetting(const Ogre::String&amp; section,
         const Ogre::String&amp; key) const
     {
         // Get the value we are looking for
         return findSetting(section, key);
     }
 
-    int ConfigurationManager::getIntSetting(const ConfigurationSection&amp; section,
+    int ConfigurationManager::getIntSetting(const Ogre::String&amp; section,
         const Ogre::String&amp; key) const
     {
         // Get the value we are looking for
         return Ogre::StringConverter::parseInt(findSetting(section, key));
     }
 
-    bool ConfigurationManager::getBoolSetting(const ConfigurationSection&amp; section,
+    bool ConfigurationManager::getBoolSetting(const Ogre::String&amp; section,
         const Ogre::String&amp; key) const
     {
         // Get the value we are looking for
         return Ogre::StringConverter::parseBool(findSetting(section, key));
     }
 
-    Ogre::Real ConfigurationManager::getRealSetting(const ConfigurationSection&amp; section,
+    Ogre::Real ConfigurationManager::getRealSetting(const Ogre::String&amp; section,
         const Ogre::String&amp; key) const
     {
         // Get the value we are looking for
         return Ogre::StringConverter::parseReal(findSetting(section, key));
     }
 
-    Ogre::String ConfigurationManager::findSetting(const ConfigurationSection&amp; section,
+    Ogre::String ConfigurationManager::findSetting(const Ogre::String&amp; section,
         const Ogre::String&amp; key) const
     {
-        Ogre::NameValuePairList::const_iterator it;
-        const Ogre::NameValuePairList* searchList;
-
-        // Search for the key in the specified section
-        switch (section)
+        SectionMap::const_iterator sectionIt = mSettings.find(section);
+        if (sectionIt != mSettings.end())
         {
-            case CS_GENERAL:
-                searchList = &mGeneralSettings;
-            break;
-            case CS_GRAPHICS:
-                searchList = &mGraphicSettings;
-            break;
-            case CS_SOUND:
-                searchList = &mSoundSettings;
-            break;
-            case CS_INPUT:
-                searchList = &mInputSettings;
-            break;
-            default:
+            Ogre::NameValuePairList::const_iterator it = sectionIt-&gt;second.find(key);
 
-            break;
+            if (it != sectionIt-&gt;second.end())
+            {
+                return it-&gt;second;
+            }
         }
-
-        it = searchList-&gt;find(key);
-
-        if (it == searchList-&gt;end())
-        {
-            return Ogre::String(&quot;&quot;);
-        }
-        else
-        {
-            return it-&gt;second;
-        }
+        return &quot;&quot;;
     }
 
-    void ConfigurationManager::addSetting(const ConfigurationSection&amp; section,
+    void ConfigurationManager::addSetting(const Ogre::String&amp; section,
         const Ogre::String&amp; key, const Ogre::String&amp; value)
     {
-        Ogre::NameValuePairList::iterator it;
-        Ogre::NameValuePairList* addList;
-
-        // Get the section, where the key is inserted
-        switch (section)
-        {
-            case CS_GENERAL:
-                addList = &mGeneralSettings;
-                break;
-            case CS_GRAPHICS:
-                addList = &mGraphicSettings;
-                break;
-            case CS_SOUND:
-                addList = &mSoundSettings;
-                break;
-            case CS_INPUT:
-                addList = &mInputSettings;
-                break;
-            default:
-                break;
-        }
-
-        // Find out, if key exist
-        it = addList-&gt;find(key);
-
-        if (it == addList-&gt;end())
-        {
-            // Key does not exist, insert
-            addList-&gt;insert(make_pair(key, value));
-        }
-        else
-        {
-            // Key does exist, update
-            it-&gt;second = value;
-        }
+        mSettings[section][key] = value;
     }
 
     Ogre::String ConfigurationManager::getKeymap() const

Modified: rl/trunk/engine/core/src/CoreSubsystem.cpp
===================================================================
--- rl/trunk/engine/core/src/CoreSubsystem.cpp	2007-04-18 18:58:56 UTC (rev 3312)
+++ rl/trunk/engine/core/src/CoreSubsystem.cpp	2007-04-18 20:06:35 UTC (rev 3313)
@@ -181,7 +181,7 @@
         for (it = rsl-&gt;begin(); it &lt; rsl-&gt;end(); it++)
         {
             if ((*it)-&gt;getName() == ConfigurationManager::getSingleton().getStringSetting(
-                ConfigurationManager::CS_GRAPHICS, &quot;Render System&quot;))
+                &quot;Video&quot;, &quot;Render System&quot;))
             {
                 // Select and initialise the render system
                 mOgreRoot-&gt;setRenderSystem(*it);
@@ -206,15 +206,15 @@
 
         // Get width and height of the RenderWindow from the &quot;Video Mode&quot; setting
         Ogre::String VideoMode = ConfigurationManager::getSingleton().getStringSetting(
-            ConfigurationManager::CS_GRAPHICS, &quot;Video Mode&quot;);
+            &quot;Video&quot;, &quot;Video Mode&quot;);
         int temp = VideoMode.find(&quot;x&quot;);
         int width = Ogre::StringConverter::parseInt(VideoMode.substr(0, temp));
         int height = Ogre::StringConverter::parseInt(VideoMode.substr(temp + 1, VideoMode.size()));
 
         mRenderWindow = mOgreRoot-&gt;createRenderWindow(name.str(), width, height,
             ConfigurationManager::getSingleton().getBoolSetting(
-                ConfigurationManager::CS_GRAPHICS, &quot;Fullscreen&quot;),
-                    &amp;ConfigurationManager::getSingleton().getGraphicSettings());
+                &quot;Video&quot;, &quot;Fullscreen&quot;),
+                    &amp;ConfigurationManager::getSingleton().getSettings(&quot;Video&quot;));
 
         if (!mRenderWindow)
             return false;
@@ -245,7 +245,7 @@
         MaterialManager::getSingleton().setDefaultTextureFiltering(TFO_TRILINEAR);
         MaterialManager::getSingleton().setDefaultAnisotropy(
             ConfigurationManager::getSingleton().getIntSetting(
-                ConfigurationManager::CS_GRAPHICS, &quot;Max Anisotropy&quot;));
+                &quot;Video&quot;, &quot;Max Anisotropy&quot;));
 
 
         mWorld = new DotSceneOctreeWorld();
@@ -543,7 +543,7 @@
 
     void CoreSubsystem::loadPlugins()
     {
-        mSoundManager-&gt;applySettings(rl::ConfigurationManager::getSingleton().getSoundSettings());
+        mSoundManager-&gt;applySettings(rl::ConfigurationManager::getSingleton().getSettings(&quot;Sound&quot;));
         LOG_MESSAGE(Logger::CORE, &quot;Soundeinstellungen geladen&quot;);
     }
 

Modified: rl/trunk/engine/core/src/DotSceneLoader.cpp
===================================================================
--- rl/trunk/engine/core/src/DotSceneLoader.cpp	2007-04-18 18:58:56 UTC (rev 3312)
+++ rl/trunk/engine/core/src/DotSceneLoader.cpp	2007-04-18 20:06:35 UTC (rev 3313)
@@ -101,7 +101,8 @@
         processNodes(nodes, sceneManager, mSceneNode);
 
         // Find out, if static geometry should be used
-        Ogre::String temp = ConfigurationManager::getSingleton().getStringSetting(ConfigurationManager::CS_GRAPHICS, &quot;Use Static Geometry&quot;);
+        Ogre::String temp = ConfigurationManager::getSingleton().getStringSetting(
+            &quot;Video&quot;, &quot;Use Static Geometry&quot;);
         bool useStaticGeometry;
 
         if (temp == &quot;yes&quot;)

Modified: rl/trunk/engine/core/src/DotSceneOctreeWorld.cpp
===================================================================
--- rl/trunk/engine/core/src/DotSceneOctreeWorld.cpp	2007-04-18 18:58:56 UTC (rev 3312)
+++ rl/trunk/engine/core/src/DotSceneOctreeWorld.cpp	2007-04-18 20:06:35 UTC (rev 3313)
@@ -126,7 +126,7 @@
 		{
 			Ogre::String tmp = 
 				ConfigurationManager::getSingleton().getStringSetting(
-					ConfigurationManager::CS_GRAPHICS, &quot;Cast Shadows&quot; );
+					&quot;Video&quot;, &quot;Cast Shadows&quot; );
 			
 			if (tmp == &quot;yes&quot;)
 				castShadows = true;
@@ -139,7 +139,7 @@
 		{
 			int textureSize = 
 				ConfigurationManager::getSingleton().getIntSetting(
-					ConfigurationManager::CS_GRAPHICS, &quot;Shadow Texture Size&quot; );
+					&quot;Video&quot;, &quot;Shadow Texture Size&quot; );
 			textureSize = std::max( 64, std::min( 4096, textureSize ) );
 
 			mSceneMgr-&gt;setShadowTechnique(SHADOWTYPE_TEXTURE_MODULATIVE);

Modified: rl/trunk/engine/dialog/include/DialogCharacter.h
===================================================================
--- rl/trunk/engine/dialog/include/DialogCharacter.h	2007-04-18 18:58:56 UTC (rev 3312)
+++ rl/trunk/engine/dialog/include/DialogCharacter.h	2007-04-18 20:06:35 UTC (rev 3313)
@@ -33,6 +33,7 @@
 
     /**
      * Representation of a Character that is able to respond in a Dialog
+     * @todo Art der Erstellung &#228;ndern, das ist zu kompliziert.
      */
 	class _RlDialogExport DialogCharacter 
 	{
@@ -77,9 +78,9 @@
 		 * calculation of special condition values
 		 * should have a second parameter &quot;patternValue&quot;
 		 */
-		virtual int calcOptionValue(const CeGuiString&amp; optionName)=0;
-		virtual int calcResponseValue(const CeGuiString&amp; responseName)=0;
-		virtual int calcSelectionValue(const CeGuiString&amp; selectionName)=0;
+		virtual int calcOptionValue(const CeGuiString&amp; optionName);
+		virtual int calcResponseValue(const CeGuiString&amp; responseName);
+		virtual int calcSelectionValue(const CeGuiString&amp; selectionName);
 
 		DialogResponse* createResponse(const CeGuiString&amp; input);
 		bool isActive(){ return mActive; }
@@ -141,11 +142,21 @@
 		mNonPlayerCharacter = npc;
 	}
 
-/*	inline DialogScriptObject* DialogCharacter::getScriptObject() const
-	{
-		return mScriptObject;
-	}
-*/
+    /// @todo Magic Number.
+    inline int DialogCharacter::calcOptionValue(const CeGuiString&amp; optionName)
+    {
+        return 4;
+    }
+
+	inline int DialogCharacter::calcResponseValue(const CeGuiString&amp; responseName)
+    {
+        return 4;
+    }
+
+	inline int DialogCharacter::calcSelectionValue(const CeGuiString&amp; selectionName)
+    {
+        return 4;
+    }
 }
 
 #endif

Modified: rl/trunk/engine/dialog/include/DialogSubsystem.h
===================================================================
--- rl/trunk/engine/dialog/include/DialogSubsystem.h	2007-04-18 18:58:56 UTC (rev 3312)
+++ rl/trunk/engine/dialog/include/DialogSubsystem.h	2007-04-18 20:06:35 UTC (rev 3313)
@@ -72,6 +72,7 @@
 		 * Set the DialogCharacter loaded from ruby
 		 */
 		void setCurrentDialogCharacter(DialogCharacter* bot);
+		DialogCharacter* getCurrentDialogCharacter() const;
 
 	private:
 		void initialize();

Modified: rl/trunk/engine/dialog/src/DialogSubsystem.cpp
===================================================================
--- rl/trunk/engine/dialog/src/DialogSubsystem.cpp	2007-04-18 18:58:56 UTC (rev 3312)
+++ rl/trunk/engine/dialog/src/DialogSubsystem.cpp	2007-04-18 20:06:35 UTC (rev 3313)
@@ -112,7 +112,12 @@
 	AimlBot&lt;CeGuiString&gt;* bot = mCore-&gt;loadBot(botName.c_str(), fileName.c_str());
 //  while processing the bot definition, a DialogCharacter should have been created 
 //  through a ruby script and stored in mCurrentBot
-	if(mCurrentBot != NULL &amp;&amp; bot != NULL)
+    if (mCurrentBot == NULL)
+    {
+        mCurrentBot = new DialogCharacter();
+    }
+
+	if(bot != NULL)
 	{
 		mCurrentBot-&gt;setBot(bot);
 		mCurrentBot-&gt;initialize();
@@ -145,4 +150,9 @@
 	mCurrentBot = bot;
 }
 
+DialogCharacter* DialogSubsystem::getCurrentDialogCharacter() const
+{
+    return mCurrentBot;
 }
+
+}

Modified: rl/trunk/engine/script/RlScript2005.vcproj
===================================================================
--- rl/trunk/engine/script/RlScript2005.vcproj	2007-04-18 18:58:56 UTC (rev 3312)
+++ rl/trunk/engine/script/RlScript2005.vcproj	2007-04-18 20:06:35 UTC (rev 3313)
@@ -40,7 +40,7 @@
 			&lt;Tool
 				Name=&quot;VCCLCompilerTool&quot;
 				Optimization=&quot;0&quot;
-				AdditionalIncludeDirectories=&quot;.\include;..\common\include;..\core\include;..\dialog\include;..\rules\include;..\ai\include;..\ui\include;&quot;..\..\dependencies\ruby\lib\ruby\1.8\i386-mswin32&quot;;..\..\dependencies\ogrenew\OgreMain\include;..\..\dependencies\cegui_mk2\include;..\..\dependencies\boost\include;..\..\dependencies\xerces\include;..\..\dependencies\OgreNewt\include\OgreNewt;..\..\dependencies\NewtonSDK\sdk\;..\..\dependencies\ogrenew\Samples\Common\CEGUIRenderer\include;..\..\dependencies\ogrenew\dependencies\include;..\..\dependencies\opensteer\include&quot;
+				AdditionalIncludeDirectories=&quot;.\include;..\common\include;..\core\include;..\dialog\include;..\rules\include;..\ai\include;..\ui\include;&quot;..\..\dependencies\ruby\lib\ruby\1.8\i386-mswin32&quot;;..\..\dependencies\ogrenew\OgreMain\include;..\..\dependencies\cegui_mk2\include;..\..\dependencies\boost\include;..\..\dependencies\xerces\include;..\..\dependencies\OgreNewt\include\OgreNewt;..\..\dependencies\NewtonSDK\sdk\;..\..\dependencies\ogrenew\Samples\Common\CEGUIRenderer\include;..\..\dependencies\ogrenew\dependencies\include;..\..\dependencies\opensteer\include;..\..\dependencies\ois\includes&quot;
 				PreprocessorDefinitions=&quot;WITH_FMOD3;WIN32;_DEBUG;_WINDOWS;_USRDLL;RLSCRIPT_EXPORTS;_CRT_SECURE_CPP_OVERLOAD_STANDARD_NAMES&quot;
 				MinimalRebuild=&quot;true&quot;
 				BasicRuntimeChecks=&quot;3&quot;

Modified: rl/trunk/engine/script/swig/RlUi.head.swig
===================================================================
--- rl/trunk/engine/script/swig/RlUi.head.swig	2007-04-18 18:58:56 UTC (rev 3312)
+++ rl/trunk/engine/script/swig/RlUi.head.swig	2007-04-18 20:06:35 UTC (rev 3313)
@@ -22,6 +22,7 @@
 #include &quot;CommandMapper.h&quot;
 #include &quot;CutsceneCharacterController.h&quot;
 #include &quot;GameLoggerWindow.h&quot;
+#include &quot;InputManager.h&quot;
 #include &quot;UiPrerequisites.h&quot;
 #include &quot;UiSubsystem.h&quot;
 #include &quot;WindowFactory.h&quot;

Modified: rl/trunk/engine/script/swig/RlUi.swig
===================================================================
--- rl/trunk/engine/script/swig/RlUi.swig	2007-04-18 18:58:56 UTC (rev 3312)
+++ rl/trunk/engine/script/swig/RlUi.swig	2007-04-18 20:06:35 UTC (rev 3313)
@@ -24,18 +24,7 @@
 private:
 	CharacterController(rl::Actor* camera, rl::Actor* character);
 public:
-	enum ControllerType
-	{
-		CTRL_NONE = 1,
-		CTRL_FREEFLIGHT,
-		CTRL_MOVEMENT,
-		CTRL_DIALOG,
-		CTRL_CUTSCENE,
-		CTRL_COMBAT,
-	};
 
-	rl::CharacterController::ControllerType getType();
-
      /**
        *  @throw NullPointerException if camera or character is NULL.
        *  @throw InvalidArgumentException if character is not placed in the scene.
@@ -53,8 +42,6 @@
 public:
 	virtual ~CutsceneCharacterController();
 
-	ControllerType getType() const;
-
 	void toggleViewMode();
     void resetCamera();
 
@@ -72,12 +59,30 @@
 	rl::Person* getActiveCharacter();
 	void setActiveCharacter(rl::Person* chara);
 
-	rl::CharacterController* getCharacterController() const;
-	rl::CharacterController::ControllerType getCharacterControllerType() const;
-	void setCharacterController(rl::CharacterController::ControllerType type);
 	void linkKeyToRubyCommand(const rl::CeGuiString &amp;key, const rl::CeGuiString &amp;command);
 };
 
+enum ControlStateType 
+{
+    CST_NONE = 1,
+    CST_FREEFLIGHT,
+    CST_MOVEMENT,
+    CST_DIALOG,
+    CST_CUTSCENE,
+    CST_COMBAT,
+};
+
+class InputManager
+{
+public:
+    static InputManager&amp; getSingleton(void);
+
+    void pushControlState(rl::ControlStateType);
+    void popControlState();
+private:
+    InputManager();
+};
+
 class GameLoggerWindow
 {
 public:
@@ -108,7 +113,6 @@
 	void showContainerContent(rl::Container* container);
 	void showDescriptionWindow(rl::GameObject* obj);
 	void showGameObjectPropsWindow(rl::GameObject* obj);
-	void showDialog(rl::DialogCharacter* bot);
 	void showExitConfirmation();
 	void showJournalWindow();
 	void showLogfiles();

Modified: rl/trunk/engine/ui/RlUI2005.vcproj
===================================================================
--- rl/trunk/engine/ui/RlUI2005.vcproj	2007-04-18 18:58:56 UTC (rev 3312)
+++ rl/trunk/engine/ui/RlUI2005.vcproj	2007-04-18 20:06:35 UTC (rev 3313)
@@ -429,10 +429,6 @@
 					&gt;
 				&lt;/File&gt;
 				&lt;File
-					RelativePath=&quot;.\include\CommandMapperWindow.h&quot;
-					&gt;
-				&lt;/File&gt;
-				&lt;File
 					RelativePath=&quot;.\include\ConfigComponent.h&quot;
 					&gt;
 				&lt;/File&gt;
@@ -622,10 +618,6 @@
 					&gt;
 				&lt;/File&gt;
 				&lt;File
-					RelativePath=&quot;.\src\CommandMapperWindow.cpp&quot;
-					&gt;
-				&lt;/File&gt;
-				&lt;File
 					RelativePath=&quot;.\src\ConfigComponent.cpp&quot;
 					&gt;
 				&lt;/File&gt;

Modified: rl/trunk/engine/ui/include/CharacterController.h
===================================================================
--- rl/trunk/engine/ui/include/CharacterController.h	2007-04-18 18:58:56 UTC (rev 3312)
+++ rl/trunk/engine/ui/include/CharacterController.h	2007-04-18 20:06:35 UTC (rev 3313)
@@ -26,48 +26,40 @@
     class Actor;
 	class CommandMapper;
 	class Creature;
+    class Person;
 
     /**
      * This class handles character control via user input.
      */
-	class _RlUiExport CharacterController : public GameTask
+	class _RlUiExport CharacterController
     {
 	public:
 
-		enum ControllerType 
-		{
-			CTRL_NONE = 1,
-			CTRL_FREEFLIGHT,
-			CTRL_MOVEMENT,
-			CTRL_DIALOG,
-			CTRL_CUTSCENE,
-			CTRL_COMBAT,
-		};
-
         /**
          *  @throw NullPointerException if camera or character is NULL.
          *  @throw InvalidArgumentException if character is not placed in the scene.
          */
-        CharacterController(Actor* camera, Actor* character);
+        CharacterController(CommandMapper* commandMapper, Actor* camera, Person* character);
 		virtual ~CharacterController()= 0;
 
-		void setCommandMapper(CommandMapper* mapper);
-
-		virtual ControllerType getType() const = 0;
-
 		virtual void toggleViewMode() = 0;
 		virtual void resetCamera() = 0;
 
+        virtual void pause() = 0;
+        virtual void resume() = 0;
+
+        virtual void run(Ogre::Real elapsedTime) = 0;
+
 		virtual bool injectMouseDown(int mouseButtonMask) { return false; }
 		virtual bool injectMouseUp(int mouseButtonMask) { return false; }
 		virtual bool injectKeyDown(int keycode) { return false; }
 		virtual bool injectKeyUp(int keycode) { return false; }	
 
-        virtual const Ogre::String&amp; getName() const;
-
 	protected:
 		static bool startAction(const CeGuiString&amp; actionName, Creature* character = NULL);
 
+        Person* mCharacter;
+
         Actor* mCameraActor;
         Actor* mCharacterActor;
 

Modified: rl/trunk/engine/ui/include/CombatCharacterController.h
===================================================================
--- rl/trunk/engine/ui/include/CombatCharacterController.h	2007-04-18 18:58:56 UTC (rev 3312)
+++ rl/trunk/engine/ui/include/CombatCharacterController.h	2007-04-18 20:06:35 UTC (rev 3313)
@@ -28,11 +28,9 @@
 		/**
 		*  @throw NullPointerException if camera is NULL.
 		*/
-		CombatCharacterController(Actor* camera, Actor* character);
+		CombatCharacterController(CommandMapper* cmdMapper, Actor* camera, Person* character);
 		virtual ~CombatCharacterController();
 
-		virtual ControllerType getType() const;
-
 		void run(Ogre::Real elapsedTime);
 
 		void toggleViewMode();

Modified: rl/trunk/engine/ui/include/CommandMapper.h
===================================================================
--- rl/trunk/engine/ui/include/CommandMapper.h	2007-04-18 18:58:56 UTC (rev 3312)
+++ rl/trunk/engine/ui/include/CommandMapper.h	2007-04-18 20:06:35 UTC (rev 3313)
@@ -39,16 +39,6 @@
         MOVE_RUN_LOCK = 1&lt;&lt;9
     };
 
-    enum MapType
-    {
-        CMDMAP_KEYMAP_IN_COMBAT,
-        CMDMAP_KEYMAP_OFF_COMBAT,
-        CMDMAP_KEYMAP_MOVEMENT,
-        CMDMAP_KEYMAP_GLOBAL,
-        CMDMAP_MOUSEMAP_IN_COMBAT,
-        CMDMAP_MOUSEMAP_OFF_COMBAT
-    };
-
     const int CMDMAP_NO_MAPPING = -9999999;
 
     class _RlUiExport CommandMapper
@@ -58,17 +48,6 @@
         CommandMapper();
         ~CommandMapper();
 
-        /**
-         * Creates the key -&gt; action mapping from the key-value list
-         *
-         * @param keylist key-value list of input options
-         */
-        void buildCommandMapping(const Ogre::NameValuePairList&amp; keylist);
-
-        void setMapping(MapType map, int code, const CeGuiString&amp; actionName);
-
-        int getMapping(MapType map, const CeGuiString&amp; actionName);
-
         std::map&lt;CeGuiString, MovementState&gt; getMovements();
 
         static int encodeKey(int scancode, int syskeys);
@@ -76,9 +55,9 @@
 
         const MovementState getMovement(int keycode) const;
 
-        // Finde die der Taste oder dem Mausbutton zugeordneten Aktion in der
-        // angegebenen CommandMap
-        const CeGuiString&amp; getAction(int keyCodeOrMouseButton, MapType mapType);
+        /// Get the action name assigned to the key.
+        const CeGuiString&amp; getGlobalAction(int keyCodeOrMouseButton);
+        const CeGuiString&amp; getControlStateAction(int keyCodeOrMouseButton, ControlStateType);
 
     private:
 
@@ -87,19 +66,20 @@
         typedef std::map&lt;int, MovementState&gt; MovementCommandMap;
 
         MovementCommandMap mMovementCommands;
-        KeyAndMouseCommandMap mKeyCommandsInCombat;
-        KeyAndMouseCommandMap mKeyCommandsOffCombat;
-        KeyAndMouseCommandMap mKeyCommandsGlobal;
-        KeyAndMouseCommandMap mMouseCommandsInCombat;
-        KeyAndMouseCommandMap mMouseCommandsOffCombat;
+        KeyAndMouseCommandMap mKeyGlobalActions;
+        KeyAndMouseCommandMap mKeyMovementControlState;
+        KeyAndMouseCommandMap mKeyFreeflightControlState;
+        KeyAndMouseCommandMap mKeyDialogControlState;
+        KeyAndMouseCommandMap mKeyCombatControlState;
+        KeyAndMouseCommandMap mKeyCutsceneControlState;
 
-        std::map&lt;CeGuiString, MovementState&gt; mMovement;
-
-        KeyAndMouseCommandMap* getCommandMap(MapType mapType);
         int getKeyCode(const Ogre::String&amp; keyDescription);
         int getMouseButtonCode(int buttonNum);
         int getMouseButtonCode(const Ogre::String&amp; buttonDescription);
         MovementState getMovement(const Ogre::String&amp; movementDescription);
+        void buildCommandMapping();
+        void buildCommandMap(KeyAndMouseCommandMap&amp; cmdMap, const Ogre::NameValuePairList&amp; values);
+        const KeyAndMouseCommandMap&amp; getControlStateMapping(ControlStateType) const;
     };
 
 }

Deleted: rl/trunk/engine/ui/include/CommandMapperWindow.h
===================================================================
--- rl/trunk/engine/ui/include/CommandMapperWindow.h	2007-04-18 18:58:56 UTC (rev 3312)
+++ rl/trunk/engine/ui/include/CommandMapperWindow.h	2007-04-18 20:06:35 UTC (rev 3313)
@@ -1,71 +0,0 @@
-/* This source file is part of Rastullahs Lockenpracht.
- * Copyright (C) 2003-2007 Team Pantheon. <A HREF="http://www.team-pantheon.de">http://www.team-pantheon.de</A>
- * 
- *  This program is free software; you can redistribute it and/or modify
- *  it under the terms of the Clarified Artistic License.
- *
- *  This program is distributed in the hope that it will be useful,
- *  but WITHOUT ANY WARRANTY; without even the implied warranty of
- *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
- *  Clarified Artistic License for more details.
- *
- *  You should have received a copy of the Clarified Artistic License
- *  along with this program; if not you can get it here
- *  <A HREF="http://www.jpaulmorrison.com/fbp/artistic2.htm.">http://www.jpaulmorrison.com/fbp/artistic2.htm.</A>
- */
-
-#ifndef __CommandMapperWindow_H__
-#define __CommandMapperWindow_H__
-
-#include &quot;UiPrerequisites.h&quot;
-#include &quot;AbstractWindow.h&quot;
-
-namespace rl {
-
-	class Creature;
-	class CommandMapper;
-
-	class CommandMapperInputWindow :
-		public AbstractWindow
-	{
-	public:
-		CommandMapperInputWindow();
-
-		void setVisible(bool visible, bool destroyAfterHide = false);
-	};
-
-	class _RlUiExport CommandMapperWindow :
-		public AbstractWindow
-	{
-	public:
-		CommandMapperWindow(Creature* actionHolder, CommandMapper* commandMapper);
-			
-	private:
-		bool handleChangeButton();
-		bool handleCloseButton();
-		bool handleChangeMovement();
-		bool handleChangeInCombat();
-		bool handleChangeOffCombat();
-		bool handleKeyDown(const CEGUI::EventArgs&amp; evt);
-		bool handleMouseButton(const CEGUI::EventArgs&amp; evt);
-	
-		void muteElements(bool mute);
-		void muteWindow(bool mute);
-
-		void refreshContent();
-
-		Creature* mActionHolder;
-		CommandMapperInputWindow* mInputWindow;
-		CommandMapper* mCommandMapper;
-		CEGUI::MultiColumnList* mTableInCombat;
-		CEGUI::MultiColumnList* mTableOffCombat;
-		CEGUI::MultiColumnList* mTableMovement;
-		CEGUI::TabControl* mTabControl;
-		CEGUI::Window* mSelectedTable;
-	};
-
-	
-
-}
-
-#endif

Modified: rl/trunk/engine/ui/include/CutsceneCharacterController.h
===================================================================
--- rl/trunk/engine/ui/include/CutsceneCharacterController.h	2007-04-18 18:58:56 UTC (rev 3312)
+++ rl/trunk/engine/ui/include/CutsceneCharacterController.h	2007-04-18 20:06:35 UTC (rev 3313)
@@ -30,15 +30,16 @@
 		/**
 		*  @throw NullPointerException if camera is NULL.
 		*/
-		CutsceneCharacterController(Actor* camera);
+		CutsceneCharacterController(CommandMapper* cmdMapper, Actor* camera);
 		virtual ~CutsceneCharacterController();
 
-		virtual ControllerType getType() const;
+        virtual void pause();
+        virtual void resume();
 
-		void run(Ogre::Real elapsedTime);
+		virtual void run(Ogre::Real elapsedTime);
 
-		void toggleViewMode();
-        void resetCamera();
+		virtual void toggleViewMode();
+        virtual void resetCamera();
 
         void setCameraPosition(const Ogre::Vector3&amp; pos);
         void setCameraOrientation(const Ogre::Quaternion&amp; orient);

Modified: rl/trunk/engine/ui/include/DialogCharacterController.h
===================================================================
--- rl/trunk/engine/ui/include/DialogCharacterController.h	2007-04-18 18:58:56 UTC (rev 3312)
+++ rl/trunk/engine/ui/include/DialogCharacterController.h	2007-04-18 20:06:35 UTC (rev 3313)
@@ -47,11 +47,13 @@
 		*  @throw NullPointerException if camera or character is NULL.
 		*  @throw InvalidArgumentException if character is not placed in the scene.
 		*/
-		DialogCharacterController(Actor* camera, Actor* character);
+		DialogCharacterController(CommandMapper* cmdMapper, Actor* camera, Person* character);
 		/// Dtor 
 		virtual ~DialogCharacterController();
-		virtual ControllerType getType() const;
 
+        virtual void pause();
+        virtual void resume();
+
 		/// @override
 		virtual void run(Ogre::Real elapsedTime);
 

Modified: rl/trunk/engine/ui/include/DialogWindow.h
===================================================================
--- rl/trunk/engine/ui/include/DialogWindow.h	2007-04-18 18:58:56 UTC (rev 3312)
+++ rl/trunk/engine/ui/include/DialogWindow.h	2007-04-18 20:06:35 UTC (rev 3313)
@@ -34,10 +34,10 @@
 	class _RlUiExport DialogWindow : public AbstractWindow
 	{
 	public:
-		DialogWindow(DialogCharacter* bot, GameLoggerWindow* gamelogger, DialogCharacterController* controller);
+		DialogWindow(GameLoggerWindow* gamelogger);
 		~DialogWindow();
 
-		void initialize();
+        void initialize(DialogCharacterController* controller, DialogCharacter* character);
 
 		void getResponse(const CeGuiString&amp; msg);
 		unsigned int count();
@@ -48,7 +48,7 @@
 
 		void textFinished();
 
-		void start();
+        void start();
 
 	private:
 		enum DialogState

Modified: rl/trunk/engine/ui/include/FreeFlightCharacterController.h
===================================================================
--- rl/trunk/engine/ui/include/FreeFlightCharacterController.h	2007-04-18 18:58:56 UTC (rev 3312)
+++ rl/trunk/engine/ui/include/FreeFlightCharacterController.h	2007-04-18 20:06:35 UTC (rev 3313)
@@ -38,10 +38,12 @@
 		*  @throw NullPointerException if camera or character is NULL.
 		*  @throw InvalidArgumentException if character is not placed in the scene.
 		*/
-		FreeFlightCharacterController(Actor* camera, Actor* character);
+		FreeFlightCharacterController(CommandMapper* cmdMapper, Actor* camera, Person* character);
 		virtual ~FreeFlightCharacterController();
-		virtual ControllerType getType() const;
 
+        virtual void pause();
+        virtual void resume();
+
 		virtual void run(Ogre::Real elapsedTime);
 
 		void toggleViewMode();

Modified: rl/trunk/engine/ui/include/InputManager.h
===================================================================
--- rl/trunk/engine/ui/include/InputManager.h	2007-04-18 18:58:56 UTC (rev 3312)
+++ rl/trunk/engine/ui/include/InputManager.h	2007-04-18 20:06:35 UTC (rev 3313)
@@ -28,14 +28,8 @@
 #include &quot;FixRubyHeaders.h&quot;
 #include &quot;GameTask.h&quot;
 
-//#include &lt;OgreNoMemoryMacros.h&gt;
-//#include &lt;CEGUI.h&gt;
-//#include &lt;OgreMemoryMacros.h&gt;
+#include &lt;stack&gt;
 
-//namespace CEGUI {
-//    enum MouseButton;
-//}
-
 namespace rl {
 
     class AbstractWindow;
@@ -50,6 +44,7 @@
             public OIS::MouseListener
     {
     public:
+
         InputManager(Ogre::RenderWindow* window);
         ~InputManager();
 
@@ -83,12 +78,23 @@
         typedef std::map&lt;int, CEGUI::utf8&gt; KeyCharMap;
         typedef std::map&lt;int, CeGuiString&gt; KeyNameMap;
 
-        void setCharacterController(CharacterController* controller);
-
         virtual const Ogre::String&amp; getName() const;
 
         void linkKeyToRubyCommand(const CeGuiString &amp;key, const CeGuiString &amp;command);
 
+        // State management
+
+        /// Empties the control state stack and sets the control state to the requested state.
+        void setControlState(ControlStateType);
+        /// Put a new state onto the stack, this state is used for input handling from then on.
+        void pushControlState(ControlStateType);
+        /// Remove the current state from the stack and give control back to the former state.
+        void popControlState();
+        /// Remove all control states.
+        void clearControlStates();
+
+        CharacterController* getCharacterController() const;
+
     private:
         enum { NUM_MOUSE_BUTTON=4, NUM_KEYS=256 };
         enum Modifiers {ALT_MASK = 1, CTRL_MASK = 2, SHIFT_MASK = 4, SUPER_MASK = 8};
@@ -121,7 +127,8 @@
         int mNumActiveWindowsKeyboardInput;
         int mNumActiveWindowsAllInput;
 
-        CharacterController* mCharacterController;
+        typedef std::stack&lt;CharacterController*&gt; ControlStateVector;
+        ControlStateVector mControlStates;
     };
 }
 

Modified: rl/trunk/engine/ui/include/MovementCharacterController.h
===================================================================
--- rl/trunk/engine/ui/include/MovementCharacterController.h	2007-04-18 18:58:56 UTC (rev 3312)
+++ rl/trunk/engine/ui/include/MovementCharacterController.h	2007-04-18 20:06:35 UTC (rev 3313)
@@ -49,10 +49,12 @@
          *  @throw NullPointerException if camera or character is NULL.
          *  @throw InvalidArgumentException if character is not placed in the scene.
          */
-        MovementCharacterController(Actor* camera, Creature* character);
+        MovementCharacterController(CommandMapper* cmdMapper, Actor* camera, Person* character);
         virtual ~MovementCharacterController();
-		virtual ControllerType getType() const;
 
+        virtual void pause();
+        virtual void resume();
+
         void run(Ogre::Real elapsedTime);
 
         /// This is the OgreNewt contact process callback for the combination
@@ -116,7 +118,6 @@
         static Ogre::String msDebugWindowPageName;
 
 		CharacterState mCharacterState;// does only refer to the movement caused by the keyboard
-		Creature* mCharacter;
 
         // camera control params
         /// optimal distance to the character

Modified: rl/trunk/engine/ui/include/UiPrerequisites.h
===================================================================
--- rl/trunk/engine/ui/include/UiPrerequisites.h	2007-04-18 18:58:56 UTC (rev 3312)
+++ rl/trunk/engine/ui/include/UiPrerequisites.h	2007-04-18 20:06:35 UTC (rev 3313)
@@ -1,40 +1,53 @@
-/* This source file is part of Rastullahs Lockenpracht.
- * Copyright (C) 2003-2007 Team Pantheon. <A HREF="http://www.team-pantheon.de">http://www.team-pantheon.de</A>
- * 
- *  This program is free software; you can redistribute it and/or modify
- *  it under the terms of the Clarified Artistic License.
- *
- *  This program is distributed in the hope that it will be useful,
- *  but WITHOUT ANY WARRANTY; without even the implied warranty of
- *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
- *  Clarified Artistic License for more details.
- *
- *  You should have received a copy of the Clarified Artistic License
- *  along with this program; if not you can get it here
- *  <A HREF="http://www.jpaulmorrison.com/fbp/artistic2.htm.">http://www.jpaulmorrison.com/fbp/artistic2.htm.</A>
- */
-
-#ifndef __UiPrerequisites_H__
-#define __UiPrerequisites_H__
-
-#include &lt;xercesc/util/XMemory.hpp&gt;	// Muss vor Ogre stehen (zumindest f&#252;r VS)
-
-#undef _assert
-
-#include &lt;vector&gt;
-#include &quot;FixRubyHeaders.h&quot;
-
-#include &quot;CommonPrerequisites.h&quot;
-
-#if OGRE_PLATFORM == OGRE_PLATFORM_WIN32
-// Export control
-#   if defined( RLUI_EXPORTS )
-#       define _RlUiExport __declspec( dllexport )
-#   else
-#       define _RlUiExport __declspec( dllimport )
-#   endif
-#else // Linux / Mac OSX etc
-#   define _RlUiExport
-#endif
-
-#endif
+/* This source file is part of Rastullahs Lockenpracht.
+ * Copyright (C) 2003-2007 Team Pantheon. <A HREF="http://www.team-pantheon.de">http://www.team-pantheon.de</A>
+ * 
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the Clarified Artistic License.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  Clarified Artistic License for more details.
+ *
+ *  You should have received a copy of the Clarified Artistic License
+ *  along with this program; if not you can get it here
+ *  <A HREF="http://www.jpaulmorrison.com/fbp/artistic2.htm.">http://www.jpaulmorrison.com/fbp/artistic2.htm.</A>
+ */
+
+#ifndef __UiPrerequisites_H__
+#define __UiPrerequisites_H__
+
+#include &lt;xercesc/util/XMemory.hpp&gt;	// Muss vor Ogre stehen (zumindest f&#252;r VS)
+
+#undef _assert
+
+#include &lt;vector&gt;
+#include &quot;FixRubyHeaders.h&quot;
+
+#include &quot;CommonPrerequisites.h&quot;
+
+#if OGRE_PLATFORM == OGRE_PLATFORM_WIN32
+// Export control
+#   if defined( RLUI_EXPORTS )
+#       define _RlUiExport __declspec( dllexport )
+#   else
+#       define _RlUiExport __declspec( dllimport )
+#   endif
+#else // Linux / Mac OSX etc
+#   define _RlUiExport
+#endif
+
+// Important types. Probably will have to be relocated, though it is used throughout RlUi.
+namespace rl
+{
+    enum ControlStateType 
+    {
+	    CST_NONE = 1,
+	    CST_FREEFLIGHT,
+	    CST_MOVEMENT,
+	    CST_DIALOG,
+	    CST_CUTSCENE,
+	    CST_COMBAT,
+    };
+}
+#endif

Modified: rl/trunk/engine/ui/include/UiSubsystem.h
===================================================================
--- rl/trunk/engine/ui/include/UiSubsystem.h	2007-04-18 18:58:56 UTC (rev 3312)
+++ rl/trunk/engine/ui/include/UiSubsystem.h	2007-04-18 20:06:35 UTC (rev 3313)
@@ -23,7 +23,6 @@
 #include &lt;OgreSingleton.h&gt;
 
 #include &quot;CharacterController.h&quot;
-#include &quot;GameTask.h&quot;
 
 // Gar nicht sch&#246;n, aber ansonsten gibt es unn&#246;tige Abh&#228;ngigkeiten,
 // wenn man die Header hier inkludiert.
@@ -46,7 +45,7 @@
     class WindowManager;
 
     class _RlUiExport UiSubsystem : public SceneChangeListener,
-        protected Ogre::Singleton&lt;UiSubsystem&gt;, protected GameTask
+        protected Ogre::Singleton&lt;UiSubsystem&gt;
     {
     public:
         static const char* CEGUI_ROOT;
@@ -63,39 +62,16 @@
         CEGUI::OgreCEGUIRenderer* getGUIRenderer();
         Person* getActiveCharacter() const;
         void setActiveCharacter(Person* person);
-        CharacterController* getCharacterController() const;
-        CharacterController::ControllerType getCharacterControllerType() const;
 
-        /**
-         * Aendert den CharacterController, wird sofort durchgefuehrt
-         * kann Probleme bei Ausfuehrung innerhalb eines Controllers geben,
-         * dann ist @see requestCharacterControllerSwitch empfohlen
-        */
-        void setCharacterController(CharacterController::ControllerType type);
-
-        /**
-         * Aendert den CharacterController nach dem naechsten Frame
-        */
-        void requestCharacterControllerSwitch(CharacterController::ControllerType type);
-
-        void update();
-
         /// from SceneChangeListener
         virtual void onBeforeClearScene();
 
-        virtual void run(Ogre::Real elapsedTime);
-
-        virtual const Ogre::String&amp; getName() const;
-
         void initializeSubsystem();
 
         /// this method is here because it is easier to include it in swig here (actually really defined in InputManager)
         void linkKeyToRubyCommand(const CeGuiString &amp;key, const CeGuiString &amp;command);
 
     private:
-        CharacterController* mCharacterController;
-        CharacterController::ControllerType mCharacterControllerType;
-        GameActor* mHero;
         Person* mCharacter;
 
         // Singletons

Modified: rl/trunk/engine/ui/include/WindowFactory.h
===================================================================
--- rl/trunk/engine/ui/include/WindowFactory.h	2007-04-18 18:58:56 UTC (rev 3312)
+++ rl/trunk/engine/ui/include/WindowFactory.h	2007-04-18 20:06:35 UTC (rev 3313)
@@ -41,6 +41,7 @@
 	class DataLoadingProgressWindow;
 	class DebugWindow;
     class DialogCharacter;
+    class DialogWindow;
 	class GameLoggerWindow;
 	class GameObject;
 	class InfoPopup;
@@ -83,15 +84,12 @@
 		void showContainerContent(Container* container);
 		void showDescriptionWindow(GameObject* obj);
         void showGameObjectPropsWindow(GameObject* obj);
-		void showDialog(DialogCharacter* bot);
         void showExitConfirmation();
-		bool showInputOptionsMenu(Creature* actionHolder);
 		void showJournalWindow();
 		void showLogfiles();
 		void showMessageWindow(const CeGuiString&amp; message);
 		void showMainMenu();
 		void showObjectDescription(GameObject* object);
-		void showObjectName(GameObject* object);
 		void showPlaylist();
 		void showPopupMessage(int popupTypes);
 		/**
@@ -106,7 +104,7 @@
 		void toggleInGameGlobalMenu();
 		void toggleInventoryWindow();
 
-		InventoryWindow* getInventoryWindow();
+		DialogWindow* getDialogWindow();
 
 		void checkForErrors();
 		GameLoggerWindow* getGameLogger();
@@ -125,6 +123,7 @@
 
 		GameLoggerWindow* mGameLogger;
 		CharacterStateWindow* mCharacterStateWindow;
+        DialogWindow* mDialogWindow;
 		InGameMenuWindow* mInGameMenuWindow;
 		CharacterSheetWindow* mCharacterSheet;
 		JournalWindow* mJournalWindow;

Modified: rl/trunk/engine/ui/src/CharacterController.cpp
===================================================================
--- rl/trunk/engine/ui/src/CharacterController.cpp	2007-04-18 18:58:56 UTC (rev 3312)
+++ rl/trunk/engine/ui/src/CharacterController.cpp	2007-04-18 20:06:35 UTC (rev 3313)
@@ -24,6 +24,7 @@
 #include &quot;CoreSubsystem.h&quot;
 #include &quot;Creature.h&quot;
 #include &quot;Exception.h&quot;
+#include &quot;Person.h&quot;
 #include &quot;PhysicalThing.h&quot;
 #include &quot;World.h&quot;
 
@@ -31,27 +32,30 @@
 
 namespace rl {
 
-	CharacterController::CharacterController(Actor* camera, Actor* character)
-		: GameTask(),
-		mCameraActor(camera),
-		mCharacterActor(character),
-		mCamBody(0),
-		mCharBody(0),
-        mCommandMapper(NULL)
+	CharacterController::CharacterController(CommandMapper* commandMapper,
+        Actor* camera, Person* character)
+		: mCharacter(character),
+        mCameraActor(camera),
+		mCharacterActor(NULL),
+		mCamBody(NULL),
+		mCharBody(NULL),
+        mCommandMapper(commandMapper)
 	{
-		if (mCameraActor == 0)
+		if (mCameraActor == NULL)
 		{
 			Throw(NullPointerException, &quot;Camera must not be NULL.&quot;);
 		}
 
-		if (mCharacterActor != NULL)
+		if (mCharacter != NULL)
 		{
-			if (mCharacterActor-&gt;_getSceneNode() == NULL)
+            mCharacterActor = mCharacter-&gt;getActor();
+            
+			if (mCharacter != NULL &amp;&amp; mCharacterActor-&gt;_getSceneNode() == NULL)
 			{
 				Throw(IllegalArgumentException,
 					&quot;character has to be placed in the scene beforehand&quot;);
 			}
-            if (mCharacterActor-&gt;getPhysicalThing() == NULL)
+            if (mCharacter != NULL &amp;&amp; mCharacterActor-&gt;getPhysicalThing() == NULL)
 			{
 				Throw(IllegalArgumentException,
 					&quot;character must have a physics proxy&quot;);
@@ -96,11 +100,6 @@
     
     }
 
-	void CharacterController::setCommandMapper(CommandMapper* commandMapper)
-	{
-		mCommandMapper = commandMapper;
-	}
-
 	bool CharacterController::startAction(const CeGuiString&amp; actionName, Creature* character)
 	{
 		if (actionName.length() == 0)
@@ -121,11 +120,4 @@
 
 		return false;
 	}
-
-    const Ogre::String&amp; CharacterController::getName() const
-    {
-        static String NAME = &quot;CharacterController&quot;;
-
-        return NAME;
-    }
 }

Modified: rl/trunk/engine/ui/src/CombatCharacterController.cpp
===================================================================
--- rl/trunk/engine/ui/src/CombatCharacterController.cpp	2007-04-18 18:58:56 UTC (rev 3312)
+++ rl/trunk/engine/ui/src/CombatCharacterController.cpp	2007-04-18 20:06:35 UTC (rev 3313)
@@ -20,8 +20,8 @@
 #include &quot;Actor.h&quot;
 
 namespace rl {
-    CombatCharacterController::CombatCharacterController(Actor* camera, Actor* character)
-        : CharacterController(camera, character)
+    CombatCharacterController::CombatCharacterController(CommandMapper* cmdMapper,
+        Actor* camera, Person* character) : CharacterController(cmdMapper, camera, character)
     {
     }
 
@@ -29,11 +29,6 @@
     {
     }
 
-    CharacterController::ControllerType CombatCharacterController::getType() const
-    {
-        return CTRL_COMBAT;
-    }
-
 	void CombatCharacterController::run(Ogre::Real elapsedTime)
     {
     }
@@ -50,4 +45,4 @@
     {
         return false;
     }
-}
\ No newline at end of file
+}

Modified: rl/trunk/engine/ui/src/CommandMapper.cpp
===================================================================
--- rl/trunk/engine/ui/src/CommandMapper.cpp	2007-04-18 18:58:56 UTC (rev 3312)
+++ rl/trunk/engine/ui/src/CommandMapper.cpp	2007-04-18 20:06:35 UTC (rev 3313)
@@ -14,41 +14,42 @@
  *  <A HREF="http://www.jpaulmorrison.com/fbp/artistic2.htm.">http://www.jpaulmorrison.com/fbp/artistic2.htm.</A>
  */
 
-#include &quot;CommandMapper.h&quot;
-#include &quot;UiSubsystem.h&quot;
-#include &quot;Person.h&quot;
-#include &quot;Exception.h&quot;
 #include &quot;Action.h&quot;
 #include &quot;ActionManager.h&quot;
+#include &quot;CommandMapper.h&quot;
+#include &quot;ConfigurationManager.h&quot;
+#include &quot;Exception.h&quot;
 #include &quot;InputManager.h&quot;
+#include &quot;Person.h&quot;
+#include &quot;UiSubsystem.h&quot;
 #include &lt;OgreConfigFile.h&gt;
 
 using namespace Ogre;
-using namespace std;
 
 namespace rl {
 
     CommandMapper::CommandMapper()
         : mMovementCommands(),
-          mKeyCommandsInCombat(),
-          mKeyCommandsOffCombat(),
-          mKeyCommandsGlobal(),
-          mMouseCommandsInCombat(),
-          mMouseCommandsOffCombat()
+        mKeyGlobalActions(),
+        mKeyMovementControlState(),
+        mKeyFreeflightControlState(),
+        mKeyDialogControlState(),
+        mKeyCombatControlState(),
+        mKeyCutsceneControlState()
     {
+        buildCommandMapping();
     }
 
     CommandMapper::~CommandMapper()
     {
     }
 
-    const CeGuiString&amp; CommandMapper::getAction(int keyCodeOrMouseButton, MapType mapType)
+    const CeGuiString&amp; CommandMapper::getGlobalAction(int keyCodeOrMouseButton)
     {
-        KeyAndMouseCommandMap* commandMap = getCommandMap(mapType);
+        KeyAndMouseCommandMap::const_iterator command =
+            mKeyGlobalActions.find(keyCodeOrMouseButton);
 
-        KeyAndMouseCommandMap::const_iterator command = commandMap-&gt;find(keyCodeOrMouseButton);
-
-        if (command != commandMap-&gt;end())
+        if (command != mKeyGlobalActions.end())
         {
             return (*command).second;
         }
@@ -57,55 +58,39 @@
         return NO_ACTION;
     }
 
-
-    void CommandMapper::setMapping(
-            MapType mapType,
-            int code,
-            const CeGuiString&amp; actionName)
+    const CeGuiString&amp; CommandMapper::getControlStateAction(int keyCodeOrMouseButton,
+        ControlStateType type)
     {
-        getCommandMap(mapType)-&gt;insert(make_pair(code, actionName));
-    }
+        const KeyAndMouseCommandMap&amp; mapping = getControlStateMapping(type);
 
-    CommandMapper::KeyAndMouseCommandMap* CommandMapper::getCommandMap(MapType mapType)
-    {
-        KeyAndMouseCommandMap* commandMap;
+        KeyAndMouseCommandMap::const_iterator command = mapping.find(keyCodeOrMouseButton);
+        if (command != mapping.end())
+        {
+            return (*command).second;
+        }
 
-        if (mapType == CMDMAP_KEYMAP_OFF_COMBAT)
-            commandMap = &mKeyCommandsOffCombat;
-        else if (mapType == CMDMAP_KEYMAP_IN_COMBAT)
-            commandMap = &mKeyCommandsInCombat;
-        else if (mapType == CMDMAP_KEYMAP_GLOBAL)
-            commandMap = &mKeyCommandsGlobal;
-        else if (mapType == CMDMAP_MOUSEMAP_OFF_COMBAT)
-            commandMap = &mMouseCommandsOffCombat;
-        else if (mapType == CMDMAP_MOUSEMAP_IN_COMBAT)
-            commandMap = &mMouseCommandsInCombat;
-        else
-            Throw(RuntimeException, &quot;Unknown command map&quot;);
-
-        return commandMap;
+        static CeGuiString NO_ACTION = &quot;&quot;;
+        return NO_ACTION;
     }
 
-    int CommandMapper::getMapping(
-            MapType mapType,
-            const CeGuiString&amp; actionName)
+    const CommandMapper::KeyAndMouseCommandMap&amp;
+        CommandMapper::getControlStateMapping(ControlStateType type) const
     {
-        if (mapType == CMDMAP_KEYMAP_MOVEMENT)
+        switch (type)
         {
-            return 0;
+        case CST_MOVEMENT:
+            return mKeyMovementControlState;
+        case CST_FREEFLIGHT:
+            return mKeyFreeflightControlState;
+        case CST_CUTSCENE:
+            return mKeyCutsceneControlState;
+        case CST_DIALOG:
+            return mKeyDialogControlState;
+        case CST_COMBAT:
+            return mKeyCombatControlState;
+        default:
+            RlAssert1(false &amp;&amp; &quot;Unknown ControlStateType&quot;);
         }
-
-        KeyAndMouseCommandMap* commandMap = getCommandMap(mapType);
-
-        for (KeyAndMouseCommandMap::iterator command = commandMap-&gt;begin();
-                command != commandMap-&gt;end(); command++)
-        {
-            CeGuiString name = (*command).second;
-            if (name.compare(actionName) == 0)
-                return (*command).first;
-        }
-
-        return CMDMAP_NO_MAPPING;
     }
 
     int CommandMapper::encodeKey(int scancode, int syskeys)
@@ -142,114 +127,55 @@
         }
     }
 
-    void CommandMapper::buildCommandMapping(const Ogre::NameValuePairList&amp; keylist)
+    void CommandMapper::buildCommandMapping()
     {
-        /** @Todo: Replace this with something not static */
-        /*
-        mKeyCommandsGlobal[getKeyCode(&quot;F10&quot;)] = CeGuiString(&quot;toggleingameglobalmenu&quot;);
-        mKeyCommandsGlobal[getKeyCode(&quot;I&quot;)] = CeGuiString(&quot;toggleinventorywindow&quot;);
-        mKeyCommandsGlobal[getKeyCode(&quot;J&quot;)] = CeGuiString(&quot;showjournalwindow&quot;);
-        mKeyCommandsGlobal[getKeyCode(&quot;C&quot;)] = CeGuiString(&quot;showcharactersheet&quot;);
-        mKeyCommandsGlobal[getKeyCode(&quot;O&quot;)] = CeGuiString(&quot;togglecharacterstatewindow&quot;);
-        */
+        ConfigurationManager* cfgMgr = ConfigurationManager::getSingletonPtr();
+        InputManager* inputMgr = InputManager::getSingletonPtr();
 
-        StringVector keys;
+        // First get the movement commands
+        const NameValuePairList&amp; commands = cfgMgr-&gt;getSettings(&quot;Movement keys&quot;);
 
-        // Extract global actions and movement actions from the list
-        for (Ogre::NameValuePairList::const_iterator it = keylist.begin(); it != keylist.end(); it++)
+        for (NameValuePairList::const_iterator it = commands.begin(); it != commands.end(); it++)
         {
             // Split the path at the ',' character
-            keys = Ogre::StringUtil::split(it-&gt;second, &quot;,&quot;);
+            StringVector keys = Ogre::StringUtil::split(it-&gt;second, &quot;,&quot;);
 
-            // We got a movement action
-            if (it-&gt;first.find(&quot;mov_&quot;) != std::string::npos)
+            for (size_t i = 0; i &lt; keys.size(); i++)
             {
-                for (size_t i = 0; i &lt; keys.size(); i++)
-                {
-                    mMovementCommands[InputManager::getSingleton().getScanCode(keys[i])] = getMovement(it-&gt;first);
-                    LOG_MESSAGE(Logger::UI,
-                        Ogre::String(&quot;Key &quot;) + keys[i] + &quot; (&quot;
-                        + StringConverter::toString(InputManager::getSingleton().getScanCode(keys[i]))
-                        + &quot;) is assigned to movement &quot; + it-&gt;first +&quot; (&quot;
-                        + StringConverter::toString(getMovement(it-&gt;first))+&quot;)&quot;);
-                }
+                mMovementCommands[inputMgr-&gt;getScanCode(keys[i])] = getMovement(it-&gt;first);
+                LOG_MESSAGE(Logger::UI,
+                    Ogre::String(&quot;Key &quot;) + keys[i] + &quot; (&quot;
+                    + StringConverter::toString(inputMgr-&gt;getScanCode(keys[i]))
+                    + &quot;) is assigned to movement &quot; + it-&gt;first +&quot; (&quot;
+                    + StringConverter::toString(getMovement(it-&gt;first))+&quot;)&quot;);
             }
 
-            // We got a global action
-            if (it-&gt;first.find(&quot;act_&quot;) != std::string::npos)
-            {
-                for (size_t i = 0; i &lt; keys.size(); i++)
-                {
-                    mKeyCommandsGlobal[getKeyCode(keys[i])] = CeGuiString(it-&gt;first);
-                    LOG_MESSAGE(Logger::UI,
-                        Ogre::String(&quot;Key &quot;) + keys[i] + &quot; (&quot; + StringConverter::toString(getKeyCode(keys[i]))
-                        + &quot;) is assigned to command &quot; + it-&gt;first +&quot; globally&quot;);
-                }
-            }
+            buildCommandMap(mKeyGlobalActions, cfgMgr-&gt;getSettings(&quot;Action keys&quot;));
+            buildCommandMap(mKeyMovementControlState, cfgMgr-&gt;getSettings(&quot;MovementController keys&quot;));
+            buildCommandMap(mKeyFreeflightControlState, cfgMgr-&gt;getSettings(&quot;FreeflightController keys&quot;));
+            buildCommandMap(mKeyDialogControlState, cfgMgr-&gt;getSettings(&quot;DialogController keys&quot;));
+            buildCommandMap(mKeyCombatControlState, cfgMgr-&gt;getSettings(&quot;CombatController keys&quot;));
+            buildCommandMap(mKeyCutsceneControlState, cfgMgr-&gt;getSettings(&quot;CutsceneController keys&quot;));
         }
+    }
 
-        /*
-
-        for (ConfigFile::SettingsIterator it = cfgfile-&gt;getSettingsIterator(&quot;Global keys&quot;);
-            it.hasMoreElements();)
+    void CommandMapper::buildCommandMap(KeyAndMouseCommandMap&amp; cmdMap,
+        const NameValuePairList&amp; values)
+    {
+        for (NameValuePairList::const_iterator it = values.begin(); it != values.end(); it++)
         {
-            String key = it.peekNextKey();
-            String setting = it.getNext();
+            // Split the path at the ',' character
+            StringVector keys = Ogre::StringUtil::split(it-&gt;second, &quot;,&quot;);
 
-            mKeyCommandsGlobal[getKeyCode(key)] = CeGuiString(setting);
-            LOG_MESSAGE(Logger::UI,
-                Ogre::String(&quot;Key &quot;) + key    + &quot; (&quot; + StringConverter::toString(getKeyCode(key))
-                + &quot;) is assigned to command &quot; + setting+&quot; globally&quot;);
+            for (size_t i = 0; i &lt; keys.size(); i++)
+            {
+                cmdMap[getKeyCode(keys[i])] = CeGuiString(it-&gt;first);
+                LOG_MESSAGE(Logger::UI,
+                    Ogre::String(&quot;Key &quot;) + keys[i] + &quot; (&quot;
+                    + StringConverter::toString(getKeyCode(keys[i]))
+                    + &quot;) is assigned to command &quot; + it-&gt;first + &quot; globally&quot;);
+            }
         }
-
-        for (ConfigFile::SettingsIterator it = cfgfile-&gt;getSettingsIterator(&quot;Keys off combat&quot;);
-            it.hasMoreElements();)
-        {
-            String key = it.peekNextKey();
-            String setting = it.getNext();
-
-            mKeyCommandsOffCombat[getKeyCode(key)] = CeGuiString(setting);
-            LOG_MESSAGE(Logger::UI,
-                Ogre::String(&quot;Key &quot;) + key    + &quot; (&quot; + StringConverter::toString(getKeyCode(key))
-                + &quot;) is assigned to command &quot; + setting+&quot; while not in combat&quot;);
-        }
-
-        for (ConfigFile::SettingsIterator it = cfgfile-&gt;getSettingsIterator(&quot;Keys in combat&quot;);
-            it.hasMoreElements();)
-        {
-            String key = it.peekNextKey();
-            String setting = it.getNext();
-
-            mKeyCommandsInCombat[getKeyCode(key)] = CeGuiString(setting);
-            LOG_MESSAGE(Logger::UI,
-                Ogre::String(&quot;Key &quot;) + key    + &quot; (&quot; + StringConverter::toString(getKeyCode(key))
-                + &quot;) is assigned to command &quot; + setting+&quot; while in combat&quot;);
-        }
-
-        for (ConfigFile::SettingsIterator it = cfgfile-&gt;getSettingsIterator(&quot;Mouse off combat&quot;);
-            it.hasMoreElements();)
-        {
-            String key = it.peekNextKey();
-            String setting = it.getNext();
-
-            mMouseCommandsOffCombat[getMouseButtonCode(key)] = CeGuiString(setting);
-            LOG_MESSAGE(Logger::UI,
-                Ogre::String(&quot;Mouse Button &quot;) + key    + &quot; (&quot; + StringConverter::toString(getMouseButtonCode(key))
-                + &quot;) is assigned to command &quot; + setting+&quot; while not in combat&quot;);
-        }
-
-        for (ConfigFile::SettingsIterator it = cfgfile-&gt;getSettingsIterator(&quot;Mouse in combat&quot;);
-            it.hasMoreElements();)
-        {
-            String key = it.peekNextKey();
-            String setting = it.getNext();
-
-            mMouseCommandsInCombat[getMouseButtonCode(key)] = CeGuiString(setting);
-            LOG_MESSAGE(Logger::UI,
-                Ogre::String(&quot;Mouse Button &quot;) + key    + &quot; (&quot; + StringConverter::toString(getMouseButtonCode(key))
-                + &quot;) is assigned to command &quot; + setting+&quot; while in combat&quot;);
-        }
-        */
     }
 
     int CommandMapper::getKeyCode(const Ogre::String &amp;keyDescription)
@@ -286,43 +212,43 @@
 
     MovementState CommandMapper::getMovement(const Ogre::String &amp;movementDescription)
     {
-        if (movementDescription == &quot;mov_move_left&quot;)
+        if (movementDescription == &quot;move_left&quot;)
         {
             return MOVE_LEFT;
         }
-        else if (movementDescription == &quot;mov_move_right&quot;)
+        else if (movementDescription == &quot;move_right&quot;)
         {
             return MOVE_RIGHT;
         }
-        else if (movementDescription == &quot;mov_move_forward&quot;)
+        else if (movementDescription == &quot;move_forward&quot;)
         {
             return MOVE_FORWARD;
         }
-        else if (movementDescription == &quot;mov_move_backward&quot;)
+        else if (movementDescription == &quot;move_backward&quot;)
         {
             return MOVE_BACKWARD;
         }
-        else if (movementDescription == &quot;mov_turn_left&quot;)
+        else if (movementDescription == &quot;turn_left&quot;)
         {
             return TURN_LEFT;
         }
-        else if (movementDescription == &quot;mov_turn_right&quot;)
+        else if (movementDescription == &quot;turn_right&quot;)
         {
             return TURN_RIGHT;
         }
-        else if (movementDescription == &quot;mov_run&quot;)
+        else if (movementDescription == &quot;run&quot;)
         {
             return MOVE_RUN;
         }
-        else if (movementDescription == &quot;mov_sneak&quot;)
+        else if (movementDescription == &quot;sneak&quot;)
         {
             return MOVE_SNEAK;
         }
-        else if (movementDescription == &quot;mov_jump&quot;)
+        else if (movementDescription == &quot;jump&quot;)
         {
             return MOVE_JUMP;
         }
-        else if (movementDescription == &quot;mov_run_lock&quot;)
+        else if (movementDescription == &quot;run_lock&quot;)
         {
             return MOVE_RUN_LOCK;
         }
@@ -330,4 +256,3 @@
         return MOVE_NONE;
     }
 }
-

Deleted: rl/trunk/engine/ui/src/CommandMapperWindow.cpp
===================================================================
--- rl/trunk/engine/ui/src/CommandMapperWindow.cpp	2007-04-18 18:58:56 UTC (rev 3312)
+++ rl/trunk/engine/ui/src/CommandMapperWindow.cpp	2007-04-18 20:06:35 UTC (rev 3313)
@@ -1,240 +0,0 @@
-/* This source file is part of Rastullahs Lockenpracht.
- * Copyright (C) 2003-2007 Team Pantheon. <A HREF="http://www.team-pantheon.de">http://www.team-pantheon.de</A>
- * 
- *  This program is free software; you can redistribute it and/or modify
- *  it under the terms of the Clarified Artistic License.
- *
- *  This program is distributed in the hope that it will be useful,
- *  but WITHOUT ANY WARRANTY; without even the implied warranty of
- *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
- *  Clarified Artistic License for more details.
- *
- *  You should have received a copy of the Clarified Artistic License
- *  along with this program; if not you can get it here
- *  <A HREF="http://www.jpaulmorrison.com/fbp/artistic2.htm.">http://www.jpaulmorrison.com/fbp/artistic2.htm.</A>
- */
-
-#include &quot;CommandMapperWindow.h&quot;
-
-#include &lt;boost/bind.hpp&gt;
-#include &lt;elements/CEGUIListboxTextItem.h&gt;
-
-#include &quot;InputManager.h&quot;
-#include &quot;UiSubsystem.h&quot;
-#include &quot;CommandMapper.h&quot;
-
-#include &quot;GameObject.h&quot;
-#include &quot;Creature.h&quot;
-#include &quot;Action.h&quot;
-
-using namespace CEGUI;
-using namespace Ogre;
-
-namespace rl {
-
-CommandMapperWindow::CommandMapperWindow(Creature* actionHolder, CommandMapper* commandMapper)
-	:	AbstractWindow(&quot;commandmapper.xml&quot;, WND_ALL_INPUT),
-		mActionHolder(actionHolder),
-		mInputWindow(new CommandMapperInputWindow()),
-		mCommandMapper(commandMapper)
-{
-	getWindow(&quot;CommandMapper/ChangeButton&quot;)-&gt;
-		subscribeEvent(
-			PushButton::EventClicked,
-			boost::bind(&amp;CommandMapperWindow::handleChangeButton, this));
-	bindDestroyWindowToClick(getWindow(&quot;CommandMapper/CloseButton&quot;));
-	bindDestroyWindowToXButton();
-
-	mTabControl = getTabControl(&quot;CommandMapper/TabPane&quot;);
-
-	mTableMovement = getMultiColumnList(&quot;CommandMapper/TableMovement&quot;);
-	mTableMovement-&gt;subscribeEvent(
-			Window::EventMouseDoubleClick,
-			boost::bind(&amp;CommandMapperWindow::handleChangeMovement, this));
-	mTableInCombat = getMultiColumnList(&quot;CommandMapper/TableInCombat&quot;);
-	mTableInCombat-&gt;subscribeEvent(
-			Window::EventMouseDoubleClick,
-			boost::bind(&amp;CommandMapperWindow::handleChangeInCombat, this));
-	mTableOffCombat = getMultiColumnList(&quot;CommandMapper/TableOffCombat&quot;);
-	mTableOffCombat-&gt;subscribeEvent(
-			Window::EventMouseDoubleClick,
-			boost::bind(&amp;CommandMapperWindow::handleChangeOffCombat, this));
-
-	mTableMovement-&gt;addColumn(&quot;Aktion&quot;, 0, cegui_reldim(0.5));
-	mTableMovement-&gt;addColumn(&quot;Taste&quot;, 1, cegui_reldim(0.5));
-	mTableInCombat-&gt;addColumn(&quot;Aktion&quot;, 0, cegui_reldim(0.3));
-	mTableInCombat-&gt;addColumn(&quot;Klasse&quot;, 1, cegui_reldim(0.4));
-	mTableInCombat-&gt;addColumn(&quot;Taste&quot;, 2, cegui_reldim(0.3));
-	mTableOffCombat-&gt;addColumn(&quot;Aktion&quot;, 0, cegui_reldim(0.3));
-	mTableOffCombat-&gt;addColumn(&quot;Klasse&quot;, 1, cegui_reldim(0.4));
-	mTableOffCombat-&gt;addColumn(&quot;Taste&quot;, 2, cegui_reldim(0.3));
-
-	getWindow(&quot;CommandMapper&quot;)-&gt;
-		subscribeEvent(
-			Window::EventKeyDown,
-			boost::bind(&amp;CommandMapperWindow::handleKeyDown, this, _1));
-	getWindow(&quot;CommandMapper&quot;)-&gt;
-		subscribeEvent(
-			Window::EventMouseButtonDown,
-			boost::bind(&amp;CommandMapperWindow::handleMouseButton, this, _1));
-	muteWindow(true);
-
-	bindDestroyWindowToXButton();
-
-	centerWindow();
-	refreshContent();
-}
-
-void CommandMapperWindow::muteElements(bool mute)
-{
-	getWindow(&quot;CommandMapper/ChangeButton&quot;)-&gt;setMutedState(mute);
-	getWindow(&quot;CommandMapper/CloseButton&quot;)-&gt;setMutedState(mute);
-	getWindow(&quot;CommandMapper/TableMovement&quot;)-&gt;setMutedState(mute);
-	getWindow(&quot;CommandMapper/TableInCombat&quot;)-&gt;setMutedState(mute);
-	getWindow(&quot;CommandMapper/TableOffCombat&quot;)-&gt;setMutedState(mute);
-}
-
-void CommandMapperWindow::muteWindow(bool mute)
-{
-	getWindow(&quot;CommandMapper&quot;)-&gt;setMutedState(mute);
-	mInputWindow-&gt;setVisible(!mute);
-}
-
-bool CommandMapperWindow::handleChangeButton()
-{
-	muteElements(true);
-	muteWindow(false);
-
-	mSelectedTable = mTabControl-&gt;getActiveChild();
-
-	return true;
-}
-
-bool CommandMapperWindow::handleCloseButton()
-{
-	//TODO: CloseButton
-	return true;
-}
-
-bool CommandMapperWindow::handleChangeInCombat()
-{
-	//TODO: ChangeInCombat
-	return true;
-}
-
-bool CommandMapperWindow::handleChangeMovement()
-{
-	//TODO: ChangeMovement
-	return true;
-}
-
-bool CommandMapperWindow::handleChangeOffCombat()
-{
-	//TODO: ChangeOffCombat
-	return true;
-}
-
-bool CommandMapperWindow::handleKeyDown(const CEGUI::EventArgs&amp; e)
-{
-	const KeyEventArgs ke = static_cast&lt;const KeyEventArgs&amp;&gt;(e);
-	LOG_MESSAGE(Logger::UI, &quot;Key Down &quot;+StringConverter::toString(ke.scancode));
-
-	muteWindow(true);
-	muteElements(false);
-
-	//TODO: Taste in CommandMapper eintragen
-	if (mSelectedTable == mTableInCombat)
-		mCommandMapper-&gt;setMapping(
-			CMDMAP_KEYMAP_IN_COMBAT, 
-			ke.scancode, 
-			mTableInCombat-&gt;getItemAtGridReference(
-				MCLGridRef(mTableInCombat-&gt;getNominatedSelectionRow(), 0))-&gt;getText()
-		);
-	else if (mSelectedTable == mTableOffCombat)
-		mCommandMapper-&gt;setMapping(
-			CMDMAP_KEYMAP_OFF_COMBAT, 
-			ke.scancode, 
-			mTableOffCombat-&gt;getItemAtGridReference(
-				MCLGridRef(mTableOffCombat-&gt;getNominatedSelectionRow(), 0))-&gt;getText());
-	else if (mSelectedTable == mTableMovement)
-		mCommandMapper-&gt;setMapping(
-			CMDMAP_KEYMAP_MOVEMENT, 
-			ke.scancode, 
-			mTableMovement-&gt;getItemAtGridReference(
-				MCLGridRef(mTableMovement-&gt;getNominatedSelectionRow(), 0))-&gt;getText());
-	
-	return true;
-}
-
-bool CommandMapperWindow::handleMouseButton(const CEGUI::EventArgs&amp; e)
-{
-	const MouseEventArgs me = static_cast&lt;const MouseEventArgs&amp;&gt;(e);
-	LOG_MESSAGE(Logger::UI, &quot;Mouse Button Down &quot;+StringConverter::toString(me.button));
-	//TODO: Mausknopf in CommandMapper eintragen
-
-	muteWindow(true);
-	muteElements(false);
-	return true;
-}
-
-CommandMapperInputWindow::CommandMapperInputWindow() :
-	AbstractWindow(&quot;commandmapperinput.xml&quot;, AbstractWindow::WND_SHOW)
-{
-	setVisible(false);
-	mWindow-&gt;moveToFront();
-	centerWindow();
-}
-
-void CommandMapperInputWindow::setVisible(bool visible, bool destroyAfterHide)
-{
-	AbstractWindow::setVisible(visible, destroyAfterHide);
-	if (visible)
-		mWindow-&gt;moveToFront();
-}
-
-void CommandMapperWindow::refreshContent()
-{
-	unsigned int row;
-	//// Alle m&#239;&#191;&#189;glichen Bewegungen aus dem CommandMapper auslesen
-	//row = 0;
-	//const std::map&lt;CeGuiString, MovementState&gt; movements = 
-	//	mCommandMapper-&gt;getMovements();
-	//for (std::map&lt;CeGuiString, MovementState&gt;::const_iterator move = movements.begin();
-	//	move != movements.end(); move++)
-	//{
-	//	if (mTableMovement-&gt;getRowCount() &lt;= row)
-	//		mTableMovement-&gt;insertRow();
-
-	//	mTableMovement-&gt;setItem(new ListboxTextItem(move-&gt;first), 0, row);
-	//	mTableMovement-&gt;setItem(
-	//		new ListboxTextItem(InputManager::getSingleton().getKeyName(move-&gt;second), 0, row);
-	//	row++;
-	//} 
-
-	row = 0;
-	const ActionVector actions = mActionHolder-&gt;getValidActions(mActionHolder);
-	for (ActionVector::const_iterator actionIter = actions.begin(); 
-		actionIter != actions.end(); actionIter++)
-	{
-		if (mTableInCombat-&gt;getRowCount() &lt;= row)
-			mTableInCombat-&gt;addRow();
-		if (mTableOffCombat-&gt;getRowCount() &lt;= row)
-			mTableOffCombat-&gt;addRow();
-
-		Action* action = *actionIter;
-		mTableInCombat-&gt;setItem(new ListboxTextItem(action-&gt;getName()), 0, row);
-		mTableOffCombat-&gt;setItem(new ListboxTextItem(action-&gt;getName()), 0, row);
-
-		//int keyInCombat = mCommandMapper-&gt;getMapping(CMDMAP_KEYMAP_IN_COMBAT, action-&gt;getClassName(), action-&gt;getName());
-		int keyOffCombat = mCommandMapper-&gt;getMapping(CMDMAP_KEYMAP_OFF_COMBAT, action-&gt;getName());
-		//mTableInCombat-&gt;setItem(
-		//	new ListboxTextItem(
-		//		InputManager::getSingleton().getKeyName(keyInCombat)), 2, row);
-		mTableOffCombat-&gt;setItem(
-			new ListboxTextItem(
-				InputManager::getSingleton().getKeyName(keyOffCombat)), 2, row);
-		row++;
-	}
-}
-
-}

Modified: rl/trunk/engine/ui/src/CutsceneCharacterController.cpp
===================================================================
--- rl/trunk/engine/ui/src/CutsceneCharacterController.cpp	2007-04-18 18:58:56 UTC (rev 3312)
+++ rl/trunk/engine/ui/src/CutsceneCharacterController.cpp	2007-04-18 20:06:35 UTC (rev 3313)
@@ -26,8 +26,8 @@
 
 namespace rl {
 
-	CutsceneCharacterController::CutsceneCharacterController(Actor* camera)
-		: CharacterController(camera, NULL)
+	CutsceneCharacterController::CutsceneCharacterController(CommandMapper* cmdMapper,
+        Actor* camera) : CharacterController(cmdMapper, camera, NULL)
 	{
 		mCameraActor-&gt;getPhysicalThing()-&gt;freeze();
 		Camera* ogreCam = static_cast&lt;Camera*&gt;(mCameraActor-&gt;_getMovableObject());
@@ -40,6 +40,14 @@
 		mCameraActor-&gt;getPhysicalThing()-&gt;unfreeze();
 	}
 
+    void CutsceneCharacterController::pause()
+    {
+    }
+
+    void CutsceneCharacterController::resume()
+    {
+    }
+
 	void CutsceneCharacterController::run(Ogre::Real elapsedTime)
 	{
 	}
@@ -52,11 +60,6 @@
 	{
 	}
 
-	CharacterController::ControllerType CutsceneCharacterController::getType() const
-	{
-		return CTRL_CUTSCENE;
-	}
-
     void CutsceneCharacterController::setCameraPosition(const Ogre::Vector3&amp; pos)
     {
         mCameraActor-&gt;setPosition(pos);
@@ -75,6 +78,6 @@
 
     bool CutsceneCharacterController::injectKeyUp(int keycode)
 	{
-		return startAction(mCommandMapper-&gt;getAction(keycode, CMDMAP_KEYMAP_OFF_COMBAT));		
+		return startAction(mCommandMapper-&gt;getControlStateAction(keycode, CST_CUTSCENE));		
 	}
 }

Modified: rl/trunk/engine/ui/src/DialogCharacterController.cpp
===================================================================
--- rl/trunk/engine/ui/src/DialogCharacterController.cpp	2007-04-18 18:58:56 UTC (rev 3312)
+++ rl/trunk/engine/ui/src/DialogCharacterController.cpp	2007-04-18 20:06:35 UTC (rev 3313)
@@ -21,20 +21,24 @@
 #include &quot;Actor.h&quot;
 #include &quot;CameraObject.h&quot;
 #include &quot;CommandMapper.h&quot;
+#include &quot;ConfigurationManager.h&quot;
 #include &quot;CoreSubsystem.h&quot;
+#include &quot;DialogCharacter.h&quot;
+#include &quot;DialogSubsystem.h&quot;
 #include &quot;DialogWindow.h&quot;
 #include &quot;InputManager.h&quot;
 #include &quot;MeshAnimation.h&quot;
 #include &quot;MeshObject.h&quot;
+#include &quot;Person.h&quot;
 #include &quot;PhysicalThing.h&quot;
 #include &quot;Sound.h&quot;
 #include &quot;SoundDriver.h&quot;
 #include &quot;SoundManager.h&quot;
 #include &quot;SoundObject.h&quot;
 #include &quot;SubtitleWindow.h&quot;
+#include &quot;WindowFactory.h&quot;
 #include &quot;WindowManager.h&quot;
 #include &quot;World.h&quot;
-#include &quot;ConfigurationManager.h&quot;
 
 #include &lt;OgreSceneManager.h&gt;
 #include &lt;OgreNewt_Body.h&gt;
@@ -43,8 +47,9 @@
 
 namespace rl {
 
-    DialogCharacterController::DialogCharacterController(Actor* camera, Actor* character)
-        : CharacterController(camera, character),
+    DialogCharacterController::DialogCharacterController(CommandMapper* cmdMapper,
+        Actor* camera, Person* character)
+        : CharacterController(cmdMapper, camera, character),
         mTargetCameraPosition(Vector3::ZERO),
         mTargetCameraDirection(Vector3::UNIT_Z),
         mCurrFadeTextTime(0),
@@ -58,43 +63,44 @@
         mTalkAnimation(NULL),
         mSubtitleSpeed(1.0f)
     {
-        mCameraActor-&gt;getPhysicalThing()-&gt;freeze();
-        mCharacterActor-&gt;getPhysicalThing()-&gt;freeze();
-        Camera* ogreCam = static_cast&lt;Camera*&gt;(mCameraActor-&gt;_getMovableObject());
-        ogreCam-&gt;setFixedYawAxis(true);
-        ogreCam-&gt;setPosition(Vector3::ZERO);
-        ogreCam-&gt;setOrientation(Quaternion::IDENTITY);
-        mCameraActor-&gt;_getSceneNode()-&gt;setFixedYawAxis(true);
+        mSubtitleSpeed = ConfigurationManager::getSingleton().getRealSetting(
+            &quot;General&quot;, &quot;Subtitle Speed&quot;);
 
-        mSubtitleSpeed = ConfigurationManager::getSingleton().getRealSetting(ConfigurationManager::CS_GENERAL, &quot;Subtitle Speed&quot;);
+        mSubtitleWindow = new SubtitleWindow();
     }
 
     DialogCharacterController::~DialogCharacterController()
     {
-        mCameraActor-&gt;getPhysicalThing()-&gt;unfreeze();
-        mCharacterActor-&gt;getPhysicalThing()-&gt;unfreeze();
-        if (mDialogWindow != NULL)
-        {
-            mDialogWindow-&gt;setVisible(false, true);
-            mDialogWindow = NULL;
-        }
-        if (mSubtitleWindow != NULL)
-        {
-            mSubtitleWindow-&gt;setVisible(false, true);
-            mSubtitleWindow = NULL;
-        }
         delete mSoundObject;
     }
 
-    CharacterController::ControllerType DialogCharacterController::getType() const
+    void DialogCharacterController::pause()
     {
-        return CTRL_DIALOG;
+        mCameraActor-&gt;getPhysicalThing()-&gt;unfreeze();
+        mCharacterActor-&gt;getPhysicalThing()-&gt;unfreeze();
+        mDialogWindow-&gt;setVisible(false, false);
+        mSubtitleWindow-&gt;setVisible(false, false);
     }
 
-    void DialogCharacterController::setDialogPartner(Actor* partner)
+    void DialogCharacterController::resume()
     {
-        mDialogPartner = partner;
+        mCameraActor-&gt;getPhysicalThing()-&gt;freeze();
+        mCharacterActor-&gt;getPhysicalThing()-&gt;freeze();
+        Camera* ogreCam = static_cast&lt;Camera*&gt;(mCameraActor-&gt;_getMovableObject());
+        ogreCam-&gt;setFixedYawAxis(true);
+        ogreCam-&gt;setPosition(Vector3::ZERO);
+        ogreCam-&gt;setOrientation(Quaternion::IDENTITY);
+        mCameraActor-&gt;_getSceneNode()-&gt;setFixedYawAxis(true);
+
+        DialogCharacter* bot = DialogSubsystem::getSingleton().getCurrentDialogCharacter();
+        bot-&gt;setDialogCharacter(mCharacter);
+		mDialogPartner = bot-&gt;getDialogPartner()-&gt;getActor();
+
         resetCamera();
+
+        mDialogWindow = WindowFactory::getSingleton().getDialogWindow();
+        mDialogWindow-&gt;initialize(this, bot);
+		mDialogWindow-&gt;start();
     }
 
     void DialogCharacterController::run(Real elapsedTime)
@@ -144,16 +150,6 @@
                 + StringConverter::toString(mCurrFadeTextTime));
     }
 
-    void DialogCharacterController::setDialogWindow(DialogWindow* dialog)
-    {
-        mDialogWindow = dialog;
-    }
-
-    void DialogCharacterController::setSubtitleWindow(SubtitleWindow* subtitles)
-    {
-        mSubtitleWindow = subtitles;
-    }
-
     void DialogCharacterController::toggleViewMode()
     {
         /// @todo Krasser Gesichtszoom? Halbtotale... usw?

Modified: rl/trunk/engine/ui/src/DialogWindow.cpp
===================================================================
--- rl/trunk/engine/ui/src/DialogWindow.cpp	2007-04-18 18:58:56 UTC (rev 3312)
+++ rl/trunk/engine/ui/src/DialogWindow.cpp	2007-04-18 20:06:35 UTC (rev 3313)
@@ -44,14 +44,13 @@
 const CeGuiString DialogWindow::DIALOG_END = &quot;DIALOG BEENDET&quot;;
 const CeGuiString DialogWindow::DIALOG_EXIT = &quot;EXIT&quot;;
 
-DialogWindow::DialogWindow(DialogCharacter* bot, GameLoggerWindow* gamelogger,
-                           DialogCharacterController* controller)
+DialogWindow::DialogWindow(GameLoggerWindow* gamelogger)
   : AbstractWindow(&quot;dialogwindow.xml&quot;, WND_MOUSE_INPUT, false),
-	mBot(bot), 
+	mBot(NULL), 
 	mCurrentResponse(NULL),
     mCurrentResponseText(&quot;&quot;),
 	mGameLogger(gamelogger),
-	mController(controller),
+	mController(NULL),
     mState( TALKING_PLAYER_CHARACTER )
 {
 	mImage = getWindow(&quot;DialogWindow/Image&quot;);
@@ -82,8 +81,10 @@
 	ResourceGroupManager::getSingleton().removeResourceLocation(voiceFile, voiceFile);
 }
 
-void DialogWindow::initialize()
+void DialogWindow::initialize(DialogCharacterController* controller, DialogCharacter* character)
 {
+    mController = controller;
+    mBot = character;
 	
 	// Add 2 ListboxItems, one for the nsc responses, 
 	// one for the player selections
@@ -114,7 +115,11 @@
 
 void DialogWindow::start()
 {
-	initialize();
+    if (mBot == NULL || mController == NULL)
+    {
+        Throw(IllegalStateException, &quot;DialogWindow not properly initialized.&quot;);
+    }
+
 	mName-&gt;setText(mBot-&gt;getName());
 	getResponse(DIALOG_START);
 }
@@ -189,11 +194,6 @@
 		getResponse(mCurrentResponseText);
 	}
 	
-	if (mState == CLOSING_DIALOG)
-	{
-		handleClose();
-	}
-
     LOG_DEBUG(Logger::UI, 
 				StringConverter::toString(mState)
 				+ &quot; bei textFinished&quot; );
@@ -302,9 +302,8 @@
 
 bool DialogWindow::handleClose()
 {
-	UiSubsystem::getSingleton().requestCharacterControllerSwitch(
-		CharacterController::CTRL_MOVEMENT);
-	destroyWindow();
+	InputManager::getSingleton().popControlState();
+	hideWindow();
 	return true;
 }
 

Modified: rl/trunk/engine/ui/src/FreeFlightCharacterController.cpp
===================================================================
--- rl/trunk/engine/ui/src/FreeFlightCharacterController.cpp	2007-04-18 18:58:56 UTC (rev 3312)
+++ rl/trunk/engine/ui/src/FreeFlightCharacterController.cpp	2007-04-18 20:06:35 UTC (rev 3313)
@@ -32,8 +32,9 @@
 
 namespace rl {
 
-	FreeFlightCharacterController::FreeFlightCharacterController(Actor* camera, Actor* character)
-		: CharacterController(camera, character),
+	FreeFlightCharacterController::FreeFlightCharacterController(CommandMapper* cmdMapper,
+        Actor* camera, Person* character)
+		: CharacterController(cmdMapper, camera, character),
 		mMovementSpeed(5.0f),
 		mSpeedRange(0.03f, 90.0f),
 		mSpeedIncrement(0.02f),
@@ -44,16 +45,40 @@
         mPitchRange(Degree(-89), Degree(89)),
         mCameraUpConstraint(Vector3::ZERO)
 	{
-		mCameraActor-&gt;getPhysicalThing()-&gt;freeze();
+        mMouseSensitivity = ConfigurationManager::getSingleton().getIntSetting(&quot;Input&quot;, &quot;Mouse Sensitivity&quot;);
+        mInvertedMouse = ConfigurationManager::getSingleton().getBoolSetting(&quot;Input&quot;, &quot;Mouse Invert&quot;);
+	}
+
+	FreeFlightCharacterController::~FreeFlightCharacterController()
+	{
+	}
+
+    void FreeFlightCharacterController::pause()
+    {
+		mCameraActor-&gt;getPhysicalThing()-&gt;unfreeze();
+        if(mCameraUpConstraint != Vector3::ZERO)
+            mCameraActor-&gt;getPhysicalThing()-&gt;setUpConstraint(mCameraUpConstraint);
+		mCharacterActor-&gt;getPhysicalThing()-&gt;unfreeze();
+        mCameraActor-&gt;getPhysicalThing()-&gt;setPhysicsController(NULL);
+
+        // Char&lt;-&gt;Level collision back to default
+        PhysicsManager::getSingleton().resetMaterialPair(
+            PhysicsManager::getSingleton().getMaterialID(&quot;character&quot;),
+            PhysicsManager::getSingleton().getMaterialID(&quot;default&quot;));
+        // Char&lt;-&gt;Default collision back to default
+        PhysicsManager::getSingleton().resetMaterialPair(
+            PhysicsManager::getSingleton().getMaterialID(&quot;character&quot;),
+            PhysicsManager::getSingleton().getMaterialID(&quot;level&quot;));
+    }
+
+    void FreeFlightCharacterController::resume()
+    {
+        mCameraActor-&gt;getPhysicalThing()-&gt;freeze();
         mCameraUpConstraint = mCameraActor-&gt;getPhysicalThing()-&gt;getUpConstraint();
 		mCharacterActor-&gt;getPhysicalThing()-&gt;freeze();
-        mMouseSensitivity = ConfigurationManager::getSingleton().getIntSetting(ConfigurationManager::CS_INPUT, &quot;Mouse Sensitivity&quot;);
-        mInvertedMouse = ConfigurationManager::getSingleton().getBoolSetting(ConfigurationManager::CS_INPUT, &quot;Mouse Invert&quot;);
 
+        resetCamera();
 
-		resetCamera();
-
-
         // The actor should be controlled manually,
         // so let the PM prepare it accordingly
         mCameraActor-&gt;getPhysicalThing()-&gt;setPhysicsController(this);
@@ -71,21 +96,8 @@
 		    mesh-&gt;stopAllAnimations();
 		    mesh-&gt;startAnimation(&quot;idle&quot;);
         }
-	}
+    }
 
-	FreeFlightCharacterController::~FreeFlightCharacterController()
-	{
-		mCameraActor-&gt;getPhysicalThing()-&gt;unfreeze();
-        if(mCameraUpConstraint != Vector3::ZERO)
-            mCameraActor-&gt;getPhysicalThing()-&gt;setUpConstraint(mCameraUpConstraint);
-		mCharacterActor-&gt;getPhysicalThing()-&gt;unfreeze();
-	}
-
-	CharacterController::ControllerType FreeFlightCharacterController::getType() const
-	{
-		return CTRL_FREEFLIGHT;
-	}
-
 	void FreeFlightCharacterController::run(Real elapsedTime)
 	{
 		InputManager* im = InputManager::getSingletonPtr();
@@ -230,7 +242,16 @@
 		}
         else
         {
-            startAction(mCommandMapper-&gt;getAction(keycode, CMDMAP_KEYMAP_OFF_COMBAT));
+            CeGuiString command = mCommandMapper-&gt;getControlStateAction(keycode, CST_FREEFLIGHT);
+            if (command == &quot;back_to_character_movement&quot;)
+            {
+                InputManager::getSingleton().popControlState();
+                return true;
+            }
+            else
+            {
+                return startAction(command);
+            }
         }
 			
 		return false;

Modified: rl/trunk/engine/ui/src/InputManager.cpp
===================================================================
--- rl/trunk/engine/ui/src/InputManager.cpp	2007-04-18 18:58:56 UTC (rev 3312)
+++ rl/trunk/engine/ui/src/InputManager.cpp	2007-04-18 20:06:35 UTC (rev 3313)
@@ -34,13 +34,17 @@
 #include &quot;ActorManager.h&quot;
 #include &quot;AbstractWindow.h&quot;
 #include &quot;CharacterController.h&quot;
+#include &quot;ConfigurationManager.h&quot;
 #include &quot;CommandMapper.h&quot;
 #include &quot;Console.h&quot;
 #include &quot;CoreSubsystem.h&quot;
+#include &quot;CutsceneCharacterController.h&quot;
 #include &quot;DebugWindow.h&quot;
-#include &quot;DialogWindow.h&quot;
+#include &quot;DialogCharacterController.h&quot;
+#include &quot;FreeFlightCharacterController.h&quot;
 #include &quot;GameLoop.h&quot;
 #include &quot;GameObject.h&quot;
+#include &quot;MovementCharacterController.h&quot;
 #include &quot;RubyInterpreter.h&quot;
 #include &quot;UiSubsystem.h&quot;
 #include &quot;WindowFactory.h&quot;
@@ -62,16 +66,23 @@
         mKeyMapShift(),
         mKeyMapAlt(),
         mKeyNames(),
-        mCharacterController(NULL),
         mCommandMapper(NULL),
         mInputManager(NULL)
     {
         initializeOis(win);
+
+        loadKeyMapping(ConfigurationManager::getSingleton().getKeymap());
+        LOG_MESSAGE2(Logger::UI, &quot;Keymap geladen&quot;, &quot;UiSubsystem::initializeUiSubsystem&quot;);
+
+        mCommandMapper = new CommandMapper();
+
         GameLoop::getSingleton().addTask(this, GameLoop::TG_INPUT);
     }
 
     InputManager::~InputManager()
     {
+        clearControlStates();
+
         GameLoop::getSingleton().removeTask(this);
         if( mInputManager )
         {
@@ -139,12 +150,11 @@
     {
         mMouse-&gt;capture();
         mKeyboard-&gt;capture();
-    }
 
-    void InputManager::setCharacterController(CharacterController* controller)
-    {
-        mCharacterController = controller;
-        mCharacterController-&gt;setCommandMapper(mCommandMapper);
+        if (!mControlStates.empty())
+        {
+            mControlStates.top()-&gt;run(elapsedTime);
+        }
     }
 
     bool InputManager::mousePressed(const OIS::MouseEvent &amp; e, MouseButtonID id)
@@ -156,10 +166,10 @@
         }
         else
         {
-            if (mCharacterController != NULL)
+            if (!mControlStates.empty())
             {
-                mCharacterController-&gt;
-                    injectMouseDown(CommandMapper::encodeKey(id, getModifierCode()));
+                mControlStates.top()-&gt;injectMouseDown(
+                    CommandMapper::encodeKey(id, getModifierCode()));
             }
         }
         return true;
@@ -180,16 +190,11 @@
                 static_cast&lt;CEGUI::MouseButton&gt;(id));
             // return true;
         }
-        else
-            /// {
-            /// @todo Furchtbarer Hack. Das Ereignis wird durchgeschliffen, damit
-            /// der DialogCharacterController ne M&#195;&#182;glichkeit hat den Text abzubrechen.
-            /// Verantwortlichkeit zwischen DialogWindow und Controller ist arg durcheinander
-            /// und die Tatsache, dass ich das als Kommentar in den InputManager schreibe zeigt,
-            /// dass da noch mehr durcheinander ist. ^^
-            if (mCharacterController != NULL)
-                mCharacterController-&gt;injectMouseUp(
-                    CommandMapper::encodeKey(id, getModifierCode()));
+        else if (!mControlStates.empty())
+        {
+            mControlStates.top()-&gt;injectMouseUp(
+                CommandMapper::encodeKey(id, getModifierCode()));
+        }
 
         return true;
     }
@@ -296,9 +301,9 @@
                 }
             }
 
-            if (mCharacterController != NULL)
+            if (!mControlStates.empty())
             {
-                mCharacterController-&gt;injectKeyDown(code);
+                mControlStates.top()-&gt;injectKeyDown(code);
             }
         }
 
@@ -318,16 +323,16 @@
         {
             int code = CommandMapper::encodeKey(e.key, getModifierCode());
             Action* action = ActionManager::getSingleton().getInGameGlobalAction(
-                mCommandMapper-&gt;getAction(code, CMDMAP_KEYMAP_GLOBAL));
+                mCommandMapper-&gt;getGlobalAction(code));
             if (action != NULL)
             {
                 action-&gt;doAction(NULL, NULL, NULL);
                 LOG_MESSAGE2(Logger::UI, &quot;    invoked action &quot; + action-&gt;getName(), &quot;InputManager::keyReleased&quot;);
             }
 
-            if (mCharacterController != NULL)
+            if (!mControlStates.empty())
             {
-                mCharacterController-&gt;injectKeyUp(e.key);
+                mControlStates.top()-&gt;injectKeyUp(e.key);
                 LOG_MESSAGE2(Logger::UI, &quot;    fed to char controller&quot;, &quot;InputManager::keyReleased&quot;);
             }
         }
@@ -574,15 +579,6 @@
         return NO_CHAR;
     }
 
-    void InputManager::buildCommandMapping(const Ogre::NameValuePairList&amp; keylist)
-    {
-        if (mCommandMapper == NULL)
-        {
-            mCommandMapper = new CommandMapper();
-        }
-        mCommandMapper-&gt;buildCommandMapping(keylist);
-    }
-
     const Ogre::String&amp; InputManager::getName() const
     {
         static Ogre::String NAME = &quot;InputManager&quot;;
@@ -590,7 +586,6 @@
         return NAME;
     }
 
-
     void InputManager::linkKeyToRubyCommand(const CeGuiString &amp;keyStr, const CeGuiString &amp;command)
     {
         std::ostringstream ss;
@@ -627,4 +622,77 @@
         LOG_MESSAGE(Logger::UI, ss.str());
     }
 
+    void InputManager::setControlState(ControlStateType controlStateType)
+    {
+        while (!mControlStates.empty())
+        {
+            popControlState();
+        }
+        pushControlState(controlStateType);
+    }
+
+    void InputManager::pushControlState(ControlStateType controlStateType)
+    {
+        Actor* camera = ActorManager::getSingleton().getActor(&quot;DefaultCamera&quot;);
+        Person* character = UiSubsystem::getSingleton().getActiveCharacter();
+
+        CharacterController* controller = NULL;
+        switch (controlStateType)
+        {
+        case CST_CUTSCENE:
+            controller = new CutsceneCharacterController(mCommandMapper, camera);
+            break;
+        case CST_MOVEMENT:
+            controller = new MovementCharacterController(mCommandMapper, camera, character);
+            break;
+        case CST_FREEFLIGHT:
+            controller = new FreeFlightCharacterController(mCommandMapper, camera, character);
+            break;
+        case CST_DIALOG:
+            controller = new DialogCharacterController(mCommandMapper, camera, character);
+            break;
+        default:
+            Throw(IllegalStateException, &quot;Unknown controller type.&quot;);
+        }
+
+        if (!mControlStates.empty())
+        {
+            mControlStates.top()-&gt;pause();
+        }
+        mControlStates.push(controller);
+        mControlStates.top()-&gt;resume();
+    }
+
+    void InputManager::popControlState()
+    {
+        CharacterController* controller = mControlStates.top();
+        mControlStates.pop();
+        controller-&gt;pause();
+        delete controller;
+
+        if (!mControlStates.empty())
+        {
+            mControlStates.top()-&gt;resume();
+        }
+    }
+
+    void InputManager::clearControlStates()
+    {
+        while (!mControlStates.empty())
+        {
+            popControlState();
+        }
+    }
+
+    CharacterController* InputManager::getCharacterController() const
+    {
+        if (!mControlStates.empty())
+        {
+            return mControlStates.top();
+        }
+        else
+        {
+            return NULL;
+        }
+    }
 }

Modified: rl/trunk/engine/ui/src/MovementCharacterController.cpp
===================================================================
--- rl/trunk/engine/ui/src/MovementCharacterController.cpp	2007-04-18 18:58:56 UTC (rev 3312)
+++ rl/trunk/engine/ui/src/MovementCharacterController.cpp	2007-04-18 20:06:35 UTC (rev 3313)
@@ -39,6 +39,7 @@
 #include &quot;MeshObject.h&quot;
 #include &quot;MeshAnimation.h&quot;
 #include &quot;MovementCharacterController.h&quot;
+#include &quot;Person.h&quot;
 #include &quot;PhysicsManager.h&quot;
 #include &quot;PhysicsMaterialRaycast.h&quot;
 #include &quot;PhysicalThing.h&quot;
@@ -73,10 +74,10 @@
 
     }
 
-    MovementCharacterController::MovementCharacterController(Actor* camera, Creature* character)
-        : CharacterController(camera, character-&gt;getActor()),
+    MovementCharacterController::MovementCharacterController(CommandMapper* cmdMapper,
+        Actor* camera, Person* character)
+        : CharacterController(cmdMapper, camera, character),
         mCharacterState(),
-        mCharacter(character),
         mDesiredDistance(2.00),
         mDistanceRange(0.60, 7.00),
         mYaw(0),
@@ -112,8 +113,8 @@
 
 
         mGravitation = PhysicsManager::getSingleton().getGravity();
-        mMouseSensitivity = ConfigurationManager::getSingleton().getIntSetting(ConfigurationManager::CS_INPUT, &quot;Mouse Sensitivity&quot;);
-        mInvertedMouse = ConfigurationManager::getSingleton().getBoolSetting(ConfigurationManager::CS_INPUT, &quot;Mouse Invert&quot;);
+        mMouseSensitivity = ConfigurationManager::getSingleton().getIntSetting(&quot;Input&quot;, &quot;Mouse Sensitivity&quot;);
+        mInvertedMouse = ConfigurationManager::getSingleton().getBoolSetting(&quot;Input&quot;, &quot;Mouse Invert&quot;);
 
         // The relationCoefficient determines the relation between spring accel in target direction
         // and damping in velocity direction. 1.0 means equilibrium is reached in optimal time
@@ -133,31 +134,6 @@
         // wird sp&#239;&#191;&#189;er neu berechnet in calculateOptimalCameraPosition
         mLookAtOffset = Vector3(0, (aabb.getMaximum() - aabb.getMinimum()).y * 0.45f, 0);
 
-        // The actor should be controlled manually,
-        // so let the PM prepare it accordingly
-        mCharacterActor-&gt;getPhysicalThing()-&gt;setMaterialID(
-            PhysicsManager::getSingleton().getMaterialID(&quot;character&quot;));
-        mCharacterActor-&gt;getPhysicalThing()-&gt;setPhysicsController(this);
-        mCameraActor-&gt;getPhysicalThing()-&gt;setMaterialID(
-            PhysicsManager::getSingleton().getMaterialID(&quot;character&quot;));
-        mCameraActor-&gt;getPhysicalThing()-&gt;setPhysicsController(this);
-        // We also handle char&lt;-&gt;level, char&lt;-&gt;default collision from now on
-        PhysicsManager::getSingleton().getMaterialPair(
-            PhysicsManager::getSingleton().getMaterialID(&quot;character&quot;),
-            PhysicsManager::getSingleton().getMaterialID(&quot;default&quot;))-&gt;setContactCallback(this);
-        PhysicsManager::getSingleton().getMaterialPair(
-            PhysicsManager::getSingleton().getMaterialID(&quot;character&quot;),
-            PhysicsManager::getSingleton().getMaterialID(&quot;level&quot;))-&gt;setContactCallback(this);
-        
-        // Fit Collision proxy to idle anim
-        mCharacterActor-&gt;getPhysicalThing()-&gt;fitToPose(&quot;idle&quot;);
-
-        MeshObject* mesh = dynamic_cast&lt;MeshObject*&gt;(mCharacterActor-&gt;getControlledObject());
-        mesh-&gt;stopAllAnimations();
-        mesh-&gt;startAnimation(&quot;idle&quot;);
-
-        setViewMode(VM_THIRD_PERSON);
-
         // We want to check for visibility from char's POV.
         mSelector.setCheckVisibility(true, mCharacterActor);
     }
@@ -166,6 +142,22 @@
     MovementCharacterController::~MovementCharacterController()
     {
         delete mRaycast;
+
+        if (DebugWindow::getSingletonPtr())
+        {
+            DebugWindow::getSingletonPtr()-&gt;unregisterPage(msDebugWindowPageName);
+        }
+
+        // Remove debug scene node from character node, if debugview was used.
+        if (mSceneNode != NULL &amp;&amp; mSceneNode-&gt;getParent() != NULL)
+        {
+            mCharacterActor-&gt;_getSceneNode()-&gt;removeChild(mSceneNode);
+        }
+    }
+
+    //------------------------------------------------------------------------
+    void MovementCharacterController::pause()
+    {
         // actors aren't controlled anymore
         mCharacterActor-&gt;getPhysicalThing()-&gt;setPhysicsController(NULL);
         mCameraActor-&gt;getPhysicalThing()-&gt;setPhysicsController(NULL);
@@ -178,37 +170,47 @@
             PhysicsManager::getSingleton().getMaterialID(&quot;character&quot;),
             PhysicsManager::getSingleton().getMaterialID(&quot;level&quot;));
 
-        if (DebugWindow::getSingletonPtr())
-        {
-            DebugWindow::getSingletonPtr()-&gt;unregisterPage(msDebugWindowPageName);
-        }
-
         // Unhighlight selected object, if any.
         GameObject* go = mSelector.getFirstSelectedObject();
         if (go != NULL &amp;&amp; go-&gt;isHighlighted())
         {
             go-&gt;setHighlighted(false);
         }
-
-        // Remove debug scene node from character node, if debugview was used.
-        if (mSceneNode != NULL &amp;&amp; mSceneNode-&gt;getParent() != NULL)
-        {
-            mCharacterActor-&gt;_getSceneNode()-&gt;removeChild(mSceneNode);
-        }
     }
 
     //------------------------------------------------------------------------
-    CharacterController::ControllerType MovementCharacterController::getType() const
+    void MovementCharacterController::resume()
     {
-        return CTRL_MOVEMENT;
+        // The actor should be controlled manually,
+        // so let the PM prepare it accordingly
+        mCharacterActor-&gt;getPhysicalThing()-&gt;setMaterialID(
+            PhysicsManager::getSingleton().getMaterialID(&quot;character&quot;));
+        mCharacterActor-&gt;getPhysicalThing()-&gt;setPhysicsController(this);
+        mCameraActor-&gt;getPhysicalThing()-&gt;setMaterialID(
+            PhysicsManager::getSingleton().getMaterialID(&quot;character&quot;));
+        mCameraActor-&gt;getPhysicalThing()-&gt;setPhysicsController(this);
+
+        // We also handle char&lt;-&gt;level, char&lt;-&gt;default collision from now on
+        PhysicsManager::getSingleton().getMaterialPair(
+            PhysicsManager::getSingleton().getMaterialID(&quot;character&quot;),
+            PhysicsManager::getSingleton().getMaterialID(&quot;default&quot;))-&gt;setContactCallback(this);
+        PhysicsManager::getSingleton().getMaterialPair(
+            PhysicsManager::getSingleton().getMaterialID(&quot;character&quot;),
+            PhysicsManager::getSingleton().getMaterialID(&quot;level&quot;))-&gt;setContactCallback(this);
+        
+        // Fit Collision proxy to idle anim
+        mCharacterActor-&gt;getPhysicalThing()-&gt;fitToPose(&quot;idle&quot;);
+
+        MeshObject* mesh = dynamic_cast&lt;MeshObject*&gt;(mCharacterActor-&gt;getControlledObject());
+        mesh-&gt;stopAllAnimations();
+        mesh-&gt;startAnimation(&quot;idle&quot;);
+
+        setViewMode(VM_THIRD_PERSON);
     }
 
     //------------------------------------------------------------------------
     void MovementCharacterController::run(Real elapsedTime)
     {
-        //int movement = mCharacterState.mCurrentMovementState;
-        //updateAnimationState(movement); // lasse updateAnimationState das &#239;&#191;&#189;dern
-        //updateCharacterState(movement, elapsedTime);
         updateCharacterState(elapsedTime);
         updateCameraLookAt(elapsedTime);
         updateSelection();
@@ -252,7 +254,7 @@
 
         if (isEnemyNear())
         {
-            UiSubsystem::getSingleton().requestCharacterControllerSwitch(CTRL_COMBAT);
+            RlAssert1(false &amp;&amp; &quot;Not yet implemented&quot;);
         }
     }
 
@@ -1848,7 +1850,16 @@
         }
         else
         {
-            return startAction(mCommandMapper-&gt;getAction(keycode, CMDMAP_KEYMAP_OFF_COMBAT), mCharacter);
+            CeGuiString command = mCommandMapper-&gt;getControlStateAction(keycode, CST_MOVEMENT);
+            if (command == &quot;freeflight_mode&quot;)
+            {
+                InputManager::getSingleton().pushControlState(CST_FREEFLIGHT);
+                return true;
+            }
+            else
+            {
+                return startAction(command);
+            }
         }
 
         return false;
@@ -1877,8 +1888,8 @@
     {
         if (!InputManager::getSingleton().isCeguiActive())
         {
-            return startAction(mCommandMapper-&gt;getAction(mouseButtonMask,
-                CMDMAP_MOUSEMAP_OFF_COMBAT), mCharacter);
+            return startAction(mCommandMapper-&gt;getControlStateAction(mouseButtonMask,
+                CST_MOVEMENT), mCharacter);
         }
         else
         {

Modified: rl/trunk/engine/ui/src/UiSubsystem.cpp
===================================================================
--- rl/trunk/engine/ui/src/UiSubsystem.cpp	2007-04-18 18:58:56 UTC (rev 3312)
+++ rl/trunk/engine/ui/src/UiSubsystem.cpp	2007-04-18 20:06:35 UTC (rev 3313)
@@ -66,9 +66,6 @@
     }
 
     UiSubsystem::UiSubsystem() :
-        mCharacterController(NULL),
-        mCharacterControllerType(CharacterController::CTRL_NONE),
-        mHero(NULL),
         mCharacter(NULL),
         mInputManager(NULL),
         mWindowFactory(NULL),
@@ -88,9 +85,6 @@
         delete mWindowFactory;
         delete mWindowManager;
 
-        GameLoop::getSingleton().removeTask(mCharacterController);
-        delete mCharacterController;
-
         delete mInputManager;
 
         delete mGuiSystem;
@@ -151,19 +145,7 @@
         LOG_MESSAGE2(Logger::UI, &quot;InputManager started.&quot;,
             &quot;UiSubsystem::initializeUiSubsystem&quot;);
 
-        mInputManager-&gt;loadKeyMapping(ConfigurationManager::getSingleton().getKeymap());
-        LOG_MESSAGE2(Logger::UI, &quot;Keymap geladen&quot;,
-            &quot;UiSubsystem::initializeUiSubsystem&quot;);
-        mInputManager-&gt;buildCommandMapping(ConfigurationManager::getSingleton().getInputSettings());
-        LOG_MESSAGE2(Logger::UI, &quot;UI-Manager loaded.&quot;,
-            &quot;UiSubsystem::initializeUiSubsystem&quot;);
-
         mWindowFactory-&gt;initialize();
-
-        ///\XXX Not sensible to call setCharacterController each frame.
-        /// A better control over removed and added tasks will resolve this.
-        /// TG_INPUT is a bit of a stretch, but this doesn't fit anywhere else.
-        GameLoop::getSingleton().addTask(this, GameLoop::TG_INPUT);
     }
 
 
@@ -199,6 +181,7 @@
             if (person == NULL)
             {
                 mCharacter = NULL;
+                mInputManager-&gt;clearControlStates();
             }
             else
             {
@@ -210,117 +193,20 @@
                 mCharacter-&gt;getActor()-&gt;attach(SoundManager::getSingleton().getListenerActor());
                 LOG_MESSAGE(Logger::UI, &quot;SoundListener attached.&quot;);
 
-                setCharacterController(CharacterController::CTRL_MOVEMENT);
+                // Reset control stack for the new Character and set to movement.
+                mInputManager-&gt;setControlState(CST_MOVEMENT);
             }
         }
     }
 
-    void UiSubsystem::requestCharacterControllerSwitch(CharacterController::ControllerType type)
-    {
-        mCharacterControllerType = type;
-    }
-
-    void UiSubsystem::setCharacterController(CharacterController::ControllerType type)
-    {
-        if (mCharacterController != NULL)
-        {
-            if (mCharacterController-&gt;getType() == type)
-                return;
-
-            GameLoop::getSingleton().removeTask(mCharacterController);
-            delete mCharacterController;
-            mCharacterController = NULL;
-            LOG_MESSAGE(Logger::UI,
-                &quot;Old CharacterController deleted.&quot;);
-        }
-
-           if( type == CharacterController::CTRL_NONE )
-        {
-            mCharacterController = NULL;
-            return;
-        }
-
-        Actor* camera = ActorManager::getSingleton().getActor(&quot;DefaultCamera&quot;);
-        if (camera == NULL)
-        {
-            requestCharacterControllerSwitch(type);
-            return;
-        }
-
-        if (type == CharacterController::CTRL_MOVEMENT)
-        {
-            mCharacterController = new MovementCharacterController(camera, mCharacter);
-            if (!PhysicsManager::getSingleton().isEnabled())
-            {
-                PhysicsManager::getSingleton().setEnabled(true);
-            }
-        }
-        else if (type == CharacterController::CTRL_FREEFLIGHT)
-        {
-            mCharacterController = new FreeFlightCharacterController(camera,
-                mCharacter ? mCharacter-&gt;getActor() : NULL);
-        }
-        else if (type == CharacterController::CTRL_DIALOG)
-        {
-            mCharacterController = new DialogCharacterController(camera,
-                mCharacter ? mCharacter-&gt;getActor() : NULL);
-        }
-        else if (type == CharacterController::CTRL_CUTSCENE)
-        {
-            mCharacterController = new CutsceneCharacterController(camera);
-        }
-        else if (type == CharacterController::CTRL_COMBAT)
-        {
-            mCharacterController = new CombatCharacterController(camera,
-                mCharacter ? mCharacter-&gt;getActor() : NULL);
-        }
-        else
-        {
-            Throw(IllegalArgumentException, &quot;Unknown CharacterControllerType.&quot;);
-        }
-        mCharacterControllerType = type;
-
-        mInputManager-&gt;setCharacterController(mCharacterController);
-
-        LOG_MESSAGE(Logger::UI, &quot;CharacterController created.&quot;);
-        GameLoop::getSingleton().addTask(mCharacterController, GameLoop::TG_INPUT);
-        LOG_MESSAGE(Logger::UI, &quot;CharacterController task added.&quot;);
-    }
-
-    void UiSubsystem::run(Ogre::Real timeElapsed)
-    {
-        setCharacterController(mCharacterControllerType);
-    }
-
-    CharacterController* UiSubsystem::getCharacterController() const
-    {
-        return mCharacterController;
-    }
-
-    CharacterController::ControllerType UiSubsystem::getCharacterControllerType() const
-    {
-        if (mCharacterController == NULL)
-            return CharacterController::CTRL_NONE;
-
-        return mCharacterController-&gt;getType();
-    }
-
     void UiSubsystem::onBeforeClearScene()
     {
-        if (mCharacterController != NULL)
-        {
-            setCharacterController(CharacterController::CTRL_NONE);
-            setActiveCharacter(NULL);
-        }
+        setActiveCharacter(NULL);
+        // Remove control states here too, in case that there has not yet been a
+        // person set active.
+        mInputManager-&gt;clearControlStates();
     }
 
-    const Ogre::String&amp; UiSubsystem::getName() const
-    {
-        static String NAME = &quot;UiSubsystem&quot;;
-
-        return NAME;
-    }
-
     void UiSubsystem::linkKeyToRubyCommand(const CeGuiString &amp;key, const CeGuiString &amp;command)
     {
         InputManager::getSingleton().linkKeyToRubyCommand(key,command);

Modified: rl/trunk/engine/ui/src/WindowFactory.cpp
===================================================================
--- rl/trunk/engine/ui/src/WindowFactory.cpp	2007-04-18 18:58:56 UTC (rev 3312)
+++ rl/trunk/engine/ui/src/WindowFactory.cpp	2007-04-18 20:06:35 UTC (rev 3313)
@@ -21,7 +21,6 @@
 #include &quot;CharacterSheetWindow.h&quot;
 #include &quot;CharacterStateWindow.h&quot;
 #include &quot;CloseConfirmationWindow.h&quot;
-#include &quot;CommandMapperWindow.h&quot;
 #include &quot;Console.h&quot;
 #include &quot;ContainerContentWindow.h&quot;
 #include &quot;CoreSubsystem.h&quot;
@@ -66,10 +65,24 @@
 namespace rl {
 
 	WindowFactory::WindowFactory()
-		: mShownObject(NULL),
-		  mObjectNameText(NULL),
-          mMainMenuWindow(NULL),
-          mInventoryWindow(NULL)
+		: mGameLogger(NULL),
+		mCharacterStateWindow(NULL),
+        mDialogWindow(NULL),
+		mInGameMenuWindow(NULL),
+		mCharacterSheet(NULL),
+		mJournalWindow(NULL),
+		mInventoryWindow(NULL),
+		mLogWindow(NULL),
+		mDebugWindow(NULL),
+		mConsole(NULL),
+		mInfoPopup(NULL),
+		mObjectNameText(NULL),
+		mShownObject(NULL),
+		mObjectDescriptionWindow(NULL),
+        mDataLoadingProgressWindow(NULL),
+        mMainMenuWindow(NULL),
+        mCloseConfirmationWindow(NULL),
+        mGameSettings(NULL)
     {
     }
 
@@ -144,17 +157,6 @@
         (new ContainerContentWindow(container))-&gt;setVisible(true);
 	}
 
-	bool WindowFactory::showInputOptionsMenu(Creature* actionHolder)
-	{
-		CommandMapperWindow* wnd =
-			new CommandMapperWindow(
-				actionHolder,
-				NULL);
-		wnd-&gt;setVisible(true);
-
-		return true;
-	}
-
 	void WindowFactory::showMessageWindow(const CeGuiString&amp; message)
 	{
 		MessageWindow* w = new MessageWindow();
@@ -357,27 +359,6 @@
 		}
 	}
 
-	void WindowFactory::showDialog(DialogCharacter* bot)
-	{
-		if (bot-&gt;getDialogCharacter() == NULL)
-		{
-			bot-&gt;setDialogCharacter(UiSubsystem::getSingleton().getActiveCharacter());
-		}
-
-		UiSubsystem::getSingleton().setCharacterController(CharacterController::CTRL_DIALOG);
-		DialogCharacterController* controller =
-			dynamic_cast&lt;DialogCharacterController*&gt;(
-				UiSubsystem::getSingleton().getCharacterController());
-
-		SubtitleWindow* subtitleWnd = new SubtitleWindow();
-		controller-&gt;setSubtitleWindow(subtitleWnd);
-		controller-&gt;setDialogPartner(bot-&gt;getDialogPartner()-&gt;getActor());
-
-		DialogWindow* dialogWnd = new DialogWindow(bot, mGameLogger, controller);
-		controller-&gt;setDialogWindow(dialogWnd);
-		dialogWnd-&gt;start();
-	}
-
 	void WindowFactory::showLogfiles()
 	{
 		(new LogWindow())-&gt;setVisible(true);
@@ -396,37 +377,6 @@
 		}
 	}
 
-	void WindowFactory::showObjectName(GameObject* object)
-	{
-		//static Ogre::String NODENAME = &quot;ObjectDescription&quot;;
-
-		//if (object == NULL)
-		//{
-		//	if (mObjectNameText != NULL)
-		//	{
-		//		ActorManager::getSingleton().destroyActor(mObjectNameText);
-		//		mObjectNameText = NULL;
-		//	}
-		//}
-		//else
-		//{
-		//	if (object != mShownObject)
-		//	{
-		//		if (mObjectNameText == NULL)
-		//		{
-		//			mObjectNameText = ActorManager::getSingleton().createTextActor(NODENAME, object-&gt;getName());
-		//		}
-		//		else
-		//		{
-		//			dynamic_cast&lt;MovableText*&gt;(mObjectNameText-&gt;getControlledObject())
-		//				-&gt;setCaption(object-&gt;getName().c_str());
-		//			mObjectNameText-&gt;removeFromScene();
-		//		}
-		//		object-&gt;getActor()-&gt;attach(mObjectNameText);
-		//	}
-		//}
-	}
-
 	void WindowFactory::showObjectDescription(GameObject* object)
 	{
 		mObjectDescriptionWindow-&gt;show(object);
@@ -465,4 +415,13 @@
                 + StringConverter::toString(wnd-&gt;getPixelSize().d_height));
         }
     }
+
+	DialogWindow* WindowFactory::getDialogWindow()
+    {
+        if (mDialogWindow == NULL)
+        {
+            mDialogWindow = new DialogWindow(mGameLogger);
+        }
+        return mDialogWindow;
+    }
 }


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000382.html">[Dsa-hl-svn] r3312 - modules/techdemo2/scripts
</A></li>
	<LI>Next message: <A HREF="000385.html">[Dsa-hl-svn] r3314 - in modules: combattest/scripts/maps	common/scripts intro/scripts regressiontest/dialogs
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#384">[ date ]</a>
              <a href="thread.html#384">[ thread ]</a>
              <a href="subject.html#384">[ subject ]</a>
              <a href="author.html#384">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/dsa-hl-svn">More information about the Dsa-hl-svn
mailing list</a><br>
</body></html>
