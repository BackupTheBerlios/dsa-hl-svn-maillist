<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Dsa-hl-svn] r4390 - modules/persistenztest/maps	modules/persistenztest/scripts	modules/persistenztest/scripts/maps rl/trunk/engine/script	rl/trunk/engine/script/include rl/trunk/engine/script/src	rl/trunk/engine/script/swig
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/dsa-hl-svn/2008-May/index.html" >
   <LINK REL="made" HREF="mailto:dsa-hl-svn%40lists.berlios.de?Subject=Re%3A%20%5BDsa-hl-svn%5D%20r4390%20-%20modules/persistenztest/maps%0A%09modules/persistenztest/scripts%0A%09modules/persistenztest/scripts/maps%20rl/trunk/engine/script%0A%09rl/trunk/engine/script/include%20rl/trunk/engine/script/src%0A%09rl/trunk/engine/script/swig&In-Reply-To=%3C200805310921.m4V9Lh4p005702%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001460.html">
   <LINK REL="Next"  HREF="001462.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Dsa-hl-svn] r4390 - modules/persistenztest/maps	modules/persistenztest/scripts	modules/persistenztest/scripts/maps rl/trunk/engine/script	rl/trunk/engine/script/include rl/trunk/engine/script/src	rl/trunk/engine/script/swig</H1>
    <B>blakharaz at mail.berlios.de</B> 
    <A HREF="mailto:dsa-hl-svn%40lists.berlios.de?Subject=Re%3A%20%5BDsa-hl-svn%5D%20r4390%20-%20modules/persistenztest/maps%0A%09modules/persistenztest/scripts%0A%09modules/persistenztest/scripts/maps%20rl/trunk/engine/script%0A%09rl/trunk/engine/script/include%20rl/trunk/engine/script/src%0A%09rl/trunk/engine/script/swig&In-Reply-To=%3C200805310921.m4V9Lh4p005702%40sheep.berlios.de%3E"
       TITLE="[Dsa-hl-svn] r4390 - modules/persistenztest/maps	modules/persistenztest/scripts	modules/persistenztest/scripts/maps rl/trunk/engine/script	rl/trunk/engine/script/include rl/trunk/engine/script/src	rl/trunk/engine/script/swig">blakharaz at mail.berlios.de
       </A><BR>
    <I>Sat May 31 11:21:43 CEST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="001460.html">[Dsa-hl-svn] r4389 - in modules: combattest/dsa common/dsa
</A></li>
        <LI>Next message: <A HREF="001462.html">[Dsa-hl-svn] r4391 - rl/trunk/engine/common
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1461">[ date ]</a>
              <a href="thread.html#1461">[ thread ]</a>
              <a href="subject.html#1461">[ subject ]</a>
              <a href="author.html#1461">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: blakharaz
Date: 2008-05-31 11:21:36 +0200 (Sat, 31 May 2008)
New Revision: 4390

Added:
   modules/persistenztest/maps/map01.rlscene
   modules/persistenztest/maps/map02.rlscene
   rl/trunk/engine/script/include/Scene.h
   rl/trunk/engine/script/include/SceneLoader.h
   rl/trunk/engine/script/include/SceneManager.h
   rl/trunk/engine/script/src/Scene.cpp
   rl/trunk/engine/script/src/SceneLoader.cpp
   rl/trunk/engine/script/src/SceneManager.cpp
Modified:
   modules/persistenztest/scripts/MapChange.rb
   modules/persistenztest/scripts/maps/map01.rb
   modules/persistenztest/scripts/maps/map02.rb
   modules/persistenztest/scripts/maps/setchar.rb
   modules/persistenztest/scripts/moduleconfig.rb
   rl/trunk/engine/script/RlScript2005.vcproj
   rl/trunk/engine/script/include/Makefile.am
   rl/trunk/engine/script/include/MapLoader.h
   rl/trunk/engine/script/include/ScriptSubsystem.h
   rl/trunk/engine/script/include/stdinc.h
   rl/trunk/engine/script/src/Makefile.am
   rl/trunk/engine/script/src/MapLoader.cpp
   rl/trunk/engine/script/src/ScriptSubsystem.cpp
   rl/trunk/engine/script/swig/RlScript.head.swig
   rl/trunk/engine/script/swig/RlScript.swig
Log:
Added Scene and SceneManager and tests for scene loading and change in module persistenztest

Added: modules/persistenztest/maps/map01.rlscene
===================================================================
--- modules/persistenztest/maps/map01.rlscene	2008-05-31 09:17:47 UTC (rev 4389)
+++ modules/persistenztest/maps/map01.rlscene	2008-05-31 09:21:36 UTC (rev 4390)
@@ -0,0 +1,4 @@
+&lt;scene name=&quot;scene01&quot;&gt;
+	&lt;map file=&quot;persistenztest01.rlmap.xml&quot;/&gt;
+	&lt;map file=&quot;hero.rlmap.xml&quot;/&gt;
+&lt;/scene&gt;
\ No newline at end of file

Added: modules/persistenztest/maps/map02.rlscene
===================================================================
--- modules/persistenztest/maps/map02.rlscene	2008-05-31 09:17:47 UTC (rev 4389)
+++ modules/persistenztest/maps/map02.rlscene	2008-05-31 09:21:36 UTC (rev 4390)
@@ -0,0 +1,4 @@
+&lt;scene name=&quot;scene02&quot;&gt;
+	&lt;map file=&quot;persistenztest02.rlmap.xml&quot;/&gt;
+	&lt;map file=&quot;hero.rlmap.xml&quot;/&gt;
+&lt;/scene&gt;
\ No newline at end of file

Modified: modules/persistenztest/scripts/MapChange.rb
===================================================================
--- modules/persistenztest/scripts/MapChange.rb	2008-05-31 09:17:47 UTC (rev 4389)
+++ modules/persistenztest/scripts/MapChange.rb	2008-05-31 09:21:36 UTC (rev 4390)
@@ -1,21 +1,22 @@
 require &quot;embed.rb&quot;
 require &quot;areahelper.rb&quot;
 
-def changeMap(mapLoader, mapNames)
-	characterId = $UI.getActiveCharacter().getId()
-	CreatureControllerManager.getSingleton().detachController($UI.getActiveCharacter())
-	$UI.setActiveCharacter(nil)
+def changeScene(scene)
+#	characterId = $UI.getActiveCharacter().getId()
+#	CreatureControllerManager.getSingleton().detachController($UI.getActiveCharacter())
+#	$UI.setActiveCharacter(nil)
 	#$SCRIPT.logError(mapNames.type().to_s)
-	mapLoader.requestSceneChange(mapNames)
+#	mapLoader.requestSceneChange(mapNames)
+	SceneManager::getSingleton().loadScene(scene, true);
 end
 
-class MapChangeTrigger &lt; Trigger
+class SceneChangeTrigger &lt; Trigger
   def initialize(classname, name)
     super(classname, name, false);
   end
 
   def activate()
-	changeMap($MAPLOADER, @maps)
+	changeScene(@scene)
     return false
   end
   def deactivate()
@@ -27,8 +28,8 @@
   def getProperty(name)
 	super(name)
   end
-  def setMaps(maps)
-	@maps = maps
+  def setScene(scene)
+	@scene = scene
   end
   def getAllProperties()
     ps = super();
@@ -36,17 +37,16 @@
   end
 end
 
-def CreateMapChangeTrigger(name, pos, orientation, size, maps)
-	unless ( ZoneManager.getSingleton().getZone(&quot;MapChangeZone_&quot; + name) == nil )
-		raise ArgumentError, &quot;A MapChangeTrigger with name &quot; + name + &quot; already exists!&quot;, caller
+def CreateSceneChangeTrigger(name, pos, orientation, size, scene)
+	unless ( ZoneManager.getSingleton().getZone(&quot;SceneChangeZone_&quot; + name) == nil )
+		raise ArgumentError, &quot;A SceneChangeTrigger with name &quot; + name + &quot; already exists!&quot;, caller
 	end
-	trigger = $SCRIPT.getTriggerFactory().createTrigger(&quot;MapChangeTrigger&quot;, &quot;MapChangeTrigger&quot; + name)
-	trigger.setMaps(maps)
-	zone = ZoneManager.getSingleton().createZone(&quot;MapChangeZone_&quot; + name, true)
+	trigger = $SCRIPT.getTriggerFactory().createTrigger(&quot;SceneChangeTrigger&quot;, &quot;SceneChangeTrigger&quot; + name)
+	trigger.setScene(scene)
+	zone = ZoneManager.getSingleton().createZone(&quot;SceneChangeZone_&quot; + name, true)
 	ZoneManager.getSingleton().addAreaToZone(
-    &quot;MapChangeZone_&quot; + name, 
-    size, PhysicsManager::GT_BOX, pos, [0,0,0], orientation, 0.2, RlScript::QUERYFLAG_PLAYER);
-	trigger.setProperty(&quot;zone&quot;,&quot;MapChangeZone_&quot; + name)
+	    &quot;SceneChangeZone_&quot; + name, 
+	    size, PhysicsManager::GT_BOX, pos, [0,0,0], orientation, 0.2, RlScript::QUERYFLAG_PLAYER);
+	trigger.setProperty(&quot;zone&quot;,&quot;SceneChangeZone_&quot; + name)
 	zone.addTrigger(trigger)
-	zone.getTriggers().methods()
 end
\ No newline at end of file

Modified: modules/persistenztest/scripts/maps/map01.rb
===================================================================
--- modules/persistenztest/scripts/maps/map01.rb	2008-05-31 09:17:47 UTC (rev 4389)
+++ modules/persistenztest/scripts/maps/map01.rb	2008-05-31 09:21:36 UTC (rev 4390)
@@ -5,6 +5,6 @@
 
 base.placeIntoScene([8,0,8])
 
-puts CreateMapChangeTrigger(&quot;map1&quot;, [8,0,8], [0,0,0,1], [2, 2, 2], [&quot;persistenztest02.rlmap.xml&quot;,&quot;hero.rlmap.xml&quot;])
+CreateSceneChangeTrigger(&quot;map1&quot;, [8,0,8], [0,0,0,1], [2, 2, 2], &quot;scene02&quot;)
 
 #puts 'Map 1 init script wurde ausgef&#252;hrt!'

Modified: modules/persistenztest/scripts/maps/map02.rb
===================================================================
--- modules/persistenztest/scripts/maps/map02.rb	2008-05-31 09:17:47 UTC (rev 4389)
+++ modules/persistenztest/scripts/maps/map02.rb	2008-05-31 09:21:36 UTC (rev 4390)
@@ -4,6 +4,6 @@
 
 base.placeIntoScene([8,0,8])
 
-puts CreateMapChangeTrigger(&quot;map2&quot;, [8,0,-8], [0,0,0,1], [2, 2, 2], [&quot;persistenztest01.rlmap.xml&quot;,&quot;hero.rlmap.xml&quot;])
+CreateSceneChangeTrigger(&quot;map2&quot;, [8,0,-8], [0,0,0,1], [2, 2, 2], &quot;scene01&quot;)
 
 puts 'Map 2 ausgef&#252;hrt'
\ No newline at end of file

Modified: modules/persistenztest/scripts/maps/setchar.rb
===================================================================
--- modules/persistenztest/scripts/maps/setchar.rb	2008-05-31 09:17:47 UTC (rev 4389)
+++ modules/persistenztest/scripts/maps/setchar.rb	2008-05-31 09:21:36 UTC (rev 4390)
@@ -5,10 +5,16 @@
 require 'MapChange.rb'
 
 $SCRIPT.log(&quot;Prepare hero for being the active character&quot;)
-$hero = $GOM.getGameObject(10);
-PlayerSettings.preparePlayer($hero)
+hero = $GOM.getGameObject(10);
+PlayerSettings.preparePlayer(hero)
 
 $SCRIPT.log(&quot;Set hero as active character&quot;)
-$UI.setActiveCharacter($hero)
+$UI.setActiveCharacter(hero)
 
-$SCRIPT.log(&quot;Hero ready&quot;)
\ No newline at end of file
+$SCRIPT.log(&quot;Hero ready&quot;)
+itemToAdd = $GOM.createGameObject(&quot;men_human_female_legs_pants_01_long&quot;);
+hero.getInventory().hold(itemToAdd, &quot;Trousers&quot;);
+itemToAdd = $GOM.createGameObject(&quot;men_human_female_cloth_short&quot;);
+hero.getInventory().hold(itemToAdd, &quot;Clothes&quot;);
+itemToAdd = $GOM.createGameObject(&quot;men_human_female_feet_boots_01&quot;);
+hero.getInventory().hold(itemToAdd, &quot;Boots&quot;);

Modified: modules/persistenztest/scripts/moduleconfig.rb
===================================================================
--- modules/persistenztest/scripts/moduleconfig.rb	2008-05-31 09:17:47 UTC (rev 4389)
+++ modules/persistenztest/scripts/moduleconfig.rb	2008-05-31 09:21:36 UTC (rev 4390)
@@ -24,11 +24,9 @@
     def start()
         require &quot;mckhero.rb&quot;
         require &quot;hero.rb&quot;
-		$MAPLOADER = MapLoader.new(&quot;persistenztest&quot;)
-		$MAPLOADER.setDefaultMaps([&quot;persistenztest01.rlmap.xml&quot;,&quot;hero.rlmap.xml&quot;])
-		registerContentLoader($MAPLOADER)
-		loadContent();
-		load &quot;persistenztest.rb&quot;
+		require &quot;MapChange.rb&quot;
+		require &quot;Clothing.rb&quot;
+		SceneManager::getSingleton().loadScene(&quot;scene01&quot;, false);
     end
 end
 

Modified: rl/trunk/engine/script/RlScript2005.vcproj
===================================================================
--- rl/trunk/engine/script/RlScript2005.vcproj	2008-05-31 09:17:47 UTC (rev 4389)
+++ rl/trunk/engine/script/RlScript2005.vcproj	2008-05-31 09:21:36 UTC (rev 4390)
@@ -355,6 +355,18 @@
 					&gt;
 				&lt;/File&gt;
 				&lt;File
+					RelativePath=&quot;.\src\Scene.cpp&quot;
+					&gt;
+				&lt;/File&gt;
+				&lt;File
+					RelativePath=&quot;.\src\SceneLoader.cpp&quot;
+					&gt;
+				&lt;/File&gt;
+				&lt;File
+					RelativePath=&quot;.\src\SceneManager.cpp&quot;
+					&gt;
+				&lt;/File&gt;
+				&lt;File
 					RelativePath=&quot;.\src\SoundNodeProcessor.cpp&quot;
 					&gt;
 				&lt;/File&gt;
@@ -450,6 +462,18 @@
 					&gt;
 				&lt;/File&gt;
 				&lt;File
+					RelativePath=&quot;.\include\Scene.h&quot;
+					&gt;
+				&lt;/File&gt;
+				&lt;File
+					RelativePath=&quot;.\include\SceneLoader.h&quot;
+					&gt;
+				&lt;/File&gt;
+				&lt;File
+					RelativePath=&quot;.\include\SceneManager.h&quot;
+					&gt;
+				&lt;/File&gt;
+				&lt;File
 					RelativePath=&quot;.\include\SoundNodeProcessor.h&quot;
 					&gt;
 				&lt;/File&gt;

Modified: rl/trunk/engine/script/include/Makefile.am
===================================================================
--- rl/trunk/engine/script/include/Makefile.am	2008-05-31 09:17:47 UTC (rev 4389)
+++ rl/trunk/engine/script/include/Makefile.am	2008-05-31 09:21:36 UTC (rev 4390)
@@ -7,10 +7,13 @@
 	MapLoader.h \
 	ParticleSystemNodeProcessor.h \
 	TriggerFactory.h \
-	SoundNodeProcessor.h \
+	Scene.h \
+	SceneLoader.h \
+	SceneManager.h \
 	ScriptObjectMarker.h \
 	ScriptPrerequisites.h \
 	ScriptSubsystem.h \
+	SoundNodeProcessor.h \
 	WaypointProcessor.h \
 	UnifiedFactory.h \
 	ZoneProcessor.h

Modified: rl/trunk/engine/script/include/MapLoader.h
===================================================================
--- rl/trunk/engine/script/include/MapLoader.h	2008-05-31 09:17:47 UTC (rev 4389)
+++ rl/trunk/engine/script/include/MapLoader.h	2008-05-31 09:21:36 UTC (rev 4390)
@@ -38,6 +38,7 @@
     public:
         static const CeGuiString PROPERTY_ACTIVEMAPS;
 
+        MapLoader();
         MapLoader(const Ogre::String&amp; resourceGroup);
         ~MapLoader();
 
@@ -56,9 +57,9 @@
 
         const CeGuiString getClassName() const;
 
-        const Property getProperty(const CeGuiString&amp; key) const;
-        void setProperty(const CeGuiString&amp; key, const Property&amp; value);
-
+        const Property getProperty(const CeGuiString&amp; key) const;
+        void setProperty(const CeGuiString&amp; key, const Property&amp; value);
+
         PropertyKeys getAllPropertyKeys() const;
     private:
         std::list&lt;AbstractMapNodeProcessor*&gt; mNodeProcessors;
@@ -76,7 +77,8 @@
         void processSceneNodes(XERCES_CPP_NAMESPACE::DOMElement* nodesElem, bool loadGameObjects);
         void setLoadingPercentage(Ogre::Real percentage, const Ogre::String&amp; text = &quot;&quot;);
         bool changeScene(Ogre::StringVector mapsresources);
-
+        void initialize(const Ogre::String&amp; resourceGroup);
+    
         MessagePump::ScopedConnection RequestedSceneChangeConnection;
     };
 

Added: rl/trunk/engine/script/include/Scene.h
===================================================================
--- rl/trunk/engine/script/include/Scene.h	2008-05-31 09:17:47 UTC (rev 4389)
+++ rl/trunk/engine/script/include/Scene.h	2008-05-31 09:21:36 UTC (rev 4390)
@@ -0,0 +1,51 @@
+/* This source file is part of Rastullahs Lockenpracht.
+* Copyright (C) 2003-2008 Team Pantheon. <A HREF="http://www.team-pantheon.de">http://www.team-pantheon.de</A>
+*
+*  This program is free software; you can redistribute it and/or modify
+*  it under the terms of the Clarified Artistic License.
+*
+*  This program is distributed in the hope that it will be useful,
+*  but WITHOUT ANY WARRANTY; without even the implied warranty of
+*  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+*  Clarified Artistic License for more details.
+*
+*  You should have received a copy of the Clarified Artistic License
+*  along with this program; if not you can get it here
+*  <A HREF="http://www.jpaulmorrison.com/fbp/artistic2.htm.">http://www.jpaulmorrison.com/fbp/artistic2.htm.</A>
+*/
+
+#ifndef __RlScene_H__
+#define __RlScene_H__
+
+#include &quot;ScriptPrerequisites.h&quot;
+
+#include &lt;vector&gt;
+
+#include &quot;Properties.h&quot;
+
+namespace rl {
+
+    class Scene : public PropertyHolder
+    {
+    public:
+        static const Ogre::String PROPERTY_GAMEOBJECTS;
+
+        Scene(const CeGuiString&amp; name);
+        ~Scene();
+
+        void addMap(const Ogre::String&amp; mapfile);
+        void load(bool loadGameObjects);
+        const CeGuiString&amp; getName() const;
+
+        virtual const Property getProperty(const CeGuiString&amp; key) const;
+        virtual void setProperty(const CeGuiString&amp; key, const Property&amp; value);
+        virtual PropertyKeys getAllPropertyKeys() const;
+
+    private:
+        CeGuiString mName;
+        std::vector&lt;Ogre::String&gt; mMaps;
+    };
+
+}
+
+#endif // __RlScene_H__

Added: rl/trunk/engine/script/include/SceneLoader.h
===================================================================
--- rl/trunk/engine/script/include/SceneLoader.h	2008-05-31 09:17:47 UTC (rev 4389)
+++ rl/trunk/engine/script/include/SceneLoader.h	2008-05-31 09:21:36 UTC (rev 4390)
@@ -0,0 +1,34 @@
+/* This source file is part of Rastullahs Lockenpracht.
+* Copyright (C) 2003-2008 Team Pantheon. <A HREF="http://www.team-pantheon.de">http://www.team-pantheon.de</A>
+* 
+*  This program is free software; you can redistribute it and/or modify
+*  it under the terms of the Clarified Artistic License.
+*
+*  This program is distributed in the hope that it will be useful,
+*  but WITHOUT ANY WARRANTY; without even the implied warranty of
+*  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+*  Clarified Artistic License for more details.
+*
+*  You should have received a copy of the Clarified Artistic License
+*  along with this program; if not you can get it here
+*  <A HREF="http://www.jpaulmorrison.com/fbp/artistic2.htm.">http://www.jpaulmorrison.com/fbp/artistic2.htm.</A>
+*/
+#ifndef __SceneLoader_H__
+#define __SceneLoader_H__
+
+#include &quot;ScriptPrerequisites.h&quot;
+
+#include &quot;XmlProcessor.h&quot;
+
+namespace rl
+{
+    class Scene;
+
+    class SceneLoader : protected XmlProcessor
+    {
+    public:
+        Scene* loadScene(Ogre::DataStreamPtr&amp; data);
+    };
+}
+
+#endif // __SceneLoader_H__
\ No newline at end of file

Added: rl/trunk/engine/script/include/SceneManager.h
===================================================================
--- rl/trunk/engine/script/include/SceneManager.h	2008-05-31 09:17:47 UTC (rev 4389)
+++ rl/trunk/engine/script/include/SceneManager.h	2008-05-31 09:21:36 UTC (rev 4390)
@@ -0,0 +1,56 @@
+/* This source file is part of Rastullahs Lockenpracht.
+* Copyright (C) 2003-2008 Team Pantheon. <A HREF="http://www.team-pantheon.de">http://www.team-pantheon.de</A>
+*
+*  This program is free software; you can redistribute it and/or modify
+*  it under the terms of the Clarified Artistic License.
+*
+*  This program is distributed in the hope that it will be useful,
+*  but WITHOUT ANY WARRANTY; without even the implied warranty of
+*  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+*  Clarified Artistic License for more details.
+*
+*  You should have received a copy of the Clarified Artistic License
+*  along with this program; if not you can get it here
+*  <A HREF="http://www.jpaulmorrison.com/fbp/artistic2.htm.">http://www.jpaulmorrison.com/fbp/artistic2.htm.</A>
+*/
+
+#ifndef __RlSceneManager_H__
+#define __RlSceneManager_H__
+
+#include &quot;ScriptPrerequisites.h&quot;
+
+#include &quot;Properties.h&quot;
+
+namespace rl 
+{
+
+    class Scene;
+
+    class _RlScriptExport SceneManager 
+        : public Ogre::Singleton&lt;SceneManager&gt;, public Ogre::ScriptLoader//, public PropertyHolder
+    {
+    public:
+        SceneManager();
+        ~SceneManager();
+
+        void addScene(Scene* scene);
+        void loadScene(const CeGuiString&amp; name, bool saveCurrent = true);
+
+        const Ogre::StringVector&amp; getScriptPatterns() const;
+        void parseScript(Ogre::DataStreamPtr&amp; data, const Ogre::String&amp; resourceGroup);
+        Ogre::Real getLoadingOrder() const;
+
+        /*virtual const Property getProperty(const CeGuiString&amp; key) const;
+        virtual void setProperty(const CeGuiString&amp; key, const Property&amp; value);
+        virtual PropertyKeys getAllPropertyKeys() const;*/
+
+    private:
+        std::map&lt;CeGuiString, Scene*&gt; mScenes;
+        Ogre::StringVector mScriptPatterns;
+        Scene* mCurrentScene;
+        std::map&lt;Scene*, PropertyRecordPtr&gt; mSceneStates;
+    };
+
+}
+
+#endif // __RlSceneManager_H__

Modified: rl/trunk/engine/script/include/ScriptSubsystem.h
===================================================================
--- rl/trunk/engine/script/include/ScriptSubsystem.h	2008-05-31 09:17:47 UTC (rev 4389)
+++ rl/trunk/engine/script/include/ScriptSubsystem.h	2008-05-31 09:21:36 UTC (rev 4390)
@@ -21,8 +21,8 @@
 
 namespace rl 
 {
+    class ScriptObjectMarker;
 	class TriggerFactory;
-    class ScriptObjectMarker;
 
     class _RlScriptExport ScriptSubsystem : public Ogre::Singleton&lt;ScriptSubsystem&gt;
     {

Modified: rl/trunk/engine/script/include/stdinc.h
===================================================================
--- rl/trunk/engine/script/include/stdinc.h	2008-05-31 09:17:47 UTC (rev 4389)
+++ rl/trunk/engine/script/include/stdinc.h	2008-05-31 09:21:36 UTC (rev 4390)
@@ -52,7 +52,7 @@
 
 #include &lt;OgreNewt.h&gt;
 
-#include &lt;CeGuiString.h&gt;
+#include &lt;CEGUIString.h&gt;
 #include &lt;CEGUILogger.h&gt;
 
 #include &lt;boost/filesystem/operations.hpp&gt;

Modified: rl/trunk/engine/script/src/Makefile.am
===================================================================
--- rl/trunk/engine/script/src/Makefile.am	2008-05-31 09:17:47 UTC (rev 4389)
+++ rl/trunk/engine/script/src/Makefile.am	2008-05-31 09:21:36 UTC (rev 4390)
@@ -20,6 +20,9 @@
 	LightNodeProcessor.cpp \
 	MapLoader.cpp \
 	ParticleSystemNodeProcessor.cpp \
+	Scene.cpp \
+	SceneLoader.cpp \
+	SceneManager.cpp \
 	ScriptSubsystem.cpp \
 	ScriptObjectMarker.cpp \
 	SoundNodeProcessor.cpp \

Modified: rl/trunk/engine/script/src/MapLoader.cpp
===================================================================
--- rl/trunk/engine/script/src/MapLoader.cpp	2008-05-31 09:17:47 UTC (rev 4389)
+++ rl/trunk/engine/script/src/MapLoader.cpp	2008-05-31 09:21:36 UTC (rev 4390)
@@ -48,20 +48,22 @@
 
     const CeGuiString MapLoader::PROPERTY_ACTIVEMAPS = &quot;activemaps&quot;;
 
+    MapLoader::MapLoader()
+        : mRootSceneNode(NULL),
+          mResourceGroup(CoreSubsystem::getSingleton().getActiveAdventureModule()-&gt;getId()),
+          mPercentageWindow(NULL),
+          ContentLoader(mResourceGroup)
+    {
+        initialize(mResourceGroup);
+    }
+
     MapLoader::MapLoader(const Ogre::String&amp; resourceGroup)
         : mRootSceneNode(NULL),
           mResourceGroup(resourceGroup),
           mPercentageWindow(NULL),
           ContentLoader(resourceGroup)
     {
-        mNodeProcessors.push_back(new EntityNodeProcessor(resourceGroup));
-        mNodeProcessors.push_back(new GameObjectNodeProcessor());
-        mNodeProcessors.push_back(new SoundNodeProcessor());
-        mNodeProcessors.push_back(new LightNodeProcessor());
-		mNodeProcessors.push_back(new ParticleSystemNodeProcessor());
-
-        RequestedSceneChangeConnection = MessagePump::getSingleton().addMessageHandler&lt;MessageType_SceneChangeRequested&gt;(
-            boost::bind(&amp;MapLoader::changeScene, this, _1));
+        initialize(resourceGroup);
     }
 
     MapLoader::~MapLoader()
@@ -74,6 +76,18 @@
         delete mPercentageWindow;
     }
 
+    void MapLoader::initialize(const Ogre::String&amp; resourceGroup)
+    {
+        mNodeProcessors.push_back(new EntityNodeProcessor(resourceGroup));
+        mNodeProcessors.push_back(new GameObjectNodeProcessor());
+        mNodeProcessors.push_back(new SoundNodeProcessor());
+        mNodeProcessors.push_back(new LightNodeProcessor());
+		mNodeProcessors.push_back(new ParticleSystemNodeProcessor());
+
+        RequestedSceneChangeConnection = MessagePump::getSingleton().addMessageHandler&lt;MessageType_SceneChangeRequested&gt;(
+            boost::bind(&amp;MapLoader::changeScene, this, _1));
+    }
+
     void MapLoader::loadContent()
     {
         if(mLoadedMaps.empty()) // No maps defined to load -&gt; no savegame
@@ -204,35 +218,35 @@
         return &quot;MapLoader&quot;;
     }
 
-    const Property MapLoader::getProperty(const CeGuiString&amp; key) const
-    {
-        if(PROPERTY_ACTIVEMAPS == key)
-        {
-            PropertyArray vec;
-            for(Ogre::StringVector::const_iterator it = mLoadedMaps.begin(); it != mLoadedMaps.end(); ++it)
-            {
-                vec.push_back(Property(*it));
-            }
-            return Property(vec);
-        }
-        return ContentLoader::getProperty(key);
-    }
-    
-    void MapLoader::setProperty(const CeGuiString&amp; key, const Property&amp; value)
-    {
-        if(PROPERTY_ACTIVEMAPS == key)
-        {
-            mLoadedMaps.clear();
-            PropertyArray vec(value.toArray());
-            for(PropertyArray::const_iterator it = vec.begin(); it != vec.end(); ++it)
-            {
-                mLoadedMaps.push_back(it-&gt;toString().c_str());
-            }
-        }
-        else
-            ContentLoader::setProperty(key,value);
-    }
-
+    const Property MapLoader::getProperty(const CeGuiString&amp; key) const
+    {
+        if(PROPERTY_ACTIVEMAPS == key)
+        {
+            PropertyArray vec;
+            for(Ogre::StringVector::const_iterator it = mLoadedMaps.begin(); it != mLoadedMaps.end(); ++it)
+            {
+                vec.push_back(Property(*it));
+            }
+            return Property(vec);
+        }
+        return ContentLoader::getProperty(key);
+    }
+    
+    void MapLoader::setProperty(const CeGuiString&amp; key, const Property&amp; value)
+    {
+        if(PROPERTY_ACTIVEMAPS == key)
+        {
+            mLoadedMaps.clear();
+            PropertyArray vec(value.toArray());
+            for(PropertyArray::const_iterator it = vec.begin(); it != vec.end(); ++it)
+            {
+                mLoadedMaps.push_back(it-&gt;toString().c_str());
+            }
+        }
+        else
+            ContentLoader::setProperty(key,value);
+    }
+
     PropertyKeys MapLoader::getAllPropertyKeys() const
     {
         PropertyKeys keys = ContentLoader::getAllPropertyKeys();

Added: rl/trunk/engine/script/src/Scene.cpp
===================================================================
--- rl/trunk/engine/script/src/Scene.cpp	2008-05-31 09:17:47 UTC (rev 4389)
+++ rl/trunk/engine/script/src/Scene.cpp	2008-05-31 09:21:36 UTC (rev 4390)
@@ -0,0 +1,123 @@
+/* This source file is part of Rastullahs Lockenpracht.
+* Copyright (C) 2003-2008 Team Pantheon. <A HREF="http://www.team-pantheon.de">http://www.team-pantheon.de</A>
+*
+*  This program is free software; you can redistribute it and/or modify
+*  it under the terms of the Clarified Artistic License.
+*
+*  This program is distributed in the hope that it will be useful,
+*  but WITHOUT ANY WARRANTY; without even the implied warranty of
+*  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+*  Clarified Artistic License for more details.
+*
+*  You should have received a copy of the Clarified Artistic License
+*  along with this program; if not you can get it here
+*  <A HREF="http://www.jpaulmorrison.com/fbp/artistic2.htm.">http://www.jpaulmorrison.com/fbp/artistic2.htm.</A>
+*/
+
+#include &quot;stdinc.h&quot; //precompiled header
+
+#include &quot;Scene.h&quot;
+
+#include &quot;CoreSubsystem.h&quot;
+#include &quot;GameObject.h&quot;
+#include &quot;GameObjectManager.h&quot;
+#include &quot;MapLoader.h&quot;
+#include &quot;World.h&quot;
+
+namespace rl 
+{
+
+const Ogre::String Scene::PROPERTY_GAMEOBJECTS = &quot;gameobjects&quot;;
+
+Scene::Scene(const CeGuiString&amp; name)
+: mName(name)
+{
+}
+
+Scene::~Scene() 
+{
+}
+
+void Scene::addMap(const Ogre::String &amp;mapfile)
+{
+    mMaps.push_back(mapfile);
+}
+
+void Scene::load(bool loadGameObjects)
+{
+    CoreSubsystem::getSingleton().getWorld()-&gt;clearScene();
+    MapLoader* loader = new MapLoader();
+    loader-&gt;loadScene(mMaps, loadGameObjects);
+}
+
+const CeGuiString&amp; Scene::getName() const
+{
+    return mName;
+}
+
+const Property Scene::getProperty(const CeGuiString&amp; key) const
+{
+    Property prop;
+
+    if (key == PROPERTY_GAMEOBJECTS)
+    {
+        PropertyArray goProps;
+
+        std::list&lt;GameObject*&gt; golist = GameObjectManager::getSingleton().getAllGameObjects();
+        std::list&lt;GameObject*&gt;::iterator end = golist.end();
+        for (std::list&lt;GameObject*&gt;::iterator it = golist.begin(); it != end; ++it)
+        {
+            GameObject* cur = *it;
+            if (cur-&gt;getState() == GOS_LOADED || cur-&gt;getState() == GOS_IN_SCENE)
+            {
+                goProps.push_back(cur-&gt;getAllProperties()-&gt;toPropertyMap());
+            }
+        }
+
+        prop = goProps;
+    }
+    else
+    {
+        Throw(IllegalArgumentException, &quot;Property '&quot; + key + &quot;' is no property of a scene.&quot;);
+    }
+
+    return prop;
+}
+
+void Scene::setProperty(const CeGuiString&amp; key, const Property&amp; value)
+{
+    try 
+    {
+        if (key == PROPERTY_GAMEOBJECTS)
+        {
+            PropertyArray goProps = value.toArray();
+
+            for (PropertyArray::iterator it = goProps.begin(); it != goProps.end(); ++it)
+            {
+                PropertyRecord cur(it-&gt;toMap());
+                GameObject* go = GameObjectManager::getSingleton().createGameObject(
+                    cur.getProperty(GameObject::PROPERTY_BASE_CLASS).toString(),
+                    cur.getProperty(GameObject::PROPERTY_CLASS_ID).toInt());
+            }
+        }
+        else
+        {
+            LOG_WARNING(&quot;Scene&quot;, &quot;Property '&quot; + key + &quot;' is no property of a scene.&quot;);
+        }
+    }
+    catch (WrongFormatException ex)
+    {
+        LOG_ERROR(
+            &quot;Scene&quot;,
+            &quot;property &quot; + key + &quot; has the wrong format&quot;);
+    }
+}
+
+PropertyKeys Scene::getAllPropertyKeys() const
+{
+    PropertyKeys keys;
+    keys.insert(Scene::PROPERTY_GAMEOBJECTS);
+    return keys;
+}
+
+}
\ No newline at end of file

Added: rl/trunk/engine/script/src/SceneLoader.cpp
===================================================================
--- rl/trunk/engine/script/src/SceneLoader.cpp	2008-05-31 09:17:47 UTC (rev 4389)
+++ rl/trunk/engine/script/src/SceneLoader.cpp	2008-05-31 09:21:36 UTC (rev 4390)
@@ -0,0 +1,56 @@
+/* This source file is part of Rastullahs Lockenpracht.
+* Copyright (C) 2003-2008 Team Pantheon. <A HREF="http://www.team-pantheon.de">http://www.team-pantheon.de</A>
+* 
+*  This program is free software; you can redistribute it and/or modify
+*  it under the terms of the Clarified Artistic License.
+*
+*  This program is distributed in the hope that it will be useful,
+*  but WITHOUT ANY WARRANTY; without even the implied warranty of
+*  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+*  Clarified Artistic License for more details.
+*
+*  You should have received a copy of the Clarified Artistic License
+*  along with this program; if not you can get it here
+*  <A HREF="http://www.jpaulmorrison.com/fbp/artistic2.htm.">http://www.jpaulmorrison.com/fbp/artistic2.htm.</A>
+*/
+#include &quot;stdinc.h&quot; //precompiled header
+
+#include &quot;SceneLoader.h&quot;
+
+#include &lt;xercesc/dom/DOM.hpp&gt;
+
+#include &quot;Scene.h&quot;
+
+using namespace XERCES_CPP_NAMESPACE;
+
+namespace rl
+{
+
+Scene* SceneLoader::loadScene(Ogre::DataStreamPtr &amp;data)
+{
+    initializeXml();
+
+    DOMDocument* doc = loadDocument(data);
+    DOMElement* root = doc-&gt;getDocumentElement();
+    Scene* scene = new Scene(getAttributeValueAsString(root, &quot;name&quot;));
+    
+    DOMNodeList* children = root-&gt;getChildNodes();
+    for (XMLSize_t i = 0; i &lt; children-&gt;getLength(); ++i)
+    {
+        DOMNode* cur = children-&gt;item(i);
+        if (cur-&gt;getNodeType() == DOMNode::ELEMENT_NODE)
+        {
+            DOMElement* elem = static_cast&lt;DOMElement*&gt;(cur);
+            if (hasNodeName(elem, &quot;map&quot;))
+            {
+                scene-&gt;addMap(getAttributeValueAsStdString(elem, &quot;file&quot;));
+            }
+        }
+    }
+
+    shutdownXml();
+
+    return scene;
+}
+
+}

Added: rl/trunk/engine/script/src/SceneManager.cpp
===================================================================
--- rl/trunk/engine/script/src/SceneManager.cpp	2008-05-31 09:17:47 UTC (rev 4389)
+++ rl/trunk/engine/script/src/SceneManager.cpp	2008-05-31 09:21:36 UTC (rev 4390)
@@ -0,0 +1,125 @@
+/* This source file is part of Rastullahs Lockenpracht.
+* Copyright (C) 2003-2008 Team Pantheon. <A HREF="http://www.team-pantheon.de">http://www.team-pantheon.de</A>
+*
+*  This program is free software; you can redistribute it and/or modify
+*  it under the terms of the Clarified Artistic License.
+*
+*  This program is distributed in the hope that it will be useful,
+*  but WITHOUT ANY WARRANTY; without even the implied warranty of
+*  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+*  Clarified Artistic License for more details.
+*
+*  You should have received a copy of the Clarified Artistic License
+*  along with this program; if not you can get it here
+*  <A HREF="http://www.jpaulmorrison.com/fbp/artistic2.htm.">http://www.jpaulmorrison.com/fbp/artistic2.htm.</A>
+*/
+
+#include &quot;stdinc.h&quot; //precompiled header
+
+#include &quot;SceneManager.h&quot;
+
+#include &quot;Creature.h&quot;
+#include &quot;CreatureControllerManager.h&quot;
+#include &quot;Scene.h&quot;
+#include &quot;SceneLoader.h&quot;
+#include &quot;UiSubsystem.h&quot;
+
+rl::SceneManager* Ogre::Singleton&lt;rl::SceneManager&gt;::ms_Singleton = NULL;
+
+namespace rl 
+{
+
+    SceneManager::SceneManager()
+        : Ogre::Singleton&lt;SceneManager&gt;(),
+          Ogre::ScriptLoader(),
+          mCurrentScene(NULL)
+    {
+        mScriptPatterns.push_back(&quot;*.rlscene&quot;);
+        Ogre::ResourceGroupManager::getSingleton()._registerScriptLoader(this);
+    }
+
+    SceneManager::~SceneManager()
+    {
+        Ogre::ResourceGroupManager::getSingleton()._unregisterScriptLoader(this);
+        for (std::map&lt;CeGuiString, Scene*&gt;::iterator it = mScenes.begin();
+            it != mScenes.end(); ++it)
+        {
+            delete it-&gt;second;
+        }
+    }
+
+    void SceneManager::addScene(Scene* scene) 
+    {
+        mScenes[scene-&gt;getName()] = scene;
+    }
+
+    void SceneManager::loadScene(const CeGuiString&amp; sceneName, bool saveCurrent)
+    {
+        if (mCurrentScene &amp;&amp; sceneName == mCurrentScene-&gt;getName())
+        {
+            return;
+        }
+
+        Creature* activeChar = UiSubsystem::getSingleton().getActiveCharacter();
+
+        if (activeChar) {
+            CreatureControllerManager::getSingleton().detachController(
+                activeChar);
+            activeChar-&gt;setState(GOS_LOADED);
+        }
+
+        if (saveCurrent) 
+        {
+            mSceneStates[mCurrentScene] = mCurrentScene-&gt;getAllProperties();
+        }
+
+        std::map&lt;CeGuiString, Scene*&gt;::iterator itScene = mScenes.find(sceneName);
+        if (itScene != mScenes.end())
+        {            
+            if (saveCurrent) 
+            {
+                itScene-&gt;second-&gt;load(false);
+                mCurrentScene = itScene-&gt;second;
+                std::map&lt;Scene*, PropertyRecordPtr&gt;::iterator itState 
+                    = mSceneStates.find(mCurrentScene);
+                if (itState != mSceneStates.end())
+                {
+                    mCurrentScene-&gt;setProperties(itState-&gt;second);
+                }
+            }
+            else 
+            {
+                itScene-&gt;second-&gt;load(true);
+                mCurrentScene = itScene-&gt;second;
+            }
+        }
+        else
+        {
+            LOG_ERROR(&quot;SceneManager&quot;, 
+                &quot;Scene '&quot; + sceneName + &quot;' not found. Have you forgotten to define it in a .rlscene file?&quot;);
+        }
+
+        if (activeChar) 
+        {
+            UiSubsystem::getSingleton().setActiveCharacter(activeChar);
+        }
+    }
+
+    const Ogre::StringVector&amp; SceneManager::getScriptPatterns() const
+    {
+        return mScriptPatterns;
+    }
+
+    void SceneManager::parseScript(Ogre::DataStreamPtr&amp; data, const Ogre::String&amp; resourceGroup)
+    {
+        SceneLoader* loader = new SceneLoader();
+        addScene(loader-&gt;loadScene(data));
+        delete loader;
+    }
+
+    Ogre::Real SceneManager::getLoadingOrder() const
+    {
+        return 1000;
+    }
+
+}

Modified: rl/trunk/engine/script/src/ScriptSubsystem.cpp
===================================================================
--- rl/trunk/engine/script/src/ScriptSubsystem.cpp	2008-05-31 09:17:47 UTC (rev 4389)
+++ rl/trunk/engine/script/src/ScriptSubsystem.cpp	2008-05-31 09:21:36 UTC (rev 4390)
@@ -16,9 +16,13 @@
 #include &quot;stdinc.h&quot; //precompiled header
 
 #include &quot;ScriptSubsystem.h&quot;
+
+#include &quot;SceneManager.h&quot;
 #include &quot;ScriptObjectMarker.h&quot;
 #include &quot;Logger.h&quot;
 
+#include &quot;SceneManager.h&quot;
+
 using Ogre::Singleton;
 
 template&lt;&gt; rl::ScriptSubsystem* Singleton&lt;rl::ScriptSubsystem&gt;::ms_Singleton = NULL;
@@ -29,10 +33,12 @@
 		: mScriptObjectMarker(NULL), mTriggerFactory(NULL)
     {
         mScriptObjectMarker = new ScriptObjectMarker();
+        new SceneManager();
     }
 
     ScriptSubsystem::~ScriptSubsystem()
     {
+        delete SceneManager::getSingletonPtr();
         delete mScriptObjectMarker;
     }
 

Modified: rl/trunk/engine/script/swig/RlScript.head.swig
===================================================================
--- rl/trunk/engine/script/swig/RlScript.head.swig	2008-05-31 09:17:47 UTC (rev 4389)
+++ rl/trunk/engine/script/swig/RlScript.head.swig	2008-05-31 09:21:36 UTC (rev 4390)
@@ -16,9 +16,10 @@
 
 %{
 //----------- Includes - Script -----------
+#include &quot;ContentLoader.h&quot;
 #include &quot;MapLoader.h&quot;
+#include &quot;SceneManager.h&quot;
 #include &quot;ScriptSubsystem.h&quot;
 #include &quot;TriggerFactory.h&quot;
 #include &quot;UnifiedFactory.h&quot;
-#include &quot;ContentLoader.h&quot;
 %}
\ No newline at end of file

Modified: rl/trunk/engine/script/swig/RlScript.swig
===================================================================
--- rl/trunk/engine/script/swig/RlScript.swig	2008-05-31 09:17:47 UTC (rev 4389)
+++ rl/trunk/engine/script/swig/RlScript.swig	2008-05-31 09:21:36 UTC (rev 4390)
@@ -30,8 +30,10 @@
     class MapLoader : public rl::ContentLoader
     {
     public:
+        MapLoader();
+        MapLoader(const Ogre::String&amp; resourceGroup);
         virtual ~MapLoader();
-        MapLoader(const Ogre::String&amp; resourceGroup);
+
         void loadMap(const Ogre::String&amp; mapresource, bool loadGameObjects = true);
         void loadContent();
         void unloadContent();
@@ -66,4 +68,13 @@
         virtual rl::SteeringBehaviour* createBehaviour(const Ogre::String&amp; classname) = 0;
     };
 
-}
\ No newline at end of file
+    class SceneManager 
+    {
+    public:
+        static rl::SceneManager&amp; getSingleton();
+        void loadScene(const rl::CeGuiString&amp; name, bool saveCurrent = true);
+
+    private:
+        SceneManager();
+    };
+}


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001460.html">[Dsa-hl-svn] r4389 - in modules: combattest/dsa common/dsa
</A></li>
	<LI>Next message: <A HREF="001462.html">[Dsa-hl-svn] r4391 - rl/trunk/engine/common
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1461">[ date ]</a>
              <a href="thread.html#1461">[ thread ]</a>
              <a href="subject.html#1461">[ subject ]</a>
              <a href="author.html#1461">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/dsa-hl-svn">More information about the Dsa-hl-svn
mailing list</a><br>
</body></html>
