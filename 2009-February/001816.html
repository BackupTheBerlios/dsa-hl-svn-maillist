<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Dsa-hl-svn] r4759 - in rl/trunk/editors/Lockenwickler: .	_eric4project src
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/dsa-hl-svn/2009-February/index.html" >
   <LINK REL="made" HREF="mailto:dsa-hl-svn%40lists.berlios.de?Subject=Re%3A%20%5BDsa-hl-svn%5D%20r4759%20-%20in%20rl/trunk/editors/Lockenwickler%3A%20.%0A%09_eric4project%20src&In-Reply-To=%3C200902092205.n19M50BE029581%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001815.html">
   <LINK REL="Next"  HREF="001817.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Dsa-hl-svn] r4759 - in rl/trunk/editors/Lockenwickler: .	_eric4project src</H1>
    <B>fusion2 at mail.berlios.de</B> 
    <A HREF="mailto:dsa-hl-svn%40lists.berlios.de?Subject=Re%3A%20%5BDsa-hl-svn%5D%20r4759%20-%20in%20rl/trunk/editors/Lockenwickler%3A%20.%0A%09_eric4project%20src&In-Reply-To=%3C200902092205.n19M50BE029581%40sheep.berlios.de%3E"
       TITLE="[Dsa-hl-svn] r4759 - in rl/trunk/editors/Lockenwickler: .	_eric4project src">fusion2 at mail.berlios.de
       </A><BR>
    <I>Mon Feb  9 23:05:00 CET 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="001815.html">[Dsa-hl-svn] r4758 - rl/trunk/engine/core
</A></li>
        <LI>Next message: <A HREF="001817.html">[Dsa-hl-svn] r4760 - in rl/trunk: . docs/documents	engine/ui/include engine/ui/src
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1816">[ date ]</a>
              <a href="thread.html#1816">[ thread ]</a>
              <a href="subject.html#1816">[ subject ]</a>
              <a href="author.html#1816">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: fusion2
Date: 2009-02-09 23:04:51 +0100 (Mon, 09 Feb 2009)
New Revision: 4759

Modified:
   rl/trunk/editors/Lockenwickler/Lockenwickler.e4p
   rl/trunk/editors/Lockenwickler/_eric4project/Lockenwickler.e4q
   rl/trunk/editors/Lockenwickler/_eric4project/Lockenwickler.e4t
   rl/trunk/editors/Lockenwickler/src/Lockenwickler.py
   rl/trunk/editors/Lockenwickler/src/ModuleExplorer.py
   rl/trunk/editors/Lockenwickler/src/ModuleManager.py
   rl/trunk/editors/Lockenwickler/src/MovePivot.py
   rl/trunk/editors/Lockenwickler/src/OgreMainWindow.py
   rl/trunk/editors/Lockenwickler/src/OgreWidget.py
   rl/trunk/editors/Lockenwickler/src/SelectionBuffer.py
Log:
- add new scenes/maps with the module explorer
- scenes are saved to xml (maps are still WIP)
- selection buffer now updates its size

Modified: rl/trunk/editors/Lockenwickler/Lockenwickler.e4p
===================================================================
--- rl/trunk/editors/Lockenwickler/Lockenwickler.e4p	2009-02-09 21:25:56 UTC (rev 4758)
+++ rl/trunk/editors/Lockenwickler/Lockenwickler.e4p	2009-02-09 22:04:51 UTC (rev 4759)
@@ -1,7 +1,7 @@
 &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
 &lt;!DOCTYPE Project SYSTEM &quot;Project-4.6.dtd&quot;&gt;
 &lt;!-- eric4 project file for project Lockenwickler --&gt;
-&lt;!-- Saved: 2009-02-08, 13:55:11 --&gt;
+&lt;!-- Saved: 2009-02-09, 18:57:06 --&gt;
 &lt;!-- Copyright (C) 2009 Stefan Stammberger, <A HREF="https://lists.berlios.de/mailman/listinfo/dsa-hl-svn">sstammberger at web.de</A> --&gt;
 &lt;Project version=&quot;4.6&quot;&gt;
   &lt;Language&gt;en&lt;/Language&gt;

Modified: rl/trunk/editors/Lockenwickler/_eric4project/Lockenwickler.e4q
===================================================================
--- rl/trunk/editors/Lockenwickler/_eric4project/Lockenwickler.e4q	2009-02-09 21:25:56 UTC (rev 4758)
+++ rl/trunk/editors/Lockenwickler/_eric4project/Lockenwickler.e4q	2009-02-09 22:04:51 UTC (rev 4759)
@@ -1,7 +1,7 @@
 &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
 &lt;!DOCTYPE UserProject SYSTEM &quot;UserProject-4.0.dtd&quot;&gt;
 &lt;!-- eric4 user project file for project Lockenwickler --&gt;
-&lt;!-- Saved: 2009-02-08, 13:55:11 --&gt;
+&lt;!-- Saved: 2009-02-09, 18:57:06 --&gt;
 &lt;!-- Copyright (C) 2009 Stefan Stammberger, <A HREF="https://lists.berlios.de/mailman/listinfo/dsa-hl-svn">sstammberger at web.de</A> --&gt;
 &lt;UserProject version=&quot;4.0&quot;&gt;
 &lt;/UserProject&gt;
\ No newline at end of file

Modified: rl/trunk/editors/Lockenwickler/_eric4project/Lockenwickler.e4t
===================================================================
--- rl/trunk/editors/Lockenwickler/_eric4project/Lockenwickler.e4t	2009-02-09 21:25:56 UTC (rev 4758)
+++ rl/trunk/editors/Lockenwickler/_eric4project/Lockenwickler.e4t	2009-02-09 22:04:51 UTC (rev 4759)
@@ -1,15 +1,33 @@
 &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
 &lt;!DOCTYPE Tasks SYSTEM &quot;Tasks-4.2.dtd&quot;&gt;
 &lt;!-- eric4 tasks file for project Lockenwickler --&gt;
-&lt;!-- Saved: 2009-02-08, 13:55:11 --&gt;
+&lt;!-- Saved: 2009-02-09, 18:57:06 --&gt;
 &lt;Tasks version=&quot;4.2&quot;&gt;
   &lt;Task priority=&quot;1&quot; completed=&quot;False&quot; bugfix=&quot;False&quot;&gt;
+    &lt;Summary&gt;TODO: not implemented yet&lt;/Summary&gt;
+    &lt;Description&gt;&lt;/Description&gt;
+    &lt;Created&gt;2009-02-09, 14:05:47&lt;/Created&gt;
+    &lt;Resource&gt;
+      &lt;Filename&gt;src/GOIntEditor.py&lt;/Filename&gt;
+      &lt;Linenumber&gt;28&lt;/Linenumber&gt;
+    &lt;/Resource&gt;
+  &lt;/Task&gt;
+  &lt;Task priority=&quot;1&quot; completed=&quot;False&quot; bugfix=&quot;False&quot;&gt;
+    &lt;Summary&gt;TODO: not implemented yet&lt;/Summary&gt;
+    &lt;Description&gt;&lt;/Description&gt;
+    &lt;Created&gt;2009-02-09, 14:05:47&lt;/Created&gt;
+    &lt;Resource&gt;
+      &lt;Filename&gt;src/GOIntEditor.py&lt;/Filename&gt;
+      &lt;Linenumber&gt;36&lt;/Linenumber&gt;
+    &lt;/Resource&gt;
+  &lt;/Task&gt;
+  &lt;Task priority=&quot;1&quot; completed=&quot;False&quot; bugfix=&quot;False&quot;&gt;
     &lt;Summary&gt;TODO: implement save here&lt;/Summary&gt;
     &lt;Description&gt;&lt;/Description&gt;
-    &lt;Created&gt;2009-02-08, 11:32:14&lt;/Created&gt;
+    &lt;Created&gt;2009-02-09, 16:16:17&lt;/Created&gt;
     &lt;Resource&gt;
       &lt;Filename&gt;src/Lockenwickler.py&lt;/Filename&gt;
-      &lt;Linenumber&gt;416&lt;/Linenumber&gt;
+      &lt;Linenumber&gt;424&lt;/Linenumber&gt;
     &lt;/Resource&gt;
   &lt;/Task&gt;
 &lt;/Tasks&gt;
\ No newline at end of file

Modified: rl/trunk/editors/Lockenwickler/src/Lockenwickler.py
===================================================================
--- rl/trunk/editors/Lockenwickler/src/Lockenwickler.py	2009-02-09 21:25:56 UTC (rev 4758)
+++ rl/trunk/editors/Lockenwickler/src/Lockenwickler.py	2009-02-09 22:04:51 UTC (rev 4759)
@@ -76,7 +76,7 @@
             self.prefDialog.show()
 
         self.moduleManager.moduleCfgPath = self.prefDialog.moduleCfgPath
-        self.moduleManager.moduleExplorer = self.moduleExplorerWin
+        self.moduleManager.setModuleExplorer(self.moduleExplorerWin)
         
         self.setWindowIcon(QIcon(&quot;media/icons/lockenwickler_provisorium_small.png&quot;))
         self.setWindowTitle(&quot;Rastullahs Lockenwickler&quot;)
@@ -142,6 +142,9 @@
 
         self.actionOpen = self.createAction(&quot;&amp;Open Module&quot;,  self.actionOpenSlot,  QKeySequence.Open,  &quot;filenew.png&quot;,  &quot;Open Module&quot;)
         self.actionOpen.setObjectName(&quot;actionOpen&quot;)
+        
+        self.actionSave = self.createAction(&quot;&amp;Save&quot;,  self.actionSaveSlot,  QKeySequence.Save,  &quot;filenew.png&quot;,  &quot;Save Module&quot;)
+        self.actionSave.setObjectName(&quot;actionSave&quot;)
 
         self.actionClose = self.createAction(&quot;Quit&quot;,  self.actionQuitSlot,  &quot;Alt + Q&quot;,  &quot;exit.png&quot;,  &quot;Quit&quot;)
         self.actionClose.setObjectName(&quot;actionQuit&quot;)
@@ -200,6 +203,7 @@
 
         self.menuFile.addAction(self.actionNeu)
         self.menuFile.addAction(self.actionOpen)
+        self.menuFile.addAction(self.actionSave)
         self.menuFile.addAction(self.actionClose)
 
         self.menuEdit.addAction(self.actionSelect)
@@ -284,7 +288,10 @@
         newModuleWiz = NewModuleWizard(self.moduleManager, self)
         newModuleWiz.exec_()
         return
-
+        
+    def actionSaveSlot(self):
+        self.moduleManager.save()
+        
     def actionQuitSlot(self):
         self.close()
 
@@ -368,7 +375,7 @@
         self.addDockWidget(QtCore.Qt.RightDockWidgetArea, self.gameObjectClassViewDock)
 
         self.moduleExplorerDock = QtGui.QDockWidget(self.tr(&quot;Module Explorer&quot;), self)
-        self.moduleExplorerDock.setObjectName(&quot;SceneExplorerDockWindow&quot;)
+        self.moduleExplorerDock.setObjectName(&quot;ModuleExplorerDockWindow&quot;)
         self.moduleExplorerDock.setAllowedAreas(QtCore.Qt.LeftDockWidgetArea | QtCore.Qt.RightDockWidgetArea)
         self.moduleExplorerDock.setWidget(self.moduleExplorerWin)
         self.addDockWidget(QtCore.Qt.LeftDockWidgetArea, self.moduleExplorerDock)
@@ -383,6 +390,7 @@
         self.fileToolBar.setObjectName(&quot;FileToolBar&quot;)
         self.fileToolBar.setAllowedAreas(QtCore.Qt.TopToolBarArea | QtCore.Qt.BottomToolBarArea)
         self.fileToolBar.addAction(self.actionNeu)
+        self.fileToolBar.addAction(self.actionSave)
         self.fileToolBar.addAction(self.actionClose)
         self.addToolBar(QtCore.Qt.TopToolBarArea, self.fileToolBar)
 

Modified: rl/trunk/editors/Lockenwickler/src/ModuleExplorer.py
===================================================================
--- rl/trunk/editors/Lockenwickler/src/ModuleExplorer.py	2009-02-09 21:25:56 UTC (rev 4758)
+++ rl/trunk/editors/Lockenwickler/src/ModuleExplorer.py	2009-02-09 22:04:51 UTC (rev 4759)
@@ -16,17 +16,60 @@
  # Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
  #################################################
 
-
+#dienstag 24.03 15.50
 import sys
 from PyQt4.QtCore import *
 from PyQt4.QtGui import *
 import ogre.renderer.OGRE as og
 
+class NameInputDlg(QDialog):
+    def __init__(self, parent = None):
+        super(NameInputDlg, self).__init__(parent)
+        
+        self.nameInput = QLineEdit(self)
+        buttonBox = QDialogButtonBox(QDialogButtonBox.Ok | QDialogButtonBox.Cancel)
+        layout = QVBoxLayout()
+        layout.addWidget(self.nameInput)
+        layout.addWidget(buttonBox)
+        self.setLayout(layout)
+        
+        self.connect(buttonBox, SIGNAL(&quot;accepted()&quot;), self, SLOT(&quot;accept()&quot;))        
+        self.connect(buttonBox, SIGNAL(&quot;rejected()&quot;), self, SLOT(&quot;reject()&quot;))
+        
+        
+class ModuleTreeWidget(QTreeWidget):
+    def __init__(self, parent = None):
+        super(ModuleTreeWidget, self).__init__(parent)
+        
+        self.connect(self, SIGNAL(&quot;itemClicked (QTreeWidgetItem *,int)&quot;), self.onClick)
+        self.setContextMenuPolicy(Qt.CustomContextMenu)        
+        self.connect(self, SIGNAL(&quot;customContextMenuRequested(const QPoint &amp;)&quot;), self.doMenu)
+
+        self.onMenuCallback = None
+
+
+#        clearAction= QAction(&quot;Clear Window&quot;,  self)
+#        self.consoleWindow.textEdit.addAction(clearAction)
+#        self.consoleWindow.textEdit.setContextMenuPolicy(Qt.ActionsContextMenu)
+#        clearAction.setShortcut(&quot;Ctrl + R&quot;)
+#        self.connect(clearAction, SIGNAL(&quot;triggered()&quot;), self.consoleWindow.textEdit.clear)
+
+    def setMenuCallback(self, callback):
+        self.onMenuCallback = callback
+        
+    def doMenu(self, point):
+        self.onMenuCallback(self.mapToGlobal(point))
+
+    def onClick(self, item, column):
+        pass
+
 class ModuleExplorer(QWidget):
     def __init__(self, parent=None):
         QWidget.__init__(self, parent)
-        self.sceneTreeView = QTreeWidget()
-
+        self.sceneTreeView = ModuleTreeWidget()
+        
+        self.sceneTreeView.setMenuCallback(self.onMenu)
+        
         vBoxLayout = QVBoxLayout()
         vBoxLayout.addWidget(self.sceneTreeView)
 
@@ -34,12 +77,49 @@
         
         self.nodeDict = {}
         
+        self.moduleManager = None
+      
+    def onMenu(self, point):
+        if self.moduleManager is not None:
+            menu = QMenu(self)
+            
+            newSceneAction= QAction(&quot;New Scene&quot;,  self)
+            menu.addAction(newSceneAction)
+            self.connect(newSceneAction, SIGNAL(&quot;triggered()&quot;), self.onNewScene)
+
+            if self.sceneTreeView.currentItem() is not None and str(self.sceneTreeView.currentItem().text(0)).startswith(&quot;Scene:&quot;):
+                newMapAction= QAction(&quot;New Map&quot;,  self)
+                menu.addAction(newMapAction)
+                self.connect(newMapAction, SIGNAL(&quot;triggered()&quot;), self.onNewMap)
+
+            deleteAction= QAction(&quot;Delete&quot;,  self)
+            menu.addAction(deleteAction)
+            self.connect(deleteAction, SIGNAL(&quot;triggered()&quot;), self.onDelete)
+            
+            menu.exec_(point)
+      
+    def onNewScene(self):
+        dlg = NameInputDlg(self)
+        if dlg.exec_():
+            self.moduleManager.addSceneToModule(str(dlg.nameInput.text()))
+            self.updateView()
+            
+    def onNewMap(self):
+        dlg = NameInputDlg(self)
+        if dlg.exec_():
+            sceneName = str(self.sceneTreeView.currentItem().text(0)).replace(&quot;Scene: &quot;, &quot;&quot;)
+            self.moduleManager.addMapToScene(sceneName, str(dlg.nameInput.text()))
+            self.updateView()
+        
+    def onDelete(self):
+        print &quot;delete&quot;
+      
     def updateView(self):
         self.sceneTreeView.clear()
         
         for s in self.module.scenes:
             sceneRootItem = QTreeWidgetItem(self.sceneTreeView)
-            sceneRootItem.setText(0, s.name)
+            sceneRootItem.setText(0, &quot;Scene: &quot; + s.name)
             
             for m in s.mapFiles:
                 self.parseMap(m, sceneRootItem)
@@ -47,7 +127,7 @@
                 
     def parseMap(self, map, sceneRootItem):
         childItem =  QTreeWidgetItem(sceneRootItem)
-        childItem.setText(0, map.mapName)
+        childItem.setText(0, &quot;Map: &quot; + map.mapName)
         
         iter = map.mapNode.getChildIterator()
         while iter.hasMoreElements():
@@ -59,3 +139,5 @@
         self.module = module
         self.updateView()
 
+    def setModuleManager(self, moduleManager):
+        self.moduleManager = moduleManager

Modified: rl/trunk/editors/Lockenwickler/src/ModuleManager.py
===================================================================
--- rl/trunk/editors/Lockenwickler/src/ModuleManager.py	2009-02-09 21:25:56 UTC (rev 4758)
+++ rl/trunk/editors/Lockenwickler/src/ModuleManager.py	2009-02-09 22:04:51 UTC (rev 4759)
@@ -57,8 +57,24 @@
 #                        &lt;/trigger&gt;
 #                &lt;/zone&gt;
 
+def indent(elem, level=0):
+    i = &quot;\n&quot; + level*&quot;  &quot;
+    
+    if len(elem):
+        if not elem.text or not elem.text.strip():
+            elem.text = i + &quot;  &quot;
+        if not elem.tail or not elem.tail.strip():
+            elem.tail = i
+        for elem in elem:
+            indent(elem, level+1)
+        if not elem.tail or not elem.tail.strip():
+            elem.tail = i
+    else:
+        if level and (not elem.tail or not elem.tail.strip()):
+            elem.tail = i
+
 class Map():
-    def __init__(self, pathToFile, sceneManager, ogreRoot, gocManager):
+    def __init__(self, pathToFile, sceneManager, ogreRoot, gocManager, emptyMap = False):
         self.pathToMapFile = pathToFile
         
         mapName = pathToFile.replace(&quot;\\&quot;, &quot;/&quot;)
@@ -66,21 +82,23 @@
         mapName = mapName[len(mapName) - 1].split(&quot;.&quot;)
         mapName = mapName[len(mapName) - 3]
         self.mapName = mapName
+        self.mapFileName = self.mapName + &quot;.rlmap.xml&quot;
         
         self.sceneManager = sceneManager
         self.mapNode = sceneManager.getRootSceneNode().createChildSceneNode(self.pathToMapFile)
         self.ogreRoot = ogreRoot
         self.gocManager = gocManager
 
-        xmlTree = xml.parse(pathToFile)
-        root = xmlTree.getroot()
+        if not emptyMap:
+            xmlTree = xml.parse(pathToFile)
+            root = xmlTree.getroot()
 
-        if root.attrib[&quot;formatVersion&quot;] == &quot;0.4.0&quot;:
-            self.parseMapNodes(root.find(&quot;nodes&quot;))
-            #self.parseMapZones(root.find(&quot;zones&quot;))
-        else:
-            print pathToFile + &quot; has wrong format version. It needs to be 0.4.0&quot;
-            return
+            if root.attrib[&quot;formatVersion&quot;] == &quot;0.4.0&quot;:
+                self.parseMapNodes(root.find(&quot;nodes&quot;))
+                #self.parseMapZones(root.find(&quot;zones&quot;))
+            else:
+                print pathToFile + &quot; has wrong format version. It needs to be 0.4.0&quot;
+                return
 
     def parseMapNodes(self, nodeElement):
         nodes = nodeElement.getiterator(&quot;entity&quot;)
@@ -148,7 +166,7 @@
             colourSpecular = None
             lightAttenuationRange = None
             lightAttenuationConstant= None
-            lightAttenuationlinear = None
+            lightAttenuationLinear = None
             lightAttenuationQuadratic = None
 
             transformations = l.getiterator()
@@ -171,14 +189,27 @@
                 elif t.tag == &quot;lightAttenuation&quot;:
                     lightAttenuationRange = float(t.attrib[&quot;range&quot;])
                     lightAttenuationConstant= float(t.attrib[&quot;constant&quot;])
-                    lightAttenuationlinear = float(t.attrib[&quot;linear&quot;])
+                    lightAttenuationLinear = float(t.attrib[&quot;linear&quot;])
                     lightAttenuationQuadratic = float(t.attrib[&quot;quadratic&quot;])
+            
 
-            e = self.sceneManager.createEntity(lightName, &quot;lightbulp.mesh&quot;)
+            light = self.sceneManager.createLight(lightName)
+            light.setVisible(lightVisible)
+            light.setCastShadows(castShadows)
+            light.setAttenuation(lightAttenuationRange, lightAttenuationConstant, lightAttenuationLinear, lightAttenuationQuadratic)
+            light.setDiffuseColour(colourDiffuse)
+            light.setSpecularColour(colourSpecular)
+            
+            if lightType == &quot;point&quot;:
+                light.setType(og.Light.LT_POINT)
+            
+            e = self.sceneManager.createEntity(lightName + &quot;_ent&quot;, &quot;lightbulp.mesh&quot;)
             n = self.mapNode.createChild(lightName + &quot;_node&quot;)
             n.attachObject(e)
+            n.attachObject(light)
             n.setPosition(lightPosition)
 
+            
     def createSound(self, soundNodes):
         #raise NotImplementedError
         return
@@ -233,34 +264,59 @@
     def createParticleSystems(self, particleNodes):
         #raise NotImplementedError
         return
+        
+    def save(self):
+        root = xml.Element(&quot;rastullahmap&quot;)
+        root.attrib[&quot;formatVersion&quot;] = &quot;0.4.0&quot;
+        
+        nodesElem = xml.SubElement(root, &quot;nodes&quot;)
+        
+        iter = self.mapNode.getChildIterator()
+        while iter.hasMoreElements():
+            iter.getNext().getName()
 
 class Scene():
-    def __init__(self, moduleroot, pathToFile, sceneManager, ogreRoot, gocManager):
+    def __init__(self, moduleroot, pathToFile, sceneManager, ogreRoot, gocManager, emptyScene = False, sceneName = &quot;NewScene&quot;):
         self.moduleRoot = moduleroot
+        self.pathToFile = pathToFile
         self.sceneManager = sceneManager
         self.ogreRoot = ogreRoot
         self.gocManager = gocManager
-        
-        xmlTree = xml.parse(pathToFile)
-        root = xmlTree.getroot()
-        self.name = root.attrib[&quot;name&quot;]
-        
         self.mapFiles = [] # a list in case the module has more than one map file
         mappaths = []
+        self.name = sceneName
+
         
-        maps = root.getiterator(&quot;map&quot;)
-        for m in maps:
-            mappaths.append(join(self.moduleRoot, join(&quot;maps&quot;, m.attrib[&quot;file&quot;])))
+        if not emptyScene:
+            xmlTree = xml.parse(pathToFile)
+            root = xmlTree.getroot()
+            self.name = root.attrib[&quot;name&quot;]
+        
+            maps = root.getiterator(&quot;map&quot;)
+            for m in maps:
+                mappaths.append(join(self.moduleRoot, join(&quot;maps&quot;, m.attrib[&quot;file&quot;])))
+                
+            for m in mappaths:
+                self.mapFiles.append(Map(m, self.sceneManager, self.ogreRoot, self.gocManager))
             
-        for m in mappaths:
-            self.mapFiles.append(Map(m, self.sceneManager, self.ogreRoot, self.gocManager))
-            
-        #cmd = join(self.moduleRoot, &quot;maps/*.rlmap.xml&quot;)
-        #maps = glob.glob(cmd)
-        #for m in maps:
-            #self.mapFiles.append(Map(m, self.sceneManager, self.ogreRoot, self.gocManager))
+    def addMap(self, name):
+        path = join(self.moduleRoot, join(&quot;maps&quot;, name + &quot;.rlmap.xml&quot;))
+        self.mapFiles.append(Map(path, self.sceneManager, self.ogreRoot, self.gocManager, True))
+        
+    def save(self):
+        root = xml.Element(&quot;scene&quot;)
+        root.attrib[&quot;name&quot;] = self.name
+        
+        for m in self.mapFiles:
+            sub = xml.SubElement(root, &quot;map&quot;)
+            sub.attrib[&quot;file&quot;] = m.mapFileName
+            m.save()
 
+        indent(root)
+        xml.ElementTree(root).write(self.pathToFile)
 
+
+
 class Module():
     def __init__(self,name, modulePath, sceneManager, ogreRoot, gameObjectManager):
         self.sceneManager = sceneManager
@@ -281,6 +337,18 @@
 
         self.isLoaded = False
 
+    def addScene(self, name):
+        self.scenes.append(Scene(self.moduleRoot, join(self.moduleRoot, (&quot;maps/&quot; + name + &quot;.rlscene&quot;)), self.sceneManager, self.ogreRoot, self.gocManager, True, name))
+    
+    def addMapToScene(self, sceneName, mapName):
+        for scene in self.scenes:
+            if scene.name == sceneName:
+                scene.addMap(mapName)
+                return
+        
+        print &quot;ERROR: could not find scene: &quot; + sceneName
+        
+    
     def isCommon(self):
         modConfig = join(self.moduleRoot,  &quot;scripts/moduleconfig.rb&quot;)
         if isfile(modConfig): # is the modconfig existing?
@@ -343,15 +411,13 @@
             
         
     def loadScenes(self, sceneFiles):
-        for f in sceneFiles:
-            self.scenes.append(Scene(self.moduleRoot, f, self.sceneManager, self.ogreRoot, self.gocManager))
+        for s in sceneFiles:
+            self.scenes.append(Scene(self.moduleRoot, s, self.sceneManager, self.ogreRoot, self.gocManager))
 
-    def saveMaps(self):
-        return
+    def save(self):
+        for s in self.scenes:
+            s.save()
 
-    def saveScenes(self):
-        return
-
     def setResourcePaths(self, recurseFolder = &quot;&quot;):
         if recurseFolder == &quot;&quot;:
             rootFolder = self.moduleRoot
@@ -384,7 +450,7 @@
         # and deletes the object
         self.gameObjectRepresentationDict = []
 
-        self.mainModule = []
+        self.mainModule = None
         self.mainModuledependencieList =[]
         self.moduleList = []
         self.userSelectionList = []
@@ -486,7 +552,7 @@
                 self.mainModule = m
                 self.moduleExplorer.setCurrentModule(m)
                 
-#        self.moduleExplorer.updateView()
+        self.moduleExplorer.updateView()
 #        n = self.sceneManager.getRootSceneNode().createChildSceneNode()
 #        e = self.sceneManager.createEntity(&quot;west342wt346t&quot;,  &quot;UniCube.mesh&quot;)
 #        e.setMaterialName(&quot;PlainColor&quot;)
@@ -502,15 +568,24 @@
         if self.selectionBuffer is None:
             self.selectionBuffer = SelectionBuffer(self.sceneManager, self.ogreRoot.getRenderTarget(&quot;OgreMainWin&quot;))
 
+    def addSceneToModule(self, name):
+        if self.mainModule is not None:
+            self.mainModule.addScene(name)
+
+    def addMapToScene(self, sceneName, mapName):
+        if self.mainModule is not None:
+            self.mainModule.addMapToScene(sceneName, mapName)
+
+    def setModuleExplorer(self, moduleExplorer):
+        self.moduleExplorer = moduleExplorer
+        self.moduleExplorer.setModuleManager(self)
+        
     # called when a click into Main Ogre Window occurs
     def selectionClick(self, screenX, screenY, ray,  controlDown=False,  shiftDown=False):
         so = None
-        
         if self.selectionBuffer is not None:
             so = self.selectionBuffer.onSelectionClick(screenX, screenY)
         
-        
-        
         if so is not None:
             if not so.isPivot:
                 if not controlDown and not shiftDown:
@@ -697,7 +772,7 @@
         pass
 
     def save(self):
-        pass
+        self.mainModule.save()
 
     def startDropGameObjectAction(self, classid, ray):
         go = self.gocManager.getGameObjectWithClassId(classid)

Modified: rl/trunk/editors/Lockenwickler/src/MovePivot.py
===================================================================
--- rl/trunk/editors/Lockenwickler/src/MovePivot.py	2009-02-09 21:25:56 UTC (rev 4758)
+++ rl/trunk/editors/Lockenwickler/src/MovePivot.py	2009-02-09 22:04:51 UTC (rev 4759)
@@ -191,7 +191,7 @@
                 transVec = transVec * transFactor
                 for so in self.selectionList:
                     so.entity.getParentNode().translate(transVec)
-
+                    
                 self.pivotNode.translate(transVec)
 
             # rotate mode
@@ -211,8 +211,16 @@
         self.update()
 
     def update(self):
-        if not self.isHidden:
-            dist = self.camera.getPosition().distance(self.pivotNode.getPosition())
-            self.pivotNode.setScale(og.Vector3(0.5,  0.5,  0.5) * (dist / 30))
+        vSize = og.Vector3(1.0,1.0,1.0)
+        vScale = og.Vector3(1.0,1.0,1.0)
+
+        dist = (self.camera.getDerivedPosition() - self.pivotNode._getDerivedPosition()).length()
+        vScale *= dist / 90.0
 
+        self.pivotNode.setScale(vScale.x * vSize.x,vScale.y * vSize.y,vScale.z * vSize.z)
+        #print vScale.x * vSize.x,vScale.y * vSize.y,vScale.z * vSize.z
+#        if not self.isHidden:
+#            dist = self.camera.getPosition().distance(self.pivotNode.getPosition())
+#            self.pivotNode.setScale(og.Vector3(0.5,  0.5,  0.5) * (dist / 30))
 
+

Modified: rl/trunk/editors/Lockenwickler/src/OgreMainWindow.py
===================================================================
--- rl/trunk/editors/Lockenwickler/src/OgreMainWindow.py	2009-02-09 21:25:56 UTC (rev 4758)
+++ rl/trunk/editors/Lockenwickler/src/OgreMainWindow.py	2009-02-09 22:04:51 UTC (rev 4759)
@@ -312,7 +312,7 @@
         return self.ogreWidget.getHeight()
 
 
-    def updateCamera(self):
+    def updateCamera(self):        
         if self.moveCamForward:
             self.ogreWidget.dollyCamera(og.Vector3( 0, 0,-0.2))
         if self.moveCamBackward:
@@ -321,3 +321,5 @@
             self.ogreWidget.dollyCamera(og.Vector3(-0.2, 0 , 0))
         if self.strafeCamRight:
             self.ogreWidget.dollyCamera(og.Vector3( 0.2, 0, 0))
+        
+        self.moduleManager.pivot.update()

Modified: rl/trunk/editors/Lockenwickler/src/OgreWidget.py
===================================================================
--- rl/trunk/editors/Lockenwickler/src/OgreWidget.py	2009-02-09 21:25:56 UTC (rev 4758)
+++ rl/trunk/editors/Lockenwickler/src/OgreWidget.py	2009-02-09 22:04:51 UTC (rev 4759)
@@ -33,6 +33,7 @@
         self.sceneManager = sceneManager
         self.camDistFromFocusNode = camDistFromFocusNode
         self.initOgreWindow(renderWindowName,cameraName)
+        self.resizeEventListener = []
 
     def initOgreWindow(self, renderWindowName, cameraName):
         self.renderParameters = og.NameValuePairList()
@@ -86,7 +87,13 @@
 
         if self.camera:
             self.camera.setAspectRatio(float(event.size().width()) / float(event.size().height()));
+            
+        for listener in self.resizeEventListener:
+            listener(event.size().width(), event.size().height())
 
+    def addResizeEventListener(self, listener):
+        self.resizeEventListener.append(listener)
+
     def addOgreResourceLocation(self, location, locType, resGroup, recursive=False):
         og.ResourceGroupManager.getSingleton().addResourceLocation(location, locType, resGroup, recursive)
 

Modified: rl/trunk/editors/Lockenwickler/src/SelectionBuffer.py
===================================================================
--- rl/trunk/editors/Lockenwickler/src/SelectionBuffer.py	2009-02-09 21:25:56 UTC (rev 4758)
+++ rl/trunk/editors/Lockenwickler/src/SelectionBuffer.py	2009-02-09 22:04:51 UTC (rev 4759)
@@ -95,7 +95,7 @@
         self.sceneMgr = sceneManager
         self.camera = sceneManager.getCamera(&quot;MainCam&quot;)
 
-        self.viewport = renderTarget
+        self.renderTarget = renderTarget
         
         # This is the material listener - Note: it is controlled by a seperate
         # RenderTargetListener, not applied globally to all targets
@@ -103,8 +103,8 @@
         
         self.selectionTargetListener = SelectionRenderListener( self.materialSwitchListener )
         
-        width = self.viewport.getWidth()
-        height = self.viewport.getHeight()
+        width = self.renderTarget.getWidth()
+        height = self.renderTarget.getHeight()
         
         self.texture = og.TextureManager.getSingleton().createManual(&quot;SelectionPassTex&quot;, 
                                                                     og.ResourceGroupManager.DEFAULT_RESOURCE_GROUP_NAME, 
@@ -122,9 +122,11 @@
         self.renderTexture.addListener( self.selectionTargetListener )
         self.renderTexture.getViewport(0).setMaterialScheme(&quot;aa&quot;)
         
-        self.createRTTOverlays()
+        #self.createRTTOverlays()
 
     def update(self):
+        self.updateBufferSize()
+        
         self.renderTexture.update()        
         self.materialSwitchListener.reset()
         
@@ -146,7 +148,38 @@
 #            #print str(self.buffer[i + 2]) + &quot; &quot; + str(self.buffer[i+1]) + &quot; &quot; + str(self.buffer[i])
 #            
 #            i += 4
+    
+    def updateBufferSize(self):
+        width = self.renderTarget.getWidth()
+        height = self.renderTarget.getHeight()
+        needsSizeUpdate = False
+        
+        if width is not self.renderTexture.getWidth():
+            needsSizeUpdate = True
+        if height is not self.renderTexture.getHeight():
+            needsSizeUpdate = True            
+        
+        if needsSizeUpdate:
+            og.TextureManager.getSingleton().unload(&quot;SelectionPassTex&quot;)
             
+            self.texture = og.TextureManager.getSingleton().createManual(&quot;SelectionPassTex&quot;, 
+                                                            og.ResourceGroupManager.DEFAULT_RESOURCE_GROUP_NAME, 
+                                                            og.TEX_TYPE_2D, 
+                                                            width, 
+                                                            height, 
+                                                            0, og.PixelFormat.PF_R8G8B8, og.TU_RENDERTARGET)
+                                                                    
+            self.renderTexture = self.texture.getBuffer().getRenderTarget()
+            self.renderTexture.setAutoUpdated(False)
+            self.renderTexture.setPriority(0)                                                         
+            self.renderTexture.addViewport( self.camera )
+            self.renderTexture.getViewport(0).setOverlaysEnabled(False)
+            self.renderTexture.getViewport(0).setClearEveryFrame(True)
+            self.renderTexture.addListener( self.selectionTargetListener )
+            self.renderTexture.getViewport(0).setMaterialScheme(&quot;aa&quot;)
+        else:
+            return
+            
     def onSelectionClick(self, x, y):
         self.update()
         
@@ -157,8 +190,31 @@
         
         for key in self.materialSwitchListener.colorDict:
             if self.materialSwitchListener.colorDict[key] == colVec:
-                so = SelectionObject(self.sceneMgr.getEntity(key))
-                return so
+                if key == &quot;OgreMainWin::0::ViewportGrid&quot;:
+                    return None
+                elif key == &quot;rayLine&quot;:
+                    return None
+                elif key == &quot;EditorXArrow&quot;:
+                    so = SelectionObject(self.sceneMgr.getEntity(key))
+                    so.isPivot = True
+                    return so
+                elif key == &quot;EditorYArrow&quot;:
+                    so = SelectionObject(self.sceneMgr.getEntity(key))
+                    so.isPivot = True
+                    return so
+                elif key == &quot;EditorZArrow&quot;:
+                    so = SelectionObject(self.sceneMgr.getEntity(key))
+                    so.isPivot = True
+                    return so
+                elif key == &quot;EditorFreeMover&quot;:
+                    return None
+                elif key == &quot;EditorXRotator&quot; or key == &quot;EditorYRotator&quot; or key == &quot;EditorZRotator&quot;:
+                    so = SelectionObject(self.sceneMgr.getEntity(key))
+                    so.isPivot = True
+                    return so
+                else:
+                    so = SelectionObject(self.sceneMgr.getEntity(key))
+                    return so
 
         return None
         


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001815.html">[Dsa-hl-svn] r4758 - rl/trunk/engine/core
</A></li>
	<LI>Next message: <A HREF="001817.html">[Dsa-hl-svn] r4760 - in rl/trunk: . docs/documents	engine/ui/include engine/ui/src
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1816">[ date ]</a>
              <a href="thread.html#1816">[ thread ]</a>
              <a href="subject.html#1816">[ subject ]</a>
              <a href="author.html#1816">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/dsa-hl-svn">More information about the Dsa-hl-svn
mailing list</a><br>
</body></html>
