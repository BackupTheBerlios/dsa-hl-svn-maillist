<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Dsa-hl-svn] r4743 - in rl/trunk/editors/Lockenwickler: .	_eric4project src
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/dsa-hl-svn/2009-February/index.html" >
   <LINK REL="made" HREF="mailto:dsa-hl-svn%40lists.berlios.de?Subject=Re%3A%20%5BDsa-hl-svn%5D%20r4743%20-%20in%20rl/trunk/editors/Lockenwickler%3A%20.%0A%09_eric4project%20src&In-Reply-To=%3C200902081543.n18FhGOH016951%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001799.html">
   <LINK REL="Next"  HREF="001801.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Dsa-hl-svn] r4743 - in rl/trunk/editors/Lockenwickler: .	_eric4project src</H1>
    <B>fusion2 at mail.berlios.de</B> 
    <A HREF="mailto:dsa-hl-svn%40lists.berlios.de?Subject=Re%3A%20%5BDsa-hl-svn%5D%20r4743%20-%20in%20rl/trunk/editors/Lockenwickler%3A%20.%0A%09_eric4project%20src&In-Reply-To=%3C200902081543.n18FhGOH016951%40sheep.berlios.de%3E"
       TITLE="[Dsa-hl-svn] r4743 - in rl/trunk/editors/Lockenwickler: .	_eric4project src">fusion2 at mail.berlios.de
       </A><BR>
    <I>Sun Feb  8 16:43:16 CET 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="001799.html">[Dsa-hl-svn] r4742 - in	rl/branches/persistence2/editors/Lockenwickler: .	_eric4project src src/media
</A></li>
        <LI>Next message: <A HREF="001801.html">[Dsa-hl-svn] r4744 - in rl/branches/persistence2/engine:	common/include common/src core/include core/src
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1800">[ date ]</a>
              <a href="thread.html#1800">[ thread ]</a>
              <a href="subject.html#1800">[ subject ]</a>
              <a href="author.html#1800">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: fusion2
Date: 2009-02-08 16:43:10 +0100 (Sun, 08 Feb 2009)
New Revision: 4743

Modified:
   rl/trunk/editors/Lockenwickler/Lockenwickler.e4p
   rl/trunk/editors/Lockenwickler/_eric4project/Lockenwickler.e4q
   rl/trunk/editors/Lockenwickler/_eric4project/Lockenwickler.e4t
   rl/trunk/editors/Lockenwickler/src/ModuleManager.py
   rl/trunk/editors/Lockenwickler/src/MyRaySceneQueryListener.py
   rl/trunk/editors/Lockenwickler/src/OgreMainWindow.py
   rl/trunk/editors/Lockenwickler/src/SelectionBuffer.py
Log:
- selection buffer mostly finished (pixel perfect selection!!)

Modified: rl/trunk/editors/Lockenwickler/Lockenwickler.e4p
===================================================================
--- rl/trunk/editors/Lockenwickler/Lockenwickler.e4p	2009-02-07 20:53:03 UTC (rev 4742)
+++ rl/trunk/editors/Lockenwickler/Lockenwickler.e4p	2009-02-08 15:43:10 UTC (rev 4743)
@@ -1,7 +1,7 @@
 &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
 &lt;!DOCTYPE Project SYSTEM &quot;Project-4.6.dtd&quot;&gt;
 &lt;!-- eric4 project file for project Lockenwickler --&gt;
-&lt;!-- Saved: 2009-02-07, 20:03:18 --&gt;
+&lt;!-- Saved: 2009-02-08, 13:55:11 --&gt;
 &lt;!-- Copyright (C) 2009 Stefan Stammberger, <A HREF="https://lists.berlios.de/mailman/listinfo/dsa-hl-svn">sstammberger at web.de</A> --&gt;
 &lt;Project version=&quot;4.6&quot;&gt;
   &lt;Language&gt;en&lt;/Language&gt;

Modified: rl/trunk/editors/Lockenwickler/_eric4project/Lockenwickler.e4q
===================================================================
--- rl/trunk/editors/Lockenwickler/_eric4project/Lockenwickler.e4q	2009-02-07 20:53:03 UTC (rev 4742)
+++ rl/trunk/editors/Lockenwickler/_eric4project/Lockenwickler.e4q	2009-02-08 15:43:10 UTC (rev 4743)
@@ -1,7 +1,7 @@
 &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
 &lt;!DOCTYPE UserProject SYSTEM &quot;UserProject-4.0.dtd&quot;&gt;
 &lt;!-- eric4 user project file for project Lockenwickler --&gt;
-&lt;!-- Saved: 2009-02-07, 20:03:18 --&gt;
+&lt;!-- Saved: 2009-02-08, 13:55:11 --&gt;
 &lt;!-- Copyright (C) 2009 Stefan Stammberger, <A HREF="https://lists.berlios.de/mailman/listinfo/dsa-hl-svn">sstammberger at web.de</A> --&gt;
 &lt;UserProject version=&quot;4.0&quot;&gt;
 &lt;/UserProject&gt;
\ No newline at end of file

Modified: rl/trunk/editors/Lockenwickler/_eric4project/Lockenwickler.e4t
===================================================================
--- rl/trunk/editors/Lockenwickler/_eric4project/Lockenwickler.e4t	2009-02-07 20:53:03 UTC (rev 4742)
+++ rl/trunk/editors/Lockenwickler/_eric4project/Lockenwickler.e4t	2009-02-08 15:43:10 UTC (rev 4743)
@@ -1,12 +1,12 @@
 &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
 &lt;!DOCTYPE Tasks SYSTEM &quot;Tasks-4.2.dtd&quot;&gt;
 &lt;!-- eric4 tasks file for project Lockenwickler --&gt;
-&lt;!-- Saved: 2009-02-07, 20:03:18 --&gt;
+&lt;!-- Saved: 2009-02-08, 13:55:11 --&gt;
 &lt;Tasks version=&quot;4.2&quot;&gt;
   &lt;Task priority=&quot;1&quot; completed=&quot;False&quot; bugfix=&quot;False&quot;&gt;
     &lt;Summary&gt;TODO: implement save here&lt;/Summary&gt;
     &lt;Description&gt;&lt;/Description&gt;
-    &lt;Created&gt;2009-02-07, 17:52:11&lt;/Created&gt;
+    &lt;Created&gt;2009-02-08, 11:32:14&lt;/Created&gt;
     &lt;Resource&gt;
       &lt;Filename&gt;src/Lockenwickler.py&lt;/Filename&gt;
       &lt;Linenumber&gt;416&lt;/Linenumber&gt;

Modified: rl/trunk/editors/Lockenwickler/src/ModuleManager.py
===================================================================
--- rl/trunk/editors/Lockenwickler/src/ModuleManager.py	2009-02-07 20:53:03 UTC (rev 4742)
+++ rl/trunk/editors/Lockenwickler/src/ModuleManager.py	2009-02-08 15:43:10 UTC (rev 4743)
@@ -33,8 +33,8 @@
 from SelectionBuffer import *
 from MovePivot import *
 from GameObjectClassManager import *
-from MyRaySceneQueryListener import *
 
+
 #                &lt;zone name=&quot;Testzone&quot;&gt;
 #                        &lt;area type=&quot;sphere&quot;&gt;
 #                                &lt;position x=&quot;-10&quot; y=&quot;0&quot; z=&quot;-5&quot;/&gt;
@@ -378,8 +378,6 @@
 
         self.moduleCfgPath = &quot;&quot;
 
-        self.raySceneQuery = self.sceneManager.createRayQuery(og.Ray())
-
         self.gocManager = GameObjectClassManager()
         # we need to hold a reference to the game object representaions ourself
         # python does not recognize the a reference to a c++ object (Entity in our case) is passed
@@ -393,8 +391,6 @@
         self.cutList = [] # selection objects that has been cut out and wait to be pasted again
         self.cutListPreviousNodes = [] # contains the nodes they where copnnected to before the cut
 
-        self.listenerDings = MyRaySceneQueryListener()
-
         self.moduleExplorer = None
 
         self.lastRay = None
@@ -507,18 +503,14 @@
             self.selectionBuffer = SelectionBuffer(self.sceneManager, self.ogreRoot.getRenderTarget(&quot;OgreMainWin&quot;))
 
     # called when a click into Main Ogre Window occurs
-    def selectionClick(self,  ray,  controlDown=False,  shiftDown=False):
+    def selectionClick(self, screenX, screenY, ray,  controlDown=False,  shiftDown=False):
+        so = None
+        
         if self.selectionBuffer is not None:
-            self.selectionBuffer.update()
-            
-        self.listenerDings.reset()
-        self.lastRay = ray
-        self.listenerDings.currentRay = ray
-        self.raySceneQuery.Ray = ray
-        self.raySceneQuery.execute(self.listenerDings)
-
-        so = self.listenerDings.rayCastToPolygonLevel(ray)
-
+            so = self.selectionBuffer.onSelectionClick(screenX, screenY)
+        
+        
+        
         if so is not None:
             if not so.isPivot:
                 if not controlDown and not shiftDown:
@@ -691,8 +683,6 @@
 
         self.userSelectionList = []
 
-        self.listenerDings.reset()
-        pass
 
 
     def updatePivots(self):

Modified: rl/trunk/editors/Lockenwickler/src/MyRaySceneQueryListener.py
===================================================================
--- rl/trunk/editors/Lockenwickler/src/MyRaySceneQueryListener.py	2009-02-07 20:53:03 UTC (rev 4742)
+++ rl/trunk/editors/Lockenwickler/src/MyRaySceneQueryListener.py	2009-02-08 15:43:10 UTC (rev 4743)
@@ -18,7 +18,6 @@
 
 import ctypes
 import ogre.renderer.OGRE as og
-import ogre.physics.OgreNewt as on
 
 # a class to store information about a object that got selected
 class SelectionObject():
@@ -61,12 +60,9 @@
         self.currentRay = None
         self.lastRay = None
 
-        self.World = on.World()
-        self.World.setWorldSize(og.Vector3(-1000000, -1000000, -1000000), og.Vector3(1000000, 1000000, 1000000))
+    #def __del__(self):
+        #del self.World
 
-    def __del__(self):
-        del self.World
-
     # sort algorithm for the selection list
     def sortCompareImp(self,  x,  y):
         if x.distance &gt; y.distance:
@@ -137,33 +133,9 @@
 
 
     def rayCastToPolygonLevelOnSingleMesh(self,  ray,  entity):
-        col = on.TreeCollision(self.World, entity.getParentNode(), False)
-        bod = on.Body(self.World, col)
-
-
-        start = ray.getOrigin()
-        end = ray.getPoint(10000)
-
-        retNorm = og.Vector3(0.0, 0.0, 0.0)
-
-        val = on.CollisionRayCast(col, start, end, retNorm)
-#        print val
-#
-#        print retNorm.x
-#        print retNorm.y
-#        print retNorm.z
-        del col
-        self.World.destroyAllBodies()
+        return
         
-        if retNorm.x != 0.0 or retNorm.y != 0.0 or retNorm.z != 0.0:
-#           print &quot;yes&quot;
-           return True
-        else:
-#            print &quot;no&quot;
-            return False
-           
         
-        
 
 #    def iterateEntityUnderMouse(self):
 #        self.previousSelected = self.currentSelected

Modified: rl/trunk/editors/Lockenwickler/src/OgreMainWindow.py
===================================================================
--- rl/trunk/editors/Lockenwickler/src/OgreMainWindow.py	2009-02-07 20:53:03 UTC (rev 4742)
+++ rl/trunk/editors/Lockenwickler/src/OgreMainWindow.py	2009-02-08 15:43:10 UTC (rev 4743)
@@ -299,11 +299,11 @@
         mouseRay = self.ogreWidget.getCamera().getCameraToViewportRay(screenX, screenY)
 
         if event.modifiers() == Qt.ControlModifier:
-            self.moduleManager.selectionClick(mouseRay,  True,  False)
+            self.moduleManager.selectionClick(relMousePos.x(), relMousePos.y(), mouseRay,  True,  False)
         elif event.modifiers() == Qt.ShiftModifier:
-            self.moduleManager.selectionClick(mouseRay,  False,  True)
+            self.moduleManager.selectionClick(relMousePos.x(), relMousePos.y(), mouseRay,  False,  True)
         else:
-            self.moduleManager.selectionClick(mouseRay)
+            self.moduleManager.selectionClick(relMousePos.x(), relMousePos.y(), mouseRay)
 
     def getWidth():
         return self.ogreWidget.getWidth()

Modified: rl/trunk/editors/Lockenwickler/src/SelectionBuffer.py
===================================================================
--- rl/trunk/editors/Lockenwickler/src/SelectionBuffer.py	2009-02-07 20:53:03 UTC (rev 4742)
+++ rl/trunk/editors/Lockenwickler/src/SelectionBuffer.py	2009-02-08 15:43:10 UTC (rev 4743)
@@ -3,15 +3,44 @@
 
 import ogre.renderer.OGRE as og
 
+
+# a class to store information about a object that got selected
+class SelectionObject():
+    def __init__(self,  entity):
+        self.entityName = entity.getName()
+        self.entity = entity #the selected entity
+        self.isPivot = False
+
+#        if self.entity.getUserObject() is not None:
+#            self.isGameObject = True
+#        else:
+#            self.isGameObject = False
+
+    #if True this instance will show its bounding box else it will hide it
+    def setSelected(self,  selected):
+        if selected == True:
+            self.entity.getParentNode().showBoundingBox(True)
+        else:
+            self.entity.getParentNode().showBoundingBox(False)
+
+    def __eq__(self, other):
+        return self.entity.getName() == other.entity.getName()
+
+    def __ne__(self, other):
+        return self.entity.getName() != other.entity.getName()
+
 # class to handle material switching without having to modify scene materials individually
 class MaterialSwitcher( og.MaterialManager.Listener ):
     def __init__(self):
         og.MaterialManager.Listener.__init__(self)
       
         self.currentColor = og.ColourValue(0.0, 0.0, 0.0)
+        self.currentColorAsVector3 = og.Vector3()
+        
         self.lastEntity = &quot;&quot;
         self.lastTechnique = None
         
+        self.colorDict = {}
        
     # takes into account that one Entity can have multiple SubEntities
     def handleSchemeNotFound(self, index, name, material, lod, subEntity):
@@ -26,8 +55,8 @@
                 self.randomizeColor()
                 subEntity.setCustomParameter(1, og.Vector4(self.currentColor.r, self.currentColor.g, self.currentColor.b, 1.0))
                 
-
                 self.lastEntity = subEntity.getParent().getName()
+                self.colorDict[self.lastEntity] = self.currentColorAsVector3
                 return self.lastTechnique
         
 
@@ -35,12 +64,13 @@
         r = random.randrange(1, 255)
         g = random.randrange(1, 255)
         b = random.randrange(1, 255)
-        
+        self.currentColorAsVector3 = og.Vector3(r, g, b)
         var = 1.0 / 255.0
 
         self.currentColor = og.ColourValue(r * var, g * var, b * var)
 
-        
+        #print str(int(self.currentColor.r * 255)) + &quot; &quot; + str(int(255 * self.currentColor.g)) + &quot; &quot; + str(int(255 * self.currentColor.b))
+    
     def reset(self):
         self.currentColor = og.ColourValue(0.0, 0.0, 0.0)
         self.lastEntity = &quot;&quot;
@@ -73,13 +103,6 @@
         
         self.selectionTargetListener = SelectionRenderListener( self.materialSwitchListener )
         
-#        self.texture = og.TextureManager.getSingleton().createManual(&quot;SelectionPassTex&quot;, 
-#                                                                    og.ResourceGroupManager.DEFAULT_RESOURCE_GROUP_NAME, 
-#                                                                    og.TEX_TYPE_2D, 
-#                                                                    self.viewport.getActualWidth(), 
-#                                                                    self.viewport.getActualHeight(), 
-#                                                                    0, og.PixelFormat.PF_R8G8B8, og.TU_RENDERTARGET)
-                                                                    
         width = self.viewport.getWidth()
         height = self.viewport.getHeight()
         
@@ -110,30 +133,35 @@
         #buffersize2 = self.renderTexture.getWidth()*self.renderTexture.getHeight()*4
         
         storageclass = ctypes.c_uint8 * (bufferSize)
-        buff = storageclass()
+        self.buffer = storageclass()
         
-        VoidPointer = og.CastVoidPtr(ctypes.addressof(buff))
+        VoidPointer = og.CastVoidPtr(ctypes.addressof(self.buffer))
 
-        pBox = og.PixelBox(pixelBuffer.getWidth(), pixelBuffer.getHeight(),pixelBuffer.getDepth(), pixelBuffer.getFormat(), VoidPointer)
-        self.renderTexture.copyContentsToMemory(pBox, og.RenderTarget.FrameBuffer.FB_FRONT)
-        self.renderTexture.writeContentsToTimestampedFile(&quot;editor&quot;, &quot;.png&quot;)
-        i = 0
-        
-        while i &lt; len(buff):
-            #print str(buff[i + 2]) + &quot; &quot; + str(buff[i+1]) + &quot; &quot; + str(buff[i])
+        self.pBox = og.PixelBox(pixelBuffer.getWidth(), pixelBuffer.getHeight(),pixelBuffer.getDepth(), pixelBuffer.getFormat(), VoidPointer)
+        self.renderTexture.copyContentsToMemory(self.pBox, og.RenderTarget.FrameBuffer.FB_FRONT)
+
+#        i = 0
+#        
+#        while i &lt; len(self.buffer):
+#            #print str(self.buffer[i + 2]) + &quot; &quot; + str(self.buffer[i+1]) + &quot; &quot; + str(self.buffer[i])
+#            
+#            i += 4
             
-            i += 4
-        #for a in buff:
-            #print a
-
-        #pBox = pixelBuffer.getCurrentLock()
+    def onSelectionClick(self, x, y):
+        self.update()
         
-        #storageclass = ctypes.c_uint8 * (self.renderTexture.getWidth()*self.renderTexture.getHeight()*3) 
+        posInStream = (self.pBox.getWidth() * y - 1)*4
+        posInStream += x*4
         
+        colVec = og.Vector3(self.buffer[posInStream + 2], self.buffer[posInStream+1], self.buffer[posInStream])
         
-        #pixelBuffer.unlock()
+        for key in self.materialSwitchListener.colorDict:
+            if self.materialSwitchListener.colorDict[key] == colVec:
+                so = SelectionObject(self.sceneMgr.getEntity(key))
+                return so
+
+        return None
         
-
     def createRTTOverlays(self):
         baseWhite = og.MaterialManager.getSingletonPtr().getByName(&quot;Lockenwickler_Pivot_X&quot;)
         SelectionBufferTexture = baseWhite.clone(&quot;SelectionDebugMaterial&quot;)


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001799.html">[Dsa-hl-svn] r4742 - in	rl/branches/persistence2/editors/Lockenwickler: .	_eric4project src src/media
</A></li>
	<LI>Next message: <A HREF="001801.html">[Dsa-hl-svn] r4744 - in rl/branches/persistence2/engine:	common/include common/src core/include core/src
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1800">[ date ]</a>
              <a href="thread.html#1800">[ thread ]</a>
              <a href="subject.html#1800">[ subject ]</a>
              <a href="author.html#1800">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/dsa-hl-svn">More information about the Dsa-hl-svn
mailing list</a><br>
</body></html>
